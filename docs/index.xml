<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI â€“ èªªæ˜èˆ‡ä»‹ç´¹</title><link>https://pin-yi.me/docs/</link><description>Recent content in èªªæ˜èˆ‡ä»‹ç´¹ on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><atom:link href="https://pin-yi.me/docs/index.xml" rel="self" type="application/rss+xml"/><item><title>æ­£å¼ç’°å¢ƒä¸Šè¸©åˆ° StatefulSet çš„é›·ï¼Œæ‹¿åˆ° P1 çš„æ•™è¨“</title><link>https://pin-yi.me/docs/kubernetes/k8s-statefulset-podmanagementpolicy/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pin-yi.me/docs/kubernetes/k8s-statefulset-podmanagementpolicy/</guid><description>
&lt;p>æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹å‰é™£å­åœ¨å…¬å¸çš„æ­£å¼ç’°å¢ƒè¸©åˆ° StatefulSet çš„é›·ï¼Œäº‹æƒ…æ˜¯é€™æ¨£çš„ï¼Œæˆ‘å€‘æœ‰äº›æœå‹™ï¼Œæ˜¯ä½¿ç”¨ StatefulSet ä¾†å»ºç½®ï¼Œè‡³æ–¼ç‚ºä»€éº¼ä¸ç”¨ Deploymentï¼Œé€™å€‹èªªä¾†è©±é•· (ä¹Ÿä¸æ˜¯å› ç‚ºéœ€è¦ç‰¹å®šçš„ Pod åç¨±ã€æˆ–æ˜¯ç¶²è·¯æ¨™è¨˜ç­‰ç­‰)ï¼Œæˆ‘å€‘é€™é‚Šå…ˆä¸è¨è«–ï¼Œé€™å€‹ StatefulSet æœå‹™æ˜¯ Nginx + PHP-FPMï¼Œç‚ºäº†é¿å…æµé‡é€²å…¥åˆ° processes å·²ç¶“è¢«ç”¨å…‰çš„ Pod ä¸­ï¼Œæˆ‘å€‘åœ¨ StatefulSet çš„ PHP Container ä¸Šæœ‰è¨­å®š readinessï¼Œreadiness çš„è¨­å®šé•·å¾—åƒä»¥ä¸‹ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">readinessProbe&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">exec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">command&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#34;/bin/bash&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#34;-c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - |&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> CHECK_INFO=$(curl -s -w &amp;#39;http code:\t%{http_code}\n&amp;#39; 127.0.0.1/status)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> HTTP_CODE=$(echo -e &amp;#34;${CHECK_INFO}&amp;#34; | awk &amp;#39;/http code:/ {print $3}&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> IDLE_PROCESSES=$(echo -e &amp;#34;${CHECK_INFO}&amp;#34; | awk &amp;#39;/idle processes:/ {print $3}&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> [[ $HTTP_CODE -eq 200 &amp;amp;&amp;amp; $IDLE_PROCESSES -ge 10 ]] || exit 1&lt;/span> &lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;p>æˆ‘å€‘æœƒç”¨ curl ä¾†æ‰“ &lt;code>/status&lt;/code>ï¼Œæª¢æŸ¥å›å‚³çš„ http code æ˜¯å¦ç‚º 200ï¼Œä»¥åŠ idle processes æ˜¯å¦å¤§æ–¼ç­‰æ–¼ 10ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œå°±æœƒå›å‚³ 1ï¼Œè®“ä»–è¢«æ¨™è¨˜ä¸å¥åº·ï¼Œè®“ Kubernetes åœæ­¢æµé‡åˆ°ä¸å¥åº·çš„å®¹å™¨ï¼Œä»¥ç¢ºä¿æµé‡è¢«è·¯ç”±åˆ°å…¶ä»–å¥åº·çš„å‰¯æœ¬ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>å•é¡Œ&lt;span class="absolute -mt-20" id="å•é¡Œ">&lt;/span>
&lt;a href="#%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ç•¶å¤©é‡åˆ°çš„æƒ…æ³æ˜¯ï¼Œæˆ‘å€‘ä¸Šç¨‹å¼å¾Œï¼ŒPod éƒ½ä¸€åˆ‡æ­£å¸¸ï¼Œç•¶æµé‡é–‹å§‹é€²ä¾†å¾Œï¼Œç™¼ç¾ 10 å€‹ Pod æœƒé–‹å§‹å¶ç™¼çš„å™´ &lt;code>Readiness probe failed&lt;/code>ï¼ŒæŸ¥çœ‹ç›£æ§ç™¼ç¾ processes è¶Šä¾†è¶Šä½ï¼Œæœ€å¾Œè¢«åæ‡‰æœå‹™æœ‰å•é¡Œï¼Œæˆ‘å€‘æŸ¥çœ‹ Hpa çš„ç´€éŒ„çš„ç¢ºæœ‰è§¸ç™¼åˆ° 40 å€‹ Podï¼Œåªæ˜¯æŸ¥çœ‹ Pod æ•¸é‚„æ˜¯ä¾æ¨£å¡åœ¨ 10 å€‹ï¼Œç•¶ä¸‹æˆ‘å€‘æœ‰å˜—è©¦ä½¿ç”¨èª¿æ•´ yaml åœ¨ applyï¼Œç™¼ç¾ StatefulSet çš„ yaml ä¹Ÿå·²ç¶“æ›´æ–°äº†ï¼Œä½† Pod é‚„æ˜¯ä¸€æ¨£å¡åœ¨ 10 å€‹ï¼Œä¹Ÿæœ‰ä½¿ç”¨ kubectl ä¸‹ &lt;code>kubectl scale sts [æœå‹™åç¨±] --replicas=0&lt;/code>ï¼Œæƒ³è¦åˆ‡æ› Pod æ•¸ä¹Ÿæ²’æœ‰è¾¦æ³•ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ç•¶ä¸‹æˆ‘å€‘æœ‰å…ˆ Call Google çš„ Support ä¸€èµ·æ‰¾åŸå› ï¼ŒGoogle æ˜¯å»ºè­°æˆ‘å€‘ readiness çš„æ¢ä»¶ä¸è¦è¨­çš„å¤ªåš´æ ¼ï¼Œå¯ä»¥åŠ ä¸Š &lt;code>timeoutSeconds: ç§’æ•¸&lt;/code>ï¼Œä½†å°æ–¼ Pod å¡ä½ï¼Œé‚„æ˜¯æ²’æœ‰æ‰¾åˆ°åŸå› ï¼Œå¾Œä¾†æˆ‘å€‘æŸ¥äº†ä¸€ä¸‹ StatefulSet çš„æ–‡ä»¶ç™¼ç¾ï¼ŒStatefulSet æœ‰ä¸€å€‹è¨­å®š &lt;code>podManagementPolicy&lt;/code>ï¼Œé è¨­æ˜¯ &lt;code>OrderedReady&lt;/code>ï¼Œä»–å¿…é ˆç­‰å¾…å‰é¢çš„ Pod æ˜¯ Ready ç‹€æ…‹ï¼Œæ‰æœƒå†ç¹¼çºŒå»ºç«‹æ–°çš„ï¼Œä¹Ÿå°±æ˜¯èªªæˆ‘å€‘çš„ StatefulSet å·²ç¶“å¡ä½ï¼Œå°è‡´å°±ç®— Hpa è§¸ç™¼è¦é•·åˆ° 40 å€‹ Pod ä¹Ÿæ²’æœ‰ç”¨ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>è§£æ±ºè¾¦æ³•&lt;span class="absolute -mt-20" id="è§£æ±ºè¾¦æ³•">&lt;/span>
&lt;a href="#%e8%a7%a3%e6%b1%ba%e8%be%a6%e6%b3%95" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ç•¶ä¸‹æƒ³è¶•å¿«è§£æ±º readiness é€™å€‹å•é¡Œï¼Œèª¿æ•´ &lt;code>timeoutSeconds&lt;/code> å¾Œï¼Œå–®ç´” apply æ˜¯æ²’æœ‰ç”¨çš„ï¼Œè¦è¨˜å¾—åˆªæ‰å¡ä½çš„ Podï¼Œè®“ä»–é‡æ–°å»ºç«‹ï¼Œæ‰æœƒå¥—ç”¨æ–°çš„è¨­å®š (ä½†æˆ‘å€‘ç•¶ä¸‹å¤ªåœ¨æ„ç‚ºç”šéº¼ Pod æœƒå¡ä½ï¼Œæ²’æœ‰æƒ³åˆ°è¦å…ˆæŠŠ readiness å•é¡Œä¿®æ‰ xDï¼Œæˆ‘å€‘ç•¶ä¸‹çš„è§£æ³•æ˜¯å…ˆå°‡æµé‡å°åˆ°åœ°ç«¯æ­£å¸¸çš„æœå‹™ä¸Š)ã€‚&lt;/p>
&lt;p>å¦å¤– Google ä¹Ÿèªªï¼Œå‡å¦‚æˆ‘å€‘é‚„æ˜¯å¿…é ˆä½¿ç”¨ StatefulSet ä¾†å»ºç«‹æœå‹™ï¼Œå»ºè­°æˆ‘å€‘æŠŠ podManagementPolicy æ”¹æˆ &lt;code>Parallel&lt;/code>ï¼Œå®ƒæœƒæœ‰é»åƒæ˜¯ Deployment çš„æ„Ÿè¦ºï¼Œä¸æœƒç­‰å¾…å…¶ä»– Pod è®Šæˆ Ready ç‹€æ…‹ï¼Œæ‰€ä»¥å¯ä»¥è®“æˆ‘å€‘å°±ç®—åœ¨ readiness å¡ä½çš„æƒ…æ³ä¸‹ï¼Œä¹Ÿå¯ä»¥è‡ªå‹•æ“´ç¸®æœå‹™ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;div class="overflow-x-auto mt-6 flex rounded-lg border py-2 ltr:pr-4 rtl:pl-4 contrast-more:border-current contrast-more:dark:border-current border-orange-100 bg-orange-50 text-orange-800 dark:border-orange-400/30 dark:bg-orange-400/20 dark:text-orange-300">
&lt;div class="ltr:pl-3 ltr:pr-2 rtl:pr-3 rtl:pl-2">&lt;/div>
&lt;div class="w-full min-w-0 leading-7">
&lt;div class="mt-6 leading-7 first:mt-0">
&lt;p>StatefulSet podManagementPolicy åƒæ•¸èªªæ˜&lt;/p>
&lt;ul>
&lt;li>OrderedReady (é è¨­)&lt;/li>
&lt;/ul>
&lt;p>Pods æœƒæŒ‰ç…§é †åºä¸€å€‹æ¥ä¸€å€‹åœ°è¢«å‰µå»ºã€‚å³ï¼Œn+1 è™Ÿ Pod ä¸æœƒåœ¨ n è™Ÿ Pod æˆåŠŸå‰µå»ºä¸” Ready ä¹‹å‰é–‹å§‹å‰µå»ºã€‚
åœ¨ç¸®å° StatefulSet çš„å¤§å°æ™‚ï¼ŒPods æœƒæŒ‰ç…§åå‘é †åºä¸€å€‹æ¥ä¸€å€‹åœ°è¢«çµ‚æ­¢ã€‚å³ï¼Œn è™Ÿ Pod ä¸æœƒåœ¨ n+1 è™Ÿ Pod å®Œå…¨çµ‚æ­¢ä¹‹å‰é–‹å§‹çµ‚æ­¢ã€‚
é€™ç¢ºä¿äº† Pods çš„å•Ÿå‹•å’Œçµ‚æ­¢çš„é †åºæ€§ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>Parallel&lt;/li>
&lt;/ul>
&lt;p>æ‰€æœ‰ Pods æœƒåŒæ™‚åœ°è¢«å‰µå»ºæˆ–çµ‚æ­¢ã€‚
ç•¶ StatefulSet æ“´å±•æ™‚ï¼Œæ–°çš„ Pods æœƒç«‹å³é–‹å§‹å‰µå»ºï¼Œä¸ç”¨ç­‰å¾…å…¶ä»– Pods æˆç‚º Ready ç‹€æ…‹ã€‚
ç•¶ç¸®å° StatefulSet çš„å¤§å°æ™‚ï¼Œè¦çµ‚æ­¢çš„ Pods æœƒç«‹å³é–‹å§‹çµ‚æ­¢ï¼Œä¸ç”¨ç­‰å¾…å…¶ä»– Pods å…ˆçµ‚æ­¢ã€‚
é€™ç¨®ç­–ç•¥æä¾›äº†å¿«é€Ÿçš„æ“´å±•å’Œç¸®å°æ“ä½œï¼Œä½†ç¼ºä¹é †åºæ€§ä¿è­‰ã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;h2>æ¸¬è©¦çµæœ&lt;span class="absolute -mt-20" id="æ¸¬è©¦çµæœ">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e7%b5%90%e6%9e%9c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æœ€å¾Œæˆ‘å€‘å°±ä½¿ç”¨å…©ç¨®æ¨¡å¼ä¾†æ¸¬è©¦çœ‹çœ‹ï¼Œå·²ä¸‹æ˜¯æ¸¬è©¦çµæœ(é€é P1 æ‰çŸ¥é“çš„è¨­å®šï¼±ï¼±)ï¼š&lt;/p>
&lt;p>æœ‰å°‡æ¸¬è©¦çš„ StatefulSet æ”¾åœ¨ Githubï¼Œ&lt;a href="https://github.com/880831ian/k8s-statefulset-podmanagementpolicy" target="_blank" rel="noopener">å¯ä»¥é»æˆ‘æŸ¥çœ‹&lt;/a> (å¯ä»¥èª¿æ•´ readinessProbe çš„ httpGet.Path æ•…æ„æŠŠä»–ç”¨å£)&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3>ä½¿ç”¨ OrderedReady æ¨¡å¼&lt;span class="absolute -mt-20" id="ä½¿ç”¨-orderedready-æ¨¡å¼">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-orderedready-%e6%a8%a1%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>StatefulSet åœ¨ podManagementPolicy é è¨­ OrderedReady çš„æ¨¡å¼ï¼Œæ•…æ„è®“ readiness å¡ä½æ™‚ (Pod å¡ä½æ™‚)ï¼š&lt;/p>
&lt;ul>
&lt;li>ç•¶ä¸‹çš„ StatefulSet è¨­å®šï¼š&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/1.png" title="StatefulSet è¨­å®š" alt="" loading="lazy" />
&lt;figcaption>StatefulSet è¨­å®š&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;ul>
&lt;li>Pod ç‹€æ…‹ï¼š&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/2.png" title="Pod ç‹€æ…‹" alt="" loading="lazy" />
&lt;figcaption>Pod ç‹€æ…‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h4>ä½¿ç”¨æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡&lt;span class="absolute -mt-20" id="ä½¿ç”¨æŒ‡ä»¤èª¿æ•´-pod-æ•¸é‡">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8%e6%8c%87%e4%bb%a4%e8%aa%bf%e6%95%b4-pod-%e6%95%b8%e9%87%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>æˆ‘å€‘é€™æ™‚å€™ä¸‹æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;pre>&lt;code>kubectl scale sts my-statefulset --replicas=5&lt;/code>&lt;/pre>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;p>æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ï¼Œä»£è¡¨ StatefulSet æœ¬èº«æœ‰æ¥æ”¶åˆ°èª¿æ•´è¨­å®šçš„è«‹æ±‚ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/3.png" title="ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š" alt="" loading="lazy" />
&lt;figcaption>ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>çœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿæ˜¯ä¸€æ¨£å¡ä½ï¼Œä¸” Pod æ•¸é‡ä¹Ÿæ²’æœ‰è®ŠåŒ–ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/4.png" title="ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹" alt="" loading="lazy" />
&lt;figcaption>ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h4>ä½¿ç”¨ yaml èª¿æ•´ Pod æ•¸é‡&lt;span class="absolute -mt-20" id="ä½¿ç”¨-yaml-èª¿æ•´-pod-æ•¸é‡">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-yaml-%e8%aa%bf%e6%95%b4-pod-%e6%95%b8%e9%87%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>æˆ‘å€‘ç›´æ¥èª¿æ•´ StatefulSet yaml çš„ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š&lt;/p>
&lt;p>ä¸€æ¨£æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Š(é€™è£¡æ‡‰è©²åˆ‡åˆ¥çš„ Pod æ•¸é‡ï¼Œåˆ‡å› 3 å€‹å¥½åƒæ²’æœ‰æ„ç¾© xD)ï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/5.png" title="ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š" alt="" loading="lazy" />
&lt;figcaption>ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>çœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿæ˜¯ä¸€æ¨£å¡ä½ï¼Œä¸” Pod æ•¸é‡ä¹Ÿæ²’æœ‰è®ŠåŒ–ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/6.png" title="ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹" alt="" loading="lazy" />
&lt;figcaption>ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>æ‰€ä»¥ä»£è¡¨åœ¨ OrderedReady çš„æ¨¡å¼ä¸‹ï¼ŒPod å¡ä½æ™‚ï¼Œç„¡æ³•å° Pod é€²è¡Œä»»ä½•æ“ä½œï¼Œå¿…é ˆè¦æ‰‹å‹•åˆªé™¤å¡ä½çš„ Pod æ‰åƒå¾—åˆ°æœ€æ–°çš„è¨­å®šã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3>ä½¿ç”¨ Parallel æ¨¡å¼&lt;span class="absolute -mt-20" id="ä½¿ç”¨-parallel-æ¨¡å¼">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-parallel-%e6%a8%a1%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>StatefulSet åœ¨ podManagementPolicy Parallel çš„æ¨¡å¼ï¼Œæ•…æ„è®“ readiness å¡ä½æ™‚ (Pod å¡ä½æ™‚)ï¼š&lt;/p>
&lt;ul>
&lt;li>ç•¶ä¸‹çš„ StatefulSet è¨­å®šï¼š&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/7.png" title="StatefulSet è¨­å®š" alt="" loading="lazy" />
&lt;figcaption>StatefulSet è¨­å®š&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;ul>
&lt;li>Pod ç‹€æ…‹ï¼š&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/8.png" title="Pod ç‹€æ…‹" alt="" loading="lazy" />
&lt;figcaption>Pod ç‹€æ…‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h4>ä½¿ç”¨æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡&lt;span class="absolute -mt-20" id="ä½¿ç”¨æŒ‡ä»¤èª¿æ•´-pod-æ•¸é‡-1">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8%e6%8c%87%e4%bb%a4%e8%aa%bf%e6%95%b4-pod-%e6%95%b8%e9%87%8f-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>æˆ‘å€‘é€™æ™‚å€™ä¸‹æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;pre>&lt;code>kubectl scale sts my-statefulset --replicas=5&lt;/code>&lt;/pre>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;p>æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ï¼Œä»£è¡¨ StatefulSet æœ¬èº«æœ‰æ¥æ”¶åˆ°èª¿æ•´è¨­å®šçš„è«‹æ±‚ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/9.png" title="ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š" alt="" loading="lazy" />
&lt;figcaption>ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>çœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œå°±ç®— my-statefulset-2 å¡ä½ï¼Œé‚„æ˜¯å¯ä»¥æ“´åˆ° 5 å€‹ Podã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/10.png" title="ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹" alt="" loading="lazy" />
&lt;figcaption>ä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h4>ä½¿ç”¨ yaml èª¿æ•´ Pod æ•¸é‡&lt;span class="absolute -mt-20" id="ä½¿ç”¨-yaml-èª¿æ•´-pod-æ•¸é‡-1">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-yaml-%e8%aa%bf%e6%95%b4-pod-%e6%95%b8%e9%87%8f-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>æˆ‘å€‘ç›´æ¥èª¿æ•´ StatefulSet yaml çš„ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š&lt;/p>
&lt;p>ä¸€æ¨£æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/11.png" title="ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š" alt="" loading="lazy" />
&lt;figcaption>ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>çœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿä¸æœƒç®¡å…¶ä»– Pod æ˜¯å¦ Readyï¼Œä¸€æ¨£å¯ä»¥ç¸®å°æˆ 2 å€‹ Podã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/12.png" title="ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹" alt="" loading="lazy" />
&lt;figcaption>ä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>çµè«–&lt;span class="absolute -mt-20" id="çµè«–">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å¾Œä¾†æˆ‘å€‘é‡æ–°æª¢æŸ¥äº†ä¸€ä¸‹ç‚ºä»€éº¼ processes æœƒç”¨å®Œï¼Œçµæœç™¼ç¾æ˜¯ RD çš„ç¨‹å¼é‚è¼¯ï¼Œå°è‡´æ¯ç­† Request å¿…é ˆç­‰å¾…å‰ä¸€ç­† Request åšå®Œï¼Œæ‰æœƒé–‹å§‹å‹•ä½œï¼Œè®“ processes ä¸€ç›´è¢«å ç”¨ï¼Œæ²’è¾¦æ³•å³æ™‚æ¶ˆåŒ–ï¼Œå°è‡´ processes ç”¨å®Œï¼ŒåˆåŠ ä¸Šæœå‹™æ˜¯ä½¿ç”¨ StatefulSetï¼Œé è¨­æ¨¡å¼çš„ OrderedReadyï¼Œå¿…é ˆç­‰å¾…å‰ä¸€å€‹ Pod æ˜¯ Ready æ‰å¯ä»¥è‡ªå‹•æ“´ç¸®ï¼Œæ‰€ä»¥ç•¶æˆ‘å€‘ Hpa æƒ³è¦æ“´ç¸®ï¼Œä¾†å¢åŠ å¯ç”¨çš„ processes æ•¸é‡ï¼Œä¹Ÿå› ç‚ºæ²’è¾¦æ³•æ“´ç¸®ï¼Œæœ€å¾Œå°è‡´é€™ä¸€é€£ä¸²çš„å•é¡Œ ğŸ˜•ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>å¦å¤–ï¼Œå¦‚æœæƒ³è¦å¾ OrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼ (åæ­£éä¾†ä¹Ÿæ˜¯)ï¼Œå¿…é ˆå…ˆå°‡åŸæœ¬çš„ StatefulSet çµ¦åˆªé™¤ï¼Œæ‰å¯ä»¥èª¿æ•´ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/k8s-statefulset-podmanagementpolicy/13.png" title="OrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼" alt="" loading="lazy" />
&lt;figcaption>OrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>åƒè€ƒè³‡æ–™&lt;span class="absolute -mt-20" id="åƒè€ƒè³‡æ–™">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Kubernetes â€” å¥åº·æª¢æŸ¥ï¼š&lt;a href="https://medium.com/learn-or-die/kubernetes-%E5%81%A5%E5%BA%B7%E6%AA%A2%E6%9F%A5-59ee2a798115" target="_blank" rel="noopener">https://medium.com/learn-or-die/kubernetes-%E5%81%A5%E5%BA%B7%E6%AA%A2%E6%9F%A5-59ee2a798115&lt;/a>&lt;/p>
&lt;p>Pod Management Policiesï¼š&lt;a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#pod-management-policies" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#pod-management-policies&lt;/a>&lt;/p></description></item><item><title>æƒ³ä½¿ç”¨ Nginx Upstream Proxy åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸¦å¸¶å…¥å°æ‡‰çš„ header è©²æ€éº¼åšï¼Ÿ</title><link>https://pin-yi.me/docs/nginx/nginx-upstream-set-host-header/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pin-yi.me/docs/nginx/nginx-upstream-set-host-header/</guid><description>
&lt;p>æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹æœ€è¿‘åœ¨å…¬å¸æœå‹™å…¥å£é‡åˆ°çš„ä¸€äº›å°å•é¡Œï¼Œä»¥åŠè§£æ±ºçš„æ–¹æ³•ã€‚ç°¡å–®èªªæ˜ä¸€ä¸‹ï¼Œæˆ‘å€‘çš„æœå‹™å…¥å£æ˜¯ç”¨ Nginx ä¾†ç•¶ä½œ proxy serverï¼Œå°‡ä¸åŒè·¯å¾‘æˆ–æ˜¯ servername å°åˆ°å°æ‡‰çš„å¾Œç«¯ç¨‹å¼ï¼Œæˆ–æ˜¯å¤–éƒ¨çš„æœå‹™ä¸Š(ä¾‹å¦‚ AWS cloudfront.net)ï¼Œæœ¬ç¯‡è¦æ¸¬è©¦çš„æ˜¯å¦‚æœä½¿ç”¨è¦åŒæ™‚ä½¿ç”¨ upstream åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸”éœ€è¦å¸¶ host header è©²æ€éº¼åšã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;div class="overflow-x-auto mt-6 flex rounded-lg border py-2 ltr:pr-4 rtl:pl-4 contrast-more:border-current contrast-more:dark:border-current border-orange-100 bg-orange-50 text-orange-800 dark:border-orange-400/30 dark:bg-orange-400/20 dark:text-orange-300">
&lt;div class="ltr:pl-3 ltr:pr-2 rtl:pr-3 rtl:pl-2">&lt;/div>
&lt;div class="w-full min-w-0 leading-7">
&lt;div class="mt-6 leading-7 first:mt-0">
&lt;p>Nginx çš„ upstream æ˜¯ä»€éº¼ï¼Ÿ&lt;/p>
&lt;p>é€šå¸¸æˆ‘å€‘ proxy_pass çš„å¯«æ³•æœƒæ˜¯é€™æ¨£ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-nginx" data-lang="nginx">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">location&lt;/span> &lt;span style="color:#e6db74">/aaa&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_pass&lt;/span> &lt;span style="color:#e6db74">http://aaa.example.com&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç•¶ Nginx æ”¶åˆ°çš„ request æ˜¯ &lt;code>/aaa&lt;/code> æ™‚ï¼Œå°±æœƒå°‡ request è½‰ç™¼åˆ° &lt;code>http://aaa.example.com&lt;/code>ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ä½†å‡å¦‚å¾Œç«¯æœ‰å¤šå°æ©Ÿå™¨æˆ–æ˜¯æœå‹™ï¼Œå¯ä»¥è™•ç†åŒä¸€ç¨® requestï¼Œé€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨ upstream ä¾†è™•ç†ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-nginx" data-lang="nginx">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">upstream&lt;/span> &lt;span style="color:#e6db74">backend_hosts&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> &lt;span style="color:#e6db74">aaa.example.com&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> &lt;span style="color:#e6db74">bbb.example.com&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> &lt;span style="color:#e6db74">ccc.example.com&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">location&lt;/span> &lt;span style="color:#e6db74">/aaa&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_pass&lt;/span> &lt;span style="color:#e6db74">http://backend_hosts&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é€™æ¨£å­çš„å¥½è™•æ˜¯å¯ä»¥æœ‰å¤šå€‹æ©Ÿå™¨æˆ–æ˜¯å¾Œç«¯æœå‹™å¯ä»¥åˆ†æ•£è«‹æ±‚ï¼Œåšåˆ°è² è¼‰å¹³è¡¡çš„æ•ˆæœã€‚&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;h2>å•é¡Œ&lt;span class="absolute -mt-20" id="å•é¡Œ">&lt;/span>
&lt;a href="#%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>é‚£å¦‚æœæˆ‘å€‘ä½¿ç”¨ Nginx upstream æ™‚ï¼Œé‚„æƒ³è¦åŒæ™‚å¸¶ host çš„ header åˆ°å¾Œç«¯è©²æ€éº¼åšå‘¢ï¼Ÿæˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ç›®å‰çš„å¯«æ³•ï¼š&lt;/p>
&lt;p>( æ¸¬è©¦ç¯„ä¾‹æ˜¯ä½¿ç”¨ docker ä¾†æ¨¡æ“¬ï¼Œå¯ä»¥åƒè€ƒç¨‹å¼ç¢¼ &amp;gt; &lt;a href="https://github.com/880831ian/nginx-upstream-set-host-header" target="_blank" rel="noopener">é»æˆ‘å‰å¾€ github&lt;/a>ï¼Œæœƒæœ‰ä¸‰å€‹ nginxï¼Œå…¶ä¸­ä¸€å€‹æ˜¯è² è²¬ proxy çš„ nginx åç‚º proxyï¼Œå¦å¤–å…©å°æ˜¯ upstream å¾Œçš„æœå‹™ï¼Œåç‚º upstream_server1ã€upstream_server2 )&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div class="filename">nginx-old.conf&lt;/div>&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-nginx" data-lang="nginx">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">upstream&lt;/span> &lt;span style="color:#e6db74">upstream_server&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> &lt;span style="color:#e6db74">upstream_server1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> &lt;span style="color:#e6db74">upstream_server2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">server&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">listen&lt;/span> &lt;span style="color:#ae81ff">80&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server_name&lt;/span> &lt;span style="color:#e6db74">localhost&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">location&lt;/span> &lt;span style="color:#e6db74">/upstream_server/&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_pass&lt;/span> &lt;span style="color:#e6db74">http://upstream_server&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_set_header&lt;/span> &lt;span style="color:#e6db74">Host&lt;/span> &lt;span style="color:#e6db74">&amp;#34;upstream_server1&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_set_header&lt;/span> &lt;span style="color:#e6db74">Host&lt;/span> &lt;span style="color:#e6db74">&amp;#34;upstream_server2&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">access_log&lt;/span> &lt;span style="color:#e6db74">/var/log/nginx/access.log&lt;/span> &lt;span style="color:#e6db74">upstream_log&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-8">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;p>å¯ä»¥çœ‹åˆ°æˆ‘å€‘å¸Œæœ› Nginx æ”¶åˆ° request æ˜¯ &lt;code>/upstream_server&lt;/code> æ™‚ï¼Œå°‡ request è½‰ç™¼åˆ° &lt;code>http://upstream_server&lt;/code>ï¼Œè€Œ &lt;code>upstream_server&lt;/code> å¾Œé¢æœ‰å…©å€‹ serverï¼Œä¸¦ä¸”åœ¨ proxy æ™‚ï¼Œå¸¶å…¥å…©å€‹ä¸åŒçš„ host headerã€‚ä½†å¦‚æœçœŸçš„é€™æ¨£å¯«ï¼Œå¯ä»¥é”åˆ°æˆ‘å€‘æƒ³è¦å¾—æ•ˆæœå—ï¼Ÿæˆ‘å€‘å¯¦éš›è·‘çœ‹çœ‹ç¨‹å¼ (ç¯„ä¾‹å¯ä»¥ä½¿ç”¨ nginx-old.conf)ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/nginx-upstream-set-host-header/1.png" title="nginx åŸæœ¬å¯«æ³•" alt="" loading="lazy" />
&lt;figcaption>nginx åŸæœ¬å¯«æ³•&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>å¾ä¸Šé¢çš„ LOG å¯ä»¥ç™¼ç¾ï¼Œæˆ‘å€‘ call &lt;code>/upstream_server&lt;/code> æ™‚ï¼Œå¾Œç«¯çš„ upstream_server1ã€upstream_server2 æ”¶åˆ°çš„ host åªæœƒæ”¶åˆ°ç¬¬ä¸€å€‹è¨­å®šçš„ Hostï¼Œä¸”æœå‹™æœƒå‡ºç¾ 400 Bad Requestï¼ŒæŸ¥äº†ä¸€ä¸‹ç¶²è·¯æ–‡ç« ï¼Œç™¼ç¾å‡ºç¾ 400 Bad Requestï¼Œå¯èƒ½è·Ÿ header é€å¤ªå¤šè³‡è¨Šéå»ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ &lt;a href="https://tools.wingzero.tw/article/sn/534" target="_blank" rel="noopener">è§£æ±ºç¶²ç«™å‡ºç¾ 400 Bad Request ç‹€æ…‹çš„æ–¹æ³•&lt;/a>ã€‚&lt;/p>
&lt;p>é€™é‚Šæ¨æ¸¬æ‡‰è©²æ˜¯å¾Œç«¯å¦‚æœä¹Ÿæ˜¯ç”¨ nginx ç›´æ¥æ¥æ”¶æ‰æœƒé‡åˆ° 400 çš„å•é¡Œï¼Œé‚„å¥½ç›®å‰å…¬å¸æœå‹™é‚„æ˜¯æ­£å¸¸çš„ xDDï¼Œæª¢æŸ¥ä¸€ä¸‹å¾Œç™¼ç¾ï¼Œå…¶å¯¦å¾Œç«¯æ ¹æœ¬æ²’æœ‰è¦æ±‚å°æ‡‰ header æ‰èƒ½æ¥æ”¶(æ‡‰è©²æ˜¯å°æ–¹å¿˜è¨˜åŠ ä¸Šæ­¤é™åˆ¶)ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>è§£æ±º&lt;span class="absolute -mt-20" id="è§£æ±º">&lt;/span>
&lt;a href="#%e8%a7%a3%e6%b1%ba" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å¥½ï¼Œä¸ç®¡æ˜¯å¦éœ€è¦å°æ‡‰ headerï¼Œæˆ‘å€‘é‚„æ˜¯æ‰¾çœ‹çœ‹æœ‰æ²’æœ‰è¾¦æ³•åŒæ™‚ä½¿ç”¨ upstreamï¼Œä¸¦å¸¶å…¥å°æ‡‰ host çš„æ–¹æ³•å‘¢ï¼Ÿ&lt;/p>
&lt;p>æœ€å¾Œåƒè€ƒç¶²è·¯ä¸Šçš„æ–‡ç« ï¼Œä¼¼ä¹åªèƒ½ä½¿ç”¨å…©å±¤çš„ proxyï¼Œæ‰èƒ½å®Œæˆé€™å…©å€‹éœ€æ±‚ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹è¦æ€éº¼å¯«å§ (ç¯„ä¾‹å¯ä»¥ä½¿ç”¨ nginx.conf)ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div class="filename">nginx.conf&lt;/div>&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-nginx" data-lang="nginx">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">server&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">listen&lt;/span> &lt;span style="color:#ae81ff">777&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server_name&lt;/span> &lt;span style="color:#e6db74">localhost&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">location&lt;/span> &lt;span style="color:#e6db74">/&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_pass&lt;/span> &lt;span style="color:#e6db74">http://upstream_server1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_set_header&lt;/span> &lt;span style="color:#e6db74">Host&lt;/span> &lt;span style="color:#e6db74">&amp;#34;upstream_server1&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">access_log&lt;/span> &lt;span style="color:#e6db74">/var/log/nginx/access.log&lt;/span> &lt;span style="color:#e6db74">upstream_log&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">server&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">listen&lt;/span> &lt;span style="color:#ae81ff">888&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server_name&lt;/span> &lt;span style="color:#e6db74">localhost&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">location&lt;/span> &lt;span style="color:#e6db74">/&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_pass&lt;/span> &lt;span style="color:#e6db74">http://upstream_server2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_set_header&lt;/span> &lt;span style="color:#e6db74">Host&lt;/span> &lt;span style="color:#e6db74">&amp;#34;upstream_server2&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">access_log&lt;/span> &lt;span style="color:#e6db74">/var/log/nginx/access.log&lt;/span> &lt;span style="color:#e6db74">upstream_log&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">upstream&lt;/span> &lt;span style="color:#e6db74">upstream_server&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> 127.0.0.1:&lt;span style="color:#ae81ff">777&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server&lt;/span> 127.0.0.1:&lt;span style="color:#ae81ff">888&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">server&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">listen&lt;/span> &lt;span style="color:#ae81ff">80&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">server_name&lt;/span> &lt;span style="color:#e6db74">localhost&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">location&lt;/span> &lt;span style="color:#e6db74">/upstream_server/&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">proxy_pass&lt;/span> &lt;span style="color:#e6db74">http://upstream_server&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">access_log&lt;/span> &lt;span style="color:#e6db74">/var/log/nginx/access.log&lt;/span> &lt;span style="color:#e6db74">upstream_log&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-8">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;!-- raw HTML omitted -->
&lt;p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ç¨‹å¼ç¢¼ï¼Œæˆ‘å€‘é€éå…©å±¤çš„ proxyï¼Œä¾†é”åˆ°æˆ‘å€‘æƒ³è¦çš„æ•ˆæœï¼Œé€™æ¨£å­å°±å¯ä»¥åŒæ™‚ä½¿ç”¨ upstreamï¼Œä¸¦ä¸”å¸¶å…¥å°æ‡‰çš„ host headerã€‚&lt;/p>
&lt;p>é¦–å…ˆåœ¨ 28 ~ 36 è¡Œï¼Œæˆ‘å€‘ä¸€æ¨£å¦‚æœ Nginx æ”¶åˆ° request æ˜¯ &lt;code>/upstream_server&lt;/code> æ™‚ï¼Œæœƒ proxy åˆ° upstream_server é€™å€‹ upstream ä¸­ï¼Œè€Œ upstream_server æœ‰å…©å€‹ serverï¼Œåˆ†åˆ¥æ˜¯ &lt;code>127.0.0.1:777&lt;/code>ã€&lt;code>127.0.0.1:888&lt;/code>ï¼Œä½†å¯¦éš›ä¸Šæ²’æœ‰é€™å…©å€‹ portï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å†å¯«ä¸€å±¤ä¸€èˆ¬çš„ proxy è¨­å®šï¼Œåˆ†åˆ¥æ˜¯ 1 ~ 10 è¡Œã€12 ~ 21 è¡Œï¼Œé€™æ¨£å­å°±å¯ä»¥é”åˆ°æˆ‘å€‘æƒ³è¦çš„æ•ˆæœã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ä½†é€™å€‹æ–¹æ³•æ¯”è¼ƒé©ç”¨æ–¼ upstream å¾Œç«¯æ²’æœ‰å¤ªå¤šå€‹æœå‹™æˆ–æ˜¯æ©Ÿå™¨çš„æƒ…æ³ï¼Œå¦‚æœæœ‰å¾ˆå¤šå€‹æœå‹™æˆ–æ˜¯æ©Ÿå™¨ï¼Œå°±éœ€è¦å¯«å¾ˆå¤šçš„ proxyï¼Œé€™æ¨£å­æœƒè®Šå¾—å¾ˆéº»ç…©ï¼Œæ‰€ä»¥å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œä¹Ÿæ­¡è¿ç•™è¨€è·Ÿæˆ‘åˆ†äº« ğŸ¤£ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>æœ€å¾Œæˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹å¯¦éš›åŸ·è¡Œçš„çµæœï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/nginx-upstream-set-host-header/2.png" title="ä½¿ç”¨å¤šå±¤çš„ nginx proxy è™•ç†" alt="" loading="lazy" />
&lt;figcaption>ä½¿ç”¨å¤šå±¤çš„ nginx proxy è™•ç†&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>åƒè€ƒ&lt;span class="absolute -mt-20" id="åƒè€ƒ">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://serverfault.com/questions/598202/make-nginx-to-pass-hostname-of-the-upstream-when-reverseproxying" target="_blank" rel="noopener">Make nginx to pass hostname of the upstream when reverseproxying&lt;/a>&lt;/p></description></item></channel></rss>