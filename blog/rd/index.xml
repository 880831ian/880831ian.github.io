<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – RD 使用的相關工具</title><link>https://pin-yi.me/blog/rd/</link><description>Recent content in RD 使用的相關工具 on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><atom:link href="https://pin-yi.me/blog/rd/index.xml" rel="self" type="application/rss+xml"/><item><title>Fluentd-Server 出現 Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch 錯誤解決</title><link>https://pin-yi.me/blog/rd/fluentd-server-show-fluent-plugin-elasticsearch-error400/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/rd/fluentd-server-show-fluent-plugin-elasticsearch-error400/</guid><description>
&lt;p>先說結論 &amp;hellip; &lt;del>EFK 真的好多雷 😆&lt;/del> 我們今天又再度踩雷拉，這次又是炸的分身碎骨，花了 4 個多小時才找到原因，也有可能是小弟我跟 EFK 不是很熟 XD。就如標題所說，我在抽 Log 的時候發現有部分的 Log 送不到 Kibana，檢查 Fluentd-Server 的 Log 發現裡面有 &lt;code>Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch&lt;/code> 的錯誤訊息，到底這個 Error 400 是什麼咧，就跟著我一起重溫找問題的苦難吧 XD&lt;/p>
&lt;br>
&lt;h2>EFK 結構&lt;span class="absolute -mt-20" id="efk-結構">&lt;/span>
&lt;a href="#efk-%e7%b5%90%e6%a7%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>在開始之前我先簡單說一下我現在的 EFK 結構：&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/rd/fluentd-server-show-fluent-plugin-elasticsearch-error400/1.png"
alt="EFK 結構" width="900">&lt;figcaption>
&lt;p>EFK 結構&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>現在的 EFK 結構如上圖，我在要抽 Log 的 Pod 中多塞一個 fluentd-bit container，將 fluentd-bit 與服務(例如 nginx) 的 log 掛相同路徑，讓 fluentd-bit 可以抽到服務 log，接著就透過 fluentd-server-svc 打到 fluentd-server pod，後面就是常見的 EFK 結構，就不多做說明。&lt;/p>
&lt;br>
&lt;h2>問題的出現&lt;span class="absolute -mt-20" id="問題的出現">&lt;/span>
&lt;a href="#%e5%95%8f%e9%a1%8c%e7%9a%84%e5%87%ba%e7%8f%be" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們就像平常一樣寫好整個 EFK 的 yaml，run 的時候也正常，可以收到 log，但很奇怪的是我們先送 &lt;code>log_false&lt;/code> 的 log 可以正常收到，但再接著送 &lt;code>log_true &lt;/code> 就收不到，我們也嘗試反過來送，先送 &lt;code>log_true&lt;/code>，再送 &lt;code>log_false&lt;/code>，發現換收不到 &lt;code>log_false&lt;/code> 的 log&lt;/p>
&lt;br>
&lt;ul>
&lt;li>log_false&lt;/li>
&lt;/ul>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;result&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">false&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;我是馬賽克&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;code&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">11223344&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;data&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;end_at&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2022-12-19 04:09:00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;response_code&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;326dgf241geh1596489&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;job_name&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;叮叮噹噹聖誕節&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;method&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;GET&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;url&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;url.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ul>
&lt;li>log_true&lt;/li>
&lt;/ul>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;result&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;response_code&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;wkCJl1dfr45671607965&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>接著在 Fluentd-Server Log 中發現 Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch 錯誤&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/fluentd-server-show-fluent-plugin-elasticsearch-error400/2.png"
alt="fluentd-server 跳出錯誤 LOG" width="1000">&lt;figcaption>
&lt;p>fluentd-server 跳出錯誤 LOG&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>我到網路上搜尋，看看有沒有人有遇到跟我一樣的問題，發現在 &lt;a href="https://github.com/uken/fluent-plugin-elasticsearch/issues/467" target="_blank" rel="noopener">uken/fluent-plugin-elasticsearch&lt;/a> 也有其他人有遇到同樣的問題&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/fluentd-server-show-fluent-plugin-elasticsearch-error400/3.png"
alt="uken/fluent-plugin-elasticsearch issus 詢問" width="1000">&lt;figcaption>
&lt;p>uken/fluent-plugin-elasticsearch issus 詢問&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>有人說可能是 Elasticsearch 的 disk 滿了，也有人說是裝在 Fluentd-Server 的套件 fluent-plugin-elasticsearch 版本有問題，或是將 Elasticsearch 跟 Kibana index 刪除就可以，我有砍掉 index 再重新倒入 Log，還是會有問題。&lt;/p>
&lt;p>一開始以為是 &lt;code>log_false&lt;/code> 跟 &lt;code>log_true&lt;/code> 的欄位不同，所以才會有這個問題發生（你看就知道我跟 EFK 不熟吧ＸＤ），所以有另外倒一些其他服務(欄位也不同)的 log 進去測試，發現是可以正常抽到，且 kibana 那邊會依照 es 提供的欄位自動新增，所以也不是欄位的問題，那最後的問題是什麼呢？&lt;/p>
&lt;br>
&lt;h2>如何解決問題&lt;span class="absolute -mt-20" id="如何解決問題">&lt;/span>
&lt;a href="#%e5%a6%82%e4%bd%95%e8%a7%a3%e6%b1%ba%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>最後在我們仔細檢查後發現，&lt;code>log_false&lt;/code> 跟 &lt;code>log_true&lt;/code> 的欄位其中一樣存的資料型態不太一樣，發現其中的 &lt;code>data&lt;/code> 欄位在 &lt;code>log_false&lt;/code> 的資料型態是 array，在 &lt;code>log_true&lt;/code> 存的時候是字串，所以導致當其中一個 log 寫入後，另一個 log 就會因為同欄位的資料型態有所不同，而無法寫入 log，且在 Fluentd-Server 會出現標題的 Error 400 原因拉～&lt;/p>
&lt;p>最後重新調整欄位的資料型態，就順利解決此次問題 ✌️✌️✌️&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="absolute -mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Elasticsearch 400 error #467：&lt;a href="https://github.com/uken/fluent-plugin-elasticsearch/issues/467" target="_blank" rel="noopener">https://github.com/uken/fluent-plugin-elasticsearch/issues/467&lt;/a>&lt;/p></description></item><item><title>Kibana 新增 index 索引時一直轉圈圈以及顯示 HTTP 403 Forbidden</title><link>https://pin-yi.me/blog/rd/kibana-create-index-forbidden/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/rd/kibana-create-index-forbidden/</guid><description>
&lt;p>前幾天在工作使用 Kibana 時，想要新增一個新的索引，發現選擇索引並按下新增的按鈕，會一直轉圈圈，等了一陣子，使用開發工具 F12 查看，跳出了 HTTP 403 Forbidden，到底是什麼原因導致的呢！？我們一起看下去吧，會從問題的出現到問題原因再到如何解決問題，來仔細介紹，希望大家不要像我一樣踩到雷 🤣&lt;/p>
&lt;br>
&lt;h2>問題的出現&lt;span class="absolute -mt-20" id="問題的出現">&lt;/span>
&lt;a href="#%e5%95%8f%e9%a1%8c%e7%9a%84%e5%87%ba%e7%8f%be" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;del>那天是個變冷的 12 月&lt;/del>，要幫 RD 同仁新增 Kibana 的索引時，照往常一樣輸入 Index pattern，按下一步，選擇 Configure settings ：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/1.png"
alt="輸入 Index pattern (圖片為範例，正常都是用 -* )" width="800">&lt;figcaption>
&lt;p>輸入 Index pattern (圖片為範例，正常都是用 -* )&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>按下新增索引，他就開始無限的轉圈圈，有去查看 ElasticSearch 的 log，發現也沒有特別的錯誤訊息&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/2.png"
alt="新增索引後，一直轉圈圈" width="800">&lt;figcaption>
&lt;p>新增索引後，一直轉圈圈&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>接著想說打開開發者工具 F12 來看看，是卡在哪一個點，卻發現有幾個紅字寫著 HTTP 403 Forbidden&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/3.png"
alt="開發者工具網頁內容顯示 HTTP 403 Forbidden" width="800">&lt;figcaption>
&lt;p>開發者工具網頁內容顯示 HTTP 403 Forbidden&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>想說為什麼會有 HTTP 403 Forbidden，之前也沒有看過類似的錯誤訊息，於是就開始在網路上亂晃，最後在同事的幫助下找到了一個跟我們情況很相似的文章 &lt;a href="https://www.cnblogs.com/caoweixiong/p/10972120.html" target="_blank" rel="noopener">Kibana 创建索引 POST 403 (forbidden) on create index&lt;/a>&lt;/p>
&lt;br>
&lt;h2>問題原因&lt;span class="absolute -mt-20" id="問題原因">&lt;/span>
&lt;a href="#%e5%95%8f%e9%a1%8c%e5%8e%9f%e5%9b%a0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>文章的說明是索引變成只允許讀取的狀態，其原因是因為出現這個 HTTP 403 Forbidden 前，ElasticSearch 的空間滿了，導致 Kibana 會自動的將索引改成只允許讀取的狀態，我們來看一下剛剛的 Index 狀態是不是像他說的一樣變成只允許讀取的狀態呢&lt;/p>
&lt;br>
&lt;div class="overflow-x-auto mt-6 flex rounded-lg border py-2 ltr:pr-4 rtl:pl-4 contrast-more:border-current contrast-more:dark:border-current border-orange-100 bg-orange-50 text-orange-800 dark:border-orange-400/30 dark:bg-orange-400/20 dark:text-orange-300">
&lt;div class="ltr:pl-3 ltr:pr-2 rtl:pr-3 rtl:pl-2">&lt;/div>
&lt;div class="w-full min-w-0 leading-7">
&lt;div class="mt-6 leading-7 first:mt-0">
可以到 kibana 的 Dev Tools 下指令來查詢歐，輸入 &lt;code>GET _settings&lt;/code>，就會顯示以下圖片的內容囉
&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/4.png"
alt="索引只允許讀取的設定變成" width="900">&lt;figcaption>
&lt;p>索引只允許讀取的設定變成&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>發現正如文章所說，是因為 read_only_allow_delete 的狀態變成了 &lt;code>true&lt;/code>，所以才沒辦法新增索引～&lt;/p>
&lt;br>
&lt;h2>如何解決問題&lt;span class="absolute -mt-20" id="如何解決問題">&lt;/span>
&lt;a href="#%e5%a6%82%e4%bd%95%e8%a7%a3%e6%b1%ba%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們查看文章的解決辦法，有兩種辦法，一個是擴大 ElasticSearch 的空間，以及使用 kibana 的 Dev Tools 下指令修改，那我們兩種都有做，這邊就直接介紹下指令需要輸入什麼～&lt;/p>
&lt;p>需要再 Dev Tools 輸入以下指令，來修改 Index 的狀態：&lt;/p>
&lt;br>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">PUT&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">_settings&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;index&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;blocks&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;read_only_allow_delete&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;false&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/5.png"
alt="Dev Tools 修改 Index 的狀態" width="600">&lt;figcaption>
&lt;p>Dev Tools 修改 Index 的狀態&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>最後我們用 &lt;code>GET _settings&lt;/code> 檢查一下索引狀態是不是已經變回原本的了：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/6.png"
alt="索引只允許讀取的設定變成 false" width="900">&lt;figcaption>
&lt;p>索引只允許讀取的設定變成 false&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>最後就可以順利新增索引拉 👍👍👍&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/rd/kibana-create-index-forbidden/7.png"
alt="順利新增索引" width="900">&lt;figcaption>
&lt;p>順利新增索引&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="absolute -mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Kibana 创建索引 POST 403 (forbidden) on create index：&lt;a href="https://www.cnblogs.com/caoweixiong/p/10972120.html" target="_blank" rel="noopener">https://www.cnblogs.com/caoweixiong/p/10972120.html&lt;/a>&lt;/p></description></item><item><title>如何啟用 GitLab 的 Package Registry 以及將儲存位置從伺服器改到 GCS 上</title><link>https://pin-yi.me/blog/rd/gitlab-package-registry-to-gcs/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/rd/gitlab-package-registry-to-gcs/</guid><description>
&lt;p>今天接到一個案子，RD 部門之後想要使用 GitLab 的 Package Registry 功能來發布套件，且不想把它存在 GitLab 伺服器上，希望可以直接存到 GCP 的 Google Cloud Storage 上，所以才會有了此篇筆記來記錄一下整個過程。&lt;/p>
&lt;br>
&lt;p>版本資訊&lt;/p>
&lt;ul>
&lt;li>GitLab 14.10 (有部分設定會於新版本棄用，請記得確認好自己的版本是否支援)&lt;/li>
&lt;/ul>
&lt;p>先說一下，我們的 GitLab 是使用 docker-compose 來建置，所以後續的實作內容都會以 docker-compose 的方式來介紹。&lt;/p>
&lt;br>
&lt;h2>啟動 GitLab 的 Package Registry&lt;span class="absolute -mt-20" id="啟動-gitlab-的-package-registry">&lt;/span>
&lt;a href="#%e5%95%9f%e5%8b%95-gitlab-%e7%9a%84-package-registry" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>首先，我們當然要先啟動這項 Package Registry 功能，才可以再之後使用它，我們先看一下 GitLab 啟動的 docker-compose.yml 檔案：&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">version&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;3&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">services&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">gitlab&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">image&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;gitlab/gitlab-ee:14.10.5-ee.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">restart&lt;/span>: &lt;span style="color:#ae81ff">always&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">container_name&lt;/span>: &lt;span style="color:#ae81ff">gitlab&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">hostname&lt;/span>: &lt;span style="color:#ae81ff">gitlab-pid&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">logging&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">driver&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;json-file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">options&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">max-size&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;100m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">max-file&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;50&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">environment&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">GITLAB_OMNIBUS_CONFIG&lt;/span>: |&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> external_url &amp;#39;${GITLAB_DOMAIN}&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> letsencrypt[&amp;#39;enable&amp;#39;] = false
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;initial_root_password&amp;#39;] = &amp;#39;${GITLAB_ROOT_PASSWORD}&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;gitlab_shell_ssh_port&amp;#39;] = &amp;#39;${GITLAB_HOST_SSH_PORT}&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;backup_keep_time&amp;#39;] = 79200
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;omniauth_allow_single_sign_on&amp;#39;] = [&amp;#39;google_oauth2&amp;#39;]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;omniauth_block_auto_created_users&amp;#39;] = false
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;omniauth_sync_profile_from_provider&amp;#39;] = [&amp;#39;google_oauth2&amp;#39;]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;omniauth_sync_profile_attributes&amp;#39;] = [&amp;#39;name&amp;#39;, &amp;#39;email&amp;#39;]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> gitlab_rails[&amp;#39;omniauth_providers&amp;#39;] = [
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">略過．．．&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">ports&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;${GITLAB_HOST_SSH_PORT}:22&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;${GITLAB_HOST_HTTP_PORT}:80&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;${GITLAB_HOST_HTTPS_PORT}:443&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">volumes&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;./config:/etc/gitlab&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;./logs:/var/log/gitlab&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#39;./data:/var/opt/gitlab&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>有些設定有略過或是省略不寫，大家就依照自己的設定來看就好～&lt;/p>
&lt;br>
&lt;h2>新增 Package Registry 設定&lt;span class="absolute -mt-20" id="新增-package-registry-設定">&lt;/span>
&lt;a href="#%e6%96%b0%e5%a2%9e-package-registry-%e8%a8%ad%e5%ae%9a" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們在上方的 &lt;code>gitlab_rails['omniauth_providers'] = [ ... 略 ... ] &lt;/code> 之後加上新增 Package Registry 設定內容：&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_enabled&amp;#39;] = true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_object_store_enabled&amp;#39;] = true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_object_store_remote_directory&amp;#39;] = &amp;#34;GCS 名稱&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_object_store_direct_upload&amp;#39;] = true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_object_store_background_upload&amp;#39;] = true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_object_store_proxy_download&amp;#39;] = true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">gitlab_rails[&amp;#39;packages_object_store_connection&amp;#39;] = {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#39;provider&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">=&amp;gt; &amp;#39;Google&amp;#39;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#39;google_project&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">=&amp;gt; &amp;#39;專案 ID&amp;#39;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#39;google_json_key_location&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">=&amp;gt; &amp;#39;/etc/gitlab/google_key.json&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>packages_enabled：啟動 packages&lt;/li>
&lt;li>packages_object_store_enabled：啟動 packages 對象存儲&lt;/li>
&lt;li>packages_object_store_remote_directory：設定 packages 對象存儲位置，這邊要輸入 GCS 的名稱&lt;/li>
&lt;li>packages_object_store_direct_upload：設定是否可以直接上傳到對象存儲位置&lt;/li>
&lt;li>packages_object_store_background_upload：設定是否以後台方式上傳到對象存儲位置&lt;/li>
&lt;li>packages_object_store_proxy_download：設定是否可以透過代理伺服器進行套件下載&lt;/li>
&lt;li>packages_object_store_connection：設定連接到對象存儲，由於我們要存到 GCS 上面，需要有這三項 provider、google_project、google_json_key_location 才可以將 packages 存到 GCS 上。如果想用其他的儲存位置，例如 Amazon S3、Azure Blob storage 可以參考 &lt;a href="https://docs.gitlab.com/ee/administration/object_storage.html" target="_blank" rel="noopener">Object storage 詳細設定&lt;/a> ( 其中的 google_json_key_location 是要放可以讀寫 GCS 的 SA SECRET 檔案 )&lt;/li>
&lt;/ul>
&lt;br>
&lt;h2>先查看尚未重啟的 GitLab Package&lt;span class="absolute -mt-20" id="先查看尚未重啟的-gitlab-package">&lt;/span>
&lt;a href="#%e5%85%88%e6%9f%a5%e7%9c%8b%e5%b0%9a%e6%9c%aa%e9%87%8d%e5%95%9f%e7%9a%84-gitlab-package" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>由於公司 GitLab 預設有先開啟 packages_enabled，所以我就拿同事用 Helm 寫的 CI，來做測試。當更新 value.yaml 後會自動打包 Package 放到 Package Registry 中，我們直接進入到預設 Package Registry 的儲存位置，是在 &lt;code>/var/opt/gitlab/gitlab-rails/shared/packages/&lt;/code>，用指令發現打包的 Package 的確存放於此 ，如下：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/other/gitlab-package-registry-to-gcs/1.png"
alt="檢查是否還有 Package 在預設儲存位置 (尚未遷移)" width="800">&lt;figcaption>
&lt;p>檢查是否還有 Package 在預設儲存位置 (尚未遷移)&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>重啟設定後再次檢查 GitLab Package&lt;span class="absolute -mt-20" id="重啟設定後再次檢查-gitlab-package">&lt;/span>
&lt;a href="#%e9%87%8d%e5%95%9f%e8%a8%ad%e5%ae%9a%e5%be%8c%e5%86%8d%e6%ac%a1%e6%aa%a2%e6%9f%a5-gitlab-package" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>當我們重啟設定後，也有建立好可供我們權限 SA 的 GCS 後，會發現原本存在預設 &lt;code>/var/opt/gitlab/gitlab-rails/shared/packages/&lt;/code> 沒有自動跑到 GCS 上，是因為我們還需要手動下指令將他遷移過去，指令是 &lt;code>gitlab-rake &amp;quot;gitlab:packages:migrate&amp;quot;&lt;/code>，最後等他跑完我們在檢查一下預設儲存位置就發現已經沒有 Package 了&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/other/gitlab-package-registry-to-gcs/2.png"
alt="檢查是否還有 Package 在預設儲存位置 (已遷移)" width="800">&lt;figcaption>
&lt;p>檢查是否還有 Package 在預設儲存位置 (已遷移)&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>開 GCS 網站來看會發現原先在預設儲存位置的 Package 都可以跑到 GCS 上：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/other/gitlab-package-registry-to-gcs/3.png"
alt="查看已遷移到 Google Cloud Storage 的 Package" width="800">&lt;figcaption>
&lt;p>查看已遷移到 Google Cloud Storage 的 Package&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="absolute -mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>GitLab Package Registry administration：&lt;a href="https://docs.gitlab.com/14.10/ee/administration/packages/" target="_blank" rel="noopener">https://docs.gitlab.com/14.10/ee/administration/packages/&lt;/a>&lt;/p></description></item></channel></rss>