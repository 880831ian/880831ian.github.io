<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – Amazon Web Services</title><link>https://pin-yi.me/blog/aws/</link><description>Recent content in Amazon Web Services on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><atom:link href="https://pin-yi.me/blog/aws/index.xml" rel="self" type="application/rss+xml"/><item><title>如何共用 ECR 給同一個 AWS Organization 的其他 AWS Account EKS 使用</title><link>https://pin-yi.me/blog/aws/aws-ecr-permissions/</link><pubDate>Wed, 25 Jun 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ecr-permissions/</guid><description>
&lt;p>這篇主要是因為公司目前的 AWS 架構，會將各單位的系統依照產品、環境給拆分，但有時候部署，總會有一些共用的 Image。
在這之前，我們需要一個一個將相同的 Image 搬到每個 AWS Account 的 ECR，當時就在想，是否可以直接共用 ECR 給同一個 AWS Organization 的其他 AWS Account 使用 (當然也不要用 Public ECR 來避免安全性問題)。&lt;/p>
&lt;br>
&lt;div class="hx-overflow-x-auto hx-mt-6 hx-flex hx-flex-col hx-rounded-lg hx-border hx-py-4 hx-px-4 contrast-more:hx-border-current contrast-more:dark:hx-border-current hx-border-blue-200 hx-bg-blue-100 hx-text-blue-900 dark:hx-border-blue-200/30 dark:hx-bg-blue-900/30 dark:hx-text-blue-200">
&lt;p class="hx-flex hx-items-center hx-font-medium">&lt;svg height=16px class="hx-inline-block hx-align-middle hx-mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>&lt;/svg>範例 AWS Account 說明&lt;/p>
&lt;div class="hx-w-full hx-min-w-0 hx-leading-7">
&lt;div class="hx-mt-6 hx-leading-7 first:hx-mt-0">&lt;p>為了方便說明，我會使用兩個 AWS Account 來做範例，632xxxxx1762 (後面簡稱 A 帳號) 以及 722xxxxx9750 (後面簡稱 B 帳號)，這兩個帳號都屬於同一個 AWS Organization。&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>那我們就直接來看要如何設定，首先我先在 632xxxxx1762 (後面簡稱 A 帳號) 放了一個 ECR，名稱是：&lt;code>audit/sa/cicd-runner&lt;/code>，Tag 是 &lt;code>latest&lt;/code>，它會是我之後想要共享給其他 AWS Account 使用的 ECR。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ecr-permissions/1.png"
alt="A 帳號 ECR" width="650">&lt;figcaption>
&lt;p>A 帳號 ECR&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>那如果我們使用另一個 AWS Account 722xxxxx9750 (後面簡稱 B 帳號) 直接拉這個 ECR 的 Image，會發生什麼錯誤呢？&lt;/p>
&lt;p>我們先切換到 B 帳號，然後使用 &lt;code>kubectl&lt;/code> 來部署一個 Pod，Pod 的 Image 寫 A 帳號的 ECR Image 名稱。&lt;/p>
&lt;ul>
&lt;li>cicd-runner.yaml&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">apps/v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">Pod&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">cicd-runner&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">containers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">cicd-runner&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">image&lt;/span>: &lt;span style="color:#ae81ff">632xxxxx1762.dkr.ecr.ap-southeast-1.amazonaws.com/audit/sa/cicd-runner:latest&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">imagePullPolicy&lt;/span>: &lt;span style="color:#ae81ff">Always&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>觀察一下 Pod 的狀態，會發現 Pod 會出現 &lt;code>ErrImagePull&lt;/code> 的錯誤，這是因為 B 帳號沒有權限去拉取 A 帳號的 ECR Image。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ecr-permissions/2.png"
alt="Pod ErrImagePull 錯誤" width="1200">&lt;figcaption>
&lt;p>Pod ErrImagePull 錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>那要怎麼解決呢？！
以及我們要怎麼讓 B 帳號可以拉取 A 帳號的 ECR Image 呢？&lt;/p>
&lt;p>其實很簡單，我們只需要在 A 帳號的 ECR 上設定一個 IAM Policy，讓 B 帳號可以拉取這個 ECR 的 Image。&lt;/p>
&lt;p>如果以 Console 來設定的話，我們可以在 A 帳號的 ECR 上，點選 &lt;code>Private registry&lt;/code> &amp;gt; &lt;code>Permissions&lt;/code>，然後選擇 &lt;code>Edit policy JSON&lt;/code>。
(如果之後使用 Terraform 來設定的話，可以參考 &lt;a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecr_repository_policy" target="_blank" rel="noopener">AWS ECR Repository Policy&lt;/a> 的相關文件。)&lt;/p>
&lt;p>將以下的 JSON 給貼進去，當然相關的設定可以再自行調整：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2008-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Sid&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AllowPullFromOrg&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ecr:BatchCheckLayerAvailability&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ecr:BatchGetImage&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ecr:GetDownloadUrlForLayer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalOrgID&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;o-xxxxxxx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這裡的 &lt;code>o-xxxxxxx&lt;/code> 是你的 AWS Organization ID，可以在 AWS Organizations 的 Console 中找到。&lt;/p>
&lt;br>
&lt;p>簡單說明一下這邊的設定：&lt;/p>
&lt;ul>
&lt;li>&lt;code>Principal&lt;/code> 設定為 &lt;code>*&lt;/code>，表示允許所有人。&lt;/li>
&lt;li>&lt;code>Action&lt;/code> 設定為 ECR 的相關拉取權限。&lt;/li>
&lt;li>&lt;code>Condition&lt;/code> 設定為 &lt;code>aws:PrincipalOrgID&lt;/code>，這樣就限制了只有同一個 AWS Organization 的帳號可以拉取這個 ECR 的 Image。(當然我們也可以改指定特定的 AWS Account ID，這樣就只有指定的帳號可以拉取。)&lt;/li>
&lt;/ul>
&lt;br>
&lt;p>設定完畢後，我們可以回到 B 帳號，重新部署剛剛的 Pod。&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>kubectl apply -f cicd-runner.yaml&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>就可以發現 Pod 成功啟動了，並且可以正常拉取 A 帳號的 ECR Image。&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ecr-permissions/3.png"
alt="Pod 成功啟動" width="1200">&lt;figcaption>
&lt;p>Pod 成功啟動&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>這樣就完成了如何共用 ECR 給同一個 AWS Organization 的其他 AWS Account 使用的設定。&lt;/p></description></item><item><title>AWS EKS Pod 出現 aws-cni failed to assign an IP address to container 錯誤</title><link>https://pin-yi.me/blog/aws/aws-cni-failed-to-assign-ip/</link><pubDate>Wed, 11 Dec 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-cni-failed-to-assign-ip/</guid><description>
&lt;p>此文章是我在公司擔任架構師，在負責稽核資源使用時，有發現有同仁的 AWS EKS node_group 資源開太大 (開發環境使用 2xlarge 機器規格)，所以先手動從 UI 去調整 Node 的機器規格 (RD 未提供建立時的 Terraform 版控)，從 m7g.2xlarge 先改成 m7g.large。&lt;/p>
&lt;p>但由於同仁是用 Terraform 來建置整座 EKS + node_group，有 Launch Templates 以及 Auto Scaling Groups 等元件，能調整機器規格的只能從 Launch Templates 以及 Auto Scaling Groups，但 Launch Templates 沒辦法編輯 (只能新增、刪除)，當時為了想要先快速的減少花費，因此先直接調整 Auto Scaling Groups 的 Node 機器規格。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/1.png"
alt="Auto Scaling Groups 設定" width="650">&lt;figcaption>
&lt;p>Auto Scaling Groups 設定&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>遇到問題&lt;span class="hx-absolute -hx-mt-20" id="遇到問題">&lt;/span>
&lt;a href="#%e9%81%87%e5%88%b0%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>調整完後，再使用 Auto Scaling Groups 的 instance refresh 去更新機器規格，這時候會發現，新 Node 上的 Pod 會偶發出現以下錯誤訊息：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-txt" data-lang="txt">&lt;span style="display:flex;">&lt;span>Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox &amp;#34;XXXXXXXXX&amp;#34;: plugin type=&amp;#34;aws-cni&amp;#34; name=&amp;#34;aws-cni&amp;#34; failed (add): add cmd: failed to assign an IP address to container&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>尋找問題&lt;span class="hx-absolute -hx-mt-20" id="尋找問題">&lt;/span>
&lt;a href="#%e5%b0%8b%e6%89%be%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>排除 Subnet IP 用完的情況&lt;span class="hx-absolute -hx-mt-20" id="排除-subnet-ip-用完的情況">&lt;/span>
&lt;a href="#%e6%8e%92%e9%99%a4-subnet-ip-%e7%94%a8%e5%ae%8c%e7%9a%84%e6%83%85%e6%b3%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>一開始看錯誤訊息 &lt;code>aws-cni failed to assign an IP address to container&lt;/code> 以為是 subnet 的 IP 已經被 Pod 用完了，所以先使用以下指令來查看 Subnet 的可用 IP 數量：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ec2 describe-subnets &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --query &lt;span style="color:#e6db74">&amp;#34;Subnets[*].{SubnetId:SubnetId, AvailableIps:AvailableIpAddressCount, CidrBlock:CidrBlock}&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --output table&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/2.png"
alt="（輸出範例，非當下 Subnet）" width="550">&lt;figcaption>
&lt;p>（輸出範例，非當下 Subnet）&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>也可以從 UI 去看每一個 Subnet 的可用 IP 是多少：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/3.png"
alt="AWS UI 查看 Subnet 可用 IP" width="750">&lt;figcaption>
&lt;p>AWS UI 查看 Subnet 可用 IP&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx-overflow-x-auto hx-mt-6 hx-flex hx-flex-col hx-rounded-lg hx-border hx-py-4 hx-px-4 contrast-more:hx-border-current contrast-more:dark:hx-border-current hx-border-blue-200 hx-bg-blue-100 hx-text-blue-900 dark:hx-border-blue-200/30 dark:hx-bg-blue-900/30 dark:hx-text-blue-200">
&lt;p class="hx-flex hx-items-center hx-font-medium">&lt;svg height=16px class="hx-inline-block hx-align-middle hx-mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>&lt;/svg>AWS Subnet 計算方式：&lt;/p>
&lt;div class="hx-w-full hx-min-w-0 hx-leading-7">
&lt;div class="hx-mt-6 hx-leading-7 first:hx-mt-0">&lt;p>假設是 /24 計算是： 32-24=8，2 的 8 次方 = 256&lt;br>
AWS 會保留 5 個 IP，如下：&lt;br>
XX.XX.XX.0：網路位置&lt;br>
XX.XX.XX.1：VPC 路由器位址&lt;br>
XX.XX.XX.2：Amazon DNS 位址&lt;br>
XX.XX.XX.3：保留給未來用途&lt;br>
XX.XX.XX.255：廣播位址&lt;br>
所以最多可用的 IP 數量是 256-5=251&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>排除 Pod 數量超過 Node 的限制&lt;span class="hx-absolute -hx-mt-20" id="排除-pod-數量超過-node-的限制">&lt;/span>
&lt;a href="#%e6%8e%92%e9%99%a4-pod-%e6%95%b8%e9%87%8f%e8%b6%85%e9%81%8e-node-%e7%9a%84%e9%99%90%e5%88%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>排除了 Subnet 用完的情況，後來搜尋了一下文件，發現 AWS 的機器規格，會限制一個 Node 上面，最多能長有幾個 Pod，這個跟 Amazon VPC CNI 插件有關，下面附上一些相關的問題連結：&lt;/p>
&lt;p>&lt;a href="https://github.com/aws/amazon-vpc-cni-k8s/issues/3066" target="_blank" rel="noopener">Non fatal but persistent warning: &amp;ldquo;Failed to create pod sandbox &amp;hellip; failed to assign an IP address to container.&amp;rdquo; #3066&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://serverfault.com/questions/1156773/aws-vpc-cni-plugin-error-container-runtime-network-not-ready-due-to-networkpl" target="_blank" rel="noopener">AWS VPC CNI PLUGIN - Error: container runtime network not ready due to NetworkPluginNotReady - How to Resolve&lt;/a>&lt;/p>
&lt;br>
&lt;p>那要怎麼計算什麼機器規格，Pod 的最大限制是多少，可以用這個公式來計算&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>ENI * (# of IPv4 per ENI - 1) &amp;#43; 2&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>可以先用這個指令來看 ENI 以及 IPv4 per ENI 各是多少：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ec2 describe-instance-types &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --filters &lt;span style="color:#e6db74">&amp;#34;Name=instance-type,Values=c5.*&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --query &lt;span style="color:#e6db74">&amp;#34;InstanceTypes[].{ \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> Type: InstanceType, \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> MaxENI: NetworkInfo.MaximumNetworkInterfaces, \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --output table&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AvailableIpPerENI.html" target="_blank" rel="noopener">Maximum IP addresses per network interface&lt;/a>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/4.png"
alt="每個機器規格對應的 IP 以及 MaxENI" width="400">&lt;figcaption>
&lt;p>每個機器規格對應的 IP 以及 MaxENI&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>已 c5.4xlarge 來說，就是 8*(30-1)+2 = 234，一個 Node 最多 234 個 Pod，c5.xlarge 來說，就是 4*(15-1)+2 = 58，一個 Node 最多 58 個 Pod。&lt;/p>
&lt;br>
&lt;p>但如果每次都要自己計算，會有點麻煩，所以這邊再提供幾個方式：&lt;/p>
&lt;ol>
&lt;li>官方已經計算好的對應表：&lt;a href="https://github.com/awslabs/amazon-eks-ami/blob/main/templates/shared/runtime/eni-max-pods.txt" target="_blank" rel="noopener">https://github.com/awslabs/amazon-eks-ami/blob/main/templates/shared/runtime/eni-max-pods.txt&lt;/a>&lt;/li>
&lt;li>每個 Amazon EC2 執行個體類型建議的最大 Pod 數腳本：&lt;a href="https://docs.aws.amazon.com/eks/latest/userguide/choosing-instance-type.html#determine-max-pods" target="_blank" rel="noopener">Amazon EKS recommended maximum Pods for each Amazon EC2 instance type&lt;/a>
(但這個計算最高只會顯示 110，詳細可以看文件)&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/5.png"
alt="使用腳本計算不同 CNI version 以及機器的可用 Pod 數量" width="650">&lt;figcaption>
&lt;p>使用腳本計算不同 CNI version 以及機器的可用 Pod 數量&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>但是，如果是超過 Node 的 Pod 最高限制，應該也會是顯示以下的無法調度錯誤，而不是 &lt;code>aws-cni failed to assign an IP address to container&lt;/code> 錯誤：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/6.png"
alt="無法調度的範例錯誤" width="650">&lt;figcaption>
&lt;p>無法調度的範例錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>找到問題&lt;span class="hx-absolute -hx-mt-20" id="找到問題">&lt;/span>
&lt;a href="#%e6%89%be%e5%88%b0%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>最後發現，因為我們最一開始只調整了 Auto Scaling Groups 的機器規格，調整完後，資源的確是降低了（從 8 vCPUs / 32.0 GiB → 2 vCPUs / 8.0 GiB），但 Node 的 Allocatable pod 卻還是原本的數量限制，原因是 Controller plane 不知道我們有調整 (Auto Scaling Groups 只會調整 node_group)。&lt;/p>
&lt;p>因此，當服務開上去，Node 能長的 Pod 上限還是舊的 m7g.2xlarge 58 個，但對於 aws-node 來說，cni 最多只能 m7g.large 29 個，所以超過 29 的都會出現這個錯誤，把它趕到其他 Node (還沒有滿 29 上限) 就正常。&lt;/p>
&lt;br>
&lt;ul>
&lt;li>可以用這個指令看到目前 Node 的 HOSTNAME、instance-type、allocatable.pods：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>kubectl get nodes -o custom-columns&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;HOSTNAME:.metadata.name,INSTANCE-TYPE:.metadata.labels.node\\.kubernetes\\.io/instance-type,ALLOCATABLE-PODS:.status.allocatable.pods&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ul>
&lt;li>有問題的 Node&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/7.png"
alt="有問題的 Node Allocatable-Pods" width="700">&lt;figcaption>
&lt;p>有問題的 Node Allocatable-Pods&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ul>
&lt;li>正常的 Node&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cni-failed-to-assign-ip/8.png"
alt="正常的 Node Allocatable-Pods" width="700">&lt;figcaption>
&lt;p>正常的 Node Allocatable-Pods&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>解決問題&lt;span class="hx-absolute -hx-mt-20" id="解決問題">&lt;/span>
&lt;a href="#%e8%a7%a3%e6%b1%ba%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>所以我們要避免這個問題有兩個解法：&lt;/p>
&lt;ol>
&lt;li>更換機器規格需要重建 Launch Templates，用先建後拆，不能只更新 Auto Scaling Groups。&lt;/li>
&lt;li>用 Terraform 做完整的管理。&lt;/li>
&lt;/ol>
&lt;br>
&lt;h2>參考資料&lt;span class="hx-absolute -hx-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Maximum IP addresses per network interface：&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AvailableIpPerENI.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AvailableIpPerENI.html&lt;/a>&lt;/p></description></item><item><title>Amazon Virtual Private Cloud (VPC) 介紹</title><link>https://pin-yi.me/blog/aws/vpc-introduce/</link><pubDate>Mon, 02 Sep 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/vpc-introduce/</guid><description>
&lt;p>此篇單純是我自己學習 AWS VPC 的筆記，主要是為了熟悉 AWS 的 VPC，了解 VPC 包含哪些元件，以及如何建立 VPC、設定 VPC 等等。&lt;/p>
&lt;br>
&lt;h2>武功秘笈&lt;span class="hx-absolute -hx-mt-20" id="武功秘笈">&lt;/span>
&lt;a href="#%e6%ad%a6%e5%8a%9f%e7%a7%98%e7%ac%88" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>文章主要參考：&lt;a href="https://godleon.github.io/blog/AWS/AWS-CSA-associate-VPC-part1/" target="_blank" rel="noopener">AWS CSA Associate 學習筆記 - VPC(Virtual Private Cloud) Part 1&lt;/a>，這篇文章寫得很詳細，當然，我會加上一些自己的理解跟測試範例，如果有興趣的話，可以去看看原文。&lt;/p>
&lt;br>
&lt;h2>什麼是 VPC？&lt;span class="hx-absolute -hx-mt-20" id="什麼是-vpc">&lt;/span>
&lt;a href="#%e4%bb%80%e9%ba%bc%e6%98%af-vpc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>VPC 的全名是 Virtual Private Cloud，可以在 AWS 雲端內配置邏輯上隔離的虛擬網路。透過建立自己的 VPC，可以完全控制網路環境，包括定義 IP 位址範圍、子網路、路由表和連接選項的能力。&lt;/p>
&lt;p>每個 AWS 帳號包含每個 AWS 區域的預設 VPC。預設 VPC 有先設置好一些設定，方便我們可以快速啟動資源的便捷選項。但是預設 VPC 沒辦法符合長期的網路需求，這時候就需要自己建立 VPC。&lt;/p>
&lt;p>建立額外的 VPC 還有很多優勢，例如：可以按照部門或業務隔離工作負載，可以設定更多的安全性控制 (Network ACL &amp;amp; Security Group)，可以設定更多詳細的網路設定。&lt;/p>
&lt;p>還可以幫 VPC 建立 VPN 連線，將地端網路與 AWS VPC 連接起來，變成一個 Hybrid Cloud 架構。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/vpc-introduce/1.png"
alt="VPC 架構 什麼是 Amazon VPC" width="550">&lt;figcaption>
&lt;p>VPC 架構 &lt;a href="https://docs.aws.amazon.com/zh_tw/vpc/latest/userguide/what-is-amazon-vpc.html" target="_blank" rel="noopener">什麼是 Amazon VPC&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>從圖片來看，可以知道：&lt;/p>
&lt;ul>
&lt;li>VPC 會在 Region 層級底下，每個 Region 可以有多個 VPC。&lt;/li>
&lt;li>VPC 是跨 Availability Zone (AZ) 的，可以在不同的 AZ 建立 Subnet。&lt;/li>
&lt;li>VPC 會透過 Internet Gateway (IGW) 連接到 Internet。&lt;/li>
&lt;/ul>
&lt;br>
&lt;h2>VPC 元件&lt;span class="hx-absolute -hx-mt-20" id="vpc-元件">&lt;/span>
&lt;a href="#vpc-%e5%85%83%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>從上面可以簡單知道 VPC 架構，那我們來詳細看一下每個組成的元件是什麼，先看細圖：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/vpc-introduce/2.jpg"
alt="VPC Data Flow Virtual Private Cloud" width="800">&lt;figcaption>
&lt;p>VPC Data Flow &lt;a href="https://salmankhalid85.wordpress.com/aws/virtual-private-cloud/" target="_blank" rel="noopener">Virtual Private Cloud&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>我們從最大的元件開始看：&lt;/p>
&lt;h3>Region &amp;amp; VPC&lt;span class="hx-absolute -hx-mt-20" id="region--vpc">&lt;/span>
&lt;a href="#region--vpc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>上方淺藍色外框就代表 Region，每個 Region 可以有多個 VPC，範例的 Region 是 eu-west-2。&lt;/p>
&lt;p>深藍色外框就代表 VPC，VPC 是在 Region 層級底下。&lt;/p>
&lt;br>
&lt;h3>Internet Gateway (IGW) &amp;amp; Virtual Private Gateway (VGW)&lt;span class="hx-absolute -hx-mt-20" id="internet-gateway-igw--virtual-private-gateway-vgw">&lt;/span>
&lt;a href="#internet-gateway-igw--virtual-private-gateway-vgw" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>要存取 VPC 的方式有兩種，一種是透過 IGW 可以從 Internet 存取 VPC，另一種是透過 VGW 可以從地端網路存取 VPC。&lt;/p>
&lt;p>不管從 IGW 或 VGW 存取 VPC，都會先到 Route，Route 會根據 traffic 的來源跟目的地，決定要套用哪個 Route Table Rule。&lt;/p>
&lt;p>接著 Route Table 會根據 Rule 決定 traffic 要往哪個方向走，並導向到不同的 Network ACL 來進行流量的控制。&lt;/p>
&lt;br>
&lt;h3>Internet Gateway (IGW)&lt;span class="hx-absolute -hx-mt-20" id="internet-gateway-igw">&lt;/span>
&lt;a href="#internet-gateway-igw" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>(比較會用到，另外拉出來說)&lt;/p>
&lt;p>Internet Gateway (IGW) 有自動水平擴展，以及 HA (High Availability) 的特性，會由 AWS 負責管理，我們不需要特別設定。&lt;/p>
&lt;p>沒有對外的頻寬限制。&lt;/p>
&lt;p>每個 default VPC 都會有一個 Internet Gateway (IGW)。&lt;/p>
&lt;br>
&lt;h3>Route Table&lt;span class="hx-absolute -hx-mt-20" id="route-table">&lt;/span>
&lt;a href="#route-table" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Route Table 是用來指引網路流量要怎麼走，以及去哪裡。Route Table 會有目的地 IP 以及下一站要去哪。&lt;/p>
&lt;p>預設情況下，VPC 內部的 traffic 可以在不同的 subnet 之間自由流動，依靠的就是 &lt;code>local route&lt;/code>。&lt;/p>
&lt;p>local route 是預設存在，且無法修改的。&lt;/p>
&lt;p>VPC 中可以設定多組的 Route Table，但每個 Subnet 只能指定一組 Route Table，且已經與 Subnet 關聯的 Route Table 不能刪除。&lt;/p>
&lt;br>
&lt;h3>Network ACL (NACL)&lt;span class="hx-absolute -hx-mt-20" id="network-acl-nacl">&lt;/span>
&lt;a href="#network-acl-nacl" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Network ACL 是網路進到 VPC 的第一道防禦，可以把它想成是一個子網級別的防火牆，用於控制進入和出去子網的流量。&lt;/p>
&lt;p>Network ACL 是 stateless，這意味著進入和出去的流量都必須明確允許。如果允許進入流量 (inbound traffic)，出去的流量 (outbound traffic) 必須單獨設定規則允許。&lt;/p>
&lt;br>
&lt;h3>Security Group (SG)&lt;span class="hx-absolute -hx-mt-20" id="security-group-sg">&lt;/span>
&lt;a href="#security-group-sg" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>是網路進入的第二道防禦，是虛擬防火牆，用於控制 EC2 實例的進入和出去流量。&lt;/p>
&lt;p>但是比較不一樣的是 Security Group 是 stateful，這意味著如果允許進入流量 (inbound traffic)，相應的出去回應流量 (outbound response traffic) 也自動被允許，反之亦然。&lt;/p>
&lt;p>&lt;b>就算移除 Allow Outbound Traffic 規則，一樣還是會通&lt;/b>&lt;/p>
&lt;br>
&lt;h3>Subnet (Public &amp;amp; Private)&lt;span class="hx-absolute -hx-mt-20" id="subnet-public--private">&lt;/span>
&lt;a href="#subnet-public--private" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Subnet 是 VPC 的子網路，可以在不同的 Availability Zone (AZ) 建立 Subnet。&lt;/p>
&lt;p>Subnet 又分成 Public Subnet 跟 Private Subnet，Public Subnet 可以連到 Internet，Private Subnet 則不能。&lt;/p>
&lt;p>但如果 Private Subnet 需要連到 Internet (例如 EC2 更新套件版本等)，則需要透過 NAT Gateway 來達成 (只有單向，沒辦法讓外部網路連進來)。&lt;/p>
&lt;p>Subnet 跟 Subnet 之間要溝通，則需要透過 Route Table 來指引路線。&lt;/p>
&lt;br>
&lt;h2>VPC IP 範圍&lt;span class="hx-absolute -hx-mt-20" id="vpc-ip-範圍">&lt;/span>
&lt;a href="#vpc-ip-%e7%af%84%e5%9c%8d" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>目前 AWS 支援的 IP 範圍是根據 RFC 1918 標準。以下是可用的私有 IP 範圍：&lt;/p>
&lt;ul>
&lt;li>10.0.0.0 - 10.255.255.255（10.0.0.0/8，總共 16,777,216 個 IP 地址）&lt;/li>
&lt;li>172.16.0.0 - 172.31.255.255（172.16.0.0/12，總共 1,048,576 個 IP 地址）&lt;/li>
&lt;li>192.168.0.0 - 192.168.255.255（192.168.0.0/16，總共 65,536 個 IP 地址）&lt;/li>
&lt;/ul>
&lt;p>&lt;b>一個 VPC 最多可以使用 5 個 Ipv4 CIDR 設定，但一般只會設定一個&lt;/b>&lt;/p>
&lt;br>
&lt;h2>Default VPC&lt;span class="hx-absolute -hx-mt-20" id="default-vpc">&lt;/span>
&lt;a href="#default-vpc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>每個 AWS 帳號都會有一個 Default VPC，這個 VPC 是 AWS 預設給你的，裡面已經設定好一些設定，方便你可以快速啟動資源。&lt;/p>
&lt;p>在 Default VPC 中，會在每個 Availability Zone (AZ) 建立好 Subnet。&lt;/p>
&lt;p>每個 Subnet 都會有一組可以連到 internet 的 Route Table，所以每個 Subnet 都預設具備連網的功能&lt;/p>
&lt;p>每個 Subnet 都會有一個 Internet Gateway 存在以及連接，因此 Default VPC 所有 Subnet 都屬於 Public Subnet。&lt;/p>
&lt;br>
&lt;h2>VPC Peering&lt;span class="hx-absolute -hx-mt-20" id="vpc-peering">&lt;/span>
&lt;a href="#vpc-peering" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>當不同的 VPC 想要連接時，可以透過 VPC Peering 來連接，VPC Peering 是一種私有的連接，可以在兩個 VPC 之間傳輸流量，使用 Private IP 將兩個 VPC 連接起來。&lt;/p>
&lt;p>不同的 VPC 的 CIDR 不能重疊，否則無法建立 VPC Peering。&lt;/p>
&lt;p>VPC Peering 不限制同一個帳號，可以跟其他帳號的 VPC 連接。&lt;/p>
&lt;p>也可以跨 Region，這種稱為 &lt;code>Inter-Region VPC Peering&lt;/code>&lt;/p>
&lt;p>Peering 屬於一對一的連接，如果要連接多個 VPC，則需要建立多個 Peering。例如：A 與 B Peering，B 與 C Peering，A 與 C 之間是無法直接溝通。&lt;/p>
&lt;p>可以設定整個 VPC 進行 Peering，也可以設定特定 Subnet 進行 Peering。&lt;/p>
&lt;p>需要額外設定 Route Table，才可以兩個 VPC 之間可以溝通。&lt;/p>
&lt;p>詳細可以看：&lt;a href="https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html" target="_blank" rel="noopener">What is VPC peering? 什麼是 VPC 對等互連？&lt;/a>&lt;/p>
&lt;br>
&lt;h2>VPC 懶人包&lt;span class="hx-absolute -hx-mt-20" id="vpc-懶人包">&lt;/span>
&lt;a href="#vpc-%e6%87%b6%e4%ba%ba%e5%8c%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>如果對於上面比較詳細的說明有點複雜，這邊我總結一下 VPC 的重點：&lt;/p>
&lt;h3>以網路的角度出發&lt;span class="hx-absolute -hx-mt-20" id="以網路的角度出發">&lt;/span>
&lt;a href="#%e4%bb%a5%e7%b6%b2%e8%b7%af%e7%9a%84%e8%a7%92%e5%ba%a6%e5%87%ba%e7%99%bc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>下面都先用 EC2 來當作 Subnet 底下的後端服務：&lt;/p>
&lt;ul>
&lt;li>Private Subnet 沒辦法對外連網，外面也連不進來。&lt;/li>
&lt;li>同一個 Subnet 裡面的 EC2 可以互相溝通，不需要透過其他的元件。&lt;/li>
&lt;li>不同的 Subnet 要溝通時，則需要透過 Route Table 元件。&lt;/li>
&lt;li>Route Table 功用就是去指引網路流量要怎麼走，以及去哪裡。會有目的地 IP 以及下一站要去哪。會經過 Local 中繼站。&lt;/li>
&lt;li>Public Subnet 讓裡面的 EC2 可以連到 Internet，一樣需要 Route Table 去指引路線，目的地是 Internet，下一站則需要到 Internet Gateway (IGW)。&lt;/li>
&lt;li>Internet Gateway (IGW) 會放在 VPC 層級上面，是 Public Subnet 對外連線的重要元件。&lt;/li>
&lt;li>如果要讓 Private Subnet 能夠連 Internet，Route Table 下一站則需要到 NAT Gateway。&lt;/li>
&lt;li>NAT Gateway 是設定在 Public Subnet 上面，透過它才能讓 Private Subnet 連到 Internet。整個流程如下：&lt;code>Private Subnet &amp;gt; Route Table &amp;gt; NAT Gateway &amp;gt; Internet Gateway (IGW) &amp;gt; Internet&lt;/code>，這個流程是單向的，外面的網路還是連不進來 Private Subnet。&lt;/li>
&lt;/ul>
&lt;br>
&lt;h3>以安全性的角度出發&lt;span class="hx-absolute -hx-mt-20" id="以安全性的角度出發">&lt;/span>
&lt;a href="#%e4%bb%a5%e5%ae%89%e5%85%a8%e6%80%a7%e7%9a%84%e8%a7%92%e5%ba%a6%e5%87%ba%e7%99%bc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>外部連線想要進來 Subnet 時，會需要先經過 Network Access Control List (NACL)。&lt;/li>
&lt;li>Network Access Control List (NACL) 是隸屬於 Subnet 層級，NACL 會規範，什麼請求可以進來，什麼請求可以出去 Subnet。&lt;/li>
&lt;li>進入到 Subnet 後，要在到 EC2 時，會在經過一層保護名為 Security groups (SG)。&lt;/li>
&lt;li>Security groups (SG) 是給 EC2 instance 用的，類似防火牆規範。&lt;/li>
&lt;/ul>
&lt;p>Network Access Control List (NACL) 跟 Security groups (SG) 差異&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>差異&lt;/th>
&lt;th>NACL&lt;/th>
&lt;th>SG&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>說明&lt;/td>
&lt;td>是一個子網級別的防火牆，用於控制進入和出去子網的流量。&lt;/td>
&lt;td>是虛擬防火牆，用於控制 EC2 實例的進入和出去流量。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>狀態&lt;/td>
&lt;td>stateless，這意味著進入和出去的流量都必須明確允許。如果允許進入流量，出去的流量必須單獨設定規則允許。&lt;/td>
&lt;td>stateful，這意味著如果允許進入流量（inbound traffic），相應的出去回應流量（outbound response traffic）也自動被允許，反之亦然。&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;p>最後如果懶得看文字，建議大家可以去看這部影片：&lt;a href="https://www.youtube.com/watch?v=0YG3vo78gSM" target="_blank" rel="noopener">AWS 專家教你：打造高效 VPC 網絡（包含 Subnet、IGW、NAT 等）
&lt;/a>，6 分鐘的影片，可以快速了解 VPC 的重點。&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx-absolute -hx-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>什麼是 Amazon VPC：&lt;a href="https://docs.aws.amazon.com/zh_tw/vpc/latest/userguide/what-is-amazon-vpc.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_tw/vpc/latest/userguide/what-is-amazon-vpc.html&lt;/a>&lt;/p>
&lt;p>AWS CSA Associate 學習筆記 - VPC(Virtual Private Cloud) Part 1：&lt;a href="https://godleon.github.io/blog/AWS/AWS-CSA-associate-VPC-part1/" target="_blank" rel="noopener">https://godleon.github.io/blog/AWS/AWS-CSA-associate-VPC-part1/&lt;/a>&lt;/p>
&lt;p>Virtual Private Cloud：&lt;a href="https://salmankhalid85.wordpress.com/aws/virtual-private-cloud/" target="_blank" rel="noopener">https://salmankhalid85.wordpress.com/aws/virtual-private-cloud/&lt;/a>&lt;/p>
&lt;p>【技術分享】Internet Gateway 和 NAT Gateway 的區別在哪? 功能分別是什麼?：&lt;a href="https://medium.com/@awseducate.cloudambassador/%E6%8A%80%E8%A1%93%E5%88%86%E4%BA%AB-internet-gateway-%E5%92%8C-nat-gateway-%E7%9A%84%E5%8D%80%E5%88%A5%E5%9C%A8%E5%93%AA-%E5%8A%9F%E8%83%BD%E5%88%86%E5%88%A5%E6%98%AF%E4%BB%80%E9%BA%BC-b676f62b1d31" target="_blank" rel="noopener">https://medium.com/@awseducate.cloudambassador/%E6%8A%80%E8%A1%93%E5%88%86%E4%BA%AB-internet-gateway-%E5%92%8C-nat-gateway-%E7%9A%84%E5%8D%80%E5%88%A5%E5%9C%A8%E5%93%AA-%E5%8A%9F%E8%83%BD%E5%88%86%E5%88%A5%E6%98%AF%E4%BB%80%E9%BA%BC-b676f62b1d31&lt;/a>&lt;/p></description></item><item><title>Elastic Kubernetes Service (EKS) 介紹</title><link>https://pin-yi.me/blog/aws/eks-introduce/</link><pubDate>Fri, 26 Jul 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/eks-introduce/</guid><description>
&lt;p>由於公司政策調整，除了原先的 Google Cloud Platform (GCP) 之外，我們也開始使用 AWS 服務，其中包括了 EKS (Elastic Kubernetes Service)。這篇文章將會介紹 EKS 的基本概念以及一些使用上的注意事項。&lt;/p>
&lt;p>後面也會有幾篇 AWS 文章，歡迎大家持續關注。&lt;/p>
&lt;br>
&lt;h2>什麼是 EKS？&lt;span class="hx-absolute -hx-mt-20" id="什麼是-eks">&lt;/span>
&lt;a href="#%e4%bb%80%e9%ba%bc%e6%98%af-eks" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>那熟悉 Kubernetes 的朋友應該對 EKS 並不陌生，EKS 是 AWS 提供的 Kubernetes 服務，讓使用者可以在 AWS 上快速建立、擴展和管理 Kubernetes 集群。就跟 GCP 的 GKE 一樣。&lt;/p>
&lt;br>
&lt;p>流程也跟 GKE 差不多，如圖：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>建立 Cluster：可以透過 eksctl、AWS Console、AWS CLI、Terraform 等等來建立。&lt;/p>
&lt;ul>
&lt;li>eksctl：是一個官方專門給 EKS 的 CLI 工具，可以快速建立、更新和刪除 EKS 集群，詳細可以看：&lt;a href="https://eksctl.io/" target="_blank" rel="noopener">eksctl&lt;/a>、&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/getting-started-eksctl.html" target="_blank" rel="noopener">Amazon EKS 入門&lt;/a>。&lt;/li>
&lt;/ul>
&lt;p>Mac 安裝指令：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>brew tap weaveworks/tap
brew install weaveworks/tap/eksctl&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>AWS CLI：是官方的 CLI 工具，除了建立 EKS 集群，還可以管理其他 AWS 服務，詳細可以看：我的另一篇筆記 &lt;a href="../aws-cli" >設定 AWS CLI 以及 AWS CLI 指令說明&lt;/a>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>選擇運算資源的方式：可以分成 &lt;a href="https://aws.amazon.com/tw/fargate/" target="_blank" rel="noopener">Fargate&lt;/a>、&lt;a href="https://karpenter.sh/" target="_blank" rel="noopener">Karpenter&lt;/a>、託管節點群組和自管理節點。那我們使用主要是使用託管節點群組。其他的方式會在後面的文章介紹。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>設定：設定必要的控制器、驅動程式或是服務等等。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>部署工作負載：自訂 Kubernetes 物件，例如 Pod、Service、Deployment 等等。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>管理：監督工作負載，整合 AWS 服務以簡化維運並提高工作負載效能。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/eks-introduce/1.png"
alt="在雲端中執行 Amazon EKS 的基本流程" width="750">&lt;figcaption>
&lt;p>在雲端中執行 Amazon EKS 的基本流程&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>其他比較詳細的架構以及部署選項可以參考：&lt;a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-architecture.html" target="_blank" rel="noopener">Amazon EKS 架構&lt;/a>、&lt;a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-deployment-options.html" target="_blank" rel="noopener">部署選項&lt;/a>，這邊就不再贅述。&lt;/p>
&lt;br>
&lt;h2>建立第一個 EKS：eksctl&lt;span class="hx-absolute -hx-mt-20" id="建立第一個-ekseksctl">&lt;/span>
&lt;a href="#%e5%bb%ba%e7%ab%8b%e7%ac%ac%e4%b8%80%e5%80%8b-ekseksctl" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>詳細請參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/getting-started-eksctl.html" target="_blank" rel="noopener">Amazon EKS 入門：eksctl&lt;/a>&lt;/p>
&lt;p>在建立 EKS 前，我們要先確認我們要建立的節點是要使用 Fargate 還是託管節點群組，我們這邊拿 GCP 來說明，託管節點群組就是我們一般建立的 Node_Pool，而 Fargate 就是 Serverless 的概念，不需要自己管理節點，只需要管理 Pod，詳細我後面也會寫一篇文章來介紹，&lt;a href="../fargate-introduce/" >可以點我查看&lt;/a>。&lt;/p>
&lt;br>
&lt;p>那我們這邊就先以託管節點群組來建立 EKS，建立使用以下指令來建立：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>eksctl create cluster --name &lt;span style="color:#f92672">{&lt;/span>my-cluster&lt;span style="color:#f92672">}&lt;/span> --region &lt;span style="color:#f92672">{&lt;/span>region-code&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>eksctl create cluster --name ian-test --region us-east-1&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>將 &lt;code>{my-cluster}&lt;/code> 替換成自己要的名稱，只能英文數字字元(區分大小寫)和連字號。必須字母數字字元開頭，且長度不可以超過 100 個字元，名稱在該區域中必須是唯一的。&lt;/p>
&lt;p>&lt;code>{region-code}&lt;/code> 則是替換成自己要的區域，例如：us-east-1。可以從 &lt;a href="https://docs.aws.amazon.com/general/latest/gr/eks.html" target="_blank" rel="noopener">Amazon EKS endpoints and quotas&lt;/a> 這邊查看 region-code。
如果是 Fargate 的話，只需要在指令後面加上 &lt;code>--fargate&lt;/code>&lt;/p>
&lt;br>
&lt;p>提醒：使用這個指令建置，會需要有 CloudFormation 的相關權限，如果缺少權限，會顯示以下錯誤：&lt;/p>
&lt;p>( CloudFormation 是將基礎設施視為程式碼的服務，可以對 AWS 和第三方資源進行建模、佈建和管理，詳細一樣請參考後續文章 &lt;a href="../cloudformation-introduce" >AWS CloudFormation 介紹&lt;/a>。)
&lt;br>&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/aws/eks-introduce/2.png"
alt="使用 eksctl 建立 EKS 缺少 CloudFormation 權限" width="850">&lt;figcaption>
&lt;p>使用 eksctl 建立 EKS 缺少 CloudFormation 權限&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>EKS 定價&lt;span class="hx-absolute -hx-mt-20" id="eks-定價">&lt;/span>
&lt;a href="#eks-%e5%ae%9a%e5%83%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;br>
&lt;h2>參考資料&lt;span class="hx-absolute -hx-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>What is Amazon EKS?：&lt;a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html&lt;/a>&lt;/p>
&lt;p>Amazon EKS 入門：eksctl：&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/getting-started-eksctl.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/getting-started-eksctl.html&lt;/a>&lt;/p></description></item><item><title>Identity and Access Management (IAM) 介紹</title><link>https://pin-yi.me/blog/aws/iam-introduce/</link><pubDate>Fri, 26 Jul 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/iam-introduce/</guid><description>
&lt;p>先來說一下為什麼會寫這篇文章，主要是在寫跟測試 &lt;a href="../eks-introduce" >Elastic Kubernetes Service (EKS) 介紹&lt;/a> 文章時，想要用 eksctl 來建立 EKS，它實際上是透過 CloudFormation 來建立的，詳細可以去看 EKS 文章，總之當時遇到權限的問題，找了很久，也看不懂 AWS 的 ARN 是什麼，所以就先來寫一篇 IAM 的文章 (´≖◞౪◟≖)。&lt;/p>
&lt;br>
&lt;h2>武功秘籍&lt;span class="hx-absolute -hx-mt-20" id="武功秘籍">&lt;/span>
&lt;a href="#%e6%ad%a6%e5%8a%9f%e7%a7%98%e7%b1%8d" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>文章主要參考：&lt;a href="https://godleon.github.io/blog/AWS/learn-AWS-IAM-2-policy/" target="_blank" rel="noopener">[AWS IAM] 學習重點節錄(2) - IAM Policy&lt;/a>，這篇文章寫得很詳細，當然，我會加上一些自己的理解跟測試範例，如果有興趣的話，可以去看看原文。&lt;/p>
&lt;p>下方文章主要都圍繞官方的 &lt;a href="https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html" target="_blank" rel="noopener">Actions, resources, and condition keys for AWS services&lt;/a> 文件上，如果後面沒有附連結，基本上就在講這份，請大家可以打開網頁一起看。&lt;/p>
&lt;br>
&lt;h2>什麼是 IAM？&lt;span class="hx-absolute -hx-mt-20" id="什麼是-iam">&lt;/span>
&lt;a href="#%e4%bb%80%e9%ba%bc%e6%98%af-iam" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>IAM 的全名是 Identity and Access Management，從字面上來看就可以得知，它是用來管理 AWS 資源的身份和存取權限的服務。透過 IAM，您可以控制對 AWS 資源的存取權限，以及對這些資源的操作權限。也就是 &lt;code>Who (身份) 可以 Do (操作) What (資源)&lt;/code> 的一個功能。&lt;/p>
&lt;br>
&lt;h2>Policy Type&lt;span class="hx-absolute -hx-mt-20" id="policy-type">&lt;/span>
&lt;a href="#policy-type" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Policy Type 有三種：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>AWS 受管&lt;/p>
&lt;p>由 AWS 提供的 Policy，這些 Policy 會包含一些常見的操作，例如：S3 的讀寫、EC2 的啟動、停止等等。如果 AWS 有新增服務，也會同時更新這些 policy。詳細可以看：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/access_policies_managed-vs-inline.html#aws-managed-policies" target="_blank" rel="noopener">AWS 受管理政策
&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="2">
&lt;li>
&lt;p>AWS 受管 – 職務職能&lt;/p>
&lt;p>這些 Policy 會針對特定的工作角色，例如：系統管理員 (AdministratorAccess)、網路管理員任務角色 (NetworkAdministrator)、資料庫管理員任務角色 (DatabaseAdministrator) 等等，這些 Policy 會包含這些角色常見的操作。詳細可以看：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/access_policies_job-functions.html" target="_blank" rel="noopener">AWS 受管理的工作職能政策&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="3">
&lt;li>
&lt;p>客戶受管&lt;/p>
&lt;p>使用者自己定義的 Policy，這些 Policy 會針對自己的需求來定義，例如：只能讀取某個 S3 bucket、只能啟動某個 EC2 instance 等等。詳細可以看：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/access_policies_managed-vs-inline.html#customer-managed-policies" target="_blank" rel="noopener">客戶受管政策&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;h2>Policy 結構&lt;span class="hx-absolute -hx-mt-20" id="policy-結構">&lt;/span>
&lt;a href="#policy-%e7%b5%90%e6%a7%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>IAM Policy 會是一個 JSON 格式的文件，可以定義了一個或多個 Action，這個 Policy 會告訴 AWS 這個身份可以對哪些資源 (Resource) 進行哪些操作 (Action)。而這個 Policy 會被附加到一個身份上，這個身份可以是一個 IAM User、IAM Group 或 IAM Role。然後一個 User、Group 或 Role 可以有多個 Policy。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/iam-introduce/1.png"
alt="我目前公司帳號的 Policy" width="650">&lt;figcaption>
&lt;p>我目前公司帳號的 Policy&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>上面的圖片就是一個典型的 IAM 的 Policy 結構，可以看到這個 Policy 會有 Version、Statement、Effect、Action、Resource、Condition (上面沒有 xD) 等等主要元素。&lt;/p>
&lt;br>
&lt;p>下面就針對 Version、Statement、Effect、Action、Resource、Condition 這些元素來做一些介紹。&lt;/p>
&lt;p>重點提醒：&lt;/p>
&lt;ul>
&lt;li>所有的元素都是有區分大小寫的，寫錯大小寫會導致 Policy 無法正確解析。&lt;/li>
&lt;/ul>
&lt;br>
&lt;h3>Version&lt;span class="hx-absolute -hx-mt-20" id="version">&lt;/span>
&lt;a href="#version" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Version：用來告知 AWS 這個 Policy 是使用哪個版本的 IAM Policy 語法，目前最新的版本是 2012-10-17，舊版本是 2008-10-17。詳細請參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_version.html" target="_blank" rel="noopener">IAM JSON 政策元素：Version&lt;/a>&lt;/p>
&lt;br>
&lt;h3>Statement&lt;span class="hx-absolute -hx-mt-20" id="statement">&lt;/span>
&lt;a href="#statement" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Statement：是 Policy 的主要元素。此元素為必填。Statement 元素可包含單一陳述式，或是個別陳述式的陣列。每個個別的陳述式區塊都必須用大括號 { } 括起。針對多個陳述式，陣列必須用方括號 [ ] 括起。詳細請參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_statement.html" target="_blank" rel="noopener">IAM JSON 政策元素：Statement&lt;/a>&lt;/p>
&lt;p>例如：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Statement&amp;#34;: [{...},{...},{...}]&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>Effect&lt;span class="hx-absolute -hx-mt-20" id="effect">&lt;/span>
&lt;a href="#effect" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Effect：元素是必填的，指定陳述式是否允許或拒絕。&lt;/p>
&lt;ul>
&lt;li>Effect 的有效值為 Allow 和 Deny。Effect 值會區分大小寫。&lt;/li>
&lt;li>AWS 預設是 Deny，所以如果沒有設定 Effect，則預設是 Deny，需要明確指定 Allow。&lt;/li>
&lt;li>Policy 每個 Statement 都必須有一個 Effect 元素。&lt;/li>
&lt;li>如果同時有 Allow 和 Deny 套用同一個資源，則 Deny 會優先於 Allow。&lt;/li>
&lt;/ul>
&lt;p>詳細請參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_effect.html" target="_blank" rel="noopener">IAM JSON 政策元素：Effect&lt;/a>&lt;/p>
&lt;br>
&lt;h3>Action&lt;span class="hx-absolute -hx-mt-20" id="action">&lt;/span>
&lt;a href="#action" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Action：描述哪一個服務可以做哪些動作。&lt;/p>
&lt;ul>
&lt;li>每個 AWS 服務都有自己的一組動作，描述您可以使用該服務執行的哪些任務。&lt;/li>
&lt;li>使用服務命名做為動作開頭 (iam、ec2、sqs、sns、s3 等) 來指定值，後面則加上對應的動作名稱。&lt;/li>
&lt;li>Action 服務和動作名稱不區分大小寫。例如，&lt;code>iam:ListAccessKeys&lt;/code> 與 &lt;code>IAM:listaccesskeys&lt;/code> 相同&lt;/li>
&lt;/ul>
&lt;p>下面舉例幾個 Action：&lt;/p>
&lt;ol>
&lt;li>Amazon S3 取得物件：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: &amp;#34;s3:GetObject&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="2">
&lt;li>IAM 修改密碼：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: &amp;#34;iam:ChangePassword&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="3">
&lt;li>EC2 啟動實例：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: &amp;#34;ec2:StartInstances&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>可以從上面得知 s3、iam、ec2 是 AWS 提供的服務，而 GetObject、ChangePassword、StartInstances 是這些服務提供的動作。&lt;/p>
&lt;br>
&lt;p>當然，服務很多，再加上每個服務的動作也不一樣，那我們可以依照 &lt;a href="#%e6%ad%a6%e5%8a%9f%e7%a7%98%e7%b1%8d" >武功秘籍&lt;/a> 提到的 &lt;a href="https://docs.aws.amazon.com/zh_tw/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html" target="_blank" rel="noopener">Actions, resources, and condition keys for AWS services&lt;/a> 去查詢對應的動作列表。&lt;/p>
&lt;br>
&lt;h4>如何方便的撰寫 Action？&lt;span class="hx-absolute -hx-mt-20" id="如何方便的撰寫-action">&lt;/span>
&lt;a href="#%e5%a6%82%e4%bd%95%e6%96%b9%e4%be%bf%e7%9a%84%e6%92%b0%e5%af%ab-action" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>如果，我們需要新增服務很多的 Action，我們只能一個一個輸入嗎？像下面這張圖片，我們可以看到 Elastic Kubernetes Service (EKS) 的 Action 部分清單，假如我們要這些全部的動作，需要把每個都寫出來嗎？&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/iam-introduce/2.png"
alt="Elastic Kubernetes Service Action 部分清單 Amazon Elastic Kubernetes Service 定義的動作" width="650">&lt;figcaption>
&lt;p>Elastic Kubernetes Service Action 部分清單 &lt;a href="https://docs.aws.amazon.com/zh_tw/service-authorization/latest/reference/list_amazonelastickubernetesservice.html" target="_blank" rel="noopener">Amazon Elastic Kubernetes Service 定義的動作&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>當然不用！我們可以使用 &lt;code>*&lt;/code> 來代表所有的動作，例如：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: &amp;#34;eks:*&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這樣就可以代表所有的 EKS 的動作。&lt;/p>
&lt;br>
&lt;p>或是只想要 eks 的 Create 相關動作，可以這樣寫：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: &amp;#34;eks:Create*&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這樣就包含了 &lt;code>CreateAccessEntry&lt;/code>、&lt;code>CreateAddon&lt;/code>、&lt;code>CreateCluster&lt;/code>、&lt;code>CreateFargateProfile&lt;/code>、&lt;code>CreateNodegroup&lt;/code> 等等動作。&lt;/p>
&lt;br>
&lt;p>或是我們只想要有 eks 的 cluster 相關動作(不要 Addon、Nodegroup 等等)，可以這樣寫：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: &amp;#34;eks:*Cluster*&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這樣就只有 &lt;code>CreateCluster&lt;/code>、&lt;code>DeleteCluster&lt;/code>、&lt;code>DescribeCluster&lt;/code>、&lt;code>ListClusters&lt;/code> 等等的動作，沒有 &lt;code>CreateAddon&lt;/code>、&lt;code>CreateNodegroup&lt;/code> 動作。&lt;/p>
&lt;p>詳細請參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_action.html" target="_blank" rel="noopener">IAM JSON 政策元素：Action&lt;/a>&lt;/p>
&lt;br>
&lt;h3>Resource&lt;span class="hx-absolute -hx-mt-20" id="resource">&lt;/span>
&lt;a href="#resource" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Resource：描述哪一個服務的哪一個資源。&lt;/p>
&lt;p>這邊以 Amazon S3 為例，我們建立了一個 bucket，它就是一個 Resource，我們上傳了一個檔案到這個 bucket，這個檔案也是一個 Resource。&lt;/p>
&lt;p>但是，我們要如何去定義我們可以對哪些的 AWS Resource 做哪些的操作呢？這時候就可以使用 ARN (Amazon Resource Name) 來定義。&lt;/p>
&lt;br>
&lt;p>ARN 它的命名會將不同服務、不同 region、不同使用者帳號都考慮進去，產生一個唯一識別 AWS 資源的字串，下面是三種 ARN 格式：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>arn:&amp;lt;partition&amp;gt;:&amp;lt;service&amp;gt;:&amp;lt;region&amp;gt;:&amp;lt;account-id&amp;gt;:&amp;lt;resource-id&amp;gt;
arn:&amp;lt;partition&amp;gt;:&amp;lt;service&amp;gt;:&amp;lt;region&amp;gt;:&amp;lt;account-id&amp;gt;:&amp;lt;resource-type&amp;gt;/&amp;lt;resource-id&amp;gt;
arn:&amp;lt;partition&amp;gt;:&amp;lt;service&amp;gt;:&amp;lt;region&amp;gt;:&amp;lt;account-id&amp;gt;:&amp;lt;resource-type&amp;gt;:&amp;lt;resource-id&amp;gt;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>詳細可以參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference-arns.html" target="_blank" rel="noopener">ARN 格式&lt;/a>&lt;/p>
&lt;br>
&lt;p>那我們一樣，將 partition、service、region、account-id、resource-type、resource-id 都個別簡單介紹一下：&lt;/p>
&lt;h4>partition (分區)&lt;span class="hx-absolute -hx-mt-20" id="partition-分區">&lt;/span>
&lt;a href="#partition-%e5%88%86%e5%8d%80" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>它是 AWS 的分區，目前有 &lt;code>aws&lt;/code> 和 &lt;code>aws-cn&lt;/code> 以及 &lt;code>aws-us-gov&lt;/code>，分別代表 AWS 區域和中國區域以及 AWS GovCloud (US) 區域，所以基本上我們都會使用 &lt;code>aws&lt;/code>。&lt;/p>
&lt;br>
&lt;h4>service (服務)&lt;span class="hx-absolute -hx-mt-20" id="service-服務">&lt;/span>
&lt;a href="#service-%e6%9c%8d%e5%8b%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>它是 AWS 的服務名稱字首，例如：s3、iam、ec2、eks 等等。不清楚每個服務的字首可以參考 &lt;a href="https://docs.aws.amazon.com/zh_tw/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html" target="_blank" rel="noopener">AWS 服務的動作、資源和條件索引鍵&lt;/a>，假設我們點進去看到 Amazon S3 的服務名稱字首是 &lt;code>s3&lt;/code>。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/iam-introduce/3.png"
alt="Amazon S3 的動作、資源和條件索引鍵" width="650">&lt;figcaption>
&lt;p>&lt;a href="https://docs.aws.amazon.com/zh_tw/service-authorization/latest/reference/list_amazons3.html" target="_blank" rel="noopener">Amazon S3 的動作、資源和條件索引鍵&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>region (區域)&lt;span class="hx-absolute -hx-mt-20" id="region-區域">&lt;/span>
&lt;a href="#region-%e5%8d%80%e5%9f%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>它是 AWS 的區域，例如：us-east-1、us-west-2、ap-northeast-1 等等。如果需區域代碼清單，可以查看&lt;a href="https://docs.aws.amazon.com/zh_tw/general/latest/gr/rande.html#regional-endpoints" target="_blank" rel="noopener">區域端點&lt;/a>&lt;/p>
&lt;br>
&lt;h4>account-id (帳號識別碼)&lt;span class="hx-absolute -hx-mt-20" id="account-id-帳號識別碼">&lt;/span>
&lt;a href="#account-id-%e5%b8%b3%e8%99%9f%e8%ad%98%e5%88%a5%e7%a2%bc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>它是擁有資源的 AWS 帳號識別碼 (不含連字號)，例如：123456789012。&lt;/p>
&lt;br>
&lt;h4>resource-type (資源類型)&lt;span class="hx-absolute -hx-mt-20" id="resource-type-資源類型">&lt;/span>
&lt;a href="#resource-type-%e8%b3%87%e6%ba%90%e9%a1%9e%e5%9e%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>它是資源的類型，例如：vpc (虛擬私有雲)，bucket (S3 bucket)，instance (EC2 instance) 等等。&lt;/p>
&lt;br>
&lt;h4>resource-id (資源識別碼)&lt;span class="hx-absolute -hx-mt-20" id="resource-id-資源識別碼">&lt;/span>
&lt;a href="#resource-id-%e8%b3%87%e6%ba%90%e8%ad%98%e5%88%a5%e7%a2%bc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>它是資源名稱、資源 ID 或資源路徑。某些資源識別碼包括父項資源 (sub-resource-type/父資源/子資源) 或限定元，&lt;/p>
&lt;p>例如：&lt;/p>
&lt;ol>
&lt;li>IAM User&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>arn:aws:iam::123456789012:user/ian_zhuang&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這個在最上面的 Policy 結構中的圖片可以看到我的 User ARN。&lt;/p>
&lt;ol start="2">
&lt;li>VPC&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>arn:aws:ec2:us-east-1:123456789012:vpc/vpc-0e9801d129EXAMPLE&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="3">
&lt;li>S3 Bucket&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>arn:aws:s3:::*
arn:aws:s3:::demo-bucket-a/*
arn:aws:s3:::demo-bucket-b/downloads/*&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這邊 S3 Bucket 的 ARN 有三個：&lt;/p>
&lt;p>第一個代表的是所有的 S3 bucket &amp;amp; object。&lt;/p>
&lt;p>第二個代表的 demo-bucket-a 對於此 bucket 的所有 object。&lt;/p>
&lt;p>第三個代表的 demo-bucket-b 的 downloads 目錄下的所有 object。&lt;/p>
&lt;p>&lt;b>另外，還會發現，因為 S3 服務它沒有 &lt;code>&amp;lt;region&amp;gt;&lt;/code>、&lt;code>&amp;lt;account-id&amp;gt;&lt;/code> 所以中間兩個就留空即可。&lt;/b>&lt;/p>
&lt;p>詳細可以參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_resource.html" target="_blank" rel="noopener">IAM JSON 政策元素：Resource&lt;/a>&lt;/p>
&lt;br>
&lt;h3>Condition&lt;span class="hx-absolute -hx-mt-20" id="condition">&lt;/span>
&lt;a href="#condition" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>在上面介紹的 Effect 我們可以設定 Allow 或 Deny 來限制 User、Group、Role 對資源操作的權限，但是有時候我們可能會需要更多的條件來限制這個 Policy，這時候就可以使用 Condition 來設定。&lt;/p>
&lt;p>Condition：它可用於 Policy 生效時指定條件，Condition 元素是選填的。&lt;/p>
&lt;p>這個功能等於是加了一個 &lt;code>if&lt;/code> 的判斷，以及 Statement 可以有很多個 Sub-Statement，每個 Sub-Statement 都可以設定 Condition，就可以設定很多種可能。&lt;/p>
&lt;p>它的格式是：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Condition&amp;#34;: {
&amp;#34;&amp;lt;condition-operator&amp;gt;&amp;#34;: {
&amp;#34;&amp;lt;condition-key&amp;gt;&amp;#34;: &amp;#34;&amp;lt;condition-value&amp;gt;&amp;#34;
}
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>會有三個元素組成：分別是 condition-operator、condition-key、condition-value。(condition-value 就是一般要判斷的資料，所以這邊就不多做介紹)&lt;/p>
&lt;br>
&lt;h4>condition-operator&lt;span class="hx-absolute -hx-mt-20" id="condition-operator">&lt;/span>
&lt;a href="#condition-operator" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>condition-operator：是一個比較運算子，例如：&lt;/p>
&lt;ul>
&lt;li>字串的有：&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>運算子&lt;/th>
&lt;th>說明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>StringEquals&lt;/td>
&lt;td>檢查 condition-key 跟 condition-value 字串是否相等&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>StringNotEquals&lt;/td>
&lt;td>檢查 condition-key 跟 condition-value 字串是否不相等&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>StringEqualsIgnoreCase&lt;/td>
&lt;td>檢查 condition-key 跟 condition-value 字串是否相等，不區分大小寫&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>StringNotEqualsIgnoreCase&lt;/td>
&lt;td>檢查 condition-key 跟 condition-value 字串是否不相等，不區分大小寫&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>由於有些 condition-key 沒有區分大小寫，所以運算子會有 &lt;code>IgnoreCase&lt;/code> 的不區分大小寫的運算子，在設計的時候要注意。&lt;/p>
&lt;br>
&lt;ul>
&lt;li>數值的有：&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>運算子&lt;/th>
&lt;th>說明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>NumericEquals&lt;/td>
&lt;td>檢查 condition-key 跟 condition-value 數值是否相等&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NumericNotEquals&lt;/td>
&lt;td>檢查 condition-key 跟 condition-value 數值是否不相等&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NumericLessThan&lt;/td>
&lt;td>檢查 condition-key 是否小於 condition-value 數值&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NumericLessThanEquals&lt;/td>
&lt;td>檢查 condition-key 是否小於等於 condition-value 數值&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NumericGreaterThan&lt;/td>
&lt;td>檢查 condition-key 是否大於 condition-value 數值&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;p>還有像是日期條件運算子、布林值條件運算子、二進位條件運算子、IP 地址條件運算子等等，由於運算子蠻多的，可以參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_condition_operators.html" target="_blank" rel="noopener">IAM JSON 原則元素:條件運算子&lt;/a>。&lt;/p>
&lt;br>
&lt;h4>condition-key&lt;span class="hx-absolute -hx-mt-20" id="condition-key">&lt;/span>
&lt;a href="#condition-key" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>那 condition-key 是什麼呢？它是一個 key，用來指定要檢查的條件，例如：&lt;code>aws:username&lt;/code>、&lt;code>aws:MultiFactorAuthAge&lt;/code>、&lt;code>s3:authType&lt;/code>、&lt;code>eks:namespaces&lt;/code> 等等。&lt;/p>
&lt;p>在 condition-key 又分為兩種類型：分別是：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Global Condition Key&lt;/p>
&lt;p>這些是 AWS 提供的全域條件，可以在所有的服務或是 Action 中使用，例如：&lt;code>aws:username&lt;/code>、&lt;code>aws:userid&lt;/code> 等等。但是有些特定狀況下才可以使用，例如：&lt;code>aws:MultiFactorAuthAge&lt;/code>，詳細可以參考：&lt;a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html" target="_blank" rel="noopener">AWS global condition context keys&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="2">
&lt;li>
&lt;p>Service Condition Key&lt;/p>
&lt;p>這些是服務提供的條件，不同服務的 Service 也會有所不同，例如：&lt;code>s3:authType&lt;/code>、&lt;code>eks:namespaces&lt;/code> 等等。&lt;/p>
&lt;p>想要知道哪些服務有什麼 Condition Key，可以再次開啟 &lt;a href="#%e6%ad%a6%e5%8a%9f%e7%a7%98%e7%b1%8d" >武功秘籍&lt;/a> 提到的 &lt;a href="https://docs.aws.amazon.com/zh_tw/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html" target="_blank" rel="noopener">Actions, resources, and condition keys for AWS services&lt;/a>，我們假設選擇 Amazon Elastic Kubernetes Service (EKS) 服務：&lt;/p>
&lt;br>
&lt;p>因為每個 Action 都有對應的 Condition Key，不是任何一個 Action 都與任一個 Condition Key 有搭配，如下圖：&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/iam-introduce/4.png"
alt="Actions defined by Amazon Elastic Kubernetes Service" width="950">&lt;figcaption>
&lt;p>&lt;a href="https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonelastickubernetesservice.html#amazonelastickubernetesservice-actions-as-permissions" target="_blank" rel="noopener">Actions defined by Amazon Elastic Kubernetes Service&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>所以需要查看文件裡面的清單，例如像是 AssociateAccessPolicy Action 就會有 &lt;code>eks:policyArn&lt;/code>、&lt;code>eks:namespaces&lt;/code>、&lt;code>eks:accessScope&lt;/code> 的 Condition Key。&lt;/p>
&lt;br>
&lt;p>另外，想要知道 Condition Key 對應到哪個資料類型，也可以參考 Condition keys for Amazon Elastic Kubernetes Service，後面會告訴你哪個 Condition Key 的資料類型，方便找到對應的 Condition Operator。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/iam-introduce/5.png"
alt="Condition keys for Amazon Elastic Kubernetes Service" width="950">&lt;figcaption>
&lt;p>&lt;a href="https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonelastickubernetesservice.html#amazonelastickubernetesservice-policy-keys" target="_blank" rel="noopener">Condition keys for Amazon Elastic Kubernetes Service&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Condition 規範&lt;span class="hx-absolute -hx-mt-20" id="condition-規範">&lt;/span>
&lt;a href="#condition-%e8%a6%8f%e7%af%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;br>
&lt;ol>
&lt;li>Condition 可以在 (condition-operator) 有多個條件 (condition-key)，每個條件都是 &lt;code>and&lt;/code> 來相互關聯，例如：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">(省略其他元素)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/department&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;finance&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/role&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;audit&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>代表的是 &lt;code>aws:PrincipalTag/department&lt;/code> 跟 &lt;code>aws:PrincipalTag/role&lt;/code> 都要符合才會生效。&lt;/p>
&lt;br>
&lt;ol start="2">
&lt;li>如果同一個條件有多個值，每個值都是 &lt;code>or&lt;/code> 來相互關聯，例如：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">(省略其他元素)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/department&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;finance&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;hr&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;legal&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/role&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;audit&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;security&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>官方的圖片解釋的更清楚：&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/aws/iam-introduce/6.png" width="400">
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>Condition 的 condition-operator 不能重複，例如：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">(省略其他元素)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/department&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;finance&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/role&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;audit&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這樣是錯誤的寫法，因為 &lt;code>StringEquals&lt;/code> 出現兩次，要將兩個條件合併成一個條件，例如：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">(省略其他元素)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/department&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;finance&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalTag/role&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;audit&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>詳細可以參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_elements_condition.html" target="_blank" rel="noopener">IAMJSON 政策元素：Condition&lt;/a>&lt;/p>
&lt;br>
&lt;h2>IAM Policy 範例&lt;span class="hx-absolute -hx-mt-20" id="iam-policy-範例">&lt;/span>
&lt;a href="#iam-policy-%e7%af%84%e4%be%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>那了解了 IAM Policy 的每個結構以及功能，我下面就舉例兩個 IAM Policy 來讓大家複習看看。&lt;/p>
&lt;br>
&lt;h3>範例一&lt;span class="hx-absolute -hx-mt-20" id="範例一">&lt;/span>
&lt;a href="#%e7%af%84%e4%be%8b%e4%b8%80" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;,
&amp;#34;Statement&amp;#34;: [
{
&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&amp;#34;Action&amp;#34;: &amp;#34;ec2:CreateVolume&amp;#34;,
&amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34;
},
{
&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&amp;#34;Action&amp;#34;: &amp;#34;ec2:CreateTags&amp;#34;,
&amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:ec2:::volume/*&amp;#34;,
&amp;#34;Condition&amp;#34;: {
&amp;#34;StringLike&amp;#34;: {
&amp;#34;aws:RequestTag/project&amp;#34;: &amp;#34;*&amp;#34;
}
}
},
{
&amp;#34;Effect&amp;#34;: &amp;#34;Deny&amp;#34;,
&amp;#34;Action&amp;#34;: &amp;#34;ec2:CreateTags&amp;#34;,
&amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:ec2:::volume/*&amp;#34;,
&amp;#34;Condition&amp;#34;: {
&amp;#34;StringEquals&amp;#34;: {
&amp;#34;aws:ResourceTag/environment&amp;#34;: &amp;#34;production&amp;#34;
}
}
}
]
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>這個 Policy 有 3 個 Sub-Statement，分別是：&lt;/p>
&lt;ol>
&lt;li>允許對所有的 EC2 instance 創建 Volume。&lt;/li>
&lt;li>允許有 &lt;code>aws:RequestTag/project&lt;/code> 的 Tag 對所有的 EC2 Volume 創建 Tag。&lt;/li>
&lt;li>拒絕有 &lt;code>aws:ResourceTag/environment&lt;/code> 是 production 的 Tag 對所有的 EC2 Volume 創建 Tag。&lt;/li>
&lt;/ol>
&lt;br>
&lt;h3>範例二&lt;span class="hx-absolute -hx-mt-20" id="範例二">&lt;/span>
&lt;a href="#%e7%af%84%e4%be%8b%e4%ba%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;,
&amp;#34;Statement&amp;#34;: [
{
&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&amp;#34;Action&amp;#34;: [
&amp;#34;ecs:RunTask&amp;#34;,
&amp;#34;ecs:StartTask&amp;#34;
],
&amp;#34;Resource&amp;#34;: [
&amp;#34;*&amp;#34;
],
&amp;#34;Condition&amp;#34;: {
&amp;#34;StringEquals&amp;#34;: {
&amp;#34;aws:RequestTag/environment&amp;#34;: [
&amp;#34;production&amp;#34;,
&amp;#34;prod-backup&amp;#34;
]
},
&amp;#34;ArnEquals&amp;#34;: {
&amp;#34;ecs:cluster&amp;#34;: [
&amp;#34;arn:aws:ecs:us-east-1:111122223333:cluster/default1&amp;#34;,
&amp;#34;arn:aws:ecs:us-east-1:111122223333:cluster/default2&amp;#34;
]
}
}
}
]
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>這個 Policy 有 1 個 Sub-Statement：&lt;/p>
&lt;p>允許在 &lt;code>arn:aws:ecs:us-east-1:111122223333:cluster/default1&lt;/code> 和 &lt;code>arn:aws:ecs:us-east-1:111122223333:cluster/default2&lt;/code> 這兩個 ECS 集群上，對 &lt;code>aws:RequestTag/environment&lt;/code> 標籤為 &lt;code>production&lt;/code> 或 &lt;code>prod-backup&lt;/code> 的任務執行 RunTask 和 StartTask 操作。&lt;/p>
&lt;br>
&lt;p>範例參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/reference_policies_condition_examples-single-valued-context-keys.html" target="_blank" rel="noopener">單值內容索引鍵政策範例&lt;/a>&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx-absolute -hx-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>[AWS IAM] 學習重點節錄(2) - IAM Policy：&lt;a href="https://godleon.github.io/blog/AWS/learn-AWS-IAM-2-policy/" target="_blank" rel="noopener">https://godleon.github.io/blog/AWS/learn-AWS-IAM-2-policy/&lt;/a>&lt;/p>
&lt;p>Actions, resources, and condition keys for AWS services：&lt;a href="https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html&lt;/a>&lt;/p>
&lt;p>其餘對應的參考資料都直接附在文章中。&lt;/p></description></item><item><title>如何使用 MFA Token 驗證 AWS CLI</title><link>https://pin-yi.me/blog/aws/cli-mfa/</link><pubDate>Thu, 01 Aug 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/cli-mfa/</guid><description>
&lt;p>會有這一篇文章也是跟 &lt;a href="../iam-introduce" >Identity and Access Management (IAM) 介紹&lt;/a> 一樣，在測試 eksctl 建立 EKS 時，發現一直噴錯，說我沒有權限，但我去看我的 IAM Policy 也有加上對應 action 以及 resource，但還是不行，後來發現 &lt;code>cloudformation:*&lt;/code> 這個 action 所在的 Policy 有加上 Condition MFA 驗證的條件，所以就來寫一篇如何使用 MFA Token 驗證 AWS CLI 的文章。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/1.png"
alt="沒有權限噴錯QQ" width="850">&lt;figcaption>
&lt;p>沒有權限噴錯QQ&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>前情提要&lt;span class="hx-absolute -hx-mt-20" id="前情提要">&lt;/span>
&lt;a href="#%e5%89%8d%e6%83%85%e6%8f%90%e8%a6%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我目前有 3 個 IAM Policy，分別是：&lt;/p>
&lt;ol>
&lt;li>default-policy：放一些個人基本的 IAM 權限&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/2.png"
alt="default-policy" width="650">&lt;figcaption>
&lt;p>default-policy&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="2">
&lt;li>poc-general-policy：放一些我在測試的 PoC 的 IAM 權限，&lt;b>但是仔細看這邊有 Condition MFA 驗證的條件&lt;/b>。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/3.png"
alt="poc-general-policy" width="650">&lt;figcaption>
&lt;p>poc-general-policy&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>ReadOnlyAccess：預設的 ReadOnlyAccess 權限。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/4.png"
alt="ReadOnlyAccess" width="650">&lt;figcaption>
&lt;p>ReadOnlyAccess&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>當你設定好 &lt;code>aws configure&lt;/code> 後，你會拿到一個永久性的 IAM 憑證 (也就是 Access Key ID 和 Secret Access Key，設定可以看&lt;a href="../aws-cli/#%e9%85%8d%e7%bd%ae-aws-cli" >配置 AWS CLI&lt;/a>)，但是如果你的 Policy 有加上 MFA 驗證的條件，那你就需要使用 MFA Token 來驗證，那要怎麼做呢？&lt;/p>
&lt;br>
&lt;h2>查詢目前有沒有設定 MFA&lt;span class="hx-absolute -hx-mt-20" id="查詢目前有沒有設定-mfa">&lt;/span>
&lt;a href="#%e6%9f%a5%e8%a9%a2%e7%9b%ae%e5%89%8d%e6%9c%89%e6%b2%92%e6%9c%89%e8%a8%ad%e5%ae%9a-mfa" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>可以先查詢目前有沒有設定 MFA，可以透過以下指令：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws iam list-mfa-devices --user-name &lt;span style="color:#f92672">{&lt;/span>USER_NAME&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>將 &lt;code>{USER_NAME}&lt;/code> 換成自己的使用者名稱，如果有設定 MFA，就會顯示出來，如下：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/5.png"
alt="顯示 mfa 裝置" width="650">&lt;figcaption>
&lt;p>顯示 mfa 裝置&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>產生 MFA Token&lt;span class="hx-absolute -hx-mt-20" id="產生-mfa-token">&lt;/span>
&lt;a href="#%e7%94%a2%e7%94%9f-mfa-token" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們確定我們有 MFA 設定後，就可以透過已經設定好的 MFA 以及剛剛的 SerialNumber 來產生 MFA Token，指令如下：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws sts get-session-token --duration-seconds &lt;span style="color:#ae81ff">129600&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --serial-number &lt;span style="color:#f92672">{&lt;/span>MFA_DEVICES_NUMBER&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --token-code &lt;span style="color:#f92672">{&lt;/span>MFA_CODE&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>首先 &lt;code>--duration-seconds&lt;/code> 參數是 MFA Token 的有效時間，單位是秒，預設是 12 小時，我們可以調整 900 秒 (15 分鐘) 到 129600 秒 (36 小時)，root 使用者憑證，範圍為 900 秒 (15 分鐘）到 3600 秒 (1 小時)，大家可以自行調整。&lt;/p>
&lt;p>&lt;code>{MFA_DEVICES_NUMBER}&lt;/code> 換成剛剛查詢到的 MFA 裝置的 SerialNumber，最後將 &lt;code>{MFA_CODE}&lt;/code> 換成你的 MFA 的 Code。&lt;/p>
&lt;br>
&lt;p>一起來看一下輸出結果：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Credentials&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AccessKeyId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ASIA2HCXXXXXXXXXXXXX&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SecretAccessKey&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;25CBN6CjRNLPukXXXXXXXXXXXXX&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SessionToken&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;FwoGZXIvYXdzEXXXXXXXXXXXXX&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Expiration&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2024-08-02T19:42:36+00:00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>AccessKeyId、SecretAccessKey 就跟 &lt;code>aws configure&lt;/code> 拿到的 Access Key ID 和 Secret Access Key 是一樣的類型，只是還多一個 SessionToken，這個 SessionToken 是有經過 MFA 驗證過，所以可以用來執行需要 MFA 驗證條件的 Policy。&lt;/p>
&lt;br>
&lt;h2>寫入設定檔&lt;span class="hx-absolute -hx-mt-20" id="寫入設定檔">&lt;/span>
&lt;a href="#%e5%af%ab%e5%85%a5%e8%a8%ad%e5%ae%9a%e6%aa%94" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>當你拿到 Token 以外，你不可能每次下指令都帶 Token，所以我們要把它寫到 &lt;code>~/.aws/credentials&lt;/code> 檔案中，這樣就可以自動帶入 Token 了。&lt;/p>
&lt;p>我們在 &lt;code>aws configure&lt;/code> 的時候，會有一個 &lt;code>profile&lt;/code> 的選項，這個選項就是用來設定不同的憑證，預設是 &lt;code>default&lt;/code>，我們可以自己設定一個新的憑證，如下：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&lt;/span>mfa&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>aws_access_key_id &lt;span style="color:#f92672">=&lt;/span> ASIA2HCXXXXXXXXXXXXX
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>aws_secret_access_key &lt;span style="color:#f92672">=&lt;/span> 25CBN6CjRNLPukXXXXXXXXXXXXX
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>aws_session_token &lt;span style="color:#f92672">=&lt;/span> FwoGZXIvYXdzEXXXXXXXXXXXXX&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>所以當你要使用 MFA Token 的時候，只要在指令後面加上 &lt;code>--profile mfa&lt;/code> 就可以了。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/6.png"
alt="就可以用 poc-general-policy 的 action 囉～" width="850">&lt;figcaption>
&lt;p>就可以用 poc-general-policy 的 action 囉～&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>當然，如果每次都需要下指令去取得 Token 也是很麻煩的，所以我寫了一個 Shell Script 來幫我們取得 Token 並寫入 &lt;code>~/.aws/credentials&lt;/code> 檔案中，這樣就可以省去每次都要下指令的麻煩了。程式也會同步到 &lt;a href="https://github.com/880831ian/aws-cli-mfa" target="_blank" rel="noopener">Github&lt;/a>，大家可以自行下載使用。&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#! /bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>USER_NAME&lt;span style="color:#f92672">=&lt;/span>$1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>MFA_CODE&lt;span style="color:#f92672">=&lt;/span>$2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 顏色設定&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RED&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;\033[1;31m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>GREEN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;\033[1;32m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>YELLOW&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;\033[1;33m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>BLUE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;\033[1;34m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>WHITE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;\033[0m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> -z $USER_NAME &lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">[&lt;/span> -z $MFA_CODE &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;\n&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>YELLOW&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">提醒說明：請輸入使用者名稱 與 MFA 驗證碼\n格式如下：./aws_mfa.sh ian_zhuang 235821 &amp;lt;&amp;lt; (請依照手機上的 MFA 號碼)。&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>WHITE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> ! &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$MFA_CODE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">=&lt;/span>~ ^&lt;span style="color:#f92672">[&lt;/span>0-9&lt;span style="color:#f92672">]{&lt;/span>6&lt;span style="color:#f92672">}&lt;/span>$ &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;\n&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>YELLOW&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">提醒說明：MFA 驗證碼只支援 6 碼數字。&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>WHITE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>MFA_DEVICES_NUMBER&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>aws iam list-mfa-devices --user-name &lt;span style="color:#e6db74">${&lt;/span>USER_NAME&lt;span style="color:#e6db74">}&lt;/span> | jq -r &lt;span style="color:#e6db74">&amp;#39;.MFADevices[0].SerialNumber&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> -z $MFA_DEVICES_NUMBER &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;\n&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>RED&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">錯誤說明：MFA 裝置不存在，請確認使用者名稱是否輸入正確&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>WHITE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>MFA_INFO&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>aws sts get-session-token --duration-seconds &lt;span style="color:#ae81ff">129600&lt;/span> --serial-number &lt;span style="color:#e6db74">${&lt;/span>MFA_DEVICES_NUMBER&lt;span style="color:#e6db74">}&lt;/span> --token-code &lt;span style="color:#e6db74">${&lt;/span>MFA_CODE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> $? -eq &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_ACCESS_KEY_ID&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo $MFA_INFO | jq -r &lt;span style="color:#e6db74">&amp;#39;.Credentials.AccessKeyId&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_SECRET_ACCESS_KEY&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo $MFA_INFO | jq -r &lt;span style="color:#e6db74">&amp;#39;.Credentials.SecretAccessKey&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_SESSION_TOKEN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo $MFA_INFO | jq -r &lt;span style="color:#e6db74">&amp;#39;.Credentials.SessionToken&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_EXPIRATION&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo $MFA_INFO | jq -r &lt;span style="color:#e6db74">&amp;#39;.Credentials.Expiration&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 計算 MFA 到期時間(轉換時區)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_0_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -j -f &lt;span style="color:#e6db74">&amp;#34;%Y-%m-%dT%H:%M:%S&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$MFA_EXPIRATION&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | sed &lt;span style="color:#e6db74">&amp;#39;s/+00:00//&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_8_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -j -v+8H -f &lt;span style="color:#e6db74">&amp;#34;%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$MFA_0_TIME&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MFA_CREDENTIALS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;[mfa]\naws_access_key_id = &lt;/span>$MFA_ACCESS_KEY_ID&lt;span style="color:#e6db74">\naws_secret_access_key = &lt;/span>$MFA_SECRET_ACCESS_KEY&lt;span style="color:#e6db74">\naws_session_token = &lt;/span>$MFA_SESSION_TOKEN&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 檢查是否已經有 [mfa] 區塊&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> grep -q &lt;span style="color:#e6db74">&amp;#34;\[mfa\]&amp;#34;&lt;/span> ~/.aws/credentials; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 更新 [mfa] 區塊&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sed -i &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span> &lt;span style="color:#e6db74">&amp;#39;/\[mfa\]/,/^$/d&amp;#39;&lt;/span> ~/.aws/credentials
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$MFA_CREDENTIALS&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &amp;gt;&amp;gt;~/.aws/credentials
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 新增 [mfa] 區塊&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;\n\n&lt;/span>$MFA_CREDENTIALS&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &amp;gt;&amp;gt;~/.aws/credentials
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;\n&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>GREEN&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">MFA 驗證成功，將 Key 跟 Token 加入or修改到 ~/.aws/credentials 檔案中&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>WHITE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>BLUE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">到期時間：&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>MFA_8_TIME&lt;span style="color:#e6db74">}${&lt;/span>WHITE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;\n&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>RED&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">MFA 驗證失敗，請確認 MFA 驗證碼是否正確&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>WHITE&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>只需要執行 &lt;code>./aws_mfa.sh {USER_NAME} {MFA_CODE}&lt;/code> 就可以了，程式會自動幫你取得 Token 並寫入 &lt;code>~/.aws/credentials&lt;/code> 檔案中。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/cli-mfa/7.png"
alt="執行腳本" width="700">&lt;figcaption>
&lt;p>執行腳本&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx-absolute -hx-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>How do I use an MFA token to authenticate access to my AWS resources through the AWS CLI?
：&lt;a href="https://repost.aws/knowledge-center/authenticate-mfa-cli" target="_blank" rel="noopener">https://repost.aws/knowledge-center/authenticate-mfa-cli&lt;/a>&lt;/p></description></item><item><title>設定 AWS CLI 以及 AWS CLI 指令說明</title><link>https://pin-yi.me/blog/aws/aws-cli/</link><pubDate>Fri, 26 Jul 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-cli/</guid><description>
&lt;h2>介紹&lt;span class="hx-absolute -hx-mt-20" id="介紹">&lt;/span>
&lt;a href="#%e4%bb%8b%e7%b4%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>AWS CLI 是用於使用 AWS 服務的命令列工具。它也用於對 IAM 使用者或角色進行身份驗證，以便從本機電腦存取 Amazon EKS 叢集和其他 AWS 資源。若要從命令列在 AWS 中設定資源，您需要取得要在命令列中使用的 AWS 存取金鑰 ID 和金鑰。&lt;/p>
&lt;br>
&lt;h2>如何安裝 AWS CLI&lt;span class="hx-absolute -hx-mt-20" id="如何安裝-aws-cli">&lt;/span>
&lt;a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%9d-aws-cli" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Mac 安裝指令：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>brew install awscli&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>自動補齊指令：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>complete -C &lt;span style="color:#e6db74">&amp;#39;/usr/local/bin/aws_completer&amp;#39;&lt;/span> aws&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>如何設定 AWS CLI&lt;span class="hx-absolute -hx-mt-20" id="如何設定-aws-cli">&lt;/span>
&lt;a href="#%e5%a6%82%e4%bd%95%e8%a8%ad%e5%ae%9a-aws-cli" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>AWS 跟 GCP 比較不一樣的是 CLI 在 Google (gcloud) 可以使用 Web 登入的方式來驗證 &lt;code>gcloud auto login&lt;/code>，但是在 AWS 需要使用 Access Key ID 和 Secret Access Key 來驗證。&lt;/p>
&lt;p>因此我們在開始使用前，需要先透過 UI 產生自己帳號的 Access Key ID 和 Secret Access Key，才能夠有權限下指令。&lt;/p>
&lt;br>
&lt;h3>建立存取密鑰&lt;span class="hx-absolute -hx-mt-20" id="建立存取密鑰">&lt;/span>
&lt;a href="#%e5%bb%ba%e7%ab%8b%e5%ad%98%e5%8f%96%e5%af%86%e9%91%b0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>需要先確認是否有以下的 IAM 權限：&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;Action&amp;#34;: [
&amp;#34;iam:CreateAccessKey&amp;#34;,
&amp;#34;iam:DeleteAccessKey&amp;#34;,
&amp;#34;iam:GetAccessKeyLastUsed&amp;#34;,
&amp;#34;iam:ListAccessKeys&amp;#34;,
&amp;#34;iam:UpdateAccessKey&amp;#34;,
&amp;#34;iam:TagUser&amp;#34;
]&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>TagUser：是用來幫金鑰加上標籤值，方便管理。&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cli/1.png"
alt="沒有權限會噴錯" width="850">&lt;figcaption>
&lt;p>沒有權限會噴錯&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol>
&lt;li>先登入 AWS 的管理控制台。&lt;/li>
&lt;li>點擊右上角的 AWS 使用者名稱，並點選「安全憑證」。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cli/2.png"
alt="在 AWS 的管理控制台，選擇安全憑證" width="750">&lt;figcaption>
&lt;p>在 AWS 的管理控制台，選擇安全憑證&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>找到存取金鑰，並點選「建立存取金鑰」，如果有建立過，也會顯示在這邊。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cli/3.png"
alt="建立存取金鑰" width="1100">&lt;figcaption>
&lt;p>建立存取金鑰&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="4">
&lt;li>點選「命令列介面 (CLI)」，下方要勾選一個確認建議的選項，最後按下一步。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cli/4.png"
alt="選擇命令列介面 (CLI)案例" width="900">&lt;figcaption>
&lt;p>選擇命令列介面 (CLI)案例&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>可以選擇是否要建立標籤，如果要建立，需要前面提到的 &lt;code>iam:TagUser&lt;/code> IAM 權限。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cli/5.png"
alt="設定描述標籤" width="950">&lt;figcaption>
&lt;p>設定描述標籤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="6">
&lt;li>就可以拿到存取金鑰 (Access Key ID) 以及私密存取金鑰 (Secret Access Key)，&lt;b>要記住私密存取金鑰，只有這個畫面可以拿到，如果沒有儲存，就需要重新建立一個新的金鑰&lt;/b>。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cli/6.png"
alt="產生完金鑰" width="1100">&lt;figcaption>
&lt;p>產生完金鑰&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;br>
&lt;h3>配置 AWS CLI&lt;span class="hx-absolute -hx-mt-20" id="配置-aws-cli">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae-aws-cli" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>接下來我們要在本機把剛剛產生的 Access Key ID 和 Secret Access Key 設定到 AWS CLI，我們可以下這個指令。&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws configure&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="2">
&lt;li>下完後，就會顯示以下設定畫面，分別輸入 Access Key ID、Secret Access Key、預設區域以及輸出格式。&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>AWS Access Key ID &lt;span style="color:#f92672">[&lt;/span>None&lt;span style="color:#f92672">]&lt;/span>: AAKIA2HCM5WKG7R647HTV
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>AWS Secret Access Key &lt;span style="color:#f92672">[&lt;/span>None&lt;span style="color:#f92672">]&lt;/span>: ******************************
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Default region name &lt;span style="color:#f92672">[&lt;/span>None&lt;span style="color:#f92672">]&lt;/span>: region-code &lt;span style="color:#f92672">(&lt;/span>例如：亞太地區東京 ap-northeast-1&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Default output format &lt;span style="color:#f92672">[&lt;/span>None&lt;span style="color:#f92672">]&lt;/span>: json&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就代表成功設定完成囉 ლ(́◕◞౪◟◕‵ლ)&lt;/p>
&lt;br>
&lt;p>另外，設定的內容會寫到 &lt;code>~/.aws/credentials&lt;/code> 和 &lt;code>~/.aws/config&lt;/code> 這兩個檔案中，如果想要修改設定，也可以直接修改這兩個檔案。&lt;/p>
&lt;br>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div class="filename not-prose" dir="auto">~/.aws/credentials&lt;/div>&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&lt;/span>default&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>aws_access_key_id &lt;span style="color:#f92672">=&lt;/span> AAKIA2HCM5WKG7R647HTV
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>aws_secret_access_key &lt;span style="color:#f92672">=&lt;/span> t5CMmR4Y7cuFC/RgxJS1XXXXXXXXXXXXXXXXXXXX&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-8">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div class="filename not-prose" dir="auto">~/.aws/config&lt;/div>&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&lt;/span>default&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>region &lt;span style="color:#f92672">=&lt;/span> ap-northeast-1&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-8">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>常用 的 AWS CLI 指令說明&lt;span class="hx-absolute -hx-mt-20" id="常用-的-aws-cli-指令說明">&lt;/span>
&lt;a href="#%e5%b8%b8%e7%94%a8-%e7%9a%84-aws-cli-%e6%8c%87%e4%bb%a4%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>指令&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>aws sts get-caller-identity&lt;/code>&lt;/td>
&lt;td>驗證使用者身份&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>aws eks list-clusters --region {REGION}&lt;/code>&lt;/td>
&lt;td>列出區域的 EKS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>aws iam list-mfa-devices --user-name {USER_NAME}&lt;/code>&lt;/td>
&lt;td>列出使用者的 MFA 裝置&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>aws sts get-session-token --duration-seconds 129600 --serial-number ${MFA_DEVICES_NUMBER} --token-code ${MFA_CODE}&lt;/code>&lt;/td>
&lt;td>取得 MFA Token&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>參考資料&lt;span class="hx-absolute -hx-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>探索 AWS：從菜鳥到熟練的完全指南(四)IAM 登入方式：&lt;a href="https://hackmd.io/@gdw7l5sPTOyNv76kZ_twjA/SkTPl-xP3" target="_blank" rel="noopener">https://hackmd.io/@gdw7l5sPTOyNv76kZ_twjA/SkTPl-xP3&lt;/a>&lt;/p>
&lt;p>設定 AWS CLI：&lt;a href="https://docs.aws.amazon.com/eks/latest/userguide/install-awscli.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/eks/latest/userguide/install-awscli.html&lt;/a>&lt;/p>
&lt;p>AWS CLI 指令參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/cli/latest/userguide/cli_code_examples_categorized.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_tw/cli/latest/userguide/cli_code_examples_categorized.html&lt;/a>&lt;/p></description></item></channel></rss>