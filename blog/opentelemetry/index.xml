<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI â€“ Opentelemetry</title><link>https://pin-yi.me/blog/opentelemetry/</link><description>Recent content in Opentelemetry on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><atom:link href="https://pin-yi.me/blog/opentelemetry/index.xml" rel="self" type="application/rss+xml"/><item><title>å¦‚ä½•é€é OpenTelemetry ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š</title><link>https://pin-yi.me/blog/opentelemetry/opentelemetry-ingress-nginx-controller/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/opentelemetry/opentelemetry-ingress-nginx-controller/</guid><description>
&lt;p>ç”±æ–¼æœ€è¿‘å…¬å¸æƒ³è¦å°å…¥ Datadogï¼Œåœ¨æ¸¬è©¦éç¨‹ä¸­é †ä¾¿å°å…¥ OpenTelemetry ä¾†æ”¶é›† Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š ï½&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ğŸ”¥ é€™å€‹ç¯„ä¾‹æ¯”è¼ƒç‰¹åˆ¥ï¼Œå› ç‚º Datadog æœ‰æä¾› Ingress Nginx Controller çš„ integrationsï¼Œå¯ä»¥é€é Datadog Agent ä¾†æ”¶é›† Metricsï¼Œä¸éœ€è¦é€é OpenTelemetry Collector ä¾†æ”¶é›†ã€‚
( Datadog Agent è«‹åƒè€ƒï¼š&lt;a href="https://docs.datadoghq.com/containers/kubernetes/" target="_blank" rel="noopener">https://docs.datadoghq.com/containers/kubernetes/&lt;/a> )&lt;/p>
&lt;p>ç¨‹å¼éƒ¨åˆ†ä¹ŸåŒæ­¥ä¸Šå‚³åˆ° github ä¸Šï¼Œ&lt;a href="https://github.com/880831ian/opentelemetry-ingress-nginx-controller" target="_blank" rel="noopener">å¯ä»¥é»æˆ‘å‰å¾€&lt;/a>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>æª”æ¡ˆèªªæ˜&lt;span class="absolute -mt-20" id="æª”æ¡ˆèªªæ˜">&lt;/span>
&lt;a href="#%e6%aa%94%e6%a1%88%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>otel-collector.yamlï¼š
OpenTelemetry Collector çš„è¨­å®šæª”ï¼Œä¸»è¦æ˜¯è¨­å®šè¦æ”¶é›†å“ªäº› metricsã€tracesï¼Œä¸¦ä¸”è¦é€åˆ°å“ªå€‹ exporterï¼Œè¦æ³¨æ„çš„æ˜¯ exporters çš„ datadog éœ€è¦è¨­å®š siteã€api_keyï¼Œä»¥åŠ image è¦è¨˜å¾—ç”¨ otel/opentelemetry-collector-contribï¼Œæ‰æœƒæœ‰ datadog çš„ exporterã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ingress-nginx-values.yamlï¼š
Ingress Nginx Controller çš„è¨­å®šæª”ï¼Œé€™é‚Šçš„ podAnnotations æ˜¯ç‚ºäº†è®“ Ingress Nginx Controller çš„ Pod èƒ½å¤ é€é Datadog agent æ”¶é›† metrics åˆ° Datadog æ‰åŠ ä¸Šçš„ã€‚&lt;/p>
&lt;p>config è£¡é¢çš„è¨­å®šæœ‰å¾ˆå¤šï¼Œä¸»è¦éƒ½æ˜¯ openTelemetry çš„è¨­å®šï¼Œè¦æ³¨æ„çš„æ˜¯ enable-opentelemetry è¦è¨­ç‚º trueï¼Œå¦å¤– otlp-collector-host ä»¥åŠ otlp-collector-port è¦é€åˆ°å“ªå€‹ collector ç­‰ç­‰ä¹Ÿè¦è¨˜å¾—è¨­å®šã€‚
å¦å¤–å¦‚æœæƒ³è¦å°‡ LOG èˆ‡ Trace ä¸²å†ä¸€èµ·ï¼Œè¨˜å¾—è¦æŠŠ log-format è¨­ç‚º jsonï¼Œä¸¦ä¸”å¸¶å…¥ï¼Œtrace_id èˆ‡ span_id ( é€™é‚Šæœ‰å¤šå¸¶ dd.trace_id æ˜¯ç‚ºäº†è®“ datadog å¯ä»¥è‡ªå‹•ä¸²æ¥ LOG &amp;amp; Trace )ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>nginx.yamlï¼š
ä¸€å€‹ç°¡å–®çš„ Nginx æ•´å¥—æœå‹™ (Deploymentã€Serviceã€Ingress)ï¼Œè¦æ³¨æ„çš„æ˜¯ Ingress éœ€è¦è¨­å®š annotations kubernetes.io/ingress.class: nginx (é€™å€‹æ˜¯ Ingress Nginx Controller çš„é è¨­ class name)ï¼Œæ‰æœƒè¢« Ingress Nginx Controller æ¥ç®¡ (æ‰æœƒæœ‰ Load Balancer çš„ IP)&lt;/p>
&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;h2>åŸ·è¡Œæ­¥é©Ÿ&lt;span class="absolute -mt-20" id="åŸ·è¡Œæ­¥é©Ÿ">&lt;/span>
&lt;a href="#%e5%9f%b7%e8%a1%8c%e6%ad%a5%e9%a9%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>
&lt;p>å…ˆ clone é€™å€‹ repo (å»¢è©± xD)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å…ˆå»ºç«‹ OpenTelemetry Collectorï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>helm upgrade collector &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> opentelemetry-collector &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --repo https://open-telemetry.github.io/opentelemetry-helm-charts &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --install &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --create-namespace &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --namespace opentelemetry &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -f &lt;span style="color:#e6db74">&amp;#34;otel-collector.yaml&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>å†å»ºç«‹ Ingress Nginx Controllerï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>helm upgrade ingress-nginx &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> ingress-nginx &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --repo https://kubernetes.github.io/ingress-nginx &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --install &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --create-namespace &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --namespace ingress-nginx &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -f &lt;span style="color:#e6db74">&amp;#34;ingress-nginx-values.yaml&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;li>
&lt;p>æ¥è‘—å»ºç«‹æ¸¬è©¦ç”¨ Nginx æœå‹™ï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š&lt;/p>
&lt;div class="code-block relative mt-6 first:mt-0 group/code">&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl apply -f nginx.yaml&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0">
&lt;button
class="code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;div class="hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;!-- raw HTML omitted -->
&lt;h2>æ¸¬è©¦&lt;span class="absolute -mt-20" id="æ¸¬è©¦">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ç•¶ä½ åŸ·è¡Œå®Œä¸Šé¢çš„æ­¥é©Ÿå¾Œï¼Œä½ æœƒç™¼ç¾æœ‰ç”¢ç”Ÿå…©å€‹ namespaceï¼Œä¸€å€‹æ˜¯ ingress-nginxï¼Œå¦ä¸€å€‹æ˜¯ opentelemetryï¼Œä¸¦ä¸”æœƒæœ‰ OpenTelemetry Collectorã€Ingress Nginx Controllerã€Nginx ç­‰æœå‹™ï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/opentelemetry/opentelemetry-ingress-nginx-controller/1.png" title="å•Ÿå‹•æœå‹™" alt="" loading="lazy" />
&lt;figcaption>å•Ÿå‹•æœå‹™&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>æˆ‘å€‘è©¦è‘—æ‰“ &lt;code>http://nginx.example.com/&lt;/code> (æ¸¬è©¦ç¶²å€ï¼Œéœ€è¦å…ˆåœ¨ /etc/hosts ç¶å®š Ingress Nginx Controller å’¬ä½çš„ Load Balancer IP)ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ Datadog çš„ LOGï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ”¶åˆ° Nginx çš„ LOG (æ­¤æ”¶é›† LOG çš„æ–¹å¼æ˜¯é€éåœ¨ cluster ä¸Šå®‰è£ Datadog çš„ agent)ï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/opentelemetry/opentelemetry-ingress-nginx-controller/2.png" title="Datadog LOG" alt="" loading="lazy" />
&lt;figcaption>Datadog LOG&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>æ¥è‘—æŸ¥çœ‹ Datadog APM çš„ traceï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/opentelemetry/opentelemetry-ingress-nginx-controller/3.png" title="Datadog APM" alt="" loading="lazy" />
&lt;figcaption>Datadog APM&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ç”±æ–¼æˆ‘å€‘åœ¨å¾Œé¢ç›®å‰æ²’æœ‰ä¸²å…¶ä»–æœå‹™ï¼Œæ‰€ä»¥åªæœ‰ä¸€å€‹ spanï¼Œä¹‹å¾Œé‚„æœ‰å¦å¤–å…©ç¯‡æ–‡ç« æ˜¯ä»‹ç´¹å¦‚ä½•ä¸²å…¶ä»–æœå‹™ (æœƒå¢åŠ æœå‹™ä»¥åŠéƒ¨åˆ†è¨­å®š)ï¼Œå¯ä»¥åƒè€ƒçœ‹çœ‹ï¼š&lt;a href="https://github.com/880831ian/opentelemetry-roadrunner" target="_blank" rel="noopener">opentelemetry-roadrunner&lt;/a>ã€&lt;a href="https://github.com/880831ian/opentelemetry-nodejs" target="_blank" rel="noopener">opentelemetry-nodejs&lt;/a>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>é †ä¾¿çœ‹ä¸€ä¸‹é€é Datadog Agent æ”¶é›†çš„ Ingress Nginx Controller çš„ Metricsï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/opentelemetry/opentelemetry-ingress-nginx-controller/4.png" title="Datadog Ingress Nginx Controller çš„ Metrics" alt="" loading="lazy" />
&lt;figcaption>Datadog Ingress Nginx Controller çš„ Metrics&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>å¯ä»¥ç”¨é€™äº› Metrics ä¾†åš Dashboardï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;figure>
&lt;img src="https://pin-yi.me/opentelemetry/opentelemetry-ingress-nginx-controller/5.png" title="Datadog Dashboard" alt="" loading="lazy" />
&lt;figcaption>Datadog Dashboard&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>çµè«–&lt;span class="absolute -mt-20" id="çµè«–">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>é€é OpenTelemetry Collector ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Šï¼Œé€™æ¨£å°±å¯ä»¥é€é Ingress Nginx Controller çš„ Metrics ä¾†åšç›£æ§äº†ï¼Œå°æ–¼ RD å†é–‹ç™¼ä¸Šï¼Œæœ‰ Traces ä¹Ÿæ›´æ–¹ä¾¿ RD ä»–å€‘æ‰¾åˆ°ç¨‹å¼çš„ç“¶é ¸ (æœ‰å¯èƒ½æ˜¯æœå‹™å°è‡´çš„)ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2>åƒè€ƒ&lt;span class="absolute -mt-20" id="åƒè€ƒ">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Configure Nginx Ingress Controller to use JSON log formatï¼š&lt;a href="https://dev.to/bzon/send-gke-nginx-ingress-controller-logs-to-stackdriver-2ih4" target="_blank" rel="noopener">https://dev.to/bzon/send-gke-nginx-ingress-controller-logs-to-stackdriver-2ih4&lt;/a>&lt;/p>
&lt;p>æ·ºè«‡ OpenTelemetry - Collector Compoentsï¼š&lt;a href="https://ithelp.ithome.com.tw/articles/10290703" target="_blank" rel="noopener">https://ithelp.ithome.com.tw/articles/10290703&lt;/a>&lt;/p></description></item></channel></rss>