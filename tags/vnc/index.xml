<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – VNC</title><link>https://pin-yi.me/tags/vnc/</link><description>Recent content in VNC on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Fri, 03 Jan 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://pin-yi.me/tags/vnc/index.xml" rel="self" type="application/rss+xml"/><item><title>透過 AWS SSM 連線至 macOS EC2 並啟用 VNC 遠端桌面 GUI</title><link>https://pin-yi.me/blog/aws/aws-ssm-macos-ec2-vnc-gui/</link><pubDate>Fri, 03 Jan 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ssm-macos-ec2-vnc-gui/</guid><description>
&lt;h2>名詞說明&lt;span class="hx:absolute hx:-mt-20" id="名詞說明">&lt;/span>
&lt;a href="#%e5%90%8d%e8%a9%9e%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>AWS：Amazon Web Services 亞馬遜的雲端服務&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SSM：AWS Systems Manager 可以透過 AWS 直接連上內部 VPC 的機器 (不需要在 public subnet)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>EC2：AWS 的虛擬雲端計算服務&lt;/p>
&lt;/li>
&lt;li>
&lt;p>VNC：Virtual Network Computing 遠端控制&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;h2>步驟&lt;span class="hx:absolute hx:-mt-20" id="步驟">&lt;/span>
&lt;a href="#%e6%ad%a5%e9%a9%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>
&lt;p>確定使用的 User 有 &lt;code>ssm:StartSession&lt;/code> 權限&lt;/p>
&lt;/li>
&lt;li>
&lt;p>確定要連線的 EC2 有 IAM Role 並被賦予 &lt;code>AmazonSSMManagedInstanceCore&lt;/code> 權限&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/1.webp"
alt="AmazonSSMManagedInstanceCore 權限" width="1000">&lt;figcaption>
&lt;p>AmazonSSMManagedInstanceCore 權限&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>
&lt;p>確定 EC2 上有安裝 SSM Agent，macOS 可以查看：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/ssm-agent-macos.html"target="_blank" rel="noopener">在 macOS 專用 EC2 執行個體使用 SSM Agent - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>接著我們等到 EC2 確定啟動完畢 (macOS 啟動到可以連線需要約 5 分鐘)，可以以下指令連線測試&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &amp;lt;instance-id&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>&amp;lt;instance-id&amp;gt;&lt;/code> 請帶上 EC2 的 instance id&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/2.webp"
alt="SSM 連線" width="900">&lt;figcaption>
&lt;p>SSM 連線&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>確認看看是否可以正常連線，可以下 &lt;code>sudo -i&lt;/code> 來切換成 root&lt;/p>
&lt;br>
&lt;ol start="5">
&lt;li>當我們確定可以透過 SSM 連上 EC2 後，接著我們要安裝並啟動 macOS 畫面共用，請安裝以下指令&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="6">
&lt;li>接著要透過 VNC 連線，需要指定 User，但我們沒辦法拿到 root 密碼，所以只能在建立一個帳號，或是使用預設的 ec2-user，這邊先使用預設帳號，並新增密碼&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo /usr/bin/dscl . -passwd /Users/ec2-user&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="7">
&lt;li>接著開啟新的一個 Terminal 下此指令，透過 SSM 將本機與 EC2 內部的 Port 做 Port forwarding&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ssm start-session &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --target &amp;lt;instance-id&amp;gt; &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartPortForwardingSession&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;portNumber&amp;#34;:[&amp;#34;5900&amp;#34;], &amp;#34;localPortNumber&amp;#34;:[&amp;#34;5900&amp;#34;]}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就會看到這個類似的畫面&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/3.webp"
alt="SSM Port Forwarding" width="750">&lt;figcaption>
&lt;p>SSM Port Forwarding&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="8">
&lt;li>開啟瀏覽器或是開啟 macOS 內建的螢幕共享，打上&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vnc://localhost:5900&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就可以看到此畫面囉&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/4.webp"
alt="VNC 連線到 macOS" width="800">&lt;figcaption>
&lt;p>VNC 連線到 macOS&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>備註&lt;span class="hx:absolute hx:-mt-20" id="備註">&lt;/span>
&lt;a href="#%e5%82%99%e8%a8%bb" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>假設是建立其他的 User (不是用 ec2-user)，在第一次連線時，還是需要先登入 ec2-user 才可以切換其他帳號&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>How can I access my Amazon EC2 macOS instance through a GUI?：&lt;a href="https://repost.aws/knowledge-center/ec2-mac-instance-gui-access"target="_blank" rel="noopener">Access an EC2 macOS instance through a GUI&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>AWS Systems Manager 使用 Port-Forwarding：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding"target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item></channel></rss>