<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – KubeDNS</title><link>https://pin-yi.me/tags/kubedns/</link><description>Recent content in KubeDNS on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Tue, 12 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://pin-yi.me/tags/kubedns/index.xml" rel="self" type="application/rss+xml"/><item><title>GKE DNS 相關注意事項及結論</title><link>https://pin-yi.me/blog/gcp/gke-dns/</link><pubDate>Tue, 12 Aug 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-dns/</guid><description>
&lt;p>一樣先前情提要：&lt;/p>
&lt;p>最近在評估要將公司內的 EndPoint 都改成 Cloud DNS 的 Private Zone (打造內部的 internal dns 服務機制)，到時候 DNS 解析的請求會比以往還要多，所以需要先測試評估 GKE 內的 DNS 解析方案，避免再次發生 &lt;a href="../../kubernetes/pod-curl-error-6-could-not-resolve-host">Pod 出現 cURL error 6: Could not resolve host&lt;/a>，此篇文章再來回顧以及整理，可以依照情境測試後的結論以及注意事項，來選擇適合 GKE DNS 組合：&lt;/p>
&lt;p>&lt;a href="../gke-kubedns/">GKE DNS 使用 KubeDNS 運作測試&lt;/a>&lt;/p>
&lt;p>&lt;a href="../gke-kubedns-nodelocaldnscache/">GKE DNS 使用 KubeDNS + NodeLocal DNSCache 運作測試&lt;/a>&lt;/p>
&lt;p>&lt;a href="../gke-cloud-dns/">GKE DNS 使用 Cloud DNS 運作測試&lt;/a>&lt;/p>
&lt;p>&lt;a href="../gke-cloud-dns-nodelocaldnscache/">GKE DNS 使用 Cloud DNS + NodeLocal DNSCache 運作測試&lt;/a>&lt;/p>
&lt;br>
&lt;h2>測試情境的依賴性&lt;span class="hx:absolute hx:-mt-20" id="測試情境的依賴性">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e6%83%85%e5%a2%83%e7%9a%84%e4%be%9d%e8%b3%b4%e6%80%a7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">GKE DNS 情境&lt;/th>
&lt;th style="text-align: left">KubeDNS&lt;/th>
&lt;th style="text-align: left">KubeDNS + NodeLocal DNSCache&lt;/th>
&lt;th style="text-align: left">Cloud DNS&lt;/th>
&lt;th style="text-align: left">Cloud DNS + NodeLocal DNSCache&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為 KubeDNS 有 Liveness，不會馬上關掉，等到 KubeDNS 關成 0 後，就無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為有 NodeLocal DNSCache，透過 Cache 還可以回覆 DNS 請求，但等到 TTL 時間到，就會出現無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會短暫卡住，但他會自動切換到 KubeDNS 上繼續解析&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會直接卡住，會出現無法解析，也不會自動切換成 KubeDNS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為 KubeDNS 有 Liveness，不會馬上關掉，等到 KubeDNS 關成 0 後，就無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依然正常，因為 Cloud DNS Private 他不是 cluster.local，所以不會透過 KubeDNS 來做解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會短暫卡住，但他會自動切換到 KubeDNS 上繼續解析&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會直接卡住，會出現無法解析，也不會自動切換成 KubeDNS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為 KubeDNS 有 Liveness，不會馬上關掉，等到 KubeDNS 關成 0 後，就無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依然正常，因為外部 DNS 他不是 cluster.local，所以不會透過 KubeDNS 來做解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會短暫卡住，但他會自動切換到 KubeDNS 上繼續解析&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會直接卡住，會出現無法解析，也不會自動切換成 KubeDNS&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>測試對於情境的依賴性 (不管 Liveness 或是有 Cache，以結果來看)&lt;span class="hx:absolute hx:-mt-20" id="測試對於情境的依賴性-不管-liveness-或是有-cache以結果來看">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e5%b0%8d%e6%96%bc%e6%83%85%e5%a2%83%e7%9a%84%e4%be%9d%e8%b3%b4%e6%80%a7-%e4%b8%8d%e7%ae%a1-liveness-%e6%88%96%e6%98%af%e6%9c%89-cache%e4%bb%a5%e7%b5%90%e6%9e%9c%e4%be%86%e7%9c%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>✅：代表服務異常不會對解析造成影響&lt;/p>
&lt;p>❌：代表服務異常會對解析造成影響&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">GKE DNS 情境&lt;/th>
&lt;th style="text-align: left">KubeDNS&lt;/th>
&lt;th style="text-align: left">KubeDNS + NodeLocal DNSCache&lt;/th>
&lt;th style="text-align: left">Cloud DNS&lt;/th>
&lt;th style="text-align: left">Cloud DNS + NodeLocal DNSCache&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>結論與優缺點&lt;span class="hx:absolute hx:-mt-20" id="結論與優缺點">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96%e8%88%87%e5%84%aa%e7%bc%ba%e9%bb%9e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">模式&lt;/th>
&lt;th style="text-align: left">結論&lt;/th>
&lt;th style="text-align: left">優點&lt;/th>
&lt;th style="text-align: left">缺點&lt;/th>
&lt;th style="text-align: left">/etc/resolv.conf&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>KubeDNS&lt;/strong>&lt;/td>
&lt;td style="text-align: left">對 KubeDNS 的依賴性極高。只要壞掉，所有解析都會失效&lt;/td>
&lt;td style="text-align: left">GKE 預設設定，能快速使用&lt;/td>
&lt;td style="text-align: left">容易出現單點故障，影響所有 DNS 解析。&lt;br>GKE KubeDNS 可以將 kube-dns-autoscaler configmap 納管進版控來調整 Pod 數量 (但沒辦法動態調整)&lt;br>Deployment 沒辦法調整，會被還原，因為有：addonmanager.kubernetes.io/mode=Reconcile 設定，由 GKE 維運 (&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/custom-kube-dns?hl=zh-tw"target="_blank" rel="noopener">也可以自建 DNS&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>)&lt;/td>
&lt;td style="text-align: left">KubeDNS 的 IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>KubeDNS + NodeLocal DNSCache&lt;/strong>&lt;/td>
&lt;td style="text-align: left">大幅降低對 KubeDNS 的依賴。快取可以應對 KubeDNS 短暫異常&lt;/td>
&lt;td style="text-align: left">提高 DNS 解析的效能和可靠性&lt;/td>
&lt;td style="text-align: left">需要維護 KubeDNS 的 kube-dns-autoscaler configmap 來調整 Pod 數量&lt;/td>
&lt;td style="text-align: left">KubeDNS 的 IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>Cloud DNS&lt;/strong>&lt;/td>
&lt;td style="text-align: left">所有的 DNS 解析都依賴 Cloud DNS。可以將 KubeDNS Pod 縮減為 0&lt;/td>
&lt;td style="text-align: left">高可用性。DNS 責任交由託管服務處理，節省維護成本&lt;/td>
&lt;td style="text-align: left">會有額外的費用，以及若 GCP DNS 出現異常會導致 GKE 服務無法解析問題&lt;/td>
&lt;td style="text-align: left">169.254.169.254&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>Cloud DNS + NodeLocal DNSCache&lt;/strong>&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 只要發生問題，所有的解析都會有異常。&lt;br>所以不太建議使用 Cloud DNS + NodeLocal DNSCache 的模式&lt;/td>
&lt;td style="text-align: left">提供更快的 DNS 解析速度，減少延遲&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 出現問題時，所有解析都會失效&lt;/td>
&lt;td style="text-align: left">169.254.20.10&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>注意事項&lt;span class="hx:absolute hx:-mt-20" id="注意事項">&lt;/span>
&lt;a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a0%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>測試 KubeDNS、KubeDNS + NodeLocal DNSCache、Cloud DNS、Cloud DNS + NodeLocal DNSCache 使用 K6 簡單進行壓測，會發現除了 Cloud DNS 以外，其他的 DNS 解析 RPS 不一定會慢於直接打 IP&lt;/li>
&lt;li>如果有需求需要管理 KubeDNS Deployment 服務，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/custom-kube-dns?hl=zh-tw"target="_blank" rel="noopener">自訂 kube-dns 部署作業&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，但會有相對的維運成本 (因為官方預設的沒辦法調整 Deployment，會因為 addonmanager.kubernetes.io/mode=Reconcile 被 GKE 還原)&lt;/li>
&lt;li>所有只要經過 Cloud DNS 以及 Metadata Server (在 Node 上) 都會有 Cache 機制&lt;/li>
&lt;li>將 GKE 叢集的 DNS 服務從 KubeDNS + NodeLocal DNSCache 換成 Cloud DNS + NodeLocal DNSCache，且此過程會導致舊節點無法解析網域，造成服務中斷，因此建議在維護期間執行，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#dns-fails-dnscache"target="_blank" rel="noopener">從 kube-dns 遷移至 Cloud DNS 後，啟用 NodeLocal DNSCache 時 DNS 解析失敗&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>在升級 GKE Cluster 時，因為會更新 KubeDNS，所以有可能會發生 DNS 解析失敗的情況，不管是否有開啟 NodeLocal DNSCache，都也可能發生 (通常只有一小部分節點會遇到 10%)，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/kube-dns?hl=zh-tw#performance_limitations_with_kube-dns"target="_blank" rel="noopener">kube-dns 的效能限制&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-dns/1.webp" width="600">
&lt;/figure>
&lt;br>
&lt;ol start="6">
&lt;li>將 GKE 叢集的 DNS 服務從 KubeDNS 換成 Cloud DNS VPC 範圍，必須在重建節點後才會生效，且此過程會導致舊節點無法解析網域，造成服務中斷，因此建議在維護期間執行，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#enable-vpc-scope-existing"target="_blank" rel="noopener">在現有叢集啟用 VPC 範圍 DNS&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-dns/2.webp" width="600">
&lt;/figure>
&lt;br>
&lt;ol start="7">
&lt;li>如果已經建立 GKE Cloud DNS VPC 範圍的 Cluster，是沒辦法切換回 KubeDNS，只能重建 Cluster，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#disable-cloud-dns"target="_blank" rel="noopener">停用 Cloud DNS for GKE&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-dns/3.webp" width="600">
&lt;/figure>
&lt;br>
&lt;h2>結論&lt;span class="hx:absolute hx:-mt-20" id="結論">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們上面進行測試的內容，是為了選出 4 種在 GKE DNS 比較好的一個選型，最終考慮：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>服務的可控性 (能夠自己管理 KubeDNS 以及建立 NodeLocal DNSCache)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>服務的穩定性 (服務若異常可以快速恢復，且不需要依靠 GCP 協助)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>服務的監控性 (能夠監控 KubeDNS 以及 NodeLocal DNSCache)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>額外產生的費用 &amp;amp; 人力成本等 (使用 Cloud DNS 會有額外成本)&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>我們公司最終選型為：GKE 內使用 &lt;b>KubeDNS + NodeLocal DNSCache&lt;/b>&lt;/p>
&lt;br>
&lt;p>補充：&lt;/p>
&lt;p>在測試過程中發現，我們使用的是 nslookup 並搭配 busybox image 基底測試，中間有換成 alpine 並安裝 bind-tools 發現在 KubeDNS + NodeLocal DNSCache 將 NodeLocal DNSCache 用壞時，會無法正常解析，或是解析速度會下降很多，我們推測是跟底層的 C 語言 lib 有關。&lt;/p>
&lt;p>下面提供幾個最終可能會導致 DNS 解析有差異的因素，會需要再去考慮以及測試：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>系統底層 C 語言 lib 選用：glibc / msul&lt;/p>
&lt;/li>
&lt;li>
&lt;p>程式 lib 選用 (例如 Golang)：net.http / goresty&lt;/p>
&lt;/li>
&lt;li>
&lt;p>連線方式：短 / 長連線&lt;/p>
&lt;/li>
&lt;li>
&lt;p>晶片架構：amd / arm&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Golang 是否 Build 開啟 CGO_ENABLED 等等&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;p>我們上述的選型主要考慮的不是 KubeDNS 或是 NodeLocal DNSCache 故障等異常情形 (這個異常是可以透過監控以及好的維運設定改善的)，而是上面那四點綜合評估下來的結論&lt;/p></description></item><item><title>GKE DNS 使用 KubeDNS + NodeLocal DNSCache 運作測試</title><link>https://pin-yi.me/blog/gcp/gke-kubedns-nodelocaldnscache/</link><pubDate>Fri, 01 Aug 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-kubedns-nodelocaldnscache/</guid><description>
&lt;p>最近在評估要將公司內的 EndPoint 都改成 Cloud DNS 的 Private Zone (打造內部的 internal dns 服務機制)，到時候 DNS 解析的請求會比以往還要多，所以需要先測試評估 GKE 內的 DNS 解析方案，避免再次發生 &lt;a href="../../kubernetes/pod-curl-error-6-could-not-resolve-host">Pod 出現 cURL error 6: Could not resolve host&lt;/a>，此篇文章測試的是： KubeDNS + NodeLocal DNSCache 的運作。&lt;/p>
&lt;br>
&lt;p>首先，先建立一個 dns-test pod &lt;a href="https://github.com/880831ian/gke-dns/blob/main/dns-test.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 以及 nginx 的 pod + svc &lt;a href="https://github.com/880831ian/gke-dns/blob/main/nginx.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，會分別測試&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal">叢集內部 cluster.local&lt;/a> (nginx-svc.default.svc.cluster.local)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#internal-dns-cloud-dns-private">internal-dns 使用 cloud dns private&lt;/a> (aaa.test-audit.com)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme">外部 dns&lt;/a> (ifconfig.me)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>並使用 nslookup 腳本進行確認回傳 DNS 解析，每一次測試都會重新建立 KubeDNS、NodeLocal DNSCache Pod&lt;/p>
&lt;p>相關程式以及 Prometheus、Grafana 的設定可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;h2>叢集內部 cluster.local&lt;span class="hx:absolute hx:-mt-20" id="叢集內部-clusterlocal">&lt;/span>
&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;cluster.local.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;nginx-svc.default.svc.cluster.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.36.16.35&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.36.16.35 是 nginx-svc Cluster IP&lt;/p>
&lt;p>需要先確認 &lt;code>nginx-svc&lt;/code> 的 IP 是多少，然後修改腳本中的 &lt;code>EXPECTED_IP&lt;/code> 變數。&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/1.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/2.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache 內的指標 hit 跟 request 都有持續上升&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/3.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/4.webp"
alt="第二輪才出現錯誤" width="500">&lt;figcaption>
&lt;p>第二輪才出現錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/5.webp"
alt="因為 KubeDNS 關成 0 顆，不會馬上關掉" width="700">&lt;figcaption>
&lt;p>因為 KubeDNS 關成 0 顆，不會馬上關掉&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/6.webp"
alt="將 KubeDNS 調整回來，就正常解析" width="500">&lt;figcaption>
&lt;p>將 KubeDNS 調整回來，就正常解析&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/7.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>總共打了兩輪的 10000 筆，在第一輪大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，但到了第二輪的 2838 筆的時候才開始出現解析失敗，因為前面 KubeDNS 切成 0，Pod 不會馬上關掉，所以還能夠解析 DNS，中間又因爲有 NodeLocal DNSCache 做 Cache，所以 DNS 解析還有相關紀錄可以回覆，但後面當 Cache TTL 到期後，需要先訪問 KubeDNS 時，此時 KubeDNS 也已經關閉，最後才會出現解析錯誤
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache request 跟 hit 差不多，但當 15:33 線圖開始 request 大於 hit，且出現 miss，這代表因為後面的 KubeDNS 異常，導致 NodeLocal DNSCache 沒辦法做 Cache hit&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/8.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>分別在 15:55:53 跟 15:57:04 下指令調整&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/9.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/10.webp"
alt="觀察調整讓 NodeLocal DNSCache 故障 Log" width="500">&lt;figcaption>
&lt;p>觀察調整讓 NodeLocal DNSCache 故障 Log&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/11.webp"
alt="觀察修正 NodeLocal DNSCache Log" width="500">&lt;figcaption>
&lt;p>觀察修正 NodeLocal DNSCache Log&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/12.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會短暫卡住，但會直接切換到 KubeDNS 上繼續進行解析，因此以結果論，如果 NodeLocal DNSCache 有短暫異常，不會出現無法解析的問題
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache 正常運作，當我們在 15:55:53 調整後，變成 KubeDNS 起來開始處理解析，在 15:57:04 切換讓 NodeLocal DNSCache 恢復，後面又會變成由 NodeLocal DNSCache 來處理解析
&lt;br>
&lt;br>
紫色是 NodeLocal DNSCache，黃色是 KubeDNS&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>Internal DNS (Cloud DNS Private)&lt;span class="hx:absolute hx:-mt-20" id="internal-dns-cloud-dns-private">&lt;/span>
&lt;a href="#internal-dns-cloud-dns-private" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>先建立一個 cloud dns private，以下範例是 aaa.test-audit.com &amp;gt; 10.1.1.4，並將此 use VPC 與 GKE 的 VPC 打通&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/1.webp"
alt="設定 cloud dns private" width="600">&lt;figcaption>
&lt;p>設定 cloud dns private&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;aaa.test-audit.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.1.1.4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.1.1.4 是隨機亂取的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-1">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/2.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/3.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache 內的指標 hit 跟 request 都有持續上升&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/4.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/5.webp"
alt="因為 KubeDNS 關成 0 顆，不會馬上關掉" width="700">&lt;figcaption>
&lt;p>因為 KubeDNS 關成 0 顆，不會馬上關掉&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/6.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>總共打了兩輪的 10000 筆，在第一輪大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，因為前面 KubeDNS 切成 0，Pod 不會馬上關掉，避免有測試誤差，所以在打第二輪 10000 筆，但從結果發現，所有的 DNS 請求都是走 NodeLocal DNSCache，因為 cloud dns private 不是 .cluster.local，所以就算沒有 KubeDNS 也能正常運作&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/7.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>分別在 18:26:11 跟 18:28:03 下指令調整&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/8.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/9.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會短暫卡住，但會直接切換到 KubeDNS 上繼續進行解析，因此以結果論，如果 NodeLocal DNSCache 有短暫異常，不會出現無法解析的問題
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache 正常運作，當我們在 18:26:11 調整後，變成 KubeDNS 起來開始處理解析，在 18:28:03 切換讓 NodeLocal DNSCache 恢復，後面又會變成由 NodeLocal DNSCache 來處理解析
&lt;br>
&lt;br>
紫色是 NodeLocal DNSCache，黃色是 KubeDNS&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>外部 DNS (ifconfig.me)&lt;span class="hx:absolute hx:-mt-20" id="外部-dns-ifconfigme">&lt;/span>
&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ifconfig.me&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;34.160.111.145&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>34.160.111.145 是 ifconfig.me 的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-2">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/1.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/2.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache 內的指標 hit 跟 request 都有持續上升&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/3.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/4.webp"
alt="因為 KubeDNS 關成 0 顆，不會馬上關掉" width="700">&lt;figcaption>
&lt;p>因為 KubeDNS 關成 0 顆，不會馬上關掉&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/5.webp"
alt="Prometheus 監控指標" width="900">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>總共打了兩輪的 10000 筆，在第一輪大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，因為前面 KubeDNS 切成 0，Pod 不會馬上關掉，避免有測試誤差，所以在打第二輪 10000 筆，但從結果發現，所有的 DNS 請求都是走 NodeLocal DNSCache，因為外部 dns 不是 .cluster.local，所以就算沒有 KubeDNS 也能正常運作&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/6.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>分別在 19:52:28 跟 19:53:16 下指令調整&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/7.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/8.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會短暫卡住，但會直接切換到 KubeDNS 上繼續進行解析，因此以結果論，如果 NodeLocal DNSCache 有短暫異常，不會出現無法解析的問題
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache 正常運作，當我們在 19:52:28 調整後，變成 KubeDNS 起來開始處理解析，在 19:53:16 切換讓 NodeLocal DNSCache 恢復，後面又會變成由 NodeLocal DNSCache 來處理解析
&lt;br>
&lt;br>
紫色是 NodeLocal DNSCache，黃色是 KubeDNS&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>k6 測試&lt;span class="hx:absolute hx:-mt-20" id="k6-測試">&lt;/span>
&lt;a href="#k6-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>額外在另一個 cluster 建立 nginx deployment 開 5 個 pod 以及 svc 改成 lb (L4)，然後在 cloud dns 的 test-audit-com 設定 nginx-lb-internal.test-audit.com 解析到內網的 svc (10.156.17.230)&lt;/p>
&lt;br>
&lt;p>使用 k6 測試 KubeDNS + NodeLocal DNSCache 模式下 IP 跟 DNS 的差異&lt;/p>
&lt;p>相關程式可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>這邊測試的 Node 是用 e2-medium 而非 c3d-standard-4&lt;/p>
&lt;br>
&lt;h3>第一次測試&lt;span class="hx:absolute hx:-mt-20" id="第一次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%80%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=181.7ms / 3511 RPS)、DNS (avg=335.43ms / 2278 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/1.webp"
alt="IP 第一次測試" width="1000">&lt;figcaption>
&lt;p>IP 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/2.webp"
alt="DNS 第一次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第二次測試&lt;span class="hx:absolute hx:-mt-20" id="第二次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%ba%8c%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=336.98ms / 2272 RPS)、DNS (avg=503.79ms / 1640 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/3.webp"
alt="IP 第二次測試" width="1000">&lt;figcaption>
&lt;p>IP 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/4.webp"
alt="DNS 第二次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第三次測試&lt;span class="hx:absolute hx:-mt-20" id="第三次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%89%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=128.9ms / 4310 RPS)、DNS (avg=129.23ms / 4310 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/5.webp"
alt="IP 第三次測試" width="1000">&lt;figcaption>
&lt;p>IP 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/6.webp"
alt="DNS 第三次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第四次測試&lt;span class="hx:absolute hx:-mt-20" id="第四次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e5%9b%9b%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=149.5ms / 3965 RPS)、DNS (avg=133.73ms / 4230 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/7.webp"
alt="IP 第四次測試" width="1000">&lt;figcaption>
&lt;p>IP 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/8.webp"
alt="DNS 第四次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>理論上 ip 應該會比 dns 還要快，但測試 4 次發現其實不一定&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>結論&lt;span class="hx:absolute hx:-mt-20" id="結論">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>可以發現，使用 KubeDNS + NodeLocal DNSCache 的模式下，對於 KubeDNS 的依賴性降低了很多，因為 NodeLocal DNSCache 會先做 cache hit，這樣就算 KubeDNS 異常（只有 cluster 內的，且 cache 失效才會影響），否則不會影響到 pod 的 DNS 解析。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/nodelocal-dns-cache-diagram.webp"
alt="KubeDNS &amp;#43; NodeLocal DNSCache 流程圖
https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#architecture " width="650">&lt;figcaption>
&lt;p>KubeDNS + NodeLocal DNSCache 流程圖&lt;br>&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#architecture"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#architecture&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>由於官方流程圖有些細節沒有揭露的完成，我們有額外詢問 Google TAM，並畫出以下流程圖，Google TAM 也確認流程正確&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/nodelocal-dns-cache-flow.webp"
alt="自己重新畫的 GKE KubeDNS &amp;#43; NodeLocal DNSCache 流程圖" width="1200">&lt;figcaption>
&lt;p>自己重新畫的 GKE KubeDNS + NodeLocal DNSCache 流程圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>以下是我們與 Google 討論的內容：&lt;/p>
&lt;p>我們：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>MetaData Server 是否會快取外部DNS的解析結果？若會的話，是否 DNS Provider 改為 Cloud DNS才會有這個行爲發生？&lt;/p>
&lt;/li>
&lt;li>
&lt;p>公用的 Cloud DNS 是否有什麼統一的稱呼 (例：Common Cloud DNS…之類的)？或者就真的只叫 “Cloud DNS”？&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>Google：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>會快取並遵循 TTL，無論是否設定為 Cloud DNS，內外部的 DNS 解析都需要透過 Cloud DNS 查詢，只有是否先經過 kube-dns 的差異，因此快取無論開啟 Cloud DNS 都會有&lt;/p>
&lt;/li>
&lt;li>
&lt;p>就叫 Cloud DNS，或內部稱 GCE DNS&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>這是 K8s 官方的 NodeLocalDNS 流程圖：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/nodelocaldns.webp"
alt="Using NodeLocal DNSCache in Kubernetes Clusters
https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#architecture-diagram " width="600">&lt;figcaption>
&lt;p>Using NodeLocal DNSCache in Kubernetes Clusters&lt;br>&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#architecture-diagram"target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#architecture-diagram&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>另外也可以從官方文件中得知 KubeDNS + NodeLocal DNSCache 的 &lt;code>/etc/resolv.conf&lt;/code> 設定值，可以知道 Pod 最開始使用的 DNS 解析 Server 是誰。&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/resolv.webp"
alt="/etc/resolv.conf 設定值 服務探索和 DNS /etc/resolv.conf " width="800">&lt;figcaption>
&lt;p>/etc/resolv.conf 設定值 &lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/service-discovery?hl=zh-tw#conf_value"target="_blank" rel="noopener">服務探索和 DNS /etc/resolv.conf&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/config.webp"
alt="實際查看 /etc/resolv.conf" width="800">&lt;figcaption>
&lt;p>實際查看 /etc/resolv.conf&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>設定 NodeLocal DNSCache：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item></channel></rss>