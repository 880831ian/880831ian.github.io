<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – EC2</title><link>https://pin-yi.me/tags/ec2/</link><description>Recent content in EC2 on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Tue, 22 Jul 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://pin-yi.me/tags/ec2/index.xml" rel="self" type="application/rss+xml"/><item><title>AWS SSM 連線到 EC2、打通 RDS &amp; Elasticache &amp; MSK 到本機、使用 SCP 傳送檔案/拉取遠端檔案到本機</title><link>https://pin-yi.me/blog/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/</link><pubDate>Tue, 22 Jul 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/</guid><description>
&lt;p>AWS Systems Manager Agent (SSM Agent) 是 Amazon 軟體，在 Amazon Elastic Compute Cloud (Amazon EC2) 執行個體、邊緣裝置、內部部署伺服器和虛擬機器上執行&lt;/p>
&lt;br>
&lt;p>SSM 就跟 GCP 的 IAP 類似，可以直接連線到 EC2 內，不需要在使用 SSH 等方式連線，那使用 SSM 有幾個前提：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>需要先安裝 AWS CLI，以及相關的 configure 設定，詳細可以參考：
&lt;a href="../aws-sso-profile-introduce">AWS SSO Profile 設定介紹&lt;/a>、&lt;a href="../aws-assuming-roles-tool-introduce">手動切 AWS Profile 太麻煩？試試 Granted，多帳號管理神器助你效率倍增！&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>節點必須為受管節點，這表示機器上已安裝 SSM Agent，且代理程式可以與 Systems Manager 服務進行通訊。(大多數的 AMI 都有預先安裝 SSM Agnet，詳細可以參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/ami-preinstalled-agent.html"target="_blank" rel="noopener">尋找預先安裝了 SSM Agent的 AMIs - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> )&lt;/p>
&lt;/li>
&lt;li>
&lt;p>需要有對應的權限，這邊的權限有兩種：一個是操作的 IAM User，以及被連線的 EC2 IAM Role。操作的 IAM User 需要有 &lt;code>ssm:StartSession&lt;/code> 相關權限，EC2 IAM Role 則是需要被賦予 &lt;code>AmazonSSMManagedInstanceCore&lt;/code>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>電腦本機有需要安裝 Session Manager plugin，詳細安裝步驟請參考：&lt;a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html"target="_blank" rel="noopener">Install the Session Manager plugin on macOS - AWS Systems Manager &lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>(如果使用下方腳本，會自動檢查是否安裝，沒有也會自動安裝)，如果沒有裝此 plugin，就會出現權限錯誤提示 (&lt;code>because no identity-based policy allows the ssm:TerminateSession action&lt;/code>)。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>SSM 除了連線到 EC2 以外，還有其他的功能，可以透過 EC2 去連線 AWS 上的其他資源，例如：RDS 跟 Elasticache。在之後會建議都會透過 EC2 當作跳板機去連線，讓 RD 自行於本地選擇工具來操作，而不會直接將這些工具建立在線上服務。&lt;/p>
&lt;br>
&lt;ul>
&lt;li>連線到對應的 EC2 instances&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ul>
&lt;li>連線 EC2 後，進到 root / 目錄&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartInteractiveCommand&amp;#34;&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;command&amp;#34;:[&amp;#34;sudo -i;cd /&amp;#34;]}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ul>
&lt;li>透過 EC2 連線到 RDS or Elasticache or MSK&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ssm start-session &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --target &lt;span style="color:#e6db74">&amp;#34;i-0ad1b308da085aaa4&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartPortForwardingSessionToRemoteHost&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#34;{\&amp;#34;host\&amp;#34;:[\&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>host&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\&amp;#34;], \&amp;#34;portNumber\&amp;#34;:[\&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>service_port&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\&amp;#34;], \&amp;#34;localPortNumber\&amp;#34;:[\&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>local_port&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\&amp;#34;]}&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>${host}&lt;/code>：帶入 Elasticache Route53 private-dns 網址&lt;/p>
&lt;p>&lt;code>${service_port}&lt;/code>：如果是 RDS 預設是 3306，如果是 Elasticache 預設是 6379&lt;/p>
&lt;p>&lt;code>${local_port}&lt;/code>：本機使用的 Port，只要不衝突就可以使用，在使用自己習慣的工具去連線 &lt;code>127.0.0.1:${local_port}&lt;/code>&lt;/p>
&lt;br>
&lt;p>如果連線上有錯誤，可能會是對應的 RDS or Elasticache SG 沒有開給該跳板機&lt;/p>
&lt;p>MSK 由於其架構較為特殊，會額外安裝 kafka-proxy 來代理連線到叢集，詳細可以參考：&lt;a href="https://github.com/grepplabs/kafka-proxy"target="_blank" rel="noopener">GitHub - grepplabs/kafka-proxy: Proxy connections to Kafka cluster. Connect through SOCKS Proxy, HTTP Proxy or to cluster running in Kubernetes.&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>(建議使用下方腳本進行操作，下方腳本會連 SSM + kafka-proxy 都ㄧ併完成)&lt;/p>
&lt;br>
&lt;ul>
&lt;li>將本機檔案傳送到 EC2 / 從 EC2 複製檔案到本機&lt;/li>
&lt;/ul>
&lt;p>這個需求在傳大量檔案的時候會很方便，但由於 SSM 沒有自己的傳送檔案相關指令，所以我們統一使用 SCP 來傳送傳送檔案。&lt;/p>
&lt;p>使用 SCP 則會需要先設定 KEY 到 EC2 機器上，這樣會有點麻煩，因此參考 AWS 官方文件，我們會使用 &lt;code>aws ec2-instance-connect send-ssh-public-key&lt;/code> 指令來將 public-key 傳送到 EC2 上，可以快速的省下先 SSM 進去機器，設定好 KEY，也因為透過 &lt;code>send-ssh-public-key&lt;/code> 只有 60s，所以不會有 &lt;code>authorized_keys&lt;/code> 不好管理的問題，詳細說明可以參考：&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-aws-cli"target="_blank" rel="noopener">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-aws-cli&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>、&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html"target="_blank" rel="noopener">步驟 8：(選用) 透過 Session Manager 允許和控制 SSH 連線的許可 - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;ol>
&lt;li>需要額外新增以下的 SSH 設定檔，讓 SCP 可以透過 SSM 執行&lt;/li>
&lt;/ol>
&lt;p>SSH 組態檔案通常位於 ~/.ssh/config&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># SSH over Session Manager&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Host i-* mi-*
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ProxyCommand sh -c &lt;span style="color:#e6db74">&amp;#34;aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters &amp;#39;portNumber=%p&amp;#39;&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>(如果使用下方腳本，會自動檢查是否設定，沒有也會自動設定)&lt;/p>
&lt;br>
&lt;ol start="2">
&lt;li>建立 SSH 公私金鑰檔案，並調整權限&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>ssh-keygen -f ssm&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>(ssm 為範例，會產生 ssm 跟 ssm.pub)&lt;/p>
&lt;br>
&lt;ol start="3">
&lt;li>使用 &lt;code>send-ssh-public-key&lt;/code> 將 SSH 公鑰推到 &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html"target="_blank" rel="noopener">instance metadata&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，只會保留 60s，會需要 &lt;code>ec2-instance-connect:SendSSHPublicKey&lt;/code> 權限&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ec2-instance-connect send-ssh-public-key &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --region &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>region&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --availability-zone &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>zone&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --instance-id &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --instance-os-user root &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --ssh-public-key &lt;span style="color:#e6db74">&amp;#34;file://&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>ssh_pub_key&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --no-cli-pager&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>${region}&lt;/code>：EC2 機器的 Region&lt;/p>
&lt;p>&lt;code>${zone}&lt;/code>：EC2 機器的 zone&lt;/p>
&lt;p>&lt;code>${instance_id}&lt;/code>：傳送的 EC2 機器&lt;/p>
&lt;p>&lt;code>${ssh_pub_key}&lt;/code>：公鑰路徑，例如上面的 &lt;code>/Users/$(whoami)/.ssh/ssm.pub&lt;/code>&lt;/p>
&lt;br>
&lt;p>有回傳 Success: true 就代表成功，接著就可以嘗試下 SCP 指令將檔案傳給 EC2，或是從 EC2 複製檔案出來，這邊以 SCP 將檔案傳給 EC2 為例：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>scp -o &lt;span style="color:#e6db74">&amp;#34;IdentitiesOnly=yes&amp;#34;&lt;/span> -i &lt;span style="color:#e6db74">${&lt;/span>ssh_priv_key&lt;span style="color:#e6db74">}&lt;/span> &lt;span style="color:#e6db74">${&lt;/span>local_path&lt;span style="color:#e6db74">}&lt;/span> root@&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>:&lt;span style="color:#e6db74">${&lt;/span>remote_path&lt;span style="color:#e6db74">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>${ssh_priv_key}&lt;/code>：私鑰路徑，需要跟前面傳送給 EC2 是同一把&lt;/p>
&lt;p>&lt;code>${local_path}&lt;/code>：本地要傳送的檔案路徑&lt;/p>
&lt;p>&lt;code>${instance_id}&lt;/code>：傳送的 EC2 機器&lt;/p>
&lt;p>&lt;code>${remote_path}&lt;/code>：EC2 機器的檔案路徑&lt;/p>
&lt;br>
&lt;h2>執行腳本&lt;span class="hx:absolute hx:-mt-20" id="執行腳本">&lt;/span>
&lt;a href="#%e5%9f%b7%e8%a1%8c%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>為了方便大家快速執行，有將上面提到的指令寫成腳本，讓大家可以用選擇及輸入的方式來使用&lt;/p>
&lt;p>腳本連結：&lt;a href="https://github.com/880831ian/aws-ssm-ec2-rds-elasticacahe-msk-scp"target="_blank" rel="noopener">https://github.com/880831ian/aws-ssm-ec2-rds-elasticacahe-msk-scp&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/1.webp"
alt="腳本使用" width="450">&lt;figcaption>
&lt;p>腳本使用&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>MSK 比較特別，會額外安裝套件&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/2.webp"
alt="MSK 安裝詢問" width="1200">&lt;figcaption>
&lt;p>MSK 安裝詢問&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>輸入對應的 Broker 清單，會自動轉發&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/3.webp"
alt="轉發 Broker" width="1000">&lt;figcaption>
&lt;p>轉發 Broker&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>會跳出能在本機連線的 IP 以及 Port&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/4.webp"
alt="本機連線 IP" width="1000">&lt;figcaption>
&lt;p>本機連線 IP&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-aws-cli"target="_blank" rel="noopener">Connect to a Linux instance using EC2 Instance Connect&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html"target="_blank" rel="noopener">透過 Session Manager 允許和控制 SSH 連線的許可&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>在 AWS EC2 macOS 上安裝 Gitlab-Runner 注意事項</title><link>https://pin-yi.me/blog/aws/aws-ec2-macos-gitlab-runner/</link><pubDate>Tue, 25 Feb 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ec2-macos-gitlab-runner/</guid><description>
&lt;p>會寫此文章主要原因是公司會需要打包多個 IOS APP，之前是使用 github 來進行打包，但因為費用以及管理問題，所以想測試改用 AWS 的 EC2 macOS 來當作 Runner。&lt;/p>
&lt;br>
&lt;h2>建立 macOS Runner 機器&lt;span class="hx:absolute hx:-mt-20" id="建立-macos-runner-機器">&lt;/span>
&lt;a href="#%e5%bb%ba%e7%ab%8b-macos-runner-%e6%a9%9f%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>AWS 能夠建立 macOS 的 EC2 Instances，使用的 instance_type 會是 mac2.metal 或 mac1.metal，這兩種型號的差異可以參考 &lt;a href="https://aws.amazon.com/tw/ec2/instance-types/mac/"target="_blank" rel="noopener">AWS 官方文件&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，且會需要使用專用主機(Dedicated Hosts)，這個專用主機開下去，只能 24 小時後才可以關閉。&lt;/p>
&lt;p>IaC 上需要多設定 &lt;code>create_dedicated_host&lt;/code> 或 &lt;code>host_id&lt;/code>，下面說明兩個設定：&lt;/p>
&lt;p>&lt;code>create_dedicated_host&lt;/code>：如果是 macOS 才需打開此設定，會自動建立專用主機，自動把 host_id 帶入。&lt;/p>
&lt;p>&lt;code>host_id&lt;/code>：由於專用主機 24 小時內不能刪除，所以當刪除 macOS 的 EC2，有時候專用主機還會存在，這時候新的 EC2 可以直接把 host_id 帶入，就可以沿用，不需要額外再建立專用主機 (記得把 create_dedicated_host 關閉)。&lt;/p>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>&lt;/svg>說明&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>上面的 IaC 是我使用 Terraform 所寫的 EC2 module，後續會出文章來說明每一個 IaC 如何使用，到時候也會更新連結到這篇文章。&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>另外根據 instance_type 會需要選擇對應的 ami，例如：instance_type 是 mac2.metal，mac2.metal 是 arm 架構，就需要選擇 arm 的 ami，也要記得選對 OS 版本。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/1.webp"
alt="不同的 instance_type 需要選擇對應的 AMI" width="1000">&lt;figcaption>
&lt;p>不同的 instance_type 需要選擇對應的 AMI&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>macOS EC2 注意事項&lt;span class="hx:absolute hx:-mt-20" id="macos-ec2-注意事項">&lt;/span>
&lt;a href="#macos-ec2-%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a0%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>在測試的過程中，有發現一些 macOS EC2 的限制，提供給大家參加(有些上面有提到)：&lt;/p>
&lt;ol>
&lt;li>需要選擇 macOS 版本 (macOS Sequola、macOS Sonoma、macOS Ventura)&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/2.webp"
alt="有不同的 OS 版本可以選擇" width="700">&lt;figcaption>
&lt;p>有不同的 OS 版本可以選擇&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="2">
&lt;li>只有兩種機器規格可以選擇，分別是：
&lt;ul>
&lt;li>mac1.metal：12 vCPU、32 G MEM&lt;/li>
&lt;li>mac2.metal (ARM 架構)：8 vCPU、16 G MEM&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="3">
&lt;li>
&lt;p>建立需要用專用主機 (所以 IaC 需要有多選擇租賃類型、以及專用主機 ID)，建立專用主機後，mac 類型專用主機需要等 24小時後，才可以釋放&lt;/p>
&lt;/li>
&lt;li>
&lt;p>不能使用 Spot Instance&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/3.webp"
alt="會顯示無法使用 Spot VM" width="900">&lt;figcaption>
&lt;p>會顯示無法使用 Spot VM&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>
&lt;p>內建有 SSM，但建立完機器不能馬上連線，需要等約 5 分鐘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如果要建立 AMI 後，還需要使用機器，記得把重啟機器選項關掉，macOS 機器重啟會蠻久的&lt;/p>
&lt;/li>
&lt;li>
&lt;p>關機+destroy 需要約 10 分鐘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>測試建立 macOS 的 AMI 正常 (資料有保留)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>macOS 預設安裝的資料會佔用 9.6G 左右的 Disk 空間 (ami-09c1170ae6e30597d，規格：macOS Sonoma、mac2.metal)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/4.webp"
alt="預設的 Disk 使用情況" width="900">&lt;figcaption>
&lt;p>預設的 Disk 使用情況&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>安裝 Gitlab-Runner&lt;span class="hx:absolute hx:-mt-20" id="安裝-gitlab-runner">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%9d-gitlab-runner" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>需要切換到 ec2-user 內，並執行此腳本，記得要輸入大寫的單位名稱 (此為公司設計的命名規則，可以依照自己需求修改)&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 取得系統架構&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ARCH&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>uname -m&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 要求輸入符合格式的大寫單位名稱&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">while&lt;/span> true; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> read -p &lt;span style="color:#e6db74">&amp;#34;請輸入大寫的英文單位名稱: &amp;#34;&lt;/span> UNIT_NAME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$UNIT_NAME&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">=&lt;/span>~ ^&lt;span style="color:#f92672">[&lt;/span>A-Z&lt;span style="color:#f92672">]&lt;/span>+&lt;span style="color:#f92672">(&lt;/span>-&lt;span style="color:#f92672">[&lt;/span>A-Z&lt;span style="color:#f92672">]&lt;/span>+&lt;span style="color:#f92672">)&lt;/span>?$ &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> break
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;無效的單位名稱，請輸入符合格式的值\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 基本下載 URL&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>BASE_URL&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;https://s3.dualstack.us-east-1.amazonaws.com/gitlab-runner-downloads/latest/binaries/gitlab-runner-darwin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 根據架構選擇檔案名稱&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ARCH&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;arm64&amp;#34;&lt;/span> &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_NAME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;arm64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_NAME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> ! -f /usr/local/bin/gitlab-runner &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 下載並安裝&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;下載 GitLab Runner，架構：&lt;/span>$ARCH&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sudo curl --output /usr/local/bin/gitlab-runner &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>BASE_URL&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">-&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>FILE_NAME&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sudo chmod +x /usr/local/bin/gitlab-runner
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gitlab-runner register --non-interactive &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --name &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$UNIT_NAME&lt;span style="color:#e6db74">-MacOS-Runner&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --url &lt;span style="color:#e6db74">&amp;#34;&amp;lt;GitLab Domain&amp;gt;&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --registration-token &amp;lt;GitLab Token&amp;gt; &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --executor shell &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --tag-list &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$UNIT_NAME&lt;span style="color:#e6db74">-MacOS-Runner&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>完成後，請執行以下指令來執行 Runner，會將 Log 寫到 gitlab-runner.log&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gitlab-runner run &amp;gt; gitlab-runner.log 2&amp;gt;&amp;amp;&lt;span style="color:#ae81ff">1&lt;/span> &amp;amp;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>注意！不要使用 &lt;code>gitlab-runner start&lt;/code>，避免遇到 &lt;code>FATAL: Failed to start gitlab-runner: exit status 134&lt;/code> 錯誤&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/5.webp"
alt="使用 start 會噴 134 錯誤" width="900">&lt;figcaption>
&lt;p>使用 start 會噴 134 錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>這個問題官方文件也有說明，start 會需要 LaunchAgent，然後 LaunchAgent 需要先透過 GUI 登入才可以，官方文件：&lt;a href="https://docs.gitlab.com/runner/install/osx/#fatal-failed-to-start-gitlab-runner-exit-status-134-on-gitlab-runner-start-command"target="_blank" rel="noopener">Install GitLab Runner on macOS | GitLab Docs&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>透過 AWS SSM 連線至 macOS EC2 並啟用 VNC 遠端桌面 GUI</title><link>https://pin-yi.me/blog/aws/aws-ssm-macos-ec2-vnc-gui/</link><pubDate>Fri, 03 Jan 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ssm-macos-ec2-vnc-gui/</guid><description>
&lt;h2>名詞說明&lt;span class="hx:absolute hx:-mt-20" id="名詞說明">&lt;/span>
&lt;a href="#%e5%90%8d%e8%a9%9e%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>AWS：Amazon Web Services 亞馬遜的雲端服務&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SSM：AWS Systems Manager 可以透過 AWS 直接連上內部 VPC 的機器 (不需要在 public subnet)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>EC2：AWS 的虛擬雲端計算服務&lt;/p>
&lt;/li>
&lt;li>
&lt;p>VNC：Virtual Network Computing 遠端控制&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;h2>步驟&lt;span class="hx:absolute hx:-mt-20" id="步驟">&lt;/span>
&lt;a href="#%e6%ad%a5%e9%a9%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>
&lt;p>確定使用的 User 有 &lt;code>ssm:StartSession&lt;/code> 權限&lt;/p>
&lt;/li>
&lt;li>
&lt;p>確定要連線的 EC2 有 IAM Role 並被賦予 &lt;code>AmazonSSMManagedInstanceCore&lt;/code> 權限&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/1.webp"
alt="AmazonSSMManagedInstanceCore 權限" width="1000">&lt;figcaption>
&lt;p>AmazonSSMManagedInstanceCore 權限&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>
&lt;p>確定 EC2 上有安裝 SSM Agent，macOS 可以查看：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/ssm-agent-macos.html"target="_blank" rel="noopener">在 macOS 專用 EC2 執行個體使用 SSM Agent - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>接著我們等到 EC2 確定啟動完畢 (macOS 啟動到可以連線需要約 5 分鐘)，可以以下指令連線測試&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &amp;lt;instance-id&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>&amp;lt;instance-id&amp;gt;&lt;/code> 請帶上 EC2 的 instance id&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/2.webp"
alt="SSM 連線" width="900">&lt;figcaption>
&lt;p>SSM 連線&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>確認看看是否可以正常連線，可以下 &lt;code>sudo -i&lt;/code> 來切換成 root&lt;/p>
&lt;br>
&lt;ol start="5">
&lt;li>當我們確定可以透過 SSM 連上 EC2 後，接著我們要安裝並啟動 macOS 畫面共用，請安裝以下指令&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="6">
&lt;li>接著要透過 VNC 連線，需要指定 User，但我們沒辦法拿到 root 密碼，所以只能在建立一個帳號，或是使用預設的 ec2-user，這邊先使用預設帳號，並新增密碼&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo /usr/bin/dscl . -passwd /Users/ec2-user&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="7">
&lt;li>接著開啟新的一個 Terminal 下此指令，透過 SSM 將本機與 EC2 內部的 Port 做 Port forwarding&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ssm start-session &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --target &amp;lt;instance-id&amp;gt; &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartPortForwardingSession&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;portNumber&amp;#34;:[&amp;#34;5900&amp;#34;], &amp;#34;localPortNumber&amp;#34;:[&amp;#34;5900&amp;#34;]}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就會看到這個類似的畫面&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/3.webp"
alt="SSM Port Forwarding" width="750">&lt;figcaption>
&lt;p>SSM Port Forwarding&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="8">
&lt;li>開啟瀏覽器或是開啟 macOS 內建的螢幕共享，打上&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vnc://localhost:5900&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就可以看到此畫面囉&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/4.webp"
alt="VNC 連線到 macOS" width="800">&lt;figcaption>
&lt;p>VNC 連線到 macOS&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>備註&lt;span class="hx:absolute hx:-mt-20" id="備註">&lt;/span>
&lt;a href="#%e5%82%99%e8%a8%bb" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>假設是建立其他的 User (不是用 ec2-user)，在第一次連線時，還是需要先登入 ec2-user 才可以切換其他帳號&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>How can I access my Amazon EC2 macOS instance through a GUI?：&lt;a href="https://repost.aws/knowledge-center/ec2-mac-instance-gui-access"target="_blank" rel="noopener">Access an EC2 macOS instance through a GUI&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>AWS Systems Manager 使用 Port-Forwarding：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding"target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item></channel></rss>