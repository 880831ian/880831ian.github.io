<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – AWS</title><link>https://pin-yi.me/tags/aws/</link><description>Recent content in AWS on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Mon, 17 Nov 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://pin-yi.me/tags/aws/index.xml" rel="self" type="application/rss+xml"/><item><title>AWS SSM 連線到 EC2、打通 RDS &amp; Elasticache &amp; MSK 到本機、使用 SCP 傳送檔案/拉取遠端檔案到本機</title><link>https://pin-yi.me/blog/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/</link><pubDate>Tue, 22 Jul 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/</guid><description>
&lt;p>AWS Systems Manager Agent (SSM Agent) 是 Amazon 軟體，在 Amazon Elastic Compute Cloud (Amazon EC2) 執行個體、邊緣裝置、內部部署伺服器和虛擬機器上執行&lt;/p>
&lt;br>
&lt;p>SSM 就跟 GCP 的 IAP 類似，可以直接連線到 EC2 內，不需要在使用 SSH 等方式連線，那使用 SSM 有幾個前提：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>需要先安裝 AWS CLI，以及相關的 configure 設定，詳細可以參考：
&lt;a href="../aws-sso-profile-introduce">AWS SSO Profile 設定介紹&lt;/a>、&lt;a href="../aws-assuming-roles-tool-introduce">手動切 AWS Profile 太麻煩？試試 Granted，多帳號管理神器助你效率倍增！&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>節點必須為受管節點，這表示機器上已安裝 SSM Agent，且代理程式可以與 Systems Manager 服務進行通訊。(大多數的 AMI 都有預先安裝 SSM Agnet，詳細可以參考：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/ami-preinstalled-agent.html"target="_blank" rel="noopener">尋找預先安裝了 SSM Agent的 AMIs - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> )&lt;/p>
&lt;/li>
&lt;li>
&lt;p>需要有對應的權限，這邊的權限有兩種：一個是操作的 IAM User，以及被連線的 EC2 IAM Role。操作的 IAM User 需要有 &lt;code>ssm:StartSession&lt;/code> 相關權限，EC2 IAM Role 則是需要被賦予 &lt;code>AmazonSSMManagedInstanceCore&lt;/code>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>電腦本機有需要安裝 Session Manager plugin，詳細安裝步驟請參考：&lt;a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html"target="_blank" rel="noopener">Install the Session Manager plugin on macOS - AWS Systems Manager &lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>(如果使用下方腳本，會自動檢查是否安裝，沒有也會自動安裝)，如果沒有裝此 plugin，就會出現權限錯誤提示 (&lt;code>because no identity-based policy allows the ssm:TerminateSession action&lt;/code>)。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>SSM 除了連線到 EC2 以外，還有其他的功能，可以透過 EC2 去連線 AWS 上的其他資源，例如：RDS 跟 Elasticache。在之後會建議都會透過 EC2 當作跳板機去連線，讓 RD 自行於本地選擇工具來操作，而不會直接將這些工具建立在線上服務。&lt;/p>
&lt;br>
&lt;ul>
&lt;li>連線到對應的 EC2 instances&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ul>
&lt;li>連線 EC2 後，進到 root / 目錄&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartInteractiveCommand&amp;#34;&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;command&amp;#34;:[&amp;#34;sudo -i;cd /&amp;#34;]}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ul>
&lt;li>透過 EC2 連線到 RDS or Elasticache or MSK&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>aws ssm start-session &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --target &lt;span style="color:#e6db74">&amp;#34;i-0ad1b308da085aaa4&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartPortForwardingSessionToRemoteHost&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#34;{\&amp;#34;host\&amp;#34;:[\&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>host&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\&amp;#34;], \&amp;#34;portNumber\&amp;#34;:[\&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>service_port&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\&amp;#34;], \&amp;#34;localPortNumber\&amp;#34;:[\&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>local_port&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">\&amp;#34;]}&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>${host}&lt;/code>：帶入 Elasticache Route53 private-dns 網址&lt;/p>
&lt;p>&lt;code>${service_port}&lt;/code>：如果是 RDS 預設是 3306，如果是 Elasticache 預設是 6379&lt;/p>
&lt;p>&lt;code>${local_port}&lt;/code>：本機使用的 Port，只要不衝突就可以使用，在使用自己習慣的工具去連線 &lt;code>127.0.0.1:${local_port}&lt;/code>&lt;/p>
&lt;br>
&lt;p>如果連線上有錯誤，可能會是對應的 RDS or Elasticache SG 沒有開給該跳板機&lt;/p>
&lt;p>MSK 由於其架構較為特殊，會額外安裝 kafka-proxy 來代理連線到叢集，詳細可以參考：&lt;a href="https://github.com/grepplabs/kafka-proxy"target="_blank" rel="noopener">GitHub - grepplabs/kafka-proxy: Proxy connections to Kafka cluster. Connect through SOCKS Proxy, HTTP Proxy or to cluster running in Kubernetes.&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>(建議使用下方腳本進行操作，下方腳本會連 SSM + kafka-proxy 都ㄧ併完成)&lt;/p>
&lt;br>
&lt;ul>
&lt;li>將本機檔案傳送到 EC2 / 從 EC2 複製檔案到本機&lt;/li>
&lt;/ul>
&lt;p>這個需求在傳大量檔案的時候會很方便，但由於 SSM 沒有自己的傳送檔案相關指令，所以我們統一使用 SCP 來傳送傳送檔案。&lt;/p>
&lt;p>使用 SCP 則會需要先設定 KEY 到 EC2 機器上，這樣會有點麻煩，因此參考 AWS 官方文件，我們會使用 &lt;code>aws ec2-instance-connect send-ssh-public-key&lt;/code> 指令來將 public-key 傳送到 EC2 上，可以快速的省下先 SSM 進去機器，設定好 KEY，也因為透過 &lt;code>send-ssh-public-key&lt;/code> 只有 60s，所以不會有 &lt;code>authorized_keys&lt;/code> 不好管理的問題，詳細說明可以參考：&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-aws-cli"target="_blank" rel="noopener">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-aws-cli&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>、&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html"target="_blank" rel="noopener">步驟 8：(選用) 透過 Session Manager 允許和控制 SSH 連線的許可 - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;ol>
&lt;li>需要額外新增以下的 SSH 設定檔，讓 SCP 可以透過 SSM 執行&lt;/li>
&lt;/ol>
&lt;p>SSH 組態檔案通常位於 ~/.ssh/config&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># SSH over Session Manager&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Host i-* mi-*
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ProxyCommand sh -c &lt;span style="color:#e6db74">&amp;#34;aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters &amp;#39;portNumber=%p&amp;#39;&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>(如果使用下方腳本，會自動檢查是否設定，沒有也會自動設定)&lt;/p>
&lt;br>
&lt;ol start="2">
&lt;li>建立 SSH 公私金鑰檔案，並調整權限&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>ssh-keygen -f ssm&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>(ssm 為範例，會產生 ssm 跟 ssm.pub)&lt;/p>
&lt;br>
&lt;ol start="3">
&lt;li>使用 &lt;code>send-ssh-public-key&lt;/code> 將 SSH 公鑰推到 &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html"target="_blank" rel="noopener">instance metadata&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，只會保留 60s，會需要 &lt;code>ec2-instance-connect:SendSSHPublicKey&lt;/code> 權限&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ec2-instance-connect send-ssh-public-key &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --region &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>region&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --availability-zone &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>zone&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --instance-id &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --instance-os-user root &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --ssh-public-key &lt;span style="color:#e6db74">&amp;#34;file://&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>ssh_pub_key&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --no-cli-pager&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>${region}&lt;/code>：EC2 機器的 Region&lt;/p>
&lt;p>&lt;code>${zone}&lt;/code>：EC2 機器的 zone&lt;/p>
&lt;p>&lt;code>${instance_id}&lt;/code>：傳送的 EC2 機器&lt;/p>
&lt;p>&lt;code>${ssh_pub_key}&lt;/code>：公鑰路徑，例如上面的 &lt;code>/Users/$(whoami)/.ssh/ssm.pub&lt;/code>&lt;/p>
&lt;br>
&lt;p>有回傳 Success: true 就代表成功，接著就可以嘗試下 SCP 指令將檔案傳給 EC2，或是從 EC2 複製檔案出來，這邊以 SCP 將檔案傳給 EC2 為例：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>scp -o &lt;span style="color:#e6db74">&amp;#34;IdentitiesOnly=yes&amp;#34;&lt;/span> -i &lt;span style="color:#e6db74">${&lt;/span>ssh_priv_key&lt;span style="color:#e6db74">}&lt;/span> &lt;span style="color:#e6db74">${&lt;/span>local_path&lt;span style="color:#e6db74">}&lt;/span> root@&lt;span style="color:#e6db74">${&lt;/span>instance_id&lt;span style="color:#e6db74">}&lt;/span>:&lt;span style="color:#e6db74">${&lt;/span>remote_path&lt;span style="color:#e6db74">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>${ssh_priv_key}&lt;/code>：私鑰路徑，需要跟前面傳送給 EC2 是同一把&lt;/p>
&lt;p>&lt;code>${local_path}&lt;/code>：本地要傳送的檔案路徑&lt;/p>
&lt;p>&lt;code>${instance_id}&lt;/code>：傳送的 EC2 機器&lt;/p>
&lt;p>&lt;code>${remote_path}&lt;/code>：EC2 機器的檔案路徑&lt;/p>
&lt;br>
&lt;h2>執行腳本&lt;span class="hx:absolute hx:-mt-20" id="執行腳本">&lt;/span>
&lt;a href="#%e5%9f%b7%e8%a1%8c%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>為了方便大家快速執行，有將上面提到的指令寫成腳本，讓大家可以用選擇及輸入的方式來使用&lt;/p>
&lt;p>腳本連結：&lt;a href="https://github.com/880831ian/aws-ssm-ec2-rds-elasticacahe-msk-scp"target="_blank" rel="noopener">https://github.com/880831ian/aws-ssm-ec2-rds-elasticacahe-msk-scp&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/1.webp"
alt="腳本使用" width="450">&lt;figcaption>
&lt;p>腳本使用&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>MSK 比較特別，會額外安裝套件&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/2.webp"
alt="MSK 安裝詢問" width="1200">&lt;figcaption>
&lt;p>MSK 安裝詢問&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>輸入對應的 Broker 清單，會自動轉發&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/3.webp"
alt="轉發 Broker" width="1000">&lt;figcaption>
&lt;p>轉發 Broker&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>會跳出能在本機連線的 IP 以及 Port&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-ec2-rds-elasticacahe-msk-scp/4.webp"
alt="本機連線 IP" width="1000">&lt;figcaption>
&lt;p>本機連線 IP&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-aws-cli"target="_blank" rel="noopener">Connect to a Linux instance using EC2 Instance Connect&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html"target="_blank" rel="noopener">透過 Session Manager 允許和控制 SSH 連線的許可&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>跨不同 VPC 資源使用 EFS</title><link>https://pin-yi.me/blog/aws/aws-cross-vpc-efs/</link><pubDate>Thu, 27 Feb 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-cross-vpc-efs/</guid><description>
&lt;p>EFS 在設計上，Mount targets 只支援單一 VPC 的 Subnet 來連線，有研究一下，如果有情境需要跨 VPC 使用同一座 EFS 需要怎麼調整設定。&lt;/p>
&lt;br>
&lt;p>首先，EFS 會自己建立一條 route53 的 private dns domain 會像 (以 ap-southeast-1 區域為例)：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>fs-xxxxx.efs.ap-southeast-1.amazonaws.com&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>開頭有說，EFS 只支援單一 VPC，所以該 EFS 產生的 Domain 只有設定的 VPC 才可以使用 (就算透過 VPC Peering 都不行)，也沒辦法另外去調整 EFS 建立的 DNS Domain，因此我們需要額外再建立一條 route53 internal-dns 來使用&lt;/p>
&lt;p>新的一條 route53 internal-dns domain，需要用 A Record 解析到 EFS 的 Network interfaces IP Address 上&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cross-vpc-efs/1.webp"
alt="EFS 的 IP" width="1200">&lt;figcaption>
&lt;p>EFS 的 IP&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-cross-vpc-efs/2.webp"
alt="internal dns 設定新的 EFS Domain，並指向 EFS 的 Network interfaces IP" width="1200">&lt;figcaption>
&lt;p>internal dns 設定新的 EFS Domain，並指向 EFS 的 Network interfaces IP&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>將需要使用的 VPC 都加到該 route53 internal-dns 內，接著回到 EFS，將對應的 Subnet 都設定到 SG，開啟對應 Subnet 的 2049 Port&lt;/p>
&lt;br>
&lt;p>最後再建立 PV 時，除了原本的設定&lt;/p>
&lt;ul>
&lt;li>原設定&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code> csi:
driver: efs.csi.aws.com
volumeHandle: fs-xxxxxx # 替換為你的 EFS ID&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>還需要加上&lt;/p>
&lt;ul>
&lt;li>新設定&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code> csi:
driver: efs.csi.aws.com
volumeHandle: fs-xxxxxx # 替換為你的 EFS ID
volumeAttributes:
mounttargetip: &amp;lt;自訂的 route53-internal-dns domain&amp;gt;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>就可以正常使用囉，文件可以參考：&lt;a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver/blob/master/examples/kubernetes/static_provisioning/README.md"target="_blank" rel="noopener">aws-efs-csi-driver/examples/kubernetes/static_provisioning/README.md at master · kubernetes-sigs/aws-efs-csi-driver&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>在 AWS EC2 macOS 上安裝 Gitlab-Runner 注意事項</title><link>https://pin-yi.me/blog/aws/aws-ec2-macos-gitlab-runner/</link><pubDate>Tue, 25 Feb 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ec2-macos-gitlab-runner/</guid><description>
&lt;p>會寫此文章主要原因是公司會需要打包多個 IOS APP，之前是使用 github 來進行打包，但因為費用以及管理問題，所以想測試改用 AWS 的 EC2 macOS 來當作 Runner。&lt;/p>
&lt;br>
&lt;h2>建立 macOS Runner 機器&lt;span class="hx:absolute hx:-mt-20" id="建立-macos-runner-機器">&lt;/span>
&lt;a href="#%e5%bb%ba%e7%ab%8b-macos-runner-%e6%a9%9f%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>AWS 能夠建立 macOS 的 EC2 Instances，使用的 instance_type 會是 mac2.metal 或 mac1.metal，這兩種型號的差異可以參考 &lt;a href="https://aws.amazon.com/tw/ec2/instance-types/mac/"target="_blank" rel="noopener">AWS 官方文件&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，且會需要使用專用主機(Dedicated Hosts)，這個專用主機開下去，只能 24 小時後才可以關閉。&lt;/p>
&lt;p>IaC 上需要多設定 &lt;code>create_dedicated_host&lt;/code> 或 &lt;code>host_id&lt;/code>，下面說明兩個設定：&lt;/p>
&lt;p>&lt;code>create_dedicated_host&lt;/code>：如果是 macOS 才需打開此設定，會自動建立專用主機，自動把 host_id 帶入。&lt;/p>
&lt;p>&lt;code>host_id&lt;/code>：由於專用主機 24 小時內不能刪除，所以當刪除 macOS 的 EC2，有時候專用主機還會存在，這時候新的 EC2 可以直接把 host_id 帶入，就可以沿用，不需要額外再建立專用主機 (記得把 create_dedicated_host 關閉)。&lt;/p>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>&lt;/svg>說明&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>上面的 IaC 是我使用 Terraform 所寫的 EC2 module，後續會出文章來說明每一個 IaC 如何使用，到時候也會更新連結到這篇文章。&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>另外根據 instance_type 會需要選擇對應的 ami，例如：instance_type 是 mac2.metal，mac2.metal 是 arm 架構，就需要選擇 arm 的 ami，也要記得選對 OS 版本。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/1.webp"
alt="不同的 instance_type 需要選擇對應的 AMI" width="1000">&lt;figcaption>
&lt;p>不同的 instance_type 需要選擇對應的 AMI&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>macOS EC2 注意事項&lt;span class="hx:absolute hx:-mt-20" id="macos-ec2-注意事項">&lt;/span>
&lt;a href="#macos-ec2-%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a0%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>在測試的過程中，有發現一些 macOS EC2 的限制，提供給大家參加(有些上面有提到)：&lt;/p>
&lt;ol>
&lt;li>需要選擇 macOS 版本 (macOS Sequola、macOS Sonoma、macOS Ventura)&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/2.webp"
alt="有不同的 OS 版本可以選擇" width="700">&lt;figcaption>
&lt;p>有不同的 OS 版本可以選擇&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="2">
&lt;li>只有兩種機器規格可以選擇，分別是：
&lt;ul>
&lt;li>mac1.metal：12 vCPU、32 G MEM&lt;/li>
&lt;li>mac2.metal (ARM 架構)：8 vCPU、16 G MEM&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="3">
&lt;li>
&lt;p>建立需要用專用主機 (所以 IaC 需要有多選擇租賃類型、以及專用主機 ID)，建立專用主機後，mac 類型專用主機需要等 24小時後，才可以釋放&lt;/p>
&lt;/li>
&lt;li>
&lt;p>不能使用 Spot Instance&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/3.webp"
alt="會顯示無法使用 Spot VM" width="900">&lt;figcaption>
&lt;p>會顯示無法使用 Spot VM&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>
&lt;p>內建有 SSM，但建立完機器不能馬上連線，需要等約 5 分鐘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如果要建立 AMI 後，還需要使用機器，記得把重啟機器選項關掉，macOS 機器重啟會蠻久的&lt;/p>
&lt;/li>
&lt;li>
&lt;p>關機+destroy 需要約 10 分鐘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>測試建立 macOS 的 AMI 正常 (資料有保留)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>macOS 預設安裝的資料會佔用 9.6G 左右的 Disk 空間 (ami-09c1170ae6e30597d，規格：macOS Sonoma、mac2.metal)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/4.webp"
alt="預設的 Disk 使用情況" width="900">&lt;figcaption>
&lt;p>預設的 Disk 使用情況&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>安裝 Gitlab-Runner&lt;span class="hx:absolute hx:-mt-20" id="安裝-gitlab-runner">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%9d-gitlab-runner" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>需要切換到 ec2-user 內，並執行此腳本，記得要輸入大寫的單位名稱 (此為公司設計的命名規則，可以依照自己需求修改)&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 取得系統架構&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ARCH&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>uname -m&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 要求輸入符合格式的大寫單位名稱&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">while&lt;/span> true; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> read -p &lt;span style="color:#e6db74">&amp;#34;請輸入大寫的英文單位名稱: &amp;#34;&lt;/span> UNIT_NAME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$UNIT_NAME&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">=&lt;/span>~ ^&lt;span style="color:#f92672">[&lt;/span>A-Z&lt;span style="color:#f92672">]&lt;/span>+&lt;span style="color:#f92672">(&lt;/span>-&lt;span style="color:#f92672">[&lt;/span>A-Z&lt;span style="color:#f92672">]&lt;/span>+&lt;span style="color:#f92672">)&lt;/span>?$ &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> break
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo -e &lt;span style="color:#e6db74">&amp;#34;無效的單位名稱，請輸入符合格式的值\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 基本下載 URL&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>BASE_URL&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;https://s3.dualstack.us-east-1.amazonaws.com/gitlab-runner-downloads/latest/binaries/gitlab-runner-darwin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 根據架構選擇檔案名稱&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ARCH&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;arm64&amp;#34;&lt;/span> &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_NAME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;arm64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE_NAME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[&lt;/span> ! -f /usr/local/bin/gitlab-runner &lt;span style="color:#f92672">]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 下載並安裝&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;下載 GitLab Runner，架構：&lt;/span>$ARCH&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sudo curl --output /usr/local/bin/gitlab-runner &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>BASE_URL&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">-&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>FILE_NAME&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sudo chmod +x /usr/local/bin/gitlab-runner
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gitlab-runner register --non-interactive &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --name &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$UNIT_NAME&lt;span style="color:#e6db74">-MacOS-Runner&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --url &lt;span style="color:#e6db74">&amp;#34;&amp;lt;GitLab Domain&amp;gt;&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --registration-token &amp;lt;GitLab Token&amp;gt; &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --executor shell &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --tag-list &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$UNIT_NAME&lt;span style="color:#e6db74">-MacOS-Runner&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>完成後，請執行以下指令來執行 Runner，會將 Log 寫到 gitlab-runner.log&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gitlab-runner run &amp;gt; gitlab-runner.log 2&amp;gt;&amp;amp;&lt;span style="color:#ae81ff">1&lt;/span> &amp;amp;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>注意！不要使用 &lt;code>gitlab-runner start&lt;/code>，避免遇到 &lt;code>FATAL: Failed to start gitlab-runner: exit status 134&lt;/code> 錯誤&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ec2-macos-gitlab-runner/5.webp"
alt="使用 start 會噴 134 錯誤" width="900">&lt;figcaption>
&lt;p>使用 start 會噴 134 錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>這個問題官方文件也有說明，start 會需要 LaunchAgent，然後 LaunchAgent 需要先透過 GUI 登入才可以，官方文件：&lt;a href="https://docs.gitlab.com/runner/install/osx/#fatal-failed-to-start-gitlab-runner-exit-status-134-on-gitlab-runner-start-command"target="_blank" rel="noopener">Install GitLab Runner on macOS | GitLab Docs&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>透過 AWS SSM 連線至 macOS EC2 並啟用 VNC 遠端桌面 GUI</title><link>https://pin-yi.me/blog/aws/aws-ssm-macos-ec2-vnc-gui/</link><pubDate>Fri, 03 Jan 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/aws/aws-ssm-macos-ec2-vnc-gui/</guid><description>
&lt;h2>名詞說明&lt;span class="hx:absolute hx:-mt-20" id="名詞說明">&lt;/span>
&lt;a href="#%e5%90%8d%e8%a9%9e%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>AWS：Amazon Web Services 亞馬遜的雲端服務&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SSM：AWS Systems Manager 可以透過 AWS 直接連上內部 VPC 的機器 (不需要在 public subnet)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>EC2：AWS 的虛擬雲端計算服務&lt;/p>
&lt;/li>
&lt;li>
&lt;p>VNC：Virtual Network Computing 遠端控制&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;h2>步驟&lt;span class="hx:absolute hx:-mt-20" id="步驟">&lt;/span>
&lt;a href="#%e6%ad%a5%e9%a9%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>
&lt;p>確定使用的 User 有 &lt;code>ssm:StartSession&lt;/code> 權限&lt;/p>
&lt;/li>
&lt;li>
&lt;p>確定要連線的 EC2 有 IAM Role 並被賦予 &lt;code>AmazonSSMManagedInstanceCore&lt;/code> 權限&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/1.webp"
alt="AmazonSSMManagedInstanceCore 權限" width="1000">&lt;figcaption>
&lt;p>AmazonSSMManagedInstanceCore 權限&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>
&lt;p>確定 EC2 上有安裝 SSM Agent，macOS 可以查看：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/ssm-agent-macos.html"target="_blank" rel="noopener">在 macOS 專用 EC2 執行個體使用 SSM Agent - AWS Systems Manager&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>接著我們等到 EC2 確定啟動完畢 (macOS 啟動到可以連線需要約 5 分鐘)，可以以下指令連線測試&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ssm start-session --target &amp;lt;instance-id&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>&amp;lt;instance-id&amp;gt;&lt;/code> 請帶上 EC2 的 instance id&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/2.webp"
alt="SSM 連線" width="900">&lt;figcaption>
&lt;p>SSM 連線&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>確認看看是否可以正常連線，可以下 &lt;code>sudo -i&lt;/code> 來切換成 root&lt;/p>
&lt;br>
&lt;ol start="5">
&lt;li>當我們確定可以透過 SSM 連上 EC2 後，接著我們要安裝並啟動 macOS 畫面共用，請安裝以下指令&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="6">
&lt;li>接著要透過 VNC 連線，需要指定 User，但我們沒辦法拿到 root 密碼，所以只能在建立一個帳號，或是使用預設的 ec2-user，這邊先使用預設帳號，並新增密碼&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo /usr/bin/dscl . -passwd /Users/ec2-user&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="7">
&lt;li>接著開啟新的一個 Terminal 下此指令，透過 SSM 將本機與 EC2 內部的 Port 做 Port forwarding&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>aws ssm start-session &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --target &amp;lt;instance-id&amp;gt; &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --document-name &lt;span style="color:#e6db74">&amp;#34;AWS-StartPortForwardingSession&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --parameters &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;portNumber&amp;#34;:[&amp;#34;5900&amp;#34;], &amp;#34;localPortNumber&amp;#34;:[&amp;#34;5900&amp;#34;]}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就會看到這個類似的畫面&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/3.webp"
alt="SSM Port Forwarding" width="750">&lt;figcaption>
&lt;p>SSM Port Forwarding&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="8">
&lt;li>開啟瀏覽器或是開啟 macOS 內建的螢幕共享，打上&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vnc://localhost:5900&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就可以看到此畫面囉&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/aws/aws-ssm-macos-ec2-vnc-gui/4.webp"
alt="VNC 連線到 macOS" width="800">&lt;figcaption>
&lt;p>VNC 連線到 macOS&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>備註&lt;span class="hx:absolute hx:-mt-20" id="備註">&lt;/span>
&lt;a href="#%e5%82%99%e8%a8%bb" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>假設是建立其他的 User (不是用 ec2-user)，在第一次連線時，還是需要先登入 ec2-user 才可以切換其他帳號&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>How can I access my Amazon EC2 macOS instance through a GUI?：&lt;a href="https://repost.aws/knowledge-center/ec2-mac-instance-gui-access"target="_blank" rel="noopener">Access an EC2 macOS instance through a GUI&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>AWS Systems Manager 使用 Port-Forwarding：&lt;a href="https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding"target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_tw/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html#sessions-start-port-forwarding&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>統一機密、身份與加密的管理系統 - HashiCorp Vault 介紹與說明</title><link>https://pin-yi.me/blog/security/vault-introduce/</link><pubDate>Mon, 17 Nov 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/security/vault-introduce/</guid><description>
&lt;p>我們在現代的開發或是雲端管理，會有很多的 API 金鑰、Token、密碼、憑證 讓服務或是資源來去做驗證與授權，但有什麼工具能夠更好的存放這些金鑰呢？因此有了今天想要學習研究的主題 - HashiCorp Vault&lt;/p>
&lt;br>
&lt;p>學習一個東西最快的方式，就我而言就是先看影片 😆
這邊附上我一開始學習的參考影片 &lt;a href="https://www.youtube.com/watch?v=YU_rQz8emoE"target="_blank" rel="noopener">HashiCorp Vault on AWS &amp;amp; K8s - 雲端地端通吃的私鑰管理平台 【Webinar： HashiCorp Vault】| 歐立威科技&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>可以先透過影片了解 Vault 的功用，他是怎麼去做驗證，以及他怎麼儲存資料，或是後面需要怎麼監控以及備份等初步的介紹，那看完影片後，我們就可以來看官方的介紹&lt;/p>
&lt;br>
&lt;h2>什麼是 Vault&lt;span class="hx:absolute hx:-mt-20" id="什麼是-vault">&lt;/span>
&lt;a href="#%e4%bb%80%e9%ba%bc%e6%98%af-vault" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Vault 官網介紹：（以下機翻）&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Vault 是一個基於身分的金鑰和加密管理系統，它集中管理金鑰，輪換舊憑證，按照需求產生憑證，稽核客戶端的交互行為，並支援監管合規性。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>它提供加密服務，並透過身份驗證和授權方法進行控制，以確保對機密資訊的安全、可稽核和受限存取。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>金鑰是指任何需要嚴格控制存取權限的訊息，例如令牌、API 金鑰、密碼、加密金鑰或憑證。 Vault 提供了一個統一的金鑰管理介面，同時提供嚴格的存取控制並記錄詳細的稽核日誌。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Vault 會在向客戶端（使用者、機器、應用程式）提供對金鑰或儲存的敏感資料的存取權之前，對其進行驗證和授權。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2">&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>&lt;/div>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">白話文就是：Vault 可以統一金鑰管理以及身份驗證(包含與機器、使用者、應用程式)，設計不同的路徑 Policy，並且有稽核紀錄跟監控的管理系統&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/how-vault-works.webp"
alt="Vault 的概述介紹圖" width="800">&lt;figcaption>
&lt;p>Vault 的概述介紹圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>工作原理&lt;span class="hx:absolute hx:-mt-20" id="工作原理">&lt;/span>
&lt;a href="#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Vault 的核心工作流程有四個階段：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Authenticate (身份驗證)：客戶端提供訊息，Vault 會使用這些資訊來確認客戶端是否與其聲稱的身份一致，驗證過後，系統會產生一個 Token 並將其與 Policy 關聯 (Policy 後面會提到)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Validation (驗證)：Vault 會根據第三方可信任來源驗證客戶端，例如：AWS、GCP、K8s、Github、LDAP 等&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Authorize (授權)：Vault 會將客戶端與 Vault 安全性原則進行比對。定義客戶端可以使用哪些 Valut Token 存取哪些 API Endpoint。提供一種聲明式的方式來授予或是禁止對 Vault 特定路徑的操作權限&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Access (存取權限)：Vault 透過與客戶端身份關聯的 Policy 頒發 Token 並授予對金鑰、機密資訊和加密功能的存取權限&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/vault-workflow-diagram.webp"
alt="Vault 的概述介紹圖" width="600">&lt;figcaption>
&lt;p>Vault 的概述介紹圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>安裝 Valut&lt;span class="hx:absolute hx:-mt-20" id="安裝-valut">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%9d-valut" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>我們大概知道 Vault 它的用途，那接下來當然就是安裝起來玩玩看&lt;/p>
&lt;p>可以使用以下指令安裝 Vault：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>brew tap hashicorp/tap
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>brew install hashicorp/tap/vault&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>其他作業系統可以參考此篇文件：&lt;a href="https://developer.hashicorp.com/vault/install"target="_blank" rel="noopener">https://developer.hashicorp.com/vault/install&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;h2>使用 Dev 開發模式來測試 Valut&lt;span class="hx:absolute hx:-mt-20" id="使用-dev-開發模式來測試-valut">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-dev-%e9%96%8b%e7%99%bc%e6%a8%a1%e5%bc%8f%e4%be%86%e6%b8%ac%e8%a9%a6-valut" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>由於我們還不熟悉 Vault 元件，所以我們先用 DEV 模式來測試以下內容：&lt;/p>
&lt;p>(這邊會以維運角度來說明，如果開發者請查閱&lt;a href="https://developer.hashicorp.com/vault/docs/get-started/developer-qs"target="_blank" rel="noopener">開發者快速入門&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，來讀取相關 Vault secret)&lt;/p>
&lt;ul>
&lt;li>&lt;a href="#%e5%95%9f%e5%8b%95-dev-vault">啟動 DEV Vault&lt;/a>&lt;/li>
&lt;li>&lt;a href="#%e5%95%9f%e7%94%a8%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%8f%92%e4%bb%b6">啟用身份驗證插件&lt;/a>&lt;/li>
&lt;li>&lt;a href="#%e5%95%9f%e7%94%a8%e9%8d%b5%e5%80%bc%e5%af%86%e9%91%b0%e6%8f%92%e4%bb%b6kv">啟用鍵/值密鑰插件(KV)&lt;/a>&lt;/li>
&lt;li>&lt;a href="#%e5%84%b2%e5%ad%98%e7%ac%ac%e4%b8%80%e5%80%8b%e6%a9%9f%e5%af%86">儲存第一個機密&lt;/a>&lt;/li>
&lt;li>&lt;a href="#%e8%a8%ad%e8%a8%88%e4%bf%9d%e8%ad%b7%e6%a9%9f%e5%af%86%e8%b3%87%e8%a8%8a%e7%9a%84-policy">設計保護機密資訊的 Policy&lt;/a>&lt;/li>
&lt;li>&lt;a href="#%e6%b8%ac%e8%a9%a6%e5%8f%8a%e9%a9%97%e8%ad%89-policy">測試及驗證 Policy&lt;/a>&lt;/li>
&lt;/ul>
&lt;br>
&lt;h3>啟動 DEV Vault&lt;span class="hx:absolute hx:-mt-20" id="啟動-dev-vault">&lt;/span>
&lt;a href="#%e5%95%9f%e5%8b%95-dev-vault" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>安裝好 Vault 後，我們可以在本機啟動 Vault 來測試 (當然 Vault 之後正式環境不會在本機執行，這個我們之後再說)，啟動指令可以參考：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault server -dev&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>或是你想要自定義 root token 的 ID 就可以多帶 &lt;code>-dev-root-token-id=&amp;quot;xxxx&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;p>啟動後，可以發現跑了一堆東西&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/1.webp"
alt="啟動 Vault" width="700">&lt;figcaption>
&lt;p>啟動 Vault&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>最後有一個 WARNING 提示，告訴我們現在啟用的是開發者模式，且這個模式下 Vault 都運行在記憶體中，並用單一解封金鑰且自動幫我們解封，Root Token 會在 CLI 自動完成驗證&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/2.webp"
alt="Vault DEV 環境提示" width="800">&lt;figcaption>
&lt;p>Vault DEV 環境提示&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>那這邊有提到解封還有解封金鑰，我們後面會提到，所以這邊先跳過，大家先知道有這個東西就可以了，在上面圖片裡面也有所謂的解封金鑰 &lt;code>L7+kfL/Of/MW846XMFL7riPX5oyoW1SwZVk9T++i8A0=&lt;/code>，以及 Root Token &lt;code>hvs.cCF4zQJ4bRwYEzouk621CFJr&lt;/code>&lt;/p>
&lt;br>
&lt;p>我們接下來要連線到該 Vault Server，先另開一個新的 Terminal，然後下 &lt;code>export VAULT_ADDR='http://127.0.0.1:8200'&lt;/code> 指定好 Vault Server Address，再使用以下指令登入 Valut&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault login hvs.cCF4zQJ4bRwYEzouk621CFJr&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>後面就直接帶入 Root Token，如果不想要 export VAULT_ADDR，也可以在後面帶入 &lt;code>-address=&lt;/code> 參數&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/3.webp"
alt="登入成功" width="650">&lt;figcaption>
&lt;p>登入成功&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以發現登入後，他會幫我們寫入 Token 到本機的 &lt;code>$HOME/.vault-token&lt;/code>，所以後續操作才不需要重複登入，也這個建議只在開發環境使用，不然還是會有資安疑慮&lt;/p>
&lt;br>
&lt;p>另外 vault 也有 UI 可以使用，可以訪問 &lt;code>http://127.0.0.1:8200/ui&lt;/code>，選擇 Token 並帶入剛剛的 Root Token 即可登入，那我們後續說明基本上都會以 CLI 方式來說明，大家可以搭配 UI 來輔助查看設定內容&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/4.webp"
alt="Vault UI 介面" width="1000">&lt;figcaption>
&lt;p>Vault UI 介面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;br>
&lt;h3>啟用身份驗證插件&lt;span class="hx:absolute hx:-mt-20" id="啟用身份驗證插件">&lt;/span>
&lt;a href="#%e5%95%9f%e7%94%a8%e8%ba%ab%e4%bb%bd%e9%a9%97%e8%ad%89%e6%8f%92%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>那在 Vault 裡面支援了很多種的身份驗證機制，它控制使用者 / 工作機器對 Vault 的存取權限，例如 AppRole、GCP、AWS、GitHub 等等，詳細可以看：&lt;a href="https://developer.hashicorp.com/vault/docs/auth"target="_blank" rel="noopener">Auth methods&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>那上面每一種方法都需要被啟用才可以使用，那我們這邊先以最簡單的方式來驗證，也就是 username + password (userpass)，啟動指令：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault auth enable userpass&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/5.webp"
alt="啟動 auth methods userpass" width="800">&lt;figcaption>
&lt;p>啟動 auth methods userpass&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>啟動完成後，我們馬上來建立一個名為 pin-yi 的 User，密碼為 &lt;code>123qwe&lt;/code>，使用以下指令建立：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault write auth/userpass/users/pin-yi password&lt;span style="color:#f92672">=&lt;/span>123qwe&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>也可以建立一個給機器或應用程式用戶端的 approle 驗證方法，使用以下指令啟動及建立：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault auth enable approle
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault write auth/approle/role/demo-app-role &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> secret_id_ttl&lt;span style="color:#f92672">=&lt;/span>10m &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> token_ttl&lt;span style="color:#f92672">=&lt;/span>20m &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> token_max_ttl&lt;span style="color:#f92672">=&lt;/span>30m&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>
&lt;p>secret_id_ttl：定義 SecretID 的存活時間。超過時間後該 SecretID 作廢，不能再用於換取 Token。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>token_ttl：定義以此 Role 生成的 Token 的初始有效時間。Token 在到期前若未續租即失效。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>token_max_ttl：定義 Token 能被續租的最長總生存時間。即便不斷續租，只要超過此上限，Token 必定失效。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/6.webp"
alt="建立 userpass user &amp;amp; 啟動 approle 及建立 demo-app-role" width="800">&lt;figcaption>
&lt;p>建立 userpass user &amp;amp; 啟動 approle 及建立 demo-app-role&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>啟用鍵/值密鑰插件(KV)&lt;span class="hx:absolute hx:-mt-20" id="啟用鍵值密鑰插件kv">&lt;/span>
&lt;a href="#%e5%95%9f%e7%94%a8%e9%8d%b5%e5%80%bc%e5%af%86%e9%91%b0%e6%8f%92%e4%bb%b6kv" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>在 Vault 支援很多&lt;a href="https://developer.hashicorp.com/vault/docs/secrets"target="_blank" rel="noopener">密鑰引擎&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，例如：Key Vaule (KV)、PKI (Certificates)、LDAP、GCP、AWS、SSH 等，依照需求選用對應的引擎來管理機密&lt;/p>
&lt;p>那我們現在使用 Key/Vaule (KV) 來測試，使用以下指令啟動該插件：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault secrets enable -path demo -version &lt;span style="color:#ae81ff">2&lt;/span> kv&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>path 可以指定儲存的路徑(用來設計區分)&lt;/li>
&lt;li>version 在 KV 有版本 1 跟 2&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/7.webp"
alt="UI 顯示建立好的 secrets 使用 kv version 2 引擎" width="800">&lt;figcaption>
&lt;p>UI 顯示建立好的 secrets 使用 kv version 2 引擎&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>儲存第一個機密&lt;span class="hx:absolute hx:-mt-20" id="儲存第一個機密">&lt;/span>
&lt;a href="#%e5%84%b2%e5%ad%98%e7%ac%ac%e4%b8%80%e5%80%8b%e6%a9%9f%e5%af%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>我們已經有儲存機密的地方，路徑是 demo，那接下來我們就來儲存我們第一個機密吧，使用以下指令：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault kv put &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -mount demo &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> kv/uuid &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> id&lt;span style="color:#f92672">=&lt;/span>1998c2d4-f0d8-465e-8a46-db6d3607e72e id&lt;span style="color:#f92672">=&lt;/span>34d1802b-5adb-459c-bb3a-2f094084a6d1&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>儲存完後，會顯示它儲存在哪一個路徑，以及相關的資訊，結果不小心手滑，多儲存了幾次，剛好可以觀察一下他的版本控制 😗&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/8.webp"
alt="可以觀察 Version 數字不同" width="650">&lt;figcaption>
&lt;p>可以觀察 Version 數字不同&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/9.webp"
alt="使用 UI 到對應路徑查看儲存的 Secret" width="800">&lt;figcaption>
&lt;p>使用 UI 到對應路徑查看儲存的 Secret&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>除此指外，我們再額外寫一個 api-keys 的機密，等等會使用到&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault kv put &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -mount demo &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> kv/api-keys &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> api_key&lt;span style="color:#f92672">=&lt;/span>9f3b12c7d84a4e0aab6e2d914f52c19d&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>設計保護機密資訊的 Policy&lt;span class="hx:absolute hx:-mt-20" id="設計保護機密資訊的-policy">&lt;/span>
&lt;a href="#%e8%a8%ad%e8%a8%88%e4%bf%9d%e8%ad%b7%e6%a9%9f%e5%af%86%e8%b3%87%e8%a8%8a%e7%9a%84-policy" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>我們已經快完成初步的流程了，我們有能夠登入 Vault 的 Token，也用 userpass 建立了 pin-yi 以及 approle 的 demo-app-role，也新增了兩個機密，那我們現在就剩下要寫 Policy 來定義：這個路徑的權限是什麼，最後掛到對應的 auth 上面&lt;/p>
&lt;p>首先，我們先用以下指令來建立，對了，目前只是為了更方便的測試跟學習，所以都使用 CLI，但在實際使用，強烈推薦使用 Terraform 等 IaC 工具來整理這些內容，並搭配 git flow 來完成更新 Vaule 的設定以及操作&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault policy write kv-access-policy - &lt;span style="color:#e6db74">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">path &amp;#34;demo/data/kv/uuid&amp;#34; {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> capabilities = [&amp;#34;read&amp;#34;, &amp;#34;create&amp;#34;, &amp;#34;update&amp;#34;, &amp;#34;delete&amp;#34;]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>並將該 Policy 設定到透過 userpass 的 pin-yi 上面&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault write auth/userpass/users/pin-yi &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> policies&lt;span style="color:#f92672">=&lt;/span>kv-access-policy&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/10.webp"
alt="建立 Policy &amp;amp; 設定 Policy 到 userpass 的 pin-yi user" width="650">&lt;figcaption>
&lt;p>建立 Policy &amp;amp; 設定 Policy 到 userpass 的 pin-yi user&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>測試及驗證 Policy&lt;span class="hx:absolute hx:-mt-20" id="測試及驗證-policy">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e5%8f%8a%e9%a9%97%e8%ad%89-policy" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>耶，到了最後的驗證環節，我們要來測試看看，上面設定以及新增的內容是否可以正常運作&lt;/p>
&lt;ul>
&lt;li>測試用 userpass 登入&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>vault login -method=userpass username=pin-yi&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/11.webp"
alt="測試登入" width="900">&lt;figcaption>
&lt;p>測試登入&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到，我已經可以改用 userpass method 來進行登入，登入完成後，也會更新 &lt;code>$HOME/.vault-token&lt;/code>，也可以改用代表 pin-yi 的 Token 來登入&lt;/p>
&lt;br>
&lt;p>接下來我們就可以使用以下指令來測試 Policy&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault kv get -mount&lt;span style="color:#f92672">=&lt;/span>demo kv/uuid
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault kv get -mount&lt;span style="color:#f92672">=&lt;/span>demo kv/api-keys&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/12.webp"
alt="測試 Policy" width="650">&lt;figcaption>
&lt;p>測試 Policy&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以發現，由於我們的 kv-access-policy 允許 read 這個 &lt;code>demo/data/kv/uuid&lt;/code> 路徑，所以可以正常訪問，但 &lt;code>demo/kv/api-keys&lt;/code> 沒有設定，就會出現 403 沒有權限&lt;/p>
&lt;br>
&lt;p>我們額外測試一下，先建立一個新的 Policy 允許 read &lt;code>demo/kv/api-keys&lt;/code> 並附加到 auth method approle 上面再進行一次測試，使用以下指令：&lt;/p>
&lt;p>(記得要先切回原本的 Root Token 登入，不然目前的 pin-yi 是沒有權限的)&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault policy write kv-approle-access-policy - &lt;span style="color:#e6db74">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">path &amp;#34;demo/data/kv/api-keys&amp;#34; {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> capabilities = [&amp;#34;read&amp;#34;]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault write auth/approle/role/demo-app-role &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> policies&lt;span style="color:#f92672">=&lt;/span>kv-approle-access-policy&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/13.webp"
alt="建立好新的 Policy 跟綁到 demo-app-role 上" width="650">&lt;figcaption>
&lt;p>建立好新的 Policy 跟綁到 demo-app-role 上&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>接下來要切成 Role 來查看，但因為 Role 沒辦法像 userpass 那樣，會需要取得 role-id 以及 secret-id，最後產生 Token，以下指令：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault read auth/approle/role/demo-app-role/role-id
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault write -f auth/approle/role/demo-app-role/secret-id
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault write auth/approle/login role_id&lt;span style="color:#f92672">=&lt;/span>c073455d-7b65-b55f-9adc-dc381feae85c secret_id&lt;span style="color:#f92672">=&lt;/span>d86ca004-5ac0-96a1-9e45-7d7bde5a6f96&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/14.webp"
alt="approle 取得 Token" width="900">&lt;figcaption>
&lt;p>approle 取得 Token&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>有拿到 Token 了，我們就可以像是最一開始用 Root Token 一樣登入，並測試一下兩個 kv 讀取狀態，以下指令：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault login hvs.CAESIKJ8sMjV51f7vCGnB6ohYQenSJm5NLO9sAnIx3H8GDg0Gh4KHGh2cy5UUkhvWG42cVNRaUNyZWw1ZkhRZHJmQUE&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/15.webp"
alt="測試 Policy" width="650">&lt;figcaption>
&lt;p>測試 Policy&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以發現，現在就可以正常讀取 kv/api-keys，但也不能讀取 kv/uuid，因為沒有設定權限&lt;/p>
&lt;br>
&lt;p>好啦到這邊，我們的開發環境測試流程就差不多結束啦，那這邊補一些前面有挖的坑：解封還有解封金鑰是什麼？&lt;/p>
&lt;h2>解封還有解封金鑰是什麼？&lt;span class="hx:absolute hx:-mt-20" id="解封還有解封金鑰是什麼">&lt;/span>
&lt;a href="#%e8%a7%a3%e5%b0%81%e9%82%84%e6%9c%89%e8%a7%a3%e5%b0%81%e9%87%91%e9%91%b0%e6%98%af%e4%bb%80%e9%ba%bc" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們可以從官網文件 &lt;a href="https://developer.hashicorp.com/vault/docs/concepts/seal"target="_blank" rel="noopener">Seal/Unseal&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 中得知：&lt;/p>
&lt;p>當我們初始化啟動 Vault Server 時，預設會是密封狀態，這個狀態下 Vault 能夠存取實體儲存 (Storage Backend) ，但無法解密其中的任何資料&lt;/p>
&lt;p>且解封是取得解密金鑰的所需明文 Root 金鑰內容。再解封之前，Vault 唯一可以執行的操作就是解封 or 檢查 Server 狀態&lt;/p>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200">
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2">&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>&lt;/svg>&lt;/div>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">那這邊先簡單小提一下 Storage Backend 是什麼，後面會再說明，在 Vaule 啟動時，可以選擇資料的存放位置，那這個 Storage Backend 有很多可以選擇， 資料會透過加密儲存到裡面&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>當 Vault 解封後，會將加密密鑰存到記憶體，因此可以正常去加解密，而 Storage Backend 永遠都是儲存密文，因此之後要備份，其實只要備份該 Storage Backend，以及將解密金鑰帶入就可以解密了，就算 Storage Backend 被駭客拿到，如果沒有解密金鑰，也無法看到裡面的內容&lt;/p>
&lt;p>這邊也來提一下 Vault 他的加密演算法，預設是使用 Shamir seals，他會產生多組密鑰，在解密時，需要輸入對應門檻的密鑰才可以解密，例如它產生 5 把，會需要輸入 3 把才可以正常解密，因此需要將這幾把密鑰分開存放&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/16.webp"
alt="測試 Policy" width="650">&lt;figcaption>
&lt;p>測試 Policy&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>那我們上面測試是用 DEV 開發環境，故只有產生一組密鑰，且已經自動解密，正式環境在服務建立初始化時，就需要先輸入對應的密鑰，若有重啟等也會因為存在記憶體的加密密鑰不見，而需要重新輸入&lt;/p>
&lt;br>
&lt;p>最後，我們拿剛剛的 DEV 環境來測試看看密封跟解封吧 (記得要再切回去 Root Token)&lt;/p>
&lt;p>使用以下指令，可以加原本解封的變成密封，並查看 Server 狀態&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault operator seal
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault status
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault secrets list&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/17.webp"
alt="測試密封，觀察 Server 狀態" width="500">&lt;figcaption>
&lt;p>測試密封，觀察 Server 狀態&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到密封后，Server 狀態的 Sealed 會從 false 變成 true，且無法進行其他的操作了&lt;/p>
&lt;br>
&lt;p>我們使用以下指令，帶入解封密鑰來解封看看(DEV 只有一把)，並測試是否能夠 list secret&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>vault operator unseal L7+kfL/Of/MW846XMFL7riPX5oyoW1SwZVk9T++i8A0&lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vault secrets list&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/security/vault-introduce/18.webp"
alt="解封並檢查功能" width="800">&lt;figcaption>
&lt;p>解封並檢查功能&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以發現就正常囉～&lt;/p>
&lt;br>
&lt;h2>Storage Backend&lt;span class="hx:absolute hx:-mt-20" id="storage-backend">&lt;/span>
&lt;a href="#storage-backend" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Vault 可以選擇不同的 Storage Backend，用來放置加密後的內容&lt;/p>
&lt;p>如果需要 HA 記得 Storage Backend 也需要確認是否支援&lt;/p>
&lt;p>詳細的說明可以參考&lt;a href="https://developer.hashicorp.com/vault/docs/configuration/storage"target="_blank" rel="noopener">官方文件&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> or 之後有時間再來更新內容 xD&lt;/p>
&lt;br>
&lt;h2>注意事項&lt;span class="hx:absolute hx:-mt-20" id="注意事項">&lt;/span>
&lt;a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a0%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Vault HA 其實讀寫還是都透過 primary 去處理&lt;/p>
&lt;p>當大量的服務請求，可能會把 Server 打爆&lt;/p>
&lt;p>所以需要啟用 rate limit 機制來保護 Vault，或是 app 取得 vault secret 後，在本地 cache，不要每次都去跟 vault 請求&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Vault Documentation：&lt;a href="https://developer.hashicorp.com/vault/docs"target="_blank" rel="noopener">https://developer.hashicorp.com/vault/docs&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>HashiCorp Vault on AWS &amp;amp; K8s - 雲端地端通吃的私鑰管理平台 【Webinar： HashiCorp Vault】| 歐立威科技：&lt;a href="https://www.youtube.com/watch?v=YU_rQz8emoE"target="_blank" rel="noopener">https://www.youtube.com/watch?v=YU_rQz8emoE&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>從零開始的 30 天 Hashicorp Vault Workshop：&lt;a href="https://ithelp.ithome.com.tw/users/20120327/ironman/6764"target="_blank" rel="noopener">https://ithelp.ithome.com.tw/users/20120327/ironman/6764&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item></channel></rss>