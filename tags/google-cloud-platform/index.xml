<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PIN-YI – Google Cloud Platform</title><link>https://pin-yi.me/tags/google-cloud-platform/</link><description>Recent content in Google Cloud Platform on PIN-YI</description><generator>Hugo -- gohugo.io</generator><language>zh-tw</language><lastBuildDate>Tue, 12 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://pin-yi.me/tags/google-cloud-platform/index.xml" rel="self" type="application/rss+xml"/><item><title>GKE DNS 相關注意事項及結論</title><link>https://pin-yi.me/blog/gcp/gke-dns/</link><pubDate>Tue, 12 Aug 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-dns/</guid><description>
&lt;p>一樣先前情提要：&lt;/p>
&lt;p>最近在評估要將公司內的 EndPoint 都改成 Cloud DNS 的 Private Zone (打造內部的 internal dns 服務機制)，到時候 DNS 解析的請求會比以往還要多，所以需要先測試評估 GKE 內的 DNS 解析方案，避免再次發生 &lt;a href="../../kubernetes/pod-curl-error-6-could-not-resolve-host">Pod 出現 cURL error 6: Could not resolve host&lt;/a>，此篇文章再來回顧以及整理，可以依照情境測試後的結論以及注意事項，來選擇適合 GKE DNS 組合：&lt;/p>
&lt;p>&lt;a href="../gke-kubedns/">GKE DNS 使用 KubeDNS 運作測試&lt;/a>&lt;/p>
&lt;p>&lt;a href="../gke-kubedns-nodelocaldnscache/">GKE DNS 使用 KubeDNS + NodeLocal DNSCache 運作測試&lt;/a>&lt;/p>
&lt;p>&lt;a href="../gke-cloud-dns/">GKE DNS 使用 Cloud DNS 運作測試&lt;/a>&lt;/p>
&lt;p>&lt;a href="../gke-cloud-dns-nodelocaldnscache/">GKE DNS 使用 Cloud DNS + NodeLocal DNSCache 運作測試&lt;/a>&lt;/p>
&lt;br>
&lt;h2>測試情境的依賴性&lt;span class="hx:absolute hx:-mt-20" id="測試情境的依賴性">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e6%83%85%e5%a2%83%e7%9a%84%e4%be%9d%e8%b3%b4%e6%80%a7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">GKE DNS 情境&lt;/th>
&lt;th style="text-align: left">KubeDNS&lt;/th>
&lt;th style="text-align: left">KubeDNS + NodeLocal DNSCache&lt;/th>
&lt;th style="text-align: left">Cloud DNS&lt;/th>
&lt;th style="text-align: left">Cloud DNS + NodeLocal DNSCache&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為 KubeDNS 有 Liveness，不會馬上關掉，等到 KubeDNS 關成 0 後，就無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為有 NodeLocal DNSCache，透過 Cache 還可以回覆 DNS 請求，但等到 TTL 時間到，就會出現無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會短暫卡住，但他會自動切換到 KubeDNS 上繼續解析&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會直接卡住，會出現無法解析，也不會自動切換成 KubeDNS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為 KubeDNS 有 Liveness，不會馬上關掉，等到 KubeDNS 關成 0 後，就無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依然正常，因為 Cloud DNS Private 他不是 cluster.local，所以不會透過 KubeDNS 來做解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會短暫卡住，但他會自動切換到 KubeDNS 上繼續解析&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會直接卡住，會出現無法解析，也不會自動切換成 KubeDNS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，不會馬上無法解析，因為 KubeDNS 有 Liveness，不會馬上關掉，等到 KubeDNS 關成 0 後，就無法解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依然正常，因為外部 DNS 他不是 cluster.local，所以不會透過 KubeDNS 來做解析&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;td style="text-align: left">KubeDNS 切成 0 顆後，解析依舊正常，因為 provider 已經改用 Cloud DNS，對解析不會有影響&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會短暫卡住，但他會自動切換到 KubeDNS 上繼續解析&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 切成 0 顆後，會直接卡住，會出現無法解析，也不會自動切換成 KubeDNS&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>測試對於情境的依賴性 (不管 Liveness 或是有 Cache，以結果來看)&lt;span class="hx:absolute hx:-mt-20" id="測試對於情境的依賴性-不管-liveness-或是有-cache以結果來看">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e5%b0%8d%e6%96%bc%e6%83%85%e5%a2%83%e7%9a%84%e4%be%9d%e8%b3%b4%e6%80%a7-%e4%b8%8d%e7%ae%a1-liveness-%e6%88%96%e6%98%af%e6%9c%89-cache%e4%bb%a5%e7%b5%90%e6%9e%9c%e4%be%86%e7%9c%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>✅：代表服務異常不會對解析造成影響&lt;/p>
&lt;p>❌：代表服務異常會對解析造成影響&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">GKE DNS 情境&lt;/th>
&lt;th style="text-align: left">KubeDNS&lt;/th>
&lt;th style="text-align: left">KubeDNS + NodeLocal DNSCache&lt;/th>
&lt;th style="text-align: left">Cloud DNS&lt;/th>
&lt;th style="text-align: left">Cloud DNS + NodeLocal DNSCache&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">叢集內部 cluster.local&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Internal DNS (Cloud DNS Private)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>KubeDNS Pod 異常&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">外部 DNS (ifconfig.me)&lt;br>NodeLocal DNSCache Pod 異常&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">✅&lt;/td>
&lt;td style="text-align: left">-&lt;/td>
&lt;td style="text-align: left">❌&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>結論與優缺點&lt;span class="hx:absolute hx:-mt-20" id="結論與優缺點">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96%e8%88%87%e5%84%aa%e7%bc%ba%e9%bb%9e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">模式&lt;/th>
&lt;th style="text-align: left">結論&lt;/th>
&lt;th style="text-align: left">優點&lt;/th>
&lt;th style="text-align: left">缺點&lt;/th>
&lt;th style="text-align: left">/etc/resolv.conf&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>KubeDNS&lt;/strong>&lt;/td>
&lt;td style="text-align: left">對 KubeDNS 的依賴性極高。只要壞掉，所有解析都會失效&lt;/td>
&lt;td style="text-align: left">GKE 預設設定，能快速使用&lt;/td>
&lt;td style="text-align: left">容易出現單點故障，影響所有 DNS 解析。&lt;br>GKE KubeDNS 可以將 kube-dns-autoscaler configmap 納管進版控來調整 Pod 數量 (但沒辦法動態調整)&lt;br>Deployment 沒辦法調整，會被還原，因為有：addonmanager.kubernetes.io/mode=Reconcile 設定，由 GKE 維運 (&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/custom-kube-dns?hl=zh-tw"target="_blank" rel="noopener">也可以自建 DNS&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>)&lt;/td>
&lt;td style="text-align: left">KubeDNS 的 IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>KubeDNS + NodeLocal DNSCache&lt;/strong>&lt;/td>
&lt;td style="text-align: left">大幅降低對 KubeDNS 的依賴。快取可以應對 KubeDNS 短暫異常&lt;/td>
&lt;td style="text-align: left">提高 DNS 解析的效能和可靠性&lt;/td>
&lt;td style="text-align: left">需要維護 KubeDNS 的 kube-dns-autoscaler configmap 來調整 Pod 數量&lt;/td>
&lt;td style="text-align: left">KubeDNS 的 IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>Cloud DNS&lt;/strong>&lt;/td>
&lt;td style="text-align: left">所有的 DNS 解析都依賴 Cloud DNS。可以將 KubeDNS Pod 縮減為 0&lt;/td>
&lt;td style="text-align: left">高可用性。DNS 責任交由託管服務處理，節省維護成本&lt;/td>
&lt;td style="text-align: left">會有額外的費用，以及若 GCP DNS 出現異常會導致 GKE 服務無法解析問題&lt;/td>
&lt;td style="text-align: left">169.254.169.254&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;strong>Cloud DNS + NodeLocal DNSCache&lt;/strong>&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 只要發生問題，所有的解析都會有異常。&lt;br>所以不太建議使用 Cloud DNS + NodeLocal DNSCache 的模式&lt;/td>
&lt;td style="text-align: left">提供更快的 DNS 解析速度，減少延遲&lt;/td>
&lt;td style="text-align: left">當 NodeLocal DNSCache 出現問題時，所有解析都會失效&lt;/td>
&lt;td style="text-align: left">169.254.20.10&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>注意事項&lt;span class="hx:absolute hx:-mt-20" id="注意事項">&lt;/span>
&lt;a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a0%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>測試 KubeDNS、KubeDNS + NodeLocal DNSCache、Cloud DNS、Cloud DNS + NodeLocal DNSCache 使用 K6 簡單進行壓測，會發現除了 Cloud DNS 以外，其他的 DNS 解析 RPS 不一定會慢於直接打 IP&lt;/li>
&lt;li>如果有需求需要管理 KubeDNS Deployment 服務，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/custom-kube-dns?hl=zh-tw"target="_blank" rel="noopener">自訂 kube-dns 部署作業&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，但會有相對的維運成本 (因為官方預設的沒辦法調整 Deployment，會因為 addonmanager.kubernetes.io/mode=Reconcile 被 GKE 還原)&lt;/li>
&lt;li>所有只要經過 Cloud DNS 以及 Metadata Server (在 Node 上) 都會有 Cache 機制&lt;/li>
&lt;li>將 GKE 叢集的 DNS 服務從 KubeDNS + NodeLocal DNSCache 換成 Cloud DNS + NodeLocal DNSCache，且此過程會導致舊節點無法解析網域，造成服務中斷，因此建議在維護期間執行，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#dns-fails-dnscache"target="_blank" rel="noopener">從 kube-dns 遷移至 Cloud DNS 後，啟用 NodeLocal DNSCache 時 DNS 解析失敗&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>在升級 GKE Cluster 時，因為會更新 KubeDNS，所以有可能會發生 DNS 解析失敗的情況，不管是否有開啟 NodeLocal DNSCache，都也可能發生 (通常只有一小部分節點會遇到 10%)，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/kube-dns?hl=zh-tw#performance_limitations_with_kube-dns"target="_blank" rel="noopener">kube-dns 的效能限制&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-dns/1.webp" width="600">
&lt;/figure>
&lt;br>
&lt;ol start="6">
&lt;li>將 GKE 叢集的 DNS 服務從 KubeDNS 換成 Cloud DNS VPC 範圍，必須在重建節點後才會生效，且此過程會導致舊節點無法解析網域，造成服務中斷，因此建議在維護期間執行，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#enable-vpc-scope-existing"target="_blank" rel="noopener">在現有叢集啟用 VPC 範圍 DNS&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-dns/2.webp" width="600">
&lt;/figure>
&lt;br>
&lt;ol start="7">
&lt;li>如果已經建立 GKE Cloud DNS VPC 範圍的 Cluster，是沒辦法切換回 KubeDNS，只能重建 Cluster，可以參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#disable-cloud-dns"target="_blank" rel="noopener">停用 Cloud DNS for GKE&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-dns/3.webp" width="600">
&lt;/figure>
&lt;br>
&lt;h2>結論&lt;span class="hx:absolute hx:-mt-20" id="結論">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們上面進行測試的內容，是為了選出 4 種在 GKE DNS 比較好的一個選型，最終考慮：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>服務的可控性 (能夠自己管理 KubeDNS 以及建立 NodeLocal DNSCache)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>服務的穩定性 (服務若異常可以快速恢復，且不需要依靠 GCP 協助)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>服務的監控性 (能夠監控 KubeDNS 以及 NodeLocal DNSCache)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>額外產生的費用 &amp;amp; 人力成本等 (使用 Cloud DNS 會有額外成本)&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>我們公司最終選型為：GKE 內使用 &lt;b>KubeDNS + NodeLocal DNSCache&lt;/b>&lt;/p>
&lt;br>
&lt;p>補充：&lt;/p>
&lt;p>在測試過程中發現，我們使用的是 nslookup 並搭配 busybox image 基底測試，中間有換成 alpine 並安裝 bind-tools 發現在 KubeDNS + NodeLocal DNSCache 將 NodeLocal DNSCache 用壞時，會無法正常解析，或是解析速度會下降很多，我們推測是跟底層的 C 語言 lib 有關。&lt;/p>
&lt;p>下面提供幾個最終可能會導致 DNS 解析有差異的因素，會需要再去考慮以及測試：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>系統底層 C 語言 lib 選用：glibc / msul&lt;/p>
&lt;/li>
&lt;li>
&lt;p>程式 lib 選用 (例如 Golang)：net.http / goresty&lt;/p>
&lt;/li>
&lt;li>
&lt;p>連線方式：短 / 長連線&lt;/p>
&lt;/li>
&lt;li>
&lt;p>晶片架構：amd / arm&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Golang 是否 Build 開啟 CGO_ENABLED 等等&lt;/p>
&lt;/li>
&lt;/ul>
&lt;br>
&lt;p>我們上述的選型主要考慮的不是 KubeDNS 或是 NodeLocal DNSCache 故障等異常情形 (這個異常是可以透過監控以及好的維運設定改善的)，而是上面那四點綜合評估下來的結論&lt;/p></description></item><item><title>GKE DNS 使用 Cloud DNS + NodeLocal DNSCache 運作測試</title><link>https://pin-yi.me/blog/gcp/gke-cloud-dns-nodelocaldnscache/</link><pubDate>Fri, 08 Aug 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-cloud-dns-nodelocaldnscache/</guid><description>
&lt;p>最近在評估要將公司內的 EndPoint 都改成 Cloud DNS 的 Private Zone (打造內部的 internal dns 服務機制)，到時候 DNS 解析的請求會比以往還要多，所以需要先測試評估 GKE 內的 DNS 解析方案，避免再次發生 &lt;a href="../../kubernetes/pod-curl-error-6-could-not-resolve-host">Pod 出現 cURL error 6: Could not resolve host&lt;/a>，此篇文章測試的是： Cloud DNS + NodeLocal DNSCache 的運作。&lt;/p>
&lt;br>
&lt;p>首先，先建立一個 dns-test pod &lt;a href="https://github.com/880831ian/gke-dns/blob/main/dns-test.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 以及 nginx 的 pod + svc &lt;a href="https://github.com/880831ian/gke-dns/blob/main/nginx.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，會分別測試&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal">叢集內部 cluster.local&lt;/a> (nginx-svc.default.svc.cluster.local)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#internal-dns-cloud-dns-private">internal-dns 使用 cloud dns private&lt;/a> (aaa.test-audit.com)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme">外部 dns&lt;/a> (ifconfig.me)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>並使用 nslookup 腳本進行確認回傳 DNS 解析，每一次測試都會重新建立 KubeDNS、NodeLocal DNSCache Pod&lt;/p>
&lt;p>相關程式以及 Prometheus、Grafana 的設定可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;p>在建立完 Cluster 後，可以先觀察在 Cloud DNS 是否新增的 Private Zone&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cloud-dns-nodelocaldnscache.webp" width="850">
&lt;/figure>
&lt;br>
&lt;p>由於裡面有很多的 Record，我們先搜尋下面會用到的 nginx-svc.default.svc.cluster.local 來當作範例&lt;/p>
&lt;br>
&lt;h2>叢集內部 cluster.local&lt;span class="hx:absolute hx:-mt-20" id="叢集內部-clusterlocal">&lt;/span>
&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>一樣會觀察 KubeDNS Pod Metrics，因為就算開啟 Cloud DNS 後，KubeDNS 還是會留著&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/1.webp"
alt="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#architecture " width="750">&lt;figcaption>
&lt;p>&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#architecture"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#architecture&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;cluster.local.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;nginx-svc.default.svc.cluster.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.36.16.172&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.36.16.172 是 nginx-svc Cluster IP&lt;/p>
&lt;p>需要先確認 &lt;code>nginx-svc&lt;/code> 的 IP 是多少，然後修改腳本中的 &lt;code>EXPECTED_IP&lt;/code> 變數。&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/2.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/3.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache hit 跟 request 都有持續上升，但與 KubeDNS + NodeLocal DNSCache 模式 metrics 比較不一樣的地方是：Server 從 KubeDNS IP 變成 169.254.20.10，可以回去看：&lt;a href="../gke-kubedns-nodelocaldnscache/#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal">GKE KubeDNS + NodeLocal DNSCache 運作測試 #叢集內部 cluster.local&lt;/a>&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/4.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/5.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，可以看到 NodeLocal DNSCache 有往上漲，也因為我們已經改用 Cloud DNS 來解析叢集內部 DNS，所以就算關閉 KubeDNS 也不會有影響，因為 NodeLocal DNSCache 會去問 Cloud DNS，並 Cache 在 NodeLocal DNSCache&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/6.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/7.webp"
alt="發現會卡住，直到手動下指令恢復 NodeLocal DNSCache" width="500">&lt;figcaption>
&lt;p>發現會卡住，直到手動下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/cluster-dns/8.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會直接卡住 (時間每五秒是因為打不到 timeout)，也不會切換到 KubeDNS 來做解析，所以最後測試沒有等到 30000 筆才下指令恢復 NodeLocal DNSCache，先提早下指令讓 NodeLocal DNSCache 正常，等到恢復，解析就正常了&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>Internal DNS (Cloud DNS Private)&lt;span class="hx:absolute hx:-mt-20" id="internal-dns-cloud-dns-private">&lt;/span>
&lt;a href="#internal-dns-cloud-dns-private" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>先建立一個 cloud dns private，以下範例是 aaa.test-audit.com &amp;gt; 10.1.1.4，並將此 use VPC 與 GKE 的 VPC 打通&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/1.webp"
alt="設定 cloud dns private" width="600">&lt;figcaption>
&lt;p>設定 cloud dns private&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;aaa.test-audit.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.1.1.4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.1.1.4 是隨機亂取的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-1">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/2.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/3.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache hit 跟 request 都有持續上升，但與 KubeDNS + NodeLocal DNSCache 模式 metrics 比較不一樣的地方是：Server 從 KubeDNS IP 變成 169.254.20.10，可以回去看：&lt;a href="../gke-kubedns-nodelocaldnscache/#internal-dns-cloud-dns-private">GKE KubeDNS + NodeLocal DNSCache 運作測試 #Internal DNS (Cloud DNS Private)&lt;/a>&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/4.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/5.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，可以看到 NodeLocal DNSCache 有往上漲，也因為我們已經改用 Cloud DNS 來解析 internal-dns DNS，所以就算關閉 KubeDNS 也不會有影響，因為 NodeLocal DNSCache 會去問 Cloud DNS，並 Cache 在 NodeLocal DNSCache&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/6.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/7.webp"
alt="只要 NodeLocal DNSCache 故障解析就會卡住，等到恢復，就能繼續正常運作" width="500">&lt;figcaption>
&lt;p>只要 NodeLocal DNSCache 故障解析就會卡住，等到恢復，就能繼續正常運作&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/8.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800&amp;#34;">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/internal-dns/9.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會直接卡住 (時間每五秒是因為打不到 timeout)，也不會切換到 KubeDNS 來做解析，所以最後測試沒有等到 30000 筆才下指令恢復 NodeLocal DNSCache，先提早下指令讓 NodeLocal DNSCache 正常，等到恢復，解析就正常了&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>外部 DNS (ifconfig.me)&lt;span class="hx:absolute hx:-mt-20" id="外部-dns-ifconfigme">&lt;/span>
&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cloud-dns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ifconfig.me&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;34.160.111.145&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>34.160.111.145 是 ifconfig.me 的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-2">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/1.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/2.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache hit 跟 request 都有持續上升，但與 KubeDNS + NodeLocal DNSCache 模式 metrics 比較不一樣的地方是：Server 從 KubeDNS IP 變成 169.254.20.10，可以回去看：
&lt;a href="../gke-kubedns-nodelocaldnscache/#%e5%a4%96%e9%83%a8-dns-ifconfigme">GKE KubeDNS + NodeLocal DNSCache 運作測試 #外部 DNS (ifconfig.me)&lt;/a>&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/3.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/4.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，可以看到 NodeLocal DNSCache 有往上漲，也因為我們已經改用 Cloud DNS 來解析 internal-dns DNS，所以就算關閉 KubeDNS 也不會有影響，因為 NodeLocal DNSCache 會去問 Cloud DNS，並 Cache 在 NodeLocal DNSCache&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/5.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/6.webp"
alt="只要 NodeLocal DNSCache 故障解析就會卡住，等到恢復，就能繼續正常運作" width="500">&lt;figcaption>
&lt;p>只要 NodeLocal DNSCache 故障解析就會卡住，等到恢復，就能繼續正常運作&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/7.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/external-dns/8.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會直接卡住 (時間每五秒是因為打不到 timeout)，也不會切換到 KubeDNS 來做解析，所以最後測試沒有等到 30000 筆才下指令恢復 NodeLocal DNSCache，先提早下指令讓 NodeLocal DNSCache 正常，等到恢復，解析就正常了&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>k6 測試&lt;span class="hx:absolute hx:-mt-20" id="k6-測試">&lt;/span>
&lt;a href="#k6-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>額外在另一個 cluster 建立 nginx deployment 開 5 個 pod 以及 svc 改成 lb (L4)，然後在 cloud dns 的 test-audit-com 設定 nginx-lb-internal.test-audit.com 解析到內網的 svc (10.156.16.19)&lt;/p>
&lt;br>
&lt;p>使用 k6 測試 KubeDNS + NodeLocal DNSCache 模式下 IP 跟 DNS 的差異&lt;/p>
&lt;p>相關程式可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>這邊測試的 Node 是用 e2-medium 而非 c3d-standard-4&lt;/p>
&lt;br>
&lt;h3>第一次測試&lt;span class="hx:absolute hx:-mt-20" id="第一次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%80%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=144.26ms / 3895 RPS)、DNS (avg=145.16ms / 3887 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/1.webp"
alt="IP 第一次測試" width="1000">&lt;figcaption>
&lt;p>IP 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/2.webp"
alt="DNS 第一次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第二次測試&lt;span class="hx:absolute hx:-mt-20" id="第二次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%ba%8c%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=141.37ms / 3960 RPS)、DNS (avg=144.9ms / 3806 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/3.webp"
alt="IP 第二次測試" width="1000">&lt;figcaption>
&lt;p>IP 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/4.webp"
alt="DNS 第二次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第三次測試&lt;span class="hx:absolute hx:-mt-20" id="第三次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%89%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=172.8ms / 2959 RPS)、DNS (avg=150.34ms / 3715 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/5.webp"
alt="IP 第三次測試" width="1000">&lt;figcaption>
&lt;p>IP 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/6.webp"
alt="DNS 第三次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第四次測試&lt;span class="hx:absolute hx:-mt-20" id="第四次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e5%9b%9b%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=168.01ms / 3071 RPS)、DNS (avg=168.14ms / 3018 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/7.webp"
alt="IP 第四次測試" width="1000">&lt;figcaption>
&lt;p>IP 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/k6/8.webp"
alt="DNS 第四次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>理論上 ip 應該會比 dns 還要快，但測試 4 次發現其實不一定&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>結論&lt;span class="hx:absolute hx:-mt-20" id="結論">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>可以發現，使用 Cloud DNS + NodeLocal DNSCache 的模式下，不管是哪一個解析，不會使用到 KubeDNS，所以可以把 KubeDNS 關成 0 顆，避免浪費資源。&lt;/p>
&lt;p>但是也可以發現當 NodeLocal DNSCache 只要發生問題，所有的解析都會有異常，所以不太建議使用 Cloud DNS + NodeLocal DNSCache 的模式&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/nodelocal-dnscache-cloud-dns.webp"
alt="Cloud DNS &amp;#43; NodeLocal DNSCache 流程圖
https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#cloud_dns_dataplane " width="650">&lt;figcaption>
&lt;p>Cloud DNS + NodeLocal DNSCache 流程圖&lt;br>&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#cloud_dns_dataplane"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#cloud_dns_dataplane&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>由於官方流程圖有些細節沒有揭露的完成，我們有額外詢問 Google TAM，並畫出以下流程圖，Google TAM 也確認流程正確&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/nodelocal-dnscache-cloud-dns-flow.webp"
alt="自己重新畫的 Cloud DNS &amp;#43; NodeLocal DNSCache 流程圖" width="1200">&lt;figcaption>
&lt;p>自己重新畫的 Cloud DNS + NodeLocal DNSCache 流程圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>另外也可以從官方文件中得知 KubeDNS + NodeLocal DNSCache 的 &lt;code>/etc/resolv.conf&lt;/code> 設定值，可以知道 Pod 最開始使用的 DNS 解析 Server 是誰。&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/resolv.webp"
alt="/etc/resolv.conf 設定值 服務探索和 DNS /etc/resolv.conf " width="800">&lt;figcaption>
&lt;p>/etc/resolv.conf 設定值 &lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/service-discovery?hl=zh-tw#conf_value"target="_blank" rel="noopener">服務探索和 DNS /etc/resolv.conf&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns-nodelocaldnscache/config.webp"
alt="實際查看 /etc/resolv.conf" width="800">&lt;figcaption>
&lt;p>實際查看 /etc/resolv.conf&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>搭配 Cloud DNS 使用 NodeLocal DNSCache：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#cloud_dns_dataplane"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#cloud_dns_dataplane&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>GKE DNS 使用 Cloud DNS 運作測試</title><link>https://pin-yi.me/blog/gcp/gke-cloud-dns/</link><pubDate>Wed, 06 Aug 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-cloud-dns/</guid><description>
&lt;p>最近在評估要將公司內的 EndPoint 都改成 Cloud DNS 的 Private Zone (打造內部的 internal dns 服務機制)，到時候 DNS 解析的請求會比以往還要多，所以需要先測試評估 GKE 內的 DNS 解析方案，避免再次發生 &lt;a href="../../kubernetes/pod-curl-error-6-could-not-resolve-host">Pod 出現 cURL error 6: Could not resolve host&lt;/a>，此篇文章測試的是： Cloud DNS 的運作。&lt;/p>
&lt;br>
&lt;p>首先，先建立一個 dns-test pod &lt;a href="https://github.com/880831ian/gke-dns/blob/main/dns-test.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 以及 nginx 的 pod + svc &lt;a href="https://github.com/880831ian/gke-dns/blob/main/nginx.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，會分別測試&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal">叢集內部 cluster.local&lt;/a> (nginx-svc.default.svc.cluster.local)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#internal-dns-cloud-dns-private">internal-dns 使用 cloud dns private&lt;/a> (aaa.test-audit.com)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme">外部 dns&lt;/a> (ifconfig.me)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>並使用 nslookup 腳本進行確認回傳 DNS 解析，每一次測試都會重新建立 KubeDNS Pod&lt;/p>
&lt;p>相關程式以及 Prometheus、Grafana 的設定可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;p>在建立完 Cluster 後，可以先觀察在 Cloud DNS 是否新增的 Private Zone&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/cloud-dns-private.webp" width="850">
&lt;/figure>
&lt;br>
&lt;p>由於裡面有很多的 Record，我們先搜尋下面會用到的 nginx-svc.default.svc.cluster.local 來當作範例&lt;/p>
&lt;br>
&lt;h2>叢集內部 cluster.local&lt;span class="hx:absolute hx:-mt-20" id="叢集內部-clusterlocal">&lt;/span>
&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>一樣會觀察 KubeDNS Pod Metrics，因為就算開啟 Cloud DNS 後，KubeDNS 還是會留著&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/cluster-dns/1.webp"
alt="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#architecture " width="750">&lt;figcaption>
&lt;p>&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#architecture"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw#architecture&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;nginx-svc.default.svc.cluster.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.36.16.243&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.36.16.243 是 nginx-svc Cluster IP&lt;/p>
&lt;p>需要先確認 &lt;code>nginx-svc&lt;/code> 的 IP 是多少，然後修改腳本中的 &lt;code>EXPECTED_IP&lt;/code> 變數。&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/cluster-dns/2.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/cluster-dns/3.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>因為改用 Cloud DNS，所以 KubeDNS 的 hit 沒有往上衝高&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/cluster-dns/4.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/cluster-dns/5.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，可以發現解析還是正常，代表使用 Cloud DNS 後，KubeDNS 對於叢集內部解析不會有影響&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>Internal DNS (Cloud DNS Private)&lt;span class="hx:absolute hx:-mt-20" id="internal-dns-cloud-dns-private">&lt;/span>
&lt;a href="#internal-dns-cloud-dns-private" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>先建立一個 cloud dns private，以下範例是 aaa.test-audit.com &amp;gt; 10.1.1.4，並將此 use VPC 與 GKE 的 VPC 打通&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/internal-dns/1.webp"
alt="設定 cloud dns private" width="600">&lt;figcaption>
&lt;p>設定 cloud dns private&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;aaa.test-audit.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.1.1.4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.1.1.4 是隨機亂取的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-1">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/internal-dns/2.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/internal-dns/3.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>因為改用 Cloud DNS，所以 KubeDNS 的 hit 沒有往上衝高&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/internal-dns/4.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/internal-dns/5.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，可以發現解析還是正常，代表使用 Cloud DNS 後，KubeDNS 對於 internal-dns 解析不會有影響&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>外部 DNS (ifconfig.me)&lt;span class="hx:absolute hx:-mt-20" id="外部-dns-ifconfigme">&lt;/span>
&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ifconfig.me&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;34.160.111.145&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>34.160.111.145 是 ifconfig.me 的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-2">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/external-dns/1.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/external-dns/2.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>因為改用 Cloud DNS，所以 KubeDNS 的 hit 沒有往上衝高&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/external-dns/3.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/external-dns/4.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，可以發現解析還是正常，代表使用 Cloud DNS 後，KubeDNS 對於外部 DNS解析不會有影響&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>k6 測試&lt;span class="hx:absolute hx:-mt-20" id="k6-測試">&lt;/span>
&lt;a href="#k6-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>額外在另一個 cluster 建立 nginx deployment 開 5 個 pod 以及 svc 改成 lb (L4)，然後在 cloud dns 的 test-audit-com 設定 nginx-lb-internal.test-audit.com 解析到內網的 svc (10.156.16.16)&lt;/p>
&lt;br>
&lt;p>使用 k6 測試 kube dns 模式下 IP 跟 DNS 的差異&lt;/p>
&lt;p>相關程式可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>這邊測試的 Node 是用 e2-medium 而非 c3d-standard-4&lt;/p>
&lt;br>
&lt;h3>第一次測試&lt;span class="hx:absolute hx:-mt-20" id="第一次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%80%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=179.06ms / 3479 RPS)、DNS (avg=191.56ms / 3348 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/1.webp"
alt="IP 第一次測試" width="1000">&lt;figcaption>
&lt;p>IP 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/2.webp"
alt="DNS 第一次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第二次測試&lt;span class="hx:absolute hx:-mt-20" id="第二次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%ba%8c%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=193.67ms / 3322 RPS)、DNS (avg=302.73ms / 2430 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/3.webp"
alt="IP 第二次測試" width="1000">&lt;figcaption>
&lt;p>IP 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/4.webp"
alt="DNS 第二次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第三次測試&lt;span class="hx:absolute hx:-mt-20" id="第三次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%89%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=174.94ms / 3529 RPS)、DNS (avg=253.71ms / 2761 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/5.webp"
alt="IP 第三次測試" width="1000">&lt;figcaption>
&lt;p>IP 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/6.webp"
alt="DNS 第三次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第四次測試&lt;span class="hx:absolute hx:-mt-20" id="第四次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e5%9b%9b%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=227.56ms / 2971 RPS)、DNS (avg=316.07ms / 2361 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/7.webp"
alt="IP 第四次測試" width="1000">&lt;figcaption>
&lt;p>IP 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/k6/8.webp"
alt="DNS 第四次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>有發現之前在 KubeDNS 跟 KubeDNS + NodeLocal DNSCache 會有 DNS RPS 大於 IP 的情況，但使用 Cloud DNS 後則沒有發生，推測是因為。Cloud DNS 在 Cluster 外部，所以會比較慢&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>結論&lt;span class="hx:absolute hx:-mt-20" id="結論">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>可以發現，使用 Cloud DNS 的模式下，所有的 DNS 解析都會依靠 Cloud DNS，不會使用到 KubeDNS，所以可以把 KubeDNS 關成 0 顆，避免浪費資源。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/gke-cloud-dns-architecture.webp"
alt="GKE Cloud DNS" width="700">&lt;figcaption>
&lt;p>GKE Cloud DNS&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>由於官方流程圖有些細節沒有揭露的完成，我們有額外詢問 Google TAM，並畫出以下流程圖，Google TAM 也確認流程正確&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/gke-cloud-dns-architecture-flow.webp"
alt="自己重新畫的 GKE Cloud DNS" width="1200">&lt;figcaption>
&lt;p>自己重新畫的 GKE Cloud DNS&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>以下是我們與 Google 討論的內容：&lt;/p>
&lt;p>我們：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>圖中粉紅框所選取的兩個 Cloud DNS&amp;lt;Cloud DNS &amp;amp; Cloud DNS (Data Plane)&amp;gt; 在實際的架構中，是兩個獨立的物件嗎？或者其實是同一個物件?&lt;/p>
&lt;/li>
&lt;li>
&lt;p>承(1)，以下項目所述的理解是否正確？若有差異的部分請協助說明：目前我們的認知是，在 Internal DNS 上會有三個 Cloud DNS：&lt;/p>
&lt;ol>
&lt;li>GKE 的設定改用 Cloud DNS 的 provider，此時系統會協助我們建立一個 Cloud DNS (Data Plane)。&lt;/li>
&lt;li>我們會自己建立一個 Cloud DNS(Private) For 我們內部自己要用的 Internal DNS。&lt;/li>
&lt;li>進行外部 DNS 解析時，目前的理解是會從 metadata server 對 Cloud DNS 轉送解析需求，是否屬實？&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>完成解析後，Cache 的部分是否在 metadata server 裡面進行？&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>Google：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>處理 private zone 和公有網域名稱的是不同物件，但都在 GCE DNS 服務裡&lt;/p>
&lt;/li>
&lt;li>
&lt;ol>
&lt;li>主要是建立 cluster-scoped private zone，進到 metadata server 後的行為與原本相同、2 跟 3 正確&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>是，除了metadata server 外，同時也會在 GCE DNS 服務裡快取&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>另外也可以從官方文件中得知 KubeDNS 的 &lt;code>/etc/resolv.conf&lt;/code> 設定值，可以知道 Pod 最開始使用的 DNS 解析 Server 是誰。&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/resolv.webp"
alt="/etc/resolv.conf 設定值 服務探索和 DNS /etc/resolv.conf " width="800">&lt;figcaption>
&lt;p>/etc/resolv.conf 設定值 &lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/service-discovery?hl=zh-tw#conf_value"target="_blank" rel="noopener">服務探索和 DNS /etc/resolv.conf&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cloud-dns/config.webp"
alt="實際查看 /etc/resolv.conf" width="800">&lt;figcaption>
&lt;p>實際查看 /etc/resolv.conf&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>使用 GKE 適用的 Cloud DNS：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-dns?hl=zh-tw&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>GKE DNS 使用 KubeDNS + NodeLocal DNSCache 運作測試</title><link>https://pin-yi.me/blog/gcp/gke-kubedns-nodelocaldnscache/</link><pubDate>Fri, 01 Aug 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-kubedns-nodelocaldnscache/</guid><description>
&lt;p>最近在評估要將公司內的 EndPoint 都改成 Cloud DNS 的 Private Zone (打造內部的 internal dns 服務機制)，到時候 DNS 解析的請求會比以往還要多，所以需要先測試評估 GKE 內的 DNS 解析方案，避免再次發生 &lt;a href="../../kubernetes/pod-curl-error-6-could-not-resolve-host">Pod 出現 cURL error 6: Could not resolve host&lt;/a>，此篇文章測試的是： KubeDNS + NodeLocal DNSCache 的運作。&lt;/p>
&lt;br>
&lt;p>首先，先建立一個 dns-test pod &lt;a href="https://github.com/880831ian/gke-dns/blob/main/dns-test.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 以及 nginx 的 pod + svc &lt;a href="https://github.com/880831ian/gke-dns/blob/main/nginx.yaml"target="_blank" rel="noopener">程式連結&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，會分別測試&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal">叢集內部 cluster.local&lt;/a> (nginx-svc.default.svc.cluster.local)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#internal-dns-cloud-dns-private">internal-dns 使用 cloud dns private&lt;/a> (aaa.test-audit.com)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme">外部 dns&lt;/a> (ifconfig.me)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>並使用 nslookup 腳本進行確認回傳 DNS 解析，每一次測試都會重新建立 KubeDNS、NodeLocal DNSCache Pod&lt;/p>
&lt;p>相關程式以及 Prometheus、Grafana 的設定可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;h2>叢集內部 cluster.local&lt;span class="hx:absolute hx:-mt-20" id="叢集內部-clusterlocal">&lt;/span>
&lt;a href="#%e5%8f%a2%e9%9b%86%e5%85%a7%e9%83%a8-clusterlocal" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;cluster.local.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cluster.local.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;nginx-svc.default.svc.cluster.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.36.16.35&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.36.16.35 是 nginx-svc Cluster IP&lt;/p>
&lt;p>需要先確認 &lt;code>nginx-svc&lt;/code> 的 IP 是多少，然後修改腳本中的 &lt;code>EXPECTED_IP&lt;/code> 變數。&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/1.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/2.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache 內的指標 hit 跟 request 都有持續上升&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/3.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/4.webp"
alt="第二輪才出現錯誤" width="500">&lt;figcaption>
&lt;p>第二輪才出現錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/5.webp"
alt="因為 KubeDNS 關成 0 顆，不會馬上關掉" width="700">&lt;figcaption>
&lt;p>因為 KubeDNS 關成 0 顆，不會馬上關掉&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/6.webp"
alt="將 KubeDNS 調整回來，就正常解析" width="500">&lt;figcaption>
&lt;p>將 KubeDNS 調整回來，就正常解析&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/7.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>總共打了兩輪的 10000 筆，在第一輪大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，但到了第二輪的 2838 筆的時候才開始出現解析失敗，因為前面 KubeDNS 切成 0，Pod 不會馬上關掉，所以還能夠解析 DNS，中間又因爲有 NodeLocal DNSCache 做 Cache，所以 DNS 解析還有相關紀錄可以回覆，但後面當 Cache TTL 到期後，需要先訪問 KubeDNS 時，此時 KubeDNS 也已經關閉，最後才會出現解析錯誤
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache request 跟 hit 差不多，但當 15:33 線圖開始 request 大於 hit，且出現 miss，這代表因為後面的 KubeDNS 異常，導致 NodeLocal DNSCache 沒辦法做 Cache hit&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/8.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>分別在 15:55:53 跟 15:57:04 下指令調整&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/9.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/10.webp"
alt="觀察調整讓 NodeLocal DNSCache 故障 Log" width="500">&lt;figcaption>
&lt;p>觀察調整讓 NodeLocal DNSCache 故障 Log&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/11.webp"
alt="觀察修正 NodeLocal DNSCache Log" width="500">&lt;figcaption>
&lt;p>觀察修正 NodeLocal DNSCache Log&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/cluster-dns/12.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會短暫卡住，但會直接切換到 KubeDNS 上繼續進行解析，因此以結果論，如果 NodeLocal DNSCache 有短暫異常，不會出現無法解析的問題
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache 正常運作，當我們在 15:55:53 調整後，變成 KubeDNS 起來開始處理解析，在 15:57:04 切換讓 NodeLocal DNSCache 恢復，後面又會變成由 NodeLocal DNSCache 來處理解析
&lt;br>
&lt;br>
紫色是 NodeLocal DNSCache，黃色是 KubeDNS&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>Internal DNS (Cloud DNS Private)&lt;span class="hx:absolute hx:-mt-20" id="internal-dns-cloud-dns-private">&lt;/span>
&lt;a href="#internal-dns-cloud-dns-private" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>先建立一個 cloud dns private，以下範例是 aaa.test-audit.com &amp;gt; 10.1.1.4，並將此 use VPC 與 GKE 的 VPC 打通&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/1.webp"
alt="設定 cloud dns private" width="600">&lt;figcaption>
&lt;p>設定 cloud dns private&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;aaa.test-audit.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;10.1.1.4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>10.1.1.4 是隨機亂取的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-1">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/2.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/3.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache 內的指標 hit 跟 request 都有持續上升&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/4.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/5.webp"
alt="因為 KubeDNS 關成 0 顆，不會馬上關掉" width="700">&lt;figcaption>
&lt;p>因為 KubeDNS 關成 0 顆，不會馬上關掉&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/6.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>總共打了兩輪的 10000 筆，在第一輪大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，因為前面 KubeDNS 切成 0，Pod 不會馬上關掉，避免有測試誤差，所以在打第二輪 10000 筆，但從結果發現，所有的 DNS 請求都是走 NodeLocal DNSCache，因為 cloud dns private 不是 .cluster.local，所以就算沒有 KubeDNS 也能正常運作&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常-1">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/7.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>分別在 18:26:11 跟 18:28:03 下指令調整&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/8.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/internal-dns/9.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會短暫卡住，但會直接切換到 KubeDNS 上繼續進行解析，因此以結果論，如果 NodeLocal DNSCache 有短暫異常，不會出現無法解析的問題
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache 正常運作，當我們在 18:26:11 調整後，變成 KubeDNS 起來開始處理解析，在 18:28:03 切換讓 NodeLocal DNSCache 恢復，後面又會變成由 NodeLocal DNSCache 來處理解析
&lt;br>
&lt;br>
紫色是 NodeLocal DNSCache，黃色是 KubeDNS&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>外部 DNS (ifconfig.me)&lt;span class="hx:absolute hx:-mt-20" id="外部-dns-ifconfigme">&lt;/span>
&lt;a href="#%e5%a4%96%e9%83%a8-dns-ifconfigme" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>NodeLocal DNSCache Prometheus 監控設定參數：&lt;code>zones=&amp;quot;.&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;ul>
&lt;li>相關 Prometheus 監控指標：&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>coredns_cache_requests_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_entries&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_hits_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coredns_cache_misses_total&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-nodelocaldns&amp;#34;&lt;/span>, zones&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_hits&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kubedns_dnsmasq_misses&lt;span style="color:#f92672">{&lt;/span>job&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;kubedns-dns&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試腳本：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>get_taiwan_time&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 獲取當前 UTC 時間的 Unix 時間戳&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UTC_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>date -u +%s&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 加上 8 小時 (台灣時間是 UTC+8)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TAIPEI_TIMESTAMP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>UTC_TIMESTAMP &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">28800&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 將時間戳轉換為格式化後的日期時間&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> date -d &lt;span style="color:#e6db74">&amp;#34;@&lt;/span>$TAIPEI_TIMESTAMP&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;+%Y-%m-%d %H:%M:%S&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOMAIN&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ifconfig.me&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>EXPECTED_IP&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;34.160.111.145&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>START_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST START: &lt;/span>$START_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">for&lt;/span> i in &lt;span style="color:#66d9ef">$(&lt;/span>seq &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>; &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OUTPUT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>nslookup &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$DOMAIN&lt;span style="color:#e6db74">&amp;#34;&lt;/span> 2&amp;gt;&amp;amp;1&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ADDR_LINE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$OUTPUT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | grep -E &lt;span style="color:#e6db74">&amp;#39;^Address:&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$ADDR_LINE&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> *&lt;span style="color:#e6db74">&amp;#34;&lt;/span>$EXPECTED_IP&lt;span style="color:#e6db74">&amp;#34;&lt;/span>* &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SUCCESS_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>SUCCESS_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FAIL_COUNT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$((&lt;/span>FAIL_COUNT &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#66d9ef">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;[&lt;/span>$i&lt;span style="color:#e6db74">] === &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74"> 成功: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74"> 失敗: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>END_TIME&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>get_taiwan_time&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;== NSLOOKUP TEST END: &lt;/span>$END_TIME&lt;span style="color:#e6db74"> ==&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;成功次數: &lt;/span>$SUCCESS_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;失敗次數: &lt;/span>$FAIL_COUNT&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tee -a nslookup_full.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>34.160.111.145 是 ifconfig.me 的 IP，只是為了確認 domain 是否能夠正常解析&lt;/p>
&lt;br>
&lt;h3>測試腳本&lt;span class="hx:absolute hx:-mt-20" id="測試腳本-2">&lt;/span>
&lt;a href="#%e6%b8%ac%e8%a9%a6%e8%85%b3%e6%9c%ac-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/1.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/2.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>可以觀察 NodeLocal DNSCache 內的指標 hit 跟 request 都有持續上升&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 KubeDNS Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-kubedns-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-kubedns-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來會在測試中，將 KubeDNS 調整到 0 顆，再開回去，觀察此模式對於 KubeDNS 的依賴&lt;/p>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/3.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/4.webp"
alt="因為 KubeDNS 關成 0 顆，不會馬上關掉" width="700">&lt;figcaption>
&lt;p>因為 KubeDNS 關成 0 顆，不會馬上關掉&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/5.webp"
alt="Prometheus 監控指標" width="900">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>總共打了兩輪的 10000 筆，在第一輪大約在 2000 筆請求時左右將 KubeDNS 關成 0 顆，因為前面 KubeDNS 切成 0，Pod 不會馬上關掉，避免有測試誤差，所以在打第二輪 10000 筆，但從結果發現，所有的 DNS 請求都是走 NodeLocal DNSCache，因為外部 dns 不是 .cluster.local，所以就算沒有 KubeDNS 也能正常運作&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>模擬 NodeLocal DNSCache Pod 異常&lt;span class="hx:absolute hx:-mt-20" id="模擬-nodelocal-dnscache-pod-異常-2">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%93%ac-nodelocal-dnscache-pod-%e7%95%b0%e5%b8%b8-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來我們測試最後一個情境，故意用壞 NodeLocal DNSCache 服務，觀察此模式對於 NodeLocal DNSCache 的依賴&lt;/p>
&lt;p>測試情境：&lt;/p>
&lt;p>先調整 COUNT 參數變成 50000&lt;/p>
&lt;p>先跑 15000 筆有 NodeLocal DNSCache，然後使用以下指令讓 NodeLocal DNSCache 無法使用&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:{&amp;#34;this-label-does-not-exist-on-any-node&amp;#34;:&amp;#34;true&amp;#34;}}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>等待約 30000 筆時，使用以下指令恢復 NodeLocal DNSCache&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>kubectl patch daemonset node-local-dns -n kube-system --type&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;strategic&amp;#39;&lt;/span> -p &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;spec&amp;#34;:{&amp;#34;template&amp;#34;:{&amp;#34;spec&amp;#34;:{&amp;#34;nodeSelector&amp;#34;:null}}}}&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>測試結果：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/6.webp"
alt="測試結果" width="450">&lt;figcaption>
&lt;p>測試結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>分別在 19:52:28 跟 19:53:16 下指令調整&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/7.webp"
alt="模擬 NodeLocal DNSCache 故障" width="800">&lt;figcaption>
&lt;p>模擬 NodeLocal DNSCache 故障&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/external-dns/8.webp"
alt="Prometheus 監控指標" width="1200">&lt;figcaption>
&lt;p>Prometheus 監控指標&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>發現當 NodeLocal DNSCache 掛了後，會短暫卡住，但會直接切換到 KubeDNS 上繼續進行解析，因此以結果論，如果 NodeLocal DNSCache 有短暫異常，不會出現無法解析的問題
&lt;br>
&lt;br>
從 Prometheus 可以發現，前面 NodeLocal DNSCache 正常運作，當我們在 19:52:28 調整後，變成 KubeDNS 起來開始處理解析，在 19:53:16 切換讓 NodeLocal DNSCache 恢復，後面又會變成由 NodeLocal DNSCache 來處理解析
&lt;br>
&lt;br>
紫色是 NodeLocal DNSCache，黃色是 KubeDNS&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>k6 測試&lt;span class="hx:absolute hx:-mt-20" id="k6-測試">&lt;/span>
&lt;a href="#k6-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>額外在另一個 cluster 建立 nginx deployment 開 5 個 pod 以及 svc 改成 lb (L4)，然後在 cloud dns 的 test-audit-com 設定 nginx-lb-internal.test-audit.com 解析到內網的 svc (10.156.17.230)&lt;/p>
&lt;br>
&lt;p>使用 k6 測試 KubeDNS + NodeLocal DNSCache 模式下 IP 跟 DNS 的差異&lt;/p>
&lt;p>相關程式可以參考：&lt;a href="https://github.com/880831ian/gke-dns"target="_blank" rel="noopener">https://github.com/880831ian/gke-dns&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>這邊測試的 Node 是用 e2-medium 而非 c3d-standard-4&lt;/p>
&lt;br>
&lt;h3>第一次測試&lt;span class="hx:absolute hx:-mt-20" id="第一次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%80%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=181.7ms / 3511 RPS)、DNS (avg=335.43ms / 2278 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/1.webp"
alt="IP 第一次測試" width="1000">&lt;figcaption>
&lt;p>IP 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/2.webp"
alt="DNS 第一次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第一次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第二次測試&lt;span class="hx:absolute hx:-mt-20" id="第二次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%ba%8c%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=336.98ms / 2272 RPS)、DNS (avg=503.79ms / 1640 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/3.webp"
alt="IP 第二次測試" width="1000">&lt;figcaption>
&lt;p>IP 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/4.webp"
alt="DNS 第二次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第二次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第三次測試&lt;span class="hx:absolute hx:-mt-20" id="第三次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e4%b8%89%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=128.9ms / 4310 RPS)、DNS (avg=129.23ms / 4310 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/5.webp"
alt="IP 第三次測試" width="1000">&lt;figcaption>
&lt;p>IP 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/6.webp"
alt="DNS 第三次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第三次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>第四次測試&lt;span class="hx:absolute hx:-mt-20" id="第四次測試">&lt;/span>
&lt;a href="#%e7%ac%ac%e5%9b%9b%e6%ac%a1%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>IP (avg=149.5ms / 3965 RPS)、DNS (avg=133.73ms / 4230 RPS)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/7.webp"
alt="IP 第四次測試" width="1000">&lt;figcaption>
&lt;p>IP 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/k6/8.webp"
alt="DNS 第四次測試" width="1000">&lt;figcaption>
&lt;p>DNS 第四次測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>結論&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>理論上 ip 應該會比 dns 還要快，但測試 4 次發現其實不一定&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>結論&lt;span class="hx:absolute hx:-mt-20" id="結論">&lt;/span>
&lt;a href="#%e7%b5%90%e8%ab%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>可以發現，使用 KubeDNS + NodeLocal DNSCache 的模式下，對於 KubeDNS 的依賴性降低了很多，因為 NodeLocal DNSCache 會先做 cache hit，這樣就算 KubeDNS 異常（只有 cluster 內的，且 cache 失效才會影響），否則不會影響到 pod 的 DNS 解析。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/nodelocal-dns-cache-diagram.webp"
alt="KubeDNS &amp;#43; NodeLocal DNSCache 流程圖
https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#architecture " width="650">&lt;figcaption>
&lt;p>KubeDNS + NodeLocal DNSCache 流程圖&lt;br>&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#architecture"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw#architecture&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>由於官方流程圖有些細節沒有揭露的完成，我們有額外詢問 Google TAM，並畫出以下流程圖，Google TAM 也確認流程正確&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/nodelocal-dns-cache-flow.webp"
alt="自己重新畫的 GKE KubeDNS &amp;#43; NodeLocal DNSCache 流程圖" width="1200">&lt;figcaption>
&lt;p>自己重新畫的 GKE KubeDNS + NodeLocal DNSCache 流程圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>以下是我們與 Google 討論的內容：&lt;/p>
&lt;p>我們：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>MetaData Server 是否會快取外部DNS的解析結果？若會的話，是否 DNS Provider 改為 Cloud DNS才會有這個行爲發生？&lt;/p>
&lt;/li>
&lt;li>
&lt;p>公用的 Cloud DNS 是否有什麼統一的稱呼 (例：Common Cloud DNS…之類的)？或者就真的只叫 “Cloud DNS”？&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>Google：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>會快取並遵循 TTL，無論是否設定為 Cloud DNS，內外部的 DNS 解析都需要透過 Cloud DNS 查詢，只有是否先經過 kube-dns 的差異，因此快取無論開啟 Cloud DNS 都會有&lt;/p>
&lt;/li>
&lt;li>
&lt;p>就叫 Cloud DNS，或內部稱 GCE DNS&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>這是 K8s 官方的 NodeLocalDNS 流程圖：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/nodelocaldns.webp"
alt="Using NodeLocal DNSCache in Kubernetes Clusters
https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#architecture-diagram " width="600">&lt;figcaption>
&lt;p>Using NodeLocal DNSCache in Kubernetes Clusters&lt;br>&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#architecture-diagram"target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#architecture-diagram&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>另外也可以從官方文件中得知 KubeDNS + NodeLocal DNSCache 的 &lt;code>/etc/resolv.conf&lt;/code> 設定值，可以知道 Pod 最開始使用的 DNS 解析 Server 是誰。&lt;/p>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/resolv.webp"
alt="/etc/resolv.conf 設定值 服務探索和 DNS /etc/resolv.conf " width="800">&lt;figcaption>
&lt;p>/etc/resolv.conf 設定值 &lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/service-discovery?hl=zh-tw#conf_value"target="_blank" rel="noopener">服務探索和 DNS /etc/resolv.conf&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-kubedns-nodelocaldnscache/config.webp"
alt="實際查看 /etc/resolv.conf" width="800">&lt;figcaption>
&lt;p>實際查看 /etc/resolv.conf&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>設定 NodeLocal DNSCache：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache?hl=zh-tw&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>GCP Load Balancer 介紹</title><link>https://pin-yi.me/blog/gcp/gcp-lb-introduce/</link><pubDate>Mon, 26 May 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gcp-lb-introduce/</guid><description>
&lt;p>最近公司在導入 Multi-Zone，有發現大量的跨域費用產生，主要是不同 Cluster 或是 Cluster 跟 VM 之間的跨域流量，與 Google TAM 討論，他們有提出可以嘗試用 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 的 Waterfall by zone，或是之後會推出的 Zone affinity，這些都會需要使用到 Load Balancer，簡單整理一下發現 GCP 的 Load Balancer 其實有很多種，因此，這篇文章就來介紹一下 GCP 的 Load Balancer。
(如果 Service load balancing policy 測試有結果，也會再寫一篇文章來介紹)&lt;/p>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:flex-col hx:rounded-lg hx:border hx:py-4 hx:px-4 hx:border-gray-200 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200">
&lt;p class="hx:flex hx:items-center hx:font-medium">&lt;svg height=16px class="hx:inline-block hx:align-middle hx:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>&lt;/svg>想知道自己用的 Load Balancer 是哪一種嗎？&lt;/p>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;p>由於以下會有多種的 Load Balancer 種類，且 gcloud CLI 沒辦法直接過濾相關 LB 名稱 (UI 可以，但需要每個都進去查看)，因此有特別寫了一隻腳本，可以來掃描查詢，請參考： &lt;a href="https://github.com/880831ian/gcp-load-balancer-type"target="_blank" rel="noopener">gcp-load-balancer-type&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>GCP 的 Load Balancer 主要分為三種，分別是：&lt;/p>
&lt;h3>Application Load Balancer (ALB) – 應用程式負載平衡器&lt;span class="hx:absolute hx:-mt-20" id="application-load-balancer-alb--應用程式負載平衡器">&lt;/span>
&lt;a href="#application-load-balancer-alb--%e6%87%89%e7%94%a8%e7%a8%8b%e5%bc%8f%e8%b2%a0%e8%bc%89%e5%b9%b3%e8%a1%a1%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>層級：第 7 層（L7）&lt;/li>
&lt;li>支援協定：HTTP、HTTPS&lt;/li>
&lt;li>功能：
&lt;ol>
&lt;li>基於內容的路由（如 URL 路徑、主機名稱）&lt;/li>
&lt;li>SSL/TLS 終止&lt;/li>
&lt;li>整合 Cloud CDN、Cloud Armor&lt;/li>
&lt;li>支援全球負載平衡（Premium Tier）&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>適用場景：需要進行應用層路由、SSL 終止，以及全球流量分配的 Web 應用程式。&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>Application Load Balancer 又可以再另外分為五種 (包含內、外網以及不同的 Region)：&lt;/p>
&lt;h4>Global external Application Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="global-external-application-load-balancer">&lt;/span>
&lt;a href="#global-external-application-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>將此負載平衡器用於具有全球分散用戶或多個區域的後端服務的外部 HTTP(S) 工作負載。 (官方建議使用)&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：全球外部應用程式負載平衡器&lt;/li>
&lt;li>縮寫：GLB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Global&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>與 GKE 相容，使用&lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api#gatewayclass"target="_blank" rel="noopener">閘道&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>或獨立 NEG&lt;/li>
&lt;li>支援先進的流量管理&lt;/li>
&lt;li>只能使用 &lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">Premium 等級的 Network Service&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>可以跨多個專案以及區域來存取後端&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/1.webp"
alt="Global external Application Load Balancer" width="250">&lt;figcaption>
&lt;p>Global external Application Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Classic Application Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="classic-application-load-balancer">&lt;/span>
&lt;a href="#classic-application-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>此負載平衡器在高階層中是全球性的。在 Premium 網路服務層，此負載平衡器提供多區域負載平衡，嘗試將流量引導至具有容量的最近的健康後端，並儘可能靠近使用者終止 HTTP(S) 流量。&lt;/p>
&lt;p>在 Standard 網路服務層中，此負載平衡器只能將流量分配到單一區域內的後端。(建議不要再使用該 LB)&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-1">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：經典應用程式負載平衡器&lt;/li>
&lt;li>縮寫：CLB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Global&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-1">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>與 GKE 相容，使用&lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api#gatewayclass"target="_blank" rel="noopener">閘道&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>、Ingress 或獨立 NEG&lt;/li>
&lt;li>可以選擇 &lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">Standard 或是 Premium 等級的 Network Service&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>可以跨多個區域來存取後端 (選擇 Standrad 不能用)&lt;/li>
&lt;li>有支援 Cloud CDN，但選擇 Standrad 則不能用&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/2.webp"
alt="Classic Application Load Balancer" width="250">&lt;figcaption>
&lt;p>Classic Application Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Regional external Application Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="regional-external-application-load-balancer">&lt;/span>
&lt;a href="#regional-external-application-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>此負載平衡器包含現有的經典應用程式負載平衡器， 以及先進的流量管理能力。
如果您只想從一個地理位置提供內容，請使用此負載平衡器。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-2">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：區域外部應用程式負載平衡器&lt;/li>
&lt;li>縮寫：ALB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Regional&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-2">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>與 GKE 相容，使用獨立 NEG&lt;/li>
&lt;li>支援先進的流量管理&lt;/li>
&lt;li>可以選擇 &lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">Standard 或是 Premium 等級的 Network Service&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>可以跨多個專案，但只能選擇該區域的資源 (且沒辦法接 Bucket)&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/3.webp"
alt="Regional external Application Load Balancer" width="250">&lt;figcaption>
&lt;p>Regional external Application Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Cross-Region internal Application Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="cross-region-internal-application-load-balancer">&lt;/span>
&lt;a href="#cross-region-internal-application-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>這是一個多區域負載平衡器，它基於開源 &lt;a href="https://www.envoyproxy.io/"target="_blank" rel="noopener">Envoy 代理&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>實現為託管服務。跨區域模式使您能夠將流量負載平衡到全球分佈的後端服務，包括確保流量定向到最近的後端的流量管理。此負載平衡器還具有高可用性。將後端放置在多個區域有助於避免單一區域故障。如果一個區域的後端發生故障，流量可以轉移到另一個區域。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-3">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-3" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：跨區域內部應用程式負載平衡器&lt;/li>
&lt;li>縮寫：Cross-Region internal ALB&lt;/li>
&lt;li>內部/外部：Internal&lt;/li>
&lt;li>區域：Global&lt;/li>
&lt;li>Load balancing scheme：INTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-3">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-3" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>始終可在全球範圍內訪問。 VPC 中任何 Google Cloud 區域的用戶端都可以將流量傳送到負載平衡器&lt;/li>
&lt;li>負載平衡器可以將流量傳送到任何區域的後端 (可以跨多個專案)&lt;/li>
&lt;li>自動故障轉移到同一或不同區域的健康後端&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/4.webp"
alt="Cross-Region internal Application Load Balancer" width="250">&lt;figcaption>
&lt;p>Cross-Region internal Application Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Regional internal Application Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="regional-internal-application-load-balancer">&lt;/span>
&lt;a href="#regional-internal-application-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>這是一個區域負載平衡器，它基於開源 &lt;a href="https://www.envoyproxy.io/"target="_blank" rel="noopener">Envoy 代理程式&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>作為託管服務實作。區域模式可確保所有用戶端和後端都來自指定區域，這在您需要區域合規性時很有幫助。此負載平衡器具備基於 HTTP(S)參數的豐富流量控制功能。負載平衡器配置完成後，它會自動指派 Envoy 代理程式來滿足您的流量需求。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-4">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-4" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：區域內部應用程式負載平衡器&lt;/li>
&lt;li>縮寫：ILB&lt;/li>
&lt;li>內部/外部：Internal&lt;/li>
&lt;li>區域：Regional&lt;/li>
&lt;li>Load balancing scheme：INTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-4">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-4" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>預設無法由不同 Region 進行訪問，需要額外開啟全球訪問設定&lt;/li>
&lt;li>負載平衡器只能將流量傳送到與負載平衡器的代理程式位於相同區域的後端 (可以跨多個專案)&lt;/li>
&lt;li>自動故障轉移到同一區域內的健康後端&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/5.webp"
alt="Regional internal Application Load Balancer" width="250">&lt;figcaption>
&lt;p>Regional internal Application Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>Proxy Network Load Balancer (PNLB) – 代理網路負載平衡器&lt;span class="hx:absolute hx:-mt-20" id="proxy-network-load-balancer-pnlb--代理網路負載平衡器">&lt;/span>
&lt;a href="#proxy-network-load-balancer-pnlb--%e4%bb%a3%e7%90%86%e7%b6%b2%e8%b7%af%e8%b2%a0%e8%bc%89%e5%b9%b3%e8%a1%a1%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>層級：第 4 層（L4）&lt;/li>
&lt;li>支援協定：TCP、SSL&lt;/li>
&lt;li>功能：
&lt;ol>
&lt;li>作為反向代理，終止 TCP 或 SSL 連線&lt;/li>
&lt;li>支援 SSL/TLS 終止（僅限 SSL Proxy 模式）&lt;/li>
&lt;li>可選擇全球（Premium Tier）或區域性（Standard Tier）部署&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>適用場景：需要處理加密的 TCP 流量，並在負載平衡器層級終止 SSL 的應用程式。&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>Proxy Network Load Balancer 又可以再另外分為五種 (包含內、外網以及不同的 Region)：&lt;/p>
&lt;h4>Global external Proxy Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="global-external-proxy-network-load-balancer">&lt;/span>
&lt;a href="#global-external-proxy-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>此負載平衡器適用於需要全球可用性和高效能的 TCP/SSL 應用程式。它支援使用 Zonal NEGs（包括 VM 和 GKE Pod）作為後端，並整合 Google Cloud Armor 進行安全防護。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-5">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-5" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：全球外部代理網路負載平衡器&lt;/li>
&lt;li>縮寫：Global Proxy NLB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Global&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-5">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-5" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>只能使用 &lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">Premium 等級的 Network Service&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>支援 TCP 和 SSL 協定&lt;/li>
&lt;li>支援 SSL/TLS 卸載&lt;/li>
&lt;li>支援使用 Zonal NEGs（包括 VM 和 GKE Pod）作為後端&lt;/li>
&lt;li>整合 Google Cloud Armor 進行 DDoS 防護&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/6.webp"
alt="Global external Proxy Network Load Balancer" width="250">&lt;figcaption>
&lt;p>Global external Proxy Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Classic Proxy Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="classic-proxy-network-load-balancer">&lt;/span>
&lt;a href="#classic-proxy-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>此負載平衡器適用於現有使用傳統實例群組（Instance Groups）的應用程式。在 Premium 網路服務層中，它可以作為全球性的負載平衡器；在 Standard 網路服務層中，僅限於區域性部署。它支援 TCP 和 SSL 協定，並支援 SSL/TLS 卸載。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-6">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：經典代理網路負載平衡器&lt;/li>
&lt;li>縮寫：Classic Proxy NLB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Global&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-6">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>可以選擇 &lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">Standard 或是 Premium 等級的 Network Service&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>支援 TCP 和 SSL 協定&lt;/li>
&lt;li>支援 SSL/TLS 卸載&lt;/li>
&lt;li>支援使用傳統實例群組作為後端&lt;/li>
&lt;li>在 Premium Tier 中可作為全球性負載平衡器，在 Standard Tier 中僅限於區域性部署&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/7.webp"
alt="Classic Proxy Network Load Balancer" width="250">&lt;figcaption>
&lt;p>Classic Proxy Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Regional external Proxy Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="regional-external-proxy-network-load-balancer">&lt;/span>
&lt;a href="#regional-external-proxy-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>此負載平衡器適用於需要在單一區域內處理 TCP 流量的應用程式。它在該區域內提供外部 IP，並將進來的 TCP 流量轉發至後端服務。此負載平衡器支援 TCP 協定，並可選擇使用 Premium 或 Standard 網路服務層級。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-7">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：區域外部代理網路負載平衡器&lt;/li>
&lt;li>縮寫：Regional Proxy NLB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Regional&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-7">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>可以選擇 &lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">Standard 或是 Premium 等級的 Network Service&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/li>
&lt;li>支援 TCP 協定&lt;/li>
&lt;li>支援使用 Compute Engine 虛擬機（VM）作為後端服務&lt;/li>
&lt;li>相較於全球性負載平衡器，區域性負載平衡器的成本較低，適合預算有限的應用程式&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/8.webp"
alt="Regional external Proxy Network Load Balancer" width="250">&lt;figcaption>
&lt;p>Regional external Proxy Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Cross-Region internal Proxy Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="cross-region-internal-proxy-network-load-balancer">&lt;/span>
&lt;a href="#cross-region-internal-proxy-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>這是一個多區域負載平衡器，它基於開源 &lt;a href="https://www.envoyproxy.io/"target="_blank" rel="noopener">Envoy 代理&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>實現為託管服務。跨區域模式可讓您將流量負載平衡到全球分佈的後端服務，包括確保流量定向到最近的後端的流量管理。此負載平衡器還具有高可用性。將後端放置在多個區域有助於避免單一區域故障。如果一個區域的後端發生故障，流量可以轉移到另一個區域。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-8">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：跨區域內部代理網路負載平衡器&lt;/li>
&lt;li>縮寫：Cross-Region internal Proxy NLB&lt;/li>
&lt;li>內部/外部：Internal&lt;/li>
&lt;li>區域：Global&lt;/li>
&lt;li>Load balancing scheme：INTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 SSL：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-8">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>始終可在全球範圍內訪問。 VPC 中任何 Google Cloud 區域的用戶端都可以將流量傳送到負載平衡器&lt;/li>
&lt;li>負載平衡器可以將流量傳送到任何區域的後端&lt;/li>
&lt;li>自動故障轉移到同一或不同區域的健康後端&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/9.webp"
alt="Cross-Region internal Proxy Network Load Balancer" width="250">&lt;figcaption>
&lt;p>Cross-Region internal Proxy Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Regional internal Proxy Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="regional-internal-proxy-network-load-balancer">&lt;/span>
&lt;a href="#regional-internal-proxy-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>這是一個區域負載平衡器，它基於開源 &lt;a href="https://www.envoyproxy.io/"target="_blank" rel="noopener">Envoy 代理程式&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>作為託管服務實作。區域模式可確保所有用戶端和後端都來自指定區域，這在您需要區域合規性時很有幫助。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-9">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：區域內部代理網路負載平衡器&lt;/li>
&lt;li>縮寫：Regional internal Proxy NLB&lt;/li>
&lt;li>內部/外部：Internal&lt;/li>
&lt;li>區域：Regional&lt;/li>
&lt;li>Load balancing scheme：INTERNAL_MANAGED&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-9">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>預設無法由不同 Region 進行訪問，需要額外開啟全球訪問設定&lt;/li>
&lt;li>負載平衡器只能將流量傳送到與負載平衡器的代理程式位於相同區域的後端&lt;/li>
&lt;li>自動故障轉移到同一區域內的健康後端&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/10.webp"
alt="Regional internal Proxy Network Load Balancer" width="250">&lt;figcaption>
&lt;p>Regional internal Proxy Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>Passthrough Network Load Balancer (NLB) – 直通網路負載平衡器&lt;span class="hx:absolute hx:-mt-20" id="passthrough-network-load-balancer-nlb--直通網路負載平衡器">&lt;/span>
&lt;a href="#passthrough-network-load-balancer-nlb--%e7%9b%b4%e9%80%9a%e7%b6%b2%e8%b7%af%e8%b2%a0%e8%bc%89%e5%b9%b3%e8%a1%a1%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>層級：第 4 層（L4）&lt;/li>
&lt;li>支援協定：TCP、UDP、ESP、GRE、ICMP、ICMPv6 等&lt;/li>
&lt;li>功能：
&lt;ol>
&lt;li>不終止連線，將流量直接傳遞給後端&lt;/li>
&lt;li>保留原始封包資訊（來源 IP、目的地 IP 等）&lt;/li>
&lt;li>僅支援區域性部署&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>適用場景：需要低延遲、高效能，並保留原始封包資訊的內部服務，如資料庫、內部微服務通訊等。&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>Passthrough Network Load Balancer 主要分為兩種 (內、外網)：&lt;/p>
&lt;h4>External passthrough Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="external-passthrough-network-load-balancer">&lt;/span>
&lt;a href="#external-passthrough-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>這是一種區域性的第 4 層（L4）負載平衡器，將來自網際網路的流量分配至同一區域內的後端服務。它不進行代理或 SSL/TLS 卸載，並保留原始的客戶端 IP 位址。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-10">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-10" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：外部直通網路負載平衡器&lt;/li>
&lt;li>縮寫：External NLB&lt;/li>
&lt;li>內部/外部：Public facing (external)&lt;/li>
&lt;li>區域：Regional&lt;/li>
&lt;li>Load balancing scheme：EXTERNAL&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：✅&lt;/li>
&lt;li>是否支援 SSL：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-10">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-10" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>支援 TCP、UDP、ESP、GRE、ICMP 和 ICMPv6 等協定&lt;/li>
&lt;li>保留原始客戶端 IP 位址，適用於需要此資訊的應用程式&lt;/li>
&lt;li>支援使用區域性的後端服務或目標集（Target Pool）作為後端&lt;/li>
&lt;li>可與 Google Cloud Armor 整合，提供進階的 DDoS 防護&lt;/li>
&lt;li>支援 IPv4 和 IPv6 流量&lt;/li>
&lt;li>適用於需要低延遲和高效能的應用場景&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/11.webp"
alt="External passthrough Network Load Balancer" width="200">&lt;figcaption>
&lt;p>External passthrough Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h4>Internal passthrough Network Load Balancer&lt;span class="hx:absolute hx:-mt-20" id="internal-passthrough-network-load-balancer">&lt;/span>
&lt;a href="#internal-passthrough-network-load-balancer" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>這是一種區域性的第 4 層（L4）負載平衡器，將流量分配至同一 VPC 網路內的後端服務。它僅在內部網路中運作，適用於內部服務之間的通訊。&lt;/p>
&lt;h5>資訊&lt;span class="hx:absolute hx:-mt-20" id="資訊-11">&lt;/span>
&lt;a href="#%e8%b3%87%e8%a8%8a-11" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>中文：內部直通網路負載平衡器&lt;/li>
&lt;li>縮寫：Internal NLB&lt;/li>
&lt;li>內部/外部：Internal&lt;/li>
&lt;li>區域：Regional&lt;/li>
&lt;li>Load balancing scheme：INTERNAL&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/cdn"target="_blank" rel="noopener">Cloud CDN&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/security/products/armor"target="_blank" rel="noopener">Cloud Armor&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/service-lb-policy"target="_blank" rel="noopener">Service load balancing policy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;li>是否支援 SSL：❌&lt;/li>
&lt;li>是否支援 &lt;a href="https://cloud.google.com/load-balancing/docs/tcp/setting-up-tcp#proxy-protocol"target="_blank" rel="noopener">PROXY protocol&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>：❌&lt;/li>
&lt;/ul>
&lt;br>
&lt;h5>特點&lt;span class="hx:absolute hx:-mt-20" id="特點-11">&lt;/span>
&lt;a href="#%e7%89%b9%e9%bb%9e-11" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h5>&lt;ul>
&lt;li>支援 TCP、UDP、ICMP、ICMPv6、SCTP、ESP、AH 和 GRE 等協定&lt;/li>
&lt;li>保留原始客戶端 IP 位址，適用於需要此資訊的內部應用程式&lt;/li>
&lt;li>支援使用區域性的後端服務作為後端&lt;/li>
&lt;li>可作為靜態路由的下一跳，實現更靈活的流量控制&lt;/li>
&lt;li>支援與 Service Directory 整合，方便服務發現與管理&lt;/li>
&lt;li>適用於需要高效能和低延遲的內部服務通訊&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-lb-introduce/12.webp"
alt="Internal passthrough Network Load Balancer" width="250">&lt;figcaption>
&lt;p>Internal passthrough Network Load Balancer&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>總結&lt;span class="hx:absolute hx:-mt-20" id="總結">&lt;/span>
&lt;a href="#%e7%b8%bd%e7%b5%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>負載平衡器類型&lt;/th>
&lt;th>層級&lt;/th>
&lt;th>協定&lt;/th>
&lt;th>功能&lt;/th>
&lt;th>適用場景&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Application Load Balancer (ALB)&lt;/td>
&lt;td>L7&lt;/td>
&lt;td>HTTP, HTTPS&lt;/td>
&lt;td>基於內容的路由、SSL/TLS 終止、整合 Cloud CDN 和 Cloud Armor&lt;/td>
&lt;td>Web 應用程式需要應用層路由和 SSL 終止&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Proxy Network Load Balancer (PNLB)&lt;/td>
&lt;td>L4&lt;/td>
&lt;td>TCP, SSL&lt;/td>
&lt;td>反向代理、SSL/TLS 終止&lt;/td>
&lt;td>處理加密的 TCP 流量，並在負載平衡器層級終止 SSL 的應用程式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Passthrough Network Load Balancer (NLB)&lt;/td>
&lt;td>L4&lt;/td>
&lt;td>TCP, UDP, ESP, GRE, ICMP 等&lt;/td>
&lt;td>不終止連線，保留原始封包資訊&lt;/td>
&lt;td>低延遲、高效能的內部服務，如資料庫、內部微服務通訊等&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Network Service Tiers：&lt;a href="https://cloud.google.com/network-tiers?hl=zh-tw"target="_blank" rel="noopener">https://cloud.google.com/network-tiers?hl=zh-tw&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>External Application Load Balancer：&lt;a href="https://cloud.google.com/load-balancing/docs/https"target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/https&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Internal Application Load Balancer：&lt;a href="https://cloud.google.com/load-balancing/docs/l7-internal"target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/l7-internal&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Proxy Network Load Balancer：&lt;a href="https://cloud.google.com/load-balancing/docs/proxy-network-load-balancer"target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/proxy-network-load-balancer&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Internal proxy Network Load Balancer：&lt;a href="https://cloud.google.com/load-balancing/docs/tcp/internal-proxy"target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/tcp/internal-proxy&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Passthrough Network Load Balancer：&lt;a href="https://cloud.google.com/load-balancing/docs/passthrough-network-load-balancer"target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/passthrough-network-load-balancer&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Internal passthrough Network Load Balancer：&lt;a href="https://cloud.google.com/load-balancing/docs/internal"target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/internal&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>GCS Bucket CORS 錯誤解決方法</title><link>https://pin-yi.me/blog/gcp/gcs-cors/</link><pubDate>Tue, 18 Mar 2025 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gcs-cors/</guid><description>
&lt;p>最近公司有需求需要透過前端去打 GCS Bucket 的檔案，但會遇到 CORS 錯誤，所以寫一篇來記錄此問題的解決方法。&lt;/p>
&lt;br>
&lt;p>有先簡單寫一個前端頁面，可以透過 Axios 去打後端，詳細程式可以&lt;a href="https://github.com/880831ian/gcs-cors"target="_blank" rel="noopener">點我查看&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，我們也另外建立一個公開的 GCS Bucket，並放一個測試用的 JSON 檔案
(都有附在此專案中)。&lt;/p>
&lt;br>
&lt;ul>
&lt;li>公開的 GCS Bucket URL 及內容 (bucket 會用 ian-test-demo 來示範，請自行修改成自己的 bucket 名稱)&lt;/li>
&lt;/ul>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/1.webp"
alt="curl 測試" width="550">&lt;figcaption>
&lt;p>curl 測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>使用測試程式需要先做以下步驟：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>執行 &lt;code>cd code; docker build -t gcs-cors-test .&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>執行 &lt;code>docker run -d -p 8080:80 --name gcs-cors-test gcs-cors-test&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>開啟瀏覽器 &lt;code>127.0.0.1:8080&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>開啟後，我們輸入剛剛公開 GCS Bucket URL 到輸入欄位，開啟 F12 Network，並按下測試&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/2.webp"
alt="使用程式來測試" width="550">&lt;figcaption>
&lt;p>使用程式來測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>就會發現，出現 CORS error 錯誤，我們可以查看下方的錯誤說明&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/3.webp"
alt="發現 CORS 錯誤" width="550">&lt;figcaption>
&lt;p>發現 CORS 錯誤&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>因為我們從 http://localhost:8080 要打到 &lt;a href="https://storage.googleapis.com/ian-test-demo/hello.json"target="_blank" rel="noopener">https://storage.googleapis.com/ian-test-demo/hello.json&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> ，觸發了瀏覽器的 CORS 限制，所以導致噴錯，CORS 的說明詳細可以直接參考：&lt;a href="https://www.explainthis.io/zh-hant/swe/what-is-cors"target="_blank" rel="noopener">https://www.explainthis.io/zh-hant/swe/what-is-cors&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;p>那要怎麼解決呢，&lt;a href="https://cloud.google.com/storage/docs/using-cors#command-line"target="_blank" rel="noopener">根據 Google 文件&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，我們需要為 Bucket 配置 cors 設定&lt;/p>
&lt;br>
&lt;p>我們可以先下此指令來查看該 bucket 是否有設定 cors： &lt;code>gcloud storage buckets describe gs://ian-test-demo --format=&amp;quot;default(cors_config)&amp;quot;&lt;/code>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/4.webp"
alt="gcloud 指令查看 cors 設定" width="550">&lt;figcaption>
&lt;p>gcloud 指令查看 cors 設定&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>如果還沒設定就會顯示 null&lt;/p>
&lt;br>
&lt;p>那我們先來寫一下 cors 的設定檔案&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;origin&amp;#34;&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;method&amp;#34;&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;GET&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;POST&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;PUT&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;DELETE&amp;#34;&lt;/span>],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;responseHeader&amp;#34;&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;Content-Type&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Authorization&amp;#34;&lt;/span>],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;maxAgeSeconds&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">30&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>]&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>(可以再根據自己需求去調整，先以這樣來 demo)&lt;/p>
&lt;br>
&lt;p>寫完後，我們需要設定到 Bucket 上面，可以用此指令將 cors.json 設定到指定的 Bucket 上：&lt;code>gcloud storage buckets update gs://ian-test-demo --cors-file=cors.json&lt;/code>&lt;/p>
&lt;p>下完指令後，我們可以在用 describe 來確認是否設定完成，正常會如下顯示：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/5.webp"
alt="設定及檢查" width="550">&lt;figcaption>
&lt;p>設定及檢查&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>接著我們就可以來測試看看是否還會碰到 CORS error 的問題了&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/6.webp"
alt="再次使用前端程式測試" width="550">&lt;figcaption>
&lt;p>再次使用前端程式測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>另外，如果不需要設定 CORS 時，可以用以下指令移除該 Bucket 的 CORS 設定：&lt;code>gcloud storage buckets update gs://ian-test-demo --clear-cors&lt;/code>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcs-cors/7.webp"
alt="移除 CORS 設定" width="550">&lt;figcaption>
&lt;p>移除 CORS 設定&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考&lt;span class="hx:absolute hx:-mt-20" id="參考">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://cloud.google.com/storage/docs/using-cors#command-line"target="_blank" rel="noopener">Set up and view CORS configurations&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://cloud.google.com/storage/docs/cors-configurations"target="_blank" rel="noopener">CORS configuration examples&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>如何為 CI/CD 配置 GCP Artifact Registry 的 Docker 認證</title><link>https://pin-yi.me/blog/gcp/gcp-artifact-registry-docker-auth/</link><pubDate>Thu, 26 Dec 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gcp-artifact-registry-docker-auth/</guid><description>
&lt;h2>說明&lt;span class="hx:absolute hx:-mt-20" id="說明">&lt;/span>
&lt;a href="#%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>當我們在 CI 階段，會將打包的 image 丟到 Repositories，我們選擇 GCP 的 Artifact Registry，就會需要有 GCP 相關權限，可以推到 Repositories 上。&lt;/p>
&lt;br>
&lt;p>那我們通常會有兩種做法：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>使用 gcloud 的 image，並在 GitLab CICD Variables 塞入對應的 SA Key (當然要給他能上傳 Artifact Registry 權限)，但這個方法在跑 CI 時，會需要拉 gcloud 的 image 會比較花時間。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>先產生好已經驗證過的 &lt;code>$HOME/.docker/config.json&lt;/code>，也放到 GitLab CICD Variables，讓 CI 動作時，可以拿來驗證可以直接 push 到 Repositories 上。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>(當然還有第三種方式，之後再來介紹)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>那我們這篇就來說明第二種方式，要怎麼產生 &lt;code>$HOME/.docker/config.json&lt;/code> 來驗證呢？&lt;/p>
&lt;p>如果本機有 Docker 可以先看看自己檔案內容，應該會長得像下面這樣&lt;/p>
&lt;br>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auths&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;asia-east1-docker.pkg.dev&amp;#34;&lt;/span>: {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;credsStore&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;desktop&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;credHelpers&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;asia-docker.pkg.dev&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;asia-east1-docker.pkg.dev&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;asia.gcr.io&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;gcr.io&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;marketplace.gcr.io&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;staging-k8s.gcr.io&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;us.gcr.io&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;currentContext&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;desktop-linux&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>可以看到 &lt;code>auths&lt;/code> 的 &lt;code>asia-east1-docker.pkg.dev&lt;/code> 是空的，然後在下面有 &lt;code>credHelpers&lt;/code> &lt;code>&amp;quot;asia-east1-docker.pkg.dev&amp;quot;: &amp;quot;gcloud&amp;quot;,&lt;/code> 就代表 Docker 在嘗試連接這些 Registry 時，會通過 gcloud 命令行工具來生成和管理憑證，但這樣又會需要使用 gcloud 來驗證 QQ&lt;/p>
&lt;br>
&lt;p>因此我們需要自己來打造我們的 Config xDD，我們要先準備好有權限的 SA Key，如下：
(有將其中 Key 以及 project 亂改了，不用擔心)&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;service_account&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;project_id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcp-20435107-111&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;private_key_id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;096bd873ba49ba348946eff2202199330fd89fbb&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;private_key&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiZ+MUvg\n9xqkVFzKpjrEE2o/L5c7XeciSoAvAF757WFWXJvPWyG48LWNE5PGy+kXo0TBWBm7\n96pgugJVAgMBAAECggEAJTTBRiRSd2Wv6T0HLolqX1xDgU6SFL7bEtub+mtq7C2b\naInTkGe8Iol0VDbysFbAEx/wQpK5a2RPUQK/QHVCkMiV13yX75OTFl3IRMoqRjmT\nHhg88ncpY4yVmUuR0dSY9asdP4hIupSe9SYq58Uu6f8wE1UhzoF6k3SsxuePKU1K7EPG3UPtFIwvc2zS0du7h\n49WUrZkzLwf/HvfUAfmbio0JdY+wEzN4lgdYD1ApEQKBgQDx4s5Znp3YBuI1rafP\n0Hrdu/5dtM1rSSP4LA6+C97fGj3N4KC1hh+6rVmr2xC3YTnhYv1uaVsbbV676Ssr\n2fBYNNqbLfzMkip4TPhg7g/rggihj5uhtui3rgyicgbgyiy\n1oJNVzYR2Q4Ay8RAne1eqdyFfQKBgQC32mKIIDBjGk/B/4g1TXEnJYJuarM72ast\nlUnvoI42FK/RJdepDdh6b+EhvAgTQD0CuJO8FE2L6/lf+LglJAzJEC8ua3PWZrS6\n2tUGd56Om9GVAtbGhvDrCprPXtN4o0ouqfRXCiKCTF0jip6t9WoCETXjvrQYN5JN\nP7WKmL2nuQKBgQDkrS20YFaNkwRtBv2tZEWkN0SlRnclxIHy74QIe6R6e46Ogpys\nwF5i19v8syA8nfhgcntx1LzDU0TKlgewb1vfqCg7qOBkbpMkJHB1AtuE+Fzr4xgi\nAyglexLgvro9o2LPbVBUPlVE5en7YVvidvm9MIP3n6KzcfDZvfRZGHFY6QKBgQCT\n7kfxt9S3KOib8/uox9MP6IJ2TaxBr/aoCsMe6FUE9sgwxP4trFJO0c6X0i+9Labp\nlZJpdvyeZRSWQA4K9GLFNRyBgTwHe0RYRNO7DGyr2nxcJZiizNj0hefiiy4kl16N\nBXrwvdredItMmbDrz9eoKijuQvettKknNuffyN5xIQKBgCe++4G6OVW6LxrY+ggm\nxRGb5p55b7RPkj2Sr1OtqsOA1PDffuBjmowOQ9atwaMotV38vFU2tMEN1A2HCtaR\n4a01Heg1jiCHyZ7KgAxkvzovxcm8KQEtgDfRKj7/5b0BWubRb5tc+yGFOiLMShRD\nBjqH9JHeNGTn5BkrcH+mWSs7\n-----END PRIVATE KEY-----\n&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;client_email&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;aaa-test@gcp-20435107-111.iam.gserviceaccount.com&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;client_id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;102880852862346945795&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auth_uri&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;https://accounts.google.com/o/oauth2/auth&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;token_uri&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;https://oauth2.googleapis.com/token&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auth_provider_x509_cert_url&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;https://www.googleapis.com/oauth2/v1/certs&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;client_x509_cert_url&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;https://www.googleapis.com/robot/v1/metadata/x509/ian-test%40gcp-20435107-111.iam.gserviceaccount.com&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;universe_domain&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;googleapis.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>使用 Token 來產生 Docker Config&lt;span class="hx:absolute hx:-mt-20" id="使用-token-來產生-docker-config">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-token-%e4%be%86%e7%94%a2%e7%94%9f-docker-config" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>
&lt;p>在本機下 &lt;code>gcloud auth activate-service-account --key-file=&amp;lt;檔案名稱&amp;gt;&lt;/code>，先將自己電腦的 gcloud 切換成 SA 帳號&lt;/p>
&lt;/li>
&lt;li>
&lt;p>接著我們把 token 印出來 (已經刪除其中 token 內容)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gcloud auth print-access-token
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ya29.c.c0ASRK0GZLLHHYbVgq_fzR2cIC01O9V-gUDB8Wxmt8X71SHEwYvDbFm4Pw4Y6snMS1XG2_a4M0-bY8cIV8tNnUCRv0Yxb-a38AJWLnreGpBj0fKMAsELhMSnQE1TRkdUiaLj4GV4JDXWROfYtBzGiqxeK89ZyzHGOpc4x0n_41ZBImgR8S1BhFQATYiFID7tqtuVdogZ2Ud74uOhZVvbicm86W_8hS4kipb8yyfF-IQ4uYuvXw4RrzRd9tuc5a_U7t5mWy7sfY1ZWbh3lkjfakxenRgqlVt6Xaj2SBiyYpaOBVuVjVynXtkS2gMBcIcdpkOehbZMU_t8MVBuUqst4Fm8iBQXrhROfgcQslnwhi2wWWyZWs7-VBaMO2mzkh2rFwyF9Fgzhw8spMt_XO4jn9R5zMe-IMB7fltyjvQx319dJBBQYX3eZJhzpJ36d-Brpgkb604mx8z_QtIIg5nBerR-g_avSptzRYk4e9QVz_xJdQmMSk7ojM0VY0wUXzUxFzBVgIsinq-hIeIgaIo6ld0b5I28qzIXzuj9nVdM2J5rfro6puVvydu45YeO1hntfzB7o65fBe8beFmUwuj5jI2XjimJkxv44JyZSY_JFv-lJQlz6uYt46cBboa0VcSW3l2YxWIoF-m9i&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="3">
&lt;li>然後下以下指令，把上面拿到的 token 塞入，並轉成 base64 (前面要多帶 oauth2accesstoken:)&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>echo -n &lt;span style="color:#e6db74">&amp;#34;oauth2accesstoken:&amp;lt;token&amp;gt;&amp;#34;&lt;/span> | base64&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="4">
&lt;li>最後將這串經過 base64 的字串，帶入 Docker config 中&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auths&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;asia-east1-docker.pkg.dev&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auth&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;base64 後的 token&amp;gt;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就完成啦！只是這個 token 會有個缺點，它有一小時的有效期限，所以拿來當 CI 專用的 Cofing 不太適合。&lt;/p>
&lt;br>
&lt;h2>使用 SA Key 來產生 Docker Config&lt;span class="hx:absolute hx:-mt-20" id="使用-sa-key-來產生-docker-config">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-sa-key-%e4%be%86%e7%94%a2%e7%94%9f-docker-config" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>
&lt;p>在本機下 &lt;code>printf &amp;quot;_json_key:%s&amp;quot; &amp;quot;$(cat &amp;lt;key 的檔案&amp;gt;)&amp;quot; | base64&lt;/code>，將 SA Key 帶入，並轉成 base64 (前面改帶 &lt;code>_json_key:&lt;/code>)&lt;/p>
&lt;p>(為什麼要用 printf 是因為如果本機是用 zsh echo 會把 Key 裡面的 \n 直接換行，就會導致憑證出現問題)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="2">
&lt;li>接著把這串字串，帶入 Docker Config 中產生的 base64，在放到底下的 JSON 裡面&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auths&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;asia-east1-docker.pkg.dev&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;auth&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;base64 後的 token&amp;gt;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就完成啦！這個方式就不會有時間限制的問題，可以直接放到 CI/CD 裡面使用。&lt;/p></description></item><item><title>Google Kubernetes Engine Local ephemeral storage 計算方式</title><link>https://pin-yi.me/blog/gcp/gke-local-ephemeral-storage/</link><pubDate>Mon, 02 Sep 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-local-ephemeral-storage/</guid><description>
&lt;p>此文章主要針對 Google Kubernetes Engine Local ephemeral storage 的計算方式來做介紹。&lt;/p>
&lt;br>
&lt;h2>前情提要&lt;span class="hx:absolute hx:-mt-20" id="前情提要">&lt;/span>
&lt;a href="#%e5%89%8d%e6%83%85%e6%8f%90%e8%a6%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>為什麼會突然在看這個主題呢？&lt;/p>
&lt;p>主要是這幾天在優化自己 GKE 的 Node Pool 規格時，原先是開 e2-standard-2 / 100GB 的 node，數量是 8 ~ 12 顆 node (透過自動擴展)，改成 n2-standard-4 / 100GB 的 node，數量是 6 ~ 10 顆 node (透過自動擴展)。&lt;/p>
&lt;p>發現明明 CPU/MEM 資源都夠且更多，但 node 數量卻還是跟原始規格一樣長到 9 顆，使用 Cloud logging 來查看 &lt;code>unschedulable&lt;/code>，發現與 Local ephemeral storage 有關，因此就來了解一下 Local ephemeral storage 是如何計算的。&lt;/p>
&lt;br>
&lt;p>我們在 Cloud Logging 用以下指令來查看為何 node 會需要長新的，而不是進到還有資源的 node 上：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>unschedulable
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>severity&lt;span style="color:#f92672">=&lt;/span>WARNING
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;ephemeral-storage&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-local-ephemeral-storage/1.webp"
alt="Cloud Logging 查詢結果" width="750">&lt;figcaption>
&lt;p>Cloud Logging 查詢結果&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到是因為 Local ephemeral storage 不足，導致無法排程，才會長新的 node。&lt;/p>
&lt;p>但這個很奇怪，我們明明建立了 100GB 的 node，為什麼會不足呢？而且我們還是開 spot instance，理論上 node 會被收回，node disk 也會被清空，所以不應該會出現這個問題才對。&lt;/p>
&lt;p>因此我們就先來了解 Local ephemeral storage 是如何計算的。&lt;/p>
&lt;br>
&lt;h2>Local ephemeral storage 計算方式&lt;span class="hx:absolute hx:-mt-20" id="local-ephemeral-storage-計算方式">&lt;/span>
&lt;a href="#local-ephemeral-storage-%e8%a8%88%e7%ae%97%e6%96%b9%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>根據官方文件 &lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/plan-node-sizes#local_ephemeral_storage_reservation"target="_blank" rel="noopener">Local ephemeral storage reservation&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，我們可以知道 GKE 會為每個 node 提供本地的臨時儲存空間，當這個儲存空間在 node 故障刪除時，資料也會被一起遺失。&lt;/p>
&lt;p>GKE 會依照下列的方式計算本機預留的暫存空間，也就是被偷走的空間 /ᐠ .ᆺ. ᐟ\ﾉ：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>EVICTION_THRESHOLD &amp;#43; SYSTEM_RESERVATION&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>EVICTION_THRESHOLD&lt;/code> 是驅逐閾值 ; &lt;code>SYSTEM_RESERVATION&lt;/code> 是系統保留空間。&lt;/p>
&lt;br>
&lt;h3>EVICTION_THRESHOLD 驅逐閥值計算&lt;span class="hx:absolute hx:-mt-20" id="eviction_threshold-驅逐閥值計算">&lt;/span>
&lt;a href="#eviction_threshold-%e9%a9%85%e9%80%90%e9%96%a5%e5%80%bc%e8%a8%88%e7%ae%97" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>在預設情況下，臨時儲存空間是由開機磁碟的大小來決定的，驅逐閾值是開機磁碟大小的 10%。&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>EVICTION_THRESHOLD = 10% * BOOT_DISK_CAPACITY&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>SYSTEM_RESERVATION 系統保留空間計算&lt;span class="hx:absolute hx:-mt-20" id="system_reservation-系統保留空間計算">&lt;/span>
&lt;a href="#system_reservation-%e7%b3%bb%e7%b5%b1%e4%bf%9d%e7%95%99%e7%a9%ba%e9%96%93%e8%a8%88%e7%ae%97" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>系統保留空間也跟開機磁碟大小有關：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>SYSTEM_RESERVATION = Min(50% * BOOT_DISK_CAPACITY, 6GiB &amp;#43; 35% * BOOT_DISK_CAPACITY, 100 GiB)&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>會計算 &lt;code>50% * BOOT_DISK_CAPACITY&lt;/code>、&lt;code>6GiB + 35% * BOOT_DISK_CAPACITY&lt;/code>、 &lt;code>100 GiB&lt;/code> 三者中的最小值。奇怪的計算方式 (*´･д･)?。&lt;/p>
&lt;br>
&lt;h3>計算可用空間&lt;span class="hx:absolute hx:-mt-20" id="計算可用空間">&lt;/span>
&lt;a href="#%e8%a8%88%e7%ae%97%e5%8f%af%e7%94%a8%e7%a9%ba%e9%96%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>最後將開機磁碟大小減去 &lt;code>EVICTION_THRESHOLD&lt;/code> 與 &lt;code>SYSTEM_RESERVATION&lt;/code> 就可以得到可用空間：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>BOOT_DISK_CAPACITY - (EVICTION_THRESHOLD &amp;#43; SYSTEM_RESERVATION)&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>計算範例&lt;span class="hx:absolute hx:-mt-20" id="計算範例">&lt;/span>
&lt;a href="#%e8%a8%88%e7%ae%97%e7%af%84%e4%be%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>根據上面的公式我們可以知道 &lt;del>被偷走的空間有多少&lt;/del>，下面舉例兩個不同的開機磁碟大小來計算：&lt;/p>
&lt;ol>
&lt;li>開機磁碟大小 100GB&lt;/li>
&lt;/ol>
&lt;p>先計算 EVICTION_THRESHOLD：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>EVICTION_THRESHOLD = 10% * 100GB = 10GB&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>再計算 SYSTEM_RESERVATION：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>SYSTEM_RESERVATION = Min(50% * 100GB, 6GiB &amp;#43; 35% * 100GB, 100 GiB)
= Min(50GB, 6GiB &amp;#43; 35GB, 100GB)
= Min(50GB, 41GB, 100GB)
= 41GB&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>接著將 EVICTION_THRESHOLD 與 SYSTEM_RESERVATION 相加：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>EVICTION_THRESHOLD &amp;#43; SYSTEM_RESERVATION = 10GB &amp;#43; 41GB = 51GB&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就可以得出被偷走的空間為 51GB，代表我們建立 100GB 的開機磁碟時，實際上只有 49GB 空間可以使用。&lt;/p>
&lt;br>
&lt;ol start="2">
&lt;li>開機磁碟大小 300GB&lt;/li>
&lt;/ol>
&lt;p>先計算 EVICTION_THRESHOLD：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>EVICTION_THRESHOLD = 10% * 300GB = 30GB&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>再計算 SYSTEM_RESERVATION：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>SYSTEM_RESERVATION = Min(50% * 300GB, 6GiB &amp;#43; 35% * 300GB, 100 GiB)
= Min(150GB, 6GiB &amp;#43; 105GB, 100GB)
= Min(150GB, 111GB, 100GB)
= 100GB&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>接著將 EVICTION_THRESHOLD 與 SYSTEM_RESERVATION 相加：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;pre>&lt;code>EVICTION_THRESHOLD &amp;#43; SYSTEM_RESERVATION = 30GB &amp;#43; 100GB = 130GB&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就可以得出被偷走的空間為 130GB，代表我們建立 300GB 的開機磁碟時，實際上只有 170GB 可以使用。&lt;/p>
&lt;br>
&lt;p>了解計算方式後，那為什麼會出現 Local ephemeral storage 不足的問題呢？&lt;/p>
&lt;p>後來發現，因為我的多數服務都會使用 gcsfuse 掛載 GCS bucket，而 gcsfuse 預設 ephemeral storage request 會使用 5GB，所以以 100 GB 的開機磁碟，我一個 node 只要超過 9 個 Pod，就會導致 Local ephemeral storage 不足的問題。詳細就請參考：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/cloud-storage-fuse-csi-driver#sidecar-container-resources"target="_blank" rel="noopener">Configure resources for the sidecar container&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;h2>哪裡可以查看 Local ephemeral storage 使用量？&lt;span class="hx:absolute hx:-mt-20" id="哪裡可以查看-local-ephemeral-storage-使用量">&lt;/span>
&lt;a href="#%e5%93%aa%e8%a3%a1%e5%8f%af%e4%bb%a5%e6%9f%a5%e7%9c%8b-local-ephemeral-storage-%e4%bd%bf%e7%94%a8%e9%87%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>可以從 GKE 的 Node Pool UI 介面查看：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-local-ephemeral-storage/2.webp"
alt="GKE Node Pool 頁面" width="450">&lt;figcaption>
&lt;p>GKE Node Pool 頁面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到實際上 101.2 GB 的 node，可用空間只有 47.06 GB，與我們上面的計算方式差不多。&lt;/p>
&lt;ol start="2">
&lt;li>可以透過 &lt;code>kubectl describe node&lt;/code> 來查看：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-local-ephemeral-storage/3.webp"
alt="kubectl describe node 頁面" width="400">&lt;figcaption>
&lt;p>kubectl describe node 頁面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>可以看到 Capacity ephemeral-storage: 98831908Ki，換算成 GB 大約是 101.19 GB。&lt;/p>
&lt;p>Allocatable ephemeral-storage: 47060071478，換算成 GB 大約是 47.06 GB。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-local-ephemeral-storage/4.webp"
alt="kubectl describe node 頁面" width="550">&lt;figcaption>
&lt;p>kubectl describe node 頁面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>也可以從 describe 看到目前 request ephemeral-storage 設定的大小，來避免 Local ephemeral storage 出現不足的問題。&lt;/p>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Local ephemeral storage reservation：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/plan-node-sizes#local_ephemeral_storage_reservation"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/concepts/plan-node-sizes#local_ephemeral_storage_reservation&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Configure resources for the sidecar container：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/cloud-storage-fuse-csi-driver#sidecar-container-resources"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/cloud-storage-fuse-csi-driver#sidecar-container-resources&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>GCP Prometheus Samples Ingested 計算方式及如何減少費用</title><link>https://pin-yi.me/blog/gcp/gcp-prometheus-sample-ingested-calculate/</link><pubDate>Wed, 10 Jul 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gcp-prometheus-sample-ingested-calculate/</guid><description>
&lt;p>最近在優化公司帳單費用，發現公司有幾個 project 裡面的 Prometheus Samples Ingested 費用很高，此文章會針對費用如何計算以及如何去減少費用來做說明。&lt;/p>
&lt;p>Prometheus Samples Ingested 就是 Prometheus 攝取的樣本數，因為上述幾個專案，我們都是使用 &lt;a href="https://cloud.google.com/stackdriver/docs/managed-prometheus"target="_blank" rel="noopener">Google Managed Prometheus (GMP)&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 的方式來接 Metrics，所以可以先推測是 Metrics 導致此費用增加。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/1.webp"
alt="Google 帳單 (project_1)" width="800">&lt;figcaption>
&lt;p>Google 帳單 (project_1)&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/2.webp"
alt="Google 帳單 (project_2)" width="800">&lt;figcaption>
&lt;p>Google 帳單 (project_2)&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>費用計算說明&lt;span class="hx:absolute hx:-mt-20" id="費用計算說明">&lt;/span>
&lt;a href="#%e8%b2%bb%e7%94%a8%e8%a8%88%e7%ae%97%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>首先我們先來計算一下費用是不是正確，Prometheus Samples Ingested 的 SKU 是 A4E4-DF03-CDB6，可以透過&lt;a href="https://cloud.google.com/skus/?currency=USD&amp;amp;filter=A4E4-DF03-CDB6&amp;amp;hl=en"target="_blank" rel="noopener">這個頁面&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>來查詢：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/3.webp"
alt="Google Cloud Platform SKUs" width="800">&lt;figcaption>
&lt;p>Google Cloud Platform SKUs&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>我們可以看到如果是 0 ~ 50,000,000,000 的 Samples，會以每 1,000,000/0.06 USD 來計算，其他以此類推，為了更方便的計算，我有簡單寫一個腳本來計算費用：&lt;/p>
&lt;ul>
&lt;li>calc_metrics.sh&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#! /bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> $# -ne &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;請使用： &lt;/span>$0&lt;span style="color:#e6db74"> &amp;lt;samples&amp;gt; 來計算費用&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> $1 &lt;span style="color:#f92672">=&lt;/span>~ &lt;span style="color:#f92672">[&lt;/span>a-zA-Z&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> number&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$1&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | sed -E &lt;span style="color:#e6db74">&amp;#39;s/([0-9]+(\.[0-9]+)?)\s*[a-zA-Z]+/\1/&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> unit&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$1&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | sed -E &lt;span style="color:#e6db74">&amp;#39;s/[0-9]+(\.[0-9]+)?\s*([a-zA-Z]+)/\2/&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> $unit in
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> K&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> factor&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ;;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> M&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> factor&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1000000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ;;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> B&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> factor&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1000000000&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ;;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> echo &lt;span style="color:#e6db74">&amp;#34;未知單位: &lt;/span>$unit&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ;;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">esac&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>printf &lt;span style="color:#e6db74">&amp;#34;%&amp;#39;d&amp;#34;&lt;/span> &lt;span style="color:#66d9ef">$(&lt;/span>printf &lt;span style="color:#e6db74">&amp;#34;%.0f&amp;#34;&lt;/span> &lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$number&lt;span style="color:#e6db74"> * &lt;/span>$factor&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | bc&lt;span style="color:#66d9ef">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result&lt;span style="color:#f92672">=&lt;/span>$1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;Samples：&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>result&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> | tr -d &lt;span style="color:#e6db74">&amp;#39;,&amp;#39;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span> -le &lt;span style="color:#ae81ff">50000000000&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cost&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;scale=2; &lt;/span>&lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74"> * 0.06 / 1000000&amp;#34;&lt;/span> | bc&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">elif&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span> -le &lt;span style="color:#ae81ff">250000000000&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cost&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;scale=2; &lt;/span>&lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74"> * 0.048 / 1000000&amp;#34;&lt;/span> | bc&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">elif&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> &lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span> -le &lt;span style="color:#ae81ff">500000000000&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>; &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cost&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;scale=2; &lt;/span>&lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74"> * 0.036 / 1000000&amp;#34;&lt;/span> | bc&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cost&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>echo &lt;span style="color:#e6db74">&amp;#34;scale=2; &lt;/span>&lt;span style="color:#e6db74">${&lt;/span>result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74"> * 0.024 / 1000000&amp;#34;&lt;/span> | bc&lt;span style="color:#66d9ef">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>echo &lt;span style="color:#e6db74">&amp;#34;費用：&lt;/span>$cost&lt;span style="color:#e6db74"> USD&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>我們分別帶入 project_1 (106,676,274,756) 以及 project_2 (66,631,967,760) 的 Samples 來計算看看金額是否正確。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/4.webp"
alt="用腳本檢查金額是否與帳單一樣" width="500">&lt;figcaption>
&lt;p>用腳本檢查金額是否與帳單一樣&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>計算完與實際的帳單費用差不多，接著我們可以打開 GCP 的 Metrics Management 來查看一下，我們用了哪些 Metrics 導致費用這麼高。&lt;/p>
&lt;p>以下以 project_1 為例：&lt;/p>
&lt;p>打開 &lt;a href="https://console.cloud.google.com/monitoring/metrics-management"target="_blank" rel="noopener">Metrics Management&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 後，將時間選擇前 30 天(30d)，與上面帳單選擇一樣，接著可以看到 Billable samples ingested 這邊，這裡就是指我們 30 天總共收了多少筆的 samples，也可以把他理解收了多少筆的 Metrics。也可以看到底下表格的 Samples billable volume 可以透過排序知道是誰使用最多。這邊的 B 代表 10 億，也就是 1000000000，所以我們上個月收了 1066 多億筆的 samples。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/5.webp"
alt="查看 Metrics Management" width="800">&lt;figcaption>
&lt;p>查看 Metrics Management&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以使用剛剛的腳本來計算 (沒錯，它也支援數字單位的轉換 xD)，計算如下：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/6.webp"
alt="查看 Metrics Management" width="550">&lt;figcaption>
&lt;p>查看 Metrics Management&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>所以可以得知，帳單 Prometheus Samples Ingested 這個 SKU 會這麼高就是這邊的 &lt;b>Billable samples ingested&lt;/b> 所導致，那我們現在可以依照下面的表格 Metrics 知道是哪個 Metrics 花錢最兇，在針對這些 Metrics 來進行調整，以達到減少費用的目的。&lt;/p>
&lt;br>
&lt;h2>如何減少花費&lt;span class="hx:absolute hx:-mt-20" id="如何減少花費">&lt;/span>
&lt;a href="#%e5%a6%82%e4%bd%95%e6%b8%9b%e5%b0%91%e8%8a%b1%e8%b2%bb" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們可以從上面的表中知道，是 &lt;code>phpfpm_process_state/gauge&lt;/code> 這個 metric，總共收了 30.71 B 也就是大約 1842.60 美元的花費是裡面最高的。所以我們就先這對如何減少這個 metric 來做說明：&lt;/p>
&lt;p>要先知道 &lt;code>phpfpm_process_state/gauge&lt;/code> 這個 metric 是怎麼來的呢？&lt;/p>
&lt;p>首先我們可以從 metric 名稱知道它是 phpfpm 的 process 狀態。我們有開啟 Cluster 的 Managed Service for Prometheus，來使用 Google 管理的 Prometheus (GMP)， 並在服務上面設定 &lt;code>phpfpm-exporter&lt;/code>，並使用 PodMonitoring 來將 Pod 上的 metrics 接到 GMP 上。&lt;/p>
&lt;p>所以我們可以先到有 phpfpm-exporter 的 Pod 隨意的 Container 去看看這個 metrics，下 &lt;code>curl -s 127.0.0.1:9253/metrics&lt;/code> 指令來查看 (請依照設定 port 去查看，這邊不詳細列出)，可以看到會有很多 phpfpm-exporter 的 metrics。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/7.webp"
alt="phpfpm-exporter metrics" width="600">&lt;figcaption>
&lt;p>phpfpm-exporter metrics&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>其中我們也可以找到 &lt;code>phpfpm_process_state&lt;/code> 這個 metrics，這邊我們發現一個比較特別的事情，一般的 metrics 都只有一筆，但 &lt;code>phpfpm_process_state&lt;/code> 它有 6 個狀態。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/8.webp"
alt="phpfpm-exporter metrics" width="600">&lt;figcaption>
&lt;p>phpfpm-exporter metrics&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>所以代表送到 GMP 的 metrics 也會比其他 phpfpm 相關的 metrics 還多 6 倍，這也可以解釋為什麼他是所有 metrics 裡面費用最高的，以及 &lt;code>phpfpm_process_state&lt;/code> 費用是其他 phpfpm 像是：&lt;code>phpfpm_process_request_duration&lt;/code> 的 6 倍了。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/9.webp"
alt="Metrics Management phpfpm metrics" width="600">&lt;figcaption>
&lt;p>Metrics Management phpfpm metrics&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>因此我們可以來計算一下費用，phpfpm_process_XXX 的 metrics 它會因為 process 的數量而改變，以 phpfpm_process_state 這個 metrics 來計算，計算公式就是：&lt;/p>
&lt;p>process 數量 * 6 (上面說的6個狀態) * Pod 數量 * PodMonitoring interval 的秒數&lt;/p>
&lt;p>(PodMonitoring interval 的秒數這個我們後續再說)&lt;/p>
&lt;br>
&lt;p>可以先看下圖，我們這個的 api 有 30 的 process，乘 6 個狀態，可以看到每次的搜集就會收集 180 筆的 &lt;code>phpfpm_process_state&lt;/code>。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/10.webp"
alt="phpfpm status" width="600">&lt;figcaption>
&lt;p>phpfpm status&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>我們也可以透過 GCP 的 Metrics explorer 查詢到對應的數值。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/11.webp"
alt="phpfpm status" width="700">&lt;figcaption>
&lt;p>phpfpm status&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>剛剛提到的 PodMonitoring interval 的秒數，在 project_1 的 PodMonitoring 設定間隔是 60s，所以上面才不需要另外乘，但像是 project_1 的秒數都是 5s，所以我們還需要再多乘上 12 (60/5) 才是我們在 GCP 的 Metrics explorer 看到每分鐘的數量。&lt;/p>
&lt;br>
&lt;p>因此，我們可以得知費用會跟 process (範例的 metrics)、裡面的 metrics 有幾個、Pod 數量、 PodMonitoring 間隔時間有關，跟 Google 的文件說明也是一樣的&lt;/p>
&lt;p>&lt;a href="https://cloud.google.com/stackdriver/pricing?hl=zh-tw#pricing_examples_samples"target="_blank" rel="noopener">https://cloud.google.com/stackdriver/pricing?hl=zh-tw#pricing_examples_samples&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/12.webp" width="700">
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/13.webp" width="700">
&lt;/figure>
&lt;br>
&lt;p>所以要減少費用，可以調整上述影響 metrics 數量的變因，另一種方式就是，針對需要收集哪些 metrics 來做過濾，可以參考此文件：&lt;a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-managed"target="_blank" rel="noopener">Get started with managed collection&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，過濾不要的 metrics ，避免送到 GMP 上，而有多餘的費用，我們可以在 PodMonitoring 上去來過濾要送出 metrics，如下：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">monitoring.googleapis.com/v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">PodMonitoring&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: {{ &lt;span style="color:#ae81ff">$.Values.deployment.name }}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">namespace&lt;/span>: {{ &lt;span style="color:#ae81ff">$.Release.Namespace }}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">selector&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">matchLabels&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">app&lt;/span>: {{ &lt;span style="color:#ae81ff">$.Values.deployment.name }}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">endpoints&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">port&lt;/span>: &lt;span style="color:#ae81ff">metrics&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">interval&lt;/span>: {{ &lt;span style="color:#ae81ff">.endpoints.metrics_interval_sec }}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">metricRelabeling&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">action&lt;/span>: &lt;span style="color:#ae81ff">drop&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">regex&lt;/span>: &lt;span style="color:#ae81ff">phpfpm_process_state&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">sourceLabels&lt;/span>: [&lt;span style="color:#ae81ff">__name__]&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>透過 &lt;code>metricRelabeling&lt;/code> 使用 drop 方式，搭配正規表示法來過濾 name 是 &lt;code>phpfpm_process_state&lt;/code> 的 metrics，另外也可以使用 keep 的方式，決定要送什麼到 GMP 上。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/14.webp"
alt="過濾後，指標不見惹" width="700">&lt;figcaption>
&lt;p>過濾後，指標不見惹&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>上圖就是在 &lt;code>PodMonitoring&lt;/code> 上新增 drop 來過濾 &lt;code>phpfpm_process_state&lt;/code>，也可以看 Samples billable volume 變成 0 Sample，就代表我們把這個 metrics 給過濾掉拉～～～ 也就可以省錢囉xDD&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-prometheus-sample-ingested-calculate/15.webp"
alt="Metrics Management phpfpm metrics" width="600">&lt;figcaption>
&lt;p>Metrics Management phpfpm metrics&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br></description></item><item><title>GCP Memorystore HA 高可用性 failover 測試</title><link>https://pin-yi.me/blog/gcp/gcp-memorystore-failover/</link><pubDate>Tue, 02 Jul 2024 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gcp-memorystore-failover/</guid><description>
&lt;p>此文章主要針對 GCP Memorystore failover 來做測試，測試 Memorystore 高可用性 (HA) 在標準 Standard Tier failover 故障轉移需要多久，以及不同 replica 條件下轉移是否會有差異等等。&lt;/p>
&lt;br>
&lt;h2>文件說明&lt;span class="hx:absolute hx:-mt-20" id="文件說明">&lt;/span>
&lt;a href="#%e6%96%87%e4%bb%b6%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>首先我們可以先閱讀 &lt;a href="https://cloud.google.com/memorystore/docs/redis/faq"target="_blank" rel="noopener">Google Memorystore for Redis FAQ&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 文章，可以得知 Standard Tier 在 failover 轉移，大約會花 30 秒左右。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/1.webp"
alt="Google Memorystore for Redis FAQ" width="400">&lt;figcaption>
&lt;p>Google Memorystore for Redis FAQ&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>我們也可以從 &lt;a href="https://cloud.google.com/memorystore/docs/redis/high-availability-for-memorystore-for-redis#when_a_failover_is_triggered"target="_blank" rel="noopener">High availability for Memorystore for Redis&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 文章中知道，當 Primary 資料庫發生故障時，就會發生故障轉移。在轉移期間，Primary Endpoint 和 Read Endpoint 會自動重新導向新的 Primary 資料庫 和 Replica。&lt;b>這時候 Primary Endpoint 和 Read Endpoint 連線都會被刪除&lt;/b>。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/2.webp"
alt="when a failover is triggered" width="700">&lt;figcaption>
&lt;p>when a failover is triggered&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>因次會導致有幾秒鐘連不到 Redis。重新連接時，將使用原本的 IP 位址即可自動重新定向到新的服務上。故障轉移後，不需要調整連線設定。&lt;/p>
&lt;br>
&lt;p>接下來我們來實際測試看看，我們分成兩個測試組，分別為：1m1s、1m2s 的方式，來看看故障轉移時，需要花多久，還有不同 Replica 條件下會不會有差異。&lt;/p>
&lt;h2>實作測試 (1m1s)&lt;span class="hx:absolute hx:-mt-20" id="實作測試-1m1s">&lt;/span>
&lt;a href="#%e5%af%a6%e4%bd%9c%e6%b8%ac%e8%a9%a6-1m1s" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>可以只用之前 &lt;a href="../../terraform/">IaC&lt;/a> 文章來建立，或是用 UI 來建立 Memorystore，這邊用 IaC 來示範：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-terragrunt.hcl" data-lang="terragrunt.hcl">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">terraform&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> source &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;${get_path_to_repo_root()}/modules/memorystore&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">include&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">find_in_parent_folders&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>inputs &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;ian-1m1s&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> memory_size_gb &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> region &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;asia-east1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> network &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;bbin-XXX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> replica_count &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> redis_version &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;REDIS_6_X&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> redis_configs &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;#34;maxmemory-policy&amp;#34; &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;allkeys-lru&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>這邊 memorystore module 預設是 Standard Tier，另外小提醒，如果要使用 Replica memory_size_gb 最小必須是 5G。&lt;/p>
&lt;br>
&lt;h3>設定監控&lt;span class="hx:absolute hx:-mt-20" id="設定監控">&lt;/span>
&lt;a href="#%e8%a8%ad%e5%ae%9a%e7%9b%a3%e6%8e%a7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>建立完成後，我們也先把監控給拉出來，設定可以參考 &lt;a href="https://cloud.google.com/memorystore/docs/redis/about-manual-failover#stackdriver_verification"target="_blank" rel="noopener">About manual failover&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，主要是選擇 &lt;b>Cloud Memorystore Redis &amp;gt; replication &amp;gt; Node role&lt;/b>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/3.webp"
alt="監控圖表" width="850">&lt;figcaption>
&lt;p>監控圖表&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到 node-0 跟 node-1，數字 1 代表 Primary (node-0)、數字 0 代表 Replica (node-1)&lt;/p>
&lt;br>
&lt;h3>查看 describe&lt;span class="hx:absolute hx:-mt-20" id="查看-describe">&lt;/span>
&lt;a href="#%e6%9f%a5%e7%9c%8b-describe" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>我們也可以下指令查看：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gcloud redis instances describe ian-1m1s --region&lt;span style="color:#f92672">=&lt;/span>asia-east1 --project&lt;span style="color:#f92672">={&lt;/span>project_id&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/4.webp"
alt="describe 畫面" width="650">&lt;figcaption>
&lt;p>describe 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到 &lt;b>currentLocationId&lt;/b> 代表現在 Primary (node-0) asia-east1-a，&lt;b>locationId&lt;/b> 代表最初配置 Primary 區域，&lt;b>alternativeLocationId&lt;/b> 則是最初配置 Replica 的區域，因此我們也可以在故障轉移後，來查看區域是否變化。詳細可以參考：&lt;a href="https://cloud.google.com/memorystore/docs/redis/about-manual-failover#gcloud_verification"target="_blank" rel="noopener">gcloud verification&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;p>接著我們可以參考 &lt;a href="https://cloud.google.com/memorystore/docs/redis/initiate-manual-failover"target="_blank" rel="noopener">Initiate a manual failover&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 文章，手動來觸發 failover，這邊提醒一下 手動 failover 有分兩種資料保護模式：limited-data-loss、force-data-loss，詳細請看 &lt;a href="https://cloud.google.com/memorystore/docs/redis/initiate-manual-failover#optional_data_protection_mode"target="_blank" rel="noopener">Optional data protection mode&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，這邊測試就不討論兩種保護模式，都使用預設的 limited-data-loss 來測試。&lt;/p>
&lt;br>
&lt;h3>寫 shell 測試 redis 連線&lt;span class="hx:absolute hx:-mt-20" id="寫-shell-測試-redis-連線">&lt;/span>
&lt;a href="#%e5%af%ab-shell-%e6%b8%ac%e8%a9%a6-redis-%e9%80%a3%e7%b7%9a" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>另外，我們在寫一個 shell 到 GKE 裡面 (用同 VPC 打) 打 Memorystore Redis 的 Primary Endpoint 以及 Read Endpoint，看看當 failover 是不是會有連不上的問題 ～&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">Pod&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">redis-test&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">namespace&lt;/span>: &lt;span style="color:#ae81ff">default&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">initContainers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">copy-scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">image&lt;/span>: &lt;span style="color:#ae81ff">busybox&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">command&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;sh&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;cp /config/redis.sh /scripts/ &amp;amp;&amp;amp; chmod +x /scripts/redis.sh&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">volumeMounts&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">config-volume&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mountPath&lt;/span>: &lt;span style="color:#ae81ff">/config&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mountPath&lt;/span>: &lt;span style="color:#ae81ff">/scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">containers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">redis-cli&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">image&lt;/span>: &lt;span style="color:#ae81ff">redis:alpine&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">command&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;sh&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;-c&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;while true; do /scripts/redis.sh; sleep 1; done&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">env&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">READ_PRIMARY_HOST&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;172.18.0.69&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">READ_REPLICA_HOST&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;172.18.0.68&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">REDIS_PASSWORD&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;XXXX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">volumeMounts&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mountPath&lt;/span>: &lt;span style="color:#ae81ff">/scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">workingDir&lt;/span>: &lt;span style="color:#ae81ff">/scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">volumes&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">config-volume&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">configMap&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">redis-scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">emptyDir&lt;/span>: {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">ConfigMap&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">redis-scripts&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">namespace&lt;/span>: &lt;span style="color:#ae81ff">default&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">data&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">redis.sh&lt;/span>: |&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> #!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> ## 顏色設定
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> GREEN=&amp;#34;\033[1;32m&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> RED=&amp;#34;\033[1;31m&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> NC=&amp;#34;\033[0m&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> READ_PRIMARY_HOST=${READ_PRIMARY_HOST}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> READ_REPLICA_HOST=${READ_REPLICA_HOST}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> READ_REPLICA_PORT=6379
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> REDIS_PASSWORD=${REDIS_PASSWORD}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> while true; do
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> TIMESTAMP=$(TZ=&amp;#34;Asia/Taipei&amp;#34; date +&amp;#34;%Y-%m-%d %H:%M:%S&amp;#34;)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> PRIMARY_OUTPUT=$(timeout 1 redis-cli -h $READ_PRIMARY_HOST -p $READ_REPLICA_PORT -a $REDIS_PASSWORD --no-auth-warning PING) 1&amp;gt;/dev/null
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> if [ $? -eq 0 ]; then
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> echo -e &amp;#34;[$TIMESTAMP] PRIMARY PING ${GREEN}SUCCESS${NC}：&amp;#34; &amp;#34;$PRIMARY_OUTPUT&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> else
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> echo -e &amp;#34;[$TIMESTAMP] PRIMARY PING ${RED}FAILED${NC}&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> fi
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> REPLICA_OUTPUT=$(timeout 1 redis-cli -h $READ_REPLICA_HOST -p $READ_REPLICA_PORT -a $REDIS_PASSWORD --no-auth-warning PING) 1&amp;gt;/dev/null
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> if [ $? -eq 0 ]; then
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> echo -e &amp;#34;[$TIMESTAMP] REPLICA PING ${GREEN}SUCCESS${NC}：&amp;#34; &amp;#34;$REPLICA_OUTPUT&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> else
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> echo -e &amp;#34;[$TIMESTAMP] REPLICA PING ${RED}FAILED${NC}&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> fi
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> sleep 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> done&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>開始手動觸發 failover&lt;span class="hx:absolute hx:-mt-20" id="開始手動觸發-failover">&lt;/span>
&lt;a href="#%e9%96%8b%e5%a7%8b%e6%89%8b%e5%8b%95%e8%a7%b8%e7%99%bc-failover" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>我們準備好監控以及也先看好 describe 後，就可以下指令來手動觸發 failover：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gcloud redis instances failover ian-1m1s --data-protection-mode&lt;span style="color:#f92672">=&lt;/span>limited-data-loss --region&lt;span style="color:#f92672">=&lt;/span>asia-east1 --project&lt;span style="color:#f92672">={&lt;/span>project_id&lt;span style="color:#f92672">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>可以看到目前 ian-1m1s 就開始 Failing over 了～&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/5.webp"
alt="memorystore UI 畫面" width="350">&lt;figcaption>
&lt;p>memorystore UI 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>後續觀察&lt;span class="hx:absolute hx:-mt-20" id="後續觀察">&lt;/span>
&lt;a href="#%e5%be%8c%e7%ba%8c%e8%a7%80%e5%af%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>查看監控&lt;span class="hx:absolute hx:-mt-20" id="查看監控">&lt;/span>
&lt;a href="#%e6%9f%a5%e7%9c%8b%e7%9b%a3%e6%8e%a7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>首先我們先看監控部分，可以看到原本的 node-1 是 Primary 後來掉下來的同時，由 node-2 變成 Primary 最後完成故障轉移。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/6.webp"
alt="監控畫面" width="500">&lt;figcaption>
&lt;p>監控畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>再來看 describe 的部分，可以發現原本的 &lt;b>currentLocationId&lt;/b> 從 Primary (node-0) asia-east1-a 變成(node-1) asia-east1-b，完成故障轉移，因此更換區域。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/7.webp"
alt="describe 畫面" width="650">&lt;figcaption>
&lt;p>describe 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>查看腳本&lt;span class="hx:absolute hx:-mt-20" id="查看腳本">&lt;/span>
&lt;a href="#%e6%9f%a5%e7%9c%8b%e8%85%b3%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>最後，查看一下腳本的執行紀錄可以發現：在 18:12:58， 出現第一筆 Primary PING 不到的錯誤，到 18:13:18 才恢復，代表故障轉移時間約 20 左右 (最後面會測試 5 次來取平均)，其流程是 Primary 會先連不到，接著變成 Primary 跟 Replica 都連不到，最後剩下 Replica，到都正常。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/8.webp"
alt="shell 畫面" width="500">&lt;figcaption>
&lt;p>shell 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>實作測試 (1m2s)&lt;span class="hx:absolute hx:-mt-20" id="實作測試-1m2s">&lt;/span>
&lt;a href="#%e5%af%a6%e4%bd%9c%e6%b8%ac%e8%a9%a6-1m2s" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>由於設定都差不多，所以上述 1m1s 設定這邊就不重複說明，記得把 IaC 的 replica_count 改成 2，以及 shell 的 IP 跟 Password 要記得換！&lt;/p>
&lt;p>直接看監控部分：可以看到現在 node-2 是 1，代表 node-2 是 Primary，其他 node-1、node-0 都是 Replica。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/9.webp"
alt="監控畫面" width="650">&lt;figcaption>
&lt;p>監控畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>接著看 describe：&lt;b>currentLocationId&lt;/b> 是 asia-east1-c，也就是 node-2 (Primary)。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/10.webp"
alt="describe 畫面" width="650">&lt;figcaption>
&lt;p>describe 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>一樣下指令來跑 shell，並觀察監控、describe 來有 shell：
變成 node-0 變成 Primary，node-2 變成 Replica，node-1 一樣是 Replica。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/11.webp"
alt="監控畫面" width="600">&lt;figcaption>
&lt;p>監控畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>&lt;b>currentLocationId&lt;/b> 變成是 asia-east1-a，Primary 從 node-2 變成 node-0。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/12.webp"
alt="describe 畫面" width="650">&lt;figcaption>
&lt;p>describe 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>觀察 shell 發現，有出現 FAILED 都是 Primary，Replica 都正常。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-memorystore-failover/13.webp"
alt="shell 畫面" width="500">&lt;figcaption>
&lt;p>shell 畫面&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>整理故障轉移時間&lt;span class="hx:absolute hx:-mt-20" id="整理故障轉移時間">&lt;/span>
&lt;a href="#%e6%95%b4%e7%90%86%e6%95%85%e9%9a%9c%e8%bd%89%e7%a7%bb%e6%99%82%e9%96%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: center">測測次數&lt;/th>
&lt;th style="text-align: center">1m1s (秒)&lt;/th>
&lt;th style="text-align: center">1m2s (秒)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: center">#1&lt;/td>
&lt;td style="text-align: center">16&lt;/td>
&lt;td style="text-align: center">13&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">#2&lt;/td>
&lt;td style="text-align: center">19&lt;/td>
&lt;td style="text-align: center">10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">#3&lt;/td>
&lt;td style="text-align: center">22&lt;/td>
&lt;td style="text-align: center">6&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">#4&lt;/td>
&lt;td style="text-align: center">20&lt;/td>
&lt;td style="text-align: center">10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">#5&lt;/td>
&lt;td style="text-align: center">18&lt;/td>
&lt;td style="text-align: center">9&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;p>可以發現，多一個 Replica，在故障轉移的時間可以更快速。&lt;/p>
&lt;br>
&lt;h2>最佳實踐&lt;span class="hx:absolute hx:-mt-20" id="最佳實踐">&lt;/span>
&lt;a href="#%e6%9c%80%e4%bd%b3%e5%af%a6%e8%b8%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>所以我們知道，每當發生 Failover 時，一定會出現斷線的問題，官方在 Memorystore for Redis 的 &lt;a href="https://cloud.google.com/memorystore/docs/redis/general-best-practices"target="_blank" rel="noopener">General best practices&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 中有提到&lt;a href="https://cloud.google.com/memorystore/docs/redis/general-best-practices#operations_and_scenarios_that_require_a_connection_retry"target="_blank" rel="noopener">需要重新連線的操作和場景&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>，以下都會導致與 Redis instance 網路連線中斷：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://cloud.google.com/memorystore/docs/redis/version-upgrade-behavior"target="_blank" rel="noopener">Version upgrade&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://cloud.google.com/memorystore/docs/redis/scaling-instances"target="_blank" rel="noopener">Scaling up/down&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://cloud.google.com/memorystore/docs/redis/import-export-overview"target="_blank" rel="noopener">Importing&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://cloud.google.com/memorystore/docs/redis/maintenance-policy"target="_blank" rel="noopener">Manual failover&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://cloud.google.com/memorystore/docs/redis/maintenance-policy"target="_blank" rel="noopener">System maintenance&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://cloud.google.com/memorystore/docs/redis/in-transit-encryption#certificate_authority_rotation"target="_blank" rel="noopener">Certificate Authority rotation&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> for Redis instances that have &lt;a href="https://cloud.google.com/memorystore/docs/redis/in-transit-encryption"target="_blank" rel="noopener">in-transit encryption&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> enabled&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Emergency failover&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>所以我們需要再設計應用程式時，考量到這一點，可以參考 &lt;a href="https://cloud.google.com/memorystore/docs/redis/exponential-backoff"target="_blank" rel="noopener">Exponential backoff&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> ，要加上重試邏輯，讓應用程式自動重新連線並持續正常運作。&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Memorystore for Redis FAQ：&lt;a href="https://cloud.google.com/memorystore/docs/redis/faq"target="_blank" rel="noopener">https://cloud.google.com/memorystore/docs/redis/faq&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>High availability for Memorystore for Redis：&lt;a href="https://cloud.google.com/memorystore/docs/redis/high-availability-for-memorystore-for-redis#when_a_failover_is_triggered"target="_blank" rel="noopener">https://cloud.google.com/memorystore/docs/redis/high-availability-for-memorystore-for-redis#when_a_failover_is_triggered&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>About manual failover：&lt;a href="https://cloud.google.com/memorystore/docs/redis/about-manual-failover#stackdriver_verification"target="_blank" rel="noopener">https://cloud.google.com/memorystore/docs/redis/about-manual-failover#stackdriver_verification&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Initiate a manual failover：&lt;a href="https://cloud.google.com/memorystore/docs/redis/initiate-manual-failover"target="_blank" rel="noopener">https://cloud.google.com/memorystore/docs/redis/initiate-manual-failover&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>General best practices：&lt;a href="https://cloud.google.com/memorystore/docs/redis/general-best-practices"target="_blank" rel="noopener">https://cloud.google.com/memorystore/docs/redis/general-best-practices&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Exponential backoff：&lt;a href="https://cloud.google.com/memorystore/docs/redis/exponential-backoff"target="_blank" rel="noopener">https://cloud.google.com/memorystore/docs/redis/exponential-backoff&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>如何過濾 GCP LOG，減少 Cloud Logging API 的花費</title><link>https://pin-yi.me/blog/gcp/gcp-log-reduce-cloud-logging-api/</link><pubDate>Sun, 30 Jul 2023 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gcp-log-reduce-cloud-logging-api/</guid><description>
&lt;p>當我們使用 GCP 的 Cloud Logging 服務來查看 Log 時，有時候會有一些我們不需要顯示出來的，或是從來都不會去查詢的 Log，再者是 GCP 本身的錯誤導致大量噴錯的 Log ，這些 Log 都會導致 Cloud Logging 的費用增加。&lt;/p>
&lt;h2>介紹 Cloud Logging&lt;span class="hx:absolute hx:-mt-20" id="介紹-cloud-logging">&lt;/span>
&lt;a href="#%e4%bb%8b%e7%b4%b9-cloud-logging" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>先來簡單說一下 Cloud Logging 這項服務的基本架構，請看圖：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/overview.webp"
alt="Cloud Logging 基本架構" width="800">&lt;figcaption>
&lt;p>Cloud Logging 基本架構&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>可以看到 Logs Data 會透過 API 再經過 _Default log sink (router) 存到相應命名的 log bucket (預設配置)，圖中 _Required 以及 _Default 的 log sink 都是 GCP 自動創建的接收器，下面簡述一下它們的區別：&lt;/p>
&lt;br>
&lt;h3>_Required 日誌儲存桶&lt;span class="hx:absolute hx:-mt-20" id="_required-日誌儲存桶">&lt;/span>
&lt;a href="#_required-%e6%97%a5%e8%aa%8c%e5%84%b2%e5%ad%98%e6%a1%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Cloud Logging 會將以下類型的 Log 存到 _Required 儲存桶&lt;/p>
&lt;ol>
&lt;li>
&lt;p>管理員活動審核 Log&lt;/p>
&lt;/li>
&lt;li>
&lt;p>系統事件審核 Log&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Access Transparency Log&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>Cloud Logging 會將 _Required 儲存桶 Log 保留 400 天，無法調整該期限，且無法修改或刪除 _Required 儲存桶，也沒辦法停用 _Required log sink 接受器路由到 _Required 儲存桶的設定。&lt;/p>
&lt;br>
&lt;h3>_Default 日誌儲存桶&lt;span class="hx:absolute hx:-mt-20" id="_default-日誌儲存桶">&lt;/span>
&lt;a href="#_default-%e6%97%a5%e8%aa%8c%e5%84%b2%e5%ad%98%e6%a1%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>只要不是存在 _Required 日誌儲存桶的 Log 就會透過 _Default log sink 接受器路由到 _Default 儲存桶。&lt;/p>
&lt;p>除非有另外配置自定義設定， 否則 _Default 日誌儲存桶 Log 只會保留 30 天，也一樣無法刪除 _Default 日誌儲存桶。此外 Cloud Logging 的費用是以存在 _Default 日誌儲存桶來計算。&lt;/p>
&lt;br>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>功能&lt;/th>
&lt;th>價格&lt;/th>
&lt;th>每月免費額度&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Logging 提取&lt;/td>
&lt;td>提取的 Log $0.5/GiB&lt;/td>
&lt;td>每個項目前 50 GiB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Logging 儲存&lt;/td>
&lt;td>保留超過 30 天的 Log，每月每 GiB $0.01&lt;/td>
&lt;td>在默認保留期限的 Log 不會有額外儲存費用&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>查看該專案使用的 Cloud Logging API 費用：&lt;a href="https://console.cloud.google.com/apis/api/logging.googleapis.com/cost"target="_blank" rel="noopener">https://console.cloud.google.com/apis/api/logging.googleapis.com/cost&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;h2>過濾 Log&lt;span class="hx:absolute hx:-mt-20" id="過濾-log">&lt;/span>
&lt;a href="#%e9%81%8e%e6%bf%be-log" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>那現在知道 Cloud Logging 的架構，那當我們遇到需要過濾 Log 時，我們可以使用以下步驟來過濾以節省 Cloud Logging API 費用：&lt;/p>
&lt;h3>範例說明&lt;span class="hx:absolute hx:-mt-20" id="範例說明">&lt;/span>
&lt;a href="#%e7%af%84%e4%be%8b%e8%aa%aa%e6%98%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>這次範例是 google 在 2023/07/06 所發佈的 Service Health，當 GKE 版本大於 1.24 以上，就會噴&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Failed to get record: decoder: failed to decode payload: EOF&lt;/p>
&lt;/li>
&lt;li>
&lt;p>cannot parse &amp;lsquo;0609 05:31:59.491654&amp;rsquo; after %L&lt;/p>
&lt;/li>
&lt;li>
&lt;p>invalid time format %m%d %H:%M:%S.%L%z for &amp;lsquo;0609 05:31:59.490647&amp;rsquo;&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>這三種類型的錯誤 Log，在等待官方修復前，官方的建議是先將他給過濾掉，避免一直刷噴錢 ┐(´д`)┌&lt;/p>
&lt;p>附上當時的 Service Health 連結：&lt;a href="https://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE"target="_blank" rel="noopener">https://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;p>我們在上面架構圖有說到，Log 會透過 log sink 路由到 bucket，所以我們要將過濾條件加在 log router 上：&lt;/p>
&lt;div class="hextra-steps hx:ml-4 hx:mb-12 hx:ltr:border-l hx:rtl:border-r hx:border-gray-200 hx:ltr:pl-6 hx:rtl:pr-6 hx:dark:border-neutral-800 [counter-reset:step]">
&lt;h3>選擇 Log Router&lt;span class="hx:absolute hx:-mt-20" id="選擇-log-router">&lt;/span>
&lt;a href="#%e9%81%b8%e6%93%87-log-router" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/1.webp"
alt="選擇 Log Router" width="550">&lt;figcaption>
&lt;p>選擇 Log Router&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>選擇 Log Router Sinks&lt;span class="hx:absolute hx:-mt-20" id="選擇-log-router-sinks">&lt;/span>
&lt;a href="#%e9%81%b8%e6%93%87-log-router-sinks" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>選擇 _Default 的 Log Router Sinks，點選右邊按鈕的 Edit Sink&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/2.webp"
alt="選擇 _Default 的 Log Router Sinks">&lt;figcaption>
&lt;p>選擇 _Default 的 Log Router Sinks&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>設定 Sink details&lt;span class="hx:absolute hx:-mt-20" id="設定-sink-details">&lt;/span>
&lt;a href="#%e8%a8%ad%e5%ae%9a-sink-details" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>第一個是 details，可以輸入說明，這邊輸入：google 有 bug 會噴大量的意外 LOG，怕費用飆高，先用官方建議的來過濾 LOG，詳細可以看： &lt;a href="https://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE"target="_blank" rel="noopener">https://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/3.webp"
alt="輸入 Sink details 說明">&lt;figcaption>
&lt;p>輸入 Sink details 說明&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>選擇 Sink Service 跟 Bucket&lt;span class="hx:absolute hx:-mt-20" id="選擇-sink-service-跟-bucket">&lt;/span>
&lt;a href="#%e9%81%b8%e6%93%87-sink-service-%e8%b7%9f-bucket" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接著 sink 服務選擇 Logging bucket，以及對應儲存的 log bucket (這邊基本上都是預設)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/4.webp"
alt="選擇 Logging bucket">&lt;figcaption>
&lt;p>選擇 Logging bucket&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>設定 include Log&lt;span class="hx:absolute hx:-mt-20" id="設定-include-log">&lt;/span>
&lt;a href="#%e8%a8%ad%e5%ae%9a-include-log" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>選擇那些可以被 include 到 sink 接收器的 LOG 格式 (這邊基本上都是預設)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/5.webp"
alt="預設的 LOG 格式">&lt;figcaption>
&lt;p>預設的 LOG 格式&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>設定 filter Log&lt;span class="hx:absolute hx:-mt-20" id="設定-filter-log">&lt;/span>
&lt;a href="#%e8%a8%ad%e5%ae%9a-filter-log" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>這邊就是我們要輸入過濾的地方，先點擊 ADD EXCLUSION，輸入過濾的名稱，以及過濾的內容格式，我們輸入 google 在 Service Health 所提供的格式，最後按下 UPDATE SINK&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/6.webp"
alt="新增要過濾的 LOG 格式">&lt;figcaption>
&lt;p>新增要過濾的 LOG 格式&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>設定完成&lt;span class="hx:absolute hx:-mt-20" id="設定完成">&lt;/span>
&lt;a href="#%e8%a8%ad%e5%ae%9a%e5%ae%8c%e6%88%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>等待更新完成，就可以看到我們已經在接收器上設定好過濾條件囉～&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/7.webp"
alt="查看詳細接收器設定">&lt;figcaption>
&lt;p>查看詳細接收器設定&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>檢查 Log 是否過濾成功&lt;span class="hx:absolute hx:-mt-20" id="檢查-log-是否過濾成功">&lt;/span>
&lt;a href="#%e6%aa%a2%e6%9f%a5-log-%e6%98%af%e5%90%a6%e9%81%8e%e6%bf%be%e6%88%90%e5%8a%9f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>最後再檢查一下 Log 是不是沒有收到該錯誤的 Log 內容&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gcp-log-reduce-cloud-logging-api/8.webp"
alt="檢查 LOG 是否不會再出現">&lt;figcaption>
&lt;p>檢查 LOG 是否不會再出現&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;/div>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Routing and storage overview &lt;a href="https://cloud.google.com/logging/docs/routing/overview"target="_blank" rel="noopener">https://cloud.google.com/logging/docs/routing/overview&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>Google Kubernetes Engine CronJob 會有短暫時間沒有執行 Job</title><link>https://pin-yi.me/blog/gcp/gke-cronjob-not-working/</link><pubDate>Fri, 10 Feb 2023 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/gke-cronjob-not-working/</guid><description>
&lt;p>前陣子公司建立在 Google Kubernetes Engine 叢集上的 CronJob 服務會有短暫時間沒有執行 Job。先前情提要一下，此 CronJob 的設定是每分鐘都會執行 (圖一)，所以理當來說 Log 應該要可以看到每分鐘都有此 CronJob 的紀錄，但有時候會發生 CronJob 短暫時間都沒有執行的狀況，找了一陣子都沒有找到原因，最後開支援單請 Google 那邊協助查看，終於找到原因拉 😍。那就跟我一起看一下發生的過程，以及 Google 幫我們找到的原因，以及要如何解決等等～&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/1.webp"
alt="(圖一) CronJob schedule 時間為每分鐘執行" width="600">&lt;figcaption>
&lt;p>(圖一) CronJob schedule 時間為每分鐘執行&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>問題發生以及問題原因&lt;span class="hx:absolute hx:-mt-20" id="問題發生以及問題原因">&lt;/span>
&lt;a href="#%e5%95%8f%e9%a1%8c%e7%99%bc%e7%94%9f%e4%bb%a5%e5%8f%8a%e5%95%8f%e9%a1%8c%e5%8e%9f%e5%9b%a0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>我們使用 Google Cloud Platform 裡面的記錄功能，可以看到 (圖二)，在每分鐘執行的 Log 中，有短暫時間沒有執行 Job，但這個時間除了 CronJob 以外，其他的服務都是好的。&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/2.webp"
alt="(圖二) Google Cloud Platform 記錄有短暫沒有執行" width="700">&lt;figcaption>
&lt;p>(圖二) Google Cloud Platform 記錄有短暫沒有執行&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>找了一陣子都沒有找到原因，於是我們開支援單請 Google 那邊協助查看，Google 那邊找了一陣子後終於找到原因拉！！！我們一起來看看吧 (圖三)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/3.webp"
alt="(圖三) Google 支援單回覆" width="700">&lt;figcaption>
&lt;p>(圖三) Google 支援單回覆&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>就如同 Google 所說，使用提供的指令參數來查詢，叢集在該時段有發生 master control plane 的升級，如 (圖四)，再加上我們建的這個 cluster 是使用 zonal cluster (圖五)，所以叢集只有一個 control plane，當 control plane 在更新時，會無法部署新的 workload，導致該 CronJob 沒有執行 Job。參考資料 [1]&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/4.webp"
alt="(圖四) 發生 master control plane 的升級" width="700">&lt;figcaption>
&lt;p>(圖四) 發生 master control plane 的升級&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/5.webp"
alt="(圖五) 有問題的叢集位置類型" width="450">&lt;figcaption>
&lt;p>(圖五) 有問題的叢集位置類型&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>Google 的建議是可以考慮使用另一個 regional cluster，讓 master node 在更新時不會只在單一地區，或是一樣使用舊的 zonal cluster，透過設定 Maintenance window 或者 Maintenance exclusions 來降低服務受到 workload 的影響。參考資料 [2]&lt;/p>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2">&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>&lt;/div>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;ol>
&lt;li>
&lt;p>就算把 node_pool 裡面的自動升級給停掉，也沒有辦法解決此問題！因為此 master control plane (也就是 master node) 的升級，不是 worker node 的 node pool 升級，是由 GKE 負責維護的，所以他們會定期升級 control plane，也沒辦法停止此類的升級。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>若已經建立好 zonal cluster 後，想要改成 regional cluster ，是沒有辦法使用修改的方式，一定只能重建 cluster，所以大家在建立時要注意～&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h2>解決問題&lt;span class="hx:absolute hx:-mt-20" id="解決問題">&lt;/span>
&lt;a href="#%e8%a7%a3%e6%b1%ba%e5%95%8f%e9%a1%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>最後我們選擇將叢集給整個重建，來確保 CronJob 不會有沒有執行到的狀況發生，重建叢集跟搬服務的過程很辛苦的 😰 希望大家不要發生 QQ，最後我們來看一下重建完後，在 master control plane 更新的時候，還會不會有 CronJob 沒有執行的情況發生。&lt;/p>
&lt;br>
&lt;p>新叢集使用 regional cluster 來建立，在 2/1 也有 master control plane 的升級。 (圖六)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/6.webp"
alt="(圖六) 發生 master control plane 的升級" width="700">&lt;figcaption>
&lt;p>(圖六) 發生 master control plane 的升級&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>查看 CronJob 執行的紀錄可以發現並沒有 Job 沒有執行的情況發生。 (圖七)&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/7.webp"
alt="(圖七) 叢集位置類型" width="700">&lt;figcaption>
&lt;p>(圖七) 叢集位置類型&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/gke-cronjob-not-working/8.webp"
alt="(圖八) 新叢集位置類型" width="450">&lt;figcaption>
&lt;p>(圖八) 新叢集位置類型&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>[1] Standard cluster upgrades：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>[2] maintenance-windows-and-exclusions：&lt;a href="https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions"target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>Google Cloud Platform (GCP) - Cloud Build</title><link>https://pin-yi.me/blog/gcp/cloud-build/</link><pubDate>Wed, 06 Jul 2022 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/cloud-build/</guid><description>
&lt;p>跟大家介紹一下今天的主題 Cloud Build，Cloud Build 可以幫我們做持續建構、測試和部署，我們可以把它想成簡易版的 Jenkins，從整個映像檔案打包到部署，也就幾分鐘的事情，且內建許多指令。&lt;/p>
&lt;br>
&lt;p>我們今天文章，需要使用前幾天提到的 &lt;a href="https://pin-yi.me/blog/gcp/cloud-source-repositories/">Cloud Source Repositories&lt;/a> 、&lt;a href="https://pin-yi.me/blog/gcp/compute-engine/">Compute Engine&lt;/a>、&lt;a href="https://pin-yi.me/blog/gcp/container-registry/">Container Registry&lt;/a>，我們需要先透過 GitLab 將程式鏡像到 Cloud Source Repositories，再透過 Cloud Build 觸發將 GitLab 上面的 Dockerfile 建置到 Container Registry 中，再部署到 Compute Engine VM 上。大家可以參考流程圖，會更清楚今天的流程！那我們就開始囉 🥸&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/1.webp"
alt="流程圖" width="1200">&lt;figcaption>
&lt;p>流程圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>Cloud Source Repositories 測試&lt;span class="hx:absolute hx:-mt-20" id="cloud-source-repositories-測試">&lt;/span>
&lt;a href="#cloud-source-repositories-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>前面 GitLab 鏡像設定，請先參考上上篇 &lt;a href="https://pin-yi.me/blog/gcp/cloud-source-repositories/">Google Cloud Platform (GCP) - Cloud Source Repositories&lt;/a>，上上篇會帶大家從 GitLab 鏡像到 Cloud Source Repositories，所以我們就接續之前的內容，繼續往下開始學習吧～&lt;/p>
&lt;br>
&lt;ol>
&lt;li>開啟 GCP，選擇左側的 menu &amp;gt; 點擊 &lt;strong>Cloud Build&lt;/strong> &amp;gt; 選擇 &lt;strong>觸發條件&lt;/strong>，點擊 &lt;strong>建立觸發條件&lt;/strong> 按鈕。&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="2">
&lt;li>輸入觸發條件的名稱，事件可以設定我們要怎麼進行觸發，我們這邊先選擇 &lt;strong>推送至分支的版本&lt;/strong> 來觸發，在來源選擇上上篇建立好的 Cloud Source Repositories 存放區，分支版本我們先使用預設的 master，也就是推程式到 master 他會就觸發 Cloud Build：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/2.webp"
alt="建立觸發條件 1" width="900">&lt;figcaption>
&lt;p>建立觸發條件 1&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>設定類型我們選擇 Cloud Build 設定檔，他也是 Cloud Build 專用的設定檔，後面會帶大家寫一份 Cloud Build，位置當然是使用我們 Cloud Source Repositories 存放區，以及可以依照專案來修改 cloudbuild.yaml 放在專案的哪裡，最後都沒問題，就按下建立：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/3.webp"
alt="建立觸發條件 2" width="900">&lt;figcaption>
&lt;p>建立觸發條件 2&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>撰寫 cloudbuild.yaml 設定檔&lt;span class="hx:absolute hx:-mt-20" id="撰寫-cloudbuildyaml-設定檔">&lt;/span>
&lt;a href="#%e6%92%b0%e5%af%ab-cloudbuildyaml-%e8%a8%ad%e5%ae%9a%e6%aa%94" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>在開始建立檔案前，先來跟大家說說檔案內有哪些設定吧：&lt;/p>
&lt;br>
&lt;p>首先 Cloud Build 建構器是裝有常用的程式語言和工具的容器映像。我們可以配置 Cloud Build，讓建構器中運行特定命令，我舉個例子讓大家了解：&lt;/p>
&lt;p>以下程式碼是來自 &lt;a href="https://hub.docker.com/search?q=&amp;amp;type=image"target="_blank" rel="noopener">Docker Hub&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 的 &lt;code>ubnutu&lt;/code> 映像檔中所執行的命令：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">steps&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ubuntu&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">args&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;echo&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;hello world&amp;#34;&lt;/span>]&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>可以看到我們配置文件中 &lt;code>steps&lt;/code> 參數是指我們要建構的步驟， &lt;code>name&lt;/code> 字段指定 Docker 映像檔的位置，以及 &lt;code>args&lt;/code> 字段中是指定映像檔運行的命令。&lt;/p>
&lt;p>我們的 Cloud Build 一樣會需要用 &lt;code>name&lt;/code> 來指定建構容器的映像檔，以及使用 &lt;code>args&lt;/code> 來執行我們映像檔所要運行的命令。&lt;/p>
&lt;br>
&lt;p>我們的 Cloud Build 設定檔中的 &lt;code>name&lt;/code> 常用的建構器映像檔如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: center">Builder&lt;/th>
&lt;th style="text-align: center">名稱&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: center">bazel&lt;/td>
&lt;td style="text-align: center">gcr.io/cloud-builders/bazel&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">docker&lt;/td>
&lt;td style="text-align: center">gcr.io/cloud-builders/docker&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">git&lt;/td>
&lt;td style="text-align: center">gcr.io/cloud-builders/git&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">gcloud&lt;/td>
&lt;td style="text-align: center">gcr.io/cloud-builders/gcloud&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">gke-deploy&lt;/td>
&lt;td style="text-align: center">gcr.io/cloud-builders/gke-deploy&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;p>接著我們來試著寫一個 cloudbuild.yaml 來建構我們的 nginx 服務，並部署到 Compute Engine 上。&lt;/p>
&lt;br>
&lt;p>我們先回到 Gitlab 該專案下的目錄，新增 cloudbuild.yaml 檔案，將複製以下內容：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">steps&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Docker Build&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcr.io/cloud-builders/docker&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">args&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;build&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;-t&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;gcr.io/$PROJECT_ID/ian-test:ian-nginx-test&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;.&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Docker Push&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcr.io/cloud-builders/docker&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">args&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;push&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;gcr.io/$PROJECT_ID/ian-test:ian-nginx-test&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Build VM&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcr.io/google.com/cloudsdktool/cloud-sdk&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">entrypoint&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;gcloud&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">args&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;compute&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;instances&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;create-with-container&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ian-test-vm&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--container-image&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;gcr.io/$PROJECT_ID/ian-test:ian-nginx-test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">env&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#34;CLOUDSDK_COMPUTE_REGION=asia-east1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e6db74">&amp;#34;CLOUDSDK_COMPUTE_ZONE=asia-east1-b&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>我們一個一個來說說的這個 cloudbuild.yaml 裡面的設定吧！(我以前面的註解來區分)&lt;/p>
&lt;ul>
&lt;li>Docker Build：這邊的 &lt;code>name&lt;/code> 我們用 &lt;code>gcr.io/cloud-builders/docker&lt;/code>，代表我們將使用 docker 建構器，&lt;code>args&lt;/code> 這邊下的意思是要把與 cloudbuild.yaml 放在一起的 Dokcerfile 給 build 起來，並改名為 gcr.io/$PROJECT_ID/ian-test:ian-nginx-test。&lt;/li>
&lt;li>Docker Push：這邊一樣使用 &lt;code>gcr.io/cloud-builders/docker&lt;/code>，&lt;code>args&lt;/code> 指令部分變成我們要把他 push 到 gcr.io/$PROJECT_ID/ian-test 這個 Cloud Source Repositories，其中這個映像檔案的 tag 為 ian-nginx-test。&lt;/li>
&lt;li>Build VM：這邊我們使用 &lt;code>gcr.io/google.com/cloudsdktool/cloud-sdk&lt;/code>，可以透過它來建立 VM，並且執行 tag 名為 ian-nginx-test 的映像檔，後面環境變數是來設定 VM 的區域等等。&lt;/li>
&lt;/ul>
&lt;br>
&lt;div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-green-200 hx:bg-green-100 hx:text-green-900 hx:dark:border-green-200/30 hx:dark:bg-green-900/30 hx:dark:text-green-200">
&lt;div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2">&lt;svg height=1.2em class="hx:inline-block hx:align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>&lt;/svg>&lt;/div>
&lt;div class="hx:w-full hx:min-w-0 hx:leading-7">
&lt;div class="hx:mt-6 hx:leading-7 hx:first:mt-0">&lt;code>ian-test&lt;/code> 是 Container Registry 資料夾名稱，&lt;code>ian-nginx-test&lt;/code> 是 Container Registry 映像檔的 tag，&lt;code>ian-test-vm&lt;/code> 是我們建立 VM 的名字，所以要記得改成自己的命名歐！&lt;/div>
&lt;/div>
&lt;/div>
&lt;br>
&lt;h3>撰寫 Dockerfile&lt;span class="hx:absolute hx:-mt-20" id="撰寫-dockerfile">&lt;/span>
&lt;a href="#%e6%92%b0%e5%af%ab-dockerfile" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>接下來剛剛有提到 Docker Build 會將我們放在一起的 Dockerfile 給 build 起來，所以我們也要先寫好要用的 Dockerfile：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">FROM&lt;/span>&lt;span style="color:#e6db74"> nginx:latest&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">COPY&lt;/span> ./index.html /usr/share/nginx/html/&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>我們的 Dockerfile 很簡單，簡單寫了要使用的映像檔，以及將我們等等要測試的 index 複製到裡面&lt;/p>
&lt;br>
&lt;h3>撰寫測試 index.html&lt;span class="hx:absolute hx:-mt-20" id="撰寫測試-indexhtml">&lt;/span>
&lt;a href="#%e6%92%b0%e5%af%ab%e6%b8%ac%e8%a9%a6-indexhtml" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="color:#f92672">html&lt;/span> &lt;span style="color:#a6e22e">lang&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;en&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">charset&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;UTF-8&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">http-equiv&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;X-UA-Compatible&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;IE=edge&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">meta&lt;/span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;viewport&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">content&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;width=device-width, initial-scale=1.0&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">title&lt;/span>&amp;gt;測試測試測試&amp;lt;/&lt;span style="color:#f92672">title&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;/&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">body&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 我是測試檔案
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;/&lt;span style="color:#f92672">body&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;/&lt;span style="color:#f92672">html&lt;/span>&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>這個測試檔案，會蓋過 nginx 的預設畫面，當我們成功將 VM 建立後，瀏覽 80 Port 時，應該會跳出這個測試的網頁。&lt;/p>
&lt;br>
&lt;h3>Commit 到 GitLab&lt;span class="hx:absolute hx:-mt-20" id="commit-到-gitlab">&lt;/span>
&lt;a href="#commit-%e5%88%b0-gitlab" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>當我們都新增好檔案後，我們就將程式推到我們前幾篇的 Cloud Source Repositories 已經鏡像的 GitLab 中，接著就是等待見證奇蹟的時候了ＸＤ&lt;/p>
&lt;ol>
&lt;li>當我們推送後，我們先檢查 Cloud Source Repositories 是否有成功從 GitLab 鏡像過來：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/4.webp"
alt="Cloud Source Repositories" width="700">&lt;figcaption>
&lt;p>Cloud Source Repositories&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="2">
&lt;li>檢查看看 Container Registry 是否多了名為 &lt;code>ian-test&lt;/code> 的資料夾，且裡面有一個 tag 為 &lt;code>ian-nginx-test&lt;/code> 的映像檔：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/5.webp"
alt="Container Registry" width="1000">&lt;figcaption>
&lt;p>Container Registry&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>檢查一下 Cloud Build 的觸發條件是不是在運作，最後成功可以看到類似下方圖片內容：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/6.webp"
alt="Cloud Build 的觸發條件" width="1200">&lt;figcaption>
&lt;p>Cloud Build 的觸發條件&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="4">
&lt;li>檢查 Compute Engine 的 VM 是否有成功被建立：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/7.webp"
alt="Compute Engine" width="1200">&lt;figcaption>
&lt;p>Compute Engine&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>最後就是測試這個映像檔案，是不是我們所 Build 的，測試方法很簡單，我們剛剛在 Dockerfile 有複製我們自己寫的 index.html 檔案，去蓋掉原本 nginx 的預設檔，所以我們可以瀏覽上面圖片的外部 IP，就可以看到我們所改的頁面囉！&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-build/8.webp"
alt="測試用 index.html" width="700">&lt;figcaption>
&lt;p>測試用 index.html&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Cloud Builder：&lt;a href="https://cloud.google.com/build/docs/cloud-builders"target="_blank" rel="noopener">https://cloud.google.com/build/docs/cloud-builders&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Day27 - 用 Cloud Build 實作 CI 部分：&lt;a href="https://ithelp.ithome.com.tw/articles/10224727"target="_blank" rel="noopener">https://ithelp.ithome.com.tw/articles/10224727&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>Google Cloud Platform (GCP) - Cloud Source Repositories</title><link>https://pin-yi.me/blog/gcp/cloud-source-repositories/</link><pubDate>Sun, 03 Jul 2022 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/cloud-source-repositories/</guid><description>
&lt;p>跟大家介紹一下今天的主題 Cloud Source Repositories，聽到 Source Repositories 是不是感覺跟什麼東西很像呀，沒錯，就跟我們的 GitHub or GitLab 一樣，可以用來存放我們的程式碼的儲存庫，我們來看看官方怎麼介紹他吧：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/1.webp"
alt="官方介紹 Cloud Source Repositories" width="800">&lt;figcaption>
&lt;p>官方介紹 Cloud Source Repositories&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>很好歐，非常簡單明瞭 🤣，沒錯，Cloud Source Repositories 就是託管在 Google Cloud 上功能齊全(？)的私有 Git 儲存庫。為什麼會打一個問號呢？是因為他其實沒有那麼好用，所以我們通常的做法，還是會依靠 GitHab 或是 GitLab 來存放程式碼，再透過鏡像 (mirror) 的方式到 Google Cloud Source Repositories。 那我們就開始囉～&lt;/p>
&lt;br>
&lt;h2>Cloud Source Repositories 測試&lt;span class="hx:absolute hx:-mt-20" id="cloud-source-repositories-測試">&lt;/span>
&lt;a href="#cloud-source-repositories-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>建立 GitLab Project&lt;span class="hx:absolute hx:-mt-20" id="建立-gitlab-project">&lt;/span>
&lt;a href="#%e5%bb%ba%e7%ab%8b-gitlab-project" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>首先，我們用 GitLab 來當示範，如何透過鏡像 (mirror) 到 Cloud Source Repositories 上面，我們先在 GitLab 上建立一個 Project：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/2.webp"
alt="建立 GitLab Project" width="800">&lt;figcaption>
&lt;p>建立 GitLab Project&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>使用 gcloud 指令建立 Source Repo&lt;span class="hx:absolute hx:-mt-20" id="使用-gcloud-指令建立-source-repo">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-gcloud-%e6%8c%87%e4%bb%a4%e5%bb%ba%e7%ab%8b-source-repo" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>首先，一定要先裝 &lt;code>gcloud&lt;/code> 指令到本機，這個步驟，前面文章也有說過，這邊就不在說明，我們先使用一下指令來查看目前所在的 GCP 專案：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gcloud config get-value project&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;p>正常來說，如果有先用 config 設定好，會直接跳出你目前的專案 ID，如果沒有跳出來，請使用下面指令來設定：&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gcloud config set project &amp;lt;project id&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="2">
&lt;li>接著我們要啟動該專案的 Cloud Source Repositories API：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gcloud services enable sourcerepo.googleapis.com&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="3">
&lt;li>創建 Cloud Source Repositories&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gcloud source repos create &amp;lt;repo name&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="4">
&lt;li>完成後，開啟 GCP 檢查一下是否有建立成功～點擊左側 menu &amp;gt; &lt;strong>Source Repositories&lt;/strong>，&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/3.webp"
alt="開啟 Source Repositories" width="800">&lt;figcaption>
&lt;p>開啟 Source Repositories&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/4.webp"
alt="成功建立 Source Repositories" width="1000">&lt;figcaption>
&lt;p>成功建立 Source Repositories&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>將程式碼新增至存放區中&lt;span class="hx:absolute hx:-mt-20" id="將程式碼新增至存放區中">&lt;/span>
&lt;a href="#%e5%b0%87%e7%a8%8b%e5%bc%8f%e7%a2%bc%e6%96%b0%e5%a2%9e%e8%87%b3%e5%ad%98%e6%94%be%e5%8d%80%e4%b8%ad" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>我們要在這一步來設定鏡像 (mirror)，首先我們看剛剛上面建立好的 Source Repositories，其中有一個&lt;strong>手動產生的憑證&lt;/strong>，點選 &lt;strong>產生及儲存 Git 憑證&lt;/strong>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/5.webp"
alt="產生及儲存 Git 憑證" width="650">&lt;figcaption>
&lt;p>產生及儲存 Git 憑證&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="2">
&lt;li>點完後會需要先登入你的 GCP 帳號，登入完後會出現以下內容：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/6.webp"
alt="Configure Git" width="800">&lt;figcaption>
&lt;p>Configure Git&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>接著把藍色框框內的輸入到終端機內&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/7.webp"
alt="Configure Git" width="800">&lt;figcaption>
&lt;p>Configure Git&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="4">
&lt;li>接著請複製以下指令貼到終端機內，會生成憑證密碼：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>grep &lt;span style="color:#e6db74">&amp;#39;source.developers.google.com&amp;#39;&lt;/span> ~/.gitcookies | tail -1 | cut -d&lt;span style="color:#f92672">=&lt;/span> -f2&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/8.webp"
alt="生成憑證密碼" width="800">&lt;figcaption>
&lt;p>生成憑證密碼&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>接著請複製以下指令貼到終端機內，將用戶名存儲在 CSR_USER 環境變量中：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>CSR_USER&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>grep &lt;span style="color:#e6db74">&amp;#39;source.developers.google.com&amp;#39;&lt;/span> ~/.gitcookies | &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> tail -1 | cut -d&lt;span style="color:#e6db74">$&amp;#39;\t&amp;#39;&lt;/span> -f7 | cut -d&lt;span style="color:#f92672">=&lt;/span> -f1&lt;span style="color:#66d9ef">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/9.webp"
alt="用戶名存儲在 CSR_USER 環境變量中" width="800">&lt;figcaption>
&lt;p>用戶名存儲在 CSR_USER 環境變量中&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="6">
&lt;li>接著請複製以下指令貼到終端機內，將 GCP 存儲庫的 URL 存儲在 CSR_REPO 環境變量中 (repo name 要改成你在 gcp 上面的 repo)：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>CSR_REPO&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>gcloud source repos describe &amp;lt;repo name&amp;gt; --format&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;value(url)&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/10.webp"
alt="將 GCP 存儲庫的 URL 存儲在 CSR_REPO 環境變量中" width="800">&lt;figcaption>
&lt;p>將 GCP 存儲庫的 URL 存儲在 CSR_REPO 環境變量中&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="7">
&lt;li>接著請複製以下指令貼到終端機內，將存儲庫的 URL（包括用戶名）印到終端機上：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>echo $CSR_REPO | sed &lt;span style="color:#e6db74">&amp;#34;s/:\/\//:\/\/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>CSR_USER&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">@/&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/11.webp"
alt="存儲庫的 URL（包括用戶名）印到終端機上" width="800">&lt;figcaption>
&lt;p>存儲庫的 URL（包括用戶名）印到終端機上&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>經過上面操作，我們可以在第 4 步驟拿到密碼，以及在第 7 步驟拿到完整的 GCP URL，接著我們要到 GItLab Mirror 來設定鏡像。&lt;/p>
&lt;br>
&lt;h3>到 GitLab Mirror 設定鏡像&lt;span class="hx:absolute hx:-mt-20" id="到-gitlab-mirror-設定鏡像">&lt;/span>
&lt;a href="#%e5%88%b0-gitlab-mirror-%e8%a8%ad%e5%ae%9a%e9%8f%a1%e5%83%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>先從右側 muen &amp;gt; 選擇 &lt;strong>Settings&lt;/strong> &amp;gt; 點選 &lt;strong>Repository&lt;/strong>，找到 &lt;strong>Mirroring repositories&lt;/strong>&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/12.webp"
alt="GitLab Mirror 設定鏡像" width="800">&lt;figcaption>
&lt;p>GitLab Mirror 設定鏡像&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="2">
&lt;li>將剛剛拿到的 URL 以及密碼各別輸入 Git repository URL 以及 Password，記得要選擇 Mirror direction，因為我們是要將 gitlab 的鏡像到 GCP 的 Cloud Source Repositories，所以我們要選擇 &lt;strong>PUSH&lt;/strong>，最後按下 &lt;strong>Mirror repository&lt;/strong>：&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/13.webp"
alt="GitLab Mirror 設定鏡像" width="800">&lt;figcaption>
&lt;p>GitLab Mirror 設定鏡像&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>如果沒有跳出錯誤，基本上是沒有問題了！&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/14.webp"
alt="GitLab Mirror 檢查" width="800">&lt;figcaption>
&lt;p>GitLab Mirror 檢查&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="3">
&lt;li>就可以試著在 gitlab 上面推程式，看看有沒有跑到 Cloud Source Repositories 上面囉！&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/cloud-source-repositories/15.webp"
alt="GitLab 推程式測試" width="800">&lt;figcaption>
&lt;p>GitLab 推程式測試&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://cloud.google.com/source-repositories/docs"target="_blank" rel="noopener">Cloud Source Repositories documentation&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://cloud.google.com/architecture/mirroring-gitlab-repositories-to-cloud-source-repositories"target="_blank" rel="noopener">Mirroring GitLab repositories to Cloud Source Repositories&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item><item><title>Google Cloud Platform (GCP) - Container Registry</title><link>https://pin-yi.me/blog/gcp/container-registry/</link><pubDate>Fri, 01 Jul 2022 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/container-registry/</guid><description>
&lt;p>跟大家介紹一下今天的主題 Container Registry，Container Registry 是儲存、管理和保護 Docker 容器映像檔的存放區，可以讓團隊透過同一項服務服務集中管理 Docker 映像檔、也可以執行安全漏洞分析，還能透過精密的存取權管理機制，來決定誰可以存取哪些內容。簡單來說他就是一個讓我們存放 Docker 映像檔的地方，他有以下幾個特點：&lt;/p>
&lt;br>
&lt;h2>Container Registry 特點&lt;span class="hx:absolute hx:-mt-20" id="container-registry-特點">&lt;/span>
&lt;a href="#container-registry-%e7%89%b9%e9%bb%9e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>安全的私人 Docker 註冊資料庫：只需要幾分鐘的時間，即可開始在 Google Cloud Platform 中使用安全的私人 Docker 映像檔儲存空間，控管能夠存取、檢視或下載映像檔的人員，並在受到 Google 安全防護機制保護的基礎架構上穩定執行。&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="2">
&lt;li>自動建立及部署映像檔：在您修訂 Cloud Source Repositories 中的程式碼時，系統會自動建立映像檔並推送至私人註冊資料庫。您可以輕鬆設定持續整合/持續推送軟體更新管道，並整合至 Cloud Build，或是直接將管道部署至 Google Kubernetes Engine、App Engine、Cloud Functions 或 Firebase。(這個就是我們在&lt;a href="https://pin-yi.me/blog/gcp/cloud-build/">下一篇文章&lt;/a>會使用到的功能)&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="3">
&lt;li>深度安全漏洞掃描：在軟體部署週期的早期階段找出安全漏洞，藉此確保您可以安全地部署容器映像檔。資料庫會持續重新整理，讓您的安全漏洞掃描作業取得最新型惡意軟體的相關資訊。&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="4">
&lt;li>鎖定有風險的映像檔：運用二進位授權的原生整合功能來定義政策，避免部署與所設定政策相衝突的映像檔。您可以觸發容器映像檔的自動鎖定功能，禁止將有風險的映像檔部署至 Google Kubernetes Engine。&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="5">
&lt;li>原生支援 Docker：您不僅可以視需求定義多個註冊資料庫，也能使用標準的 Docker 指令列介面，將 Docker 映像檔推送和提取到您的私人 Container Registry。Docker 提供依據名稱和標記搜尋映像檔的功能，讓您可以順暢使用。&lt;/li>
&lt;/ol>
&lt;br>
&lt;ol start="6">
&lt;li>快速的高可用性存取能力：您可使用我們遍布全球的區域性私人存放區，於全世界皆能享有最快速的回應時間。您可以就近將映像檔儲存在位於歐洲、亞洲或美國的運算執行個體中，並透過 Google 的高效能全球網路快速完成部署作業。&lt;/li>
&lt;/ol>
&lt;br>
&lt;p>上面有提到 Container Registry 其中一個特點就是掃描映像檔，會檢查有沒有奇怪的內容或是錯誤，讓我們在部署前可以先做檢查，底下是整個的流程圖：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/container-registry/1.webp"
alt="Container Registry 掃描流程圖" width="800">&lt;figcaption>
&lt;p>Container Registry 掃描流程圖&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>我們可以延續上一篇文章 &lt;a href="https://pin-yi.me/blog/gcp/cloud-source-repositories/">Cloud Source Repositories&lt;/a> 來說明上面圖片，一開始先 commit 到 GCP 上，也可以把它當成 Cloud Source Repositories，就著透過會透過&lt;a href="https://pin-yi.me/blog/gcp/cloud-build/">下一篇要講的 Cloud Build&lt;/a> 來建置，並且掃描，如果沒有問題就會 Pubish 到 Container Registry 存放囉～&lt;/p>
&lt;br>
&lt;p>我們就簡單說明要怎麼查看我們的 Container Registry，點選則左側的 menu &amp;gt; 選擇 &lt;strong>Container Registry&lt;/strong> &amp;gt; 點擊 &lt;strong>映像檔&lt;/strong>：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/container-registry/2.webp"
alt="Container Registry" width="350">&lt;figcaption>
&lt;p>Container Registry&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>一開始可能沒有任何的資料夾，之後當我們 Build 時，可以新增特定的資料夾來放我們的映像檔，可以參考下方圖片：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/container-registry/3.webp"
alt="Container Registry 資料夾" width="750">&lt;figcaption>
&lt;p>Container Registry 資料夾&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>進入該資料夾後，就可以看到裡面的映像檔案：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/container-registry/4.webp"
alt="Container Registry 映像檔" width="1000">&lt;figcaption>
&lt;p>Container Registry 映像檔&lt;/p>
&lt;/figcaption>
&lt;/figure></description></item><item><title>Google Cloud Platform (GCP) - Compute Engine</title><link>https://pin-yi.me/blog/gcp/compute-engine/</link><pubDate>Wed, 29 Jun 2022 00:00:00 +0000</pubDate><guid>https://pin-yi.me/blog/gcp/compute-engine/</guid><description>
&lt;p>跟大家介紹一下今天的主題 Google Compute Engine(GCE)，GCE 是 Google Cloud 上的基礎架構服務 (IaaS)，該平台可以提供大規模的虛擬機器以及相關的基礎建設 (包含硬碟、網路、附載平衡器&amp;hellip; 等等)來建置及運作您的服務，那我們可以將 GCE 服務的主要功能劃分成以下幾點：&lt;/p>
&lt;br>
&lt;h2>Google Compute Engine 特色&lt;span class="hx:absolute hx:-mt-20" id="google-compute-engine-特色">&lt;/span>
&lt;a href="#google-compute-engine-%e7%89%b9%e8%89%b2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>穩健的網路功能&lt;span class="hx:absolute hx:-mt-20" id="穩健的網路功能">&lt;/span>
&lt;a href="#%e7%a9%a9%e5%81%a5%e7%9a%84%e7%b6%b2%e8%b7%af%e5%8a%9f%e8%83%bd" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>提供使用者擁有穩健的網路功能，以運行各項應用程式及服務。&lt;/p>
&lt;br>
&lt;h3>自訂網路與預設網路&lt;span class="hx:absolute hx:-mt-20" id="自訂網路與預設網路">&lt;/span>
&lt;a href="#%e8%87%aa%e8%a8%82%e7%b6%b2%e8%b7%af%e8%88%87%e9%a0%90%e8%a8%ad%e7%b6%b2%e8%b7%af" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>GCE 包含內部與外部的網路連線能力，讓使用者可以透過自訂規劃來建置屬於自己服務適用的網路，而在 GCE 服務開通當下，也提供預設的 default network，內建常用的路由與防火牆設定 (例如：SSH、RDP、ICMP&amp;hellip; 等)，供入門使用者直接使用。&lt;/p>
&lt;br>
&lt;h3>防火牆規則&lt;span class="hx:absolute hx:-mt-20" id="防火牆規則">&lt;/span>
&lt;a href="#%e9%98%b2%e7%81%ab%e7%89%86%e8%a6%8f%e5%89%87" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>除了預設防火牆規則外，使用者也可以透過自建防火牆來開放可以連入的 IP。&lt;/p>
&lt;br>
&lt;h3>各區域的 HTTP(S) 的負載平衡&lt;span class="hx:absolute hx:-mt-20" id="各區域的-https-的負載平衡">&lt;/span>
&lt;a href="#%e5%90%84%e5%8d%80%e5%9f%9f%e7%9a%84-https-%e7%9a%84%e8%b2%a0%e8%bc%89%e5%b9%b3%e8%a1%a1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>為 Layer 7 的負載平衡設備，透過設定可以串連多台主機或是主機群組，讓服務不再只是依賴於單點存在的伺服器。Layer 7 的負載平衡更可以識別路由規劃，進一步可以提供不同路由的重導規則設定，也可以提供 CDN 的 Cache 功能。&lt;/p>
&lt;br>
&lt;h3>網路的負載平衡&lt;span class="hx:absolute hx:-mt-20" id="網路的負載平衡">&lt;/span>
&lt;a href="#%e7%b6%b2%e8%b7%af%e7%9a%84%e8%b2%a0%e8%bc%89%e5%b9%b3%e8%a1%a1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>為 Layer4 的負載平衡設備，可以透過 Protocol 與 Port 的方式來重導外部流量到 GCE 主機或主機群，並可以透過 Health Check 的方式，讓流量僅通過健康的主機，避免服務中斷。&lt;/p>
&lt;br>
&lt;h3>子網路&lt;span class="hx:absolute hx:-mt-20" id="子網路">&lt;/span>
&lt;a href="#%e5%ad%90%e7%b6%b2%e8%b7%af" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>透過 CIDR 的方式設定 GCE Network 中的各子網路範圍，並可以透過路由的方式串接各子網路中間的通訊，讓 GCE 網路的設計規劃可以更有彈性，也可以讓子網路的規劃來實作更安全的雲端網路架構。&lt;/p>
&lt;br>
&lt;h2>Google Compute Engine 測試&lt;span class="hx:absolute hx:-mt-20" id="google-compute-engine-測試">&lt;/span>
&lt;a href="#google-compute-engine-%e6%b8%ac%e8%a9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>首先我們使用 cloudskillsboost 提供的 &lt;a href="https://www.cloudskillsboost.google/focuses/3563?locale=zh_TW&amp;amp;parent=catalog"target="_blank" rel="noopener">Creating a Virtual Machine &lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 來做練習，打開後，請先登入自己的 Google 帳號，接著點選左上角的 &lt;strong>Start Lab&lt;/strong>，會跳出與下面圖片類似的內容：&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/1.webp"
alt="測試用的帳號密碼" width="250">&lt;figcaption>
&lt;p>測試用的帳號密碼&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>新增新的 VM 實例&lt;span class="hx:absolute hx:-mt-20" id="新增新的-vm-實例">&lt;/span>
&lt;a href="#%e6%96%b0%e5%a2%9e%e6%96%b0%e7%9a%84-vm-%e5%af%a6%e4%be%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>點選 &lt;strong>Open Google Console&lt;/strong> 按鈕來開啟 GCP 主控台&lt;/li>
&lt;li>登入帳號就使用上面圖片所提供的帳號密碼來進行登入&lt;/li>
&lt;li>登入成功會進入 GCP 主控台，點選左側的 menu &amp;gt; &lt;strong>Compute Engine&lt;/strong> &amp;gt; &lt;strong>VM Instances&lt;/strong>，可以參考下方圖片&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/2.webp"
alt="新增 VM 實例" width="600">&lt;figcaption>
&lt;p>新增 VM 實例&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="4">
&lt;li>點選 &lt;strong>CREATE INSTANCE&lt;/strong>，請依照下方表格來進行設定：&lt;/li>
&lt;/ol>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: center">標題&lt;/th>
&lt;th style="text-align: center">設定值&lt;/th>
&lt;th style="text-align: center">說明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: center">Name&lt;/td>
&lt;td style="text-align: center">gcelab&lt;/td>
&lt;td style="text-align: center">虛擬機實例的名稱&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">Region&lt;/td>
&lt;td style="text-align: center">us-central1（愛荷華州）&lt;/td>
&lt;td style="text-align: center">有關區域的更多信息，請參閱 Compute Engine 指南 &lt;a href="https://cloud.google.com/compute/docs/regions-zones"target="_blank" rel="noopener">Regions and zones&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">Zone&lt;/td>
&lt;td style="text-align: center">us-central1-f&lt;/td>
&lt;td style="text-align: center">&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">Series&lt;/td>
&lt;td style="text-align: center">N1&lt;/td>
&lt;td style="text-align: center">&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">Machine type&lt;/td>
&lt;td style="text-align: center">n1-standard-2&lt;/td>
&lt;td style="text-align: center">這是一個 2 vCPU、7.5 GB RAM 實例&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">Boot disk&lt;/td>
&lt;td style="text-align: center">New balanced persistent disk/10 GB/Debian GNU/Linux 10&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: center">Firewall&lt;/td>
&lt;td style="text-align: center">Allow HTTP taffic&lt;/td>
&lt;td style="text-align: center">&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/3.webp"
alt="VM 實例 (Name、Region、Zone、Series)" width="800">&lt;figcaption>
&lt;p>VM 實例 (Name、Region、Zone、Series)&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/4.webp"
alt="VM 實例 (Machine type、Boot disk、Firewall)" width="800">&lt;figcaption>
&lt;p>VM 實例 (Machine type、Boot disk、Firewall)&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>新增完後，大約需要等待一分鐘，新的虛擬機就會列在 &lt;strong>VM Instances&lt;/strong> 頁面上。&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/5.webp"
alt="VM 實例" width="1000">&lt;figcaption>
&lt;p>VM 實例&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>安裝 NGINX Web 服務器&lt;span class="hx:absolute hx:-mt-20" id="安裝-nginx-web-服務器">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%9d-nginx-web-%e6%9c%8d%e5%8b%99%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>點擊 VM instances 實例最後的 SSH，會開啟 SSH 用戶端&lt;/li>
&lt;li>在 SSH 終端，要先獲得 &lt;code>root&lt;/code> 訪問權限，才更方便的進行後續的動作，請先使用一下指令：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo su -&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;ol start="3">
&lt;li>利用 &lt;code>root&lt;/code> 用戶，來更新操作系統：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>apt-get update&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/6.webp"
alt="更新操作系統" width="1000">&lt;figcaption>
&lt;p>更新操作系統&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="4">
&lt;li>安裝 NGINX：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>apt-get nginx -y&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/7.webp"
alt="安裝 NGINX" width="1000">&lt;figcaption>
&lt;p>安裝 NGINX&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="5">
&lt;li>最後確認 NGINX 是否運行：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>ps auwx | grep nginx&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/8.webp"
alt="確認 NGINX 是否運行" width="1000">&lt;figcaption>
&lt;p>確認 NGINX 是否運行&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="6">
&lt;li>可以打開瀏覽器瀏覽 &lt;code>http://外部 IP/&lt;/code> 或是使用 &lt;code>curl 外部IP&lt;/code>，外部 IP 會在跟剛剛 VM 實例的 External IP 欄位呦～&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/9.webp"
alt="curl 外部 IP" width="700">&lt;figcaption>
&lt;p>curl 外部 IP&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;ol start="7">
&lt;li>完成後，記得可以點選 &lt;strong>Check my progress&lt;/strong> 來檢查進度吧！&lt;/li>
&lt;/ol>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/10.webp"
alt="Check my progress" width="500">&lt;figcaption>
&lt;p>Check my progress&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;h3>使用 gcloud 創建一個新實例&lt;span class="hx:absolute hx:-mt-20" id="使用-gcloud-創建一個新實例">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8-gcloud-%e5%89%b5%e5%bb%ba%e4%b8%80%e5%80%8b%e6%96%b0%e5%af%a6%e4%be%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>我們剛剛是使用網頁版來新增，當然也可以使用 gcloud 指令來新增，這個工具有預先裝在 &lt;a href="https://cloud.google.com/shell#how_do_i_get_started"target="_blank" rel="noopener">Google Cloud Shell&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a> 中。Cloud Shell 是一個基於 Debian 的虛擬機，包含了常用的開發工具 (&lt;code>gcloud&lt;/code>、&lt;code>git&lt;/code> 等工具)，另外你也可以將 gcloud 下載至本機上來做使用，請閱讀&lt;a href="https://cloud.google.com/sdk/gcloud/"target="_blank" rel="noopener"> gcloud 命令行工具指南&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;br>
&lt;ol>
&lt;li>在 Cloud Shell 中，使用 &lt;code>gcloud&lt;/code> 來新增新的虛擬機實例：&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>gcloud compute instances create gcelab2 --machine-type n1-standard-2 --zone us-central1-f&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>就會跳出以下圖片的內容，過一陣子去查看 VM Instances 也可以看到我們所新增的虛擬機實例歐～&lt;/p>
&lt;br>
&lt;figure>&lt;img src="https://pin-yi.me/gcp/compute-engine/11.webp"
alt="Check my progress" width="1000">&lt;figcaption>
&lt;p>Check my progress&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;br>
&lt;p>到這邊就完成了我們 Google Compute Engine 測試囉～我們知道可以新增 GCE 將實體主機的內容，移植到雲端上囉！希望大家會喜歡今天的文章 🥰&lt;/p>
&lt;br>
&lt;h2>參考資料&lt;span class="hx:absolute hx:-mt-20" id="參考資料">&lt;/span>
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Compute Engine 基本介紹：&lt;a href="https://gdgcloud-taipei.gitbook.io/google-cloud-platform-in-practice/google-cloud-shang-de-yun-suan-fu-wu/compute-engine/compute-engine-ji-ben-jie-shao"target="_blank" rel="noopener">https://gdgcloud-taipei.gitbook.io/google-cloud-platform-in-practice/google-cloud-shang-de-yun-suan-fu-wu/compute-engine/compute-engine-ji-ben-jie-shao&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p>
&lt;p>Creating a Virtual Machine：&lt;a href="https://www.cloudskillsboost.google/focuses/3563?locale=zh_TW&amp;amp;parent=catalog"target="_blank" rel="noopener">https://www.cloudskillsboost.google/focuses/3563?locale=zh_TW&amp;amp;parent=catalog&lt;svg class="hx:inline hx:rtl:rotate-270 hx:align-baseline" height="1em" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m9.1716 7.7574h7.0711m0 0v7.0711m0-7.0711-8.4853 8.4853" stroke-linecap="round" stroke-linejoin="round"/>
&lt;/svg>&lt;/a>&lt;/p></description></item></channel></rss>