{"/about/":{"data":{"":" å“ˆå›‰å¤§å®¶å¥½ï¼Œæˆ‘å«èŠå“æ¯…ï¼Œä¹Ÿå¯ä»¥å«æˆ‘ Ianï¼Œç›®å‰æ˜¯ä¸€ä½ Site Reliability Engineering (SRE) å·¥ç¨‹å¸«ï¼Œä¸»è¦è² è²¬ç¶­è­·å…¬å¸çš„ Google Cloud Platform (GCP) é›²ç«¯ç›¸é—œæœå‹™ï¼ŒåŒ…å« GKEã€GCEã€GCSã€GLB ç­‰ç­‰ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿç†Ÿæ‚‰ä½¿ç”¨ Terraform + Terragrunt ä¾†ç®¡ç†é›²ç«¯å¤§é‡çš„ IaC è³‡æºï¼Œé…åˆ Prometheusã€Datadogã€EFK ç­‰ç›£æ§å·¥å…·ä¾†ç¢ºä¿æœå‹™çš„ç©©å®šæ€§ï¼Œå”åŠ© RD å»ºç«‹ CICD éƒ¨ç½²æµç¨‹ã€‚\nåœ¨ä¸‹ç­ç©ºé–’æ™‚é–“ï¼Œæˆ‘å–œæ­¡é–±è®€æŠ€è¡“ç›¸é—œçš„æ–‡ä»¶ã€éƒ¨è½æ ¼ï¼Œä¹ŸæœƒåƒåŠ ä¸€äº›ç·šä¸‹æŠ€è¡“ç¤¾ç¾¤çš„æ´»å‹•ï¼Œä¾‹å¦‚ DevOpsDayï¼Œå¸Œæœ›èƒ½å¤ é€éé€™äº›æ´»å‹•ä¾†å­¸ç¿’æ›´å¤šçš„çŸ¥è­˜ï¼Œæ­¡è¿å¤§å®¶ä½¿ç”¨ä¸‹æ–¹ giscus ç•™è¨€ç³»çµ±ç•™è¨€äº¤æµã€‚","å·¥ä½œç¶“é©—#å·¥ä½œç¶“é©—":" å‡¡è°·èˆˆæ¥­æœ‰é™å…¬å¸ - SRE å·¥ç¨‹å¸« (2022/02 - ç¾åœ¨)"},"title":"é—œæ–¼æˆ‘"},"/blog/":{"data":{"":"","ä»‹ç´¹#ä»‹ç´¹":"ğŸ‘‹ ä½ å¥½ã€å¦³å¥½ã€å¤§å®¶å¥½ï¼Œæ­¡è¿ä¾†åˆ°æˆ‘çš„ç§˜å¯†èŠ±åœ’ï¼Œé€™é‚Šä¸»è¦æœƒè¨˜éŒ„æˆ‘ç ”ç©¶ä¸€å€‹æ–°çš„æŠ€è¡“æˆ–å·¥å…·ã€ä»¥åŠè™•ç†ä¸€äº› SRE é‡åˆ°çš„éˆç•°äº‹ä»¶å•é¡Œçš„å°å¤©åœ°ã€‚\næœƒé–‹å§‹å¯« Blog çš„åˆè¡·ä¸»è¦æ˜¯æˆ‘çš„å°è…¦è¢‹ç“œï¼Œå¦‚æœä¸å¯«ä¸‹ä¾†ï¼Œéé™£å­å¾ˆå®¹æ˜“å°±å¿˜è¨˜ (Â´_ã‚`)ï¼Œç•¶ç„¶ä¹Ÿå¸Œæœ›å¯ä»¥å¹«åŠ©åˆ°æœ‰ç›¸åŒå•é¡Œçš„äºº (å¯ä»¥ä½¿ç”¨æœå°‹åŠŸèƒ½ä¾†å¿«é€Ÿæ‰¾åˆ°ç›¸é—œæ–‡æª”å–”)ï¼Œå¦‚æœæœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿åœ¨ä¸‹æ–¹ç•™è¨€ã€‚","è²æ˜#è²æ˜":"ç”±æ–¼åœ¨å­¸ç¿’æ–°çš„æŠ€è¡“æˆ–å·¥å…·æ™‚ï¼Œæœƒåƒè€ƒç¶²è·¯ä¸Šè¨±å¤šçš„æ–‡ä»¶å’Œç…§ç‰‡ï¼Œé›–ç„¶æœƒåŠ ä¸Šè‡ªå·±çš„è¦‹è§£èˆ‡å¯¦ä½œå…§å®¹æ”¹å¯«è€Œæˆï¼Œä¸”æœƒæ–¼æ–‡ç« å¾Œé™„ä¸Šç›¸é—œè³‡æ–™ä¾†æºï¼Œå¦‚æœ‰ä¾µçŠ¯åˆ°æ‚¨çš„æ¬Šç›Šï¼Œè«‹æ–¼ä¸‹æ–¹å‘ŠçŸ¥ï¼Œæˆ‘æœƒç«‹å³åˆªé™¤ç›¸é—œå…§å®¹ï¼Œè¬è¬ (à¹‘â€¢Ì â‚ƒ â€¢Ì€à¹‘)ã€‚"},"title":"Blog"},"/blog/gcp/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Google Cloud Platform ç›¸é—œçš„æ–‡ç« ã€‚\nå¦‚ä½•éæ¿¾ GCP LOGï¼Œæ¸›å°‘ Cloud Logging API çš„èŠ±è²» Google Kubernetes Engine CronJob æœƒæœ‰çŸ­æš«æ™‚é–“æ²’æœ‰åŸ·è¡Œ Job "},"title":"Google Cloud Platform"},"/blog/gcp/gcp-log-reduce-cloud-logging-api/":{"data":{"":"ç•¶æˆ‘å€‘ä½¿ç”¨ GCP çš„ Cloud Logging æœå‹™ä¾†æŸ¥çœ‹ Log æ™‚ï¼Œæœ‰æ™‚å€™æœƒæœ‰ä¸€äº›æˆ‘å€‘ä¸éœ€è¦é¡¯ç¤ºå‡ºä¾†çš„ï¼Œæˆ–æ˜¯å¾ä¾†éƒ½ä¸æœƒå»æŸ¥è©¢çš„ Logï¼Œå†è€…æ˜¯ GCP æœ¬èº«çš„éŒ¯èª¤å°è‡´å¤§é‡å™´éŒ¯çš„ Log ï¼Œé€™äº› Log éƒ½æœƒå°è‡´ Cloud Logging çš„è²»ç”¨å¢åŠ ã€‚","ä»‹ç´¹-cloud-logging#ä»‹ç´¹ Cloud Logging":"å…ˆä¾†ç°¡å–®èªªä¸€ä¸‹ Cloud Logging é€™é …æœå‹™çš„åŸºæœ¬æ¶æ§‹ï¼Œè«‹çœ‹åœ–ï¼š\nCloud Logging åŸºæœ¬æ¶æ§‹\nå¯ä»¥çœ‹åˆ° Logs Data æœƒé€é API å†ç¶“é _Default log sink (router) å­˜åˆ°ç›¸æ‡‰å‘½åçš„ log bucket (é è¨­é…ç½®)ï¼Œåœ–ä¸­ _Required ä»¥åŠ _Default çš„ log sink éƒ½æ˜¯ GCP è‡ªå‹•å‰µå»ºçš„æ¥æ”¶å™¨ï¼Œä¸‹é¢ç°¡è¿°ä¸€ä¸‹å®ƒå€‘çš„å€åˆ¥ï¼š\n_Required æ—¥èªŒå„²å­˜æ¡¶ Cloud Logging æœƒå°‡ä»¥ä¸‹é¡å‹çš„ Log å­˜åˆ° _Required å„²å­˜æ¡¶\nç®¡ç†å“¡æ´»å‹•å¯©æ ¸ Log\nç³»çµ±äº‹ä»¶å¯©æ ¸ Log\nAccess Transparency Log\nCloud Logging æœƒå°‡ _Required å„²å­˜æ¡¶ Log ä¿ç•™ 400 å¤©ï¼Œç„¡æ³•èª¿æ•´è©²æœŸé™ï¼Œä¸”ç„¡æ³•ä¿®æ”¹æˆ–åˆªé™¤ _Required å„²å­˜æ¡¶ï¼Œä¹Ÿæ²’è¾¦æ³•åœç”¨ _Required log sink æ¥å—å™¨è·¯ç”±åˆ° _Required å„²å­˜æ¡¶çš„è¨­å®šã€‚\n_Default æ—¥èªŒå„²å­˜æ¡¶ åªè¦ä¸æ˜¯å­˜åœ¨ _Required æ—¥èªŒå„²å­˜æ¡¶çš„ Log å°±æœƒé€é _Default log sink æ¥å—å™¨è·¯ç”±åˆ° _Default å„²å­˜æ¡¶ã€‚\né™¤éæœ‰å¦å¤–é…ç½®è‡ªå®šç¾©è¨­å®šï¼Œ å¦å‰‡ _Default æ—¥èªŒå„²å­˜æ¡¶ Log åªæœƒä¿ç•™ 30 å¤©ï¼Œä¹Ÿä¸€æ¨£ç„¡æ³•åˆªé™¤ _Default æ—¥èªŒå„²å­˜æ¡¶ã€‚æ­¤å¤– Cloud Logging çš„è²»ç”¨æ˜¯ä»¥å­˜åœ¨ _Default æ—¥èªŒå„²å­˜æ¡¶ä¾†è¨ˆç®—ã€‚\nåŠŸèƒ½ åƒ¹æ ¼ æ¯æœˆå…è²»é¡åº¦ Logging æå– æå–çš„ Log $0.5/GiB æ¯å€‹é …ç›®å‰ 50 GiB Logging å„²å­˜ ä¿ç•™è¶…é 30 å¤©çš„ Logï¼Œæ¯æœˆæ¯ GiB $0.01 åœ¨é»˜èªä¿ç•™æœŸé™çš„ Log ä¸æœƒæœ‰é¡å¤–å„²å­˜è²»ç”¨ æŸ¥çœ‹è©²å°ˆæ¡ˆä½¿ç”¨çš„ Cloud Logging API è²»ç”¨ï¼šhttps://console.cloud.google.com/apis/api/logging.googleapis.com/cost","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Routing and storage overview https://cloud.google.com/logging/docs/routing/overview","éæ¿¾-log#éæ¿¾ Log":"é‚£ç¾åœ¨çŸ¥é“ Cloud Logging çš„æ¶æ§‹ï¼Œé‚£ç•¶æˆ‘å€‘é‡åˆ°éœ€è¦éæ¿¾ Log æ™‚ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ­¥é©Ÿä¾†éæ¿¾ä»¥ç¯€çœ Cloud Logging API è²»ç”¨ï¼š\nç¯„ä¾‹èªªæ˜ é€™æ¬¡ç¯„ä¾‹æ˜¯ google åœ¨ 2023/07/06 æ‰€ç™¼ä½ˆçš„ Service Healthï¼Œç•¶ GKE ç‰ˆæœ¬å¤§æ–¼ 1.24 ä»¥ä¸Šï¼Œå°±æœƒå™´\nFailed to get record: decoder: failed to decode payload: EOF\ncannot parse â€˜0609 05:31:59.491654â€™ after %L\ninvalid time format %m%d %H:%M:%S.%L%z for â€˜0609 05:31:59.490647â€™\né€™ä¸‰ç¨®é¡å‹çš„éŒ¯èª¤ Logï¼Œåœ¨ç­‰å¾…å®˜æ–¹ä¿®å¾©å‰ï¼Œå®˜æ–¹çš„å»ºè­°æ˜¯å…ˆå°‡ä»–çµ¦éæ¿¾æ‰ï¼Œé¿å…ä¸€ç›´åˆ·å™´éŒ¢ â”(Â´Ğ´`)â”Œ\né™„ä¸Šç•¶æ™‚çš„ Service Health é€£çµï¼šhttps://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE\næˆ‘å€‘åœ¨ä¸Šé¢æ¶æ§‹åœ–æœ‰èªªåˆ°ï¼ŒLog æœƒé€é log sink è·¯ç”±åˆ° bucketï¼Œæ‰€ä»¥æˆ‘å€‘è¦å°‡éæ¿¾æ¢ä»¶åŠ åœ¨ log router ä¸Šï¼š\né¸æ“‡ Log Router é¸æ“‡ Log Router\né¸æ“‡ Log Router Sinks é¸æ“‡ _Default çš„ Log Router Sinksï¼Œé»é¸å³é‚ŠæŒ‰éˆ•çš„ Edit Sink\né¸æ“‡ _Default çš„ Log Router Sinks\nè¨­å®š Sink details ç¬¬ä¸€å€‹æ˜¯ detailsï¼Œå¯ä»¥è¼¸å…¥èªªæ˜ï¼Œé€™é‚Šè¼¸å…¥ï¼šgoogle æœ‰ bug æœƒå™´å¤§é‡çš„æ„å¤– LOGï¼Œæ€•è²»ç”¨é£†é«˜ï¼Œå…ˆç”¨å®˜æ–¹å»ºè­°çš„ä¾†éæ¿¾ LOGï¼Œè©³ç´°å¯ä»¥çœ‹ï¼š https://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE\nè¼¸å…¥ Sink details èªªæ˜\né¸æ“‡ Sink Service è·Ÿ Bucket æ¥è‘— sink æœå‹™é¸æ“‡ Logging bucketï¼Œä»¥åŠå°æ‡‰å„²å­˜çš„ log bucket (é€™é‚ŠåŸºæœ¬ä¸Šéƒ½æ˜¯é è¨­)\né¸æ“‡ Logging bucket\nè¨­å®š include Log é¸æ“‡é‚£äº›å¯ä»¥è¢« include åˆ° sink æ¥æ”¶å™¨çš„ LOG æ ¼å¼ (é€™é‚ŠåŸºæœ¬ä¸Šéƒ½æ˜¯é è¨­)\né è¨­çš„ LOG æ ¼å¼\nè¨­å®š filter Log é€™é‚Šå°±æ˜¯æˆ‘å€‘è¦è¼¸å…¥éæ¿¾çš„åœ°æ–¹ï¼Œå…ˆé»æ“Š ADD EXCLUSIONï¼Œè¼¸å…¥éæ¿¾çš„åç¨±ï¼Œä»¥åŠéæ¿¾çš„å…§å®¹æ ¼å¼ï¼Œæˆ‘å€‘è¼¸å…¥ google åœ¨ Service Health æ‰€æä¾›çš„æ ¼å¼ï¼Œæœ€å¾ŒæŒ‰ä¸‹ UPDATE SINK\næ–°å¢è¦éæ¿¾çš„ LOG æ ¼å¼\nè¨­å®šå®Œæˆ ç­‰å¾…æ›´æ–°å®Œæˆï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘å€‘å·²ç¶“åœ¨æ¥æ”¶å™¨ä¸Šè¨­å®šå¥½éæ¿¾æ¢ä»¶å›‰ï½\næŸ¥çœ‹è©³ç´°æ¥æ”¶å™¨è¨­å®š\næª¢æŸ¥ Log æ˜¯å¦éæ¿¾æˆåŠŸ æœ€å¾Œå†æª¢æŸ¥ä¸€ä¸‹ Log æ˜¯ä¸æ˜¯æ²’æœ‰æ”¶åˆ°è©²éŒ¯èª¤çš„ Log å…§å®¹\næª¢æŸ¥ LOG æ˜¯å¦ä¸æœƒå†å‡ºç¾"},"title":"å¦‚ä½•éæ¿¾ GCP LOGï¼Œæ¸›å°‘ Cloud Logging API çš„èŠ±è²»"},"/blog/gcp/gke-cronjob-not-working/":{"data":{"":"å‰é™£å­å…¬å¸å»ºç«‹åœ¨ Google Kubernetes Engine å¢é›†ä¸Šçš„ CronJob æœå‹™æœƒæœ‰çŸ­æš«æ™‚é–“æ²’æœ‰åŸ·è¡Œ Jobã€‚å…ˆå‰æƒ…æè¦ä¸€ä¸‹ï¼Œæ­¤ CronJob çš„è¨­å®šæ˜¯æ¯åˆ†é˜éƒ½æœƒåŸ·è¡Œ (åœ–ä¸€)ï¼Œæ‰€ä»¥ç†ç•¶ä¾†èªª Log æ‡‰è©²è¦å¯ä»¥çœ‹åˆ°æ¯åˆ†é˜éƒ½æœ‰æ­¤ CronJob çš„ç´€éŒ„ï¼Œä½†æœ‰æ™‚å€™æœƒç™¼ç”Ÿ CronJob çŸ­æš«æ™‚é–“éƒ½æ²’æœ‰åŸ·è¡Œçš„ç‹€æ³ï¼Œæ‰¾äº†ä¸€é™£å­éƒ½æ²’æœ‰æ‰¾åˆ°åŸå› ï¼Œæœ€å¾Œé–‹æ”¯æ´å–®è«‹ Google é‚£é‚Šå”åŠ©æŸ¥çœ‹ï¼Œçµ‚æ–¼æ‰¾åˆ°åŸå› æ‹‰ ğŸ˜ã€‚é‚£å°±è·Ÿæˆ‘ä¸€èµ·çœ‹ä¸€ä¸‹ç™¼ç”Ÿçš„éç¨‹ï¼Œä»¥åŠ Google å¹«æˆ‘å€‘æ‰¾åˆ°çš„åŸå› ï¼Œä»¥åŠè¦å¦‚ä½•è§£æ±ºç­‰ç­‰ï½\n(åœ–ä¸€) CronJob schedule æ™‚é–“ç‚ºæ¯åˆ†é˜åŸ·è¡Œ","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"[1] Standard cluster upgradesï¼šhttps://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades\n[2] maintenance-windows-and-exclusionsï¼šhttps://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions","å•é¡Œç™¼ç”Ÿä»¥åŠå•é¡ŒåŸå› #å•é¡Œç™¼ç”Ÿä»¥åŠå•é¡ŒåŸå› ":"æˆ‘å€‘ä½¿ç”¨ Google Cloud Platform è£¡é¢çš„è¨˜éŒ„åŠŸèƒ½ï¼Œå¯ä»¥çœ‹åˆ° (åœ–äºŒ)ï¼Œåœ¨æ¯åˆ†é˜åŸ·è¡Œçš„ Log ä¸­ï¼Œæœ‰çŸ­æš«æ™‚é–“æ²’æœ‰åŸ·è¡Œ Jobï¼Œä½†é€™å€‹æ™‚é–“é™¤äº† CronJob ä»¥å¤–ï¼Œå…¶ä»–çš„æœå‹™éƒ½æ˜¯å¥½çš„ã€‚\n(åœ–äºŒ) Google Cloud Platform è¨˜éŒ„æœ‰çŸ­æš«æ²’æœ‰åŸ·è¡Œ\næ‰¾äº†ä¸€é™£å­éƒ½æ²’æœ‰æ‰¾åˆ°åŸå› ï¼Œæ–¼æ˜¯æˆ‘å€‘é–‹æ”¯æ´å–®è«‹ Google é‚£é‚Šå”åŠ©æŸ¥çœ‹ï¼ŒGoogle é‚£é‚Šæ‰¾äº†ä¸€é™£å­å¾Œçµ‚æ–¼æ‰¾åˆ°åŸå› æ‹‰ï¼ï¼ï¼æˆ‘å€‘ä¸€èµ·ä¾†çœ‹çœ‹å§ (åœ–ä¸‰)\n(åœ–ä¸‰) Google æ”¯æ´å–®å›è¦†\nå°±å¦‚åŒ Google æ‰€èªªï¼Œä½¿ç”¨æä¾›çš„æŒ‡ä»¤åƒæ•¸ä¾†æŸ¥è©¢ï¼Œå¢é›†åœ¨è©²æ™‚æ®µæœ‰ç™¼ç”Ÿ master control plane çš„å‡ç´šï¼Œå¦‚ (åœ–å››)ï¼Œå†åŠ ä¸Šæˆ‘å€‘å»ºçš„é€™å€‹ cluster æ˜¯ä½¿ç”¨ zonal cluster (åœ–äº”)ï¼Œæ‰€ä»¥å¢é›†åªæœ‰ä¸€å€‹ control planeï¼Œç•¶ control plane åœ¨æ›´æ–°æ™‚ï¼Œæœƒç„¡æ³•éƒ¨ç½²æ–°çš„ workloadï¼Œå°è‡´è©² CronJob æ²’æœ‰åŸ·è¡Œ Jobã€‚åƒè€ƒè³‡æ–™ [1]\n(åœ–å››) ç™¼ç”Ÿ master control plane çš„å‡ç´š\n(åœ–äº”) æœ‰å•é¡Œçš„å¢é›†ä½ç½®é¡å‹\nGoogle çš„å»ºè­°æ˜¯å¯ä»¥è€ƒæ…®ä½¿ç”¨å¦ä¸€å€‹ regional clusterï¼Œè®“ master node åœ¨æ›´æ–°æ™‚ä¸æœƒåªåœ¨å–®ä¸€åœ°å€ï¼Œæˆ–æ˜¯ä¸€æ¨£ä½¿ç”¨èˆŠçš„ zonal clusterï¼Œé€éè¨­å®š Maintenance window æˆ–è€… Maintenance exclusions ä¾†é™ä½æœå‹™å—åˆ° workload çš„å½±éŸ¿ã€‚åƒè€ƒè³‡æ–™ [2]\nå°±ç®—æŠŠ node_pool è£¡é¢çš„è‡ªå‹•å‡ç´šçµ¦åœæ‰ï¼Œä¹Ÿæ²’æœ‰è¾¦æ³•è§£æ±ºæ­¤å•é¡Œï¼å› ç‚ºæ­¤ master control plane (ä¹Ÿå°±æ˜¯ master node) çš„å‡ç´šï¼Œä¸æ˜¯ worker node çš„ node pool å‡ç´šï¼Œæ˜¯ç”± GKE è² è²¬ç¶­è­·çš„ï¼Œæ‰€ä»¥ä»–å€‘æœƒå®šæœŸå‡ç´š control planeï¼Œä¹Ÿæ²’è¾¦æ³•åœæ­¢æ­¤é¡çš„å‡ç´šã€‚\nè‹¥å·²ç¶“å»ºç«‹å¥½ zonal cluster å¾Œï¼Œæƒ³è¦æ”¹æˆ regional cluster ï¼Œæ˜¯æ²’æœ‰è¾¦æ³•ä½¿ç”¨ä¿®æ”¹çš„æ–¹å¼ï¼Œä¸€å®šåªèƒ½é‡å»º clusterï¼Œæ‰€ä»¥å¤§å®¶åœ¨å»ºç«‹æ™‚è¦æ³¨æ„ï½","è§£æ±ºå•é¡Œ#è§£æ±ºå•é¡Œ":"æœ€å¾Œæˆ‘å€‘é¸æ“‡å°‡å¢é›†çµ¦æ•´å€‹é‡å»ºï¼Œä¾†ç¢ºä¿ CronJob ä¸æœƒæœ‰æ²’æœ‰åŸ·è¡Œåˆ°çš„ç‹€æ³ç™¼ç”Ÿï¼Œé‡å»ºå¢é›†è·Ÿæ¬æœå‹™çš„éç¨‹å¾ˆè¾›è‹¦çš„ ğŸ˜° å¸Œæœ›å¤§å®¶ä¸è¦ç™¼ç”Ÿ QQï¼Œæœ€å¾Œæˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹é‡å»ºå®Œå¾Œï¼Œåœ¨ master control plane æ›´æ–°çš„æ™‚å€™ï¼Œé‚„æœƒä¸æœƒæœ‰ CronJob æ²’æœ‰åŸ·è¡Œçš„æƒ…æ³ç™¼ç”Ÿã€‚\næ–°å¢é›†ä½¿ç”¨ regional cluster ä¾†å»ºç«‹ï¼Œåœ¨ 2/1 ä¹Ÿæœ‰ master control plane çš„å‡ç´šã€‚ (åœ–å…­)\n(åœ–å…­) ç™¼ç”Ÿ master control plane çš„å‡ç´š\næŸ¥çœ‹ CronJob åŸ·è¡Œçš„ç´€éŒ„å¯ä»¥ç™¼ç¾ä¸¦æ²’æœ‰ Job æ²’æœ‰åŸ·è¡Œçš„æƒ…æ³ç™¼ç”Ÿã€‚ (åœ–ä¸ƒ)\n(åœ–ä¸ƒ) å¢é›†ä½ç½®é¡å‹\n(åœ–å…«) æ–°å¢é›†ä½ç½®é¡å‹"},"title":"Google Kubernetes Engine CronJob æœƒæœ‰çŸ­æš«æ™‚é–“æ²’æœ‰åŸ·è¡Œ Job"},"/blog/kubernetes/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Kubernetes ç›¸é—œçš„æ–‡ç« ã€‚\nåœ¨æ­£å¼ç’°å¢ƒä¸Šè¸©åˆ° StatefulSet çš„é›·ï¼Œæ‹¿åˆ° P1 çš„æ•™è¨“ éƒ¨ç½² Pod é‡åˆ° container veth name provided (eth0) already exists éŒ¯èª¤ Kubernetes (K8s) HorizontalPodAutoscaler (HPA) åŸç†èˆ‡å¯¦ä½œ Kubernetes (K8s) è‡ªå®šç¾© PHP HorizontalPodAutoscaler (HPA) æŒ‡æ¨™ "},"title":"Kubernetes"},"/blog/kubernetes/gcp-k8s-hpa-php-custom-metrics/":{"data":{"":"æ­¤ç¯‡è¦ä»‹ç´¹ HorizontalPodAutoscaler çš„è‡ªå®šç¾©æŒ‡æ¨™ï¼ŒK8s å…§å»ºçš„æŒ‡æ¨™ (metrics) åªæ”¯æ´ CPU ä»¥åŠ Memoryï¼Œå¦‚æœæˆ‘å€‘ä»Šå¤©æƒ³è¦ä½¿ç”¨å…¶ä»–çš„æŒ‡æ¨™ä¾†è®“ HPA æ“´ç¸®å‘¢ï¼ï¼Ÿ ä¸çŸ¥é“ä»€éº¼æ˜¯ HorizontalPodAutoscaler å—ï¼Ÿå¯ä»¥å…ˆæŸ¥çœ‹ï¼š\nKubernetes (K8s) HorizontalPodAutoscaler (HPA) åŸç†èˆ‡å¯¦ä½œ é€™æ™‚å€™æˆ‘å€‘å°±å¿…é ˆä½¿ç”¨è‡ªå®šç¾©æŒ‡æ¨™ï¼Œæˆ‘å€‘ä¸€æ¨£ä¾†èªªèªªä»–çš„å·¥ä½œåŸç†å§ï¼šHorizontalPodAutoscaler æ˜¯æ€éº¼å–å¾—è‡ªå®šç¾©æŒ‡æ¨™ï¼Œä»¥åŠæ˜¯è·Ÿèª°æ‹¿åˆ°æŒ‡æ¨™çš„å‘¢ï¼Ÿæˆ‘å€‘å¾ä¸‹åœ–å¾—çŸ¥ï¼š\nKubernetes HPA : ExternalMetrics+Prometheus\nHorizontalPodAutoscaler æœƒå…ˆè¨ªå• K8s çš„ APIï¼Œä¸¦å‘ API å–å¾—æŒ‡æ¨™è³‡æ–™ã€‚é€™é‚Šçš„ API å°±æ˜¯ custom.k8s.io/v1beta1ã€‚\nå¤§è‡´äº†è§£å¾Œï¼Œæˆ‘å€‘å°±ä¾†é€²å…¥ä»Šå¤©çš„é‡é»ï¼Œä¹Ÿå°±æ˜¯é€éè‡ªå®šç¾©åŒ– PHP çš„æŒ‡æ¨™ä¾†è®“ HorizontalPodAutoscaler é€²è¡Œæ“´ç¸®ï¼Œé€™æ¬¡ä½¿ç”¨çš„å¹³å°æ˜¯ Google Cloud Platformï¼Œå‰é¢ä»‹ç´¹ GCP æœå‹™çš„å¤§å®¶å¯ä»¥åƒè€ƒ Google Cloud Platform (GCP) ç™¾ç§‘å…¨æ›¸ - ä»‹ç´¹èˆ‡é–‹é ­ [ EP.0 ]ï¼Œæˆ‘å€‘é€™é‚Šå°±ç›´æ¥è·³åˆ°ç¨‹å¼ç¢¼èˆ‡æ“ä½œéƒ¨åˆ†ã€‚\næ­¤æ–‡ç« ç¨‹å¼ç¢¼ä¹ŸæœƒåŒæ­¥åˆ° Github ï¼Œéœ€è¦çš„ä¹Ÿå¯ä»¥å» clone ä½¿ç”¨æ­ï¼ Github ç¨‹å¼ç¢¼é€£çµ ğŸ˜†","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Autoscaling Deployments with Cloud Monitoring metricï¼šhttps://cloud.google.com/kubernetes-engine/docs/tutorials/autoscaling-metrics#custom-prometheus_1\nGoogleCloudPlatform/k8s-stackdriverï¼šhttps://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter\nhipages/php-fpm_exporterï¼šhttps://github.com/hipages/php-fpm_exporter\nScaling PHP-FPM with custom metrics on GKE/kubernetesï¼šhttps://www.ashsmith.io/scaling-phpfpm-with-custom-metrics-gke","å¯¦ä½œ#å¯¦ä½œ":"å®‰è£è‡ªå®šç¾©çš„ Adapter æˆ‘å€‘è¦å…ˆ Apply è‡ªå®šç¾©çš„ Adapterï¼Œé€™é‚Šæˆ‘å€‘ä½¿ç”¨ Google æä¾›çš„ Stackdriver Adapter ä¾†ä½¿ç”¨ (ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Github ç¨‹å¼ç¢¼ä¸­çš„ adapter_new_resource_model.yaml æª”æ¡ˆæ­)ï¼š\nkubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter_new_resource_model.yaml Deployment apiVersion: apps/v1 kind: Deployment metadata: name: demo labels: app: demo spec: replicas: 1 selector: matchLabels: app: demo template: metadata: labels: app: demo spec: containers: - name: php-fpm image: php:fpm workingDir: /var/www/service ports: - containerPort: 9000 resources: requests: cpu: 100m memory: 1G limits: cpu: 100m memory: 1G volumeMounts: - name: application mountPath: /var/www/service/ - name: php-fpm-config mountPath: /usr/local/etc/php-fpm.d/www.conf subPath: www.conf - name: nginx image: nginx:alpine workingDir: /var/www/service ports: - containerPort: 80 volumeMounts: - name: application mountPath: /var/www/service/ - name: nginx-config mountPath: /etc/nginx/conf.d/ - name: phpfpm-exporter image: hipages/php-fpm_exporter:latest env: - name: PHP_FPM_SCRAPE_URI value: \"tcp://localhost:9000/status\" - name: PHP_FPM_FIX_PROCESS_COUNT value: \"true\" resources: requests: cpu: 10m limits: cpu: 10m - name: prometheus-to-sd image: gcr.io/google-containers/prometheus-to-sd:v0.9.0 ports: - containerPort: 6060 protocol: TCP command: - /monitor - --stackdriver-prefix=custom.googleapis.com - --monitored-resource-type-prefix=k8s_ - --source=:http://localhost:9253 - --pod-id=$(POD_NAME) - --namespace-id=$(POD_NAMESPACE) resources: requests: cpu: 10m limits: cpu: 10m env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace volumes: - name: application emptyDir: {} - name: php-fpm-config configMap: name: php-fpm-conf - name: nginx-config configMap: name: nginx-conf æˆ‘ä¾†ç°¡å–®èªªæ˜ä¸€ä¸‹ï¼Œé€™æ˜¯ä¸€å€‹ Deploymentï¼Œæˆ‘å€‘åœ¨æ¯ä¸€å€‹ Pod è£¡é¢éƒ½æ”¾ 4 å€‹ Containerï¼Œåˆ†åˆ¥æ˜¯ php-fpmã€nginxã€phpfpm-exporterã€prometheus-to-sd\nphp-fpm å°±æ˜¯æˆ‘å€‘è¦ä½¿ç”¨çš„ phpï¼Œnginx æœƒæä¾› 9000 Port è®“ phpfpm-exporter å»æŠ“åˆ°ç›®å‰çš„ Process æ•¸å€¼ï¼Œæœ€å¾Œä¸Ÿçµ¦ prometheus-to-sdï¼Œè®“ä»–å»é€šçŸ¥æˆ‘å€‘å‰›å‰›æ‰€å®‰è£çš„ Adapterï¼Œå°±å¯ä»¥é€é API è®“ HPA çŸ¥é“ï¼è½ä¸å¤ªæ‡‚å—ï¼Ÿæ²’é—œä¿‚ï¼Œå¹«å¤§å®¶ç•«äº†ä¸€å¼µåœ–ï¼Œè«‹åƒè€ƒä¸‹æ–¹åœ–ç‰‡ï¼š\næ¶æ§‹åœ–\nå¯ä»¥çœ‹åˆ° Deployment è£¡é¢ï¼Œæˆ‘å€‘ä½¿ç”¨ ConfigMap ä¾†æ›è¼‰ php çš„ www.conf ä»¥åŠ nginx çš„è¨­å®šæª”ï¼Œé‚£æˆ‘å€‘æ¥ä¸‹ä¾†å°±å¯«ä¸€ä»½ ConfigMap å§ï¼\nConfigMap apiVersion: v1 kind: ConfigMap metadata: name: php-fpm-conf data: www.conf: | [www] user = 900 group = 900 listen = 9000 listen.owner = 900 listen.group = 900 listen.mode = 0660 pm = dynamic pm.max_children = 150 pm.max_requests = 300 pm.start_servers = 24 pm.min_spare_servers = 24 pm.max_spare_servers = 126 pm.status_path = /status ping.path = /ping ping.response = OK catch_workers_output = yes request_terminate_timeout = 300 clear_env = no --- apiVersion: v1 kind: ConfigMap metadata: name: nginx-conf namespace: ian data: nginx.conf: | server { listen 80; listen [::]:80; server_name _; root /var/www/service/; index index.php; location / { try_files $uri $uri/ /index.php$is_args$args; } location ~ ^/(status|ping)$ { fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } } é€™ä»½ ConfigMap.yaml æª”æ¡ˆè£¡é¢åˆ†æˆ php-fpm-conf ä¾†æ”¾ www.confï¼Œä»¥åŠ nginx-conf ä¾†æ”¾ nginx.conf æª”æ¡ˆï¼Œé€™é‚Šè¦æ³¨æ„çš„æ˜¯ www.conf è¨˜å¾—è¦åŠ ä¸Š pm.status_path = /statusï¼Œphpfpm-exporter æ˜¯é€éé€™å€‹é é¢ä¾†ç²å¾— Process æ•¸é‡ã€‚\nHorizontalPodAutoscaler apiVersion: autoscaling/v2beta2 kind: HorizontalPodAutoscaler metadata: name: demo-hpa spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: demo minReplicas: 1 maxReplicas: 10 metrics: - type: Pods pods: metric: name: phpfpm_active_processes target: averageValue: 50 type: AverageValue - type: Pods pods: metric: name: phpfpm_idle_processes target: averageValue: 50 type: AverageValue - type: Pods pods: metric: name: phpfpm_total_processes target: averageValue: 50 type: AverageValue - type: Pods pods: metric: name: phpfpm_accepted_connections target: averageValue: 50 type: AverageValue é€™ä»½ HorizontalPodAutoscaler æˆ‘å€‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ autoscaling/v2beta2ï¼Œ v2beta1 è·Ÿ v2beta2 çš„è¨­å®šæª”èªæ³•æœ‰äº›ä¸åŒï¼\nå¯ä»¥çœ‹åˆ°æˆ‘å€‘ metrics.pods.metric.name åˆ†åˆ¥æ˜¯ phpfpm_active_processes (æ´»å‹•çš„é€²ç¨‹å€‹æ•¸)ã€phpfpm_idle_processes (ç©ºé–’çš„é€²ç¨‹å€‹æ•¸)ã€phpfpm_total_processes (ç¸½å…±çš„é€²ç¨‹å€‹æ•¸)ã€phpfpm_accepted_connections (ç•¶å‰çš„é€£æ¥æ•¸é‡)ï¼Œå¦‚æœè¶…éæˆ‘å€‘æ‰€è¨­å®šçš„ target å€¼ï¼ŒHPA å°±æœƒä½œå‹•ã€‚\næˆ‘å€‘ä¾åºæŠŠ Deployment \u003e ConfigMap \u003e HorizontalPodAutoscaler çš„ yaml æª”æ¡ˆçµ¦ Applyï¼Œå¯ä»¥è§€å¯Ÿä¸€ä¸‹ Pod æ˜¯å¦éƒ½æœ‰æ­£å¸¸å•Ÿå‹•ï¼š\nPod æ˜¯å¦æ­£å¸¸å•Ÿå‹•\næˆ‘å€‘åˆ° HorizontalPodAutoscaler æŸ¥çœ‹æˆ‘å€‘æ‰€è¨­å®šçš„ metrics æ˜¯å¦éƒ½æœ‰æŠ“åˆ°ç›®å‰çš„å€¼ï¼š\nmetrics æ˜¯å¦éƒ½æœ‰æŠ“åˆ°ç›®å‰çš„å€¼\næˆ‘å€‘ä¹Ÿå¯ä»¥ç”¨ Google Cloud Platform çš„ç›£æ§ä¾†æŸ¥çœ‹ï¼š\nGoogle Cloud Platform çš„ç›£æ§\nä»¥ä¸Šå°±å®Œæˆ è‡ªå®šç¾© HorizontalPodAutoscaler æŒ‡æ¨™å›‰ï½ ğŸ˜"},"title":"Kubernetes (K8s) è‡ªå®šç¾© PHP HorizontalPodAutoscaler (HPA) æŒ‡æ¨™"},"/blog/kubernetes/k8s-hpa/":{"data":{"":"æ­¤ç¯‡æ˜¯è¦ä»‹ç´¹ HorizontalPodAutoscaler (HPA) çš„åŸç†ä»¥åŠå¯¦ä½œå…§å®¹ï¼Œé‚£æˆ‘å€‘å…ˆä¾†èªªæ˜ä¸€ä¸‹ HorizontalPodAutoscaler æ˜¯ä»€éº¼å§ï¼","horizontalpodautoscaler-åŸç†#HorizontalPodAutoscaler åŸç†":"HorizontalPodAutoscaler (HPA) ä¸­æ–‡å¯ä»¥å«æ°´å¹³ Pod è‡ªå‹•æ“´ç¸®ï¼Œä»–æœƒè‡ªå‹•æ›´æ–°å·¥ä½œè² è¼‰è³‡æº (Deployment æˆ– StatefulSet)ï¼Œå…¶ç›®çš„æ˜¯é€éè‡ªå‹•æ“´ç¸®å·¥ä½œè² è¼‰ä¾†æ»¿è¶³ä½¿ç”¨éœ€æ±‚ã€‚\nç°¡å–®ä¾†èªªä»–æœƒæ ¹æ“šä½ ç¾åœ¨çš„è² è¼‰å»èª¿æ•´ä½ çš„ Pod æ•¸é‡ï¼Œç•¶ç›®å‰çš„è² è¼‰è¶…éé…ç½®çš„è¨­å®šæ™‚ï¼ŒHPA æœƒæŒ‡ç¤ºå·¥ä½œè² è¼‰è³‡æº (Deployment æˆ– StatefulSet) æ“´å¢ï¼Œä¾†é¿å…å¡çˆ†åŒä¸€å€‹è² è¼‰è³‡æºã€‚\nå¦‚æœè² è¼‰æ¸›å°‘ï¼Œä¸” Pod æ•¸é‡é«˜æ–¼é…ç½®çš„æœ€å°å€¼ï¼ŒHPA ä¹ŸæœƒæŒ‡ç¤ºå·¥ä½œè² è¼‰è³‡æº (Deployment æˆ– StatefulSet) æ…¢æ…¢ç¸®æ¸›ã€‚å…¶ä¸­æ°´å¹³ Pod è‡ªå‹•æ“´ç¸®ä¸é©ç”¨ DaemonSet å·¥ä½œè² è¼‰è³‡æºã€‚\nHPA æ˜¯å¦‚ä½•å·¥ä½œå‘¢ï¼Ÿ HorizontalPodAutoscaler å·¥ä½œæµç¨‹åœ–\nKubernetes å°‡æ°´å¹³ Pod è‡ªå‹•æ“´ç¸®å®šç¾©ç‚ºä¸€å€‹é–“æ­‡é‹è¡Œçš„æ§åˆ¶è¿´è·¯ï¼Œä»–ä¸æ˜¯é€£çºŒçš„ï¼Œå…¶é–“éš”æ˜¯ç”± kube-controller-manager çš„ --horizontal-pod-autoscaler-sync-period åƒæ•¸ä¾†é…ç½®ï¼Œé è¨­æ˜¯ 15 ç§’ï¼Œcontroller-manager æœƒä¾æ“šæ¯ä¸€å€‹ HPA å®šç¾©çš„ scaleTargetRef ä¾†æ‰¾åˆ°æ˜¯å“ªä¸€å€‹å·¥ä½œè² è¼‰è³‡æºéœ€è¦é€²è¡Œæ°´å¹³ Pod è‡ªå‹•æ“´ç¸®ï¼Œç„¶å¾Œæ ¹æ“šç›®æ¨™è³‡æºçš„ .spec.selector æ¨™ç±¤é¸æ“‡å°æ‡‰çš„ Podï¼Œä¸¦å¾è³‡æºæŒ‡æ¨™ API æˆ–è‡ªå®šç¾©æŒ‡æ¨™ç²å– APIï¼Œç›®å‰ç¸½å…±æœ‰ä¸‰ç¨®çš„è³‡æºæŒ‡æ¨™ï¼Œåˆ†åˆ¥æ˜¯ CPUã€Memoryã€è‡ªå®šç¾©æŒ‡æ¨™ã€‚\næœ‰é—œæ–¼å…¶ä»– Kubernetes è§€å¿µéƒ¨åˆ†ï¼Œå¯ä»¥å…ˆæŸ¥çœ‹ï¼š\nKubernetes : Kubernetes (K8s) ä»‹ç´¹ - åŸºæœ¬ kubernetes : Kubernetes (K8s) ä»‹ç´¹ - é€²éš (Serviceã€Ingressã€StatefulSetã€Deploymentã€ReplicaSetã€ConfigMap) æ­¤æ–‡ç« ç¨‹å¼ç¢¼ä¹ŸæœƒåŒæ­¥åˆ° Github ï¼Œéœ€è¦çš„ä¹Ÿå¯ä»¥å» clone ä½¿ç”¨æ­ï¼è¦è¨˜å¾—å…ˆç¢ºå®šä¸€ä¸‹è‡ªå·±çš„ç‰ˆæœ¬ Github ç¨‹å¼ç¢¼é€£çµ ğŸ˜†","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Horizontal Pod Autoscalingï¼šhttps://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/\nHorizontalPodAutoscaler Walkthroughï¼šhttps://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/","å¯¦ä½œ#å¯¦ä½œ":"é€™æ¬¡å¯¦ä½œè¦ä½¿ç”¨çš„å¢é›†æ˜¯ Minikubeï¼Œæ‰€ä»¥ç…§ä»¥å‰æ–‡ç« ä¸€æ¨£ï¼Œæˆ‘å€‘å…ˆå•Ÿå‹• Minikubeã€‚æœ¬æ¬¡æœƒä½¿ç”¨ K8s çš„ç®¡ç†å·¥å…·ï¼šk8slens ä¾†åšç‚ºè¼”åŠ©ï¼Œå¤§å®¶æœ‰èˆˆè¶£ä¹Ÿå¯ä»¥å…ˆå»ä¸‹è¼‰ä¾†ä½¿ç”¨æ­ ğŸ˜˜\nå•Ÿå‹• Minikube å¢é›† å•Ÿå‹• Minikube å¢é›† minikube start --vm-driver=docker å•Ÿå‹• Minikube\nè¨­å®š Metrics Server ç”±æ–¼æˆ‘å€‘ HorizontalPodAutoscaler æœƒæ ¹æ“šç¾åœ¨çš„è² è¼‰ä¾†åˆ¤æ–·æ˜¯å¦è¦æ–°å¢æ–°çš„ Pod ä¾†è§£æ±ºè² è¼‰è³‡æºç”¨å®Œçš„å•é¡Œï¼Œæ‰€ä»¥ç¬¬ä¸€å€‹æ¢ä»¶å°±æ˜¯è¦å…ˆç²çš„ç›®å‰çš„è² è¼‰è³‡æºä½¿ç”¨é‡ï¼Œé€™æ™‚å€™æˆ‘å€‘å¿…é ˆå…ˆåœ¨ K8s å¢é›†ä¸Šå®‰è£ Metrics Serverï¼Œé€éä»–è®“æˆ‘å€‘å¯ä»¥çŸ¥é“ç›®å‰çš„è² è¼‰ä½¿ç”¨é‡ï¼\nå…ˆåˆ° kubernetes-sigs/metrics-server ä¸‹è¼‰æœ€æ–°çš„ components.yaml æª”æ¡ˆä¸‹ä¾†ï¼Œä»¥æˆ‘é€™æ¬¡ç¤ºç¯„çš„ç‰ˆæœ¬ç‚ºä¾‹ï¼Œå¤§å®¶å¯ä»¥é»æˆ‘ä¸‹è¼‰ ğŸ‘‡\nä¸‹è¼‰å®Œï¼Œéœ€è¦å…ˆä¿®æ”¹å…©å€‹åœ°æ–¹ï¼Œæ‰èƒ½ apply åˆ° Minikube å¢é›†ï¼Œç¬¬ä¸€å€‹æ˜¯ä¿®æ”¹ kubelet-preferred-address-types=InternalIPï¼Œä»¥åŠæ–°å¢ kubelet-insecure-tls=ture è®“ Metrics Server ç¦ç”¨ TLS è­‰æ›¸é©—è­‰ï¼Œè©³ç´°å¯ä»¥åƒè€ƒä»¥ä¸‹ç…§ç‰‡ï¼š\nä¿®æ”¹ components.yaml\næ¥è‘— apply é€™å€‹ yaml æª”æ¡ˆï¼š apply components.yaml\nå¯ä»¥æª¢æŸ¥ä¸€ä¸‹ deployment.apps/metrics-server æ˜¯å¦æœ‰æˆåŠŸå»ºç«‹æˆ–æ˜¯ Pod æ˜¯å¦æœ‰å•é¡Œï¼š\næª¢æŸ¥ metrics-server æ˜¯å¦æœ‰å•é¡Œ\né–‹å§‹æ’°å¯«å¯¦ä½œæª”æ¡ˆ æ¥è‘—æˆ‘å€‘å°±ä¾ç…§å®˜æ–¹çš„ HorizontalPodAutoscaler Walkthrough çš„æ–‡ç« é–‹å§‹å›‰ï¼é¦–å…ˆå…ˆå¯«ä¸€å€‹ index.phpï¼Œé€™å€‹æª”æ¡ˆæ˜¯ç”¨æ–¼å¾ŒçºŒæ¸¬è©¦ HPA è² è¼‰ä½¿ç”¨é‡çš„ç¨‹å¼ï¼š index.php\næ–°å¢ Dockerfileï¼Œæˆ‘å€‘ä½¿ç”¨ php:5-apache çš„ imageï¼Œä¸¦è¤‡è£½å‰›å‰›å¯«çš„ index.php åˆ°å®¹å™¨å…§ï¼š Dockerfile\nå°‡è©² Dockerfile Build èµ·ä¾†ï¼Œæ¨åˆ° DockerHub ä¸Šï¼Œé€™éƒ¨åˆ†å°±ä¸å¤šèªªæ˜ï¼Œæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒä»¥å‰æ–‡ç« ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥ä½¿ç”¨ 880831ian/php-apache æˆ‘æ¨å¥½çš„ image ä¾†ä½¿ç”¨ã€‚ æ–°å¢ Deployment.yamlï¼Œè£¡é¢æœƒä½¿ç”¨æˆ‘å€‘å‰›å‰›æ‰“åŒ…æ¨åˆ° DockerHub ä¸Šçš„ imageï¼š apiVersion: apps/v1 kind: Deployment metadata: name: php-apache spec: selector: matchLabels: run: php-apache replicas: 1 template: metadata: labels: run: php-apache spec: containers: - name: php-apache image: 880831ian/php-apache ports: - containerPort: 80 resources: limits: cpu: 500m requests: cpu: 200m --- apiVersion: v1 kind: Service metadata: name: php-apache labels: run: php-apache spec: ports: - port: 80 selector: run: php-apache é€™é‚Šå¤§å®¶å¯ä»¥å…ˆè¨˜å¾—æˆ‘å€‘åœ¨ containers.resources æœ‰è¨­å®š cpu çš„ requests ç‚º 200mã€‚å¾ŒçºŒåœ¨è¨ˆç®—å‰¯æœ¬æ•¸æ™‚æœƒå†æåˆ° ğŸ˜¬\næœ€å¾Œå°‡ Deployment.yaml çµ¦ applyï¼Œæª¢æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰æ­£å¸¸å•Ÿå‹•ï¼š k8slens æª¢æŸ¥æ˜¯å¦æ­£å¸¸\nä½¿ç”¨ kubectl autoscale ä¾†å¹«åŠ©æˆ‘å€‘å‰µå»º HorizontalPodAutoscalerï¼š kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10 æˆ‘å€‘åœ¨ Deployment.yaml è£¡é¢ containers.resources æœ‰è¨­å®š cpu çš„ requests æ˜¯ 200mï¼Œä¹Ÿå°±æ˜¯ 200 milli-coresï¼Œç•¶æˆ‘å€‘ç¾åœ¨è¨­å®š HPA çš„å¹³å‡ CPU ä½¿ç”¨ç‡ç‚º 50%ï¼Œæ‰€ä»¥æˆ‘å€‘åªè¦è¶…é 200m / 2 = 100mï¼Œä¹Ÿå°±æ˜¯ requests è¶…é 100 milli-cores å°±æœƒç”¢ç”Ÿæ–°çš„ Podã€‚é€™é‚Šæœ€å°‘ Pod ç‚º 1ï¼Œæœ€å¤šç‚º 10ã€‚å¾ŒçºŒç­‰æ¸¬è©¦æ™‚ï¼Œæœƒå¸¶å¤§å®¶è¨ˆç®—ä»–æ˜¯å¦‚ä½•ç”¢ç”Ÿ Pod çš„ ğŸ˜ æŸ¥çœ‹ç›®å‰ HPA ä½¿ç”¨é‡ï¼Œå› ç‚ºæˆ‘å€‘é€™å€‹ php-apache é‚„æ²’æœ‰ä»»ä½•çš„è¨ªå•ï¼Œæ‰€ä»¥æ˜¯ 0% / 50% (æ‰¿ä¸Šé¢æ‰€èªªï¼Œæ‰€ä»¥é€™é‚Šçš„å€¼æ˜¯ 0 / 100 milli-cores)ï¼Œå¾Œé¢ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘å€‘æ‰€è¨­å®šæœ€é«˜è·Ÿæœ€ä½çš„ Podï¼Œä»¥åŠç›®å‰çš„å‰¯æœ¬æ•¸ã€‚ æŸ¥çœ‹ç›®å‰ HPA ä½¿ç”¨é‡\nç•¶ç„¶æˆ‘å€‘é™¤äº†ç”¨å‰›å‰›çš„æŒ‡ä»¤ä»¥å¤–ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªå·±å¯« HPA çš„ yaml æª”æ¡ˆã€‚æˆ‘é€™é‚Šå…ˆä½¿ç”¨ kubectl get hpa php-apache -o yaml \u003e hpa.yaml ä¾†å°‡å‰›å‰›ç”¨æŒ‡ä»¤ run èµ·ä¾†çš„ HPA è®Šæˆ yaml æª”ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹è£¡é¢æœ‰å“ªäº›å…§å®¹å§ï¼š apiVersion: autoscaling/v2 kind: HorizontalPodAutoscaler metadata: creationTimestamp: \"2022-07-12T03:16:11Z\" name: php-apache namespace: default resourceVersion: \"19454\" uid: dde68e68-9b6e-46a8-b50f-5525b8ec3bdf spec: maxReplicas: 10 metrics: - resource: name: cpu target: averageUtilization: 50 type: Utilization type: Resource minReplicas: 1 scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: php-apache å¾Œé¢ç‹€æ…‹çœç•¥.... apiVersionï¼šè¦è¨˜å¾—ä½¿ç”¨ autoscaling/v2 kindï¼šHorizontalPodAutoscaler maxReplicasï¼šæ˜¯æˆ‘å€‘å‰›å‰›ç”¨æŒ‡ä»¤çš„æœ€å¤§ Pod å‰¯æœ¬æ•¸ metricsï¼šæˆ‘å€‘æŒ‡æ¨™è¨­å®š cpu resourceï¼Œå…¶è¨­å®šå¹³å‡ä½¿ç”¨ç‡ç‚º 50 % (ç™¾åˆ†æ¯”) minReplicasï¼šå‰›å‰›ç”¨æŒ‡ä»¤çš„æœ€å° Pod å‰¯æœ¬æ•¸ scaleTargetRefï¼šè¨­å®šæˆ‘å€‘é€™å€‹ HPA æ˜¯ä¾ç…§ php-apache é€™å€‹ Deploymentã€‚ ","å¸¸è¦‹å•é¡ŒåŠè§£æ±ºè¾¦æ³•#å¸¸è¦‹å•é¡ŒåŠè§£æ±ºè¾¦æ³•":" â„¹ï¸ Q1 . å‡ºç¾ x509: cannot validate certificate for 192.168.XXX.XXX because it doesnâ€™t contain any IP SANs éŒ¯èª¤\nAns 1ï¼šæ˜¯å› çˆ²æ²’æœ‰åŠ å…¥ kubelet-insecure-tls=ture è®“ Metrics Server ç¦ç”¨ TLS è­‰æ›¸é©—è­‰ï¼Œæ‰å°è‡´éŒ¯èª¤ç™¼ç”Ÿã€‚","æ¸¬è©¦-hpa#æ¸¬è©¦ HPA":" æ¥ä¸‹ä¾†æˆ‘å€‘éƒ½è¨­å®šå¥½å¾Œï¼Œæˆ‘å€‘è¦ä¾†æ¨¡æ“¬å¢åŠ è² è¼‰ï¼Œçœ‹çœ‹ HPA çš„å¾ŒçºŒå‹•ä½œï¼Œé¦–å…ˆæˆ‘å€‘å…ˆä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ä¾†æŒçºŒè§€å¯Ÿ HPAï¼š kubectl get hpa php-apache --watch NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE php-apache Deployment/php-apache 0%/50% 1 10 1 4h40m ä»¥åŠåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œè©²æŒ‡ä»¤æ˜¯å»ºä¸€å€‹æ–°çš„ Podï¼Œç”±æ–°çš„ Pod ç„¡é™å¾ªç’°çš„å»å‘ php-apahe æœå‹™ç™¼å‡ºè«‹æ±‚ kubectl run -i --tty load-generator --rm --image=busybox:1.28 --restart=Never -- /bin/sh -c \"while sleep 0.01; do wget -q -O- http://php-apache; done\" æ¨¡æ“¬å¢åŠ è² è¼‰\næˆ‘å€‘ä½¿ç”¨ k8slens è§€å¯Ÿï¼Œæœƒç™¼ç¾ç•¶è² è¼‰ä½¿ç”¨é‡è¶…éæˆ‘å€‘å‰é¢æ‰€è¨­å®šçš„ 50%ï¼Œä¹Ÿå°±æ˜¯ 100 milli-cores æ™‚ï¼Œä»–å°±æœƒè‡ªå‹•é•·æ–°çš„ Pod å‡ºä¾†ï¼š HPA è‡ªå‹•é•· Pod\næˆ‘å€‘åˆ‡å›å»çœ‹è§€å¯Ÿ HPA æŒ‡ä»¤ kubectl get hpa php-apache --watchï¼š è§€å¯Ÿ HPA\næˆ‘å€‘å‰›å‰›æœ‰èªªè¶…é 50%ï¼Œä¹Ÿå°±æ˜¯ 100 milli-cores æ™‚ï¼Œæœƒé•·æ–°çš„ Podã€‚æˆ‘å€‘ä»¥ä¸Šé¢åœ–ç‰‡çš„ä¾†èªªæ˜ï¼Œä¾†è¨ˆç®—æœŸæœ›éœ€è¦å¹¾å€‹å‰¯æœ¬?\nå®˜æ–¹æœ‰æä¾›ä¸€å€‹å…¬å¼ï¼š æœŸæœ›å‰¯æœ¬æ•° = ceil[ç›®å‰å‰¯æœ¬æ•° * (ç›®å‰æŒ‡æ¨™ / æœŸæœ›æŒ‡æ¨™)] ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘å€‘è² è¼‰å¾ 0% å¾åˆ° 250%ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘å¯¦éš›ä¸Šæ˜¯å¾ 0 è®Šæˆ 500 milli-cores (250 / 50 _ 100 )ã€‚æˆ‘å€‘å°‡å€¼å¸¶å…¥å…¬å¼å…§ï¼Œç›®å‰çš„å‰¯æœ¬ï¼š1 _ (ç›®å‰æŒ‡æ¨™ï¼š500 / æœŸæœ›æŒ‡æ¨™æ˜¯ï¼š100)å¾—å‡ºä¾†çš„å€¼æ˜¯ 5ï¼Œå¦‚æœæœ‰å°æ•¸ï¼Œå› ç‚ºå‰é¢æœ‰ceilï¼Œæ‰€ä»¥æœƒå–æ•´æ•¸(ä¸å¯èƒ½é–‹åŠå€‹ Pod å°å§ ğŸ™„)ï¼Œæœ€å¾Œä»¥é€™å€‹ä¾‹å­ä¾†èªªï¼Œæœ€çµ‚å¾—åˆ°çš„ æœŸæœ›å‰¯æœ¬æ•° = 5\næ ¹æ“šæˆ‘å€‘è¨ˆç®—å‡ºä¾†çš„å‰¯æœ¬æ•¸ï¼Œä»–å°±æœƒä¾ç…§è¨ˆç®—çµæœï¼Œå¹«æˆ‘å€‘è‡ªå‹•ç”Ÿæˆè©²æ•¸é‡çš„ Podï¼Œä¾†æ¸›ç·©åŒä¸€å€‹ Pod çš„è² è¼‰é‡ï¼Œæ¥è‘—æˆ‘å€‘å…ˆä¸­æ–·æ¸¬è©¦æŒ‡ä»¤ï¼Œå†ç¹¼çºŒè§€å¯Ÿ HPA ï¼š è§€å¯Ÿ HPA\nå¯ä»¥ç™¼ç¾å› ç‚ºæˆ‘å€‘å°‡æ¸¬è©¦æŒ‡ä»¤ä¸­æ–·å¾Œï¼Œè² è¼‰ä½¿ç”¨é‡æœƒæ…¢æ…¢é™ä½ï¼Œä½†è² è¼‰é™ä½å¾Œï¼Œå‰¯æœ¬æ•¸ä¸æœƒé¦¬ä¸Šè®Šå›å»ï¼Œå› ç‚ºæ€•å¦‚æœåˆæœ‰å¤§é‡çš„ä½¿ç”¨é‡æœƒå°è‡´ Pod ä¾†ä¸åŠé•·å‡ºä¾†ï¼Œæ‰€ä»¥é è¨­æ˜¯ 5 åˆ†é˜ (--horizontal-pod-autoscaler-downscale-stabilization) æ‰æœƒæ¸›è‡³åŸä¾†çš„ Pod æ•¸é‡\nPod è‡ªå‹•æ¸›å°‘","ç‰ˆæœ¬è³‡è¨Š#ç‰ˆæœ¬è³‡è¨Š":" macOSï¼š11.6 Minikubeï¼šv1.25.2 Kubectlï¼šClient Versionï¼šv1.24.1ã€Server Versionï¼šv1.23.3 Metrics Server 3.8.2 "},"title":"Kubernetes (K8s) HorizontalPodAutoscaler (HPA) åŸç†èˆ‡å¯¦ä½œ"},"/blog/kubernetes/k8s-statefulset-podmanagementpolicy/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹å‰é™£å­åœ¨å…¬å¸çš„æ­£å¼ç’°å¢ƒè¸©åˆ° StatefulSet çš„é›·ï¼Œäº‹æƒ…æ˜¯é€™æ¨£çš„ï¼Œæˆ‘å€‘æœ‰äº›æœå‹™ï¼Œæ˜¯ä½¿ç”¨ StatefulSet ä¾†å»ºç½®ï¼Œè‡³æ–¼ç‚ºä»€éº¼ä¸ç”¨ Deploymentï¼Œé€™å€‹èªªä¾†è©±é•· (ä¹Ÿä¸æ˜¯å› ç‚ºéœ€è¦ç‰¹å®šçš„ Pod åç¨±ã€æˆ–æ˜¯ç¶²è·¯æ¨™è¨˜ç­‰ç­‰)ï¼Œæˆ‘å€‘é€™é‚Šå…ˆä¸è¨è«–ï¼Œé€™å€‹ StatefulSet æœå‹™æ˜¯ Nginx + PHP-FPMï¼Œç‚ºäº†é¿å…æµé‡é€²å…¥åˆ° processes å·²ç¶“è¢«ç”¨å…‰çš„ Pod ä¸­ï¼Œæˆ‘å€‘åœ¨ StatefulSet çš„ PHP Container ä¸Šæœ‰è¨­å®š readinessï¼Œreadiness çš„è¨­å®šé•·å¾—åƒä»¥ä¸‹ï¼š\nreadinessProbe: exec: command: - \"/bin/bash\" - \"-c\" - | CHECK_INFO=$(curl -s -w 'http code:\\t%{http_code}\\n' 127.0.0.1/status) HTTP_CODE=$(echo -e \"${CHECK_INFO}\" | awk '/http code:/ {print $3}') IDLE_PROCESSES=$(echo -e \"${CHECK_INFO}\" | awk '/idle processes:/ {print $3}') [[ $HTTP_CODE -eq 200 \u0026\u0026 $IDLE_PROCESSES -ge 10 ]] || exit 1 æˆ‘å€‘æœƒç”¨ curl ä¾†æ‰“ /statusï¼Œæª¢æŸ¥å›å‚³çš„ http code æ˜¯å¦ç‚º 200ï¼Œä»¥åŠ idle processes æ˜¯å¦å¤§æ–¼ç­‰æ–¼ 10ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œå°±æœƒå›å‚³ 1ï¼Œè®“ä»–è¢«æ¨™è¨˜ä¸å¥åº·ï¼Œè®“ Kubernetes åœæ­¢æµé‡åˆ°ä¸å¥åº·çš„å®¹å™¨ï¼Œä»¥ç¢ºä¿æµé‡è¢«è·¯ç”±åˆ°å…¶ä»–å¥åº·çš„å‰¯æœ¬ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Kubernetes â€” å¥åº·æª¢æŸ¥ï¼šhttps://medium.com/learn-or-die/kubernetes-%E5%81%A5%E5%BA%B7%E6%AA%A2%E6%9F%A5-59ee2a798115\nPod Management Policiesï¼šhttps://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#pod-management-policies","å•é¡Œ#å•é¡Œ":"ç•¶å¤©é‡åˆ°çš„æƒ…æ³æ˜¯ï¼Œæˆ‘å€‘ä¸Šç¨‹å¼å¾Œï¼ŒPod éƒ½ä¸€åˆ‡æ­£å¸¸ï¼Œç•¶æµé‡é–‹å§‹é€²ä¾†å¾Œï¼Œç™¼ç¾ 10 å€‹ Pod æœƒé–‹å§‹å¶ç™¼çš„å™´ Readiness probe failedï¼ŒæŸ¥çœ‹ç›£æ§ç™¼ç¾ processes è¶Šä¾†è¶Šä½ï¼Œæœ€å¾Œè¢«åæ‡‰æœå‹™æœ‰å•é¡Œï¼Œæˆ‘å€‘æŸ¥çœ‹ Hpa çš„ç´€éŒ„çš„ç¢ºæœ‰è§¸ç™¼åˆ° 40 å€‹ Podï¼Œåªæ˜¯æŸ¥çœ‹ Pod æ•¸é‚„æ˜¯ä¾æ¨£å¡åœ¨ 10 å€‹ï¼Œç•¶ä¸‹æˆ‘å€‘æœ‰å˜—è©¦ä½¿ç”¨èª¿æ•´ yaml åœ¨ applyï¼Œç™¼ç¾ StatefulSet çš„ yaml ä¹Ÿå·²ç¶“æ›´æ–°äº†ï¼Œä½† Pod é‚„æ˜¯ä¸€æ¨£å¡åœ¨ 10 å€‹ï¼Œä¹Ÿæœ‰ä½¿ç”¨ kubectl ä¸‹ kubectl scale sts [æœå‹™åç¨±] --replicas=0ï¼Œæƒ³è¦åˆ‡æ› Pod æ•¸ä¹Ÿæ²’æœ‰è¾¦æ³•ã€‚\nç•¶ä¸‹æˆ‘å€‘æœ‰å…ˆ Call Google çš„ Support ä¸€èµ·æ‰¾åŸå› ï¼ŒGoogle æ˜¯å»ºè­°æˆ‘å€‘ readiness çš„æ¢ä»¶ä¸è¦è¨­çš„å¤ªåš´æ ¼ï¼Œå¯ä»¥åŠ ä¸Š timeoutSeconds: ç§’æ•¸ï¼Œä½†å°æ–¼ Pod å¡ä½ï¼Œé‚„æ˜¯æ²’æœ‰æ‰¾åˆ°åŸå› ï¼Œå¾Œä¾†æˆ‘å€‘æŸ¥äº†ä¸€ä¸‹ StatefulSet çš„æ–‡ä»¶ç™¼ç¾ï¼ŒStatefulSet æœ‰ä¸€å€‹è¨­å®š podManagementPolicyï¼Œé è¨­æ˜¯ OrderedReadyï¼Œä»–å¿…é ˆç­‰å¾…å‰é¢çš„ Pod æ˜¯ Ready ç‹€æ…‹ï¼Œæ‰æœƒå†ç¹¼çºŒå»ºç«‹æ–°çš„ï¼Œä¹Ÿå°±æ˜¯èªªæˆ‘å€‘çš„ StatefulSet å·²ç¶“å¡ä½ï¼Œå°è‡´å°±ç®— Hpa è§¸ç™¼è¦é•·åˆ° 40 å€‹ Pod ä¹Ÿæ²’æœ‰ç”¨ã€‚","æ¸¬è©¦çµæœ#æ¸¬è©¦çµæœ":"æœ€å¾Œæˆ‘å€‘å°±ä½¿ç”¨å…©ç¨®æ¨¡å¼ä¾†æ¸¬è©¦çœ‹çœ‹ï¼Œå·²ä¸‹æ˜¯æ¸¬è©¦çµæœ(é€é P1 æ‰çŸ¥é“çš„è¨­å®šï¼±ï¼±)ï¼š\næœ‰å°‡æ¸¬è©¦çš„ StatefulSet æ”¾åœ¨ Githubï¼Œå¯ä»¥é»æˆ‘æŸ¥çœ‹ (å¯ä»¥èª¿æ•´ readinessProbe çš„ httpGet.Path æ•…æ„æŠŠä»–ç”¨å£)\nä½¿ç”¨ OrderedReady æ¨¡å¼ StatefulSet åœ¨ podManagementPolicy é è¨­ OrderedReady çš„æ¨¡å¼ï¼Œæ•…æ„è®“ readiness å¡ä½æ™‚ (Pod å¡ä½æ™‚)ï¼š\nç•¶ä¸‹çš„ StatefulSet è¨­å®šï¼š StatefulSet è¨­å®š\nPod ç‹€æ…‹ï¼š Pod ç‹€æ…‹\nä½¿ç”¨æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘é€™æ™‚å€™ä¸‹æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nkubectl scale sts my-statefulset --replicas=5 æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ï¼Œä»£è¡¨ StatefulSet æœ¬èº«æœ‰æ¥æ”¶åˆ°èª¿æ•´è¨­å®šçš„è«‹æ±‚ã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿæ˜¯ä¸€æ¨£å¡ä½ï¼Œä¸” Pod æ•¸é‡ä¹Ÿæ²’æœ‰è®ŠåŒ–ã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹\nä½¿ç”¨ yaml èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘ç›´æ¥èª¿æ•´ StatefulSet yaml çš„ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nä¸€æ¨£æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Š(é€™è£¡æ‡‰è©²åˆ‡åˆ¥çš„ Pod æ•¸é‡ï¼Œåˆ‡å› 3 å€‹å¥½åƒæ²’æœ‰æ„ç¾© xD)ï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿæ˜¯ä¸€æ¨£å¡ä½ï¼Œä¸” Pod æ•¸é‡ä¹Ÿæ²’æœ‰è®ŠåŒ–ã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹\næ‰€ä»¥ä»£è¡¨åœ¨ OrderedReady çš„æ¨¡å¼ä¸‹ï¼ŒPod å¡ä½æ™‚ï¼Œç„¡æ³•å° Pod é€²è¡Œä»»ä½•æ“ä½œï¼Œå¿…é ˆè¦æ‰‹å‹•åˆªé™¤å¡ä½çš„ Pod æ‰åƒå¾—åˆ°æœ€æ–°çš„è¨­å®šã€‚\nä½¿ç”¨ Parallel æ¨¡å¼ StatefulSet åœ¨ podManagementPolicy Parallel çš„æ¨¡å¼ï¼Œæ•…æ„è®“ readiness å¡ä½æ™‚ (Pod å¡ä½æ™‚)ï¼š\nç•¶ä¸‹çš„ StatefulSet è¨­å®šï¼š StatefulSet è¨­å®š\nPod ç‹€æ…‹ï¼š Pod ç‹€æ…‹\nä½¿ç”¨æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘é€™æ™‚å€™ä¸‹æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nkubectl scale sts my-statefulset --replicas=5 æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ï¼Œä»£è¡¨ StatefulSet æœ¬èº«æœ‰æ¥æ”¶åˆ°èª¿æ•´è¨­å®šçš„è«‹æ±‚ã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œå°±ç®— my-statefulset-2 å¡ä½ï¼Œé‚„æ˜¯å¯ä»¥æ“´åˆ° 5 å€‹ Podã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹\nä½¿ç”¨ yaml èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘ç›´æ¥èª¿æ•´ StatefulSet yaml çš„ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nä¸€æ¨£æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿä¸æœƒç®¡å…¶ä»– Pod æ˜¯å¦ Readyï¼Œä¸€æ¨£å¯ä»¥ç¸®å°æˆ 2 å€‹ Podã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹","çµè«–#çµè«–":"å¾Œä¾†æˆ‘å€‘é‡æ–°æª¢æŸ¥äº†ä¸€ä¸‹ç‚ºä»€éº¼ processes æœƒç”¨å®Œï¼Œçµæœç™¼ç¾æ˜¯ RD çš„ç¨‹å¼é‚è¼¯ï¼Œå°è‡´æ¯ç­† Request å¿…é ˆç­‰å¾…å‰ä¸€ç­† Request åšå®Œï¼Œæ‰æœƒé–‹å§‹å‹•ä½œï¼Œè®“ processes ä¸€ç›´è¢«å ç”¨ï¼Œæ²’è¾¦æ³•å³æ™‚æ¶ˆåŒ–ï¼Œå°è‡´ processes ç”¨å®Œï¼ŒåˆåŠ ä¸Šæœå‹™æ˜¯ä½¿ç”¨ StatefulSetï¼Œé è¨­æ¨¡å¼çš„ OrderedReadyï¼Œå¿…é ˆç­‰å¾…å‰ä¸€å€‹ Pod æ˜¯ Ready æ‰å¯ä»¥è‡ªå‹•æ“´ç¸®ï¼Œæ‰€ä»¥ç•¶æˆ‘å€‘ Hpa æƒ³è¦æ“´ç¸®ï¼Œä¾†å¢åŠ å¯ç”¨çš„ processes æ•¸é‡ï¼Œä¹Ÿå› ç‚ºæ²’è¾¦æ³•æ“´ç¸®ï¼Œæœ€å¾Œå°è‡´é€™ä¸€é€£ä¸²çš„å•é¡Œ ğŸ˜•ã€‚\nå¦å¤–ï¼Œå¦‚æœæƒ³è¦å¾ OrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼ (åæ­£éä¾†ä¹Ÿæ˜¯)ï¼Œå¿…é ˆå…ˆå°‡åŸæœ¬çš„ StatefulSet çµ¦åˆªé™¤ï¼Œæ‰å¯ä»¥èª¿æ•´ï¼š\nOrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼","è§£æ±ºè¾¦æ³•#è§£æ±ºè¾¦æ³•":"ç•¶ä¸‹æƒ³è¶•å¿«è§£æ±º readiness é€™å€‹å•é¡Œï¼Œèª¿æ•´ timeoutSeconds å¾Œï¼Œå–®ç´” apply æ˜¯æ²’æœ‰ç”¨çš„ï¼Œè¦è¨˜å¾—åˆªæ‰å¡ä½çš„ Podï¼Œè®“ä»–é‡æ–°å»ºç«‹ï¼Œæ‰æœƒå¥—ç”¨æ–°çš„è¨­å®š (ä½†æˆ‘å€‘ç•¶ä¸‹å¤ªåœ¨æ„ç‚ºç”šéº¼ Pod æœƒå¡ä½ï¼Œæ²’æœ‰æƒ³åˆ°è¦å…ˆæŠŠ readiness å•é¡Œä¿®æ‰ xDï¼Œæˆ‘å€‘ç•¶ä¸‹çš„è§£æ³•æ˜¯å…ˆå°‡æµé‡å°åˆ°åœ°ç«¯æ­£å¸¸çš„æœå‹™ä¸Š)ã€‚\nå¦å¤– Google ä¹Ÿèªªï¼Œå‡å¦‚æˆ‘å€‘é‚„æ˜¯å¿…é ˆä½¿ç”¨ StatefulSet ä¾†å»ºç«‹æœå‹™ï¼Œå»ºè­°æˆ‘å€‘æŠŠ podManagementPolicy æ”¹æˆ Parallelï¼Œå®ƒæœƒæœ‰é»åƒæ˜¯ Deployment çš„æ„Ÿè¦ºï¼Œä¸æœƒç­‰å¾…å…¶ä»– Pod è®Šæˆ Ready ç‹€æ…‹ï¼Œæ‰€ä»¥å¯ä»¥è®“æˆ‘å€‘å°±ç®—åœ¨ readiness å¡ä½çš„æƒ…æ³ä¸‹ï¼Œä¹Ÿå¯ä»¥è‡ªå‹•æ“´ç¸®æœå‹™ã€‚\nâ„¹ï¸ StatefulSet podManagementPolicy åƒæ•¸èªªæ˜\nOrderedReady (é è¨­) Pods æœƒæŒ‰ç…§é †åºä¸€å€‹æ¥ä¸€å€‹åœ°è¢«å‰µå»ºã€‚å³ï¼Œn+1 è™Ÿ Pod ä¸æœƒåœ¨ n è™Ÿ Pod æˆåŠŸå‰µå»ºä¸” Ready ä¹‹å‰é–‹å§‹å‰µå»ºã€‚ åœ¨ç¸®å° StatefulSet çš„å¤§å°æ™‚ï¼ŒPods æœƒæŒ‰ç…§åå‘é †åºä¸€å€‹æ¥ä¸€å€‹åœ°è¢«çµ‚æ­¢ã€‚å³ï¼Œn è™Ÿ Pod ä¸æœƒåœ¨ n+1 è™Ÿ Pod å®Œå…¨çµ‚æ­¢ä¹‹å‰é–‹å§‹çµ‚æ­¢ã€‚ é€™ç¢ºä¿äº† Pods çš„å•Ÿå‹•å’Œçµ‚æ­¢çš„é †åºæ€§ã€‚\nParallel æ‰€æœ‰ Pods æœƒåŒæ™‚åœ°è¢«å‰µå»ºæˆ–çµ‚æ­¢ã€‚ ç•¶ StatefulSet æ“´å±•æ™‚ï¼Œæ–°çš„ Pods æœƒç«‹å³é–‹å§‹å‰µå»ºï¼Œä¸ç”¨ç­‰å¾…å…¶ä»– Pods æˆç‚º Ready ç‹€æ…‹ã€‚ ç•¶ç¸®å° StatefulSet çš„å¤§å°æ™‚ï¼Œè¦çµ‚æ­¢çš„ Pods æœƒç«‹å³é–‹å§‹çµ‚æ­¢ï¼Œä¸ç”¨ç­‰å¾…å…¶ä»– Pods å…ˆçµ‚æ­¢ã€‚ é€™ç¨®ç­–ç•¥æä¾›äº†å¿«é€Ÿçš„æ“´å±•å’Œç¸®å°æ“ä½œï¼Œä½†ç¼ºä¹é †åºæ€§ä¿è­‰ã€‚"},"title":"æ­£å¼ç’°å¢ƒä¸Šè¸©åˆ° StatefulSet çš„é›·ï¼Œæ‹¿åˆ° P1 çš„æ•™è¨“"},"/blog/kubernetes/pod-veth-name-provided-eth0-already-exists/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹å…¬å¸åŒäº‹åœ¨æ­£å¼æœå‹™ä¸Šé‡åˆ°çš„å•é¡Œï¼Œæœƒè©³ç´°èªªæ˜é‡åˆ°äº‹æƒ…çš„ç¶“éï¼Œä»¥åŠé–‹å–®è©¢å• google support æœ€å¾Œè¨è«–å‡ºçš„æš«æ™‚è§£æ±ºçš„è¾¦æ³•ï¼š\nç°¡å–®åˆ—å‡ºæ­£å¼ç«™ç•¶ä¸‹æœå‹™ç’°å¢ƒï¼š\ngke master versionï¼š1.25.10-gke.2700 gke node versionï¼š1.25.8-gke.1000 è©²å•é¡Œç™¼ç”Ÿçš„ node pool æœ‰è¨­å®š taint ç™¼ç”Ÿå•é¡Œçš„ Pod æ˜¯ç”¨ Statefulset å»ºç«‹çš„æœå‹™ ","äº‹æƒ…ç™¼ç”Ÿçš„ç¶“é#äº‹æƒ…ç™¼ç”Ÿçš„ç¶“é":" RD åŒä»åæ‡‰ï¼Œç™¼ç¾ä½¿ç”¨ Statefulset å»ºç«‹çš„æ’ç¨‹æœå‹™æœ‰å•é¡Œï¼Œä¸‹ kubectl delete æŒ‡ä»¤æƒ³è¦åˆªé™¤ Podï¼Œè®“ Pod é‡æ–°é•·ï¼Œå»å¡åœ¨ Terminatingï¼Œç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œï¼Œæ±ºå®šä¸‹ kubectl delete --force --grace-period=0 ä¾†å¼·åˆ¶åˆªé™¤ Podï¼Œé€™æ™‚å€™ç‹€æ…‹æœƒå¡åœ¨ ContainerCreatingï¼Œä½¿ç”¨ Describe æŸ¥çœ‹ï¼Œæœƒå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼š Warning (combined from similar events): Failed to create pod sandbox: rpo error: code = Unknown desc = failed to setup network for sandbox \"14fe0cd3d688aed4ffed4c36ffab1a145230449881bcbe4cac6478a63412b0c*: plugin type=*gke\" failed (add): container veth name provided (etho) already exists æˆ‘å€‘ SRE å”åŠ©æŸ¥çœ‹å¾Œï¼Œä¹Ÿæœ‰å˜—è©¦å»ä¸‹ kubectl delete --force --grace-period=0 ä¾†åˆªé™¤ Podï¼Œä½†é‚„æ˜¯ä¸€æ¨£å¡åœ¨ ContainerCreatingï¼Œæœ€å¾Œæ˜¯å…ˆé–‹ä¸€å€‹æ–°çš„ Node ä¸¦è®“è©² Pod å»ºç«‹åˆ°æ–°çš„ Node ä¸Šï¼Œæ‰è§£æ±ºå•é¡Œã€‚ç‚ºäº†æ–¹ä¾¿ google support å”åŠ©æª¢æŸ¥å‡ºå•é¡Œçš„ Nodeï¼Œå…ˆå°‡ Node è¨­å®šæˆ cordonï¼Œé¿å…å…¶ä»– Pod è¢«èª¿åº¦åˆ°è©²å•é¡Œ node ä¸Šã€‚ Node è¨­å®šæˆ cordon\nNode å¯ä»¥è¨­å®š cordonã€drain å’Œ delete ä¸‰å€‹æŒ‡å®šéƒ½æœƒä½¿ Node åœæ­¢è¢«èª¿åº¦ï¼Œåªæ˜¯æ¯å€‹çš„æ“ä½œæš´åŠ›ç¨‹åº¦ä¸åŒï¼š\ncordonï¼šå½±éŸ¿æœ€å°ï¼Œåªæœƒå°‡ Node æ¨™ç¤ºç‚º SchedulingDisabled ä¸å¯èª¿åº¦ç‹€æ…‹ï¼Œä½†ä¸æœƒå½±éŸ¿åˆ°å·²ç¶“åœ¨è©² Node ä¸Šçš„ Podï¼Œä½¿ç”¨ kubectl cordon [node name] ä¾†åœæ­¢èª¿åº¦ï¼Œä½¿ç”¨ kubectl uncordon [node name] ä¾†æ¢å¾©èª¿åº¦ã€‚\ndrainï¼šæœƒå…ˆé©…é€åœ¨ Node ä¸Šçš„ Podï¼Œå†å°‡ Node æ¨™ç¤ºç‚º SchedulingDisabled ä¸å¯èª¿åº¦ç‹€æ…‹ï¼Œä½¿ç”¨ kubectl drain [node name] --ignore-daemonsets --delete-local-data ä¾†åœæ­¢èª¿åº¦ï¼Œä½¿ç”¨ kubectl uncordon [node name] ä¾†æ¢å¾©èª¿åº¦ã€‚\ndeleteï¼šæœƒå…ˆé©…é€ Node ä¸Šçš„ Podï¼Œå†åˆªé™¤ Node ç¯€é»ï¼Œå®ƒæ˜¯ä¸€ç¨®æš´åŠ›åˆªé™¤ Node çš„ä½œæ³•ï¼Œåœ¨é©…é€ Pod æ™‚ï¼Œæœƒå¼·åˆ¶ Kill å®¹å™¨é€²ç¨‹ï¼Œæ²’è¾¦æ³•å„ªé›…çš„çµ‚æ­¢ Podã€‚\næˆ‘å€‘éš¨å¾Œé–‹å–®è©¢å• goolge supportã€‚ ","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Node ç¯€é»ç¦æ­¢èª¿åº¦ï¼ˆå¹³æ»‘ç¶­è­·ï¼‰æ–¹å¼- cordonï¼Œdrainï¼Œdeleteï¼šhttps://www.cnblogs.com/kevingrace/p/14412254.html","èˆ‡-google-support-è¨è«–å…§å®¹#èˆ‡ Google Support è¨è«–å…§å®¹":"Google Support ç¶“éæŸ¥è©¢å¾Œï¼Œå›è¦†èªªï¼šé€™å€‹å•é¡Œæ˜¯å› ç‚º Pod è¢«å¼·åˆ¶åˆªé™¤å°è‡´ï¼Œå¼·åˆ¶åˆªé™¤æ˜¯ä¸€ç¨®å±éšªçš„æ“ä½œï¼Œä¸å»ºè­°é€™æ¨£è™•ç†ï¼Œä¸‹é¢æœ‰è©³ç´°è¨è«–ã€‚\nä¸€é–‹å§‹å¡åœ¨ Terminating ç‹€æ…‹ï¼Œæˆ‘å€‘ä¹Ÿæœ‰è«‹ RD èªªæ˜ä¸€ä¸‹ç•¶ä¸‹é‡åˆ°çš„å•é¡Œä»¥åŠè™•ç†å‹•ä½œï¼šRD ç•¶æ™‚æƒ³è¦åˆªé™¤ Pod æ˜¯å› ç‚ºè©²ç¨‹å¼ç•¶ä¸‹æœ‰ Bugï¼Œå°‡ redis èˆ‡ db é€£ç·šçµ¦é—œé–‰ï¼Œç¨‹å¼æ‰¾ä¸åˆ°å°±æœƒä¸€ç›´ retryï¼Œå°è‡´ç›¸é—œé€²ç¨‹ç„¡æ³•çµæŸï¼Œå†åŠ ä¸Š terminationGracePeriodSeconds æˆ‘å€‘è¨­å®š 14400ï¼Œä¹Ÿå°±æ˜¯ 4 å°æ™‚ï¼Œæ‰æœƒå¡åœ¨ Terminating ç‹€æ…‹ã€‚ (terminationGracePeriodSeconds è¨­å®šé€™éº¼ä¹…æ˜¯å¸Œæœ›å¦‚æœæœ‰è¢« on callï¼Œå·¥ç¨‹å¸«ä¸Šä¾†æ™‚ï¼Œå¯ä»¥æŸ¥çœ‹è©² Pod çš„éŒ¯èª¤åŸå› )\nå› ç‚ºå¡åœ¨ Terminating å¤ªä¹…ï¼ŒRD æœ‰åŸ·è¡Œ kubectl delete --forceï¼Œå°±æ˜¯å› ç‚ºä¸‹äº† --force æ‰é€ æˆç›¸é—œè³‡æºå•é¡Œ (ä¾‹å¦‚ container proccess, sandbox, ä»¥åŠç¶²è·¯è³‡æº)æ²’æœ‰åˆªä¹¾æ·¨ã€‚æ‰€ä»¥å¼•èµ·äº†æ­¤æ¬¡çš„å ±éŒ¯ â€œcontainer veth name provided (eth0) already existsâ€ã€‚ (å› ç‚ºæˆ‘å€‘æœå‹™ä½¿ç”¨ Statefulsetï¼ŒPod åç¨±ç›¸åŒï¼Œå°è‡´ eth0 é€™å€‹ç¶²è·¯è³‡æºåç¨±é‡è¤‡ï¼Œæ‰€ä»¥é€ æˆéŒ¯èª¤ï¼Œå¯ä»¥ç”¨ deployment ä¾†æ”¹å–„é€™å€‹å•é¡Œï¼Œåªæ˜¯è³‡æºå¦‚æœæ²’æœ‰æ¸…ç†ä¹¾æ·¨æœƒä½”ç”¨ IPï¼Œæ‰€ä»¥å–®ç´”èª¿æ•´æˆ deployment ä¹Ÿä¸æ˜¯æœ€ä½³è§£)\nGoogle ç”¢å“åœ˜éšŠå»ºè­°ï¼Œå¦‚æœ Pod è™•æ–¼ Running ç‹€æ…‹æ™‚ï¼Œæƒ³è¦å¿«é€Ÿåˆªé™¤ Pod æ™‚ï¼Œä¸€é–‹å§‹å°±å…ˆä½¿ç”¨ kubectl delete pod --grace-period=number[ç§’æ•¸] ä¾†åˆªé™¤ï¼Œå¦‚æœå·²ç¶“æ˜¯ Terminating ç‹€æ…‹å‰‡ç„¡æ•ˆã€‚(SRE åŒä»å·²æ¸¬è©¦éï¼Œèˆ‡ Google Support èªªæ˜ç›¸åŒ)\né‚£å¦‚æœå·²ç¶“è™•æ–¼ Terminating ç‹€æ…‹ï¼Œè¦æ€éº½è®“ Pod è¢«é †åˆ©åˆªé™¤ï¼Œé€™éƒ¨åˆ† Google Support å¾ŒçºŒæœƒåœ¨æ¸¬è©¦ä¸¦çµ¦å‡ºå»ºè­°ï¼Œç›®å‰æ¸¬è©¦æ˜¯ï¼šé€²å»å¡ä½çš„ Pod Containerï¼Œæ‰‹å‹•åˆªé™¤ä¸»é€²ç¨‹ (pkill) å°±å¯ä»¥äº†ã€‚\nGoogle Support å›è¦†"},"title":"éƒ¨ç½² Pod é‡åˆ° container veth name provided (eth0) already exists éŒ¯èª¤"},"/blog/nginx/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Nginx ç›¸é—œçš„æ–‡ç« ã€‚\næƒ³ä½¿ç”¨ Nginx Upstream Proxy åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸¦å¸¶å…¥å°æ‡‰çš„ header è©²æ€éº¼åšï¼Ÿ Soketi WebSocket Server LOG ä¸å®šæ™‚å‡ºç¾ 502 error ä»¥åŠ connect() failed (111: Connection refused) "},"title":"Nginx"},"/blog/nginx/nginx-upstream-set-host-header/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹æœ€è¿‘åœ¨å…¬å¸æœå‹™å…¥å£é‡åˆ°çš„ä¸€äº›å°å•é¡Œï¼Œä»¥åŠè§£æ±ºçš„æ–¹æ³•ã€‚ç°¡å–®èªªæ˜ä¸€ä¸‹ï¼Œæˆ‘å€‘çš„æœå‹™å…¥å£æ˜¯ç”¨ Nginx ä¾†ç•¶ä½œ proxy serverï¼Œå°‡ä¸åŒè·¯å¾‘æˆ–æ˜¯ servername å°åˆ°å°æ‡‰çš„å¾Œç«¯ç¨‹å¼ï¼Œæˆ–æ˜¯å¤–éƒ¨çš„æœå‹™ä¸Š(ä¾‹å¦‚ AWS cloudfront.net)ï¼Œæœ¬ç¯‡è¦æ¸¬è©¦çš„æ˜¯å¦‚æœä½¿ç”¨è¦åŒæ™‚ä½¿ç”¨ upstream åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸”éœ€è¦å¸¶ host header è©²æ€éº¼åšã€‚\nNginx çš„ upstream æ˜¯ä»€éº¼ï¼Ÿ\né€šå¸¸æˆ‘å€‘ proxy_pass çš„å¯«æ³•æœƒæ˜¯é€™æ¨£ï¼š\nlocation /aaa { proxy_pass http://aaa.example.com; } ç•¶ Nginx æ”¶åˆ°çš„ request æ˜¯ /aaa æ™‚ï¼Œå°±æœƒå°‡ request è½‰ç™¼åˆ° http://aaa.example.comã€‚\nä½†å‡å¦‚å¾Œç«¯æœ‰å¤šå°æ©Ÿå™¨æˆ–æ˜¯æœå‹™ï¼Œå¯ä»¥è™•ç†åŒä¸€ç¨® requestï¼Œé€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨ upstream ä¾†è™•ç†ï¼š\nupstream backend_hosts { server aaa.example.com; server bbb.example.com; server ccc.example.com; } location /aaa { proxy_pass http://backend_hosts; } é€™æ¨£å­çš„å¥½è™•æ˜¯å¯ä»¥æœ‰å¤šå€‹æ©Ÿå™¨æˆ–æ˜¯å¾Œç«¯æœå‹™å¯ä»¥åˆ†æ•£è«‹æ±‚ï¼Œåšåˆ°è² è¼‰å¹³è¡¡çš„æ•ˆæœã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Make nginx to pass hostname of the upstream when reverseproxyingï¼šhttps://serverfault.com/questions/598202/make-nginx-to-pass-hostname-of-the-upstream-when-reverseproxying","å•é¡Œ#å•é¡Œ":"é‚£å¦‚æœæˆ‘å€‘ä½¿ç”¨ Nginx upstream æ™‚ï¼Œé‚„æƒ³è¦åŒæ™‚å¸¶ host çš„ header åˆ°å¾Œç«¯è©²æ€éº¼åšå‘¢ï¼Ÿæˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ç›®å‰çš„å¯«æ³•ï¼š\n( æ¸¬è©¦ç¯„ä¾‹æ˜¯ä½¿ç”¨ docker ä¾†æ¨¡æ“¬ï¼Œå¯ä»¥åƒè€ƒç¨‹å¼ç¢¼ \u003e é»æˆ‘å‰å¾€ githubï¼Œæœƒæœ‰ä¸‰å€‹ nginxï¼Œå…¶ä¸­ä¸€å€‹æ˜¯è² è²¬ proxy çš„ nginx åç‚º proxyï¼Œå¦å¤–å…©å°æ˜¯ upstream å¾Œçš„æœå‹™ï¼Œåç‚º upstream_server1ã€upstream_server2 )\nnginx-old.conf upstream upstream_server { server upstream_server1; server upstream_server2; } server { listen 80; server_name localhost; location /upstream_server/ { proxy_pass http://upstream_server; proxy_set_header Host \"upstream_server1\"; proxy_set_header Host \"upstream_server2\"; access_log /var/log/nginx/access.log upstream_log; } } } å¯ä»¥çœ‹åˆ°æˆ‘å€‘å¸Œæœ› Nginx æ”¶åˆ° request æ˜¯ /upstream_server æ™‚ï¼Œå°‡ request è½‰ç™¼åˆ° http://upstream_serverï¼Œè€Œ upstream_server å¾Œé¢æœ‰å…©å€‹ serverï¼Œä¸¦ä¸”åœ¨ proxy æ™‚ï¼Œå¸¶å…¥å…©å€‹ä¸åŒçš„ host headerã€‚ä½†å¦‚æœçœŸçš„é€™æ¨£å¯«ï¼Œå¯ä»¥é”åˆ°æˆ‘å€‘æƒ³è¦å¾—æ•ˆæœå—ï¼Ÿæˆ‘å€‘å¯¦éš›è·‘çœ‹çœ‹ç¨‹å¼ (ç¯„ä¾‹å¯ä»¥ä½¿ç”¨ nginx-old.conf)ï¼š\nnginx åŸæœ¬å¯«æ³•\nå¾ä¸Šé¢çš„ LOG å¯ä»¥ç™¼ç¾ï¼Œæˆ‘å€‘ call /upstream_server æ™‚ï¼Œå¾Œç«¯çš„ upstream_server1ã€upstream_server2 æ”¶åˆ°çš„ host åªæœƒæ”¶åˆ°ç¬¬ä¸€å€‹è¨­å®šçš„ Hostï¼Œä¸”æœå‹™æœƒå‡ºç¾ 400 Bad Requestï¼ŒæŸ¥äº†ä¸€ä¸‹ç¶²è·¯æ–‡ç« ï¼Œç™¼ç¾å‡ºç¾ 400 Bad Requestï¼Œå¯èƒ½è·Ÿ header é€å¤ªå¤šè³‡è¨Šéå»ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ è§£æ±ºç¶²ç«™å‡ºç¾ 400 Bad Request ç‹€æ…‹çš„æ–¹æ³•ã€‚\né€™é‚Šæ¨æ¸¬æ‡‰è©²æ˜¯å¾Œç«¯å¦‚æœä¹Ÿæ˜¯ç”¨ nginx ç›´æ¥æ¥æ”¶æ‰æœƒé‡åˆ° 400 çš„å•é¡Œï¼Œé‚„å¥½ç›®å‰å…¬å¸æœå‹™é‚„æ˜¯æ­£å¸¸çš„ xDDï¼Œæª¢æŸ¥ä¸€ä¸‹å¾Œç™¼ç¾ï¼Œå…¶å¯¦å¾Œç«¯æ ¹æœ¬æ²’æœ‰è¦æ±‚å°æ‡‰ header æ‰èƒ½æ¥æ”¶(æ‡‰è©²æ˜¯å°æ–¹å¿˜è¨˜åŠ ä¸Šæ­¤é™åˆ¶)ã€‚","è§£æ±º#è§£æ±º":"å¥½ï¼Œä¸ç®¡æ˜¯å¦éœ€è¦å°æ‡‰ headerï¼Œæˆ‘å€‘é‚„æ˜¯æ‰¾çœ‹çœ‹æœ‰æ²’æœ‰è¾¦æ³•åŒæ™‚ä½¿ç”¨ upstreamï¼Œä¸¦å¸¶å…¥å°æ‡‰ host çš„æ–¹æ³•å‘¢ï¼Ÿ\næœ€å¾Œåƒè€ƒç¶²è·¯ä¸Šçš„æ–‡ç« ï¼Œä¼¼ä¹åªèƒ½ä½¿ç”¨å…©å±¤çš„ proxyï¼Œæ‰èƒ½å®Œæˆé€™å…©å€‹éœ€æ±‚ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹è¦æ€éº¼å¯«å§ (ç¯„ä¾‹å¯ä»¥ä½¿ç”¨ nginx.conf)ï¼š\nnginx.conf server { listen 777; server_name localhost; location / { proxy_pass http://upstream_server1; proxy_set_header Host \"upstream_server1\"; access_log /var/log/nginx/access.log upstream_log; } } server { listen 888; server_name localhost; location / { proxy_pass http://upstream_server2; proxy_set_header Host \"upstream_server2\"; access_log /var/log/nginx/access.log upstream_log; } } upstream upstream_server { server 127.0.0.1:777; server 127.0.0.1:888; } server { listen 80; server_name localhost; location /upstream_server/ { proxy_pass http://upstream_server; access_log /var/log/nginx/access.log upstream_log; } } å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ç¨‹å¼ç¢¼ï¼Œæˆ‘å€‘é€éå…©å±¤çš„ proxyï¼Œä¾†é”åˆ°æˆ‘å€‘æƒ³è¦çš„æ•ˆæœï¼Œé€™æ¨£å­å°±å¯ä»¥åŒæ™‚ä½¿ç”¨ upstreamï¼Œä¸¦ä¸”å¸¶å…¥å°æ‡‰çš„ host headerã€‚\né¦–å…ˆåœ¨ 28 ~ 36 è¡Œï¼Œæˆ‘å€‘ä¸€æ¨£å¦‚æœ Nginx æ”¶åˆ° request æ˜¯ /upstream_server æ™‚ï¼Œæœƒ proxy åˆ° upstream_server é€™å€‹ upstream ä¸­ï¼Œè€Œ upstream_server æœ‰å…©å€‹ serverï¼Œåˆ†åˆ¥æ˜¯ 127.0.0.1:777ã€127.0.0.1:888ï¼Œä½†å¯¦éš›ä¸Šæ²’æœ‰é€™å…©å€‹ portï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å†å¯«ä¸€å±¤ä¸€èˆ¬çš„ proxy è¨­å®šï¼Œåˆ†åˆ¥æ˜¯ 1 ~ 10 è¡Œã€12 ~ 21 è¡Œï¼Œé€™æ¨£å­å°±å¯ä»¥é”åˆ°æˆ‘å€‘æƒ³è¦çš„æ•ˆæœã€‚\nä½†é€™å€‹æ–¹æ³•æ¯”è¼ƒé©ç”¨æ–¼ upstream å¾Œç«¯æ²’æœ‰å¤ªå¤šå€‹æœå‹™æˆ–æ˜¯æ©Ÿå™¨çš„æƒ…æ³ï¼Œå¦‚æœæœ‰å¾ˆå¤šå€‹æœå‹™æˆ–æ˜¯æ©Ÿå™¨ï¼Œå°±éœ€è¦å¯«å¾ˆå¤šçš„ proxyï¼Œé€™æ¨£å­æœƒè®Šå¾—å¾ˆéº»ç…©ï¼Œæ‰€ä»¥å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œä¹Ÿæ­¡è¿ç•™è¨€è·Ÿæˆ‘åˆ†äº« ğŸ¤£ã€‚\næœ€å¾Œæˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹å¯¦éš›åŸ·è¡Œçš„çµæœï¼š\nä½¿ç”¨å¤šå±¤çš„ nginx proxy è™•ç†"},"title":"æƒ³ä½¿ç”¨ Nginx Upstream Proxy åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸¦å¸¶å…¥å°æ‡‰çš„ header è©²æ€éº¼åšï¼Ÿ"},"/blog/nginx/soketi-log-502-error/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹ RD åŒä»å‰é™£å­æœ‰åæ‡‰ä½¿ç”¨ Soketi é€™å€‹ WebSocket Server æœƒä¸å®šæ™‚åœ¨ LOG å‡ºç¾ 502 error éŒ¯èª¤è¨Šæ¯ä»¥åŠ connect() failed (111: Connection refused) while connecting to upstreamï¼Œé›–ç„¶èªªæœå‹™ä½¿ç”¨ä¸Šä¸æœƒå½±éŸ¿å¾ˆå¤§ï¼Œä½†é‚„æ˜¯å¸Œæœ›æˆ‘å€‘å¯ä»¥å”åŠ©æ‰¾å‡º 502 çš„åŸå› ã€‚\nå‡ºéŒ¯çš„ LOG\nåœ¨é–‹å§‹æ‰¾å•é¡Œå‰ï¼Œå…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ Soketi æ˜¯ä»€éº¼æ±è¥¿å¥½äº†ï¼Œæ ¹æ“šå®˜ç¶²çš„èªªæ˜ï¼Œä»–æ˜¯ç°¡å–®ã€å¿«é€Ÿä¸”æœ‰å½ˆæ€§çš„é–‹æº WebSockets serverï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„å¯ä»¥åˆ°å®ƒå®˜ç¶²å»æŸ¥çœ‹ã€‚\nå¦å¤–æœƒæŠŠç¨‹å¼ç¢¼ç›¸é—œæ”¾åˆ° GitHub Â» é»æˆ‘å‰å¾€","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"[Nginx] è§£æ±º connect() failed (111: Connection refused) while connecting to upstreamï¼šhttps://wshs0713.github.io/posts/8c1276a7/\nWebSocket proxyingï¼šhttp://nginx.org/en/docs/http/websocket.html\nday 10 Pod(3)-ç”Ÿå‘½é€±æœŸ, å®¹å™¨æ¢æ¸¬ï¼šhttps://ithelp.ithome.com.tw/articles/10236314","å£“æ¸¬#å£“æ¸¬":"æœ€å¾Œèª¿æ•´å®Œï¼Œæˆ‘å€‘ä¾†æ¸¬è©¦çœ‹çœ‹æ˜¯å¦åœ¨ Pod è‡ªå‹•é‡å•Ÿ or æ›´æ–° Deployment çš„æ™‚å€™(ä¸¦ä¸”æœ‰å¤§é‡é€£ç·šæ™‚)é‚„æœƒå™´ 502 error æˆ–æ˜¯ connect() failed (111: Connection refused)ï¼Œæˆ‘å€‘é€™é‚Šä½¿ç”¨ k6 ä¾†åš websocket æœå‹™çš„å£“æ¸¬ï¼Œæœ‰ç°¡å–®å¯«ä¸€å€‹å£“æ¸¬ç¨‹å¼å¦‚ä¸‹ï¼š\nk6 å£“æ¸¬\nk6 æ˜¯ä¸€å€‹é–‹æºçš„å£“æ¸¬å·¥å…·ï¼Œå¯ä»¥ç”¨ä¾†æ¸¬è©¦ APIã€WebSocketã€gRPC ç­‰æœå‹™ï¼Œå¯ä»¥åˆ°å®ƒçš„å®˜ç¶²æŸ¥çœ‹æ›´å¤šè³‡è¨Šã€‚\nMacOS å®‰è£æ–¹å¼ï¼šbrew install k6\nwebsocket.jsimport ws from \"k6/ws\"; import { check } from \"k6\"; export const options = { vus: 1000, duration: \"30s\", }; export default function () { const url = \"wss://socket.XXX.com/app/hex-ws?protocol=7\u0026client=js\u0026version=7.4.1\u0026flash=false\"; const res = ws.connect(url, function (socket) { socket.on(\"open\", () =\u003e console.log(\"connected\")); socket.on(\"message\", (data) =\u003e console.log(\"Message received: \", data)); socket.on(\"close\", () =\u003e console.log(\"disconnected\")); }); check(res, { \"status is 101\": (r) =\u003e r \u0026\u0026 r.status === 101 }); } ç°¡å–®èªªæ˜ä¸€ä¸‹ä¸Šé¢ç¨‹å¼åœ¨å¯«ä»€éº¼ï¼Œæˆ‘å€‘åœ¨ const è¨­å®š vus ä»£è¡¨æœ‰ 1000 å€‹è™›æ“¬ä½¿ç”¨è€…ï¼Œæœƒåœ¨ duration 30s å…§å®Œæˆæ¸¬è©¦ï¼Œä¸‹é¢çš„ default å°±æ˜¯æ¸¬è©¦é€£ç·š ws ä»¥åŠ message è·Ÿ close ç­‰å‹•ä½œï¼Œæœ€å¾Œéœ€è¦å›å‚³ 101 (ws äº¤æ¡)\nåŸ·è¡Œ k6 run websocket.js å¾Œï¼Œå°±æœƒé–‹å§‹å£“æ¸¬ï¼Œå¯ä»¥çœ‹åˆ°æœƒé–‹å§‹åŸ·è¡Œå‰›å‰›åœ¨ä¸Šé¢æåˆ° default çš„å‹•ä½œï¼š\nk6 å£“æ¸¬éç¨‹\nç­‰åˆ°è·‘å®Œï¼Œå°±æœƒå‘Šè¨´ä½  1000 ç­†è£¡é¢æœ‰å¤šå°‘çš„ http 101ï¼Œé€™é‚Šé¡¯ç¤º status is 101ï¼Œå°±ä»£è¡¨éƒ½æ˜¯ 101ï¼Œä»£è¡¨éƒ½æœ‰é€£ç·šæˆåŠŸï¼Œæ²’æœ‰å‡ºç¾ 502 error æˆ–æ˜¯ connect() failed (111: Connection refused) çš„éŒ¯èª¤ï¼Œé€™æ¨£å°±ä»£è¡¨æˆ‘å€‘çš„å•é¡Œè§£æ±ºäº†ã€‚\nk6 å£“æ¸¬çµæœ","è§£æ±ºéç¨‹#è§£æ±ºéç¨‹":"æˆ‘å€‘å¯ä»¥çœ‹åˆ°ä¸Šæ–¹éŒ¯èª¤ LOG ä¸­ï¼Œç™¼ç¾æœ‰å‡ºç¾ 502 error ä»¥åŠ connect() failed (111: Connection refused) while connecting to upstreamï¼Œé€™å…©å€‹éŒ¯èª¤éƒ½æ˜¯ç”± Nginx æ‰€ç”¢ç”Ÿçš„ï¼Œé‚£æˆ‘å€‘å…ˆä¾†ç†è§£ä¸€ä¸‹ï¼ŒNginx èˆ‡ Soketi ä¹‹é–“çš„é—œä¿‚ã€‚\nåœ¨ä½¿ç”¨ä¸Šï¼ŒRD çš„ç¨‹å¼æœƒæ‰“ Soketi å°ˆç”¨çš„ Subdomain ä¾†ä½¿ç”¨é€™å€‹ WebSocket æœå‹™ï¼Œè€Œåœ¨æˆ‘å€‘çš„æ¶æ§‹ä¸Šï¼Œé€™å€‹ Subdomain æœƒç¶“éç”¨ nginx proxy serverï¼Œä¾†è½‰ç™¼åˆ° Soketi WebSocket Server (èµ° k8s svc)ï¼Œè¨­å®šæª”å¦‚ä¸‹åœ–ï¼š\nå…¥å£ nginx è¨­å®š\nç„¶å¾Œæœƒå‡ºç¾ connect() failed (111: Connection refused) while connecting to upstream çš„éŒ¯èª¤è¨Šæ¯ï¼Œä»£è¡¨æˆ‘å€‘çš„ Nginx è¨­å®šå°‘äº†ä¸€å€‹é‡è¦çš„ä¸€è¡Œè¨­å®šï¼Œå°±æ˜¯ proxy_http_version 1.1;ï¼Œé€™å€‹è¨­å®šè¦è®“ Nginx ä½œç‚º proxy å¯ä»¥å’Œ upstream çš„å¾Œç«¯æœå‹™ä¹Ÿæ˜¯ç”¨ keepaliveï¼Œå¿…é ˆä½¿ç”¨ http 1.1ï¼Œä½†å¦‚æœæ²’æœ‰è¨­å®šé è¨­æ˜¯ 1.0ï¼Œä¹Ÿè¦è¨˜å¾—è¨­å®š proxy_set_header Upgradeã€proxy_set_header Connectionã€‚èª¿æ•´éå¾Œå°±è®Šæˆï¼š\nws.confserver { server_name socket.XXX.com; listen 80 ; listen [::]:80 ; listen 443 ssl; listen [::]:443 ssl; ssl_certificate /etc/nginx/ingress.gcp.cert; ssl_certificate_key /etc/nginx/ingress.gcp.key; access_log /var/log/nginx/access.log main; location / { proxy_pass http://soketi-ws-ci:6001; proxy_connect_timeout 10s; proxy_read_timeout 1800s; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"Upgrade\"; proxy_set_header X-Real-IP $remote_addr; } } è§£æ±ºå®Œ connect() failed (111: Connection refused) é€™å€‹å•é¡Œå¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯è¦è§£æ±º 502 error é€™å€‹å•é¡Œï¼Œæœƒå°è‡´ 502 ä»£è¡¨ Nginx é€™å€‹ proxy server é€£ä¸ä¸Šå¾Œç«¯çš„ Soketi WebSocket Serverï¼Œå†è§€å¯Ÿ LOG ä»¥åŠæ¸¬è©¦å¾Œç™¼ç¾ï¼Œç•¶ Pod è‡ªå‹•é‡å•Ÿï¼Œæˆ–æ˜¯æ‰‹å‹•é‡å•Ÿ Deployment çš„æ™‚å€™ï¼Œå°±æœƒæœ‰ 502 çš„éŒ¯èª¤ï¼Œä»£è¡¨ Nginx åœ¨ proxy åˆ°å¾Œé¢çš„ Soketi svc å†åˆ° Pod çš„æ™‚å€™ï¼Œæœ‰ä¸€æ®µæ™‚é–“æ˜¯é€£ä¸ä¸Šçš„ï¼Œæ‰€ä»¥å°±æœƒå‡ºç¾ 502 çš„éŒ¯èª¤ï¼Œå¯ä»¥æ¨æ¸¬æ˜¯æµé‡é€²åˆ°æ­£åœ¨é—œé–‰çš„ Pod æˆ–æ˜¯é€²åˆ°é‚„æ²’æœ‰å•Ÿå‹•å¥½çš„ Pod æ‰å°è‡´çš„ã€‚\né‚£æˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ Soketi WebSocket Server çš„æœå‹™ yaml æª”æ¡ˆï¼š\ndeployment.yaml deployment.yaml spec: terminationGracePeriodSeconds: 30 securityContext: {} containers: - name: soketi securityContext: {} image: \"quay.io/soketi/soketi::1.6.0-16-alpine\" ... çœç•¥ (å¯ä»¥åˆ° github çœ‹ code)... livenessProbe: failureThreshold: 3 httpGet: httpHeaders: - name: X-Kube-Healthcheck value: \"Yes\" path: / port: 6001 initialDelaySeconds: 5 periodSeconds: 2 successThreshold: 1 å¯ä»¥çœ‹åˆ°åŸä¾†çš„è¨­å®šåªæœ‰ livenessProbe è€Œå·²ï¼Œå› æ­¤æˆ‘å€‘ç‚ºäº†è¦é¿å…æµé‡é€²åˆ°æ­£åœ¨é—œé–‰çš„ Pod æˆ–æ˜¯é€²åˆ°é‚„æ²’æœ‰å•Ÿå‹•å¥½çš„ Podï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦åŠ ä¸Š readinessProbe ä»¥åŠ preStopï¼Œè®“ Pod ç¢ºå®šå•Ÿå‹•å®Œç•¢ï¼Œæˆ–æ˜¯ç­‰å¾… Service çš„ endpoint list ä¸­ç§»é™¤ Podï¼Œæ‰é–‹å§‹æ¥æ”¶æµé‡ï¼Œé€™æ¨£å°±å¯ä»¥é¿å…å‡ºç¾ 502 çš„éŒ¯èª¤ã€‚\ndeployment.yaml spec: terminationGracePeriodSeconds: 30 securityContext: {} containers: - name: soketi securityContext: {} image: \"quay.io/soketi/soketi::1.6.0-16-alpine\" ... çœç•¥ (å¯ä»¥åˆ° github çœ‹ code)... livenessProbe: failureThreshold: 3 httpGet: httpHeaders: - name: X-Kube-Healthcheck value: \"Yes\" path: / port: 6001 initialDelaySeconds: 5 periodSeconds: 2 successThreshold: 1 readinessProbe: failureThreshold: 3 httpGet: httpHeaders: - name: X-Kube-Healthcheck value: \"Yes\" path: /ready port: 6001 initialDelaySeconds: 5 periodSeconds: 2 successThreshold: 1 lifecycle: preStop: exec: command: [\"/bin/sh\", \"-c\", \"sleep 20\"] Pod çµ‚æ­¢çš„éç¨‹"},"title":"Soketi WebSocket Server LOG ä¸å®šæ™‚å‡ºç¾ 502 error ä»¥åŠ connect() failed (111: Connection refused)"},"/blog/opentelemetry/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Opentelemetry ç›¸é—œçš„æ–‡ç« ã€‚\nä»€éº¼æ˜¯ Opentelemetryï¼Ÿå¯è§€æ¸¬æ€§ (Observability) åˆæ˜¯ä»€éº¼ï¼Ÿ å¦‚ä½•é€é OpenTelemetry ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š "},"title":"Opentelemetry"},"/blog/opentelemetry/opentelemetry-ingress-nginx-controller/":{"data":{"":"ç”±æ–¼æœ€è¿‘å…¬å¸æƒ³è¦å°å…¥ Datadogï¼Œåœ¨æ¸¬è©¦éç¨‹ä¸­é †ä¾¿å°å…¥ OpenTelemetry ä¾†æ”¶é›† Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š ï½\nğŸ”¥ é€™å€‹ç¯„ä¾‹æ¯”è¼ƒç‰¹åˆ¥ï¼Œå› ç‚º Datadog æœ‰æä¾› Ingress Nginx Controller çš„ integrationsï¼Œå¯ä»¥é€é Datadog Agent ä¾†æ”¶é›† Metricsï¼Œä¸éœ€è¦é€é OpenTelemetry Collector ä¾†æ”¶é›†ã€‚ ( Datadog Agent è«‹åƒè€ƒï¼šhttps://docs.datadoghq.com/containers/kubernetes/ )\nç¨‹å¼éƒ¨åˆ†ä¹ŸåŒæ­¥ä¸Šå‚³åˆ° github ä¸Šï¼Œå¯ä»¥é»æˆ‘å‰å¾€","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Configure Nginx Ingress Controller to use JSON log formatï¼šhttps://dev.to/bzon/send-gke-nginx-ingress-controller-logs-to-stackdriver-2ih4\næ·ºè«‡ OpenTelemetry - Collector Compoentsï¼šhttps://ithelp.ithome.com.tw/articles/10290703","åŸ·è¡Œæ­¥é©Ÿ#åŸ·è¡Œæ­¥é©Ÿ":" å…ˆ clone é€™å€‹ repo (å»¢è©± xD)\nå…ˆå»ºç«‹ OpenTelemetry Collectorï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nhelm upgrade collector \\ opentelemetry-collector \\ --repo https://open-telemetry.github.io/opentelemetry-helm-charts \\ --install \\ --create-namespace \\ --namespace opentelemetry \\ -f \"otel-collector.yaml\" å†å»ºç«‹ Ingress Nginx Controllerï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nhelm upgrade ingress-nginx \\ ingress-nginx \\ --repo https://kubernetes.github.io/ingress-nginx \\ --install \\ --create-namespace \\ --namespace ingress-nginx \\ -f \"ingress-nginx-values.yaml\" æ¥è‘—å»ºç«‹æ¸¬è©¦ç”¨ Nginx æœå‹™ï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nkubectl apply -f nginx.yaml ","æª”æ¡ˆèªªæ˜#æª”æ¡ˆèªªæ˜":" otel-collector.yamlï¼š OpenTelemetry Collector çš„è¨­å®šæª”ï¼Œä¸»è¦æ˜¯è¨­å®šè¦æ”¶é›†å“ªäº› metricsã€tracesï¼Œä¸¦ä¸”è¦é€åˆ°å“ªå€‹ exporterï¼Œè¦æ³¨æ„çš„æ˜¯ exporters çš„ datadog éœ€è¦è¨­å®š siteã€api_keyï¼Œä»¥åŠ image è¦è¨˜å¾—ç”¨ otel/opentelemetry-collector-contribï¼Œæ‰æœƒæœ‰ datadog çš„ exporterã€‚\ningress-nginx-values.yamlï¼š Ingress Nginx Controller çš„è¨­å®šæª”ï¼Œé€™é‚Šçš„ podAnnotations æ˜¯ç‚ºäº†è®“ Ingress Nginx Controller çš„ Pod èƒ½å¤ é€é Datadog agent æ”¶é›† metrics åˆ° Datadog æ‰åŠ ä¸Šçš„ã€‚\nconfig è£¡é¢çš„è¨­å®šæœ‰å¾ˆå¤šï¼Œä¸»è¦éƒ½æ˜¯ openTelemetry çš„è¨­å®šï¼Œè¦æ³¨æ„çš„æ˜¯ enable-opentelemetry è¦è¨­ç‚º trueï¼Œå¦å¤– otlp-collector-host ä»¥åŠ otlp-collector-port è¦é€åˆ°å“ªå€‹ collector ç­‰ç­‰ä¹Ÿè¦è¨˜å¾—è¨­å®šã€‚ å¦å¤–å¦‚æœæƒ³è¦å°‡ LOG èˆ‡ Trace ä¸²å†ä¸€èµ·ï¼Œè¨˜å¾—è¦æŠŠ log-format è¨­ç‚º jsonï¼Œä¸¦ä¸”å¸¶å…¥ï¼Œtrace_id èˆ‡ span_id ( é€™é‚Šæœ‰å¤šå¸¶ dd.trace_id æ˜¯ç‚ºäº†è®“ datadog å¯ä»¥è‡ªå‹•ä¸²æ¥ LOG \u0026 Trace )ã€‚\nnginx.yamlï¼š ä¸€å€‹ç°¡å–®çš„ Nginx æ•´å¥—æœå‹™ (Deploymentã€Serviceã€Ingress)ï¼Œè¦æ³¨æ„çš„æ˜¯ Ingress éœ€è¦è¨­å®š annotations kubernetes.io/ingress.class: nginx (é€™å€‹æ˜¯ Ingress Nginx Controller çš„é è¨­ class name)ï¼Œæ‰æœƒè¢« Ingress Nginx Controller æ¥ç®¡ (æ‰æœƒæœ‰ Load Balancer çš„ IP)","æ¸¬è©¦#æ¸¬è©¦":"ç•¶ä½ åŸ·è¡Œå®Œä¸Šé¢çš„æ­¥é©Ÿå¾Œï¼Œä½ æœƒç™¼ç¾æœ‰ç”¢ç”Ÿå…©å€‹ namespaceï¼Œä¸€å€‹æ˜¯ ingress-nginxï¼Œå¦ä¸€å€‹æ˜¯ opentelemetryï¼Œä¸¦ä¸”æœƒæœ‰ OpenTelemetry Collectorã€Ingress Nginx Controllerã€Nginx ç­‰æœå‹™ï¼Œå¦‚ä¸‹ï¼š\nå•Ÿå‹•æœå‹™\næˆ‘å€‘è©¦è‘—æ‰“ http://nginx.example.com/ (æ¸¬è©¦ç¶²å€ï¼Œéœ€è¦å…ˆåœ¨ /etc/hosts ç¶å®š Ingress Nginx Controller å’¬ä½çš„ Load Balancer IP)ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ Datadog çš„ LOGï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ”¶åˆ° Nginx çš„ LOG (æ­¤æ”¶é›† LOG çš„æ–¹å¼æ˜¯é€éåœ¨ cluster ä¸Šå®‰è£ Datadog çš„ agent)ï¼Œå¦‚ä¸‹ï¼š\nDatadog LOG\næ¥è‘—æŸ¥çœ‹ Datadog APM çš„ traceï¼Œå¦‚ä¸‹ï¼š\nDatadog APM\nç”±æ–¼æˆ‘å€‘åœ¨å¾Œé¢ç›®å‰æ²’æœ‰ä¸²å…¶ä»–æœå‹™ï¼Œæ‰€ä»¥åªæœ‰ä¸€å€‹ spanï¼Œä¹‹å¾Œé‚„æœ‰å¦å¤–å…©ç¯‡æ–‡ç« æ˜¯ä»‹ç´¹å¦‚ä½•ä¸²å…¶ä»–æœå‹™ (æœƒå¢åŠ æœå‹™ä»¥åŠéƒ¨åˆ†è¨­å®š)ï¼Œå¯ä»¥åƒè€ƒçœ‹çœ‹ï¼šopentelemetry-roadrunnerã€opentelemetry-nodejs\né †ä¾¿çœ‹ä¸€ä¸‹é€é Datadog Agent æ”¶é›†çš„ Ingress Nginx Controller çš„ Metricsï¼Œå¦‚ä¸‹ï¼š\nDatadog Ingress Nginx Controller çš„ Metrics\nå¯ä»¥ç”¨é€™äº› Metrics ä¾†åš Dashboardï¼Œå¦‚ä¸‹ï¼š\nDatadog Dashboard","çµè«–#çµè«–":"é€é OpenTelemetry Collector ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Šï¼Œé€™æ¨£å°±å¯ä»¥é€é Ingress Nginx Controller çš„ Metrics ä¾†åšç›£æ§äº†ï¼Œå°æ–¼ RD å†é–‹ç™¼ä¸Šï¼Œæœ‰ Traces ä¹Ÿæ›´æ–¹ä¾¿ RD ä»–å€‘æ‰¾åˆ°ç¨‹å¼çš„ç“¶é ¸ (æœ‰å¯èƒ½æ˜¯æœå‹™å°è‡´çš„)ã€‚"},"title":"å¦‚ä½•é€é OpenTelemetry ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š"},"/blog/opentelemetry/opentelemetry-observability/":{"data":{"":"åœ¨ä»‹ç´¹ Opentelemetry ä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆäº†è§£ä¸€ä¸‹ç›®å‰è»Ÿé«”æ¶æ§‹ä»¥åŠåŸºç¤è¨­æ–½çš„æ¼”é€²ï¼š\nè»Ÿé«”æ¶æ§‹ä»¥åŠåŸºç¤è¨­æ–½çš„æ¼”é€²\nç¬¬ä¸€éšæ®µåœ¨è»Ÿé«”æ¶æ§‹è¨­è¨ˆä¸Šè¼ƒç‚ºç°¡å–®ï¼Œä¸æœƒæœ‰ä»€éº¼ç‰¹åˆ¥éœ€è¦æ‹†åˆ†å‡ºä¾†çš„ç¨‹å¼ï¼Œæ‰€ä»¥éƒ½æ˜¯ä¸€æ•´åŒ…çš„ç¨‹å¼ï¼Œå†æ¸¬è©¦ä»¥åŠé™¤éŒ¯ä¹Ÿæ¯”è¼ƒä¸æœƒæœ‰ä»€éº¼å•é¡Œã€‚åŸºç¤è¨­æ–½éƒ½æ˜¯ä½¿ç”¨ VM æˆ–æ˜¯ä½¿ç”¨æ”¾åœ¨ IDC çš„æ©Ÿæˆ¿ä¾†ç•¶ Serverã€‚\nç¬¬äºŒéšæ®µéš¨è‘—é›²ç«¯æŠ€è¡“çš„æ¨å‡ºï¼Œæœƒé–‹å§‹å°‡æœå‹™æ¬ä¸Šé›²ä¾›æ‡‰å•†æä¾›çš„ IaaS æœå‹™ï¼Œæˆ–æ˜¯ä½¿ç”¨ç§æœ‰é›²çµ¦ä¼æ¥­æ”¾ç½®è¼ƒæ©Ÿå¯†çš„å…§å®¹ï¼Œå…¶ä»–å‰‡æ”¾ç½®å…¬æœ‰é›²ä¸Šï¼Œé”æˆæ··åˆé›²çš„æ¨¡å¼ã€‚\nç¬¬ä¸‰éšæ®µéš¨è‘—é›²ç«¯æŠ€è¡“è¶Šä¾†è¶Šæˆç†Ÿï¼Œæœ‰æ›´å¤šçš„é›²ç«¯ IaC ä»¥åŠåŠŸèƒ½æ¨å‡ºï¼Œæœƒé–‹å§‹è€ƒæ…®ä½¿ç”¨åˆ†æ•£å¼çš„ç³»çµ±æ¶æ§‹ï¼Œå°‡ DB ç­‰æœå‹™ä¹Ÿæ”¹ç”¨ Cloud SQL çš„æ–¹å¼ã€‚åœ¨åŸºç¤è¨­æ–½ä¸Šä¹Ÿéš¨è‘—å®¹å™¨åŒ–çš„æŠ€è¡“æˆç†Ÿè€Œé€²å…¥æ–°çš„æ™‚ä»£ã€‚\nç¬¬å››éšæ®µå·²ç¶“ä½¿ç”¨ docker ä¾†ç®¡ç†å¥½ä¸€é™£å­ï¼Œä½†ç™¼ç¾è™›æ“¬å®¹å™¨æŠ€è¡“åœ¨ç®¡ç†ä¸Šååˆ†ä¸æ–¹ä¾¿ï¼Œå› æ­¤ K8s é€æ¼¸ç››è¡Œï¼Œå°‡æ¶æ§‹å¾åˆ†æ•£å¼æ”¹æˆå¾®æœå‹™çš„æ–¹å¼é€²è¡Œï¼Œåœ¨è®“é–‹ç™¼åœ˜éšŠä½¿ç”¨ä¸Šå¯ä»¥æ›´éˆæ´»ä¸”å®¹æ˜“ã€‚\né›–ç„¶ä½¿ç”¨ K8s å¯ä»¥è®“æˆ‘å€‘çš„æœå‹™æ›´éˆæ´»æ–¹ä¾¿ï¼Œä½†ä¹Ÿæœƒå°‡æœå‹™åˆ‡çš„è¶Šä¾†è¶Šç´°ï¼Œé€™æ™‚æœƒè®“é–‹ç™¼è®Šçš„ååˆ†è¤‡é›œï¼Œæˆ‘å€‘åœ¨æ¶æ§‹ä¸Šå¾ä¸€é–‹å§‹çš„å–®é«”å¼æ¶æ§‹ï¼Œè®Šæˆåˆ†æ•£å¼æ¶æ§‹ï¼Œå†åˆ°æœ€å¾Œçš„å¾®æœå‹™ï¼Œè®“é–‹ç™¼äººå“¡éœ€è¦è™•ç†çš„äº‹æƒ…æœƒè¶Šä¾†è¶Šå¤šã€‚æœå‹™è¦å¦‚ä½•é€£ç·šï¼ŸLog è¦å¦‚ä½•è¨˜éŒ„ï¼Ÿä»¥åŠç•¶ä¸€å€‹è«‹æ±‚æœƒç¶“éå¤šå€‹æœå‹™æ™‚ï¼Œç›¸å°çš„å»¶é²ä¹Ÿæœƒå¢åŠ ï¼Œé€™æ™‚è¦æ€éº¼å»è™•ç†ç­‰ã€‚åœ¨ç›£æ§ä¸Šï¼Œå› ç‚ºæœå‹™åˆ‡åˆ†å¾—å¾ˆç´°ï¼Œç•¶ç·šä¸Šæœ‰ä¸€å€‹æœå‹™æœ‰å•é¡Œæ™‚ï¼Œè¦å¦‚ä½•å¿«é€Ÿçš„æ‰¾åˆ°å•é¡Œé»ä¹Ÿæ˜¯ä¸€å¤§æŒ‘æˆ°ã€‚\nç•¶æˆ‘å€‘ä½¿ç”¨åˆ†æ•£å¼ç³»çµ±æˆ–æ˜¯å¾®æœå‹™æ™‚ç™¼ç”Ÿæ•…éšœæ™‚ï¼Œæœƒå¾ˆé›£å¿«é€Ÿçš„æ¢å¾©æœå‹™ï¼Œå› ç‚ºæ¯å€‹æœå‹™éƒ½äº’ç›¸ä¾è³´ï¼Œåœ¨ä»¥å¾€éƒ½æ˜¯é€éç¶“é©—ä»¥åŠå°ç³»çµ±çš„äº†è§£ä¾†å¾—ä»¥è§£æ±ºã€‚é‚£æœ‰ä»€éº¼å…¶ä»–çš„æ–¹å¼ï¼Œèƒ½å¤ è®“æˆ‘å€‘æ›´å¿«æŒæ¡æ¯å€‹æœå‹™å‘¢ï¼Ÿæˆ‘å€‘å…ˆä¾†äº†è§£ä¸€å€‹åè©ï¼šå¯è§€æ¸¬æ€§(Observability)","opentelemetry#Opentelemetry":"é‚£æˆ‘å€‘é€™æ¬¡è¦ä»‹ç´¹çš„å¯è§€æ¸¬æ€§(Observability)å·¥å…·å°±æ˜¯ Opentelemetryï¼Œç¸®å¯« OTelï¼Œå®ƒæ˜¯ç”± CNCF (Cloud Native Computing Foundation) çµ„ç¹”å­µåŒ–çš„é–‹æºå°ˆæ¡ˆï¼Œåœ¨ 2021 å¹´ 5 æœˆç”± OpenTracing èˆ‡ OpenCensus å…©å€‹æ¡†æ¶åˆä½µï¼Œçµåˆå…©é …åˆ†æ•£å¼è¿½è¹¤æ¡†æ¶æœ€é‡è¦çš„ç‰¹æ€§æˆç‚ºä¸‹ä¸€ä»£æ”¶é›†é™æ¸¬æ•¸æ“šçš„æ–°æ¨™æº–ã€‚\ntelemetry åˆå«åšé™æ¸¬ï¼Œæ˜¯æŒ‡èƒ½å¤ è·¨è¶Šä¸åŒç³»çµ±ä¾†æ”¶é›†è³‡æ–™ (åŒ…å« LOGã€Metricã€trace) çš„èƒ½åŠ›ã€‚\næˆ‘å€‘å¯ä»¥çœ‹ä¸€ä¸‹å®˜ç¶²çš„èªªæ˜ï¼š\nOpentelemetry æ˜¯é›²åŸç”Ÿçš„å¯è§€æ¸¬æ€§(Observability)æ¡†æ¶ï¼Œæä¾›æ¨™æº–åŒ–çš„ APIã€SDK èˆ‡å”è­°è‡ªå‹•æª¢æ¸¬ã€è’é›†ã€å°å‡ºé™æ¸¬æ•¸æ“šè³‡æ–™ (Metricsã€Logã€Trace)ï¼Œä¸¦æ”¯æ´ W3C å®šç¾©çš„ Http trace-context è¦ç¯„ï¼Œé™ä½é–‹ç™¼è€…åœ¨æœé›†é™æ¸¬æ•¸æ“šä¸Šçš„å›°é›£åº¦ï¼Œä»¥åŠæ–¹ä¾¿é€²è¡Œå¾ŒçºŒåˆ†æä»¥åŠæ€§èƒ½çš„å„ªåŒ–ã€‚\nOpentelemetry\nåœ¨ OpenTelemetry æ ¸å¿ƒå…ƒä»¶å¦‚ä¸‹ï¼š\nAPIï¼šé–‹ç™¼äººå“¡å¯ä»¥é€é OpenTelemetry API è‡ªå‹•ç”Ÿæˆã€è’é›†æ‡‰ç”¨ç¨‹å¼(Application)çš„é™æ¸¬æ•¸æ“šè³‡æ–™(Metrics, Log, Trace)ï¼Œæ¯å€‹ç¨‹å¼èªè¨€éƒ½éœ€å¯¦ä½œ OpenTelemetry è¦ç¯„æ‰€å®šç¾©çš„ API æ–¹æ³•ç°½ç« ã€‚\nSDKï¼šæ˜¯ OpenTelemetry API çš„å¯¦ç¾ã€‚\nOTLPï¼šè¦ç¯„å®šç¾©äº†é™æ¸¬æ•¸æ“šçš„ç·¨ç¢¼èˆ‡å®¢æˆ¶ç«¯åŠæœå‹™å™¨ä¹‹é–“å¦‚ä½•äº¤æ›çš„å”è­° (gRPCã€HTTP)ã€‚\nCollectorï¼šOpenTelemetry ä¸­å„²å­˜åº«ï¼Œç”¨æ–¼æ¥æ”¶ã€è™•ç†ã€å°å‡ºé™æ¸¬æ•¸æ“šåˆ°å„ç¨®å¾Œç«¯å¹³å°ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Observabilityï¼šhttps://linkedin.github.io/school-of-sre/level101/metrics_and_monitoring/observability/\n[OpenTelemetry] ç¾ä»£åŒ–ç›£æ§ä½¿ç”¨ OpenTelemetry å¯¦ç¾ : å¯è§€æ¸¬æ€§(Observability)ï¼šhttps://marcus116.blogspot.com/2022/01/modern-monitoring-using-openTelemetry-with-Observability.html\n[OpenTelemetry] ç¾ä»£åŒ–ç›£æ§ä½¿ç”¨ OpenTelemetry å¯¦ç¾ : OpenTelemetry é–‹æ”¾é™æ¸¬ï¼šhttps://marcus116.blogspot.com/2022/01/opentelemetry-opentelemetry.html\næ·ºè«‡ Observability(ä¸‹)ï¼šhttps://ithelp.ithome.com.tw/m/articles/10287598\nManage services, spans, and traces in Splunk APMï¼šhttps://docs.splunk.com/Observability/apm/apm-spans-traces/traces-spans.html","å¯è§€æ¸¬æ€§observability#å¯è§€æ¸¬æ€§(Observability)":"å¯è§€æ¸¬æ€§æœ‰ä¸‰å€‹é‡è¦çš„ç‰¹æ€§ï¼Œåˆ†åˆ¥æ˜¯ï¼š\nMetrics è² è²¬ç›£æ§ç³»çµ±æœ‰ä»€éº¼ç‹€æ³ï¼Œç•¶è¦ç™¼ç”Ÿæœå‹™æ•…éšœå‰å¯ä»¥é€éè¨­å®šé–¥å€¼æ­é…å‘Šè­¦ææ—©å¾—çŸ¥ã€‚\nLogs ç•¶å•é¡Œç™¼ç”Ÿæ™‚ï¼Œå¯ä»¥ç”¨ä¾†æŸ¥çœ‹æ•…éšœæ™‚æ­£åœ¨åŸ·è¡Œå“ªäº›æœå‹™ï¼Œä»¥åŠç”¢ç”Ÿçš„éŒ¯èª¤è³‡è¨Šã€‚\nTraces ï¼ˆå¾Œé¢è©³ç´°ä»‹ç´¹ï¼‰\nå¯è§€æ¸¬æ€§ä¸‰å¤§æ”¯æŸ±\næˆ‘å€‘å°æ–¼ Metrics è·Ÿ Logs æœ‰åŸºæœ¬çš„äº†è§£ï¼Œæ‰€ä»¥æˆ‘é€™é‚Šæœƒæ³¨é‡åœ¨ Traces çš„éƒ¨åˆ†ï¼š\nç•¶æœ‰å¤šå€‹å¾®æœå‹™çš„è¤‡é›œåˆ†æ•£å¼ç³»çµ±ï¼Œç”¨æˆ¶çš„è«‹æ±‚æœƒç”±ç³»çµ±ä¸­çš„å¤šå€‹å¾®æœå‹™é€²è¡Œè™•ç†ã€‚Metrics è·Ÿ Logs å¯ä»¥æä¾›æˆ‘å€‘æœ‰é—œç³»çµ±å¦‚ä½•å»è™•ç†é€™äº›è«‹æ±‚çš„ä¸€äº›è³‡è¨Šï¼Œä½†æ²’æœ‰è¾¦æ³•æä¾›å¾®æœå‹™çš„è©³ç´°è¨Šæ¯ä»¥åŠä»–æ˜¯å¦‚ä½•å½±éŸ¿å®¢æˆ¶ç«¯çš„è«‹æ±‚ã€‚é€™æ™‚å€™å°±éœ€è¦é€é Trace ä¾†å”åŠ©æˆ‘å€‘è¿½è¹¤ã€‚\nTrace å¯ä»¥åœ¨é€£çºŒçš„æ™‚é–“ç¶­åº¦ä¸Šï¼Œé€é Trace ä»¥åŠ Span é—œè¯ï¼ŒæŠŠç©ºé–“çµ¦æ’åˆ—å±•ç¤ºå‡ºä¾†ï¼Œä¸¦ä¸”æœ‰ Trace-Context è¦ç¯„ï¼Œèƒ½å¤ ç›´è§€çš„çœ‹åˆ°è«‹æ±‚åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ç¶“éæ‰€æœ‰æœå‹™çš„ç´€éŒ„ã€‚\nä»€éº¼æ˜¯ Traceã€Span ã€Trace-Context å‘¢ï¼Ÿ\næˆ‘å€‘å…ˆèªª Spanï¼ŒSpan åˆå¯ä»¥å«è·¨åº¦ï¼Œæ˜¯ç³»çµ±ä¸­æœ€å°çš„å–®ä½ï¼Œå¯ä»¥çœ‹ä¸‹æ–¹åœ–ç‰‡ï¼ŒSpanA çš„è³‡æ–™æ˜¯ä¾†æº SpanBï¼ŒSpanB ä¾†æºæ˜¯ SpanC ç­‰ç­‰ï¼Œæ¯ä¸€å€‹ Span å¯ä»¥æŠŠå®ƒæƒ³æˆä¸€å€‹è«‹æ±‚å¾Œé¢æ‰€æœ‰ç¶“éæœå‹™çš„å·¥ä½œæµç¨‹ï¼Œä¾‹å¦‚ï¼šnginx_moduleã€dbã€redis ç­‰ç­‰ã€‚\nè«‹æ±‚çš„æ•´å€‹éç¨‹å«åš Traceï¼Œé‚£ä»–è¦æ€éº¼çŸ¥é“ SpanA ~ SpanE æ˜¯åŒä¸€å€‹è«‹æ±‚å‘¢ï¼Ÿ\nå°±éœ€è¦é€é TraceID ä»¥åŠ SpanID ä¾†è¨˜éŒ„ï¼š\nTraceIDï¼šæ˜¯å”¯ä¸€çš„ IDï¼Œç”¨æ–¼è­˜åˆ¥æ•´å€‹åˆ†æ•£å¼è¿½è¹¤çš„ä¸€æ¢è«‹æ±‚è·¯å¾‘ã€‚åœ¨ä¸‹æ–¹åœ–ç‰‡ä¸­ï¼Œç•¶è«‹æ±‚é€²å…¥æ™‚ï¼Œå°±æœƒè¢«è³¦äºˆä¸€å€‹ TraceIDï¼Œæ‰€æœ‰æœ‰ç¶“éçš„ Span éƒ½æœƒè¨˜éŒ„æ­¤ TraceIDï¼Œé€™æ¨£æ‰å¯ä»¥æŠŠä¸åŒæœå‹™ä¾æ“š TraceID é—œè¯æˆåŒä¸€å€‹è«‹æ±‚ã€‚\nSpanIDï¼šæ˜¯ä¸€æ¢è«‹æ±‚è·¯å¾‘ä¸­å–®å€‹æ“ä½œå”¯ä¸€çš„ IDã€‚è¿½è¹¤è·¯å¾‘æ˜¯ç”±å¤šå€‹ Span çµ„æˆï¼Œæ¯å€‹ Span éƒ½ä»£è¡¨ä¸€å€‹æ“ä½œæˆ–ç‰¹å®šçš„æ™‚é–“æ®µã€‚ç•¶è«‹æ±‚é€²å…¥æ™‚ï¼Œæ¯å€‹æœå‹™å°±æœƒç”¢ç”Ÿä¸€å€‹ Span ä¾†ä»£è¡¨å®ƒè™•ç†è«‹æ±‚çš„çš„æ™‚é–“ã€‚é€™äº› Span ä½¿ç”¨ TraceID ä¾†é€£æ¥å†ä¸€èµ·ï¼Œå½¢æˆå®Œæ•´çš„è«‹æ±‚è¿½è¹¤ã€‚\nTrace ç¤ºæ„åœ–\né‚£è¦æ€éº¼æŸ¥çœ‹æ¯å€‹ Span çš„ç´€éŒ„å…§å®¹å‘¢ï¼Œå°±éœ€è¦ Trace-Contextï¼š\næœƒæ”¾ç½®ä¸€äº›ç”¨æ–¼è¿½è¹¤å’Œè­˜åˆ¥è«‹æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚ Trace IDã€Span ID å’Œå…¶ä»–ç›¸é—œçš„æ•¸æ“šã€‚é€™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯å¯ä»¥æ˜¯ä¸€äº›é—œéµçš„æ•¸æ“šï¼Œå¯ä»¥å¹«åŠ©æˆ‘å€‘åœ¨æ•´å€‹åˆ†ä½ˆå¼ç³»çµ±ä¸­è¿½è¹¤è«‹æ±‚çš„è·¯å¾‘ï¼Œä¸¦å°‡ç›¸é—œè«‹æ±‚å’Œæ“ä½œé—œè¯èµ·ä¾†ã€‚\nECK Trace ç¤ºæ„åœ–\nä¸Šé¢çš„åœ–ç‰‡ä¸­ï¼Œå¯ä»¥çœ‹åˆ° call /product/XXXX å¾Œï¼Œæœƒç¶“ééœ€å¤šçš„ Spanï¼Œéš¨ä¾¿é»æ“Šä¸€å€‹ Span å¯ä»¥çœ‹åˆ°å®ƒè¨˜éŒ„çš„ Trace-Contextï¼Œä»¥åŠéƒ½æœƒåŒ…å« TraceID åŠ SpanID\nECK Trace ç¤ºæ„åœ–\nTrace å„ªé»å¯ä»¥çœ‹åˆ°è·¨ç¶­åº¦çœ‹åˆ°ä¸­é–“çš„è³‡è¨Šï¼Œå°æ–¼æ‰¾åˆ°å•é¡Œä»¥åŠç“¶é ¸ååˆ†æ–¹ä¾¿ï¼Œä½†ç¼ºé»å°±æ˜¯å› ç‚ºéœ€è¦åœ¨ Span ä¸­ç”¢ç”Ÿ ID ä»¥åŠå…§å®¹ï¼Œéœ€è¦åœ¨ç¨‹å¼è£¡é¢åŠ å…¥ä¸€å®šçš„å¥—ä»¶ä»¥åŠèª¿æ•´ç¨‹å¼ç¢¼ã€‚\næ‰€ä»¥æˆ‘å€‘åœ¨å¯è§€æ¸¬æ€§(Observability)æœ€çµ‚çš„ç›®çš„æ˜¯å¸Œæœ›å¯ä»¥é€éå¯è§€æ¸¬æ€§å·¥å…·è®“æˆ‘å€‘çŸ¥é“ï¼š\nè«‹æ±‚é€šéå“ªäº›æœå‹™ æ¯å€‹æœå‹™åœ¨è™•ç†è«‹æ±‚æ™‚åšäº†äº›ä»€éº¼ å¦‚æœè«‹æ±‚å¾ˆæ…¢ï¼Œç“¶é ¸åœ¨å“ªé‚Š å¦‚æœè«‹æ±‚å¤±æ•—ï¼ŒéŒ¯èª¤é»åœ¨å“ª è«‹æ±‚çš„è·¯å¾‘æ˜¯ä»€éº¼ ç‚ºä»€éº¼èŠ±é€™éº¼é•·çš„æ™‚é–“ "},"title":"ä»€éº¼æ˜¯ Opentelemetryï¼Ÿå¯è§€æ¸¬æ€§ (Observability) åˆæ˜¯ä»€éº¼ï¼Ÿ"},"/blog/other/":{"data":{"":"å…ˆæ”¾ç½®é‚„æ²’æœ‰æƒ³åˆ°çš„åˆ†é¡ Blog æ–‡ç« ã€‚\nBookstack é–‹æºçŸ¥è­˜åº«ç­†è¨˜å¹³å°å®‰è£ (K8s + docker) æ‰¾å‡ºç¨‹å¼ç¢¼ã€é–‹æºå¥—ä»¶ã€å®¹å™¨çš„å®‰å…¨æ¼æ´å·¥å…· - Snyk "},"title":"å…¶ä»–(é‚„æƒ³ä¸åˆ°åˆ†é¡)"},"/blog/other/bookstack/":{"data":{"":"æœ€è¿‘å‰›å¥½æœ‰å…¬å¸åŒäº‹é›¢è·ï¼Œæƒ³è¦æŠŠäº¤æ¥çš„è³‡æ–™çµ¦æ•´ç†æ•´ç†ï¼Œé›–ç„¶éƒ¨é–€ä¹‹å‰æœ‰æ¶è¨­å°ˆç”¨çš„ wiki çµ¦ RD ä½¿ç”¨ï¼Œä½†è¦ºå¾—ä»‹é¢æ²’æœ‰åˆ°å¾ˆå¥½ç”¨ï¼Œæ–¼æ˜¯å°±åœ¨ç¶²è·¯ä¸Šå°‹æ‰¾ï¼Œå¯ä»¥å¤šäººç·¨è¼¯çš„ç­†è¨˜ç³»çµ±ï¼Œä¸€é–‹å§‹æœ‰æƒ³éç”¨ CodiMD (HackMD)ï¼Œä½†è€ƒé‡åˆ°éœ€è¦å¤šå±¤çš„æ¶æ§‹ä¾†å€åˆ†æ–‡ä»¶ï¼Œæœ€å¾Œé¸æ“‡ Bookstack é€™å€‹é–‹æºçŸ¥è­˜åº«ç­†å¹³å°ä¾†ä½œç‚ºçµ„å…§çš„ç­†è¨˜ç³»çµ±ï¼Œä»¥ä¸‹æœƒç°¡å–®èªªä¸€ä¸‹ Bookstack çš„ç‰¹è‰²ä»¥åŠä½¿ç”¨ K8s è·Ÿ docker çš„å®‰è£æ•™å­¸ã€‚","bookstack-ä»‹ç´¹#Bookstack ä»‹ç´¹":"ä»‹ç´¹éƒ¨åˆ†ä¸»è¦åƒè€ƒ Bookstack ç°¡ä»‹ï¼Œä»¥ä¸‹åˆ—å‡ºæœƒé¸æ“‡å®ƒçš„ä¸‰å€‹ç‰¹è‰²ï¼š\nç°¡æ½”çš„æ›¸æœ¬åˆ—è¡¨æ¨¡å¼ æ›¸æ¶åˆ†é¡\næ›¸æœ¬åˆ†é¡\né é¢ç« ç¯€åˆ†é¡\næœ€ä¸»è¦æ˜¯å› ç‚ºæœ‰ä»¥ä¸Šå¹¾å€‹ä¸åŒçš„åˆ†å±¤æ¶æ§‹ï¼Œåœ¨è³‡æ–™æ•´ç†ä¸Šæœƒæ›´æ–¹ä¾¿ã€æ›´å¥½å½™æ•´ï¼Œå¯ä»¥è‡ªè¨‚æ›¸æ¶ä»¥åŠæ›¸æœ¬ã€é é¢æˆ–æ˜¯ç« ç¯€çš„å°é¢ä»¥åŠå…§å®¹ã€‚\nå¼·å¤§çš„æœå°‹åŠŸèƒ½ æœå°‹åŠŸèƒ½\nç•¶æˆ‘å€‘çš„ç­†è¨˜å…§å®¹è¶Šä¾†è¶Šå¤šï¼Œé›–ç„¶æœ‰ä¸Šé¢æåˆ°çš„åˆ†é¡æ¨¡å¼ï¼Œæƒ³è¦æ‰¾åˆ°å…§å®¹é‚„æ˜¯éœ€è¦èŠ±ä¸€æ®µæ™‚é–“ï¼Œä½† Bookstack æœ‰å¼·å¤§çš„æœå°‹åŠŸèƒ½ï¼Œå¯ä»¥é‡å°æ›¸æ¶ã€æ›¸æœ¬ã€ç« ç¯€æˆ–æ˜¯æ›¸é¢å€‹åˆ¥æœå°‹ï¼Œå¯ä»¥åˆ©ç”¨æ™‚é–“ã€æ¨™ç±¤ã€æ¨™é¡Œæˆ–æ˜¯å…§å®¹ä¾†å¿«é€Ÿæ‰¾åˆ°æƒ³è¦çš„å…§å®¹ã€‚\nç•«åœ–åŠŸèƒ½ åœ¨è¨è«–ç³»çµ±æˆ–æ˜¯ç¨‹å¼çš„æ¶æ§‹ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯ç”¨ç•«åœ–çš„ä¾†è¡¨ç¤ºã€‚åœ¨ä»¥å¾€éƒ½æ˜¯ä½¿ç”¨ Draw.io ä¾†ç•«åœ–ï¼Œç•¶ç•«å®Œåœ–å¾Œéœ€è¦åŒ¯å‡ºç•«å¥½çš„åœ–ä»¥å¤–ï¼Œå¦‚æœæ€•ç•«åœ–çš„åŸæª”æ¶ˆå¤±ï¼Œé‚„éœ€è¦å†å¦å¤–ä¸‹è¼‰åŸæª”ä¾†ä¿ç•™ï¼Œå¾ˆä¸æ–¹ä¾¿ï¼Œåˆæ€•å¿˜è¨˜ä¸‹è¼‰ï¼Œè€Œ Bookstack å…§å»ºå¯ç›´æ¥ç·¨è¼¯çš„åŠŸèƒ½ï¼Œç•¶ç•«å®Œåœ–å¾Œæœ‰å•é¡Œï¼Œå¯ä»¥ç›´æ¥é»æ“Šåœ–ç‰‡ä¾†ç·¨è¼¯ï¼Œè€Œé€™äº›åŠŸèƒ½é‚„æœƒæ­é…å…§å»ºçš„ç‰ˆæ§ï¼Œè‹¥æœ‰å•é¡Œé‚„å¯ä»¥é‚„åŸåˆ°æ­£ç¢ºçš„åœ–ç‰‡ç‰ˆæœ¬ã€‚\nç•«åœ–åŠŸèƒ½","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"BookStack ç°¡ä»‹ï¼šhttps://docs.ossii.com.tw/books/bookstack/page/bookstack\nBookStack Installationï¼šhttps://www.bookstackapp.com/docs/admin/installation/","å®‰è£èªªæ˜#å®‰è£èªªæ˜":"é‚£ç°¡å–®èªªæ˜ç‚ºä»€éº¼æœƒé¸æ“‡ Bookstack æˆ‘å€‘å°±ä¾†å®‰è£å®ƒï¼Œé€™é‚Šæœ‰ä½¿ç”¨ K8s + docker ä¾†æ¸¬è©¦å®‰è£ï¼Œé‚£æˆ‘å€‘å°±ä¸€èµ·ä¾†çœ‹ç¨‹å¼ç¢¼å§ï¼Œç¨‹å¼ç¢¼æ”¾åœ¨é€™ ğŸ‘ˆï¼š\nK8s namespace.yamlapiVersion: v1 kind: Namespace metadata: name: bookstack æˆ‘ç¿’æ…£æœƒå°‡ä¸åŒçš„æœå‹™åˆ‡ namespace ä¾†éƒ¨ç½²ï¼Œå¤§å®¶å¯ä»¥ä¾ç…§ç¿’æ…£ä¾†ä½¿ç”¨ï¼Œä¸‹æ–¹çš„ yaml éƒ½æ˜¯å»ºåœ¨æ­¤ namespace ä¸Šã€‚\ndeployment.yamlapiVersion: apps/v1 kind: Deployment metadata: name: bookstack namespace: bookstack labels: app: bookstack spec: replicas: 1 selector: matchLabels: app: bookstack template: metadata: labels: app: bookstack spec: containers: - name: bookstack image: linuxserver/bookstack ports: - name: http containerPort: 80 env: - name: DB_DATABASE value: bookstack - name: DB_HOST value: \u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - name: DB_PORT value: \"3306\" - name: DB_PASSWORD value: \u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - name: DB_USERNAME value: \u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - name: MAIL_USERNAME value: example@test.com - name: MAIL_PASSWORD value: mailpass - name: MAIL_HOST value: smtp.server.com - name: MAIL_PORT value: \"465\" - name: MAIL_ENCRYPTION value: SSL - name: MAIL_DRIVER value: smtp - name: MAIL_FROM value: no-reply@test.com - name: APP_URL value: https://\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - name: APP_LANG value: zh_TW - name: APP_TIMEZONE value: Asia/Taipei resources: limits: cpu: \"0.5\" memory: \"512Mi\" å¿…è¦æ›´æ›çš„åƒæ•¸æœ‰æ¨™ç¤º Â«æ›´æ›æ­¤è™•Â»ï¼Œå…¶é¤˜å¯ä»¥ä¾ç…§å„çµ„ç¹”ä¾†è‡ªè¡Œé…ç½®ï¼ŒBookstack æœƒå°‡å…§å®¹å­˜åœ¨ dbï¼Œåœ–ç‰‡ç­‰å­˜åœ¨ pod ä¸­ï¼Œéœ€è¦æ°¸ä¹…ä¿å­˜è«‹ä½¿ç”¨ pvc + pv æˆ–æ˜¯å¦å¤–æ› nasã€‚\nsvc.yamlapiVersion: v1 kind: Service metadata: name: bookstack namespace: bookstack spec: type: NodePort selector: app: bookstack ports: - name: http protocol: TCP port: 80 targetPort: 80 ingress.yamlapiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: bookstack-ingress namespace: bookstack annotations: kubernetes.io/ingress.class: nginx service.beta.kubernetes.io/do-loadbalancer-enable-proxy-protocol: \"true\" spec: rules: - host: \u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e http: paths: - path: / pathType: Prefix backend: service: name: bookstack port: number: 80 æœ€å¾Œé€é ingress çš„ domain å»è¨ªå• svc \u003e pod ä¸Šï¼Œå°±å®Œæˆéƒ¨ç½²æ‹‰ï½ç¬¬ä¸€æ¬¡ç™»å…¥è¦ä½¿ç”¨é è¨­å¸³è™ŸåŠå¯†ç¢¼ admin@admin.com/password\ndocker docker-compose.yamlversion: \"3.8\" services: bookstack: image: lscr.io/linuxserver/bookstack container_name: bookstack environment: - PUID=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - PGID=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - DB_HOST=bookstack_db - DB_PORT=3306 - DB_USER=bookstack - DB_PASS=bookstack - DB_DATABASE=bookstackapp - APP_LANG=zh_TW - APP_TIMEZONE=Asia/Taipei - APP_URL=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - GOOGLE_APP_ID=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - GOOGLE_APP_SECRET=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e volumes: - /bookstack/config:/config ports: - 80:80 restart: unless-stopped depends_on: - bookstack_db bookstack_db: image: lscr.io/linuxserver/mariadb container_name: bookstack_db environment: - PUID=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - PGID=\u003c\u003cæ›´æ›æ­¤è™•\u003e\u003e - MYSQL_ROOT_PASSWORD=bookstack - TZ=Asia/Taipei - MYSQL_DATABASE=bookstackapp - MYSQL_USER=bookstack - MYSQL_PASSWORD=bookstack volumes: - /bookstack/config:/config restart: unless-stopped docker çš„éƒ¨åˆ†å°±æ›´ç°¡å–®äº†ï¼Œä¸€æ¨£æ˜¯æŠŠ Â«æ›´æ›æ­¤è™•Â» æ›æˆå°æ‡‰çš„å…§å®¹å³å¯ï¼Œenv çš„éƒ¨åˆ†å¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼Œé€™é‚Šæ¯”è¼ƒç‰¹åˆ¥çš„æ˜¯æˆ‘å€‘æœ‰å¤šä½¿ç”¨ Google ä¾† Oauth ç™»å…¥ï¼ŒBookstack æ”¯æ´å¤šç¨®çš„ Oauth ç™»å…¥æ–¹å¼ï¼Œå¯ä»¥åƒè€ƒ Third Party Authenticationã€‚\næ¶è¨­å¥½ Bookstack å°±å¯ä»¥é–‹å§‹å¯«éƒ¨é–€æˆ–æ˜¯çµ„ç¹”å…§çš„ç­†è¨˜æ‹‰ï½ å¦‚æœæœ‰é–‹æ”¾å¤–ç¶²é€£ç·šï¼Œè¦è¨˜å¾—ä¿®æ”¹é è¨­çš„ç®¡ç†å“¡å¸³è™Ÿï¼Œä»¥åŠç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ï¼Œåˆ°åŠŸèƒ½èˆ‡å®‰å…¨çš„å…¬é–‹å­˜å–çµ¦å–æ¶ˆï¼Œé€™æ¨£å°±å¿…é ˆè¦ç™»å…¥æ‰å¯ä»¥ç€è¦½ç­†è¨˜äº†ï¼é‚£å°±äº¤çµ¦å¤§å®¶è‡ªå·±å»ç©é€™å€‹å¥½ç”¨çš„ç­†è¨˜å·¥å…·å›‰ï½ï½ ğŸ˜\nåŠŸèƒ½èˆ‡å®‰å…¨è¨­å®š"},"title":"Bookstack é–‹æºçŸ¥è­˜åº«ç­†è¨˜å¹³å°å®‰è£ (K8s + docker)"},"/blog/other/snyk/":{"data":{"":"å‰å¹¾å¤©æœ‰æ©Ÿæœƒå¯ä»¥å»åƒåŠ  DevOpsDays Taipei 2022 æ´»å‹•ï¼Œè½åˆ°äº†ä¸€é–€æœ‰é—œæ–¼å¦‚ä½•å°‡ Security åŠ å…¥ DevOps - GitLab CI/CD with Snyk çš„è¬›åº§ï¼Œè¦ºå¾—è »æœ‰è¶£çš„ï¼Œæƒ³èªªé †ä¾¿ç´€éŒ„ä¸€ä¸‹é€™å¹¾å¤©å»è½çš„å…§å®¹ï¼Œæ–‡ç« åº•ä¸‹æœ‰é™„ä¸Šæœ¬æ¬¡å¤§æœƒçš„å…±ç­†ä»¥åŠè©²è¬›è€…æ–¼è‡ªå·±éƒ¨è½æ ¼æ‰€ç™¼çš„æ–‡ç« ï¼Œæ­¡è¿å¤§å®¶å…ˆè¡ŒæŸ¥çœ‹æ­ ğŸ˜†\nDevOps åœ–ç‰‡ (é†«é™¢ DevOps å¦‚ä½•è½åœ°(1) â”€ DevOps èˆ‡é†«é™¢)\næˆ‘å€‘å¹³å¸¸ç†ŸçŸ¥çš„ DevOps æ–‡åŒ–æ‡‰è©²æ˜¯åƒä¸Šé¢é€™å¼µåœ–ä¸€æ¨£ï¼Œå¯ä»¥é€éè‡ªå‹•åŒ–ã€Œè»Ÿé«”äº¤ä»˜ã€å’Œã€Œæ¶æ§‹è®Šæ›´ã€çš„æµç¨‹ï¼Œä¾†ä½¿å¾—æ§‹å»ºã€æ¸¬è©¦ã€ç™¼å¸ƒè»Ÿé«”èƒ½å¤ æ›´åŠ åœ°å¿«æ·ã€é »ç¹å’Œå¯é ã€‚\né€šå¸¸åœ¨ Development è·Ÿ Operations ä¹‹å¤–é‚„æœ‰ä¸€å€‹å°ˆé–€è² è²¬æª¢æŸ¥ç¨‹å¼æœ‰ç„¡æ¼æ´æˆ–æ˜¯å®‰å…¨æ€§å•é¡Œçš„å–®ä½ï¼Œé‚£æˆ‘å€‘è©¦æƒ³ä¸€ä¸‹ï¼Œå¦‚æœåœ¨ Dev æˆ–æ˜¯ Ops ä¸­é–“å…ˆåŠ ä¸Šäº†æª¢æŸ¥å®‰å…¨çš„æ­¥é©Ÿï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è®“æ•´é«”æµç¨‹æ•ˆç‡æ›´åŠ æå‡å‘¢ï¼ï¼Ÿ å¯ä»¥å…å»ç¨‹å¼å¯«å®Œæ‰ç™¼ç¾æœ‰å®‰å…¨æ€§å•é¡Œçš„æ¼æ´ï¼Œéœ€è¦é‡æ–°ä¿®æ”¹ï¼Œè€Œæ˜¯åœ¨éƒ¨ç½²å‰ï¼Œæˆ–æ˜¯ç¨‹å¼é–‹ç™¼ä¸­å°±å…ˆè¢«æª¢æŸ¥å‡ºä¾†ã€‚\nå°æ–¼è³‡è¨Šå®‰å…¨æ–¹é¢ï¼Œé–‹ç™¼äººå“¡é€²è¡Œé–‹ç™¼æ™‚ï¼Œå¿…é ˆé—œæ³¨ç›®å‰çš„å¯«æ³•æ˜¯ä¸æ˜¯å®‰å…¨çš„ï¼Œé™¤äº†é–‹ç™¼äººå“¡çš„ç¨‹å¼ç¢¼å¤–ï¼Œé‚„è¦æ³¨æ„ä½¿ç”¨çš„é–‹æºç¨‹å¼æˆ–æ˜¯å¥—ä»¶æ˜¯ä¸æ˜¯å·²ç¶“æœ‰è¢«æƒå‡ºæ¼æ´ï¼ŒåŠ ä¸Šç¾åœ¨è¶Šä¾†è¶Šå¤šäººä½¿ç”¨å®¹å™¨åŒ–ï¼Œå°æ–¼ Container Images è£¡é¢æ‰€åŒ…å«çš„å¥—ä»¶å®‰å…¨ä¹Ÿæ˜¯ä¸€å¤§å•é¡Œã€‚\næ‰€ä»¥å–®ç´”çš„è‡ªå‹•åŒ–æ•´åˆèˆ‡éƒ¨ç½²å·²ç¶“ä¸èƒ½æ»¿è¶³éœ€æ±‚ï¼Œå°±åƒä¸‹åœ–ä¸€æ¨£ï¼Œé–‹å§‹æœ‰äº† DevSecOps é€™å€‹è©ç”¢ç”Ÿï¼Œåœ¨ DevOps çš„ CI/CD æµç¨‹ä¸­åŠ å…¥è³‡å®‰è§£æ±ºæ–¹æ¡ˆï¼Œè—‰ç”±è³‡å®‰è§£æ±ºæ–¹æ¡ˆä¾†æ¸›å°‘é–‹ç™¼äººå“¡å»æª¢æŸ¥ç¨‹å¼æ¼æ´çš„æ™‚é–“ï¼Œä¹Ÿè®“ DevOps å¿«é€Ÿè¿­ä»£æ›´åŠ çš„å®Œæ•´ã€‚\nDevSecOps åœ–ç‰‡ (Apps Built Better: Why DevSecOps is Your Security Teamâ€™s Silver Bullet)","snyk#Snyk":"é‚£æˆ‘å€‘é€™æ¬¡è¦ä½¿ç”¨çš„å·¥å…·æ˜¯ - Snykï¼Œæˆ‘å…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹é€™å€‹å…¬å¸ä»¥åŠå·¥å…·ï¼Œå®ƒæ˜¯ä½æ–¼æ³¢å£«é “çš„ç¶²çµ¡å®‰å…¨å…¬å¸ï¼Œå°ˆé–€å¾äº‹é›²è¨ˆç®—ï¼Œæä¾›å¢è¼•é¬†é›†æˆï¼Œå¯ä»¥å°‡å®‰å…¨æƒæçµåˆåˆ° IDEã€Repositoryã€CI/CD ç­‰ï¼Œé€£çºŒæƒæä»¥åŠä¸€éµä¿®å¾©ç­‰åŠŸèƒ½ã€‚ä»–æœ¬èº«æ˜¯ä¸€å€‹ SaaS çš„æœå‹™ï¼Œæ‰€ä»¥éœ€è¦åˆ°å®˜ç¶²è¨»å†Šä¸€å€‹å¸³è™Ÿæ‰èƒ½ä½¿ç”¨ï¼Œä¹Ÿæ”¯æ´ä¸åŒçš„ SSO ç™»å…¥ï¼Œè©³ç´°å¯ä»¥åƒè€ƒè¨»å†Šç•«é¢ã€‚\né€™å€‹å·¥å…·ä¸»è¦æä¾›äº† 4 ç¨®æƒæçš„åŠŸèƒ½ï¼Œ åˆ†åˆ¥æ˜¯ï¼š\nCode Open Source Container IaC é‚£æˆ‘å€‘æœƒä¾ç…§é€™ï¼”ç¨®åŠŸèƒ½ä¾åºä»‹ç´¹ï¼Œè©³ç´°çš„å¯ä»¥åƒè€ƒ Snyk User Documentation # Explore Snyk productsã€‚\nCode èƒ½å¤ ç›´æ¥æƒæç›®å‰é–‹ç™¼ Project çš„ç¨‹å¼ç¢¼æœ‰æ²’æœ‰å®‰å…¨æ€§çš„å•é¡Œï¼Œå¯ä»¥å¤§å¹…æ¸›å°‘é–‹ç™¼äººå“¡å»æª¢æŸ¥ç¨‹å¼æ¼æ´çš„æ™‚é–“ï¼Œç›®å‰æ”¯æ´äº†ä»¥ä¸‹ä¸‰ç¨®æƒææ–¹å¼ï¼š\nIDE Plugins Web CLI IDE Plugins IDE æˆ‘å€‘é€™é‚Šä»¥ VS Code ç‚ºä¾‹ä¾†èªªæ˜ï¼Œå¦‚æœæœ‰åœ¨ç”¨ VS Code çš„å¤§å®¶æ‡‰è©²çŸ¥é“ VS Code æœ‰ä¸€å€‹ Marketplaceï¼Œå¯ä»¥å®‰è£å¾ˆå¤šä¸åŒçš„å¥—ä»¶ Pluginsï¼Œä¹‹å¾Œæœ‰æ™‚é–“ä¹Ÿæœƒå¯«ä¸€ç¯‡å¥½ç”¨çš„ Plugins æ–‡ç« ï¼Œå¤§å®¶å¯ä»¥åœ¨æŒçºŒé—œæ³¨æˆ‘æ­ ğŸ˜\né¦–å…ˆå…ˆé–‹å•Ÿå·¦å´çš„ Marketplaceï¼Œæœå°‹ Snykï¼Œé¸æ“‡ä¸‹è¼‰é‡æœ€é«˜çš„æº–æ²’éŒ¯ï¼Œé¸æ“‡ Snyk Security - Code and Open Source Dependenciesã€‚ VS Code Marketplace å®‰è£ Snyk\nå®‰è£å®Œå¾Œï¼Œåœ¨å·¦å´æ¬„ä½æ‡‰è©²å°±æœƒçœ‹åˆ° Snyk çš„ç‹—ç‹— Logoï¼Œå¦‚æœæ²’æœ‰ç™»å…¥éï¼Œæœƒå…ˆè¦æ±‚ä½ ç™»å…¥ Snyk ä¸¦æˆæ¬Šçµ¦ Plugins ä½¿ç”¨ã€‚æœ€å¾Œç•¶ä½ é–‹å•Ÿå°ˆæ¡ˆæ™‚ï¼Œæœƒé–‹å§‹æƒæç¨‹å¼ç¢¼ï¼Œä¸¦ä¸”æœƒä¾ç…§é–‹æºå¥—ä»¶å®‰å…¨æ€§ã€ç¨‹å¼ç¢¼å®‰å…¨æ€§ä¾†åˆ†é¡ï¼Œæœƒé¡¯ç¤ºå¥—ä»¶é‡åˆ°ä»€éº¼æ¼æ´éœ€è¦å‡ç´šä»¥åŠç¨‹å¼ç¢¼å“ªä¸€æ®µæœƒæœ‰å®‰å…¨æ€§çš„å•é¡Œï¼Œèƒ½å¤ è®“é–‹ç™¼äººå“¡åœ¨ç¬¬ä¸€æ™‚é–“å°±ä¿®å¾©å®‰å…¨å•é¡Œã€‚ IDE Plugins æƒæ\nWeb ç™»å…¥ Snyk ç¶²ç«™ï¼Œç›´æ¥åŠ å…¥å°æ‡‰çš„ Projectï¼Œæœƒç›´æ¥æ–¼ç¶²é ä¸Šæƒææ¼æ´ï¼Œä¸¦æç¤ºéŒ¯èª¤å…§å®¹ã€‚\né¸æ“‡åŠ å…¥ project\næƒææ¼æ´ä¸¦é¡¯ç¤ºéŒ¯èª¤å…§å®¹\nCLI è¦ä½¿ç”¨ CLI éœ€è¦å…ˆå®‰è£ Snyk CLIï¼Œæˆ‘å€‘ä¸€æ¨£ä½¿ç”¨ Homebrew ä¾†å®‰è£ï¼š\nbrew tap snyk/tap brew install snyk ç•¶ç„¶é™¤äº† Homebrew ä»¥å¤–é‚„æœ‰å…¶ä»–çš„å®‰è£æ–¹å¼ï¼Œä¾‹å¦‚ï¼šcurl ä¸‹è¼‰åŸ·è¡Œæª”ã€npmã€yarnã€docker åŸ·è¡Œç­‰ç­‰ï¼Œè©³ç´°å¯ä»¥åƒè€ƒä»¥ä¸‹å®‰è£é€£çµã€‚\nå¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ‰é€²è¡Œæ¸¬è©¦ sync testï¼Œé‚„æœ‰å…¶ä»– CLI æŒ‡ä»¤ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ Snyk CLIï¼š\nCLI æƒæ (å®˜ç¶²)\nOpen Source èƒ½å¤ æƒæç›®å‰é–‹ç™¼çš„ Project ä¸­æœ‰æ²’æœ‰ä½¿ç”¨åˆ°æœ‰æ¼æ´çš„ libraryï¼Œç›®å‰æ”¯æ´ä»¥ä¸‹åœ–ç‰‡èªè¨€ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ Open Source - Supported languages and package managersï¼š\nOpen Source library æƒæ (å®˜ç¶²)\nContainer åœ¨ Container image ä¸­æœƒå­˜æ”¾è‘—ä¸åŒçš„ base image ï¼Œåœ¨ base image ä¸­åˆæœƒä½¿ç”¨ä¸åŒçš„ libraryã€‚æ‰€ä»¥é€™äº› container çš„å®‰å…¨æ€§ä¹Ÿæ˜¯éœ€è¦è¢«é—œæ³¨çš„ã€‚\nå¯ä»¥ç›´æ¥ä½¿ç”¨ web ä¾†é¸æ“‡ç›¸å°çš„ Container å€‰åº«å»åšæƒæï¼Œå¦‚æœæœ‰å®‰è£ä¸Šé¢èªªçš„ Snyk CLIï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è©²æŒ‡ä»¤åŸ·è¡Œ snyk container test \u003ccontainer image\u003e\nContainer æƒæ\nIac Snyk çš„åŸºç¤è¨­æ–½å³ä»£ç¢¼ (IaC) å¯å¹«åŠ©é–‹ç™¼äººå“¡ç·¨å¯«å®‰å…¨çš„åŸºç¤è¨­æ–½é…ç½®ï¼Œé é˜²éŒ¯èª¤çš„è¨­å®šç”¢ç”Ÿï¼Œä¸¦ä¸”æ”¯æ´å¤šç¨®æ ¼å¼ï¼š\nK8s YAML HashiCorp Terraform AWS CloudFormation Azure Resource Manager (ARM) ","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"DevOpsDays Taipei 2022 å…±åŒç­†è¨˜ - åœ¨ä½ çš„ DevOps ä¸­åŠ å…¥ä¸€é» Security â€” GitLab CI/CD with Snyk - é„­èƒæ¨º (Barry.Cheng) ï¼šhttps://hackmd.io/@DevOpsDay/2022/%2F%40DevOpsDay%2FHkm1iY6xi\nèº«ç‚º DevOps å·¥ç¨‹å¸«ï¼Œä½¿ç”¨ Snyk æƒææ¼æ´ä¹Ÿæ˜¯å¾ˆæ­£å¸¸çš„ï¼šhttps://barry-cheng.medium.com/%E8%BA%AB%E7%82%BAdevops%E5%B7%A5%E7%A8%8B%E5%B8%AB-%E4%BD%BF%E7%94%A8snyk%E6%8E%83%E6%8F%8F%E6%BC%8F%E6%B4%9E%E4%B9%9F%E6%98%AF%E5%BE%88%E6%AD%A3%E5%B8%B8%E7%9A%84-d7d8f2ad2304\nåœ¨ä½ çš„ DevOps ä¸­åŠ å…¥ä¸€é» Security â€” GitLab CI/CD with Snyk (è¬›å¸«ç°¡å ±)ï¼šhttps://s.itho.me/ccms_slides/2022/9/26/3a2ac1ef-4143-4328-9fef-066782ac7dc6.pdf"},"title":"æ‰¾å‡ºç¨‹å¼ç¢¼ã€é–‹æºå¥—ä»¶ã€å®¹å™¨çš„å®‰å…¨æ¼æ´å·¥å…· - Snyk"},"/blog/rd/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« RD ä½¿ç”¨çš„ç›¸é—œå·¥å…·æ–‡ç« ã€‚\nFluentd-Server å‡ºç¾ Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch éŒ¯èª¤è§£æ±º Kibana æ–°å¢ index ç´¢å¼•æ™‚ä¸€ç›´è½‰åœˆåœˆä»¥åŠé¡¯ç¤º HTTP 403 Forbidden å¦‚ä½•å•Ÿç”¨ GitLab çš„ Package Registry ä»¥åŠå°‡å„²å­˜ä½ç½®å¾ä¼ºæœå™¨æ”¹åˆ° GCS ä¸Š "},"title":"RD ä½¿ç”¨çš„ç›¸é—œå·¥å…·"},"/blog/rd/fluentd-server-show-fluent-plugin-elasticsearch-error400/":{"data":{"":"å…ˆèªªçµè«– â€¦ EFK çœŸçš„å¥½å¤šé›· ğŸ˜† æˆ‘å€‘ä»Šå¤©åˆå†åº¦è¸©é›·æ‹‰ï¼Œé€™æ¬¡åˆæ˜¯ç‚¸çš„åˆ†èº«ç¢éª¨ï¼ŒèŠ±äº† 4 å€‹å¤šå°æ™‚æ‰æ‰¾åˆ°åŸå› ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å°å¼Ÿæˆ‘è·Ÿ EFK ä¸æ˜¯å¾ˆç†Ÿ XDã€‚å°±å¦‚æ¨™é¡Œæ‰€èªªï¼Œæˆ‘åœ¨æŠ½ Log çš„æ™‚å€™ç™¼ç¾æœ‰éƒ¨åˆ†çš„ Log é€ä¸åˆ° Kibanaï¼Œæª¢æŸ¥ Fluentd-Server çš„ Log ç™¼ç¾è£¡é¢æœ‰ Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch çš„éŒ¯èª¤è¨Šæ¯ï¼Œåˆ°åº•é€™å€‹ Error 400 æ˜¯ä»€éº¼å’§ï¼Œå°±è·Ÿè‘—æˆ‘ä¸€èµ·é‡æº«æ‰¾å•é¡Œçš„è‹¦é›£å§ XD","efk-çµæ§‹#EFK çµæ§‹":"åœ¨é–‹å§‹ä¹‹å‰æˆ‘å…ˆç°¡å–®èªªä¸€ä¸‹æˆ‘ç¾åœ¨çš„ EFK çµæ§‹ï¼š\nEFK çµæ§‹\nç¾åœ¨çš„ EFK çµæ§‹å¦‚ä¸Šåœ–ï¼Œæˆ‘åœ¨è¦æŠ½ Log çš„ Pod ä¸­å¤šå¡ä¸€å€‹ fluentd-bit containerï¼Œå°‡ fluentd-bit èˆ‡æœå‹™(ä¾‹å¦‚ nginx) çš„ log æ›ç›¸åŒè·¯å¾‘ï¼Œè®“ fluentd-bit å¯ä»¥æŠ½åˆ°æœå‹™ logï¼Œæ¥è‘—å°±é€é fluentd-server-svc æ‰“åˆ° fluentd-server podï¼Œå¾Œé¢å°±æ˜¯å¸¸è¦‹çš„ EFK çµæ§‹ï¼Œå°±ä¸å¤šåšèªªæ˜ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Elasticsearch 400 error #467ï¼šhttps://github.com/uken/fluent-plugin-elasticsearch/issues/467","å•é¡Œçš„å‡ºç¾#å•é¡Œçš„å‡ºç¾":"æˆ‘å€‘å°±åƒå¹³å¸¸ä¸€æ¨£å¯«å¥½æ•´å€‹ EFK çš„ yamlï¼Œrun çš„æ™‚å€™ä¹Ÿæ­£å¸¸ï¼Œå¯ä»¥æ”¶åˆ° logï¼Œä½†å¾ˆå¥‡æ€ªçš„æ˜¯æˆ‘å€‘å…ˆé€ log_false çš„ log å¯ä»¥æ­£å¸¸æ”¶åˆ°ï¼Œä½†å†æ¥è‘—é€ log_true å°±æ”¶ä¸åˆ°ï¼Œæˆ‘å€‘ä¹Ÿå˜—è©¦åéä¾†é€ï¼Œå…ˆé€ log_trueï¼Œå†é€ log_falseï¼Œç™¼ç¾æ›æ”¶ä¸åˆ° log_false çš„ log\nlog_false { \"result\": false, \"message\": \"æˆ‘æ˜¯é¦¬è³½å…‹\", \"code\": 11223344, \"data\": { \"end_at\": \"2022-12-19 04:09:00\" }, \"response_code\": \"326dgf241geh1596489\", \"job_name\": \"å®å®å™¹å™¹è–èª•ç¯€\", \"method\": \"GET\", \"url\": \"url.com\" } log_true { \"result\": true, \"data\": true, \"response_code\": \"wkCJl1dfr45671607965\" } æ¥è‘—åœ¨ Fluentd-Server Log ä¸­ç™¼ç¾ Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch éŒ¯èª¤\nfluentd-server è·³å‡ºéŒ¯èª¤ LOG\næˆ‘åˆ°ç¶²è·¯ä¸Šæœå°‹ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰äººæœ‰é‡åˆ°è·Ÿæˆ‘ä¸€æ¨£çš„å•é¡Œï¼Œç™¼ç¾åœ¨ uken/fluent-plugin-elasticsearch ä¹Ÿæœ‰å…¶ä»–äººæœ‰é‡åˆ°åŒæ¨£çš„å•é¡Œ\nuken/fluent-plugin-elasticsearch issus è©¢å•\næœ‰äººèªªå¯èƒ½æ˜¯ Elasticsearch çš„ disk æ»¿äº†ï¼Œä¹Ÿæœ‰äººèªªæ˜¯è£åœ¨ Fluentd-Server çš„å¥—ä»¶ fluent-plugin-elasticsearch ç‰ˆæœ¬æœ‰å•é¡Œï¼Œæˆ–æ˜¯å°‡ Elasticsearch è·Ÿ Kibana index åˆªé™¤å°±å¯ä»¥ï¼Œæˆ‘æœ‰ç æ‰ index å†é‡æ–°å€’å…¥ Logï¼Œé‚„æ˜¯æœƒæœ‰å•é¡Œã€‚\nä¸€é–‹å§‹ä»¥ç‚ºæ˜¯ log_false è·Ÿ log_true çš„æ¬„ä½ä¸åŒï¼Œæ‰€ä»¥æ‰æœƒæœ‰é€™å€‹å•é¡Œç™¼ç”Ÿï¼ˆä½ çœ‹å°±çŸ¥é“æˆ‘è·Ÿ EFK ä¸ç†Ÿå§ï¼¸ï¼¤ï¼‰ï¼Œæ‰€ä»¥æœ‰å¦å¤–å€’ä¸€äº›å…¶ä»–æœå‹™(æ¬„ä½ä¹Ÿä¸åŒ)çš„ log é€²å»æ¸¬è©¦ï¼Œç™¼ç¾æ˜¯å¯ä»¥æ­£å¸¸æŠ½åˆ°ï¼Œä¸” kibana é‚£é‚Šæœƒä¾ç…§ es æä¾›çš„æ¬„ä½è‡ªå‹•æ–°å¢ï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯æ¬„ä½çš„å•é¡Œï¼Œé‚£æœ€å¾Œçš„å•é¡Œæ˜¯ä»€éº¼å‘¢ï¼Ÿ","å¦‚ä½•è§£æ±ºå•é¡Œ#å¦‚ä½•è§£æ±ºå•é¡Œ":"æœ€å¾Œåœ¨æˆ‘å€‘ä»”ç´°æª¢æŸ¥å¾Œç™¼ç¾ï¼Œlog_false è·Ÿ log_true çš„æ¬„ä½å…¶ä¸­ä¸€æ¨£å­˜çš„è³‡æ–™å‹æ…‹ä¸å¤ªä¸€æ¨£ï¼Œç™¼ç¾å…¶ä¸­çš„ data æ¬„ä½åœ¨ log_false çš„è³‡æ–™å‹æ…‹æ˜¯ arrayï¼Œåœ¨ log_true å­˜çš„æ™‚å€™æ˜¯å­—ä¸²ï¼Œæ‰€ä»¥å°è‡´ç•¶å…¶ä¸­ä¸€å€‹ log å¯«å…¥å¾Œï¼Œå¦ä¸€å€‹ log å°±æœƒå› ç‚ºåŒæ¬„ä½çš„è³‡æ–™å‹æ…‹æœ‰æ‰€ä¸åŒï¼Œè€Œç„¡æ³•å¯«å…¥ logï¼Œä¸”åœ¨ Fluentd-Server æœƒå‡ºç¾æ¨™é¡Œçš„ Error 400 åŸå› æ‹‰ï½\næœ€å¾Œé‡æ–°èª¿æ•´æ¬„ä½çš„è³‡æ–™å‹æ…‹ï¼Œå°±é †åˆ©è§£æ±ºæ­¤æ¬¡å•é¡Œ âœŒï¸âœŒï¸âœŒï¸"},"title":"Fluentd-Server å‡ºç¾ Fluent::Plugin::Elasticsearch Error 400 - Rejected by Elasticsearch éŒ¯èª¤è§£æ±º"},"/blog/rd/gitlab-package-registry-to-gcs/":{"data":{"":"ä»Šå¤©æ¥åˆ°ä¸€å€‹æ¡ˆå­ï¼ŒRD éƒ¨é–€ä¹‹å¾Œæƒ³è¦ä½¿ç”¨ GitLab çš„ Package Registry åŠŸèƒ½ä¾†ç™¼å¸ƒå¥—ä»¶ï¼Œä¸”ä¸æƒ³æŠŠå®ƒå­˜åœ¨ GitLab ä¼ºæœå™¨ä¸Šï¼Œå¸Œæœ›å¯ä»¥ç›´æ¥å­˜åˆ° GCP çš„ Google Cloud Storage ä¸Šï¼Œæ‰€ä»¥æ‰æœƒæœ‰äº†æ­¤ç¯‡ç­†è¨˜ä¾†è¨˜éŒ„ä¸€ä¸‹æ•´å€‹éç¨‹ã€‚\nç‰ˆæœ¬è³‡è¨Š\nGitLab 14.10 (æœ‰éƒ¨åˆ†è¨­å®šæœƒæ–¼æ–°ç‰ˆæœ¬æ£„ç”¨ï¼Œè«‹è¨˜å¾—ç¢ºèªå¥½è‡ªå·±çš„ç‰ˆæœ¬æ˜¯å¦æ”¯æ´) å…ˆèªªä¸€ä¸‹ï¼Œæˆ‘å€‘çš„ GitLab æ˜¯ä½¿ç”¨ docker-compose ä¾†å»ºç½®ï¼Œæ‰€ä»¥å¾ŒçºŒçš„å¯¦ä½œå…§å®¹éƒ½æœƒä»¥ docker-compose çš„æ–¹å¼ä¾†ä»‹ç´¹ã€‚","å…ˆæŸ¥çœ‹å°šæœªé‡å•Ÿçš„-gitlab-package#å…ˆæŸ¥çœ‹å°šæœªé‡å•Ÿçš„ GitLab Package":"ç”±æ–¼å…¬å¸ GitLab é è¨­æœ‰å…ˆé–‹å•Ÿ packages_enabledï¼Œæ‰€ä»¥æˆ‘å°±æ‹¿åŒäº‹ç”¨ Helm å¯«çš„ CIï¼Œä¾†åšæ¸¬è©¦ã€‚ç•¶æ›´æ–° value.yaml å¾Œæœƒè‡ªå‹•æ‰“åŒ… Package æ”¾åˆ° Package Registry ä¸­ï¼Œæˆ‘å€‘ç›´æ¥é€²å…¥åˆ°é è¨­ Package Registry çš„å„²å­˜ä½ç½®ï¼Œæ˜¯åœ¨ /var/opt/gitlab/gitlab-rails/shared/packages/ï¼Œç”¨æŒ‡ä»¤ç™¼ç¾æ‰“åŒ…çš„ Package çš„ç¢ºå­˜æ”¾æ–¼æ­¤ ï¼Œå¦‚ä¸‹ï¼š\næª¢æŸ¥æ˜¯å¦é‚„æœ‰ Package åœ¨é è¨­å„²å­˜ä½ç½® (å°šæœªé·ç§»)","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"GitLab Package Registry administrationï¼šhttps://docs.gitlab.com/14.10/ee/administration/packages/","å•Ÿå‹•-gitlab-çš„-package-registry#å•Ÿå‹• GitLab çš„ Package Registry":"é¦–å…ˆï¼Œæˆ‘å€‘ç•¶ç„¶è¦å…ˆå•Ÿå‹•é€™é … Package Registry åŠŸèƒ½ï¼Œæ‰å¯ä»¥å†ä¹‹å¾Œä½¿ç”¨å®ƒï¼Œæˆ‘å€‘å…ˆçœ‹ä¸€ä¸‹ GitLab å•Ÿå‹•çš„ docker-compose.yml æª”æ¡ˆï¼š\nversion: '3' services: gitlab: image: 'gitlab/gitlab-ee:14.10.5-ee.0' restart: always container_name: gitlab hostname: gitlab-pid logging: driver: \"json-file\" options: max-size: \"100m\" max-file: \"50\" environment: GITLAB_OMNIBUS_CONFIG: | external_url '${GITLAB_DOMAIN}' letsencrypt['enable'] = false gitlab_rails['initial_root_password'] = '${GITLAB_ROOT_PASSWORD}' gitlab_rails['gitlab_shell_ssh_port'] = '${GITLAB_HOST_SSH_PORT}' gitlab_rails['backup_keep_time'] = 79200 gitlab_rails['omniauth_allow_single_sign_on'] = ['google_oauth2'] gitlab_rails['omniauth_block_auto_created_users'] = false gitlab_rails['omniauth_sync_profile_from_provider'] = ['google_oauth2'] gitlab_rails['omniauth_sync_profile_attributes'] = ['name', 'email'] gitlab_rails['omniauth_providers'] = [ { ç•¥éï¼ï¼ï¼ } ] ports: - '${GITLAB_HOST_SSH_PORT}:22' - '${GITLAB_HOST_HTTP_PORT}:80' - '${GITLAB_HOST_HTTPS_PORT}:443' volumes: - './config:/etc/gitlab' - './logs:/var/log/gitlab' - './data:/var/opt/gitlab' æœ‰äº›è¨­å®šæœ‰ç•¥éæˆ–æ˜¯çœç•¥ä¸å¯«ï¼Œå¤§å®¶å°±ä¾ç…§è‡ªå·±çš„è¨­å®šä¾†çœ‹å°±å¥½ï½","æ–°å¢-package-registry-è¨­å®š#æ–°å¢ Package Registry è¨­å®š":"æˆ‘å€‘åœ¨ä¸Šæ–¹çš„ gitlab_rails['omniauth_providers'] = [ ... ç•¥ ... ] ä¹‹å¾ŒåŠ ä¸Šæ–°å¢ Package Registry è¨­å®šå…§å®¹ï¼š\ngitlab_rails['packages_enabled'] = true gitlab_rails['packages_object_store_enabled'] = true gitlab_rails['packages_object_store_remote_directory'] = \"GCS åç¨±\" gitlab_rails['packages_object_store_direct_upload'] = true gitlab_rails['packages_object_store_background_upload'] = true gitlab_rails['packages_object_store_proxy_download'] = true gitlab_rails['packages_object_store_connection'] = { 'provider' =\u003e 'Google', 'google_project' =\u003e 'å°ˆæ¡ˆ ID', 'google_json_key_location' =\u003e '/etc/gitlab/google_key.json' } packages_enabledï¼šå•Ÿå‹• packages packages_object_store_enabledï¼šå•Ÿå‹• packages å°è±¡å­˜å„² packages_object_store_remote_directoryï¼šè¨­å®š packages å°è±¡å­˜å„²ä½ç½®ï¼Œé€™é‚Šè¦è¼¸å…¥ GCS çš„åç¨± packages_object_store_direct_uploadï¼šè¨­å®šæ˜¯å¦å¯ä»¥ç›´æ¥ä¸Šå‚³åˆ°å°è±¡å­˜å„²ä½ç½® packages_object_store_background_uploadï¼šè¨­å®šæ˜¯å¦ä»¥å¾Œå°æ–¹å¼ä¸Šå‚³åˆ°å°è±¡å­˜å„²ä½ç½® packages_object_store_proxy_downloadï¼šè¨­å®šæ˜¯å¦å¯ä»¥é€éä»£ç†ä¼ºæœå™¨é€²è¡Œå¥—ä»¶ä¸‹è¼‰ packages_object_store_connectionï¼šè¨­å®šé€£æ¥åˆ°å°è±¡å­˜å„²ï¼Œç”±æ–¼æˆ‘å€‘è¦å­˜åˆ° GCS ä¸Šé¢ï¼Œéœ€è¦æœ‰é€™ä¸‰é … providerã€google_projectã€google_json_key_location æ‰å¯ä»¥å°‡ packages å­˜åˆ° GCS ä¸Šã€‚å¦‚æœæƒ³ç”¨å…¶ä»–çš„å„²å­˜ä½ç½®ï¼Œä¾‹å¦‚ Amazon S3ã€Azure Blob storage å¯ä»¥åƒè€ƒ Object storage è©³ç´°è¨­å®š ( å…¶ä¸­çš„ google_json_key_location æ˜¯è¦æ”¾å¯ä»¥è®€å¯« GCS çš„ SA SECRET æª”æ¡ˆ ) ","é‡å•Ÿè¨­å®šå¾Œå†æ¬¡æª¢æŸ¥-gitlab-package#é‡å•Ÿè¨­å®šå¾Œå†æ¬¡æª¢æŸ¥ GitLab Package":"ç•¶æˆ‘å€‘é‡å•Ÿè¨­å®šå¾Œï¼Œä¹Ÿæœ‰å»ºç«‹å¥½å¯ä¾›æˆ‘å€‘æ¬Šé™ SA çš„ GCS å¾Œï¼Œæœƒç™¼ç¾åŸæœ¬å­˜åœ¨é è¨­ /var/opt/gitlab/gitlab-rails/shared/packages/ æ²’æœ‰è‡ªå‹•è·‘åˆ° GCS ä¸Šï¼Œæ˜¯å› ç‚ºæˆ‘å€‘é‚„éœ€è¦æ‰‹å‹•ä¸‹æŒ‡ä»¤å°‡ä»–é·ç§»éå»ï¼ŒæŒ‡ä»¤æ˜¯ gitlab-rake \"gitlab:packages:migrate\"ï¼Œæœ€å¾Œç­‰ä»–è·‘å®Œæˆ‘å€‘åœ¨æª¢æŸ¥ä¸€ä¸‹é è¨­å„²å­˜ä½ç½®å°±ç™¼ç¾å·²ç¶“æ²’æœ‰ Package äº†\næª¢æŸ¥æ˜¯å¦é‚„æœ‰ Package åœ¨é è¨­å„²å­˜ä½ç½® (å·²é·ç§»)\né–‹ GCS ç¶²ç«™ä¾†çœ‹æœƒç™¼ç¾åŸå…ˆåœ¨é è¨­å„²å­˜ä½ç½®çš„ Package éƒ½å¯ä»¥è·‘åˆ° GCS ä¸Šï¼š\næŸ¥çœ‹å·²é·ç§»åˆ° Google Cloud Storage çš„ Package"},"title":"å¦‚ä½•å•Ÿç”¨ GitLab çš„ Package Registry ä»¥åŠå°‡å„²å­˜ä½ç½®å¾ä¼ºæœå™¨æ”¹åˆ° GCS ä¸Š"},"/blog/rd/kibana-create-index-forbidden/":{"data":{"":"å‰å¹¾å¤©åœ¨å·¥ä½œä½¿ç”¨ Kibana æ™‚ï¼Œæƒ³è¦æ–°å¢ä¸€å€‹æ–°çš„ç´¢å¼•ï¼Œç™¼ç¾é¸æ“‡ç´¢å¼•ä¸¦æŒ‰ä¸‹æ–°å¢çš„æŒ‰éˆ•ï¼Œæœƒä¸€ç›´è½‰åœˆåœˆï¼Œç­‰äº†ä¸€é™£å­ï¼Œä½¿ç”¨é–‹ç™¼å·¥å…· F12 æŸ¥çœ‹ï¼Œè·³å‡ºäº† HTTP 403 Forbiddenï¼Œåˆ°åº•æ˜¯ä»€éº¼åŸå› å°è‡´çš„å‘¢ï¼ï¼Ÿæˆ‘å€‘ä¸€èµ·çœ‹ä¸‹å»å§ï¼Œæœƒå¾å•é¡Œçš„å‡ºç¾åˆ°å•é¡ŒåŸå› å†åˆ°å¦‚ä½•è§£æ±ºå•é¡Œï¼Œä¾†ä»”ç´°ä»‹ç´¹ï¼Œå¸Œæœ›å¤§å®¶ä¸è¦åƒæˆ‘ä¸€æ¨£è¸©åˆ°é›· ğŸ¤£","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Kibana åˆ›å»ºç´¢å¼• POST 403 (forbidden) on create indexï¼šhttps://www.cnblogs.com/caoweixiong/p/10972120.html","å•é¡ŒåŸå› #å•é¡ŒåŸå› ":"æ–‡ç« çš„èªªæ˜æ˜¯ç´¢å¼•è®Šæˆåªå…è¨±è®€å–çš„ç‹€æ…‹ï¼Œå…¶åŸå› æ˜¯å› ç‚ºå‡ºç¾é€™å€‹ HTTP 403 Forbidden å‰ï¼ŒElasticSearch çš„ç©ºé–“æ»¿äº†ï¼Œå°è‡´ Kibana æœƒè‡ªå‹•çš„å°‡ç´¢å¼•æ”¹æˆåªå…è¨±è®€å–çš„ç‹€æ…‹ï¼Œæˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹å‰›å‰›çš„ Index ç‹€æ…‹æ˜¯ä¸æ˜¯åƒä»–èªªçš„ä¸€æ¨£è®Šæˆåªå…è¨±è®€å–çš„ç‹€æ…‹å‘¢\nå¯ä»¥åˆ° kibana çš„ Dev Tools ä¸‹æŒ‡ä»¤ä¾†æŸ¥è©¢æ­ï¼Œè¼¸å…¥ GET _settingsï¼Œå°±æœƒé¡¯ç¤ºä»¥ä¸‹åœ–ç‰‡çš„å…§å®¹å›‰ ç´¢å¼•åªå…è¨±è®€å–çš„è¨­å®šè®Šæˆ\nç™¼ç¾æ­£å¦‚æ–‡ç« æ‰€èªªï¼Œæ˜¯å› ç‚º read_only_allow_delete çš„ç‹€æ…‹è®Šæˆäº† trueï¼Œæ‰€ä»¥æ‰æ²’è¾¦æ³•æ–°å¢ç´¢å¼•ï½","å•é¡Œçš„å‡ºç¾#å•é¡Œçš„å‡ºç¾":"é‚£å¤©æ˜¯å€‹è®Šå†·çš„ 12 æœˆï¼Œè¦å¹« RD åŒä»æ–°å¢ Kibana çš„ç´¢å¼•æ™‚ï¼Œç…§å¾€å¸¸ä¸€æ¨£è¼¸å…¥ Index patternï¼ŒæŒ‰ä¸‹ä¸€æ­¥ï¼Œé¸æ“‡ Configure settings ï¼š\nè¼¸å…¥ Index pattern (åœ–ç‰‡ç‚ºç¯„ä¾‹ï¼Œæ­£å¸¸éƒ½æ˜¯ç”¨ -* )\næŒ‰ä¸‹æ–°å¢ç´¢å¼•ï¼Œä»–å°±é–‹å§‹ç„¡é™çš„è½‰åœˆåœˆï¼Œæœ‰å»æŸ¥çœ‹ ElasticSearch çš„ logï¼Œç™¼ç¾ä¹Ÿæ²’æœ‰ç‰¹åˆ¥çš„éŒ¯èª¤è¨Šæ¯\næ–°å¢ç´¢å¼•å¾Œï¼Œä¸€ç›´è½‰åœˆåœˆ\næ¥è‘—æƒ³èªªæ‰“é–‹é–‹ç™¼è€…å·¥å…· F12 ä¾†çœ‹çœ‹ï¼Œæ˜¯å¡åœ¨å“ªä¸€å€‹é»ï¼Œå»ç™¼ç¾æœ‰å¹¾å€‹ç´…å­—å¯«è‘— HTTP 403 Forbidden\né–‹ç™¼è€…å·¥å…·ç¶²é å…§å®¹é¡¯ç¤º HTTP 403 Forbidden\næƒ³èªªç‚ºä»€éº¼æœƒæœ‰ HTTP 403 Forbiddenï¼Œä¹‹å‰ä¹Ÿæ²’æœ‰çœ‹éé¡ä¼¼çš„éŒ¯èª¤è¨Šæ¯ï¼Œæ–¼æ˜¯å°±é–‹å§‹åœ¨ç¶²è·¯ä¸Šäº‚æ™ƒï¼Œæœ€å¾Œåœ¨åŒäº‹çš„å¹«åŠ©ä¸‹æ‰¾åˆ°äº†ä¸€å€‹è·Ÿæˆ‘å€‘æƒ…æ³å¾ˆç›¸ä¼¼çš„æ–‡ç«  Kibana åˆ›å»ºç´¢å¼• POST 403 (forbidden) on create index","å¦‚ä½•è§£æ±ºå•é¡Œ#å¦‚ä½•è§£æ±ºå•é¡Œ":"æˆ‘å€‘æŸ¥çœ‹æ–‡ç« çš„è§£æ±ºè¾¦æ³•ï¼Œæœ‰å…©ç¨®è¾¦æ³•ï¼Œä¸€å€‹æ˜¯æ“´å¤§ ElasticSearch çš„ç©ºé–“ï¼Œä»¥åŠä½¿ç”¨ kibana çš„ Dev Tools ä¸‹æŒ‡ä»¤ä¿®æ”¹ï¼Œé‚£æˆ‘å€‘å…©ç¨®éƒ½æœ‰åšï¼Œé€™é‚Šå°±ç›´æ¥ä»‹ç´¹ä¸‹æŒ‡ä»¤éœ€è¦è¼¸å…¥ä»€éº¼ï½\néœ€è¦å† Dev Tools è¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼Œä¾†ä¿®æ”¹ Index çš„ç‹€æ…‹ï¼š\nPUT _settings { \"index\": { \"blocks\": { \"read_only_allow_delete\": \"false\" } } } Dev Tools ä¿®æ”¹ Index çš„ç‹€æ…‹\næœ€å¾Œæˆ‘å€‘ç”¨ GET _settings æª¢æŸ¥ä¸€ä¸‹ç´¢å¼•ç‹€æ…‹æ˜¯ä¸æ˜¯å·²ç¶“è®Šå›åŸæœ¬çš„äº†ï¼š\nç´¢å¼•åªå…è¨±è®€å–çš„è¨­å®šè®Šæˆ false\næœ€å¾Œå°±å¯ä»¥é †åˆ©æ–°å¢ç´¢å¼•æ‹‰ ğŸ‘ğŸ‘ğŸ‘\né †åˆ©æ–°å¢ç´¢å¼•"},"title":"Kibana æ–°å¢ index ç´¢å¼•æ™‚ä¸€ç›´è½‰åœˆåœˆä»¥åŠé¡¯ç¤º HTTP 403 Forbidden"},"/blog/terraform/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Terraform ç›¸é—œçš„æ–‡ç« ã€‚\nä»€éº¼æ˜¯ IaC ? Terraform åˆæ˜¯ä»€éº¼ï¼Ÿ ä½¿ç”¨ Terraform å»ºç«‹ Google Compute Engine ä½¿ç”¨ Terraform å»ºç«‹ Google Kubernetes Engine Terraform å¦‚ä½•å¤šäººå…±åŒé–‹ç™¼ (å°‡ tfstate å­˜åœ¨å¾Œç«¯) å¦‚ä½•å°‡ Terraform æ”¹å¯«æˆ module ? å¦‚ä½•å°å…¥ Terragruntï¼ŒTerragrunt å¥½è™•æ˜¯ä»€éº¼ï¼Ÿ "},"title":"Terraform"},"/blog/terraform/terraform-gce/":{"data":{"":"å—¨å—¨å¤§å®¶å¥½ï¼Œè·é›¢ä¸Šä¸€ç¯‡ç­†è¨˜åˆéš”äº† 3 å€‹æœˆï¼Œæœ€è¿‘å…¬å¸æœ‰å°ˆæ¡ˆåœ¨å¿™ï¼Œæ²’æ™‚é–“æŠŠä¸Šæ¬¡æåˆ°çš„ Terraform æ‡‰ç”¨ç­†è¨˜å¯«å®Œï¼Œç¾åœ¨ä»–ä¾†æ‹‰ï½ï½ï½ ğŸ˜‚ æˆ‘å€‘é€™æ¬¡çš„ä¸»é¡Œæ˜¯ä½¿ç”¨ Terraform ä¾†å»ºç«‹ Google Compute Engine çš„æ©Ÿå™¨ï¼Œæƒ³çŸ¥é“è¦æ€éº¼ç”¨ä¸€æ®µç¨‹å¼ç¢¼å°±å¯ä»¥å»ºç«‹ã€ä¿®æ”¹ã€åˆªé™¤ Google Compute Engine çš„æ©Ÿå™¨ä¸€å®šè¦ä¾†çœ‹é€™ä¸€ç¯‡ï½æˆ‘å€‘é–‹å§‹å›‰ ğŸ§‘â€ğŸ’»","ä¿®æ”¹-google-compute-engine#ä¿®æ”¹ Google Compute Engine":"ç•¶æˆ‘å€‘ç™¼ç¾æˆ‘å€‘å»ºç«‹çš„ Google Compute Engine åƒæ•¸æœ‰éŒ¯ï¼Œæƒ³è¦ä¿®æ”¹æ™‚ï¼Œæˆ‘å€‘åªéœ€è¦ä¿®æ”¹ç¨‹å¼ç¢¼éƒ¨åˆ†ï¼Œä¸¦é‡æ–°ä¸‹ä¸€æ¬¡ terraform apply ä¾†ä¿®æ”¹ Google Compute Engineï¼Œå°±æœƒçœ‹åˆ°ä»¥ä¸‹ç•«é¢ (æœ‰äº›è¨­å®šæª”æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œè‹¥ä¿®æ”¹ä»–æœƒé‡æ–°å‰µå»ºä¸€å€‹æ–°çš„æ©Ÿå™¨ï¼Œåƒæ˜¯ name ä¹‹é¡çš„ï¼Œä½¿ç”¨æ™‚è¦å°å¿ƒä¸€é» ğŸ˜‰)\næˆ‘å€‘æ‹¿å‰›å‰›æåˆ°çš„ nat_ipï¼Œæˆ‘å€‘å…ˆæŠŠå®ƒè¨»è§£æ‰ï¼Œå†ä¸‹ terraform apply çœ‹çœ‹æ©Ÿå™¨æœ‰ä»€éº¼è®ŠåŒ–ï½\nterraform changed\nå¯ä»¥çœ‹åˆ°ä»–æœƒæç¤ºèªªï¼Œä»–æœƒæ”¹è®Š network_interfaceï¼Œä¹Ÿç§»é™¤ access_config çš„è¨­å®šï¼ŒåŸ·è¡Œå¾Œçš„ Resources ä¹Ÿæœƒå¾å‰›å‰›çš„ added è®Šæˆ changedï¼Œæˆ‘å€‘çœ‹ä¸€ä¸‹ GCP æœ‰æ²’æœ‰æ”¹è®Šï¼š\nterraform changed\nå¯ä»¥çœ‹åˆ°åŸæœ¬çš„å¤–éƒ¨ IP ä½ç½®è¢«æ”¹æ‰äº†ï½ æœ€å¾Œæé†’ï¼šå¦‚æœæœ‰ä½¿ç”¨ terraform ä¾†ä¿®æ”¹è³‡æºè¨­å®šï¼Œä¸èƒ½å‹•åˆ°ç‰¹å®šçš„é …ç›®ï¼Œä¸ç„¶ä»–çš„æµç¨‹æ˜¯å…ˆæŠŠåŸæœ¬çš„çµ¦åˆªæ‰ï¼Œå†é‡æ–°å»ºç«‹ä¸€å€‹æ–°çš„ï¼ŒåŸæœ¬çš„æ©Ÿå™¨æ²’æœ‰å‚™ä»½ï¼Œæ±è¥¿å°±æœƒä¸è¦‹æ­ï½","åˆªé™¤-google-compute-engine#åˆªé™¤ Google Compute Engine":"æœ€å¾Œå‡å¦‚æˆ‘å€‘è¦åˆªé™¤ Google Compute Engineï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ terraform çš„æŒ‡ä»¤ä¾†åˆªé™¤ï¼Œæˆ‘å€‘é †ä¾¿ä¾†æ¸¬è©¦ä¸€ä¸‹ä¸Šé¢æœ‰è¨­å®šçš„ deletion_protection åˆªé™¤ä¿è­·æ©Ÿåˆ¶æ˜¯ä¸æ˜¯æ­£å¸¸ï½\nç›®å‰ deletion_protection é‚„æ˜¯ trueï¼Œæˆ‘å€‘ç›´æ¥ä¸‹ terraform destroyï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥åˆªé™¤ Google Compute Engine\nterraform destroy\nå¯ä»¥çœ‹åˆ°ä»–æœƒæé†’ä½ èªª Deletion Protection is enabledï¼Œå¿…é ˆå…ˆæŠŠä»–æ”¹æˆ false terraform apply å¾Œæ‰å¯ä»¥åˆªé™¤ï½\næ”¹æˆ false åœ¨ä¸‹ terraform apply\nç¾åœ¨ deletion_protection æ˜¯ falseï¼Œæˆ‘å€‘å°±å¯ä»¥ä¸‹ terraform destroy ä¾†åˆªé™¤ Google Compute Engine ğŸ”ª\nterraform destroy\nGoogle Compute Engine åˆªé™¤ä¸­â€¦\nä»¥ä¸Šå°±æ˜¯ç°¡å–®çš„ä½¿ç”¨ Terraform å»ºç«‹ Google Compute Engine ä»‹ç´¹å›‰ï½æ­¡è¿å¤§å®¶ç•™è¨€æŒ‡æ•™ï¼Œæ˜å¤©çš„æ–‡ç« æ˜¯ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ Terraform å»ºç«‹ GKE ğŸ’•","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"registry.terraform.io/providers (google_compute_instance)ï¼šhttps://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance","å»ºç«‹-google-compute-engine#å»ºç«‹ Google Compute Engine":"ç•¶æˆ‘å€‘å¯«å¥½ Google Compute Engine tf æª”æ¡ˆå¾Œï¼Œæˆ‘å€‘æ¥è‘—æŠŠä»–å»ºç«‹ï¼Œå»ºç«‹å‰è¦å…ˆä½¿ç”¨ terraform init ä¾†åšåˆå§‹åŒ–\nterraform init\næ¥è‘—å¯ä»¥å…ˆä½¿ç”¨ terraform plan ä¾†æŸ¥çœ‹æˆ‘å€‘çš„è¨­å®šæ˜¯å¦æ˜¯æˆ‘å€‘æƒ³è¦çš„ï¼Œæˆ–æ˜¯ç›´æ¥ç”¨ terraform apply ä¾†å»ºç«‹ Google Compute Engine\nterraform apply\nå¯ä»¥çœ‹åˆ°æˆåŠŸå»ºç«‹æˆ‘å€‘çš„ test Google Compute Engineï¼ˆä¹Ÿå¯ä»¥çœ‹åˆ°å› ç‚ºæˆ‘å€‘æœ‰é–‹ nat_ip æ‰€ä»¥æœ‰å¤–éƒ¨ IPï¼‰\nGCP Google Compute Engine","æ’°å¯«-google-compute-engine-tf-æª”æ¡ˆ#æ’°å¯« Google Compute Engine tf æª”æ¡ˆ":"ç›¸ä¿¡å¤§å®¶æœ‰å…ˆçœ‹å®Œä¸Šä¸€ç¯‡ ä»€éº¼æ˜¯ IaC ? Terraform åˆæ˜¯ä»€éº¼ï¼Ÿ æ‰ä¾†çœ‹é€™ä¸€ç¯‡çš„å°å§ ğŸ˜ï¼Œå°æ–¼ Terraform çš„ç¨‹å¼æ¶æ§‹åŠæŒ‡ä»¤ï¼Œæˆ‘å€‘é€™é‚Šå°±ä¸å¤šåšä»‹ç´¹ï¼Œæˆ‘å€‘ç›´æ¥ä¾†çœ‹ç¨‹å¼è¦æ€éº¼å¯«ï½(ç¨‹å¼ç¢¼ä¸»è¦æ˜¯åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼ŒåŠ ä¸Šä¸€äº›å…¶ä»–çš„è¨­å®šä¾†åšä»‹ç´¹ï¼Œç¨‹å¼ç¢¼ä¹ŸæœƒåŒæ­¥åˆ° Github ï¼Œéœ€è¦çš„ä¹Ÿå¯ä»¥å» Clone ä¾†ä½¿ç”¨æ­ï¼ Github ç¨‹å¼ç¢¼é€£çµ )\nå°æé†’ï¼šç”±æ–¼ç¨‹å¼ç¢¼è¼ƒé•·ï¼Œæˆ‘å°‡ä»–æ‹†é–‹ä¾†èªªæ˜ ğŸ’–\né¸æ“‡ä¾›æ‡‰è€…ä»¥åŠå°æ‡‰çš„å°ˆæ¡ˆ provider \"google\" { project = \"gcp-20210526-001\" } ç”±æ–¼æˆ‘å€‘è¦å»ºç«‹çš„ Google Compute Engine æ˜¯ç”± Google æ‰€æä¾›çš„ api ä¾†å»ºç«‹çš„ï¼Œæ‰€ä»¥ä¸€é–‹å§‹è¦å…ˆè¨­å®šå¥½æä¾›è€…çš„åç¨± google ä»¥åŠæˆ‘å€‘è¦åœ¨å“ªä¸€å€‹ GCP çš„å°ˆæ¡ˆ ID\nresource è¨­å®š æ¥ä¸‹ä¾†çš„è¨­å®šéƒ½æœƒæ”¾åœ¨ä»¥ä¸‹çš„ google_compute_instance resource å…§ï¼Œç‚ºäº†æ–¹ä¾¿ä»‹ç´¹ï¼Œå°±ä¸æœƒæ¨™æ˜ google_compute_instanceï¼Œè©³ç´°å®Œæ•´ç¨‹å¼ç¢¼è«‹åƒè€ƒ GitLab Github ç¨‹å¼ç¢¼é€£çµ\nresource \"google_compute_instance\" \"default\" { } åŸºæœ¬è¨­å®š name = \"test\" description = \"æˆ‘æ˜¯ test æ©Ÿå™¨\" machine_type = \"n2-standard-8\" zone = \"asia-east1-b\" tags = [\"test\"] labels = { env = \"test\" } deletion_protection = \"true\" nameï¼šGCE è¦æ±‚è³‡æºçš„å”¯ä¸€åç¨±ã€‚å¦‚æœæœ‰æ›´æ”¹æ­¤é …æœƒç›´æ¥å¼·åˆ¶å‰µå»ºçš„æ–°è³‡æº (å¿…å¡«) descriptionï¼šå°æ­¤è³‡æºçš„ç°¡å–®èªªæ˜ (é¸å¡«) machine_typeï¼šè¦å‰µå»ºçš„æ©Ÿå™¨é¡å‹ (å¿…å¡«) zoneï¼šå‰µå»ºæ©Ÿå™¨çš„æ‰€åœ¨å€åŸŸï¼Œè‹¥æ²’æœ‰å¡«å¯«ï¼Œå‰‡æœƒä½¿ç”¨æä¾›è€…çš„å€åŸŸ (é¸å¡«) tagsï¼šé™„åŠ åˆ°å¯¦é«”çš„ç¶²è·¯æ¨™ç±¤åˆ—è¡¨ (é¸å¡«) labelsï¼šä¸€çµ„åˆ†é…çµ¦ disk çš„ key/value æ¨™ç±¤ (é¸å¡«) deletion_protectionï¼šåˆªé™¤ä¿è­·ï¼Œé è¨­æ˜¯ falseï¼Œç•¶æˆ‘å€‘ä½¿ç”¨ terraform destroy åˆªé™¤ GCE æ™‚ï¼Œå¿…é ˆå…ˆæ”¹æˆ falseï¼Œæ‰å¯ä»¥åˆªé™¤ï¼Œå¦å‰‡æœƒç„¡æ³•åˆªé™¤ä¸” Terraform é‹è¡Œä¹Ÿæœƒå¤±æ•—ï¼Œç®—æ˜¯ä¸€å€‹ä¿è­·æ©Ÿåˆ¶ï¼Œå¾Œé¢å†åˆªé™¤ Google Compute Engine æ™‚æœƒæ¸¬è©¦ç•«é¢ (é¸å¡«) å•Ÿå‹• disk è¨­å®š boot_disk { initialize_params { image = \"debian-cloud/debian-10-buster-v20210512\" type = \"pd-balanced\" size = \"50\" } } imageï¼šåˆå§‹åŒ–æ­¤ disk çš„ image (é¸å¡«) typeï¼šGCE disk é¡å‹ (é¸å¡«) sizeï¼šimage å¤§å°ï¼Œå·² GB ç‚ºå–®ä½ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œå°‡æœƒç¹¼æ‰¿å…¶åˆå§‹åŒ– disk çš„ image å¤§å° (é¸å¡«) ç¶²è·¯è¨­å®š network_interface { network = \"projects/rd-gateway/global/networks/rd-common\" subnetwork = \"projects/rd-gateway/regions/asia-east1/subnetworks/rd-common-asia-east1-pid-cicd\" access_config { nat_ip = \"\" } } networkï¼šè¨­å®šé™„åŠ åˆ°çš„ç¶²è·¯åç¨±æˆ–æ˜¯ self_link (é¸å¡«) subnetworkï¼šè¨­å®šé™„åŠ åˆ°çš„å­ç¶²è·¯åç¨±æˆ–æ˜¯ self_link (é¸å¡«) nat_ipï¼šå¦‚æœæƒ³è¦æœ‰å¤–ç¶²çš„ ipï¼Œå¿…é ˆåŠ ä¸Šæ­¤åƒæ•¸ï¼Œæ‰æœƒç”¢ç”Ÿä¸€çµ„å¤–ç¶² ip (é¸å¡«) æ¬Šé™è¨­å®š service_account { email = \"676962704505-compute@developer.gserviceaccount.com\" scopes = [\"storage-rw\", \"logging-write\", \"monitoring-write\", \"service-control\", \"service-management\", \"trace\"] } emailï¼šæœå‹™å¸³æˆ¶é›»å­éƒµä»¶åœ°å€ã€‚å¦‚æœæœªæä¾›ï¼Œå‰‡ä½¿ç”¨é è¨­çš„ Google Compute Engine æœå‹™å¸³æˆ¶ (é¸å¡«) scopesï¼šæœå‹™ç¯„åœåˆ—è¡¨ï¼Œå¯ä»¥é»æˆ‘æŸ¥çœ‹ç¯„åœçš„å®Œæ•´åˆ—è¡¨ (å¿…å¡«) ä»¥ä¸Šåªæ˜¯æˆ‘åœ¨å»ºç«‹ Google Compute Engine æœ€ç°¡å–®çš„è¨­å®šï¼Œç•¶ç„¶é‚„æœ‰å¾ˆå¤šå…¶ä»–çš„è¨­å®šï¼Œå¯ä»¥åƒè€ƒ registry.terraform.io/providers (google_compute_instance) è£¡é¢æœ‰æ›´å¤šçš„ resource è¨­å®šï¼Œæœ‰éœ€è¦çš„å°±è‡ªå·±ä¾†çœ‹çœ‹å§ ğŸ§"},"title":"ä½¿ç”¨ Terraform å»ºç«‹ Google Compute Engine"},"/blog/terraform/terraform-gke/":{"data":{"":"æˆ‘å€‘æ¥çºŒæ˜¨å¤©çš„å»ºç«‹ Google Kubernetes Engine æ–‡ç« ï¼Œä»Šå¤©è¦ä¾†ä»‹ç´¹çš„æ˜¯å¦‚ä½•ç”¨ Terraform å»ºç«‹ Google Kubernetes Engineï¼Œç”±æ–¼ä½¿ç”¨ terraform å»å»ºç«‹ã€ä¿®æ”¹ã€åˆªé™¤çš„æŒ‡ä»¤å¤§å®¶æ‡‰è©²éƒ½æ¸…æ¥šäº†ï¼Œé‚£æˆ‘ä»Šå¤©çš„æ–‡ç« å°±ä¸åœ¨å¤šèªªï¼Œç›´æ¥ä¾†ä»‹ç´¹ä¸€ä¸‹è¦æ€éº¼æ’°å¯« Google Kubernetes Engine tf æª”æ¡ˆ ğŸ˜","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"registry.terraform.io/providers (google_container_cluster)ï¼šhttps://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster\nregistry.terraform.io/providers (google_container_node_pool)ï¼šhttps://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_node_pool","æ’°å¯«-google-kubernetes-engine-tf-æª”æ¡ˆ#æ’°å¯« Google Kubernetes Engine tf æª”æ¡ˆ":"ç¨‹å¼ç¢¼æœƒåŒæ­¥åˆ° Github ï¼Œéœ€è¦çš„ä¹Ÿå¯ä»¥å» Clone ä¾†ä½¿ç”¨æ­ï¼ Github ç¨‹å¼ç¢¼é€£çµï¼Œå°æé†’ï¼šç”±æ–¼ç¨‹å¼ç¢¼è¼ƒé•·ï¼Œæˆ‘å°‡ä»–æ‹†é–‹ä¾†èªªæ˜ ğŸ’–\nç”±æ–¼ç­‰ç­‰ç¨‹å¼ç¢¼è¼ƒé•·ï¼Œæ‰€ä»¥æˆ‘åœ¨å‰é¢é€™é‚Šå…ˆåšèªªæ˜ï¼ŒGKE çš„çµæ§‹æ˜¯ å¢é›†(cluster) \u003e ç¯€é»æ± (node_pool) \u003e ç¯€é»(node)ï¼Œæœ¬æ¬¡çš„ä»‹ç´¹ç¯„ä¾‹ï¼Œæœƒæœ‰ä¸€å€‹å¢é›†è£¡é¢æœ‰ä¸€å€‹ç¯€é»æ± ï¼Œç¯€é»æ± è£¡é¢æœ‰ 6 å€‹ç¯€é»æ•¸é‡ï¼Œç¯„ä¾‹è£¡é¢æœƒåŠ ä¸Šæˆ‘æ¯”è¼ƒå¸¸ç”¨åˆ°çš„ä¸€äº›è¨­å®šï¼Œä»¥åŠä¸€äº›æ–‡ä»¶è£¡é¢çš„ç”¨æ³•ï¼Œå¤§å®¶å¯ä»¥ä¾ç…§è‡ªå·±çš„éœ€æ±‚ä¾†ä½¿ç”¨åƒæ•¸ï¼š\né™åˆ¶ä½¿ç”¨çš„ç‰ˆæœ¬ åœ¨ä¸Šä¸€ç¯‡ ä½¿ç”¨ Terraform å»ºç«‹ Google Compute Engineï¼Œæˆ‘å€‘çŸ¥é“ Terraform å…¶å¯¦å°±æ˜¯å°æ‡‰çš„æä¾›å•†ï¼Œæä¾›å°æ‡‰çš„ api ä¾†è®“æˆ‘å€‘å¯ä»¥ç”¨ terraform å»å»ºç½®å¾ˆå¤š IaCï¼Œä½†ä¾›æ‡‰å•†æä¾›çš„ api æœƒéš¨è‘—ç‰ˆæœ¬è€Œæœ‰æ‰€æ›´å‹•ï¼Œå¯èƒ½æ›äº†ä¸€å€‹ç‰ˆæœ¬ï¼ŒåŸæœ¬å¯ä»¥ä½¿ç”¨çš„ resource åƒæ•¸å°±æœƒæœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥åœ¨ä¸€é–‹å§‹ï¼Œå…ˆè¨­å®šå¥½é€™éš» tf è¦ä½¿ç”¨çš„ä¾›æ‡‰å•†åŠå°æ‡‰çš„ç‰ˆæœ¬ï¼Œå¯ä»¥åƒè€ƒä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š\nterraform { required_providers { google = { source = \"hashicorp/google\" version = \"~\u003e 4.38.0\" } } } å¯ä»¥çœ‹åˆ°æˆ‘å€‘æŠŠ google é€™å€‹ä¾›æ‡‰å•†è£¡é¢è¨­å®šå¥½ä»–çš„ source ä»¥åŠ versionï¼Œé€™æ¨£å°±ç®—ä¹‹å¾Œ goolge æœ‰æ›´æ–° terraform çš„ apiï¼Œæˆ‘å€‘ä¹Ÿä¸éœ€è¦å»æ›´æ›åƒæ•¸å°±å¯ä»¥ä½¿ç”¨äº†ï½\né¸æ“‡ä¾›æ‡‰è€…ä»¥åŠå°æ‡‰çš„å°ˆæ¡ˆ provider \"google\" { project = \"project\" } é™¤äº†å¯ä»¥ä½¿ç”¨å°ˆæ¡ˆ ID ä»¥å¤–ï¼Œç•¶ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å°ˆæ¡ˆçš„åç¨±æ‹‰ ğŸ¥³\nresource è¨­å®š google_container_cluster resource \"google_container_cluster\" \"cluster\" { name = \"test\" location = \"asia-southeast1-b\" min_master_version = \"1.22.12-gke.300\" network = \"projects/gcp-202011216-001/global/networks/XXXX\" subnetwork = \"projects/gcp-202011216-001/regions/asia-southeast1/subnetworks/XXXX\" default_max_pods_per_node = 64 remove_default_node_pool = true initial_node_count = 1 enable_intranode_visibility = false ip_allocation_policy { cluster_secondary_range_name = \"gke-pods\" services_secondary_range_name = \"gke-service\" } resource_labels = { \"env\" = \"test\" } addons_config { http_load_balancing { disabled = false } horizontal_pod_autoscaling { disabled = false } network_policy_config { disabled = false } } master_auth { client_certificate_config { issue_client_certificate = false } } private_cluster_config { enable_private_endpoint = false enable_private_nodes = true master_ipv4_cidr_block = \"172.16.0.0/28\" } logging_config { enable_components = [\"SYSTEM_COMPONENTS\", \"WORKLOADS\"] } monitoring_config { enable_components = [\"SYSTEM_COMPONENTS\"] } node_config { machine_type = \"e2-medium\" disk_size_gb = 100 disk_type = \"pd-standard\" image_type = \"COS_CONTAINERD\" oauth_scopes = [ \"https://www.googleapis.com/auth/devstorage.read_only\", \"https://www.googleapis.com/auth/logging.write\", \"https://www.googleapis.com/auth/monitoring\", \"https://www.googleapis.com/auth/servicecontrol\", \"https://www.googleapis.com/auth/service.management.readonly\", \"https://www.googleapis.com/auth/trace.append\" ] metadata = { disable-legacy-endpoints = \"true\" } } } nameï¼šå¢é›†çš„åç¨±ï¼Œåœ¨é€™å€‹å°ˆæ¡ˆåŠå€åŸŸå”¯ä¸€åç¨± (å¿…å¡«) locationï¼šè¦å°‡æ­¤å¢é›†å»ºç«‹åœ¨å“ªä¸€å€‹å€åŸŸ (é¸å¡«) min_master_versionï¼šmaster çš„æœ€ä½ç‰ˆæœ¬ (é¸å¡«) networkï¼šå¢é›†é€£æ¥åˆ°çš„ Google Compute Engine ç¶²çµ¡çš„åç¨±æˆ– self_link (é¸å¡«) subnetworkï¼šå•Ÿå‹•å¢é›†çš„ Google Compute Engine å­ç¶²çš„åç¨±æˆ– self_link (é¸å¡«) default_max_pods_per_nodeï¼šæ­¤å¢é›†ä¸­æ¯å€‹ç¯€é»çš„é è¨­æœ€å¤§ pod æ•¸ (é¸å¡«) remove_default_node_poolï¼šå¦‚æœè¨­å®šç‚º trueï¼Œå‰‡åœ¨å‰µå»ºå¢é›†æ™‚æœƒå¹«æˆ‘å€‘åˆªé™¤é è¨­çš„ç¯€é»æ± ã€‚æœƒä½¿ç”¨åˆ°é€™å€‹çš„åŸå› æ˜¯å› ç‚º terraform æ²’è¾¦æ³•ä¿®æ”¹é è¨­ç¯€é»æ± çš„åç¨±ï¼Œæ‰€ä»¥æˆ‘çš„åšæ³•æ˜¯ï¼Œæœƒæ–°å¢è¦çš„ç¯€é»æ± ï¼Œåœ¨ä½¿ç”¨é€™å€‹åƒæ•¸æŠŠé è¨­çš„çµ¦åˆªæ‰(é¸å¡«) initial_node_countï¼šè¦åœ¨æ­¤å¢é›†çš„é è¨­ç¯€é»æ± ä¸­å‰µå»ºçš„ç¯€é»æ•¸ (é¸å¡«) enable_intranode_visibilityï¼šæ˜¯å¦ç‚ºæ­¤å¢é›†å•Ÿç”¨äº†ç¯€é»å…§å¯è¦‹æ€§ (é¸å¡«) ip_allocation_policyï¼šç‚º VPC åŸç”Ÿå¢é›†åˆ†é…å¢é›† IP (é¸å¡«) resource_labelsï¼šæ‡‰ç”¨æ–¼å¢é›†çš„ GCE è³‡æºæ¨™ç±¤ key/value (é¸å¡«) addons_config http_load_balancingï¼šæ˜¯å¦è¦å•Ÿç”¨ HTTP (L7) çš„è² è¼‰å¹³è¡¡ (é¸å¡«) horizontal_pod_autoscalingï¼šæ˜¯å¦è¦å•Ÿç”¨ HPA æ°´å¹³ Pod è‡ªå‹•æ“´å±• (é¸å¡«) network_policy_configï¼šæ˜¯å¦è¦å•Ÿç”¨ç¶²è·¯ç­–ç•¥ (é¸å¡«) master_auth client_certificate_configï¼šæ˜¯å¦è¦å•Ÿç”¨è©²å¢é›†å®¢æˆ¶ç«¯è­‰æ›¸æˆæ¬Š (é¸å¡«) private_cluster_config enable_private_endpointï¼šæ˜¯å¦è¦å•Ÿç”¨å¢é›†å°ˆç”¨çš„ç§æœ‰ç«¯é»ï¼Œç¦æ­¢å…¬å…±ç«¯é»çš„è¨ªå• (é¸å¡«) enable_private_nodesï¼šæ˜¯å¦è¦å•Ÿç”¨ç§æœ‰å¢é›†åŠŸèƒ½ï¼Œåœ¨å¢é›†å‰µå»ºç§æœ‰ç«¯é» (é¸å¡«) master_ipv4_cidr_blockï¼šç§æœ‰ç«¯é» IP ç¯„åœ (é¸å¡«) logging_configï¼šå¢é›†çš„æ—¥èªŒè¨˜éŒ„é…ç½® enable_components (å…¬é–‹æ—¥èªŒçš„ GKE çµ„ä»¶) è¨­å®šï¼ŒåŒ…å«ï¼šSYSTEM_COMPONENTSã€APISERVERã€CONTROLLER_MANAGERã€SCHEDULERã€WORKLOADS (å¿…å¡«) monitoring_configï¼šå¢é›†çš„ç›£æ§é…ç½® enable_components (GKE çµ„ä»¶å…¬é–‹æŒ‡æ¨™) è¨­å®šï¼ŒåŒ…å«ï¼šSYSTEM_COMPONENTSã€APISERVERã€CONTROLLER_MANAGERã€SCHEDULER (é¸å¡«) node_configï¼šå‰µå»ºé è¨­ç¯€é»æ± åƒæ•¸ machine_typeï¼šGoogle Compute Engine æ©Ÿå™¨é¡å‹ï¼Œé è¨­ç‚º e2-medium (é¸å¡«) disk_size_gbï¼šæ¯å€‹ç¯€é»çš„ disk å¤§å°ï¼Œä»¥ GB ç‚ºå–®ä½ã€‚å…è¨±æœ€å°ç‚º 10 GBï¼Œé è¨­ç‚º 100 GB (é¸å¡«) disk_typeï¼šé€£æ¥åˆ°æ¯å€‹ç¯€é»çš„ disk é¡å‹ï¼Œæœ‰ pd-standardã€pd-balanced æˆ– pd-ssdï¼Œé è¨­ç‚º pd-standard (é¸å¡«) image_typeï¼šå‰µå»ºæ–°ç¯€é»æ± å¾Œ NAP ä½¿ç”¨çš„é è¨­ image é¡å‹ã€‚è©²å€¼å¿…é ˆæ˜¯ [COS_CONTAINERDã€COSã€UBUNTU_CONTAINERDã€UBUNTU] ä¹‹ä¸€ã€‚COS å’Œ UBUNTU å·²æ–¼ GKE 1.24 æ£„ç”¨ (é¸å¡«) oauth_scopesï¼šåœ¨é è¨­æœå‹™å¸³æˆ¶ä¸‹çš„æ‰€æœ‰ç¯€é»è™›æ“¬æ©Ÿä¸Šå¯ç”¨çš„ä¸€çµ„ Google API ç¯„åœã€‚ (é¸å¡«) metadataï¼šåˆ†é…çµ¦å¢é›†ä¸­å¯¦ä¾‹çš„ key/value (é¸å¡«) google_container_node_pool resource \"google_container_node_pool\" \"aaa\" { name = \"aaa\" project = \"project\" location = google_container_cluster.cluster.location cluster = google_container_cluster.cluster.name node_count = 6 node_locations = [ google_container_cluster.cluster.location ] node_config { # çœç•¥ ... èˆ‡ä¸Šé¢çš„ google_container_cluster ç›¸åŒ } management { auto_repair = true auto_upgrade = false } upgrade_settings { max_surge = 1 max_unavailable = 0 } } nameï¼šç¯€é»æ± åç¨± (é¸å¡«) projectï¼šå‰µå»ºç¯€é»æ± çš„é …ç›® ID (é¸å¡«) locationï¼šå¢é›†æ‰€åœ¨ä½ç½®ï¼Œå¯ä»¥ä½¿ç”¨è³‡æºåç¨± (google_container_node_pool) +å‘½å (cluster) + åƒæ•¸ (location) ä¾†ä»£è¡¨ (é¸å¡«) clusterï¼šå¢é›†åç¨±ï¼Œå¯ä»¥ä½¿ç”¨è³‡æºåç¨± (google_container_node_pool) +å‘½å (cluster) + åƒæ•¸ (name) ä¾†ä»£è¡¨ (é¸å¡«) node_countï¼šç¯€é»æ•¸é‡ (é¸å¡«) node_locationsï¼šç¯€é»å€åŸŸ (é¸å¡«) managementï¼šç¯€é»ç®¡ç†é…ç½® auto_repairï¼šæ˜¯å¦è¦è‡ªå‹•ä¿®å¾© (é¸å¡«) auto_upgradeï¼šæ˜¯å¦è¦è‡ªå‹•å‡ç´š (é¸å¡«) upgrade_settingsï¼šæŒ‡å®šç¯€é»å‡ç´šè¨­å®šåŠæ–¹å¼ max_surgeï¼šå‡ç´šæœŸé–“å¯ä»¥æ·»åŠ åˆ°ç¯€é»æ± çš„é¡å¤–ç¯€é»æ•¸ (é¸å¡«) max_unavailableï¼šå‡ç´šæœŸé–“å¯ä»¥åŒæ™‚ä¸å¯ç”¨çš„ç¯€é»æ•¸ (é¸å¡«) å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šè¨­å®šéƒ½æ˜¯é¸å¡«çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦åƒæˆ‘ç¯„ä¾‹ä¸€æ¨£ï¼ŒæŠŠæ‰€æœ‰çš„éƒ½æ‰“å‡ºä¾†ï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼Œå°‡è‡ªå·±æƒ³è¦çš„è¨­å®šå¯«å‡ºä¾†ï¼Œä¸¦æ³¨æ„å…¶ä»–åƒæ•¸çš„é è¨­å€¼æ˜¯å¤šå°‘ï¼Œå°±å¯ä»¥æ‰“é€ å±¬æ–¼è‡ªå·±çš„ Terraform å»ºç«‹ Google Kubernetes Engine IaC ç¨‹å¼å›‰ï½"},"title":"ä½¿ç”¨ Terraform å»ºç«‹ Google Kubernetes Engine"},"/blog/terraform/terraform-module/":{"data":{"":"ç•¶æˆ‘å€‘è¦ç®¡ç†çš„è³‡æºè¶Šä¾†è¶Šå¤šå¾Œï¼Œæœƒç”¢ç”Ÿå¾ˆå¤šçš„ tf æª”æ¡ˆï¼Œå‡è¨­æˆ‘å€‘ç¾åœ¨æœ‰ä¸‰å€‹ gce æœå‹™ï¼Œæœƒåœ¨ä»¥ä¸‹ä¸‰å€‹ä¸åŒç’°å¢ƒä¸Šé¢é‹ä½œï¼Œæ¯å€‹ç’°å¢ƒéƒ½æœƒæœ‰æˆ‘å€‘ä¹‹å‰å­¸æœƒçš„åŸºæœ¬ tf æª”æ¡ˆ(åŒ…å« provider.tf ã€main.tfã€backend.tf)ï¼Œä¸”å…¶ä¸­çš„ main.tf æª”æ¡ˆå…§æœ‰äº›è¨­å®šæœƒä¸å¤ªä¸€æ¨£ï¼Œå¦‚ä¸‹ï¼š\ndev backend.tf main.tf provider.tf prod backend.tf main.tf provider.tf qa backend.tf main.tf provider.tf dev/main.tfresource \"google_compute_instance\" \"instance\" { project = \"é¦¬è³½å…‹\" name = \"test-dev\" machine_type = \"e2-small\" zone = \"asia-east1-b\" boot_disk { initialize_params { image = \"debian-cloud/debian-10\" size = 50 } } .... å…¶ä»–çœç•¥ä¸å¯« .... } qa/main.tf (å¤šäº† tags)resource \"google_compute_instance\" \"instance\" { project = \"é¦¬è³½å…‹\" name = \"test-qa\" machine_type = \"e2-small\" zone = \"asia-east1-b\" tags = [\"for-qa\"] boot_disk { initialize_params { image = \"debian-cloud/debian-10\" size = 50 } } .... å…¶ä»–çœç•¥ä¸å¯« .... } prod/main.tf (å¤šäº† labels)resource \"google_compute_instance\" \"instance\" { project = \"é¦¬è³½å…‹\" name = \"test-prod\" machine_type = \"e2-small\" zone = \"asia-east1-b\" labels = { aaa = \"test1\" bbb = \"test2\" ccc = \"test3\" } boot_disk { initialize_params { image = \"debian-cloud/debian-10\" size = 50 } } .... å…¶ä»–çœç•¥ä¸å¯« .... } å¯ä»¥çœ‹åˆ°ä¸‰å€‹ main.tf æª”æ¡ˆé™¤äº† name ä»¥å¤–ï¼Œåœ¨ qa é‚„å¤šäº† tagsã€prod å¤šäº† labels ç­‰è¨­å®šï¼Œç­‰æ–¼æˆ‘å€‘æœƒä¾ç…§æ¯å€‹ä¸åŒç’°å¢ƒä¸åŒæœå‹™å»å®¢è£½åŒ–ä»–çš„ tf è³‡æºè¨­å®šï¼Œé›–ç„¶éå¸¸ç›´è¦ºï¼Œä½†å¾€å¾Œçš„ç¶­è­·ä»¥åŠèª¿æ•´å»éå¸¸ä¸æ–¹ä¾¿ ( å‡è¨­æˆ‘å€‘ç¾åœ¨è¦å…¨éƒ¨éƒ½åŠ ä¸Š labelsï¼Œå°±å¿…é ˆä¸€å€‹ä¸€å€‹æª¢æŸ¥ä¸¦èª¿æ•´ )ã€‚\nç‚ºäº†æ–¹ä¾¿æˆ‘å€‘ç¶­è­·ä»¥åŠé‡è¤‡ä½¿ç”¨ï¼Œå› æ­¤æœ‰äº† moduleï¼Œå¯ä»¥å…ˆå°‡å…¨éƒ¨æœƒä½¿ç”¨åˆ°çš„è¨­å®šå¯«æˆæ¨¡æ¿ï¼Œé€éåƒæ•¸çš„æ–¹å¼å¸¶å…¥å³å¯ï¼Œmodule æœ‰ä»¥ä¸‹å¹¾å€‹å„ªé»ï¼š\né‡è¤‡ä½¿ç”¨æ€§ï¼š module è®“ç¨‹å¼ç¢¼æ›´æ˜“æ–¼é‡è¤‡ä½¿ç”¨ã€‚ç•¶æˆ‘å€‘éœ€è¦åœ¨å¤šå€‹é …ç›®ä¸­ä½¿ç”¨ç›¸åŒçš„åŸºç¤æ¶æ§‹æˆ–é…ç½®æ™‚ï¼Œå¯ä»¥å…ˆå°‡å…¶å°è£ç‚ºä¸€å€‹ moduleã€‚é€™æ¨£ï¼Œæˆ‘å€‘åªéœ€è¦åœ¨ä¸åŒçš„é …ç›®ä¸­å¼•ç”¨ä¸¦èª¿æ•´æ¨¡çµ„çš„åƒæ•¸ï¼Œè€Œä¸éœ€è¦é‡æ–°å¯«æ•´å€‹ tf æª”ã€‚\næŠ½è±¡åŒ–ï¼šå°‡ Terraform ä»£ç¢¼è½‰æ›ç‚º module å¯ä»¥å°‡è©³ç´°çš„å¯¦ç¾ç´°ç¯€æŠ½è±¡åŒ–ï¼Œåƒ…å¯«å¿…è¦çš„åƒæ•¸ã€‚é€™æ¨£åšå¯ä»¥æé«˜ç¨‹å¼ç¢¼çš„å¯è®€æ€§å’Œå¯ç¶­è­·æ€§ï¼Œä¸¦é™ä½ä½¿ç”¨è€…å­¸ç¿’å’Œä½¿ç”¨çš„é–€æª»ã€‚\nåƒæ•¸åŒ–é…ç½®ï¼šmodule å¯ä»¥ä½¿ç”¨è¼¸å…¥åƒæ•¸ä¾†æ¥æ”¶ä¸åŒçš„é…ç½®å€¼ã€‚é€™æ„å‘³è‘—æ‚¨å¯ä»¥æ ¹æ“šéœ€è¦å‹•æ…‹æ›´æ”¹æ¨¡çµ„çš„è¡Œç‚ºï¼Œè€Œä¸éœ€è¦ç›´æ¥ä¿®æ”¹æ¨¡çµ„çš„å…§éƒ¨ç¨‹å¼ã€‚é€™ä½¿å¾—é…ç½®æ›´éˆæ´»ä¸¦æ”¯æŒä¸åŒç’°å¢ƒçš„éƒ¨ç½²ã€‚\nmodule ç‰ˆæœ¬æ§åˆ¶ï¼šå°‡ Terraform ç¨‹å¼å°è£ç‚º module å¾Œï¼Œå¯ä»¥ä½¿ç”¨ git å°å…¶é€²è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚å¯ä»¥æ›´è¼•é¬†åœ°å”ä½œå’Œå…±äº« module (å¯ä»¥å°‡ module èˆ‡ Terraform åˆ†åˆ¥å­˜æ”¾ï¼Œä¸¦ä½¿ç”¨å°æ‡‰ tag or åˆ†æ”¯ä¾†åšé–‹ç™¼ )ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Types and Valuesï¼šhttps://developer.hashicorp.com/terraform/language/expressions/types","å¯¦ä½œ#å¯¦ä½œ":"ç•¶æˆ‘å€‘å®Œæˆä¸Šé¢çš„æ¶æ§‹å¾Œï¼Œæˆ‘å€‘é€²å…¥ projects/prod/main.tf è·¯å¾‘ä¸‹ï¼Œé–‹å§‹ç”¨ module çš„æ–¹å¼å»ºç«‹è³‡æºï¼Œå»ºç«‹è³‡æºçš„æµç¨‹èˆ‡åŸæœ¬çš„ç›¸åŒï¼Œä¸€æ¨£æ˜¯ init \u003e plan \u003e apply é€™ä¸‰å€‹æ­¥é©Ÿï¼Œé‚£æˆ‘å€‘ä¸€å€‹ä¸€å€‹ä¾†çœ‹ï¼Œèˆ‡åŸæœ¬çš„å»ºç«‹æ–¹å¼æœ‰å“ªäº›ä¸åŒä¹‹è™•å§ï½\ninit æˆ‘å€‘ä½¿ç”¨ terraform init ä¾†çœ‹çœ‹åŸæœ¬ init èˆ‡ä½¿ç”¨æ¨¡çµ„ init å¾Œå·®åœ¨å“ªè£¡ï¼š\nåŸå…ˆ terraform init çµæœ\nä½¿ç”¨ module init çµæœ\nå¯ä»¥çœ‹åˆ°æœ‰ä½¿ç”¨ module åœ¨åˆå§‹åŒ–çš„æ™‚å€™ï¼Œæœƒé€£åŒ module ä¹Ÿä¸€ä½µåˆå§‹åŒ–ï¼Œæ¥è‘—æˆ‘å€‘é€²åˆ° .terraform è³‡æ–™å¤¾å…§ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ moduels è³‡æ–™å¤¾ã€‚\n.terraform æª”æ¡ˆå·®ç•°\nåœ¨é€²å»çœ‹æœƒçœ‹æœ‰ä¸€å€‹ modules.json æª”æ¡ˆï¼Œæœƒç´€éŒ„ module ä½¿ç”¨çš„è·¯å¾‘ï¼Œå› æ­¤ç•¶æˆ‘å€‘ä½¿ç”¨çš„ module æœ‰æ”¹è®Šæ™‚ï¼Œè¦è¨˜å¾—é‡æ–° init æ‰å¯ä»¥ç¢ºä¿ä½¿ç”¨çš„ module æ˜¯æ­£ç¢ºçš„ã€‚\nä½¿ç”¨ module æœƒå¤šä¸€å€‹ modules.json æª”æ¡ˆ\nplan æˆ‘å€‘ä¸€æ¨£ä¸‹ terraform plan æŒ‡ä»¤ï¼Œä¾†çœ‹çœ‹å…©è€…é¡¯ç¤ºçš„å·®ç•°ï¼š\nåŸå…ˆ terraform plan çµæœ\nä½¿ç”¨ module plan çµæœ\nå¯ä»¥çœ‹åˆ°ä½¿ç”¨ module åœ¨ plan æ™‚ï¼Œé è¦½å‰µå»ºçš„è³‡æºæ ¼å¼ä¸åŒï¼Œä¹Ÿå°±ä»£è¡¨ä»–å­˜åœ¨ tfstate æª”æ¡ˆçš„æ ¼å¼ä¹Ÿæœƒä¸åŒ (é€™å€‹å¾Œé¢æœƒåœ¨æåˆ°ï¼Œèˆ‡ import ä¹Ÿæœ‰é—œä¿‚)\napply ä½¿ç”¨ terraform apply ä¾†çœ‹å»ºç«‹è³‡æºå¾Œçš„çµæœæœ‰ä»€éº¼ä¸åŒï¼š\nåŸå…ˆ terraform apply çµæœ\nä½¿ç”¨ module apply çµæœ\napply çœ‹åˆ°çš„èˆ‡ plan é¡¯ç¤ºçš„ä¸€æ¨£ï¼Œä½¿ç”¨ module å»ºç«‹çš„è³‡æ–™æ ¼å¼æœƒä¸å¤ªä¸€æ¨£ï¼Œæ‰€ä»¥æˆ‘å€‘ä¾†çœ‹çœ‹å…©è€… tfstate æª”æ¡ˆçš„å·®ç•°ï¼š\nåŸå…ˆ terraform å»ºç«‹çš„ tfstate æª”æ¡ˆ\nä½¿ç”¨ module å»ºç«‹çš„ tfstate æª”æ¡ˆ\nimport import çš„åŠŸç”¨æ˜¯å¯ä»¥å¾é›²ä¸Šæœå‹™è½‰æˆ tfï¼Œåœ¨ä¹‹å‰åŸæœ¬çš„ terraform æ˜¯è¦å…ˆå»ºç«‹ä¸€å€‹ç©ºçš„ resourceï¼š\nresource \"google_compute_instance\" \"instance\" { } å†ä½¿ç”¨ terraform import google_compute_instance.instance å°ˆæ¡ˆID/æ©Ÿå™¨åœ°å€/æ©Ÿå™¨åç¨± ä¾†åŒ¯å…¥é›²ä¸Šæœå‹™çš„ç‹€æ…‹åˆ°å¾Œç«¯å­˜åˆ° tfstate çš„ä½å­ã€‚\nåŸå…ˆ terraform import ç·šä¸Šæœå‹™\né‚£æˆ‘å€‘ç¾åœ¨æ”¹æˆ moduleï¼Œæœƒæ¯”è¼ƒéº»ç…©ä¸€é»ï¼Œå› ç‚ºæˆ‘å€‘æœ‰åœ¨ variables.tf è¨­å®šæˆ‘å€‘çš„è®Šæ•¸ï¼Œè‹¥æ˜¯æ²’æœ‰è¨­å®šé è¨­å€¼ï¼Œå°±å¿…é ˆä¸€å®šè¦è¼¸å…¥ï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨å»ºç«‹æ™‚ï¼Œè¦å…ˆæŠŠè®Šæ•¸çš„ç©ºå€¼ä¹Ÿè£œä¸Šï¼Œå¦‚ä¸‹ï¼š\nmodule \"ian-test\" { source = \"../../module/google_compute_instance\" project_id = \"\" instance_name = \"\" machine_type = \"\" instance_zone = \"\" instance_tags = [] instance_labels = {} boot_disk_image_name = \"\" boot_disk_size = 50 attached_disk_enabled = false network_name = \"\" subnetwork_name = \"\" nat_ip_enabled = false metadata = {} resource_policies = [] service_account_email = \"\" service_account_scopes = [] } \" \" æ˜¯ string æ ¼å¼çš„ç©ºå€¼ï¼Œ[ ] æ˜¯ list æ ¼å¼çš„ç©ºå€¼ï¼Œ{ } æ˜¯ map æ ¼å¼çš„ç©ºå€¼ï¼Œå…¶ä»–çš„ bool æˆ‘é è¨­æœƒçµ¦ä»– falseï¼Œnumber æˆ‘æœƒéš¨ä¾¿çµ¦ä»–ä¸€å€‹æ•¸å­— xDã€‚é€™é‚Šå¸¶å…¥çš„å…§å®¹ä¸æ˜¯å¾ˆé‡è¦ï¼Œä¸»è¦æ˜¯è®“ä»–å¯ä»¥å»æŠ“åˆ°ä»–çš„æ¶æ§‹ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥åœ¨ variables.tf è¨­å®šæ™‚éƒ½è£œä¸Šé è¨­å€¼ã€‚\nå†ä½¿ç”¨ terraform import module.ian-test.google_compute_instance.instance å°ˆæ¡ˆID/æ©Ÿå™¨åœ°å€/æ©Ÿå™¨åç¨± ä¾†åŒ¯å…¥ç‹€æ…‹æª”æ¡ˆã€‚(é€™é‚Šè¦è¨˜å¾—ä¾ç…§ä½  module è¨­å®šçš„åç¨±å¸¶å…¥)\nä½¿ç”¨ module import ç·šä¸Šæœå‹™","æª”æ¡ˆèªªæ˜#æª”æ¡ˆèªªæ˜":"\né¦–å…ˆæˆ‘å€‘è¦å…ˆå®šç¾©æˆ‘å€‘çš„ moduleï¼Œæˆ‘å€‘å…ˆå»ºç«‹ä»¥ä¸‹è³‡æ–™å¤¾çµæ§‹ä»¥åŠå°æ‡‰æª”æ¡ˆï¼š(åŒæ­¥åˆ° GitHub éœ€è¦ç¨‹å¼ç¢¼çš„å¯ä»¥å‰å¾€æŸ¥çœ‹)\n(å†æ¬¡æé†’ï¼Œæœƒå€åˆ†æª”æ¡ˆåç¨±æ˜¯å› ç‚ºæ–¹ä¾¿èª¿æ•´è·Ÿç¶­è­·ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒå…¨éƒ¨å¯«åœ¨åŒä¸€å€‹ tf æª”æ¡ˆå…§æ­)\nmodule google_compute_instance main.tf outputs.tf variables.tf projects dev backend.tf main.tf provider.tf prod backend.tf main.tf provider.tf qa backend.tf main.tf provider.tf module è³‡æ–™å¤¾ï¼šæ”¾æˆ‘å€‘ module è¨­å®š (é€™é‚Šç¯„ä¾‹æ˜¯æ”¾ gce)\nprojects è³‡æ–™å¤¾ï¼šæ”¾æˆ‘å€‘ä¸åŒæœå‹™ã€ä¸åŒç’°å¢ƒè¨­å®š (é€™é‚Šç‚ºäº†ç°¡åŒ–ï¼Œç¯„ä¾‹åªä»¥ä¸åŒç’°å¢ƒç‚ºä¾‹)\nmodule/google_compute_instance/main.tfprovider \"google\" { project = var.project_id zone = var.instance_zone } resource \"google_compute_instance\" \"instance\" { name = var.instance_name machine_type = var.machine_type zone = var.instance_zone tags = var.instance_tags labels = var.instance_labels boot_disk { auto_delete = var.boot_disk_auto_delete initialize_params { image = var.boot_disk_image_name size = var.boot_disk_size } } dynamic \"attached_disk\" { for_each = var.attached_disk_enabled ? [1] : [] content { device_name = var.attached_disk_name mode = var.attached_disk_mode source = var.attached_disk_source } } network_interface { network = var.network_name subnetwork = var.subnetwork_name dynamic \"access_config\" { for_each = var.nat_ip_enabled ? [1] : [] content { } } } metadata = var.metadata enable_display = var.enable_display resource_policies = var.resource_policies service_account { email = var.service_account_email scopes = var.service_account_scopes } timeouts {} deletion_protection = var.deletion_protection allow_stopping_for_update = var.allow_stopping_for_update } æˆ‘å€‘éœ€è¦æŠŠæ‰€æœ‰è¨­å®šçš„å€¼éƒ½æŒ–æ´ï¼Œä½¿ç”¨ var çš„æ–¹å¼ä¾†å¸¶å…¥åƒæ•¸ï¼Œé€™é‚Šè¦æ³¨æ„çš„æ˜¯ç­‰è™Ÿå‰é¢çš„å€¼æˆ–æ˜¯ block åç¨±éƒ½æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œä»–æ˜¯ google å®šç¾©çš„ api è®Šæ•¸ï¼Œä½† var å¾Œçš„åƒæ•¸åç¨±æˆ‘å€‘å¯ä»¥è‡ªè¨‚ (å¾Œé¢ variable.tf æœƒåœ¨è©³ç´°èªªæ˜)ï¼Œé‚£é€™é‚Šæ¯”è¼ƒç‰¹åˆ¥çš„ç”¨æ³•æ˜¯ dynamicï¼Œä»¥ä¸‹èªªæ˜ï¼š\ndynamic \"attached_disk\" { for_each = var.attached_disk_enabled ? [1] : [] content { device_name = var.attached_disk_name mode = var.attached_disk_mode source = var.attached_disk_source } } æˆ‘å€‘æœ‰äº› block åªæœ‰åœ¨ç‰¹å®šæœå‹™æ™‚æ‰éœ€ä½¿ç”¨ï¼Œä¾‹å¦‚ä¸Šé¢çš„ attached_disk ä»–æ˜¯ gce å¦å¤–æ›è¼‰å…¶ä»–ç£ç¢Ÿçš„è¨­å®šï¼Œå¦‚æœæœ‰éœ€è¦æˆ‘å€‘æ‰æœƒå¤šè¨­å®šé€™å€‹ blockï¼Œæ²’æœ‰å‰‡ä¸éœ€è¦åŠ ï¼Œå› æ­¤é ˆä½¿ç”¨ dynamic ä¾†å‹•æ…‹ç”¢ç”Ÿ blockï¼Œé€™é‚Šçš„è¨­å®šæ˜¯æˆ‘å€‘è¦åœ¨åƒæ•¸è¦å¸¶å…¥ attached_disk_enabled ç”¨ for_each ä¾†åˆ¤æ–·æ˜¯å¦éœ€è¦é€™å€‹ blockï¼Œå¦‚æœæ˜¯ trueï¼Œå°±æœƒç”¢ç”Ÿ attached_disk blockï¼Œä¸”éœ€è¦è¼¸å…¥ attached_disk_nameã€attached_disk_modeã€attached_disk_sourceã€‚\nmodule/google_compute_instance/variables.tfvariable \"project_id\" { type = string description = \"GCP å°ˆæ¡ˆ ID\" } variable \"instance_name\" { type = string description = \"GCE åç¨±\" } variable \"machine_type\" { type = string description = \"GCE é¡å‹\" } variable \"instance_zone\" { type = string description = \"GCE æ‰€åœ¨å€åŸŸ\" } variable \"instance_tags\" { type = list(string) description = \"GCE ç¶²è·¯æ¨™è¨˜\" } variable \"instance_labels\" { type = map(string) description = \"GCE æ¨™ç±¤\" } variable \"boot_disk_auto_delete\" { type = bool description = \"æ˜¯å¦åˆªé™¤ instance æ™‚ï¼Œè‡ªå‹•åˆªé™¤é–‹æ©Ÿç£ç¢Ÿ\" default = true } variable \"boot_disk_image_name\" { type = string description = \"GCE æ˜ åƒæª”åç¨±\" } variable \"boot_disk_size\" { type = number description = \"GCE é–‹æ©Ÿç£ç¢Ÿå¤§å° (å–®ä½: GB)\" } variable \"attached_disk_enabled\" { type = bool description = \"æ˜¯å¦å•Ÿç”¨é™„åŠ ç£ç¢Ÿ\" default = false } variable \"attached_disk_name\" { type = string description = \"GCE é™„åŠ ç£ç¢Ÿåç¨±\" default = \"\" } variable \"attached_disk_mode\" { type = string description = \"GCE é™„åŠ ç£ç¢Ÿæ¨¡å¼\" default = \"READ_ONLY\" validation { condition = contains([\"READ_WRITE\", \"READ_ONLY\"], var.attached_disk_mode) error_message = \"ä¸ç¬¦åˆé™„åŠ ç£ç¢Ÿæ¨¡å¼çš„å€¼ï¼Œè«‹è¼¸å…¥ READ_WRITE æˆ– READ_ONLY\" } } variable \"attached_disk_source\" { type = string description = \"GCE é™„åŠ ç£ç¢Ÿä¾†æº\" default = \"\" } variable \"network_name\" { type = string description = \"GCE ç¶²è·¯åç¨±\" } variable \"subnetwork_name\" { type = string description = \"GCE å­ç¶²è·¯åç¨±\" } variable \"nat_ip_enabled\" { type = bool description = \"æ˜¯å¦å•Ÿç”¨ NAT IP\" default = false } variable \"metadata\" { type = map(string) description = \"GCE ä¸­ç¹¼è³‡æ–™\" } variable \"enable_display\" { type = bool description = \"æ˜¯å¦å•Ÿç”¨è™›æ“¬é¡¯ç¤º\" default = false } variable \"resource_policies\" { type = list(string) description = \"GCE è³‡æºåŸå‰‡\" } variable \"service_account_email\" { type = string description = \"GCE æœå‹™å¸³æˆ¶é›»å­éƒµä»¶\" } variable \"service_account_scopes\" { type = list(string) description = \"GCE æœå‹™å¸³æˆ¶ç¯„åœ\" } variable \"deletion_protection\" { type = bool description = \"æ˜¯å¦å•Ÿç”¨åˆªé™¤ä¿è­·\" default = false } variable \"allow_stopping_for_update\" { type = bool description = \"æ˜¯å¦å…è¨±è‡ªå‹•åœæ­¢å¾Œæ›´æ–°\" default = false } é€™å€‹æª”æ¡ˆæœƒå®šç¾©æ¯å€‹è®Šæ•¸çš„åç¨±ä»¥åŠè³‡æ–™å‹æ…‹ï¼Œä¹Ÿå¯ä»¥å¯«èªªæ˜ä»¥åŠé è¨­çš„å€¼ï¼Œé€™é‚Šæ¯”è¼ƒç‰¹åˆ¥çš„æ˜¯ validation ï¼Œä»–å¯ä»¥é©—è­‰å¸¶å…¥çš„åƒæ•¸æ˜¯å¦ç¬¦åˆ condition å…§å®¹ï¼Œä¹Ÿå¯ä»¥è‡ªå®šç¾©éŒ¯èª¤çš„è¨Šæ¯ï¼Œå¦‚ä¸‹ï¼š\nvariable \"attached_disk_mode\" { type = string description = \"GCE é™„åŠ ç£ç¢Ÿæ¨¡å¼\" default = \"READ_ONLY\" validation { condition = contains([\"READ_WRITE\", \"READ_ONLY\"], var.attached_disk_mode) error_message = \"ä¸ç¬¦åˆé™„åŠ ç£ç¢Ÿæ¨¡å¼çš„å€¼ï¼Œè«‹è¼¸å…¥ READ_WRITE æˆ– READ_ONLY\" } } é€™é‚Šé™åˆ¶ attached_disk_mode è¼¸å…¥å¿…é ˆç¬¦åˆ READ_WRITE or READ_ONLY çš„å€¼ï¼Œå¦‚æœè¼¸å…¥å…¶ä»–ä¸ç¬¦åˆçš„æœƒé¡¯ç¤º error_message å…§å®¹ã€‚\nå¦å¤– variable é€™é‚Šæœ‰å¹¾å€‹è³‡æ–™å‹æ…‹å¯ä»¥é¸æ“‡ï¼Œå¦‚ä¸‹ï¼š\nstringï¼šå­—ä¸²ï¼Œä¸çŸ¥é“è¦é¸ä»€éº¼å°±é¸ä»–æ²’éŒ¯ xD\nboolï¼šå¸ƒæ—å€¼ï¼Œåªæœ‰ trueã€false å…©ç¨®é¸é …ï¼Œé©ç”¨æ–¼åˆ¤æ–·çš„å…§å®¹ï¼Œä¾‹å¦‚å‰›å‰›ä¸Šé¢èªªçš„ attached_disk_enabled å°±æ˜¯ä½¿ç”¨ bool\nnumberï¼šæ•¸å­—ï¼Œåªèƒ½è¼¸å…¥æ•¸å­—\nlist (tuple)ï¼šæ¸…å–®ï¼Œå…§å®¹å¯ä»¥æ”¾ç½®é¡ä¼¼ [\"us-west-1a\", \"us-west-1c\"] çš„è³‡æ–™\nmap (object)ï¼š key value å­˜æ”¾æ¨¡å¼ï¼Œä¾‹å¦‚ï¼š\n{ \"aaa\": \"test1\", \"bbb\": \"test2\", \"ccc\": \"test3\" } module/google_compute_instance/outputs.tfoutput \"instance_id\" { value = google_compute_instance.instance.instance_id } é€™é‚Šä¸»è¦æ”¾ç½®è¦è¼¸å‡ºçš„å…§å®¹ï¼Œåƒæˆ‘å€‘é€™é‚Šå°±æœƒæŠŠ instance_id çµ¦é¡¯ç¤ºå‡ºä¾†ã€‚\nprojects æˆ‘é€™é‚Šåªç¤ºç¯„ prod çš„éƒ¨åˆ†\nprojects/prod/main.tfmodule \"ian-test\" { source = \"../../module/google_compute_instance\" project_id = \"é¦¬è³½å…‹\" instance_name = \"test-prod\" machine_type = \"e2-small\" instance_zone = \"asia-east1-b\" instance_tags = [] instance_labels = { \"aaa\" = \"test1\" \"bbb\" = \"test2\" \"ccc\" = \"test3\" } boot_disk_image_name = \"debian-cloud/debian-10\" boot_disk_size = \"50\" attached_disk_enabled = false network_name = \"é¦¬è³½å…‹\" subnetwork_name = \"é¦¬è³½å…‹\" nat_ip_enabled = false metadata = {} resource_policies = [] service_account_email = \"é¦¬è³½å…‹\" service_account_scopes = [\"storage-ro\", \"logging-write\", \"monitoring-write\", \"service-control\", \"service-management\", \"trace\"] } é€™é‚Šæˆ‘å€‘å¯ä»¥å®šç¾©è¦ä½¿ç”¨ module çš„å«ä»€éº¼ï¼Œé€™é‚Šæˆ‘å°±å–å google_compute_instanceï¼Œç„¶å¾Œä»–æœƒå» source \"../../module/ian-test\"ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘å‰›å‰›åœ¨ä¸Šé¢å…ˆæŒ–æ´çš„æ¨¡æ¿ï¼Œåº•ä¸‹å°±é–‹å§‹å¸¶å…¥æˆ‘å€‘åœ¨ variables.tf æœ‰è¨­å®šçš„åƒæ•¸ã€‚é€™é‚Šæ¯”è¼ƒè¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ main.tfã€variables.tf æœ‰ä½¿ç”¨çš„è®Šæ•¸è¨­å®šï¼Œéƒ½å¿…é ˆè¦å¯«åœ¨å€‹åˆ¥è³‡æº tf çš„æª”æ¡ˆè£¡é¢ï¼Œæ²’æœ‰çš„å°±å¸¶å…¥å°æ‡‰è³‡æ–™å‹æ…‹çš„ç©ºå€¼ï¼Œä¾‹å¦‚ instance_tagsã€metadataã€resource_policies ç­‰ç­‰ã€‚"},"title":"å¦‚ä½•å°‡ Terraform æ”¹å¯«æˆ module ?"},"/blog/terraform/terraform-tfstate/":{"data":{"":"æ­¤ç¯‡æ˜¯æ¥çºŒä¸Šä¸€ç¯‡ ä»€éº¼æ˜¯ IaC ? Terraform åˆæ˜¯ä»€éº¼ï¼Ÿçš„ Terraform æ–‡ç« ï¼Œæˆ‘å€‘åœ¨ä¸Šä¸€ç¯‡æœ‰æåˆ° terraform apply å®Œå¾Œï¼Œæœƒå¤šä¸€å€‹æª”æ¡ˆ *.tfstateï¼Œé€™å€‹æª”æ¡ˆæ˜¯ç”¨ä¾†å­˜æ”¾æœå‹™ç‹€æ…‹çš„æª”æ¡ˆï¼Œå®ƒåŒ…å«åŸºç¤æ¶æ§‹çš„ç‹€æ…‹å’Œè³‡æºçš„è©³ç´°ä¿¡æ¯ã€‚å‡è¨­å¤§å®¶éƒ½åœ¨è‡ªå·±çš„æœ¬åœ°å» apply åŒä¸€å€‹æœå‹™ï¼Œæœƒå°è‡´æ¯å€‹äººçš„ tfstate æª”æ¡ˆå…§å®¹ä¸åŒï¼Œæœ‰å¯èƒ½å»è¦†è“‹æ‰å…¶ä»–äººå·²ç¶“èª¿æ•´çš„å…§å®¹ï¼Œå› æ­¤æˆ‘å€‘å¿…é ˆå°‡æ­¤ tfstate æª”æ¡ˆå­˜æ”¾åœ¨ä¸€å€‹åœ°æ–¹ï¼Œè®“å¤§å®¶éƒ½å»ä½¿ç”¨åŒä¸€ä»½æª”æ¡ˆä¾†èª¿æ•´è³‡æºã€‚\næˆ‘å€‘å¸¸ç”¨çš„å„²å­˜æ–¹å¼æœƒå°‡ tfstate å­˜åœ¨ gitlab æˆ– gcs (gcp æ¶æ§‹ç‚ºä¾‹)ï¼Œä»¥ä¸‹æœƒç°¡å–®èªªæ˜è¦å¦‚ä½•æŠŠ tfstate å­˜åˆ°å¾Œç«¯ä»¥åŠå„é é¢çš„åŠŸèƒ½ï¼š","gcs#gcs":"gcs å„²å­˜æ¯”è¼ƒç°¡å–®ä¸€é»ï¼Œå› ç‚ºä»–å°±æ˜¯ä¸€å€‹ bucketï¼Œæ‰€ä»¥é é¢å°±è·Ÿä¸€èˆ¬çš„ gcs ä¸€æ¨£ï¼Œæœƒé¡¯ç¤ºæª”æ¡ˆåç¨±ã€å¤§å°ã€é¡å‹ç­‰ï¼Œå¦‚æœéœ€è¦æŸ¥çœ‹ tfstateï¼Œå¯ä»¥é»æ“Šæœ€å¾Œçš„ä¸‹è¼‰æŒ‰éˆ•ä¾†æŸ¥çœ‹\né‚£æˆ‘å€‘æ¥è‘—ä½¿ç”¨ä¸Šé¢ gitlab çš„ç¯„ä¾‹æª”æ¡ˆï¼Œåªæ˜¯è¦å°‡ backend.tf å…§å®¹æ”¹ç‚ºä»¥ä¸‹ï¼š\nbackend.tfterraform { backend \"gcs\" { bucket = \"pid-terraform-state\" prefix = \"/aaa\" } } ä¸Šé¢çš„è¨­å®šæ˜¯æŒ‡ï¼Œæˆ‘å€‘å°‡ backend å¾Œç«¯è¨­å®šæ”¹æˆ gcsï¼Œä¸¦ä¸”é¸æ“‡åç‚º pid-terraform-state çš„ bucketï¼Œæ­¤ bucket éœ€è¦å…ˆæ‰‹å‹•å»ºç«‹(å› ç‚º bucket åç¨±æ˜¯å…¨åŸŸä¸é‡è¤‡ï¼Œæ‰€ä»¥ä¸éœ€è¦ç‰¹åˆ¥è¨­å®šå…¶ project_idï¼Œåªè¦æœ‰æ¬Šé™æ­£ç¢ºéƒ½å¯ä»¥è·¨å°ˆæ¡ˆä½¿ç”¨)ï¼Œä»¥åŠæˆ‘å€‘è¦å°‡æ­¤ tfstate å­˜åœ¨ aaa è³‡æ–™å¤¾å…§ã€‚\næ¥è‘—æˆ‘å€‘é‡æ–°åˆªé™¤å‰›å‰› gitlab å·²ç”¢ç”Ÿçš„ .terraform/ è·Ÿ .terraform.lock.hcl æª”æ¡ˆï¼Œé‡æ–°ä¸‹ initï¼Œå°±å¯ä»¥åˆ° gcs å°æ‡‰è³‡æ–™å¤¾ä¸‹ï¼Œæ–°å¢äº† defaulte.tfstate æª”æ¡ˆã€‚\nç”¢ç”Ÿ defaulte.tfstate\nLock æˆ‘å€‘ä¸€æ¨£ä¾†çœ‹ä¸€ä¸‹ gcs çš„ lock æœƒé•·ä»€éº¼æ¨£å­ï¼Œgcs lock æœƒç”¢ç”Ÿä¸€å€‹ default.tflock æª”æ¡ˆï¼Œç”±ä»–å»åˆ¤æ–·ç¾åœ¨æ˜¯å¦æ˜¯ Lock ç‹€æ…‹\ngcs Lock æœƒå‡ºç¾ .tflock æª”æ¡ˆ\nç•¶æœ‰å…¶ä»–äººä¹ŸåŸ·è¡Œ plan or apply å¾Œï¼Œå°±æœƒé¡¯ç¤ºä»¥ä¸‹ï¼š\ngcs Lock å…¶ä»–äººä¸èƒ½æ“ä½œ","gitlab#gitlab":"é‚£æˆ‘å€‘è¦æ€éº¼æŠŠ tfstate å­˜åˆ° gitlab å‘¢ï¼Ÿé¦–å…ˆè·Ÿä¹‹å‰ä¸€æ¨£ï¼Œå…ˆæ–°å¢ provider.tf ä¾†æ”¾ä¾›æ‡‰å•†çš„ä¾†æºä»¥åŠç‰ˆæœ¬ï¼Œä»¥åŠ main.tf ä¾†æ”¾ gce ç›¸é—œè¨­å®šï¼Œæœ€å¾Œé‚„è¦å¤šä¸€å€‹ backend.tf ä¾†æ”¾æˆ‘å€‘è¦å„²å­˜ tfstate çš„ä½ç½®è¨­å®šï¼Œå¦‚ä¸‹ï¼š(åŒæ­¥åˆ° GitHub éœ€è¦ç¨‹å¼ç¢¼çš„å¯ä»¥å‰å¾€æŸ¥çœ‹)\n(é€™æ¬¡ç¯„ä¾‹æœƒä½¿ç”¨ gceï¼Œæ­¤é …æœƒéœ€è¦ gitlab å…ˆå•Ÿç”¨ Infrastructure åŠŸèƒ½ä»¥åŠå»ºç«‹è‡ªå·±çš„ gitlab token)\nprovider.tfterraform { required_providers { google = { source = \"hashicorp/google\" version = \"~\u003e 4.48.0\" } } } main.tf provider \"google\" { project = \"XXXXX\" zone = \"asia-east1-b\" } resource \"google_compute_instance\" \"instance\" { name = \"test\" machine_type = \"e2-small\" zone = \"asia-east1-b\" labels = { env = \"11\" } boot_disk { initialize_params { image = \"debian-cloud/debian-10\" } } network_interface { network = \"projects/XXXX/global/networks/test\" subnetwork = \"projects/XXXX/regions/asia-east1/subnetworks/testtest\" } } backend.tf Â« æ–°çš„ å°ˆæ¡ˆ ID è¦å¯«æˆ‘å€‘æƒ³è¦æ”¾ terraform state çš„ GitLab Project IDï¼Œæœå‹™åç¨±æ˜¯æŒ‡é¡¯ç¤ºåœ¨ GitLab terraform state çš„åç¨±\ngitlab å€‹äºº token æ˜¯æŒ‡å€‹äººå­˜å–æ¬Šæ–ï¼Œå¤§å®¶å†ä¾ç…§è‡ªå·±çš„ä¾†åšè¨­å®š\nbackend.tfterraform { backend \"http\" { address = \"[Gitlab ç¶²å€]/api/v4/projects/[å°ˆæ¡ˆID]/terraform/state/[æœå‹™åç¨±]\" lock_address = \"[Gitlab ç¶²å€]/api/v4/projects/[å°ˆæ¡ˆID]/terraform/state/[æœå‹™åç¨±]/lock\" unlock_address = \"[Gitlab ç¶²å€]/api/v4/projects/[å°ˆæ¡ˆID]/terraform/state/[æœå‹™åç¨±]/lock\" username = \"[Gitlab å¸³è™Ÿ]\" password = \"[Gitlab å€‹äºº token]\" lock_method = \"POST\" unlock_method = \"DELETE\" retry_wait_min = 5 } } ç•¶æˆ‘å€‘æ–°å¢å¥½å¾Œï¼Œå°±è·Ÿä¹‹å‰æ­¥é©Ÿä¸€æ¨£ï¼Œå…ˆ init \u003e plan \u003e apply ä¾†åšæ¸¬è©¦ï¼Œåœ¨ init æ™‚æœƒç™¼ç¾ï¼Œèˆ‡ä¹‹å‰ä¸å¤ªä¸€æ¨£çš„æ˜¯ï¼Œåœ¨ Initializing the backend çš„ä¸‹æ–¹æœ‰å¤šäº†ç¶ è‰²çš„æˆåŠŸè¨­å®šå¾Œç«¯å­—æ¨£ï¼Œä»£è¡¨ä»–ä¹Ÿæœƒå°‡å¾Œç«¯çš„ç›¸é—œè³‡è¨Šå­˜é€² .terraform è³‡æ–™å¤¾ä¸­ï¼Œæ‰€ä»¥æœ‰è®Šæ›´å¾Œç«¯å„²å­˜ä½ç½®ï¼Œè¦è¨˜å¾—é‡æ–° init æ­\ninit åˆå§‹åŒ–å¾Œï¼Œæœƒå°‡å¾Œç«¯è³‡è¨Šä¹Ÿå­˜åˆ° .terraform è³‡æ–™å¤¾\nç•¶æˆ‘å€‘ plan \u003e apply å®Œæˆå¾Œï¼Œå¯ä»¥è§€å¯Ÿä¸€ä¸‹ï¼Œç™¼ç¾åŸæœ¬æœƒç”¢ç”Ÿçš„ terraform.tfstate æª”æ¡ˆæ²’æœ‰å‡ºç¾åœ¨è©²ç›®éŒ„ä¸‹ï¼š\napply å®Œï¼Œæ²’æœ‰åœ¨æœ¬åœ°ç”¢ç”Ÿ .tfstate æª”æ¡ˆ\né€™æ™‚å€™ï¼Œæˆ‘å€‘å¯ä»¥åˆ°å‰›å‰›åœ¨ä¸Šé¢è¨­å®šçš„å°ˆæ¡ˆ ID å…§çš„æœ‰ä¸€å€‹ Infrastructure / Terraformï¼Œè£¡é¢å°±æœƒå­˜æ”¾ Terraform state æª”æ¡ˆï¼Œå¦‚ä¸‹ï¼š\ngitlab/Infrastructure/Terraform\næœƒé¡¯ç¤ºç‹€æ…‹åç¨±ã€æ›´æ–°è³‡è¨Šã€ä»¥åŠ Actions ç­‰æ¬„ä½ï¼š\ngitlab terraform tfstate ç¶²é \nåŠŸèƒ½éƒ¨åˆ†å¯ä»¥çœ‹å¾Œé¢çš„ Actions æ¬„ä½åº•ä¸‹æœ‰ä¸‰å€‹é»é»ï¼Œå¯ä»¥ä¸‹è¼‰å°æ‡‰çš„ tfstate æª”æ¡ˆã€Lock è®“å…¶ä»–äººä¸èƒ½å°æ­¤é€²è¡Œ applyï¼Œæˆ–æ˜¯åˆªé™¤æ­¤ tfstate æª”æ¡ˆç­‰\ngitlab terraform tfstate åŠŸèƒ½èªªæ˜\né€™æ¨£æˆ‘å€‘å°±å¯ä»¥é€éåŒä¸€ä»½çš„ tfstate æª”æ¡ˆä¾†åšç®¡ç†ï¼Œä½†æœ‰å€‹å‰ææ˜¯ï¼Œä¹‹å¾Œå°è©²è³‡æºçš„è®Šæ›´éƒ½åªèƒ½ä½¿ç”¨ tfï¼Œå¦‚æœé‚„æœ‰ç”¨ WEB UI å»èª¿æ•´ï¼Œå°±æœƒé‡åˆ°ç·šä¸Šæœå‹™èˆ‡ tfstate å„²å­˜ç‹€æ…‹ä¸åŒçš„å•é¡Œã€‚\nLock é‚£ç•¶æˆ‘å€‘å·²ç¶“æœ‰äº†å…±åŒå„²å­˜çš„åœ°æ–¹ï¼Œä¹Ÿæºé€šå¥½ï¼Œä¸æœƒä½¿ç”¨ WEB UI å»èª¿æ•´ï¼Œä½†å¦‚æœæœ‰å…©å€‹äººåŒæ™‚å»ä¸‹ apply çš„è©±ï¼Œç¬¬ä¸€å€‹äººçš„ apply é‚„åœ¨åŸ·è¡Œï¼Œå¾Œé¢é‚£å€‹äººçš„ apply æ˜¯ä¸æ˜¯å°±æœƒè“‹æ‰å‰ä¸€å€‹äººçš„è¨­å®šå‘¢ï¼Ÿ\næ‰€ä»¥ Terraform åœ¨ 0.14 ç‰ˆæœ¬æ¨å‡ºäº† Lock åŠŸèƒ½ï¼Œç•¶æœ‰äººåœ¨ plan or apply çš„æ™‚å€™ï¼Œæˆ‘å€‘å»æŸ¥çœ‹ gitlab Terraform stateï¼Œæœƒçœ‹åˆ°æˆ‘å€‘çš„ tfstate æª”æ¡ˆæœƒè¢« Lock èµ·ä¾†\nGitLab Lock é–ä½\næ­¤æ™‚é™¤äº†ç¬¬ä¸€å€‹æ“ä½œè€…ï¼Œå…¶ä»–äººå†å» plan or apply å°±æœƒå‡ºç¾éŒ¯èª¤ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯èª°æ­£åœ¨ä½¿ç”¨ï¼Œä»¥åŠæ“ä½œçš„å‹•ä½œæ˜¯ plan or apply\nåœ¨ Lock ä¸‹ï¼Œå…¶ä»–äººæ²’è¾¦æ³•å» plan or apply\nåœ¨ CI æ™‚ï¼Œéœ€è¦åœ¨ plan æ™‚å°±å°‡å®ƒçµ¦ lockï¼Œé¿å…ç¬¬ä¸€å€‹äºº plan å®Œï¼Œæ²’æœ‰åŠæ™‚çš„å»åŸ·è¡Œ applyï¼Œå¾Œä¾†æœ‰å…¶ä»–äººæ¯”ç¬¬ä¸€å€‹äººå…ˆèª¿æ•´äº†è³‡æºï¼Œç¬¬ä¸€å€‹äººå†ä¾†åŸ·è¡Œ applyï¼Œå°±æœƒå°è‡´ç¬¬ä¸€å€‹äºº apply çš„å…§å®¹èˆ‡è‡ªå·±åŸå…ˆçœ‹ plan çš„å…§å®¹æœƒä¸åŒï¼Œä¹Ÿæœ‰å¯èƒ½æœƒå°‡ä¸Šä¸€å€‹äººèª¿æ•´çš„è¨­å®šçµ¦è¦†è“‹ï¼Œç•¶ç¬¬ä¸€å€‹æ“ä½œè€…çµæŸå‹•ä½œå¾Œï¼Œè©² Lock æ‰æœƒè¢«è§£é–ã€‚\nå…¶ä»– gitlab terraform state è©³ç´°å…§å®¹å¯ä»¥åƒè€ƒï¼šhttps://docs.gitlab.com/ee/user/infrastructure/iac/terraform_state.html"},"title":"Terraform å¦‚ä½•å¤šäººå…±åŒé–‹ç™¼ (å°‡ tfstate å­˜åœ¨å¾Œç«¯)"},"/blog/terraform/terraform/":{"data":{"":"è·Ÿä¸Šä¸€ç¯‡ Snyk ä¸€æ¨£ï¼Œæœ¬ç³»åˆ—ä¹Ÿæ˜¯å»åƒåŠ  DevOpsDay Taipei 2022 æ´»å‹•è½åˆ°å„ä½ç”¢æ¥­å¤§ä½¬ç›®å‰åœ¨ä½¿ç”¨çš„åè©ä»¥åŠæŠ€è¡“ï¼Œæƒ³èªªå›å®¶ä¹Ÿå……å¯¦ä¸€ä¸‹è‡ªå·±ï¼Œäº†è§£ä¸€ä¸‹åœ¨ DevOpsDay æœ€å¸¸å‡ºç¾çš„ IaC æ˜¯ä»€éº¼ï¼Ÿä»¥åŠè½èªªå¾ˆæ–¹ä¾¿çš„ Terraform åˆæ˜¯ä»€éº¼ï¼Œå°‡å­¸ç¿’çš„éç¨‹æ‰“æˆæ­¤ç¯‡ç­†è¨˜ï¼Œæ­¡è¿å¤§å®¶å¤šäº¤æµï¼Œé‚£æˆ‘å€‘å°±é–‹å§‹å›‰ã€‚\nç›®å‰æ‰“ç®—å¯«æœ¬ç¯‡ä»‹ç´¹ IaC ä»¥åŠ Terraform ä»¥å¤–ï¼Œä¹‹å¾Œé‚„æƒ³å¯«å¦å¤–å…©ç¯‡èªªæ˜ Terraform å¦‚ä½•å…±åŒç¶­è­·é–‹ç™¼(å°‡ .tfstate æª”æ¡ˆå­˜åœ¨ gitlab or gcs ä¸Š)ã€æ€éº¼æŠŠ Terraform è½‰æˆ moduleï¼Œæœ€å¾Œå°å…¥ Terragrunt é”åˆ° DRY ç­‰ç­‰ï¼Œä¹Ÿæœƒæœ‰ç”¨ Terraform å»ºç«‹ GCE ä»¥åŠ GKEã€‚å¤§å®¶å¯ä»¥æŒçºŒé—œæ³¨æ­¤ç¯‡æ–‡ç« ï¼Œæœ€å¾Œæœƒåœ¨æ–‡ç« å¾Œé™„ä¸Šé€£çµ ğŸ˜","terraform-åˆæ˜¯ä»€éº¼#Terraform åˆæ˜¯ä»€éº¼ï¼Ÿ":"IaC çš„å·¥å…·æœ‰å¾ˆå¤šç¨®ï¼Œæ¥è‘—æˆ‘å€‘å°±ä¾†ä»‹ç´¹å…¶ä¸­ä¸€å€‹å·¥å…· - Terraformï¼ŒTerraform æ˜¯ä»€éº¼å‘¢ï¼Ÿæ ¹æ“šå®˜ç¶²çš„èªªæ˜å¯ä»¥çŸ¥é“ï¼ŒTerraform æ˜¯ HashiCorp æ‰€é–‹ç™¼çš„åŸºç¤è¨­æ–½å³ä»£ç¢¼å·¥å…·ã€‚å®ƒå¯ä»¥ä½¿ç”¨äººé¡æ–¹ä¾¿è®€çš„é…ç½®æ–‡ä»¶ä¾†å®šç¾©è³‡æºå’ŒåŸºç¤è¨­æ–½ï¼Œä»¥ä¸‹æœ‰ä½¿ç”¨ Terraform å¹¾å€‹å„ªé»ï¼š\nTerraform å¯ä»¥ç®¡ç†å¤šå€‹é›²å¹³å°ä¸Šçš„åŸºç¤æ¶æ§‹ ä½¿ç”¨äººé¡å¯è®€çš„é…ç½®èªè¨€ä¾†å¹«åŠ©æˆ‘å€‘å¿«é€Ÿç·¨å¯«åŸºç¤è¨­æ–½ä»£ç¢¼ å¯ä»¥å°‡é…ç½®æäº¤çµ¦ç‰ˆæœ¬æ§åˆ¶ï¼Œå®‰å…¨åœ°åœ¨åŸºç¤æ¶æ§‹ä¸Šé€²è¡Œå”ä½œ ç®¡ç†ä»»ä½•åŸºç¤è¨­æ–½ Terraform æä¾›æ’ä»¶è®“ Terraform å¯ä»¥é€šéå…¶ API èˆ‡é›²å¹³å°å’Œå…¶ä»–æœå‹™é€²è¡Œäº¤äº’ã€‚HashiCorp å’Œ Terraform ç¤¾å€ç·¨å¯«äº† 3193 å¤šå€‹æä¾›å•†ä¾†ç®¡ç†åƒ AWSã€Azureã€GCPã€Kubernetesã€Helmã€GitHub ç­‰è³‡æºï¼Œå¯ä»¥åˆ° Terraform Registry æŸ¥çœ‹æ›´å¤šå¹³å°æˆ–æœå‹™çš„æä¾›è€…ï¼Œç•¶ç„¶å¦‚æœæ²’æœ‰æ‰¾åˆ°æƒ³è¦çš„æä¾›è€…ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç·¨å¯«è‡ªå·±çš„å¥—ä»¶ã€‚\næ¨™æº–åŒ–éƒ¨ç½²å·¥ä½œæµç¨‹ æä¾›å•†æœƒå°‡åŸºç¤è¨­æ–½çš„æ¯å€‹å–®å…ƒ (ä¾‹å¦‚å»ºç«‹ VM æˆ–æ˜¯ VPC) å®šç¾©ç‚ºè³‡æºã€‚ä½ å¯ä»¥å°‡ä¾†è‡ªä¸åŒæä¾›è€…çš„è³‡æºçµ„åˆï¼Œè®Šæˆæ¨¡çµ„ï¼Œè®“æˆ‘å€‘å¯ä»¥ç”¨ä¸€è‡´çš„èªè¨€å’Œå·¥ä½œæµç¨‹å»ç®¡ç†ä»–å€‘ã€‚\nTerraform ä»€éº¼æ˜¯ Terraform çš„åŸºç¤è¨­æ–½å³ä»£ç¢¼ï¼Ÿ","ä»€éº¼æ˜¯-iac-#ä»€éº¼æ˜¯ IaC ?":"IaC å…¨åæ˜¯ Infrastructure as Code (åŸºç¤è¨­æ–½å³ä»£ç¢¼)ï¼Œå¾å­—é¢æ„æ€å°±å¯ä»¥ç•¥çŸ¥ä¸€äºŒï¼Œä¹Ÿå°±æ˜¯æŠŠåŸºç¤è¨­æ–½è®Šæˆç¨‹å¼ç¢¼ï¼Œåœ¨é‚„æ²’æœ‰é€™äº› IaC å·¥å…·ä¹‹å‰ï¼Œå¤§å®¶éƒ½æ˜¯é–‹å•Ÿ WEB UI ç•«é¢ä¾†é€²è¡Œå»ºç½®æˆ–è¨­å®šï¼Œé›–ç„¶ä½¿ç”¨ UI é»ä¸€é»å°±å»ºå¥½äº†ï¼Œä½†é€™äº›æ­¥é©Ÿéƒ½æ²’æœ‰è¢«ç´€éŒ„ä¸‹ä¾† (git)ï¼Œä¹Ÿæ²’æœ‰è¾¦æ³•é€éå…¶ä»–äººä¸€èµ· Review çš„æ–¹å¼ä¾†é¿å…äººç‚ºæ“ä½œéŒ¯èª¤ã€‚å› æ­¤æœ‰äº† IaC é€™äº›å·¥å…·ï¼Œå¯ä»¥å°‡å¯¦éš›çš„æ“ä½œæµç¨‹ï¼Œè½‰æ›æˆç¨‹å¼ç¢¼æˆ–æ˜¯å…¶ä»–åƒæ˜¯ JSONã€Yaml çš„æ–¹å¼çµ¦ç´€éŒ„ä¸‹ä¾†ï¼Œä»¥ä¸‹æ˜¯å°å…¥ IaC å¸¶ä¾†çš„å¥½è™•ï¼š\nå»ºç½® CI/CD è‡ªå‹•åŒ– (ä¸éœ€è¦å†ä»°è³´ UI é€²è¡Œæ“ä½œ) ç‰ˆæœ¬æ§åˆ¶ (å¤§å®¶å¯ä»¥é€é MR è¦å®š code reviewï¼Œé¿å…å‡ºç¾äººç‚ºéŒ¯èª¤) é‡è¤‡ä½¿ç”¨ (å¯ä»¥å°‡å¸¸ç”¨çš„è®Šæˆåƒæ•¸ä»£å…¥ï¼Œæ¸›å°‘å»ºç½®æ™‚é–“) ç’°å¢ƒä¸€è‡´æ€§ (ä»¥ä¸Š IaC èªªæ˜ä¾†è‡ª å°æƒ¡é­” - åˆæ¢ Infrastructure as Code å·¥å…· Terraform vs Pulumi æ–‡ç« ï¼Œå¯«å¾—çœŸçš„å¾ˆå¥½ï¼Œæ¨æ¨)\nInfrastructure as Code åˆå¿ƒä¼æœè¡Œç ”07ï¼šè®¤è¯†ã€ŒåŸºç¡€è®¾æ–½å³ä»£ç ã€(Infrastructure as Code) â€” åˆå¿ƒå†…å‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"åˆæ¢ Infrastructure as Code å·¥å…· Terraform vs Pulumiï¼šhttps://blog.wu-boy.com/2021/02/introduction-to-infrastructure-as-code-terraform-vs-pulumi/\nä»Šæ™šæˆ‘æƒ³èªè­˜ Terraformï¼šhttps://ithelp.ithome.com.tw/articles/10233759","å®‰è£-terraform#å®‰è£ Terraform":"å®‰è£ Terraform çš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œæˆ‘å°±ä»¥æˆ‘åœ¨ä½¿ç”¨çš„ Mac OS ç‚ºä¾‹ï¼Œå…¶ä»–å¯ä»¥åƒè€ƒ Install Terraformï¼š\nå®‰è£æ­¥é©Ÿ å…ˆå®‰è£ HashiCorp tapï¼Œé€™æ˜¯ HashiCorp åœ¨ Homebrew çš„å„²å­˜åº«ï¼š brew tap hashicorp/tap ä½¿ç”¨ hashicorp/tap/terraform brew install hashicorp/tap/terraform å¦‚ä½•é©—è­‰æ˜¯å¦å®‰è£æˆåŠŸ æ‰“é–‹ä¸€å€‹æ–°çš„ Terminalï¼Œä½¿ç”¨ terraform -help æª¢æŸ¥æ˜¯å¦æœ‰å®‰è£æˆåŠŸï¼Œä¹Ÿå¯ä»¥åœ¨ -help å¾Œé¢åŠ å…¥åƒæ•¸ä¾†æŸ¥çœ‹è©²åƒæ•¸çš„åŠŸèƒ½èˆ‡æ›´å¤šè¨Šæ¯\né©—è­‰ Terraform å®‰è£æˆåŠŸ Install Terraform\nè‡ªå‹•è£œå…¨æŒ‡ä»¤ å¯ä»¥å•Ÿå‹•çµ‚ç«¯æ©Ÿä¸Šçš„ Tab è‡ªå‹•è£œå…¨åŠŸèƒ½ï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œå†é‡é–‹çµ‚ç«¯æ©Ÿï¼Œå°±æœƒå‡ºç¾äº†ï¼š\nterraform -install-autocomplete æƒ³è¦è§£é™¤è‡ªå‹•è£œå…¨ (é›–ç„¶æ‡‰è©²ä¸æœƒæ‹‰)ï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nterraform -uninstall-autocomplete æ”¾ä¸Šæˆæœåœ–ç‰‡\nå¿«é€Ÿå…¥é–€ ç•¶æˆ‘å€‘å®‰è£å¥½ï¼Œæƒ³è¦æœ€å¿«çš„äº†è§£ Terraform ï¼Œç•¶ç„¶æ˜¯è‡ªå·±å‹•æ‰‹åšä¸€æ¬¡ï¼Œæˆ‘å€‘ä¾ç…§å®˜ç¶²çš„æ•™å­¸ï¼Œå¯ä»¥åœ¨ä¸€åˆ†é˜å…§ä½¿ç”¨ Docker é…ç½®å¥½ NGINX ä¼ºæœå™¨ï¼Œé‚£æˆ‘å€‘é–‹å§‹å›‰ï¼\né¦–å…ˆï¼Œæˆ‘å€‘å¿…é ˆè¦å…ˆå®‰è£å¥½ Dockerï¼Œä¸‹è¼‰ Mac ç‰ˆ Docker æ¡Œé¢ å»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ï¼Œä¸¦é€²å…¥è©²è³‡æ–™å¤¾å…§ å°‡ä»¥ä¸‹ Terraform é…ç½®æ–‡ä»¶è²¼åˆ°æª”æ¡ˆä¸­ï¼Œä¸¦å–å main.tfï¼š(åŒæ­¥åˆ° GitHub éœ€è¦ç¨‹å¼ç¢¼çš„å¯ä»¥å‰å¾€æŸ¥çœ‹) provider \"docker\" {} resource \"docker_image\" \"nginx\" { name = \"nginx:1.23\" keep_locally = false } resource \"docker_container\" \"nginx\" { image = docker_image.nginx.name name = \"nginx\" ports { internal = 80 external = 8000 } } å†é–‹ä¸€å€‹æª”æ¡ˆå–åç‚º provider.tfï¼Œå°‡ä»¥ä¸‹é…ç½®æ–‡ä»¶è²¼åˆ°æª”æ¡ˆä¸­ï¼š terraform { required_providers { docker = { source = \"kreuzwerker/docker\" version = \"~\u003e 2.13.0\" } } } (ä»¥ä¸Šç¨‹å¼ç¢¼ä¾†è‡ªå®˜ç¶² å®‰è£ Terraform#å¿«é€Ÿå…¥é–€ åŠ ä¸Šå°ä¿®æ”¹)\nå…ˆä¾†ç°¡å–®èªªæ˜ä¸€ä¸‹ Terraform ç¨‹å¼ç¢¼æ ¼å¼ï¼ŒTerraform çš„æª”æ¡ˆå‰¯æª”åæ˜¯ *.tfï¼Œæ¡ç”¨åç‚º HCL (HashiCorp Configuration Language) çš„çµ„æ…‹èªè¨€ä¾†æè¿°åŸºç¤æ¶æ§‹ã€‚\n(è£œå……èªªæ˜ï¼šåªè¦æ˜¯åŒä¸€å€‹ç›®éŒ„ä¸‹æœ‰ .tf æª”æ¡ˆçµå°¾çš„ï¼ŒTerraform éƒ½æœƒå»åŸ·è¡Œï¼Œæ‰€ä»¥æª”æ¡ˆåç¨±å¯ä»¥è‡ªå·±å–åï¼Œä½†ç‚ºäº†æ–¹ä¾¿ç®¡ç†éƒ½æœƒä½¿ç”¨ mainã€providerã€backendã€output çš„æª”æ¡ˆä¾†æ”¾ç½®å°æ‡‰çš„å…§å®¹)\nHCL æ˜¯ä¸€ç¨®å®£å‘Šå¼çš„èªè¨€ï¼Œè®“ä½ ç›´æ¥å¯«ä¸‹æœŸæœ›çš„åŸºç¤æ¶æ§‹ï¼Œè€Œä¸æ˜¯å¯«ä¸‹éç¨‹çš„æ¯ä¸€å€‹æ­¥é©Ÿã€‚\næª”æ¡ˆä»‹ç´¹ æˆ‘å€‘å…ˆçœ‹ provider.tf æª”æ¡ˆï¼Œæª”æ¡ˆå…§æœƒå…ˆå¯«å¥½éœ€è¦çš„ä¾›æ‡‰å•†ä¾†æºä»¥åŠç‰ˆæœ¬ (ç‰ˆæœ¬æœ‰é»åƒæ˜¯å°æ‡‰ä¾›æ‡‰å•†æä¾›çš„ api ç‰ˆæœ¬)\nterraform { required_providers { ä¾›æ‡‰å•†åç¨± = { source = \"ä¾›æ‡‰å•†ä¾†æº\" version = \"~\u003e æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬\" } } } main.tf æª”æ¡ˆå…§çš„ provider å€å¡Šæœƒå¯«ä¾›æ‡‰å•†çš„ç›¸é—œè¨­å®šï¼Œå‡è¨­æˆ‘å€‘ä½¿ç”¨ google å°±æœƒåœ¨è£¡é¢å…ˆè¨­å®šå¥½ project id ç­‰ã€‚\nresource å€å¡Šæœƒéœ€è¦å¯«é›²ç«¯è³‡æºåç¨±ä»¥åŠè‡ªå®šç¾©çš„åç¨±ï¼Œé›²ç«¯è³‡æºåç¨±é€™é …æ˜¯ä¸å¯ä»¥æ›´æ”¹çš„ï¼Œå‡è¨­æˆ‘å€‘è¦ä½¿ç”¨ docker çš„ container æœå‹™ï¼Œé€™é‚Šå°±éœ€è¦å¡«å¯« docker_containerã€‚è‡ªå®šç¾©çš„åç¨±å¯ä»¥æ˜¯ä½ æƒ³è¦ç‚ºä½¿ç”¨é€™å€‹é›²ç«¯è³‡æºå»å®šç¾©çš„åç¨±ã€‚\nprovider \"ä¾›æ‡‰å•†åç¨±\" {} resource \"é›²ç«¯è³‡æºåç¨±\" \"è‡ªå®šç¾©çš„åç¨±\" { å±¬æ€§ = å€¼ } æ‰€ä»¥æˆ‘å€‘å·²ä¸Šé¢çš„ Docker é…ç½®å¥½ NGINX ä¼ºæœå™¨ç‚ºä¾‹ï¼Œprovider æˆ‘å€‘é€™æ¬¡ä½¿ç”¨çš„æ˜¯ dockerï¼Œ resource æˆ‘å€‘å¯ä»¥æ‹†é–‹ä¾†å¯«ï¼Œ\nåƒæ˜¯ç¬¬ä¸€å€‹ resource docker_image æˆ‘å€‘å¹«ä»–å–å« nginxï¼Œè£¡é¢å°±æ˜¯æ”¾æœ‰é—œ image çš„è¨­å®šï¼Œè©³ç´°çš„ image è¨­å®šå¯ä»¥åƒè€ƒ Resource (docker_image)ï¼Œ\nç¬¬äºŒå€‹ resource docker_container ä¸€æ¨£å« nginxï¼Œè£¡é¢ç”¨çš„ image æ˜¯æ‹¿å‰é¢çš„ docker_image resource name ä¾†ä½¿ç”¨ï¼Œä¸€æ¨£è©³ç´°å¯ä»¥åƒè€ƒ Resource (docker_container)ã€‚\nå°æé†’ï¼Œå¦‚æœä¸çŸ¥é“è¦æ€éº¼å¯« provider ä¾›æ‡‰å•†è¨­å®šï¼Œå¯ä»¥æ‰“é–‹ terraform å®˜ç¶²æ‰¾åˆ°è©²ä¾›æ‡‰å•†ï¼Œé»é¸å³é‚Šçš„ USE PROVIDER\nå®˜æ–¹æ•™å­¸\nå¯ä»¥çœ‹åˆ°å®˜æ–¹æ•™å­¸è¦æ€éº¼ä½¿ç”¨é€™å€‹ä¾›æ‡‰å•†ã€‚\næŒ‡ä»¤èªªæ˜ æ¥è‘—æœ‰å¹¾å€‹æŒ‡ä»¤è¦å¸¶å¤§å®¶èªè­˜ï¼š\nterraform initï¼šåˆå§‹åŒ–é …ç›®ï¼Œä¸‹è¼‰ tf æª”æ¡ˆä¸­æ‰€éœ€è¦çš„å¤–æ›å¥—ä»¶ terraform planï¼šæœƒç”¢ç”Ÿä¸€ä»½åŸ·è¡Œè¨ˆåŠƒã€‚ä¸Šé¢æœƒå¯«è‘—å®ƒå°‡æœƒåšå“ªäº›äº‹ï¼Œä½ å¯ä»¥é©—è­‰æ˜¯å¦ç¬¦åˆä½ é æœŸçš„è¨­è¨ˆ terraform applyï¼šå¯¦éš›é‹ä½œï¼ŒæŠŠåŸºç¤æ¶æ§‹å»ºç½®å®Œæˆã€‚åœ¨å®Œæˆä¹‹å¾Œï¼ŒæœƒæŠŠç›®å‰çš„ç‹€æ…‹å„²å­˜åˆ°ä¸€ä»½æª”æ¡ˆä¸­ (*.tfstate) terraform destroyï¼šæœƒéŠ·æ¯€ç”¨ Terraform èµ·çš„æœå‹™ terraform fmtï¼šå¹«ä½ æ•´ç†å¥½ tf æ–‡ä»¶ terraform validateï¼šéœæ…‹æª¢æŸ¥ tf æ–‡ä»¶ é™„ä¸Šæ‡¶äººæŒ‡ä»¤\nalias ti='terraform init' alias ta='terraform apply' alias tp='terraform plan' alias td='terraform destroy' ç”±æ–¼åœ¨ apply çš„æ™‚å€™æœƒè·³å‡ºè©¢å•è¦–çª—ï¼Œå¦‚æœæ˜¯è¦å¯«æˆè…³æœ¬ï¼Œå¯ä»¥æŠŠæŒ‡ä»¤æ”¹æˆ terraform apply -auto-approve å°±ä¸éœ€è¦è¼¸å…¥ yes äº†ï¼\nå¯¦éš›æ“ä½œ æœ‰ä¸Šé¢çš„æŒ‡ä»¤å¾Œï¼Œæˆ‘å€‘ä¾†å¯¦éš›æ“ä½œçœ‹çœ‹ï¼š\né¦–å…ˆåˆ°è©² main.tf æª”æ¡ˆç›®éŒ„ä¸‹ï¼Œå…ˆä½¿ç”¨ terraform apply ä¾†æ¸¬è©¦çœ‹çœ‹ï¼š ç„¡æ³•ç›´æ¥åŸ·è¡Œ apply\næœƒç™¼ç¾æ²’æœ‰è¾¦æ³•ç›´æ¥ç”¨ terraform apply æŒ‡ä»¤ä¾†å»ºç½®æœå‹™ï¼Œæˆ‘å€‘çœ‹ä¸€ä¸‹ä»–æç¤ºçš„èªªæ˜ï¼Œä»–èªªä»–æ‰¾ä¸åˆ° lock fileï¼Œéœ€è¦å…ˆé€²è¡Œåˆå§‹åŒ–æ‰å¯ä»¥åŸ·è¡Œï¼Œæ‰€ä»¥æˆ‘å€‘çš„å»ºç½®æµç¨‹æ˜¯å…ˆ init â€“\u003e apply\nterraform init æˆ‘å€‘å…ˆåŸ·è¡Œ terraform initï¼Œå¯ä»¥çœ‹åˆ°ä»–æœƒä¸‹è¼‰ tf æª”æ¡ˆä¸­æ‰€éœ€è¦çš„å¤–æ›å¥—ä»¶ (docker) terraform init\nç•¶æˆ‘å€‘åˆå§‹åŒ–å¾Œï¼Œè³‡æ–™å¤¾æœƒå¤šä¸€å€‹æª”æ¡ˆ (.terraform.lock.hcl) ä»¥åŠè³‡æ–™å¤¾ (.terraform)\ninit å‰å¾Œæª”æ¡ˆå·®ç•°\n.terraform.lock.hclï¼šæ˜¯ Terraform ä¸­ç”¨æ–¼é–å®šå’Œç®¡ç†å¤–éƒ¨æä¾›è€…ï¼ˆprovidersï¼‰ç‰ˆæœ¬çš„æª”æ¡ˆã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯ç¢ºä¿åœ¨ä¸åŒçš„ç’°å¢ƒä¸­ä½¿ç”¨ç›¸åŒçš„å¤–éƒ¨æä¾›è€…ç‰ˆæœ¬ï¼Œä»¥é¿å…åœ¨åœ˜éšŠåˆä½œæˆ–ä¸åŒç’°å¢ƒä¸­å¼•å…¥ä¸ä¸€è‡´æ€§å’Œå•é¡Œã€‚\n.terraform/ï¼šè³‡æ–™å¤¾ä¸»è¦ç”¨æ–¼å­˜å„²åˆå§‹åŒ–å’Œç®¡ç†åŸºç¤æ¶æ§‹ç›¸é—œçš„è‡¨æ™‚æ–‡ä»¶ã€‚\nterraform plan æ¥è‘—æˆ‘å€‘ä½¿ç”¨ terraform plan ä¾†æŸ¥çœ‹æˆ‘å€‘çš„è¨ˆåŠƒï¼Œå¯ä»¥çœ‹åˆ°ä»–æœƒåˆ—å‡ºæˆ‘å€‘æ‰€å¯«çš„ tf è£¡é¢æœ‰ç”¨åˆ°çš„ resourceï¼Œé™¤äº†æˆ‘å€‘æœ‰è¨­å®šçš„å±¬æ€§ï¼Œå…¶ä»–çš„å±¬æ€§ä¹Ÿæœƒé¡¯ç¤ºå‡ºä¾†ï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°è®“æˆ‘å€‘çŸ¥é“é€™å€‹ resource æœ‰å“ªäº›å±¬æ€§å¯ä»¥è¨­å®š terraform plan\nterraform apply æœ€å¾Œæˆ‘å€‘æª¢æŸ¥éƒ½æ²’æœ‰å•é¡Œï¼Œå°±å¯ä»¥ä½¿ç”¨ terraform apply ä¾†å»ºç½®ï¼Œapply å…¶å¯¦è·Ÿ plan ä¸€æ¨£éƒ½æœƒå…ˆè®“æˆ‘å€‘çœ‹ä¸€ä¸‹è¨ˆåŠƒï¼Œä½†æœƒè·³å‡ºè©¢å•æ˜¯å¦è¦åŸ·è¡Œï¼Œé™¤éä½ è¼¸å…¥ yesï¼Œå¦å‰‡å°±è·Ÿ plan å–®ç´”é¡¯ç¤ºè¨ˆåŠƒå…§å®¹ï¼Œæœ€å¾Œæˆ‘å€‘å°±å¯ä»¥çœ‹åˆ°ä»–æˆåŠŸåœ¨ docker ä¸Šé¢å»ºç«‹ nginx æœå‹™ terraform apply\næŸ¥çœ‹ docker nginx ä»¥åŠæª¢æŸ¥å…¶æœå‹™\nç•¶æˆ‘å€‘ apply å®Œï¼Œæœå‹™ä¹Ÿå»ºç«‹å¾Œï¼ŒæŸ¥çœ‹ä¸€ä¸‹è³‡æ–™å¤¾å¾Œæœƒç™¼ç¾ï¼Œåˆå¤šäº†ä¸€å€‹æª”æ¡ˆ terraform.tfstateï¼š\nå¤šäº†ä¸€å€‹æª”æ¡ˆ terraform.tfstate\nterraform.tfstateï¼š æ˜¯ Terraform çš„ç‹€æ…‹æª”æ¡ˆï¼Œå®ƒåŒ…å«äº†åŸºç¤æ¶æ§‹çš„ç‹€æ…‹å’Œè³‡æºçš„è©³ç´°ä¿¡æ¯ã€‚é è¨­æƒ…æ³ä¸‹ï¼Œé€™å€‹æª”æ¡ˆæ˜¯æœ¬åœ°çš„ä¸¦ä¸”åªå­˜åœ¨æ–¼ Terraform åˆå§‹åŒ–å’Œæ“ä½œçš„ç›®éŒ„ä¸­ã€‚(ä½†è¦å¦‚ä½•å¯¦ç¾å…±åŒç¶­è­·åŒä¸€å€‹ IaC å‘¢ï¼Œæ•¬å¾…å¾ŒçºŒåˆ†äº« ğŸ¤£)\nterraform destory å¦å¤–ï¼Œç•¶ä½ æƒ³è¦ç§»é™¤æœå‹™æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ terraform destroy ä¾†å°‡æœå‹™çµ¦ç§»é™¤ terraform destroy\nterraform import æœ€å¾Œé‚„æœ‰ä¸€å€‹è »é‡è¦çš„ï¼Œå°±æ˜¯æˆ‘å€‘å·²ç¶“æœ‰å¾ˆå¤šæœå‹™éƒ½æ˜¯ä½¿ç”¨ WEB UI æ–¹å¼å»ºç«‹çš„æœå‹™ï¼Œé‚£æˆ‘å€‘è¦æ€éº¼æŠŠå®ƒè®Šæˆ tf æª”æ¡ˆå‘¢ï¼Ÿ è·Ÿæˆ‘å€‘å‰›å‰›èªªçš„ terraform.tfstate æª”æ¡ˆæœ‰é—œï¼Œä»–æœƒå„²å­˜æˆ‘å€‘ IaC çš„ç‹€æ…‹ï¼Œæ‰€ä»¥æˆ‘å€‘æ‰å¯ä»¥é€éä»–çŸ¥é“ç¾åœ¨æ˜¯å°è³‡æºåšæ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤å“ªå€‹æ“ä½œ\né‚£ç•¶é€™å€‹æª”æ¡ˆä¸è¦‹æ™‚ï¼Œå¦‚æœå†é‡æ–°ä¸‹ terraform applyï¼Œä»–æœƒèªç‚ºä½ æ˜¯æ–°å¢ç‹€æ…‹ï¼Œä½†å¯¦éš›ä¸Š docker æœå‹™é‚„æ˜¯å•Ÿå‹•çš„ç‹€æ…‹ï¼Œæ‰€ä»¥å°±æœƒéŒ¯èª¤ï¼Œæœƒè·Ÿä½ èªªä»–å·²ç¶“å­˜åœ¨ã€‚\næ¸¬è©¦æ²’æœ‰ terraform.tfstate ç›´æ¥ä¸‹ terraform apply\næ‰€ä»¥é€™æ™‚å€™æˆ‘å€‘è¦æŠŠç·šä¸Šæœå‹™çš„è³‡æºè½‰æˆ tf ï¼Œç¬¬ä¸€æ­¥è¦å…ˆæŠŠ resource çš„æ¡†æ¶çµ¦å¯«å‡ºä¾†ï¼Œå…¶ä»–å¯ä»¥å…ˆç•™ç©ºç™½ï¼Œå¦‚ä¸‹ main.tfï¼š\nprovider \"docker\" {} resource \"docker_image\" \"nginx\" { name = \"nginx:1.23\" keep_locally = false } resource \"docker_container\" \"nginx\" { } æ¥è‘—ä½¿ç”¨ terraform import ä¾†å°‡ç·šä¸Šæœå‹™çš„è³‡æºå¥—ç”¨åˆ°æˆ‘å€‘ main.tf è£¡é¢çš„ resourceï¼Œæ‰€ä»¥æœƒé•·å¾—åƒï¼š\nterraform import docker_container.nginx 7f363ea3f6a64b5432ae3627f490b3e297abf80f196bce9c028ec2eb82706f12 import å¾Œé¢æœƒåŠ ä¸Š main.tf resource åç¨± docker_containerï¼Œä»¥åŠæˆ‘å€‘å–åçš„ nginxï¼Œæœ€å¾Œå¸¶ container id (docker ps æŸ¥è©¢)ï¼Œå°±å¯ä»¥åŒ¯å‡º terraform.tfstate æª”æ¡ˆå›‰ï¼Œè©³ç´°çš„ import å¯ä»¥åƒè€ƒæ¯å€‹ä¾›æ‡‰å•†è³‡æºçš„ç¶²é (é€™é‚Šä»¥ docker ç‚ºä¾‹)\nterraform import åŒ¯å‡º terraform.tfstate\nterraform show ç•¶æˆ‘å€‘åŒ¯å‡ºå¾Œï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ terraform.tfstateï¼Œå®ƒæœƒæ˜¯ä¸€å€‹ json æ ¼å¼ï¼Œå¦‚æœè¦è½‰æˆ tf æ ¼å¼ï¼Œé‚„éœ€è¦ä½¿ç”¨ terraform show ä¾†å°‡ terraform.tfstate æª”æ¡ˆè½‰æˆ tf æ ¼å¼ï¼Œå¦‚ä¸‹ï¼š\nterraform show å°‡ terraform.tfstate è½‰æˆ tf\nå¦‚æœé€éä¸Šè¿°çš„æ–¹å¼ä¾†è½‰æˆ tfï¼Œæœƒç™¼ç¾åœ¨é‡æ–° apply æ™‚ï¼Œæœƒå‡ºç¾éŒ¯èª¤ï¼Œé€™é‚Šä»¥ gce çš„ç•¶ç¯„ä¾‹ï¼Œè½‰å®Œçš„ tf è¨­å®šï¼Œæœ‰äº›æ˜¯ tf ä¸æ”¯æ´çš„åƒæ•¸ï¼Œåªæœƒé¡¯ç¤ºåœ¨ tfstateï¼Œæ‰€ä»¥é‚„éœ€è¦æ‰‹å‹•åˆªé™¤ã€‚\nè½‰æ›å¾Œé‚„éœ€å°‡ä¸ç”¨çš„è¨­å®šçµ¦ç§»é™¤"},"title":"ä»€éº¼æ˜¯ IaC ? Terraform åˆæ˜¯ä»€éº¼ï¼Ÿ"},"/blog/terraform/terragrunt/":{"data":{"":"æˆ‘å€‘æ¥çºŒä¸Šä¸€ç¯‡çš„ å¦‚ä½•å°‡ Terraform æ”¹å¯«æˆ module ? ï¼Œæˆ‘å€‘å·²ç¶“å°‡ Terraform æ”¹æˆ module çš„æ–¹å¼ä¾†é€²è¡Œç®¡ç†ï¼Œä½†ç•¶æˆ‘å€‘è¦ç®¡ç†çš„è³‡æºè¶Šä¾†è¶Šå¤šï¼Œä¸”æœ‰åˆ†ä¸åŒçš„å°ˆæ¡ˆæ™‚ï¼Œæ•´å€‹æœå‹™æ¶æ§‹æœƒé•·çš„åƒä»¥ä¸‹ï¼š\nmodules google_compute_instance main.tf outputs.tf variables.tf projects gcp-1234 aaa backend.tf main.tf provider.tf bbb backend.tf main.tf provider.tf ccc backend.tf main.tf provider.tf gcp-2345 aaa backend.tf main.tf provider.tf bbb backend.tf main.tf provider.tf ccc backend.tf main.tf provider.tf gcp-3456 aaa backend.tf main.tf provider.tf bbb backend.tf main.tf provider.tf ccc backend.tf main.tf provider.tf é€™é‚Šçš„ç¯„ä¾‹æ˜¯ä»¥ä¸åŒå°ˆæ¡ˆä¾†åˆ†ï¼Œå†åˆ†å€ä¸åŒçš„æœå‹™ï¼Œæ¯å€‹æœå‹™è£¡é¢éƒ½æœƒæœ‰ backend.tfã€main.tfã€provider.tf æª”æ¡ˆæ‰€çµ„æˆï¼Œæˆ‘å€‘å¯ä»¥ä¾†æ¯”è¼ƒä¸€ä¸‹ gcp-1234 çš„ aaa æœå‹™ä»¥åŠ gcp-2345 çš„ aaa æœå‹™å·®ç•°ï¼š\næª”æ¡ˆå·®ç•°\nå¯ä»¥çœ‹åˆ°åœ¨ backend.tf é™¤äº† prefix è·¯å¾‘ä»¥å¤–ï¼Œå…¶ä»–è¨­å®šä¹Ÿéƒ½ä¸€æ¨£ï¼Œä½†å› ç‚º Terraform æœ¬èº«æ²’è¾¦æ³•é€éå¸¶å…¥åƒæ•¸çš„æ–¹å¼ä¾†è¨­å®š backend.tf å¾Œç«¯éƒ¨åˆ†ï¼Œæ‰€ä»¥å¿…é ˆè¦å…ˆå¯«å¥½æ¯å€‹æœå‹™æ‰€å­˜æ”¾çš„å¾Œç«¯ä½ç½®ï¼Œååˆ†çš„ä¸æ–¹ä¾¿ã€‚\nbackend.tfterraform { backend \"gcs\" { bucket = \"terragrunt-tfstate\" prefix = \"/gcp-1234-aaa\" } } ç‚ºäº†æ¸›å°‘ä¸Šè¿°é€™äº›éœ€è¦ä¸€ç›´é‡è¤‡å¯«å·®ä¸å¤šæª”æ¡ˆçš„å·¥ä½œå…§å®¹ï¼Œå› æ­¤æœ‰äº† Terragrunt é€™å€‹å·¥å…·ï¼ŒTerragrunt æ˜¯ Terraform çš„åŒ…è£å™¨ï¼Œå¯ä»¥å½Œè£œ Terraform ä¸Šçš„ä¸€äº›ç¼ºé™·ï¼Œä¸¦ä¸”è®“æˆ‘å€‘çš„ IaC æ›´è²¼è¿‘ DRY åŸå‰‡ã€‚\né€™é‚Šèªªæ˜ä¸€ä¸‹ DRY åŸå‰‡\nDRY å…¨åæ˜¯ Donâ€™t repeat yourselfï¼Œä¹Ÿå°±æ˜¯ä¸è¦åšé‡è¤‡çš„äº‹æƒ…ï¼Œèƒ½å¤ ä¸€æ¬¡åšå®Œçš„å°±ä¸è¦é‡è¤‡çš„å»åšã€‚","terragrunt-å¥½è™•#Terragrunt å¥½è™•":"\næ¥è‘—ä»‹ç´¹ä¸€ä¸‹ Terragrunt çš„å¥½è™•ï¼š\næ–¹ä¾¿ç®¡ç†å¾Œç«¯ç‹€æ…‹è¨­å®š\nå°‡å¾Œç«¯å­˜å„²æ¡¶ç´å…¥ç®¡ç†\nä½¿ç”¨ generate è‡ªå‹•ç”Ÿæˆæª”æ¡ˆ\nä½¿ç”¨ include æª”æ¡ˆä¾†é”åˆ° DRY åŸå‰‡\nç®¡ç† Module ä¹‹é–“çš„ä¾è³´æ€§\nç”¢ç”Ÿä¾è³´é—œè¯åœ–\næ–¹ä¾¿ç®¡ç†å¾Œç«¯ç‹€æ…‹è¨­å®š é¦–å…ˆç¬¬ä¸€å€‹æ–¹ä¾¿ç®¡ç†å¾Œç«¯ç‹€æ…‹è¨­å®šï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘ä¸Šé¢æåˆ°çš„ backend.tf è¨­å®šã€‚åœ¨ Terraform åŸç”Ÿç‚ºäº†å€åˆ¥ä¸åŒå°ˆæ¡ˆä¸åŒæœå‹™çš„ç‹€æ…‹æª”ï¼Œå°±å¿…é ˆå…ˆå¯«å¥½æ¯å€‹å„²å­˜çš„è·¯å¾‘ï¼Œä½†ä½¿ç”¨ Terragruntï¼Œå¯ä»¥å…ˆåœ¨è©²ç›®éŒ„ä¸‹ï¼Œä¹Ÿå°±æ˜¯ gcp-3456 ç›®éŒ„ä¸‹å…ˆå¯«ä¸€å€‹è¨­å®šæª”æ¡ˆ (æˆ‘å€‘ä»¥ gcp-3456 å°ˆæ¡ˆç‚ºä¾‹)ï¼Œè®“åº•ä¸‹çš„ aaaã€bbbã€ccc æœå‹™å¯ä»¥å» include å®ƒï¼Œæˆ‘å€‘å°±ä¸éœ€è¦æ¯å€‹æœå‹™éƒ½å¯«å¹¾ä¹å·®ä¸å¤šçš„è¨­å®šæª”ï¼Œæ¥è‘—æˆ‘å€‘åœ¨ gcp-3456 è³‡æ–™å¤¾ä¸‹æ–°å¢ terragrunt.hcl æª”æ¡ˆä¾†èªªæ˜ï¼š\nterragrunt.hclremote_state { backend = \"gcs\" generate = { path = \"backend.tf\" if_exists = \"overwrite\" } config = { bucket = \"terragrunt-tfstate\" prefix = \"${path_relative_to_include()}\" } } é€™é‚Šçš„è¨­å®šå…¶å¯¦è·Ÿä¹‹å‰çš„ backend.tf å·®ä¸å¤šï¼Œåªæ˜¯å¾Œç«¯ç¾åœ¨å„²å­˜çš„ block æ”¹å«åš remote_stateï¼Œå¯ä»¥çœ‹åˆ° backend è¨­å®šæˆ‘å€‘ä¸€æ¨£æ˜¯å­˜åœ¨ gcs ä¸Šï¼Œgenerate é€™å€‹ block å®ƒæœƒåˆ¤æ–· backend.tf æª”æ¡ˆæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ²’æœ‰å®ƒå°±æœƒå¹«æˆ‘å€‘å»ºç«‹ï¼Œå…¶ä¸­è¨­å®šæª”æ¡ˆå…§å®¹æ˜¯å°‡ç‹€æ…‹æª”æ¡ˆå­˜åœ¨ terragrunt-tfstate é€™å€‹ bucketï¼Œä¸¦é€é${path_relative_to_include()} é€™å€‹è®Šæ•¸ä¾†è‡ªå‹•å¸¶å…¥æœ‰ include é€™ä»½æª”æ¡ˆçš„è·¯å¾‘ï¼Œä¸¦åœ¨ç›¸å°è·¯å¾‘ç”¢ç”Ÿ backend.tf æª”æ¡ˆã€‚\næœ‰é»æŠ½è±¡ï¼Œæ‰€ä»¥æˆ‘ç•«ä¸€å€‹æ¯”è¼ƒç°¡å–®çš„æ¶æ§‹åœ–ä¾†åšèªªæ˜ä¸€ä¸‹ï¼Œå‡è¨­ç¾åœ¨æœ‰ä¸‰å€‹æœå‹™ï¼Œå¦‚ä¸‹ï¼š\naaa terragrunt.hcl bbb terragrunt.hcl ccc terragrunt.hcl terragrunt.hcl æˆ‘å€‘å‰›å‰›çš„å¾Œç«¯è¨­å®šæ˜¯å¯«åœ¨æ­¤æ ¹ç›®éŒ„çš„ terragrunt.hcl æª”æ¡ˆ(ç¬¬ 8 è¡Œ)ï¼Œç„¶å¾Œ ccc é€™å€‹æœå‹™å» include æ ¹ç›®éŒ„çš„ terragrunt.hcl æª”æ¡ˆï¼Œ Terragrunt å°±æœƒè‡ªå‹•å¹«ä½ ç”¢ç”Ÿä»¥ä¸‹çš„ backend.tf æª”æ¡ˆï¼š\nbackend.tfterraform { backend \"gcs\" { bucket = \"terragrunt-tfstate\" prefix = \"/ccc\" } } é€™æ¨£å°±å¯ä»¥çœä¸‹æˆ‘å€‘è¦é‡è¤‡å¯« backend.tf çš„æ™‚é–“ï¼Œåœ¨ç¶­è­·ä¸Šä¹Ÿæœƒæ›´åŠ çš„æ–¹ä¾¿ã€‚\nå°‡å¾Œç«¯å­˜å„²æ¡¶ç´å…¥ç®¡ç† æ¥è‘—ï¼Œå¤§å®¶æœ‰æ²’æœ‰æƒ³éï¼Œæˆ‘å€‘éƒ½å·²ç¶“ä½¿ç”¨ Terraform ä¾†ç®¡ç† IaC ï¼Œä¸¦æŠŠç‹€æ…‹æª”æ¡ˆæ”¾åˆ° gcs ä¸Šé¢ä¾†ä¿å­˜ï¼Œä½†ä¸€é–‹å§‹é‚„æ²’æœ‰ç”¨ Terraform ç®¡ç† gcs çš„è³‡æºï¼Œæˆ‘å€‘é‚„éœ€è¦åœ¨è¨­å®š backend.tf å‰ï¼Œå…ˆæ‰‹å‹•å»æ–°å¢ä¸€å€‹ gcs ï¼Œæ‰èƒ½ä¾†å­˜æ”¾ tfstate ç‹€æ…‹æª”æ¡ˆå‘¢ï¼Ÿ\nå› æ­¤åœ¨ Terragrunt remote_state çš„ config æ™‚ï¼Œå¯ä»¥å¤šè¨­å®š gcs çš„ project id ä»¥åŠ locationï¼ŒTerragrunt åœ¨åˆå§‹åŒ–å¾Œç«¯æ™‚ï¼Œæœƒæª¢æŸ¥æ˜¯å¦æœ‰è©² gcs bucketï¼Œå¦‚æœæ²’æœ‰å°±æœƒè‡ªå‹•å»ºç«‹ï¼Œè¨­å®šæª”å¦‚ä¸‹ï¼š\nterragrunt.hclremote_state { backend = \"gcs\" generate = { path = \"backend.tf\" if_exists = \"overwrite\" } config = { project = \"gcp-xxxxxx\" location = \"asia\" bucket = \"terragrunt-tfstate\" prefix = \"${path_relative_to_include()}\" } } ä½¿ç”¨ generate è‡ªå‹•ç”Ÿæˆæª”æ¡ˆ åœ¨å‰›å‰›æˆ‘å€‘å¯ä»¥ä½¿ç”¨ generate ä¾†è‡ªå‹• backend.tf æª”æ¡ˆï¼Œé‚£ä»£è¡¨æˆ‘å€‘ä¹Ÿå¯ä»¥æŠŠæ¯å€‹ provider.tf çš„å…§å®¹ï¼Œä¹Ÿé€é generate ä¾†ç”Ÿæˆï¼Œå¦‚ä¸‹ï¼š\nterragrunt.hclgenerate \"provider\" { path = \"provider.tf\" if_exists = \"overwrite\" contents = \u003c\u003cEOF terraform { required_providers { google = { source = \"hashicorp/google\" version = \"~\u003e 4.48.0\" } } } EOF } é€™æ¨£å­æ¯å€‹ include é€™ä»½è¨­å®šæª”çš„æœå‹™é™¤äº† backend.tf æª”æ¡ˆä»¥å¤–ï¼Œé‚„æœƒè‡ªå‹•ç”¢ç”Ÿ provider.tf æª”æ¡ˆã€‚\nä½¿ç”¨ include æª”æ¡ˆä¾†é”åˆ° DRY åŸå‰‡ æˆ‘å€‘æå®šäº† backend.tf è·Ÿ provider.tf å¾Œï¼Œé‚„å‰©ä¸‹ main.tfï¼Œæ‰€ä»¥æˆ‘å€‘ä¹Ÿå°‡å®ƒæ”¹æˆ Terragrunt çš„æ ¼å¼å¦‚ä¸‹ï¼š\nterragrunt.hclterraform { source = \"${get_path_to_repo_root()}/modules/google_compute_instance\" } include \"root\" { path = find_in_parent_folders() } inputs = { instance_name = \"gcp-3456-ccc\" machine_type = \"e2-small\" instance_zone = \"asia-east1-b\" instance_tags = [] instance_labels = {} boot_disk_auto_delete = true boot_disk_image_name = \"debian-cloud/debian-10\" ... è¨­å®šéƒ¨åˆ†çœç•¥ ... } é€™é‚Šå¯ä»¥çœ‹åˆ° terraform source å®ƒå°±æ˜¯æˆ‘å€‘ä½¿ç”¨ module çš„è·¯å¾‘ï¼Œä¹Ÿå¯ä»¥ç”¨ ${get_path_to_repo_root()} é€™å€‹è®Šæ•¸ä»–æœƒè‡ªå‹•æŠ“è©²å°ˆæ¡ˆçš„æ ¹ç›®éŒ„ï¼Œæˆ‘å€‘å°±ä¸éœ€è¦å»ç‰¹åˆ¥è¨­å®šã€‚\næ­¤å¤–ä¹Ÿå¯ä»¥å°‡ module ç¨ç«‹æˆä¸€å€‹å°ˆæ¡ˆï¼Œæˆ–æ˜¯ä½¿ç”¨å…¶ä»–äººå¯«å¥½çš„ moduleï¼Œåœ¨ source çš„æ™‚å€™å¯ä»¥ä½¿ç”¨ git::https://[gitlab-ç¶²å€]/sre/terraform/module.git//google_compute_address çš„æ–¹å¼ä¾†å–å¾— moduleï¼Œå¯ä»¥è¨­å®šè¦ä½¿ç”¨å“ªå€‹åˆ†æ”¯æˆ–æ˜¯ tagï¼Œåªéœ€è¦åœ¨ç¶²å€å¾Œé¢åŠ ä¸Šï¼Œ?ref=[åˆ†ä¹‹ or tag åç¨±] å³å¯ï¼Œé€™æ¨£å¯ä»¥è®“é–‹ç™¼ä¸­çš„ module ä¸æœƒå½±éŸ¿åˆ°ç·šä¸Šå…¶ä»–æ­£åœ¨ä½¿ç”¨ä¸­çš„ module è¨­å®šã€‚\n(module.git å¾Œé¢çš„ // æ˜¯ Terraform module source çš„è¦å‰‡ï¼Œå¦‚æœä¸åŠ æœƒè·³è­¦å‘Šè¨Šæ¯)\næ¥è‘—æˆ‘å€‘å¯ä»¥çœ‹åˆ° include \"root\" {} é€™æ®µï¼Œè£¡é¢æœ‰ä½¿ç”¨ find_in_parent_folders é€™é‚Šè®Šæ•¸ï¼Œä»–å°±æ˜¯ä¸Šé¢çš„æåˆ°æœƒè‡ªå‹•å»æŠ“æ”¾åœ¨çˆ¶è³‡æ–™å¤¾çš„ remote_state è·Ÿ generate terragrunt.hcl æª”æ¡ˆã€‚\nå¾Œé¢çš„ input å°±è·Ÿä½¿ç”¨ module æ™‚ä¸€æ¨£ï¼Œå°‡ module çš„åƒæ•¸å¸¶å…¥å³å¯ã€‚\nè£œå……ï¼šæ‰€ä»¥æˆ‘å€‘ä¹Ÿå¯ä»¥æŠŠä¸€äº›é€šç”¨çš„è¨­å®šå¯«åœ¨æ ¹ç›®éŒ„çš„ terragrunt.hcl æª”æ¡ˆï¼Œä¾‹å¦‚å°ˆæ¡ˆçš„ idï¼Œå¯ä»¥å¯«ä»¥ä¸‹å…§å®¹ä¾†è®“ include å®ƒçš„æª”æ¡ˆåƒåˆ°åŒä¸€å€‹åƒæ•¸è¨­å®šï¼š\nterragrunt.hclinputs = { project_id = \"gcp-3456\" } ç®¡ç† Module ä¹‹é–“çš„ä¾è³´æ€§ ç”±æ–¼ Terragrunt æ˜¯æŠŠæ¯å€‹æœå‹™æ‹†åˆ†æˆæœ€å°åŒ–ï¼Œæ²’è¾¦æ³•æŠŠä½¿ç”¨ä¸åŒ module çš„è³‡æºæ”¾åœ¨ä¸€èµ·(å–®ç´”ä½¿ç”¨ module çš„è©±ï¼Œå¯ä»¥ä¸€æ¬¡ source å¤šäº† moduleï¼Œä¸¦æŠŠä»–æ”¾åœ¨åŒä¸€å€‹ tf æª”æ¡ˆä¸­)ï¼Œé‚£åƒæ˜¯æˆ‘å€‘å»ºç«‹ k8s æœƒä½¿ç”¨åˆ° google_container_clusterã€google_container_node_pool å…©ç¨®ä¸åŒçš„ module è©²æ€éº¼è¾¦å‘¢ï¼Ÿ\né¦–å…ˆæˆ‘å€‘å…ˆåœ¨ modules è³‡æ–™å¤¾æ”¾ä¸Š google_container_clusterã€google_container_node_pool å…©å€‹ module çš„è¨­å®šæª”æ¡ˆï¼Œè©³ç´°ç¨‹å¼å¯ä»¥é»æˆ‘å‰å¾€\nmodules google_container_cluster main.tf outputs.tf variables.tf google_container_node_pool main.tf variables.tf åœ¨ projects åº•ä¸‹æ–°å¢ gke è³‡æ–™å¤¾ï¼Œæ–°å¢ terragrunt.hcl ä¾†æ”¾ remote_state provider çš„è¨­å®šï¼Œä¸¦å€åˆ†å…©å€‹è³‡æ–™å¤¾ï¼Œåˆ†åˆ¥æ˜¯ cluster è³‡æ–™å¤¾ä¾†å­˜æ”¾ cluster è³‡è¨Šï¼Œä»¥åŠ test è³‡æ–™å¤¾ä¾†å­˜æ”¾ test node-pool è³‡è¨Šï¼š\nprojects gke cluster terragrunt.hcl terragrunt.hcl test terragrunt.hcl cluster çš„ terragrunt.hcl æª”æ¡ˆå¦‚ä¸‹ï¼š\nterragrunt.hclterraform { source = \"${get_path_to_repo_root()}/modules/google_container_cluster\" } include { path = find_in_parent_folders() } inputs = { cluster_name = \"tf-test\" cluster_location = \"asia-east1-b\" node_locations = [] cluster_version = \"1.24.12-gke.500\" network_name = \"projects/gcp-202011216-001/global/networks/bbin-testdev\" subnetwork_name = \"projects/gcp-202011216-001/regions/asia-east1/subnetworks/bbin-testdev-dev-platform\" node_max_pods = 64 remove_default_node_pool = true initial_node_count = 1 enable_shielded_nodes = false resource_labels = { \"dept\" : \"pid\", \"env\" : \"dev\", \"product\" : \"bbin\" } dns_enabled = false cluster_dns = \"PROVIDER_UNSPECIFIED\" cluster_dns_scope = \"DNS_SCOPE_UNSPECIFIED\" private_cluster_ipv4_cidr = \"172.16.0.176/28\" binary_authorization_enabled = true binary_authorization = \"DISABLED\" } test node-pool æª”æ¡ˆå¦‚ä¸‹ï¼š\nterragrunt.hclterraform { source = \"${get_path_to_repo_root()}/modules/google_container_node_pool\" } include { path = find_in_parent_folders() } dependency \"cluster\" { config_path = \"../cluster\" } inputs = { cluster_name = dependency.cluster.outputs.cluster_name cluster_location = dependency.cluster.outputs.cluster_location cluster_version = dependency.cluster.outputs.cluster_version node_pool_name = \"test\" node_count = 1 node_machine_type = \"e2-small\" node_disk_size = 100 node_disk_type = \"pd-standard\" node_image_type = \"COS_CONTAINERD\" node_oauth_scopes = [ \"https://www.googleapis.com/auth/devstorage.read_only\", \"https://www.googleapis.com/auth/logging.write\", \"https://www.googleapis.com/auth/monitoring\", \"https://www.googleapis.com/auth/service.management.readonly\", \"https://www.googleapis.com/auth/servicecontrol\", \"https://www.googleapis.com/auth/trace.append\" ] node_tags = [] node_taint_enabled = false node_taint_key = \"\" node_taint_value = \"\" node_taint_effect = \"\" auto_repair = true auto_upgrade = true upgrade_max_surge = 1 upgrade_max_unavailable = 0 upgrade_strategy = \"SURGE\" autoscaling_enabled = true autoscaling_max_node_count = 2 autoscaling_min_node_count = 1 autoscaling_total_max_node_count = 0 autoscaling_total_min_node_count = 0 } ä¸Šé¢å…©å€‹æª”æ¡ˆåˆ†åˆ¥æ˜¯ cluster çš„è¨­å®šï¼Œä»¥åŠ test node-pool çš„è¨­å®šï¼Œè£¡é¢çš„è¨­å®šï¼Œä¸Šé¢åŸºæœ¬éƒ½æœ‰æéï¼Œé€™é‚Šè¦æçš„æ˜¯ dependencyï¼Œdependency ä»–æ˜¯ Terragrunt æä¾›è®“æˆ‘å€‘å¯ä»¥æ–¹ä¾¿åœ°å»ç®¡ç† IaC ä¹‹é–“çš„ç›¸ä¾æ€§ï¼Œåƒæ˜¯æˆ‘å€‘é€™é‚Šï¼Œéœ€è¦å…ˆå»ºç«‹å¥½ cluster æ‰èƒ½å»ºç«‹ node_poolï¼Œæ­¤æ™‚å°±å¯ä»¥ä¾é  dependency block ä¾†å®Œæˆéœ€æ±‚ã€‚\n( é  dependency ä¾†å–å¾— cluster çš„è³‡è¨Šï¼Œä¸¦å¸¶å…¥ node_pool ä¸­ )\næ­¤æ™‚çš„åŸ·è¡ŒæŒ‡ä»¤æ˜¯åœ¨ gke ç›®éŒ„ä¸‹ï¼Œä½¿ç”¨ terragrunt run-all [åƒæ•¸] ä¾†è·‘æ•´å€‹ç›¸ä¾çš„ moduleï¼Œæˆ‘å€‘é€™é‚Šå°±å»ºç«‹ä¸€å€‹åç‚º tf-test çš„ clusterï¼Œä¸¦ä¸”æœ‰ä¸€å€‹åç‚º test çš„ node_pool ï¼Œå…¶ä»–è¨­å®šè«‹åƒè€ƒä¸Šé¢ç¨‹å¼ï¼š\næ¸¬è©¦ terragrunt run-all\n(é»ƒè‰²çš„ WARN æ˜¯å› ç‚º gcs ä¸Šé‚„æ²’æœ‰å­˜éè©²ç‹€æ…‹æª”æ¡ˆï¼Œæ‰€ä»¥æœƒè·³å‡ºæç¤º)\nç­‰åˆ° cluster å»ºç«‹å®Œæˆå¾Œï¼Œæœƒå°‡ cluster çš„è³‡è¨Šå¸¶å…¥ node_poolï¼Œæ‰é–‹å§‹å»ºç«‹ node_pool çš„è³‡æºï¼š\næ¸¬è©¦ terragrunt run-all\nç”¢ç”Ÿä¾è³´é—œè¯åœ– ç•¶æˆ‘å€‘æœå‹™ä½¿ç”¨åˆ°å¾ˆå¤šä¾è³´é—œä¿‚ï¼Œæƒ³è¦é‡æ¸…æ˜¯èª°ä¾è³´èª°ï¼Œå¦‚æœå–®ç´”çœ‹ç¨‹å¼æœƒæ¯”è¼ƒéº»ç…©ï¼Œåœ¨ Terragrunt é‚„æœ‰ä¸€å€‹å¥½ç”¨çš„æŒ‡ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼Œç”¢ç”Ÿå°æ‡‰çš„ä¾è³´é—œä¿‚åœ–ï¼Œåœ¨æª¢è¦–æ™‚å¯ä»¥æ›´æ¸…æ¥šçŸ¥é“é—œä¿‚ï¼š\nterragrunt graph-dependencies | dot -Tpng \u003e graph.png ( é€™å€‹ dot æŒ‡ä»¤æ˜¯å¦å¤–çš„å¥—ä»¶ï¼Œæœƒå°‡é—œä¿‚åœ–ç¨‹å¼ç¢¼è½‰æˆåœ–æª”ï¼Œè«‹å…ˆå®‰è£ brew install graphviz )\né—œè¯åœ–","terragrunt-å®‰è£æ–¹å¼#Terragrunt å®‰è£æ–¹å¼":"é‚£è¦æ€éº¼ä½¿ç”¨ Terragrunt å‘¢ï¼ï¼Ÿ\nç¬¬ä¸€æ­¥ç•¶ç„¶æ˜¯å®‰è£å®ƒå›‰ï¼Œæˆ‘å€‘ç³»çµ±æ˜¯ macOSï¼Œæ‰€ä»¥æˆ‘å€‘å®‰è£æ–¹å¼æ˜¯ Homebrew ä¾†é€²è¡Œå®‰è£ï¼š\nbrew install terragrunt æ¥è‘—æˆ‘å€‘çš„æŒ‡ä»¤æœƒå¾ terraform XXX è®Šæˆä»¥ä¸‹ï¼š\nterragrunt plan terragrunt apply terragrunt output terragrunt destroy Terragrunt æœƒå°‡æ‰€æœ‰å‘½ä»¤ã€åƒæ•¸å’Œé¸é …ç›´æ¥è½‰ç™¼åˆ° Terraformã€‚(æ‰€ä»¥æˆ‘å€‘ä¹Ÿéœ€è¦ä¸‹è¼‰ Terraform)\nTerragrunt çš„é è¨­æª”æ¡ˆåç¨±æ˜¯ terragrunt.hcl ï¼ŒTerragrunt çš„è¨­å®šæª”æ¡ˆåŸºæœ¬ä¸Šèˆ‡ Module å·®ä¸å¤šï¼Œåªæ˜¯æœ‰æ›´å¤šæ›´æ–¹ä¾¿çš„è®Šæ•¸å¯ä»¥ä½¿ç”¨ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"äº‹åŠåŠŸå€ â€” ä½¿ç”¨ Terragrunt æ­é… Terraform ç®¡ç†åŸºç¤è¨­ç½®ï¼šhttps://medium.com/act-as-a-software-engineer/%E4%BA%8B%E5%8D%8A%E5%8A%9F%E5%80%8D-%E4%BD%BF%E7%94%A8-terragrunt-%E6%90%AD%E9%85%8D-terraform-%E7%AE%A1%E7%90%86%E5%9F%BA%E7%A4%8E%E8%A8%AD%E6%96%BD-f70c30166639"},"title":"å¦‚ä½•å°å…¥ Terragruntï¼ŒTerragrunt å¥½è™•æ˜¯ä»€éº¼ï¼Ÿ"},"/projects/":{"data":{"":" æ´»å‹•ç”³è«‹ç³»çµ± (Web)å¹«å­¸æ ¡é–‹ç™¼çš„å¤§å‹æ ¡å‹™ç³»çµ±ï¼Œæ–¹ä¾¿ç³»çµ±ç¤¾åœ˜ä½¿ç”¨é›»å­å¡«å–®æ–¹å¼ç”³è«‹æ´»å‹•ï¼Œä¹Ÿè®“ä¹‹å¾Œçš„å­¸å¼Ÿå¦¹ï¼Œå¯ä»¥æ›´å¿«é€Ÿçš„æŸ¥çœ‹åˆ°æ­·å±†è¾¦ç†çš„æ´»å‹•ã€‚ å·”å³°æ¥µé€Ÿ å…Œæ›è™›å¯¶ç¶²ç«™ (Web)è©²éŠæˆ²æœ‰å¤§é‡è™›å¯¶å¯ä»¥å…Œæ›ï¼Œä½†å®˜æ–¹æä¾›çš„ç¶²é ï¼Œéœ€è¦é‡è¤‡è¼¸å…¥ ID ä»¥åŠé©—è­‰ç¢¼é‚„æœ‰åºè™Ÿï¼Œå› æ­¤å¯«äº†ä¸€å€‹å°ç¶²é ï¼Œå¯ä»¥åªè¼¸å…¥ä¸€æ¬¡ ID ä»¥åŠé©—è­‰ç¢¼ï¼Œå°±å…Œæ›å®Œæ‰€æœ‰åºè™Ÿã€‚ äº¬ç·¯å·¥ç¨‹æœ‰é™å…¬å¸å®˜ç¶² (Web)å”åŠ©äº¬ç·¯å·¥ç¨‹æœ‰é™å…¬å¸å»ºç«‹å…¬å¸å®˜æ–¹ç¶²é ã€‚ "},"title":"å°ˆæ¡ˆæˆå°±"}}