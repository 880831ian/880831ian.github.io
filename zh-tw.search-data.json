{"/about/":{"data":{"":" å“ˆå›‰å¤§å®¶å¥½ï¼Œæˆ‘å«èŠå“æ¯…ï¼Œä¹Ÿå¯ä»¥å«æˆ‘ Ianï¼Œç›®å‰æ˜¯ä¸€ä½ Site Reliability Engineering (SRE) å·¥ç¨‹å¸«ï¼Œä¸»è¦è² è²¬ç¶­è­·å…¬å¸çš„ Google Cloud Platform (GCP) é›²ç«¯ç›¸é—œæœå‹™ï¼ŒåŒ…å« GKEã€GCEã€GCSã€GLB ç­‰ç­‰ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿç†Ÿæ‚‰ä½¿ç”¨ Terraform + Terragrunt ä¾†ç®¡ç†é›²ç«¯å¤§é‡çš„ IaC è³‡æºï¼Œé…åˆ Prometheusã€Datadogã€EFK ç­‰ç›£æ§å·¥å…·ä¾†ç¢ºä¿æœå‹™çš„ç©©å®šæ€§ï¼Œå”åŠ© RD å»ºç«‹ CICD éƒ¨ç½²æµç¨‹ã€‚\nåœ¨ä¸‹ç­ç©ºé–’æ™‚é–“ï¼Œæˆ‘å–œæ­¡é–±è®€æŠ€è¡“ç›¸é—œçš„æ–‡ä»¶ã€éƒ¨è½æ ¼ï¼Œä¹ŸæœƒåƒåŠ ä¸€äº›ç·šä¸‹æŠ€è¡“ç¤¾ç¾¤çš„æ´»å‹•ï¼Œä¾‹å¦‚ DevOpsDayï¼Œå¸Œæœ›èƒ½å¤ é€éé€™äº›æ´»å‹•ä¾†å­¸ç¿’æ›´å¤šçš„çŸ¥è­˜ï¼Œæ­¡è¿å¤§å®¶ä½¿ç”¨ä¸‹æ–¹ giscus ç•™è¨€ç³»çµ±ç•™è¨€äº¤æµã€‚","å·¥ä½œç¶“é©—#å·¥ä½œç¶“é©—":" å‡¡è°·èˆˆæ¥­æœ‰é™å…¬å¸ - SRE å·¥ç¨‹å¸« (2022/02 - ç¾åœ¨)"},"title":"é—œæ–¼æˆ‘"},"/blog/":{"data":{"":"","ä»‹ç´¹#ä»‹ç´¹":"ğŸ‘‹ ä½ å¥½ã€å¦³å¥½ã€å¤§å®¶å¥½ï¼Œæ­¡è¿ä¾†åˆ°æˆ‘çš„ç§˜å¯†èŠ±åœ’ï¼Œé€™é‚Šä¸»è¦æœƒè¨˜éŒ„æˆ‘ç ”ç©¶ä¸€å€‹æ–°çš„æŠ€è¡“æˆ–å·¥å…·ã€ä»¥åŠè™•ç†ä¸€äº› SRE é‡åˆ°çš„éˆç•°äº‹ä»¶å•é¡Œçš„å°å¤©åœ°ã€‚\næœƒé–‹å§‹å¯« Blog çš„åˆè¡·ä¸»è¦æ˜¯æˆ‘çš„å°è…¦è¢‹ç“œï¼Œå¦‚æœä¸å¯«ä¸‹ä¾†ï¼Œéé™£å­å¾ˆå®¹æ˜“å°±å¿˜è¨˜ (Â´_ã‚`)ï¼Œç•¶ç„¶ä¹Ÿå¸Œæœ›å¯ä»¥å¹«åŠ©åˆ°æœ‰ç›¸åŒå•é¡Œçš„äºº (å¯ä»¥ä½¿ç”¨æœå°‹åŠŸèƒ½ä¾†å¿«é€Ÿæ‰¾åˆ°ç›¸é—œæ–‡æª”å–”)ï¼Œå¦‚æœæœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿åœ¨ä¸‹æ–¹ç•™è¨€ã€‚","è²æ˜#è²æ˜":"ç”±æ–¼åœ¨å­¸ç¿’æ–°çš„æŠ€è¡“æˆ–å·¥å…·æ™‚ï¼Œæœƒåƒè€ƒç¶²è·¯ä¸Šè¨±å¤šçš„æ–‡ä»¶å’Œç…§ç‰‡ï¼Œé›–ç„¶æœƒåŠ ä¸Šè‡ªå·±çš„è¦‹è§£èˆ‡å¯¦ä½œå…§å®¹æ”¹å¯«è€Œæˆï¼Œä¸”æœƒæ–¼æ–‡ç« å¾Œé™„ä¸Šç›¸é—œè³‡æ–™ä¾†æºï¼Œå¦‚æœ‰ä¾µçŠ¯åˆ°æ‚¨çš„æ¬Šç›Šï¼Œè«‹æ–¼ä¸‹æ–¹å‘ŠçŸ¥ï¼Œæˆ‘æœƒç«‹å³åˆªé™¤ç›¸é—œå…§å®¹ï¼Œè¬è¬ (à¹‘â€¢Ì â‚ƒ â€¢Ì€à¹‘)ã€‚"},"title":"Blog"},"/blog/gcp/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Google Cloud Platform ç›¸é—œçš„æ–‡ç« ã€‚\nå¦‚ä½•éæ¿¾ GCP LOGï¼Œæ¸›å°‘ Cloud Logging API çš„èŠ±è²» "},"title":"Google Cloud Platform"},"/blog/gcp/gcp-log-reduce-cloud-logging-api/":{"data":{"":"ç•¶æˆ‘å€‘ä½¿ç”¨ GCP çš„ Cloud Logging æœå‹™ä¾†æŸ¥çœ‹ Log æ™‚ï¼Œæœ‰æ™‚å€™æœƒæœ‰ä¸€äº›æˆ‘å€‘ä¸éœ€è¦é¡¯ç¤ºå‡ºä¾†çš„ï¼Œæˆ–æ˜¯å¾ä¾†éƒ½ä¸æœƒå»æŸ¥è©¢çš„ Logï¼Œå†è€…æ˜¯ GCP æœ¬èº«çš„éŒ¯èª¤å°è‡´å¤§é‡å™´éŒ¯çš„ Log ï¼Œé€™äº› Log éƒ½æœƒå°è‡´ Cloud Logging çš„è²»ç”¨å¢åŠ ã€‚","ä»‹ç´¹-cloud-logging#ä»‹ç´¹ Cloud Logging":"å…ˆä¾†ç°¡å–®èªªä¸€ä¸‹ Cloud Logging é€™é …æœå‹™çš„åŸºæœ¬æ¶æ§‹ï¼Œè«‹çœ‹åœ–ï¼š\nCloud Logging åŸºæœ¬æ¶æ§‹\nå¯ä»¥çœ‹åˆ° Logs Data æœƒé€é API å†ç¶“é _Default log sink (router) å­˜åˆ°ç›¸æ‡‰å‘½åçš„ log bucket (é è¨­é…ç½®)ï¼Œåœ–ä¸­ _Required ä»¥åŠ _Default çš„ log sink éƒ½æ˜¯ GCP è‡ªå‹•å‰µå»ºçš„æ¥æ”¶å™¨ï¼Œä¸‹é¢ç°¡è¿°ä¸€ä¸‹å®ƒå€‘çš„å€åˆ¥ï¼š\n_Required æ—¥èªŒå„²å­˜æ¡¶ Cloud Logging æœƒå°‡ä»¥ä¸‹é¡å‹çš„ Log å­˜åˆ° _Required å„²å­˜æ¡¶\nç®¡ç†å“¡æ´»å‹•å¯©æ ¸ Log\nç³»çµ±äº‹ä»¶å¯©æ ¸ Log\nAccess Transparency Log\nCloud Logging æœƒå°‡ _Required å„²å­˜æ¡¶ Log ä¿ç•™ 400 å¤©ï¼Œç„¡æ³•èª¿æ•´è©²æœŸé™ï¼Œä¸”ç„¡æ³•ä¿®æ”¹æˆ–åˆªé™¤ _Required å„²å­˜æ¡¶ï¼Œä¹Ÿæ²’è¾¦æ³•åœç”¨ _Required log sink æ¥å—å™¨è·¯ç”±åˆ° _Required å„²å­˜æ¡¶çš„è¨­å®šã€‚\n_Default æ—¥èªŒå„²å­˜æ¡¶ åªè¦ä¸æ˜¯å­˜åœ¨ _Required æ—¥èªŒå„²å­˜æ¡¶çš„ Log å°±æœƒé€é _Default log sink æ¥å—å™¨è·¯ç”±åˆ° _Default å„²å­˜æ¡¶ã€‚\né™¤éæœ‰å¦å¤–é…ç½®è‡ªå®šç¾©è¨­å®šï¼Œ å¦å‰‡ _Default æ—¥èªŒå„²å­˜æ¡¶ Log åªæœƒä¿ç•™ 30 å¤©ï¼Œä¹Ÿä¸€æ¨£ç„¡æ³•åˆªé™¤ _Default æ—¥èªŒå„²å­˜æ¡¶ã€‚æ­¤å¤– Cloud Logging çš„è²»ç”¨æ˜¯ä»¥å­˜åœ¨ _Default æ—¥èªŒå„²å­˜æ¡¶ä¾†è¨ˆç®—ã€‚\nåŠŸèƒ½ åƒ¹æ ¼ æ¯æœˆå…è²»é¡åº¦ Logging æå– æå–çš„ Log $0.5/GiB æ¯å€‹é …ç›®å‰ 50 GiB Logging å„²å­˜ ä¿ç•™è¶…é 30 å¤©çš„ Logï¼Œæ¯æœˆæ¯ GiB $0.01 åœ¨é»˜èªä¿ç•™æœŸé™çš„ Log ä¸æœƒæœ‰é¡å¤–å„²å­˜è²»ç”¨ æŸ¥çœ‹è©²å°ˆæ¡ˆä½¿ç”¨çš„ Cloud Logging API è²»ç”¨ï¼šhttps://console.cloud.google.com/apis/api/logging.googleapis.com/cost","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Routing and storage overview https://cloud.google.com/logging/docs/routing/overview","éæ¿¾-log#éæ¿¾ Log":"é‚£ç¾åœ¨çŸ¥é“ Cloud Logging çš„æ¶æ§‹ï¼Œé‚£ç•¶æˆ‘å€‘é‡åˆ°éœ€è¦éæ¿¾ Log æ™‚ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ­¥é©Ÿä¾†éæ¿¾ä»¥ç¯€çœ Cloud Logging API è²»ç”¨ï¼š\nç¯„ä¾‹èªªæ˜ é€™æ¬¡ç¯„ä¾‹æ˜¯ google åœ¨ 2023/07/06 æ‰€ç™¼ä½ˆçš„ Service Healthï¼Œç•¶ GKE ç‰ˆæœ¬å¤§æ–¼ 1.24 ä»¥ä¸Šï¼Œå°±æœƒå™´\nFailed to get record: decoder: failed to decode payload: EOF\ncannot parse â€˜0609 05:31:59.491654â€™ after %L\ninvalid time format %m%d %H:%M:%S.%L%z for â€˜0609 05:31:59.490647â€™\né€™ä¸‰ç¨®é¡å‹çš„éŒ¯èª¤ Logï¼Œåœ¨ç­‰å¾…å®˜æ–¹ä¿®å¾©å‰ï¼Œå®˜æ–¹çš„å»ºè­°æ˜¯å…ˆå°‡ä»–çµ¦éæ¿¾æ‰ï¼Œé¿å…ä¸€ç›´åˆ·å™´éŒ¢ â”(Â´Ğ´`)â”Œ\né™„ä¸Šç•¶æ™‚çš„ Service Health é€£çµï¼šhttps://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE\næˆ‘å€‘åœ¨ä¸Šé¢æ¶æ§‹åœ–æœ‰èªªåˆ°ï¼ŒLog æœƒé€é log sink è·¯ç”±åˆ° bucketï¼Œæ‰€ä»¥æˆ‘å€‘è¦å°‡éæ¿¾æ¢ä»¶åŠ åœ¨ log router ä¸Šï¼š\né¸æ“‡ Log Router é¸æ“‡ Log Router\né¸æ“‡ Log Router Sinks é¸æ“‡ _Default çš„ Log Router Sinksï¼Œé»é¸å³é‚ŠæŒ‰éˆ•çš„ Edit Sink\né¸æ“‡ _Default çš„ Log Router Sinks\nè¨­å®š Sink details ç¬¬ä¸€å€‹æ˜¯ detailsï¼Œå¯ä»¥è¼¸å…¥èªªæ˜ï¼Œé€™é‚Šè¼¸å…¥ï¼šgoogle æœ‰ bug æœƒå™´å¤§é‡çš„æ„å¤– LOGï¼Œæ€•è²»ç”¨é£†é«˜ï¼Œå…ˆç”¨å®˜æ–¹å»ºè­°çš„ä¾†éæ¿¾ LOGï¼Œè©³ç´°å¯ä»¥çœ‹ï¼š https://status.cloud.google.com/incidents/y5XvpyBXFhsphSt4DfiE\nè¼¸å…¥ Sink details èªªæ˜\né¸æ“‡ Sink Service è·Ÿ Bucket æ¥è‘— sink æœå‹™é¸æ“‡ Logging bucketï¼Œä»¥åŠå°æ‡‰å„²å­˜çš„ log bucket (é€™é‚ŠåŸºæœ¬ä¸Šéƒ½æ˜¯é è¨­)\né¸æ“‡ Logging bucket\nè¨­å®š include Log é¸æ“‡é‚£äº›å¯ä»¥è¢« include åˆ° sink æ¥æ”¶å™¨çš„ LOG æ ¼å¼ (é€™é‚ŠåŸºæœ¬ä¸Šéƒ½æ˜¯é è¨­)\né è¨­çš„ LOG æ ¼å¼\nè¨­å®š filter Log é€™é‚Šå°±æ˜¯æˆ‘å€‘è¦è¼¸å…¥éæ¿¾çš„åœ°æ–¹ï¼Œå…ˆé»æ“Š ADD EXCLUSIONï¼Œè¼¸å…¥éæ¿¾çš„åç¨±ï¼Œä»¥åŠéæ¿¾çš„å…§å®¹æ ¼å¼ï¼Œæˆ‘å€‘è¼¸å…¥ google åœ¨ Service Health æ‰€æä¾›çš„æ ¼å¼ï¼Œæœ€å¾ŒæŒ‰ä¸‹ UPDATE SINK\næ–°å¢è¦éæ¿¾çš„ LOG æ ¼å¼\nè¨­å®šå®Œæˆ ç­‰å¾…æ›´æ–°å®Œæˆï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘å€‘å·²ç¶“åœ¨æ¥æ”¶å™¨ä¸Šè¨­å®šå¥½éæ¿¾æ¢ä»¶å›‰ï½\næŸ¥çœ‹è©³ç´°æ¥æ”¶å™¨è¨­å®š\næª¢æŸ¥ Log æ˜¯å¦éæ¿¾æˆåŠŸ æœ€å¾Œå†æª¢æŸ¥ä¸€ä¸‹ Log æ˜¯ä¸æ˜¯æ²’æœ‰æ”¶åˆ°è©²éŒ¯èª¤çš„ Log å…§å®¹\næª¢æŸ¥ LOG æ˜¯å¦ä¸æœƒå†å‡ºç¾"},"title":"å¦‚ä½•éæ¿¾ GCP LOGï¼Œæ¸›å°‘ Cloud Logging API çš„èŠ±è²»"},"/blog/kubernetes/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Kubernetes ç›¸é—œçš„æ–‡ç« ã€‚\nåœ¨æ­£å¼ç’°å¢ƒä¸Šè¸©åˆ° StatefulSet çš„é›·ï¼Œæ‹¿åˆ° P1 çš„æ•™è¨“ éƒ¨ç½² Pod é‡åˆ° container veth name provided (eth0) already exists éŒ¯èª¤ "},"title":"Kubernetes"},"/blog/kubernetes/k8s-statefulset-podmanagementpolicy/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹å‰é™£å­åœ¨å…¬å¸çš„æ­£å¼ç’°å¢ƒè¸©åˆ° StatefulSet çš„é›·ï¼Œäº‹æƒ…æ˜¯é€™æ¨£çš„ï¼Œæˆ‘å€‘æœ‰äº›æœå‹™ï¼Œæ˜¯ä½¿ç”¨ StatefulSet ä¾†å»ºç½®ï¼Œè‡³æ–¼ç‚ºä»€éº¼ä¸ç”¨ Deploymentï¼Œé€™å€‹èªªä¾†è©±é•· (ä¹Ÿä¸æ˜¯å› ç‚ºéœ€è¦ç‰¹å®šçš„ Pod åç¨±ã€æˆ–æ˜¯ç¶²è·¯æ¨™è¨˜ç­‰ç­‰)ï¼Œæˆ‘å€‘é€™é‚Šå…ˆä¸è¨è«–ï¼Œé€™å€‹ StatefulSet æœå‹™æ˜¯ Nginx + PHP-FPMï¼Œç‚ºäº†é¿å…æµé‡é€²å…¥åˆ° processes å·²ç¶“è¢«ç”¨å…‰çš„ Pod ä¸­ï¼Œæˆ‘å€‘åœ¨ StatefulSet çš„ PHP Container ä¸Šæœ‰è¨­å®š readinessï¼Œreadiness çš„è¨­å®šé•·å¾—åƒä»¥ä¸‹ï¼š\nreadinessProbe: exec: command: - \"/bin/bash\" - \"-c\" - | CHECK_INFO=$(curl -s -w 'http code:\\t%{http_code}\\n' 127.0.0.1/status) HTTP_CODE=$(echo -e \"${CHECK_INFO}\" | awk '/http code:/ {print $3}') IDLE_PROCESSES=$(echo -e \"${CHECK_INFO}\" | awk '/idle processes:/ {print $3}') [[ $HTTP_CODE -eq 200 \u0026\u0026 $IDLE_PROCESSES -ge 10 ]] || exit 1 æˆ‘å€‘æœƒç”¨ curl ä¾†æ‰“ /statusï¼Œæª¢æŸ¥å›å‚³çš„ http code æ˜¯å¦ç‚º 200ï¼Œä»¥åŠ idle processes æ˜¯å¦å¤§æ–¼ç­‰æ–¼ 10ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œå°±æœƒå›å‚³ 1ï¼Œè®“ä»–è¢«æ¨™è¨˜ä¸å¥åº·ï¼Œè®“ Kubernetes åœæ­¢æµé‡åˆ°ä¸å¥åº·çš„å®¹å™¨ï¼Œä»¥ç¢ºä¿æµé‡è¢«è·¯ç”±åˆ°å…¶ä»–å¥åº·çš„å‰¯æœ¬ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Kubernetes â€” å¥åº·æª¢æŸ¥ï¼šhttps://medium.com/learn-or-die/kubernetes-%E5%81%A5%E5%BA%B7%E6%AA%A2%E6%9F%A5-59ee2a798115\nPod Management Policiesï¼šhttps://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#pod-management-policies","å•é¡Œ#å•é¡Œ":"ç•¶å¤©é‡åˆ°çš„æƒ…æ³æ˜¯ï¼Œæˆ‘å€‘ä¸Šç¨‹å¼å¾Œï¼ŒPod éƒ½ä¸€åˆ‡æ­£å¸¸ï¼Œç•¶æµé‡é–‹å§‹é€²ä¾†å¾Œï¼Œç™¼ç¾ 10 å€‹ Pod æœƒé–‹å§‹å¶ç™¼çš„å™´ Readiness probe failedï¼ŒæŸ¥çœ‹ç›£æ§ç™¼ç¾ processes è¶Šä¾†è¶Šä½ï¼Œæœ€å¾Œè¢«åæ‡‰æœå‹™æœ‰å•é¡Œï¼Œæˆ‘å€‘æŸ¥çœ‹ Hpa çš„ç´€éŒ„çš„ç¢ºæœ‰è§¸ç™¼åˆ° 40 å€‹ Podï¼Œåªæ˜¯æŸ¥çœ‹ Pod æ•¸é‚„æ˜¯ä¾æ¨£å¡åœ¨ 10 å€‹ï¼Œç•¶ä¸‹æˆ‘å€‘æœ‰å˜—è©¦ä½¿ç”¨èª¿æ•´ yaml åœ¨ applyï¼Œç™¼ç¾ StatefulSet çš„ yaml ä¹Ÿå·²ç¶“æ›´æ–°äº†ï¼Œä½† Pod é‚„æ˜¯ä¸€æ¨£å¡åœ¨ 10 å€‹ï¼Œä¹Ÿæœ‰ä½¿ç”¨ kubectl ä¸‹ kubectl scale sts [æœå‹™åç¨±] --replicas=0ï¼Œæƒ³è¦åˆ‡æ› Pod æ•¸ä¹Ÿæ²’æœ‰è¾¦æ³•ã€‚\nç•¶ä¸‹æˆ‘å€‘æœ‰å…ˆ Call Google çš„ Support ä¸€èµ·æ‰¾åŸå› ï¼ŒGoogle æ˜¯å»ºè­°æˆ‘å€‘ readiness çš„æ¢ä»¶ä¸è¦è¨­çš„å¤ªåš´æ ¼ï¼Œå¯ä»¥åŠ ä¸Š timeoutSeconds: ç§’æ•¸ï¼Œä½†å°æ–¼ Pod å¡ä½ï¼Œé‚„æ˜¯æ²’æœ‰æ‰¾åˆ°åŸå› ï¼Œå¾Œä¾†æˆ‘å€‘æŸ¥äº†ä¸€ä¸‹ StatefulSet çš„æ–‡ä»¶ç™¼ç¾ï¼ŒStatefulSet æœ‰ä¸€å€‹è¨­å®š podManagementPolicyï¼Œé è¨­æ˜¯ OrderedReadyï¼Œä»–å¿…é ˆç­‰å¾…å‰é¢çš„ Pod æ˜¯ Ready ç‹€æ…‹ï¼Œæ‰æœƒå†ç¹¼çºŒå»ºç«‹æ–°çš„ï¼Œä¹Ÿå°±æ˜¯èªªæˆ‘å€‘çš„ StatefulSet å·²ç¶“å¡ä½ï¼Œå°è‡´å°±ç®— Hpa è§¸ç™¼è¦é•·åˆ° 40 å€‹ Pod ä¹Ÿæ²’æœ‰ç”¨ã€‚","æ¸¬è©¦çµæœ#æ¸¬è©¦çµæœ":"æœ€å¾Œæˆ‘å€‘å°±ä½¿ç”¨å…©ç¨®æ¨¡å¼ä¾†æ¸¬è©¦çœ‹çœ‹ï¼Œå·²ä¸‹æ˜¯æ¸¬è©¦çµæœ(é€é P1 æ‰çŸ¥é“çš„è¨­å®šï¼±ï¼±)ï¼š\næœ‰å°‡æ¸¬è©¦çš„ StatefulSet æ”¾åœ¨ Githubï¼Œå¯ä»¥é»æˆ‘æŸ¥çœ‹ (å¯ä»¥èª¿æ•´ readinessProbe çš„ httpGet.Path æ•…æ„æŠŠä»–ç”¨å£)\nä½¿ç”¨ OrderedReady æ¨¡å¼ StatefulSet åœ¨ podManagementPolicy é è¨­ OrderedReady çš„æ¨¡å¼ï¼Œæ•…æ„è®“ readiness å¡ä½æ™‚ (Pod å¡ä½æ™‚)ï¼š\nç•¶ä¸‹çš„ StatefulSet è¨­å®šï¼š StatefulSet è¨­å®š\nPod ç‹€æ…‹ï¼š Pod ç‹€æ…‹\nä½¿ç”¨æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘é€™æ™‚å€™ä¸‹æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nkubectl scale sts my-statefulset --replicas=5 æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ï¼Œä»£è¡¨ StatefulSet æœ¬èº«æœ‰æ¥æ”¶åˆ°èª¿æ•´è¨­å®šçš„è«‹æ±‚ã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿæ˜¯ä¸€æ¨£å¡ä½ï¼Œä¸” Pod æ•¸é‡ä¹Ÿæ²’æœ‰è®ŠåŒ–ã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹\nä½¿ç”¨ yaml èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘ç›´æ¥èª¿æ•´ StatefulSet yaml çš„ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nä¸€æ¨£æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Š(é€™è£¡æ‡‰è©²åˆ‡åˆ¥çš„ Pod æ•¸é‡ï¼Œåˆ‡å› 3 å€‹å¥½åƒæ²’æœ‰æ„ç¾© xD)ï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿæ˜¯ä¸€æ¨£å¡ä½ï¼Œä¸” Pod æ•¸é‡ä¹Ÿæ²’æœ‰è®ŠåŒ–ã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹\næ‰€ä»¥ä»£è¡¨åœ¨ OrderedReady çš„æ¨¡å¼ä¸‹ï¼ŒPod å¡ä½æ™‚ï¼Œç„¡æ³•å° Pod é€²è¡Œä»»ä½•æ“ä½œï¼Œå¿…é ˆè¦æ‰‹å‹•åˆªé™¤å¡ä½çš„ Pod æ‰åƒå¾—åˆ°æœ€æ–°çš„è¨­å®šã€‚\nä½¿ç”¨ Parallel æ¨¡å¼ StatefulSet åœ¨ podManagementPolicy Parallel çš„æ¨¡å¼ï¼Œæ•…æ„è®“ readiness å¡ä½æ™‚ (Pod å¡ä½æ™‚)ï¼š\nç•¶ä¸‹çš„ StatefulSet è¨­å®šï¼š StatefulSet è¨­å®š\nPod ç‹€æ…‹ï¼š Pod ç‹€æ…‹\nä½¿ç”¨æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘é€™æ™‚å€™ä¸‹æŒ‡ä»¤èª¿æ•´ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nkubectl scale sts my-statefulset --replicas=5 æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ï¼Œä»£è¡¨ StatefulSet æœ¬èº«æœ‰æ¥æ”¶åˆ°èª¿æ•´è¨­å®šçš„è«‹æ±‚ã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œå°±ç®— my-statefulset-2 å¡ä½ï¼Œé‚„æ˜¯å¯ä»¥æ“´åˆ° 5 å€‹ Podã€‚\nä¸‹æŒ‡ä»¤èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹\nä½¿ç”¨ yaml èª¿æ•´ Pod æ•¸é‡ æˆ‘å€‘ç›´æ¥èª¿æ•´ StatefulSet yaml çš„ Pod æ•¸é‡ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š\nä¸€æ¨£æˆ‘å€‘å…ˆçœ‹ StatefulSet çš„ yaml å¯ä»¥çœ‹åˆ° Pod replicas å·²ç¶“æ”¹è®Šï¼Œä¹Ÿå¯ä»¥çœ‹ generation æœ‰æ›´æ–°ã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ StatefulSet è¨­å®š\nçœ‹äº†ä¸€ä¸‹ Pod æ•¸é‡ï¼Œä¹Ÿä¸æœƒç®¡å…¶ä»– Pod æ˜¯å¦ Readyï¼Œä¸€æ¨£å¯ä»¥ç¸®å°æˆ 2 å€‹ Podã€‚\nä½¿ç”¨ yaml èª¿æ•´å¾Œçš„ Pod ç‹€æ…‹","çµè«–#çµè«–":"å¾Œä¾†æˆ‘å€‘é‡æ–°æª¢æŸ¥äº†ä¸€ä¸‹ç‚ºä»€éº¼ processes æœƒç”¨å®Œï¼Œçµæœç™¼ç¾æ˜¯ RD çš„ç¨‹å¼é‚è¼¯ï¼Œå°è‡´æ¯ç­† Request å¿…é ˆç­‰å¾…å‰ä¸€ç­† Request åšå®Œï¼Œæ‰æœƒé–‹å§‹å‹•ä½œï¼Œè®“ processes ä¸€ç›´è¢«å ç”¨ï¼Œæ²’è¾¦æ³•å³æ™‚æ¶ˆåŒ–ï¼Œå°è‡´ processes ç”¨å®Œï¼ŒåˆåŠ ä¸Šæœå‹™æ˜¯ä½¿ç”¨ StatefulSetï¼Œé è¨­æ¨¡å¼çš„ OrderedReadyï¼Œå¿…é ˆç­‰å¾…å‰ä¸€å€‹ Pod æ˜¯ Ready æ‰å¯ä»¥è‡ªå‹•æ“´ç¸®ï¼Œæ‰€ä»¥ç•¶æˆ‘å€‘ Hpa æƒ³è¦æ“´ç¸®ï¼Œä¾†å¢åŠ å¯ç”¨çš„ processes æ•¸é‡ï¼Œä¹Ÿå› ç‚ºæ²’è¾¦æ³•æ“´ç¸®ï¼Œæœ€å¾Œå°è‡´é€™ä¸€é€£ä¸²çš„å•é¡Œ ğŸ˜•ã€‚\nå¦å¤–ï¼Œå¦‚æœæƒ³è¦å¾ OrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼ (åæ­£éä¾†ä¹Ÿæ˜¯)ï¼Œå¿…é ˆå…ˆå°‡åŸæœ¬çš„ StatefulSet çµ¦åˆªé™¤ï¼Œæ‰å¯ä»¥èª¿æ•´ï¼š\nOrderedReady æ¨¡å¼åˆ‡æˆ Parallel æ¨¡å¼","è§£æ±ºè¾¦æ³•#è§£æ±ºè¾¦æ³•":"ç•¶ä¸‹æƒ³è¶•å¿«è§£æ±º readiness é€™å€‹å•é¡Œï¼Œèª¿æ•´ timeoutSeconds å¾Œï¼Œå–®ç´” apply æ˜¯æ²’æœ‰ç”¨çš„ï¼Œè¦è¨˜å¾—åˆªæ‰å¡ä½çš„ Podï¼Œè®“ä»–é‡æ–°å»ºç«‹ï¼Œæ‰æœƒå¥—ç”¨æ–°çš„è¨­å®š (ä½†æˆ‘å€‘ç•¶ä¸‹å¤ªåœ¨æ„ç‚ºç”šéº¼ Pod æœƒå¡ä½ï¼Œæ²’æœ‰æƒ³åˆ°è¦å…ˆæŠŠ readiness å•é¡Œä¿®æ‰ xDï¼Œæˆ‘å€‘ç•¶ä¸‹çš„è§£æ³•æ˜¯å…ˆå°‡æµé‡å°åˆ°åœ°ç«¯æ­£å¸¸çš„æœå‹™ä¸Š)ã€‚\nå¦å¤– Google ä¹Ÿèªªï¼Œå‡å¦‚æˆ‘å€‘é‚„æ˜¯å¿…é ˆä½¿ç”¨ StatefulSet ä¾†å»ºç«‹æœå‹™ï¼Œå»ºè­°æˆ‘å€‘æŠŠ podManagementPolicy æ”¹æˆ Parallelï¼Œå®ƒæœƒæœ‰é»åƒæ˜¯ Deployment çš„æ„Ÿè¦ºï¼Œä¸æœƒç­‰å¾…å…¶ä»– Pod è®Šæˆ Ready ç‹€æ…‹ï¼Œæ‰€ä»¥å¯ä»¥è®“æˆ‘å€‘å°±ç®—åœ¨ readiness å¡ä½çš„æƒ…æ³ä¸‹ï¼Œä¹Ÿå¯ä»¥è‡ªå‹•æ“´ç¸®æœå‹™ã€‚\nâ„¹ï¸ StatefulSet podManagementPolicy åƒæ•¸èªªæ˜\nOrderedReady (é è¨­) Pods æœƒæŒ‰ç…§é †åºä¸€å€‹æ¥ä¸€å€‹åœ°è¢«å‰µå»ºã€‚å³ï¼Œn+1 è™Ÿ Pod ä¸æœƒåœ¨ n è™Ÿ Pod æˆåŠŸå‰µå»ºä¸” Ready ä¹‹å‰é–‹å§‹å‰µå»ºã€‚ åœ¨ç¸®å° StatefulSet çš„å¤§å°æ™‚ï¼ŒPods æœƒæŒ‰ç…§åå‘é †åºä¸€å€‹æ¥ä¸€å€‹åœ°è¢«çµ‚æ­¢ã€‚å³ï¼Œn è™Ÿ Pod ä¸æœƒåœ¨ n+1 è™Ÿ Pod å®Œå…¨çµ‚æ­¢ä¹‹å‰é–‹å§‹çµ‚æ­¢ã€‚ é€™ç¢ºä¿äº† Pods çš„å•Ÿå‹•å’Œçµ‚æ­¢çš„é †åºæ€§ã€‚\nParallel æ‰€æœ‰ Pods æœƒåŒæ™‚åœ°è¢«å‰µå»ºæˆ–çµ‚æ­¢ã€‚ ç•¶ StatefulSet æ“´å±•æ™‚ï¼Œæ–°çš„ Pods æœƒç«‹å³é–‹å§‹å‰µå»ºï¼Œä¸ç”¨ç­‰å¾…å…¶ä»– Pods æˆç‚º Ready ç‹€æ…‹ã€‚ ç•¶ç¸®å° StatefulSet çš„å¤§å°æ™‚ï¼Œè¦çµ‚æ­¢çš„ Pods æœƒç«‹å³é–‹å§‹çµ‚æ­¢ï¼Œä¸ç”¨ç­‰å¾…å…¶ä»– Pods å…ˆçµ‚æ­¢ã€‚ é€™ç¨®ç­–ç•¥æä¾›äº†å¿«é€Ÿçš„æ“´å±•å’Œç¸®å°æ“ä½œï¼Œä½†ç¼ºä¹é †åºæ€§ä¿è­‰ã€‚"},"title":"æ­£å¼ç’°å¢ƒä¸Šè¸©åˆ° StatefulSet çš„é›·ï¼Œæ‹¿åˆ° P1 çš„æ•™è¨“"},"/blog/kubernetes/pod-veth-name-provided-eth0-already-exists/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹å…¬å¸åŒäº‹åœ¨æ­£å¼æœå‹™ä¸Šé‡åˆ°çš„å•é¡Œï¼Œæœƒè©³ç´°èªªæ˜é‡åˆ°äº‹æƒ…çš„ç¶“éï¼Œä»¥åŠé–‹å–®è©¢å• google support æœ€å¾Œè¨è«–å‡ºçš„æš«æ™‚è§£æ±ºçš„è¾¦æ³•ï¼š\nç°¡å–®åˆ—å‡ºæ­£å¼ç«™ç•¶ä¸‹æœå‹™ç’°å¢ƒï¼š\ngke master versionï¼š1.25.10-gke.2700 gke node versionï¼š1.25.8-gke.1000 è©²å•é¡Œç™¼ç”Ÿçš„ node pool æœ‰è¨­å®š taint ç™¼ç”Ÿå•é¡Œçš„ Pod æ˜¯ç”¨ Statefulset å»ºç«‹çš„æœå‹™ ","äº‹æƒ…ç™¼ç”Ÿçš„ç¶“é#äº‹æƒ…ç™¼ç”Ÿçš„ç¶“é":" RD åŒä»åæ‡‰ï¼Œç™¼ç¾ä½¿ç”¨ Statefulset å»ºç«‹çš„æ’ç¨‹æœå‹™æœ‰å•é¡Œï¼Œä¸‹ kubectl delete æŒ‡ä»¤æƒ³è¦åˆªé™¤ Podï¼Œè®“ Pod é‡æ–°é•·ï¼Œå»å¡åœ¨ Terminatingï¼Œç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œï¼Œæ±ºå®šä¸‹ kubectl delete --force --grace-period=0 ä¾†å¼·åˆ¶åˆªé™¤ Podï¼Œé€™æ™‚å€™ç‹€æ…‹æœƒå¡åœ¨ ContainerCreatingï¼Œä½¿ç”¨ Describe æŸ¥çœ‹ï¼Œæœƒå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼š Warning (combined from similar events): Failed to create pod sandbox: rpo error: code = Unknown desc = failed to setup network for sandbox \"14fe0cd3d688aed4ffed4c36ffab1a145230449881bcbe4cac6478a63412b0c*: plugin type=*gke\" failed (add): container veth name provided (etho) already exists æˆ‘å€‘ SRE å”åŠ©æŸ¥çœ‹å¾Œï¼Œä¹Ÿæœ‰å˜—è©¦å»ä¸‹ kubectl delete --force --grace-period=0 ä¾†åˆªé™¤ Podï¼Œä½†é‚„æ˜¯ä¸€æ¨£å¡åœ¨ ContainerCreatingï¼Œæœ€å¾Œæ˜¯å…ˆé–‹ä¸€å€‹æ–°çš„ Node ä¸¦è®“è©² Pod å»ºç«‹åˆ°æ–°çš„ Node ä¸Šï¼Œæ‰è§£æ±ºå•é¡Œã€‚ç‚ºäº†æ–¹ä¾¿ google support å”åŠ©æª¢æŸ¥å‡ºå•é¡Œçš„ Nodeï¼Œå…ˆå°‡ Node è¨­å®šæˆ cordonï¼Œé¿å…å…¶ä»– Pod è¢«èª¿åº¦åˆ°è©²å•é¡Œ node ä¸Šã€‚ Node è¨­å®šæˆ cordon\nNode å¯ä»¥è¨­å®š cordonã€drain å’Œ delete ä¸‰å€‹æŒ‡å®šéƒ½æœƒä½¿ Node åœæ­¢è¢«èª¿åº¦ï¼Œåªæ˜¯æ¯å€‹çš„æ“ä½œæš´åŠ›ç¨‹åº¦ä¸åŒï¼š\ncordonï¼šå½±éŸ¿æœ€å°ï¼Œåªæœƒå°‡ Node æ¨™ç¤ºç‚º SchedulingDisabled ä¸å¯èª¿åº¦ç‹€æ…‹ï¼Œä½†ä¸æœƒå½±éŸ¿åˆ°å·²ç¶“åœ¨è©² Node ä¸Šçš„ Podï¼Œä½¿ç”¨ kubectl cordon [node name] ä¾†åœæ­¢èª¿åº¦ï¼Œä½¿ç”¨ kubectl uncordon [node name] ä¾†æ¢å¾©èª¿åº¦ã€‚\ndrainï¼šæœƒå…ˆé©…é€åœ¨ Node ä¸Šçš„ Podï¼Œå†å°‡ Node æ¨™ç¤ºç‚º SchedulingDisabled ä¸å¯èª¿åº¦ç‹€æ…‹ï¼Œä½¿ç”¨ kubectl drain [node name] --ignore-daemonsets --delete-local-data ä¾†åœæ­¢èª¿åº¦ï¼Œä½¿ç”¨ kubectl uncordon [node name] ä¾†æ¢å¾©èª¿åº¦ã€‚\ndeleteï¼šæœƒå…ˆé©…é€ Node ä¸Šçš„ Podï¼Œå†åˆªé™¤ Node ç¯€é»ï¼Œå®ƒæ˜¯ä¸€ç¨®æš´åŠ›åˆªé™¤ Node çš„ä½œæ³•ï¼Œåœ¨é©…é€ Pod æ™‚ï¼Œæœƒå¼·åˆ¶ Kill å®¹å™¨é€²ç¨‹ï¼Œæ²’è¾¦æ³•å„ªé›…çš„çµ‚æ­¢ Podã€‚\næˆ‘å€‘éš¨å¾Œé–‹å–®è©¢å• goolge supportã€‚ ","åƒè€ƒ#åƒè€ƒ":"Node ç¯€é»ç¦æ­¢èª¿åº¦ï¼ˆå¹³æ»‘ç¶­è­·ï¼‰æ–¹å¼- cordonï¼Œdrainï¼Œdeleteï¼šhttps://www.cnblogs.com/kevingrace/p/14412254.html","èˆ‡-google-support-è¨è«–å…§å®¹#èˆ‡ Google Support è¨è«–å…§å®¹":"Google Support ç¶“éæŸ¥è©¢å¾Œï¼Œå›è¦†èªªï¼šé€™å€‹å•é¡Œæ˜¯å› ç‚º Pod è¢«å¼·åˆ¶åˆªé™¤å°è‡´ï¼Œå¼·åˆ¶åˆªé™¤æ˜¯ä¸€ç¨®å±éšªçš„æ“ä½œï¼Œä¸å»ºè­°é€™æ¨£è™•ç†ï¼Œä¸‹é¢æœ‰è©³ç´°è¨è«–ã€‚\nä¸€é–‹å§‹å¡åœ¨ Terminating ç‹€æ…‹ï¼Œæˆ‘å€‘ä¹Ÿæœ‰è«‹ RD èªªæ˜ä¸€ä¸‹ç•¶ä¸‹é‡åˆ°çš„å•é¡Œä»¥åŠè™•ç†å‹•ä½œï¼šRD ç•¶æ™‚æƒ³è¦åˆªé™¤ Pod æ˜¯å› ç‚ºè©²ç¨‹å¼ç•¶ä¸‹æœ‰ Bugï¼Œå°‡ redis èˆ‡ db é€£ç·šçµ¦é—œé–‰ï¼Œç¨‹å¼æ‰¾ä¸åˆ°å°±æœƒä¸€ç›´ retryï¼Œå°è‡´ç›¸é—œé€²ç¨‹ç„¡æ³•çµæŸï¼Œå†åŠ ä¸Š terminationGracePeriodSeconds æˆ‘å€‘è¨­å®š 14400ï¼Œä¹Ÿå°±æ˜¯ 4 å°æ™‚ï¼Œæ‰æœƒå¡åœ¨ Terminating ç‹€æ…‹ã€‚ (terminationGracePeriodSeconds è¨­å®šé€™éº¼ä¹…æ˜¯å¸Œæœ›å¦‚æœæœ‰è¢« on callï¼Œå·¥ç¨‹å¸«ä¸Šä¾†æ™‚ï¼Œå¯ä»¥æŸ¥çœ‹è©² Pod çš„éŒ¯èª¤åŸå› )\nå› ç‚ºå¡åœ¨ Terminating å¤ªä¹…ï¼ŒRD æœ‰åŸ·è¡Œ kubectl delete --forceï¼Œå°±æ˜¯å› ç‚ºä¸‹äº† --force æ‰é€ æˆç›¸é—œè³‡æºå•é¡Œ (ä¾‹å¦‚ container proccess, sandbox, ä»¥åŠç¶²è·¯è³‡æº)æ²’æœ‰åˆªä¹¾æ·¨ã€‚æ‰€ä»¥å¼•èµ·äº†æ­¤æ¬¡çš„å ±éŒ¯ â€œcontainer veth name provided (eth0) already existsâ€ã€‚ (å› ç‚ºæˆ‘å€‘æœå‹™ä½¿ç”¨ Statefulsetï¼ŒPod åç¨±ç›¸åŒï¼Œå°è‡´ eth0 é€™å€‹ç¶²è·¯è³‡æºåç¨±é‡è¤‡ï¼Œæ‰€ä»¥é€ æˆéŒ¯èª¤ï¼Œå¯ä»¥ç”¨ deployment ä¾†æ”¹å–„é€™å€‹å•é¡Œï¼Œåªæ˜¯è³‡æºå¦‚æœæ²’æœ‰æ¸…ç†ä¹¾æ·¨æœƒä½”ç”¨ IPï¼Œæ‰€ä»¥å–®ç´”èª¿æ•´æˆ deployment ä¹Ÿä¸æ˜¯æœ€ä½³è§£)\nGoogle ç”¢å“åœ˜éšŠå»ºè­°ï¼Œå¦‚æœ Pod è™•æ–¼ Running ç‹€æ…‹æ™‚ï¼Œæƒ³è¦å¿«é€Ÿåˆªé™¤ Pod æ™‚ï¼Œä¸€é–‹å§‹å°±å…ˆä½¿ç”¨ kubectl delete pod --grace-period=number[ç§’æ•¸] ä¾†åˆªé™¤ï¼Œå¦‚æœå·²ç¶“æ˜¯ Terminating ç‹€æ…‹å‰‡ç„¡æ•ˆã€‚(SRE åŒä»å·²æ¸¬è©¦éï¼Œèˆ‡ Google Support èªªæ˜ç›¸åŒ)\né‚£å¦‚æœå·²ç¶“è™•æ–¼ Terminating ç‹€æ…‹ï¼Œè¦æ€éº½è®“ Pod è¢«é †åˆ©åˆªé™¤ï¼Œé€™éƒ¨åˆ† Google Support å¾ŒçºŒæœƒåœ¨æ¸¬è©¦ä¸¦çµ¦å‡ºå»ºè­°ï¼Œç›®å‰æ¸¬è©¦æ˜¯ï¼šé€²å»å¡ä½çš„ Pod Containerï¼Œæ‰‹å‹•åˆªé™¤ä¸»é€²ç¨‹ (pkill) å°±å¯ä»¥äº†ã€‚\nGoogle Support å›è¦†"},"title":"éƒ¨ç½² Pod é‡åˆ° container veth name provided (eth0) already exists éŒ¯èª¤"},"/blog/nginx/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Nginx ç›¸é—œçš„æ–‡ç« ã€‚\næƒ³ä½¿ç”¨ Nginx Upstream Proxy åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸¦å¸¶å…¥å°æ‡‰çš„ header è©²æ€éº¼åšï¼Ÿ Soketi WebSocket Server LOG ä¸å®šæ™‚å‡ºç¾ 502 error ä»¥åŠ connect() failed (111: Connection refused) "},"title":"Nginx"},"/blog/nginx/nginx-upstream-set-host-header/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹æœ€è¿‘åœ¨å…¬å¸æœå‹™å…¥å£é‡åˆ°çš„ä¸€äº›å°å•é¡Œï¼Œä»¥åŠè§£æ±ºçš„æ–¹æ³•ã€‚ç°¡å–®èªªæ˜ä¸€ä¸‹ï¼Œæˆ‘å€‘çš„æœå‹™å…¥å£æ˜¯ç”¨ Nginx ä¾†ç•¶ä½œ proxy serverï¼Œå°‡ä¸åŒè·¯å¾‘æˆ–æ˜¯ servername å°åˆ°å°æ‡‰çš„å¾Œç«¯ç¨‹å¼ï¼Œæˆ–æ˜¯å¤–éƒ¨çš„æœå‹™ä¸Š(ä¾‹å¦‚ AWS cloudfront.net)ï¼Œæœ¬ç¯‡è¦æ¸¬è©¦çš„æ˜¯å¦‚æœä½¿ç”¨è¦åŒæ™‚ä½¿ç”¨ upstream åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸”éœ€è¦å¸¶ host header è©²æ€éº¼åšã€‚\nNginx çš„ upstream æ˜¯ä»€éº¼ï¼Ÿ\né€šå¸¸æˆ‘å€‘ proxy_pass çš„å¯«æ³•æœƒæ˜¯é€™æ¨£ï¼š\nlocation /aaa { proxy_pass http://aaa.example.com; } ç•¶ Nginx æ”¶åˆ°çš„ request æ˜¯ /aaa æ™‚ï¼Œå°±æœƒå°‡ request è½‰ç™¼åˆ° http://aaa.example.comã€‚\nä½†å‡å¦‚å¾Œç«¯æœ‰å¤šå°æ©Ÿå™¨æˆ–æ˜¯æœå‹™ï¼Œå¯ä»¥è™•ç†åŒä¸€ç¨® requestï¼Œé€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨ upstream ä¾†è™•ç†ï¼š\nupstream backend_hosts { server aaa.example.com; server bbb.example.com; server ccc.example.com; } location /aaa { proxy_pass http://backend_hosts; } é€™æ¨£å­çš„å¥½è™•æ˜¯å¯ä»¥æœ‰å¤šå€‹æ©Ÿå™¨æˆ–æ˜¯å¾Œç«¯æœå‹™å¯ä»¥åˆ†æ•£è«‹æ±‚ï¼Œåšåˆ°è² è¼‰å¹³è¡¡çš„æ•ˆæœã€‚","åƒè€ƒ#åƒè€ƒ":"Make nginx to pass hostname of the upstream when reverseproxyingï¼šhttps://serverfault.com/questions/598202/make-nginx-to-pass-hostname-of-the-upstream-when-reverseproxying","å•é¡Œ#å•é¡Œ":"é‚£å¦‚æœæˆ‘å€‘ä½¿ç”¨ Nginx upstream æ™‚ï¼Œé‚„æƒ³è¦åŒæ™‚å¸¶ host çš„ header åˆ°å¾Œç«¯è©²æ€éº¼åšå‘¢ï¼Ÿæˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ç›®å‰çš„å¯«æ³•ï¼š\n( æ¸¬è©¦ç¯„ä¾‹æ˜¯ä½¿ç”¨ docker ä¾†æ¨¡æ“¬ï¼Œå¯ä»¥åƒè€ƒç¨‹å¼ç¢¼ \u003e é»æˆ‘å‰å¾€ githubï¼Œæœƒæœ‰ä¸‰å€‹ nginxï¼Œå…¶ä¸­ä¸€å€‹æ˜¯è² è²¬ proxy çš„ nginx åç‚º proxyï¼Œå¦å¤–å…©å°æ˜¯ upstream å¾Œçš„æœå‹™ï¼Œåç‚º upstream_server1ã€upstream_server2 )\nnginx-old.conf upstream upstream_server { server upstream_server1; server upstream_server2; } server { listen 80; server_name localhost; location /upstream_server/ { proxy_pass http://upstream_server; proxy_set_header Host \"upstream_server1\"; proxy_set_header Host \"upstream_server2\"; access_log /var/log/nginx/access.log upstream_log; } } } å¯ä»¥çœ‹åˆ°æˆ‘å€‘å¸Œæœ› Nginx æ”¶åˆ° request æ˜¯ /upstream_server æ™‚ï¼Œå°‡ request è½‰ç™¼åˆ° http://upstream_serverï¼Œè€Œ upstream_server å¾Œé¢æœ‰å…©å€‹ serverï¼Œä¸¦ä¸”åœ¨ proxy æ™‚ï¼Œå¸¶å…¥å…©å€‹ä¸åŒçš„ host headerã€‚ä½†å¦‚æœçœŸçš„é€™æ¨£å¯«ï¼Œå¯ä»¥é”åˆ°æˆ‘å€‘æƒ³è¦å¾—æ•ˆæœå—ï¼Ÿæˆ‘å€‘å¯¦éš›è·‘çœ‹çœ‹ç¨‹å¼ (ç¯„ä¾‹å¯ä»¥ä½¿ç”¨ nginx-old.conf)ï¼š\nnginx åŸæœ¬å¯«æ³•\nå¾ä¸Šé¢çš„ LOG å¯ä»¥ç™¼ç¾ï¼Œæˆ‘å€‘ call /upstream_server æ™‚ï¼Œå¾Œç«¯çš„ upstream_server1ã€upstream_server2 æ”¶åˆ°çš„ host åªæœƒæ”¶åˆ°ç¬¬ä¸€å€‹è¨­å®šçš„ Hostï¼Œä¸”æœå‹™æœƒå‡ºç¾ 400 Bad Requestï¼ŒæŸ¥äº†ä¸€ä¸‹ç¶²è·¯æ–‡ç« ï¼Œç™¼ç¾å‡ºç¾ 400 Bad Requestï¼Œå¯èƒ½è·Ÿ header é€å¤ªå¤šè³‡è¨Šéå»ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ è§£æ±ºç¶²ç«™å‡ºç¾ 400 Bad Request ç‹€æ…‹çš„æ–¹æ³•ã€‚\né€™é‚Šæ¨æ¸¬æ‡‰è©²æ˜¯å¾Œç«¯å¦‚æœä¹Ÿæ˜¯ç”¨ nginx ç›´æ¥æ¥æ”¶æ‰æœƒé‡åˆ° 400 çš„å•é¡Œï¼Œé‚„å¥½ç›®å‰å…¬å¸æœå‹™é‚„æ˜¯æ­£å¸¸çš„ xDDï¼Œæª¢æŸ¥ä¸€ä¸‹å¾Œç™¼ç¾ï¼Œå…¶å¯¦å¾Œç«¯æ ¹æœ¬æ²’æœ‰è¦æ±‚å°æ‡‰ header æ‰èƒ½æ¥æ”¶(æ‡‰è©²æ˜¯å°æ–¹å¿˜è¨˜åŠ ä¸Šæ­¤é™åˆ¶)ã€‚","è§£æ±º#è§£æ±º":"å¥½ï¼Œä¸ç®¡æ˜¯å¦éœ€è¦å°æ‡‰ headerï¼Œæˆ‘å€‘é‚„æ˜¯æ‰¾çœ‹çœ‹æœ‰æ²’æœ‰è¾¦æ³•åŒæ™‚ä½¿ç”¨ upstreamï¼Œä¸¦å¸¶å…¥å°æ‡‰ host çš„æ–¹æ³•å‘¢ï¼Ÿ\næœ€å¾Œåƒè€ƒç¶²è·¯ä¸Šçš„æ–‡ç« ï¼Œä¼¼ä¹åªèƒ½ä½¿ç”¨å…©å±¤çš„ proxyï¼Œæ‰èƒ½å®Œæˆé€™å…©å€‹éœ€æ±‚ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹è¦æ€éº¼å¯«å§ (ç¯„ä¾‹å¯ä»¥ä½¿ç”¨ nginx.conf)ï¼š\nnginx.conf server { listen 777; server_name localhost; location / { proxy_pass http://upstream_server1; proxy_set_header Host \"upstream_server1\"; access_log /var/log/nginx/access.log upstream_log; } } server { listen 888; server_name localhost; location / { proxy_pass http://upstream_server2; proxy_set_header Host \"upstream_server2\"; access_log /var/log/nginx/access.log upstream_log; } } upstream upstream_server { server 127.0.0.1:777; server 127.0.0.1:888; } server { listen 80; server_name localhost; location /upstream_server/ { proxy_pass http://upstream_server; access_log /var/log/nginx/access.log upstream_log; } } å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ç¨‹å¼ç¢¼ï¼Œæˆ‘å€‘é€éå…©å±¤çš„ proxyï¼Œä¾†é”åˆ°æˆ‘å€‘æƒ³è¦çš„æ•ˆæœï¼Œé€™æ¨£å­å°±å¯ä»¥åŒæ™‚ä½¿ç”¨ upstreamï¼Œä¸¦ä¸”å¸¶å…¥å°æ‡‰çš„ host headerã€‚\né¦–å…ˆåœ¨ 28 ~ 36 è¡Œï¼Œæˆ‘å€‘ä¸€æ¨£å¦‚æœ Nginx æ”¶åˆ° request æ˜¯ /upstream_server æ™‚ï¼Œæœƒ proxy åˆ° upstream_server é€™å€‹ upstream ä¸­ï¼Œè€Œ upstream_server æœ‰å…©å€‹ serverï¼Œåˆ†åˆ¥æ˜¯ 127.0.0.1:777ã€127.0.0.1:888ï¼Œä½†å¯¦éš›ä¸Šæ²’æœ‰é€™å…©å€‹ portï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å†å¯«ä¸€å±¤ä¸€èˆ¬çš„ proxy è¨­å®šï¼Œåˆ†åˆ¥æ˜¯ 1 ~ 10 è¡Œã€12 ~ 21 è¡Œï¼Œé€™æ¨£å­å°±å¯ä»¥é”åˆ°æˆ‘å€‘æƒ³è¦çš„æ•ˆæœã€‚\nä½†é€™å€‹æ–¹æ³•æ¯”è¼ƒé©ç”¨æ–¼ upstream å¾Œç«¯æ²’æœ‰å¤ªå¤šå€‹æœå‹™æˆ–æ˜¯æ©Ÿå™¨çš„æƒ…æ³ï¼Œå¦‚æœæœ‰å¾ˆå¤šå€‹æœå‹™æˆ–æ˜¯æ©Ÿå™¨ï¼Œå°±éœ€è¦å¯«å¾ˆå¤šçš„ proxyï¼Œé€™æ¨£å­æœƒè®Šå¾—å¾ˆéº»ç…©ï¼Œæ‰€ä»¥å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œä¹Ÿæ­¡è¿ç•™è¨€è·Ÿæˆ‘åˆ†äº« ğŸ¤£ã€‚\næœ€å¾Œæˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹å¯¦éš›åŸ·è¡Œçš„çµæœï¼š\nä½¿ç”¨å¤šå±¤çš„ nginx proxy è™•ç†"},"title":"æƒ³ä½¿ç”¨ Nginx Upstream Proxy åˆ°å¤–éƒ¨æœå‹™ï¼Œä¸¦å¸¶å…¥å°æ‡‰çš„ header è©²æ€éº¼åšï¼Ÿ"},"/blog/nginx/soketi-log-502-error/":{"data":{"":"æ­¤æ–‡ç« è¦ä¾†è¨˜éŒ„ä¸€ä¸‹ RD åŒä»å‰é™£å­æœ‰åæ‡‰ä½¿ç”¨ Soketi é€™å€‹ WebSocket Server æœƒä¸å®šæ™‚åœ¨ LOG å‡ºç¾ 502 error éŒ¯èª¤è¨Šæ¯ä»¥åŠ connect() failed (111: Connection refused) while connecting to upstreamï¼Œé›–ç„¶èªªæœå‹™ä½¿ç”¨ä¸Šä¸æœƒå½±éŸ¿å¾ˆå¤§ï¼Œä½†é‚„æ˜¯å¸Œæœ›æˆ‘å€‘å¯ä»¥å”åŠ©æ‰¾å‡º 502 çš„åŸå› ã€‚\nå‡ºéŒ¯çš„ LOG\nåœ¨é–‹å§‹æ‰¾å•é¡Œå‰ï¼Œå…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ Soketi æ˜¯ä»€éº¼æ±è¥¿å¥½äº†ï¼Œæ ¹æ“šå®˜ç¶²çš„èªªæ˜ï¼Œä»–æ˜¯ç°¡å–®ã€å¿«é€Ÿä¸”æœ‰å½ˆæ€§çš„é–‹æº WebSockets serverï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„å¯ä»¥åˆ°å®ƒå®˜ç¶²å»æŸ¥çœ‹ã€‚\nå¦å¤–æœƒæŠŠç¨‹å¼ç¢¼ç›¸é—œæ”¾åˆ° GitHub Â» é»æˆ‘å‰å¾€","åƒè€ƒ#åƒè€ƒ":"[Nginx] è§£æ±º connect() failed (111: Connection refused) while connecting to upstreamï¼šhttps://wshs0713.github.io/posts/8c1276a7/\nWebSocket proxyingï¼šhttp://nginx.org/en/docs/http/websocket.html\nday 10 Pod(3)-ç”Ÿå‘½é€±æœŸ, å®¹å™¨æ¢æ¸¬ï¼šhttps://ithelp.ithome.com.tw/articles/10236314","å£“æ¸¬#å£“æ¸¬":"æœ€å¾Œèª¿æ•´å®Œï¼Œæˆ‘å€‘ä¾†æ¸¬è©¦çœ‹çœ‹æ˜¯å¦åœ¨ Pod è‡ªå‹•é‡å•Ÿ or æ›´æ–° Deployment çš„æ™‚å€™(ä¸¦ä¸”æœ‰å¤§é‡é€£ç·šæ™‚)é‚„æœƒå™´ 502 error æˆ–æ˜¯ connect() failed (111: Connection refused)ï¼Œæˆ‘å€‘é€™é‚Šä½¿ç”¨ k6 ä¾†åš websocket æœå‹™çš„å£“æ¸¬ï¼Œæœ‰ç°¡å–®å¯«ä¸€å€‹å£“æ¸¬ç¨‹å¼å¦‚ä¸‹ï¼š\nk6 å£“æ¸¬\nk6 æ˜¯ä¸€å€‹é–‹æºçš„å£“æ¸¬å·¥å…·ï¼Œå¯ä»¥ç”¨ä¾†æ¸¬è©¦ APIã€WebSocketã€gRPC ç­‰æœå‹™ï¼Œå¯ä»¥åˆ°å®ƒçš„å®˜ç¶²æŸ¥çœ‹æ›´å¤šè³‡è¨Šã€‚\nMacOS å®‰è£æ–¹å¼ï¼šbrew install k6\nwebsocket.jsimport ws from \"k6/ws\"; import { check } from \"k6\"; export const options = { vus: 1000, duration: \"30s\", }; export default function () { const url = \"wss://socket.XXX.com/app/hex-ws?protocol=7\u0026client=js\u0026version=7.4.1\u0026flash=false\"; const res = ws.connect(url, function (socket) { socket.on(\"open\", () =\u003e console.log(\"connected\")); socket.on(\"message\", (data) =\u003e console.log(\"Message received: \", data)); socket.on(\"close\", () =\u003e console.log(\"disconnected\")); }); check(res, { \"status is 101\": (r) =\u003e r \u0026\u0026 r.status === 101 }); } ç°¡å–®èªªæ˜ä¸€ä¸‹ä¸Šé¢ç¨‹å¼åœ¨å¯«ä»€éº¼ï¼Œæˆ‘å€‘åœ¨ const è¨­å®š vus ä»£è¡¨æœ‰ 1000 å€‹è™›æ“¬ä½¿ç”¨è€…ï¼Œæœƒåœ¨ duration 30s å…§å®Œæˆæ¸¬è©¦ï¼Œä¸‹é¢çš„ default å°±æ˜¯æ¸¬è©¦é€£ç·š ws ä»¥åŠ message è·Ÿ close ç­‰å‹•ä½œï¼Œæœ€å¾Œéœ€è¦å›å‚³ 101 (ws äº¤æ¡)\nåŸ·è¡Œ k6 run websocket.js å¾Œï¼Œå°±æœƒé–‹å§‹å£“æ¸¬ï¼Œå¯ä»¥çœ‹åˆ°æœƒé–‹å§‹åŸ·è¡Œå‰›å‰›åœ¨ä¸Šé¢æåˆ° default çš„å‹•ä½œï¼š\nk6 å£“æ¸¬éç¨‹\nç­‰åˆ°è·‘å®Œï¼Œå°±æœƒå‘Šè¨´ä½  1000 ç­†è£¡é¢æœ‰å¤šå°‘çš„ http 101ï¼Œé€™é‚Šé¡¯ç¤º status is 101ï¼Œå°±ä»£è¡¨éƒ½æ˜¯ 101ï¼Œä»£è¡¨éƒ½æœ‰é€£ç·šæˆåŠŸï¼Œæ²’æœ‰å‡ºç¾ 502 error æˆ–æ˜¯ connect() failed (111: Connection refused) çš„éŒ¯èª¤ï¼Œé€™æ¨£å°±ä»£è¡¨æˆ‘å€‘çš„å•é¡Œè§£æ±ºäº†ã€‚\nk6 å£“æ¸¬çµæœ","è§£æ±ºéç¨‹#è§£æ±ºéç¨‹":"æˆ‘å€‘å¯ä»¥çœ‹åˆ°ä¸Šæ–¹éŒ¯èª¤ LOG ä¸­ï¼Œç™¼ç¾æœ‰å‡ºç¾ 502 error ä»¥åŠ connect() failed (111: Connection refused) while connecting to upstreamï¼Œé€™å…©å€‹éŒ¯èª¤éƒ½æ˜¯ç”± Nginx æ‰€ç”¢ç”Ÿçš„ï¼Œé‚£æˆ‘å€‘å…ˆä¾†ç†è§£ä¸€ä¸‹ï¼ŒNginx èˆ‡ Soketi ä¹‹é–“çš„é—œä¿‚ã€‚\nåœ¨ä½¿ç”¨ä¸Šï¼ŒRD çš„ç¨‹å¼æœƒæ‰“ Soketi å°ˆç”¨çš„ Subdomain ä¾†ä½¿ç”¨é€™å€‹ WebSocket æœå‹™ï¼Œè€Œåœ¨æˆ‘å€‘çš„æ¶æ§‹ä¸Šï¼Œé€™å€‹ Subdomain æœƒç¶“éç”¨ nginx proxy serverï¼Œä¾†è½‰ç™¼åˆ° Soketi WebSocket Server (èµ° k8s svc)ï¼Œè¨­å®šæª”å¦‚ä¸‹åœ–ï¼š\nå…¥å£ nginx è¨­å®š\nç„¶å¾Œæœƒå‡ºç¾ connect() failed (111: Connection refused) while connecting to upstream çš„éŒ¯èª¤è¨Šæ¯ï¼Œä»£è¡¨æˆ‘å€‘çš„ Nginx è¨­å®šå°‘äº†ä¸€å€‹é‡è¦çš„ä¸€è¡Œè¨­å®šï¼Œå°±æ˜¯ proxy_http_version 1.1;ï¼Œé€™å€‹è¨­å®šè¦è®“ Nginx ä½œç‚º proxy å¯ä»¥å’Œ upstream çš„å¾Œç«¯æœå‹™ä¹Ÿæ˜¯ç”¨ keepaliveï¼Œå¿…é ˆä½¿ç”¨ http 1.1ï¼Œä½†å¦‚æœæ²’æœ‰è¨­å®šé è¨­æ˜¯ 1.0ï¼Œä¹Ÿè¦è¨˜å¾—è¨­å®š proxy_set_header Upgradeã€proxy_set_header Connectionã€‚èª¿æ•´éå¾Œå°±è®Šæˆï¼š\nws.confserver { server_name socket.XXX.com; listen 80 ; listen [::]:80 ; listen 443 ssl; listen [::]:443 ssl; ssl_certificate /etc/nginx/ingress.gcp.cert; ssl_certificate_key /etc/nginx/ingress.gcp.key; access_log /var/log/nginx/access.log main; location / { proxy_pass http://soketi-ws-ci:6001; proxy_connect_timeout 10s; proxy_read_timeout 1800s; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"Upgrade\"; proxy_set_header X-Real-IP $remote_addr; } } è§£æ±ºå®Œ connect() failed (111: Connection refused) é€™å€‹å•é¡Œå¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯è¦è§£æ±º 502 error é€™å€‹å•é¡Œï¼Œæœƒå°è‡´ 502 ä»£è¡¨ Nginx é€™å€‹ proxy server é€£ä¸ä¸Šå¾Œç«¯çš„ Soketi WebSocket Serverï¼Œå†è§€å¯Ÿ LOG ä»¥åŠæ¸¬è©¦å¾Œç™¼ç¾ï¼Œç•¶ Pod è‡ªå‹•é‡å•Ÿï¼Œæˆ–æ˜¯æ‰‹å‹•é‡å•Ÿ Deployment çš„æ™‚å€™ï¼Œå°±æœƒæœ‰ 502 çš„éŒ¯èª¤ï¼Œä»£è¡¨ Nginx åœ¨ proxy åˆ°å¾Œé¢çš„ Soketi svc å†åˆ° Pod çš„æ™‚å€™ï¼Œæœ‰ä¸€æ®µæ™‚é–“æ˜¯é€£ä¸ä¸Šçš„ï¼Œæ‰€ä»¥å°±æœƒå‡ºç¾ 502 çš„éŒ¯èª¤ï¼Œå¯ä»¥æ¨æ¸¬æ˜¯æµé‡é€²åˆ°æ­£åœ¨é—œé–‰çš„ Pod æˆ–æ˜¯é€²åˆ°é‚„æ²’æœ‰å•Ÿå‹•å¥½çš„ Pod æ‰å°è‡´çš„ã€‚\né‚£æˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ Soketi WebSocket Server çš„æœå‹™ yaml æª”æ¡ˆï¼š\ndeployment.yaml deployment.yaml spec: terminationGracePeriodSeconds: 30 securityContext: {} containers: - name: soketi securityContext: {} image: \"quay.io/soketi/soketi::1.6.0-16-alpine\" ... çœç•¥ (å¯ä»¥åˆ° github çœ‹ code)... livenessProbe: failureThreshold: 3 httpGet: httpHeaders: - name: X-Kube-Healthcheck value: \"Yes\" path: / port: 6001 initialDelaySeconds: 5 periodSeconds: 2 successThreshold: 1 å¯ä»¥çœ‹åˆ°åŸä¾†çš„è¨­å®šåªæœ‰ livenessProbe è€Œå·²ï¼Œå› æ­¤æˆ‘å€‘ç‚ºäº†è¦é¿å…æµé‡é€²åˆ°æ­£åœ¨é—œé–‰çš„ Pod æˆ–æ˜¯é€²åˆ°é‚„æ²’æœ‰å•Ÿå‹•å¥½çš„ Podï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦åŠ ä¸Š readinessProbe ä»¥åŠ preStopï¼Œè®“ Pod ç¢ºå®šå•Ÿå‹•å®Œç•¢ï¼Œæˆ–æ˜¯ç­‰å¾… Service çš„ endpoint list ä¸­ç§»é™¤ Podï¼Œæ‰é–‹å§‹æ¥æ”¶æµé‡ï¼Œé€™æ¨£å°±å¯ä»¥é¿å…å‡ºç¾ 502 çš„éŒ¯èª¤ã€‚\ndeployment.yaml spec: terminationGracePeriodSeconds: 30 securityContext: {} containers: - name: soketi securityContext: {} image: \"quay.io/soketi/soketi::1.6.0-16-alpine\" ... çœç•¥ (å¯ä»¥åˆ° github çœ‹ code)... livenessProbe: failureThreshold: 3 httpGet: httpHeaders: - name: X-Kube-Healthcheck value: \"Yes\" path: / port: 6001 initialDelaySeconds: 5 periodSeconds: 2 successThreshold: 1 readinessProbe: failureThreshold: 3 httpGet: httpHeaders: - name: X-Kube-Healthcheck value: \"Yes\" path: /ready port: 6001 initialDelaySeconds: 5 periodSeconds: 2 successThreshold: 1 lifecycle: preStop: exec: command: [\"/bin/sh\", \"-c\", \"sleep 20\"] Pod çµ‚æ­¢çš„éç¨‹"},"title":"Soketi WebSocket Server LOG ä¸å®šæ™‚å‡ºç¾ 502 error ä»¥åŠ connect() failed (111: Connection refused)"},"/blog/opentelemetry/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Opentelemetry ç›¸é—œçš„æ–‡ç« ã€‚\nä»€éº¼æ˜¯ Opentelemetryï¼Ÿå¯è§€æ¸¬æ€§ (Observability) åˆæ˜¯ä»€éº¼ï¼Ÿ å¦‚ä½•é€é OpenTelemetry ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š "},"title":"Opentelemetry"},"/blog/opentelemetry/opentelemetry-ingress-nginx-controller/":{"data":{"":"ç”±æ–¼æœ€è¿‘å…¬å¸æƒ³è¦å°å…¥ Datadogï¼Œåœ¨æ¸¬è©¦éç¨‹ä¸­é †ä¾¿å°å…¥ OpenTelemetry ä¾†æ”¶é›† Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š ï½\nğŸ”¥ é€™å€‹ç¯„ä¾‹æ¯”è¼ƒç‰¹åˆ¥ï¼Œå› ç‚º Datadog æœ‰æä¾› Ingress Nginx Controller çš„ integrationsï¼Œå¯ä»¥é€é Datadog Agent ä¾†æ”¶é›† Metricsï¼Œä¸éœ€è¦é€é OpenTelemetry Collector ä¾†æ”¶é›†ã€‚ ( Datadog Agent è«‹åƒè€ƒï¼šhttps://docs.datadoghq.com/containers/kubernetes/ )\nç¨‹å¼éƒ¨åˆ†ä¹ŸåŒæ­¥ä¸Šå‚³åˆ° github ä¸Šï¼Œå¯ä»¥é»æˆ‘å‰å¾€","åƒè€ƒ#åƒè€ƒ":"Configure Nginx Ingress Controller to use JSON log formatï¼šhttps://dev.to/bzon/send-gke-nginx-ingress-controller-logs-to-stackdriver-2ih4\næ·ºè«‡ OpenTelemetry - Collector Compoentsï¼šhttps://ithelp.ithome.com.tw/articles/10290703","åŸ·è¡Œæ­¥é©Ÿ#åŸ·è¡Œæ­¥é©Ÿ":" å…ˆ clone é€™å€‹ repo (å»¢è©± xD)\nå…ˆå»ºç«‹ OpenTelemetry Collectorï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nhelm upgrade collector \\ opentelemetry-collector \\ --repo https://open-telemetry.github.io/opentelemetry-helm-charts \\ --install \\ --create-namespace \\ --namespace opentelemetry \\ -f \"otel-collector.yaml\" å†å»ºç«‹ Ingress Nginx Controllerï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nhelm upgrade ingress-nginx \\ ingress-nginx \\ --repo https://kubernetes.github.io/ingress-nginx \\ --install \\ --create-namespace \\ --namespace ingress-nginx \\ -f \"ingress-nginx-values.yaml\" æ¥è‘—å»ºç«‹æ¸¬è©¦ç”¨ Nginx æœå‹™ï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š\nkubectl apply -f nginx.yaml ","æª”æ¡ˆèªªæ˜#æª”æ¡ˆèªªæ˜":" otel-collector.yamlï¼š OpenTelemetry Collector çš„è¨­å®šæª”ï¼Œä¸»è¦æ˜¯è¨­å®šè¦æ”¶é›†å“ªäº› metricsã€tracesï¼Œä¸¦ä¸”è¦é€åˆ°å“ªå€‹ exporterï¼Œè¦æ³¨æ„çš„æ˜¯ exporters çš„ datadog éœ€è¦è¨­å®š siteã€api_keyï¼Œä»¥åŠ image è¦è¨˜å¾—ç”¨ otel/opentelemetry-collector-contribï¼Œæ‰æœƒæœ‰ datadog çš„ exporterã€‚\ningress-nginx-values.yamlï¼š Ingress Nginx Controller çš„è¨­å®šæª”ï¼Œé€™é‚Šçš„ podAnnotations æ˜¯ç‚ºäº†è®“ Ingress Nginx Controller çš„ Pod èƒ½å¤ é€é Datadog agent æ”¶é›† metrics åˆ° Datadog æ‰åŠ ä¸Šçš„ã€‚\nconfig è£¡é¢çš„è¨­å®šæœ‰å¾ˆå¤šï¼Œä¸»è¦éƒ½æ˜¯ openTelemetry çš„è¨­å®šï¼Œè¦æ³¨æ„çš„æ˜¯ enable-opentelemetry è¦è¨­ç‚º trueï¼Œå¦å¤– otlp-collector-host ä»¥åŠ otlp-collector-port è¦é€åˆ°å“ªå€‹ collector ç­‰ç­‰ä¹Ÿè¦è¨˜å¾—è¨­å®šã€‚ å¦å¤–å¦‚æœæƒ³è¦å°‡ LOG èˆ‡ Trace ä¸²å†ä¸€èµ·ï¼Œè¨˜å¾—è¦æŠŠ log-format è¨­ç‚º jsonï¼Œä¸¦ä¸”å¸¶å…¥ï¼Œtrace_id èˆ‡ span_id ( é€™é‚Šæœ‰å¤šå¸¶ dd.trace_id æ˜¯ç‚ºäº†è®“ datadog å¯ä»¥è‡ªå‹•ä¸²æ¥ LOG \u0026 Trace )ã€‚\nnginx.yamlï¼š ä¸€å€‹ç°¡å–®çš„ Nginx æ•´å¥—æœå‹™ (Deploymentã€Serviceã€Ingress)ï¼Œè¦æ³¨æ„çš„æ˜¯ Ingress éœ€è¦è¨­å®š annotations kubernetes.io/ingress.class: nginx (é€™å€‹æ˜¯ Ingress Nginx Controller çš„é è¨­ class name)ï¼Œæ‰æœƒè¢« Ingress Nginx Controller æ¥ç®¡ (æ‰æœƒæœ‰ Load Balancer çš„ IP)","æ¸¬è©¦#æ¸¬è©¦":"ç•¶ä½ åŸ·è¡Œå®Œä¸Šé¢çš„æ­¥é©Ÿå¾Œï¼Œä½ æœƒç™¼ç¾æœ‰ç”¢ç”Ÿå…©å€‹ namespaceï¼Œä¸€å€‹æ˜¯ ingress-nginxï¼Œå¦ä¸€å€‹æ˜¯ opentelemetryï¼Œä¸¦ä¸”æœƒæœ‰ OpenTelemetry Collectorã€Ingress Nginx Controllerã€Nginx ç­‰æœå‹™ï¼Œå¦‚ä¸‹ï¼š\nå•Ÿå‹•æœå‹™\næˆ‘å€‘è©¦è‘—æ‰“ http://nginx.example.com/ (æ¸¬è©¦ç¶²å€ï¼Œéœ€è¦å…ˆåœ¨ /etc/hosts ç¶å®š Ingress Nginx Controller å’¬ä½çš„ Load Balancer IP)ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ Datadog çš„ LOGï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ”¶åˆ° Nginx çš„ LOG (æ­¤æ”¶é›† LOG çš„æ–¹å¼æ˜¯é€éåœ¨ cluster ä¸Šå®‰è£ Datadog çš„ agent)ï¼Œå¦‚ä¸‹ï¼š\nDatadog LOG\næ¥è‘—æŸ¥çœ‹ Datadog APM çš„ traceï¼Œå¦‚ä¸‹ï¼š\nDatadog APM\nç”±æ–¼æˆ‘å€‘åœ¨å¾Œé¢ç›®å‰æ²’æœ‰ä¸²å…¶ä»–æœå‹™ï¼Œæ‰€ä»¥åªæœ‰ä¸€å€‹ spanï¼Œä¹‹å¾Œé‚„æœ‰å¦å¤–å…©ç¯‡æ–‡ç« æ˜¯ä»‹ç´¹å¦‚ä½•ä¸²å…¶ä»–æœå‹™ (æœƒå¢åŠ æœå‹™ä»¥åŠéƒ¨åˆ†è¨­å®š)ï¼Œå¯ä»¥åƒè€ƒçœ‹çœ‹ï¼šopentelemetry-roadrunnerã€opentelemetry-nodejs\né †ä¾¿çœ‹ä¸€ä¸‹é€é Datadog Agent æ”¶é›†çš„ Ingress Nginx Controller çš„ Metricsï¼Œå¦‚ä¸‹ï¼š\nDatadog Ingress Nginx Controller çš„ Metrics\nå¯ä»¥ç”¨é€™äº› Metrics ä¾†åš Dashboardï¼Œå¦‚ä¸‹ï¼š\nDatadog Dashboard","çµè«–#çµè«–":"é€é OpenTelemetry Collector ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Šï¼Œé€™æ¨£å°±å¯ä»¥é€é Ingress Nginx Controller çš„ Metrics ä¾†åšç›£æ§äº†ï¼Œå°æ–¼ RD å†é–‹ç™¼ä¸Šï¼Œæœ‰ Traces ä¹Ÿæ›´æ–¹ä¾¿ RD ä»–å€‘æ‰¾åˆ°ç¨‹å¼çš„ç“¶é ¸ (æœ‰å¯èƒ½æ˜¯æœå‹™å°è‡´çš„)ã€‚"},"title":"å¦‚ä½•é€é OpenTelemetry ä¾†æ”¶é›† Ingress Nginx Controller çš„ Metrics èˆ‡ Traces ä¸¦é€åˆ° Datadog ä¸Š"},"/blog/opentelemetry/opentelemetry-observability/":{"data":{"":"åœ¨ä»‹ç´¹ Opentelemetry ä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆäº†è§£ä¸€ä¸‹ç›®å‰è»Ÿé«”æ¶æ§‹ä»¥åŠåŸºç¤è¨­æ–½çš„æ¼”é€²ï¼š\nè»Ÿé«”æ¶æ§‹ä»¥åŠåŸºç¤è¨­æ–½çš„æ¼”é€²\nç¬¬ä¸€éšæ®µåœ¨è»Ÿé«”æ¶æ§‹è¨­è¨ˆä¸Šè¼ƒç‚ºç°¡å–®ï¼Œä¸æœƒæœ‰ä»€éº¼ç‰¹åˆ¥éœ€è¦æ‹†åˆ†å‡ºä¾†çš„ç¨‹å¼ï¼Œæ‰€ä»¥éƒ½æ˜¯ä¸€æ•´åŒ…çš„ç¨‹å¼ï¼Œå†æ¸¬è©¦ä»¥åŠé™¤éŒ¯ä¹Ÿæ¯”è¼ƒä¸æœƒæœ‰ä»€éº¼å•é¡Œã€‚åŸºç¤è¨­æ–½éƒ½æ˜¯ä½¿ç”¨ VM æˆ–æ˜¯ä½¿ç”¨æ”¾åœ¨ IDC çš„æ©Ÿæˆ¿ä¾†ç•¶ Serverã€‚\nç¬¬äºŒéšæ®µéš¨è‘—é›²ç«¯æŠ€è¡“çš„æ¨å‡ºï¼Œæœƒé–‹å§‹å°‡æœå‹™æ¬ä¸Šé›²ä¾›æ‡‰å•†æä¾›çš„ IaaS æœå‹™ï¼Œæˆ–æ˜¯ä½¿ç”¨ç§æœ‰é›²çµ¦ä¼æ¥­æ”¾ç½®è¼ƒæ©Ÿå¯†çš„å…§å®¹ï¼Œå…¶ä»–å‰‡æ”¾ç½®å…¬æœ‰é›²ä¸Šï¼Œé”æˆæ··åˆé›²çš„æ¨¡å¼ã€‚\nç¬¬ä¸‰éšæ®µéš¨è‘—é›²ç«¯æŠ€è¡“è¶Šä¾†è¶Šæˆç†Ÿï¼Œæœ‰æ›´å¤šçš„é›²ç«¯ IaC ä»¥åŠåŠŸèƒ½æ¨å‡ºï¼Œæœƒé–‹å§‹è€ƒæ…®ä½¿ç”¨åˆ†æ•£å¼çš„ç³»çµ±æ¶æ§‹ï¼Œå°‡ DB ç­‰æœå‹™ä¹Ÿæ”¹ç”¨ Cloud SQL çš„æ–¹å¼ã€‚åœ¨åŸºç¤è¨­æ–½ä¸Šä¹Ÿéš¨è‘—å®¹å™¨åŒ–çš„æŠ€è¡“æˆç†Ÿè€Œé€²å…¥æ–°çš„æ™‚ä»£ã€‚\nç¬¬å››éšæ®µå·²ç¶“ä½¿ç”¨ docker ä¾†ç®¡ç†å¥½ä¸€é™£å­ï¼Œä½†ç™¼ç¾è™›æ“¬å®¹å™¨æŠ€è¡“åœ¨ç®¡ç†ä¸Šååˆ†ä¸æ–¹ä¾¿ï¼Œå› æ­¤ K8s é€æ¼¸ç››è¡Œï¼Œå°‡æ¶æ§‹å¾åˆ†æ•£å¼æ”¹æˆå¾®æœå‹™çš„æ–¹å¼é€²è¡Œï¼Œåœ¨è®“é–‹ç™¼åœ˜éšŠä½¿ç”¨ä¸Šå¯ä»¥æ›´éˆæ´»ä¸”å®¹æ˜“ã€‚\né›–ç„¶ä½¿ç”¨ K8s å¯ä»¥è®“æˆ‘å€‘çš„æœå‹™æ›´éˆæ´»æ–¹ä¾¿ï¼Œä½†ä¹Ÿæœƒå°‡æœå‹™åˆ‡çš„è¶Šä¾†è¶Šç´°ï¼Œé€™æ™‚æœƒè®“é–‹ç™¼è®Šçš„ååˆ†è¤‡é›œï¼Œæˆ‘å€‘åœ¨æ¶æ§‹ä¸Šå¾ä¸€é–‹å§‹çš„å–®é«”å¼æ¶æ§‹ï¼Œè®Šæˆåˆ†æ•£å¼æ¶æ§‹ï¼Œå†åˆ°æœ€å¾Œçš„å¾®æœå‹™ï¼Œè®“é–‹ç™¼äººå“¡éœ€è¦è™•ç†çš„äº‹æƒ…æœƒè¶Šä¾†è¶Šå¤šã€‚æœå‹™è¦å¦‚ä½•é€£ç·šï¼ŸLog è¦å¦‚ä½•è¨˜éŒ„ï¼Ÿä»¥åŠç•¶ä¸€å€‹è«‹æ±‚æœƒç¶“éå¤šå€‹æœå‹™æ™‚ï¼Œç›¸å°çš„å»¶é²ä¹Ÿæœƒå¢åŠ ï¼Œé€™æ™‚è¦æ€éº¼å»è™•ç†ç­‰ã€‚åœ¨ç›£æ§ä¸Šï¼Œå› ç‚ºæœå‹™åˆ‡åˆ†å¾—å¾ˆç´°ï¼Œç•¶ç·šä¸Šæœ‰ä¸€å€‹æœå‹™æœ‰å•é¡Œæ™‚ï¼Œè¦å¦‚ä½•å¿«é€Ÿçš„æ‰¾åˆ°å•é¡Œé»ä¹Ÿæ˜¯ä¸€å¤§æŒ‘æˆ°ã€‚\nç•¶æˆ‘å€‘ä½¿ç”¨åˆ†æ•£å¼ç³»çµ±æˆ–æ˜¯å¾®æœå‹™æ™‚ç™¼ç”Ÿæ•…éšœæ™‚ï¼Œæœƒå¾ˆé›£å¿«é€Ÿçš„æ¢å¾©æœå‹™ï¼Œå› ç‚ºæ¯å€‹æœå‹™éƒ½äº’ç›¸ä¾è³´ï¼Œåœ¨ä»¥å¾€éƒ½æ˜¯é€éç¶“é©—ä»¥åŠå°ç³»çµ±çš„äº†è§£ä¾†å¾—ä»¥è§£æ±ºã€‚é‚£æœ‰ä»€éº¼å…¶ä»–çš„æ–¹å¼ï¼Œèƒ½å¤ è®“æˆ‘å€‘æ›´å¿«æŒæ¡æ¯å€‹æœå‹™å‘¢ï¼Ÿæˆ‘å€‘å…ˆä¾†äº†è§£ä¸€å€‹åè©ï¼šå¯è§€æ¸¬æ€§(Observability)","opentelemetry#Opentelemetry":"é‚£æˆ‘å€‘é€™æ¬¡è¦ä»‹ç´¹çš„å¯è§€æ¸¬æ€§(Observability)å·¥å…·å°±æ˜¯ Opentelemetryï¼Œç¸®å¯« OTelï¼Œå®ƒæ˜¯ç”± CNCF (Cloud Native Computing Foundation) çµ„ç¹”å­µåŒ–çš„é–‹æºå°ˆæ¡ˆï¼Œåœ¨ 2021 å¹´ 5 æœˆç”± OpenTracing èˆ‡ OpenCensus å…©å€‹æ¡†æ¶åˆä½µï¼Œçµåˆå…©é …åˆ†æ•£å¼è¿½è¹¤æ¡†æ¶æœ€é‡è¦çš„ç‰¹æ€§æˆç‚ºä¸‹ä¸€ä»£æ”¶é›†é™æ¸¬æ•¸æ“šçš„æ–°æ¨™æº–ã€‚\ntelemetry åˆå«åšé™æ¸¬ï¼Œæ˜¯æŒ‡èƒ½å¤ è·¨è¶Šä¸åŒç³»çµ±ä¾†æ”¶é›†è³‡æ–™ (åŒ…å« LOGã€Metricã€trace) çš„èƒ½åŠ›ã€‚\næˆ‘å€‘å¯ä»¥çœ‹ä¸€ä¸‹å®˜ç¶²çš„èªªæ˜ï¼š\nOpentelemetry æ˜¯é›²åŸç”Ÿçš„å¯è§€æ¸¬æ€§(Observability)æ¡†æ¶ï¼Œæä¾›æ¨™æº–åŒ–çš„ APIã€SDK èˆ‡å”è­°è‡ªå‹•æª¢æ¸¬ã€è’é›†ã€å°å‡ºé™æ¸¬æ•¸æ“šè³‡æ–™ (Metricsã€Logã€Trace)ï¼Œä¸¦æ”¯æ´ W3C å®šç¾©çš„ Http trace-context è¦ç¯„ï¼Œé™ä½é–‹ç™¼è€…åœ¨æœé›†é™æ¸¬æ•¸æ“šä¸Šçš„å›°é›£åº¦ï¼Œä»¥åŠæ–¹ä¾¿é€²è¡Œå¾ŒçºŒåˆ†æä»¥åŠæ€§èƒ½çš„å„ªåŒ–ã€‚\nOpentelemetry\nåœ¨ OpenTelemetry æ ¸å¿ƒå…ƒä»¶å¦‚ä¸‹ï¼š\nAPIï¼šé–‹ç™¼äººå“¡å¯ä»¥é€é OpenTelemetry API è‡ªå‹•ç”Ÿæˆã€è’é›†æ‡‰ç”¨ç¨‹å¼(Application)çš„é™æ¸¬æ•¸æ“šè³‡æ–™(Metrics, Log, Trace)ï¼Œæ¯å€‹ç¨‹å¼èªè¨€éƒ½éœ€å¯¦ä½œ OpenTelemetry è¦ç¯„æ‰€å®šç¾©çš„ API æ–¹æ³•ç°½ç« ã€‚\nSDKï¼šæ˜¯ OpenTelemetry API çš„å¯¦ç¾ã€‚\nOTLPï¼šè¦ç¯„å®šç¾©äº†é™æ¸¬æ•¸æ“šçš„ç·¨ç¢¼èˆ‡å®¢æˆ¶ç«¯åŠæœå‹™å™¨ä¹‹é–“å¦‚ä½•äº¤æ›çš„å”è­° (gRPCã€HTTP)ã€‚\nCollectorï¼šOpenTelemetry ä¸­å„²å­˜åº«ï¼Œç”¨æ–¼æ¥æ”¶ã€è™•ç†ã€å°å‡ºé™æ¸¬æ•¸æ“šåˆ°å„ç¨®å¾Œç«¯å¹³å°ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"Observabilityï¼šhttps://linkedin.github.io/school-of-sre/level101/metrics_and_monitoring/observability/\n[OpenTelemetry] ç¾ä»£åŒ–ç›£æ§ä½¿ç”¨ OpenTelemetry å¯¦ç¾ : å¯è§€æ¸¬æ€§(Observability)ï¼šhttps://marcus116.blogspot.com/2022/01/modern-monitoring-using-openTelemetry-with-Observability.html\n[OpenTelemetry] ç¾ä»£åŒ–ç›£æ§ä½¿ç”¨ OpenTelemetry å¯¦ç¾ : OpenTelemetry é–‹æ”¾é™æ¸¬ï¼šhttps://marcus116.blogspot.com/2022/01/opentelemetry-opentelemetry.html\næ·ºè«‡ Observability(ä¸‹)ï¼šhttps://ithelp.ithome.com.tw/m/articles/10287598\nManage services, spans, and traces in Splunk APMï¼šhttps://docs.splunk.com/Observability/apm/apm-spans-traces/traces-spans.html","å¯è§€æ¸¬æ€§observability#å¯è§€æ¸¬æ€§(Observability)":"å¯è§€æ¸¬æ€§æœ‰ä¸‰å€‹é‡è¦çš„ç‰¹æ€§ï¼Œåˆ†åˆ¥æ˜¯ï¼š\nMetrics è² è²¬ç›£æ§ç³»çµ±æœ‰ä»€éº¼ç‹€æ³ï¼Œç•¶è¦ç™¼ç”Ÿæœå‹™æ•…éšœå‰å¯ä»¥é€éè¨­å®šé–¥å€¼æ­é…å‘Šè­¦ææ—©å¾—çŸ¥ã€‚\nLogs ç•¶å•é¡Œç™¼ç”Ÿæ™‚ï¼Œå¯ä»¥ç”¨ä¾†æŸ¥çœ‹æ•…éšœæ™‚æ­£åœ¨åŸ·è¡Œå“ªäº›æœå‹™ï¼Œä»¥åŠç”¢ç”Ÿçš„éŒ¯èª¤è³‡è¨Šã€‚\nTraces ï¼ˆå¾Œé¢è©³ç´°ä»‹ç´¹ï¼‰\nå¯è§€æ¸¬æ€§ä¸‰å¤§æ”¯æŸ±\næˆ‘å€‘å°æ–¼ Metrics è·Ÿ Logs æœ‰åŸºæœ¬çš„äº†è§£ï¼Œæ‰€ä»¥æˆ‘é€™é‚Šæœƒæ³¨é‡åœ¨ Traces çš„éƒ¨åˆ†ï¼š\nç•¶æœ‰å¤šå€‹å¾®æœå‹™çš„è¤‡é›œåˆ†æ•£å¼ç³»çµ±ï¼Œç”¨æˆ¶çš„è«‹æ±‚æœƒç”±ç³»çµ±ä¸­çš„å¤šå€‹å¾®æœå‹™é€²è¡Œè™•ç†ã€‚Metrics è·Ÿ Logs å¯ä»¥æä¾›æˆ‘å€‘æœ‰é—œç³»çµ±å¦‚ä½•å»è™•ç†é€™äº›è«‹æ±‚çš„ä¸€äº›è³‡è¨Šï¼Œä½†æ²’æœ‰è¾¦æ³•æä¾›å¾®æœå‹™çš„è©³ç´°è¨Šæ¯ä»¥åŠä»–æ˜¯å¦‚ä½•å½±éŸ¿å®¢æˆ¶ç«¯çš„è«‹æ±‚ã€‚é€™æ™‚å€™å°±éœ€è¦é€é Trace ä¾†å”åŠ©æˆ‘å€‘è¿½è¹¤ã€‚\nTrace å¯ä»¥åœ¨é€£çºŒçš„æ™‚é–“ç¶­åº¦ä¸Šï¼Œé€é Trace ä»¥åŠ Span é—œè¯ï¼ŒæŠŠç©ºé–“çµ¦æ’åˆ—å±•ç¤ºå‡ºä¾†ï¼Œä¸¦ä¸”æœ‰ Trace-Context è¦ç¯„ï¼Œèƒ½å¤ ç›´è§€çš„çœ‹åˆ°è«‹æ±‚åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ç¶“éæ‰€æœ‰æœå‹™çš„ç´€éŒ„ã€‚\nä»€éº¼æ˜¯ Traceã€Span ã€Trace-Context å‘¢ï¼Ÿ\næˆ‘å€‘å…ˆèªª Spanï¼ŒSpan åˆå¯ä»¥å«è·¨åº¦ï¼Œæ˜¯ç³»çµ±ä¸­æœ€å°çš„å–®ä½ï¼Œå¯ä»¥çœ‹ä¸‹æ–¹åœ–ç‰‡ï¼ŒSpanA çš„è³‡æ–™æ˜¯ä¾†æº SpanBï¼ŒSpanB ä¾†æºæ˜¯ SpanC ç­‰ç­‰ï¼Œæ¯ä¸€å€‹ Span å¯ä»¥æŠŠå®ƒæƒ³æˆä¸€å€‹è«‹æ±‚å¾Œé¢æ‰€æœ‰ç¶“éæœå‹™çš„å·¥ä½œæµç¨‹ï¼Œä¾‹å¦‚ï¼šnginx_moduleã€dbã€redis ç­‰ç­‰ã€‚\nè«‹æ±‚çš„æ•´å€‹éç¨‹å«åš Traceï¼Œé‚£ä»–è¦æ€éº¼çŸ¥é“ SpanA ~ SpanE æ˜¯åŒä¸€å€‹è«‹æ±‚å‘¢ï¼Ÿ\nå°±éœ€è¦é€é TraceID ä»¥åŠ SpanID ä¾†è¨˜éŒ„ï¼š\nTraceIDï¼šæ˜¯å”¯ä¸€çš„ IDï¼Œç”¨æ–¼è­˜åˆ¥æ•´å€‹åˆ†æ•£å¼è¿½è¹¤çš„ä¸€æ¢è«‹æ±‚è·¯å¾‘ã€‚åœ¨ä¸‹æ–¹åœ–ç‰‡ä¸­ï¼Œç•¶è«‹æ±‚é€²å…¥æ™‚ï¼Œå°±æœƒè¢«è³¦äºˆä¸€å€‹ TraceIDï¼Œæ‰€æœ‰æœ‰ç¶“éçš„ Span éƒ½æœƒè¨˜éŒ„æ­¤ TraceIDï¼Œé€™æ¨£æ‰å¯ä»¥æŠŠä¸åŒæœå‹™ä¾æ“š TraceID é—œè¯æˆåŒä¸€å€‹è«‹æ±‚ã€‚\nSpanIDï¼šæ˜¯ä¸€æ¢è«‹æ±‚è·¯å¾‘ä¸­å–®å€‹æ“ä½œå”¯ä¸€çš„ IDã€‚è¿½è¹¤è·¯å¾‘æ˜¯ç”±å¤šå€‹ Span çµ„æˆï¼Œæ¯å€‹ Span éƒ½ä»£è¡¨ä¸€å€‹æ“ä½œæˆ–ç‰¹å®šçš„æ™‚é–“æ®µã€‚ç•¶è«‹æ±‚é€²å…¥æ™‚ï¼Œæ¯å€‹æœå‹™å°±æœƒç”¢ç”Ÿä¸€å€‹ Span ä¾†ä»£è¡¨å®ƒè™•ç†è«‹æ±‚çš„çš„æ™‚é–“ã€‚é€™äº› Span ä½¿ç”¨ TraceID ä¾†é€£æ¥å†ä¸€èµ·ï¼Œå½¢æˆå®Œæ•´çš„è«‹æ±‚è¿½è¹¤ã€‚\nTrace ç¤ºæ„åœ–\né‚£è¦æ€éº¼æŸ¥çœ‹æ¯å€‹ Span çš„ç´€éŒ„å…§å®¹å‘¢ï¼Œå°±éœ€è¦ Trace-Contextï¼š\næœƒæ”¾ç½®ä¸€äº›ç”¨æ–¼è¿½è¹¤å’Œè­˜åˆ¥è«‹æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚ Trace IDã€Span ID å’Œå…¶ä»–ç›¸é—œçš„æ•¸æ“šã€‚é€™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯å¯ä»¥æ˜¯ä¸€äº›é—œéµçš„æ•¸æ“šï¼Œå¯ä»¥å¹«åŠ©æˆ‘å€‘åœ¨æ•´å€‹åˆ†ä½ˆå¼ç³»çµ±ä¸­è¿½è¹¤è«‹æ±‚çš„è·¯å¾‘ï¼Œä¸¦å°‡ç›¸é—œè«‹æ±‚å’Œæ“ä½œé—œè¯èµ·ä¾†ã€‚\nECK Trace ç¤ºæ„åœ–\nä¸Šé¢çš„åœ–ç‰‡ä¸­ï¼Œå¯ä»¥çœ‹åˆ° call /product/XXXX å¾Œï¼Œæœƒç¶“ééœ€å¤šçš„ Spanï¼Œéš¨ä¾¿é»æ“Šä¸€å€‹ Span å¯ä»¥çœ‹åˆ°å®ƒè¨˜éŒ„çš„ Trace-Contextï¼Œä»¥åŠéƒ½æœƒåŒ…å« TraceID åŠ SpanID\nECK Trace ç¤ºæ„åœ–\nTrace å„ªé»å¯ä»¥çœ‹åˆ°è·¨ç¶­åº¦çœ‹åˆ°ä¸­é–“çš„è³‡è¨Šï¼Œå°æ–¼æ‰¾åˆ°å•é¡Œä»¥åŠç“¶é ¸ååˆ†æ–¹ä¾¿ï¼Œä½†ç¼ºé»å°±æ˜¯å› ç‚ºéœ€è¦åœ¨ Span ä¸­ç”¢ç”Ÿ ID ä»¥åŠå…§å®¹ï¼Œéœ€è¦åœ¨ç¨‹å¼è£¡é¢åŠ å…¥ä¸€å®šçš„å¥—ä»¶ä»¥åŠèª¿æ•´ç¨‹å¼ç¢¼ã€‚\næ‰€ä»¥æˆ‘å€‘åœ¨å¯è§€æ¸¬æ€§(Observability)æœ€çµ‚çš„ç›®çš„æ˜¯å¸Œæœ›å¯ä»¥é€éå¯è§€æ¸¬æ€§å·¥å…·è®“æˆ‘å€‘çŸ¥é“ï¼š\nè«‹æ±‚é€šéå“ªäº›æœå‹™ æ¯å€‹æœå‹™åœ¨è™•ç†è«‹æ±‚æ™‚åšäº†äº›ä»€éº¼ å¦‚æœè«‹æ±‚å¾ˆæ…¢ï¼Œç“¶é ¸åœ¨å“ªé‚Š å¦‚æœè«‹æ±‚å¤±æ•—ï¼ŒéŒ¯èª¤é»åœ¨å“ª è«‹æ±‚çš„è·¯å¾‘æ˜¯ä»€éº¼ ç‚ºä»€éº¼èŠ±é€™éº¼é•·çš„æ™‚é–“ "},"title":"ä»€éº¼æ˜¯ Opentelemetryï¼Ÿå¯è§€æ¸¬æ€§ (Observability) åˆæ˜¯ä»€éº¼ï¼Ÿ"},"/blog/terraform/":{"data":{"":"æ­¤åˆ†é¡åŒ…å« Terraform ç›¸é—œçš„æ–‡ç« ã€‚\nå¦‚ä½•å°å…¥ Terragruntï¼ŒTerragrunt å¥½è™•æ˜¯ä»€éº¼ï¼Ÿ "},"title":"Terraform"},"/blog/terraform/terragrunt/":{"data":{"":"æˆ‘å€‘æ¥çºŒä¸Šä¸€ç¯‡çš„ å¦‚ä½•å°‡ Terraform æ”¹å¯«æˆ module ? ï¼Œæˆ‘å€‘å·²ç¶“å°‡ Terraform æ”¹æˆ module çš„æ–¹å¼ä¾†é€²è¡Œç®¡ç†ï¼Œä½†ç•¶æˆ‘å€‘è¦ç®¡ç†çš„è³‡æºè¶Šä¾†è¶Šå¤šï¼Œä¸”æœ‰åˆ†ä¸åŒçš„å°ˆæ¡ˆæ™‚ï¼Œæ•´å€‹æœå‹™æ¶æ§‹æœƒé•·çš„åƒä»¥ä¸‹ï¼š\nmodules google_compute_instance main.tf outputs.tf variables.tf projects gcp-1234 aaa backend.tf main.tf provider.tf bbb backend.tf main.tf provider.tf ccc backend.tf main.tf provider.tf gcp-2345 aaa backend.tf main.tf provider.tf bbb backend.tf main.tf provider.tf ccc backend.tf main.tf provider.tf gcp-3456 aaa backend.tf main.tf provider.tf bbb backend.tf main.tf provider.tf ccc backend.tf main.tf provider.tf é€™é‚Šçš„ç¯„ä¾‹æ˜¯ä»¥ä¸åŒå°ˆæ¡ˆä¾†åˆ†ï¼Œå†åˆ†å€ä¸åŒçš„æœå‹™ï¼Œæ¯å€‹æœå‹™è£¡é¢éƒ½æœƒæœ‰ backend.tfã€main.tfã€provider.tf æª”æ¡ˆæ‰€çµ„æˆï¼Œæˆ‘å€‘å¯ä»¥ä¾†æ¯”è¼ƒä¸€ä¸‹ gcp-1234 çš„ aaa æœå‹™ä»¥åŠ gcp-2345 çš„ aaa æœå‹™å·®ç•°ï¼š\næª”æ¡ˆå·®ç•°\nå¯ä»¥çœ‹åˆ°åœ¨ backend.tf é™¤äº† prefix è·¯å¾‘ä»¥å¤–ï¼Œå…¶ä»–è¨­å®šä¹Ÿéƒ½ä¸€æ¨£ï¼Œä½†å› ç‚º Terraform æœ¬èº«æ²’è¾¦æ³•é€éå¸¶å…¥åƒæ•¸çš„æ–¹å¼ä¾†è¨­å®š backend.tf å¾Œç«¯éƒ¨åˆ†ï¼Œæ‰€ä»¥å¿…é ˆè¦å…ˆå¯«å¥½æ¯å€‹æœå‹™æ‰€å­˜æ”¾çš„å¾Œç«¯ä½ç½®ï¼Œååˆ†çš„ä¸æ–¹ä¾¿ã€‚\nbackend.tfterraform { backend \"gcs\" { bucket = \"terragrunt-tfstate\" prefix = \"/gcp-1234-aaa\" } } ç‚ºäº†æ¸›å°‘ä¸Šè¿°é€™äº›éœ€è¦ä¸€ç›´é‡è¤‡å¯«å·®ä¸å¤šæª”æ¡ˆçš„å·¥ä½œå…§å®¹ï¼Œå› æ­¤æœ‰äº† Terragrunt é€™å€‹å·¥å…·ï¼ŒTerragrunt æ˜¯ Terraform çš„åŒ…è£å™¨ï¼Œå¯ä»¥å½Œè£œ Terraform ä¸Šçš„ä¸€äº›ç¼ºé™·ï¼Œä¸¦ä¸”è®“æˆ‘å€‘çš„ IaC æ›´è²¼è¿‘ DRY åŸå‰‡ã€‚\né€™é‚Šèªªæ˜ä¸€ä¸‹ DRY åŸå‰‡\nDRY å…¨åæ˜¯ Donâ€™t repeat yourselfï¼Œä¹Ÿå°±æ˜¯ä¸è¦åšé‡è¤‡çš„äº‹æƒ…ï¼Œèƒ½å¤ ä¸€æ¬¡åšå®Œçš„å°±ä¸è¦é‡è¤‡çš„å»åšã€‚","terragrunt-å¥½è™•#Terragrunt å¥½è™•":"\næ¥è‘—ä»‹ç´¹ä¸€ä¸‹ Terragrunt çš„å¥½è™•ï¼š\næ–¹ä¾¿ç®¡ç†å¾Œç«¯ç‹€æ…‹è¨­å®š\nå°‡å¾Œç«¯å­˜å„²æ¡¶ç´å…¥ç®¡ç†\nä½¿ç”¨ generate è‡ªå‹•ç”Ÿæˆæª”æ¡ˆ\nä½¿ç”¨ include æª”æ¡ˆä¾†é”åˆ° DRY åŸå‰‡\nç®¡ç† Module ä¹‹é–“çš„ä¾è³´æ€§\nç”¢ç”Ÿä¾è³´é—œè¯åœ–\næ–¹ä¾¿ç®¡ç†å¾Œç«¯ç‹€æ…‹è¨­å®š é¦–å…ˆç¬¬ä¸€å€‹æ–¹ä¾¿ç®¡ç†å¾Œç«¯ç‹€æ…‹è¨­å®šï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘ä¸Šé¢æåˆ°çš„ backend.tf è¨­å®šã€‚åœ¨ Terraform åŸç”Ÿç‚ºäº†å€åˆ¥ä¸åŒå°ˆæ¡ˆä¸åŒæœå‹™çš„ç‹€æ…‹æª”ï¼Œå°±å¿…é ˆå…ˆå¯«å¥½æ¯å€‹å„²å­˜çš„è·¯å¾‘ï¼Œä½†ä½¿ç”¨ Terragruntï¼Œå¯ä»¥å…ˆåœ¨è©²ç›®éŒ„ä¸‹ï¼Œä¹Ÿå°±æ˜¯ gcp-3456 ç›®éŒ„ä¸‹å…ˆå¯«ä¸€å€‹è¨­å®šæª”æ¡ˆ (æˆ‘å€‘ä»¥ gcp-3456 å°ˆæ¡ˆç‚ºä¾‹)ï¼Œè®“åº•ä¸‹çš„ aaaã€bbbã€ccc æœå‹™å¯ä»¥å» include å®ƒï¼Œæˆ‘å€‘å°±ä¸éœ€è¦æ¯å€‹æœå‹™éƒ½å¯«å¹¾ä¹å·®ä¸å¤šçš„è¨­å®šæª”ï¼Œæ¥è‘—æˆ‘å€‘åœ¨ gcp-3456 è³‡æ–™å¤¾ä¸‹æ–°å¢ terragrunt.hcl æª”æ¡ˆä¾†èªªæ˜ï¼š\nterragrunt.hclremote_state { backend = \"gcs\" generate = { path = \"backend.tf\" if_exists = \"overwrite\" } config = { bucket = \"terragrunt-tfstate\" prefix = \"${path_relative_to_include()}\" } } é€™é‚Šçš„è¨­å®šå…¶å¯¦è·Ÿä¹‹å‰çš„ backend.tf å·®ä¸å¤šï¼Œåªæ˜¯å¾Œç«¯ç¾åœ¨å„²å­˜çš„ block æ”¹å«åš remote_stateï¼Œå¯ä»¥çœ‹åˆ° backend è¨­å®šæˆ‘å€‘ä¸€æ¨£æ˜¯å­˜åœ¨ gcs ä¸Šï¼Œgenerate é€™å€‹ block å®ƒæœƒåˆ¤æ–· backend.tf æª”æ¡ˆæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ²’æœ‰å®ƒå°±æœƒå¹«æˆ‘å€‘å»ºç«‹ï¼Œå…¶ä¸­è¨­å®šæª”æ¡ˆå…§å®¹æ˜¯å°‡ç‹€æ…‹æª”æ¡ˆå­˜åœ¨ terragrunt-tfstate é€™å€‹ bucketï¼Œä¸¦é€é${path_relative_to_include()} é€™å€‹è®Šæ•¸ä¾†è‡ªå‹•å¸¶å…¥æœ‰ include é€™ä»½æª”æ¡ˆçš„è·¯å¾‘ï¼Œä¸¦åœ¨ç›¸å°è·¯å¾‘ç”¢ç”Ÿ backend.tf æª”æ¡ˆã€‚\næœ‰é»æŠ½è±¡ï¼Œæ‰€ä»¥æˆ‘ç•«ä¸€å€‹æ¯”è¼ƒç°¡å–®çš„æ¶æ§‹åœ–ä¾†åšèªªæ˜ä¸€ä¸‹ï¼Œå‡è¨­ç¾åœ¨æœ‰ä¸‰å€‹æœå‹™ï¼Œå¦‚ä¸‹ï¼š\naaa terragrunt.hcl bbb terragrunt.hcl ccc terragrunt.hcl terragrunt.hcl æˆ‘å€‘å‰›å‰›çš„å¾Œç«¯è¨­å®šæ˜¯å¯«åœ¨æ­¤æ ¹ç›®éŒ„çš„ terragrunt.hcl æª”æ¡ˆ(ç¬¬ 8 è¡Œ)ï¼Œç„¶å¾Œ ccc é€™å€‹æœå‹™å» include æ ¹ç›®éŒ„çš„ terragrunt.hcl æª”æ¡ˆï¼Œ Terragrunt å°±æœƒè‡ªå‹•å¹«ä½ ç”¢ç”Ÿä»¥ä¸‹çš„ backend.tf æª”æ¡ˆï¼š\nbackend.tfterraform { backend \"gcs\" { bucket = \"terragrunt-tfstate\" prefix = \"/ccc\" } } é€™æ¨£å°±å¯ä»¥çœä¸‹æˆ‘å€‘è¦é‡è¤‡å¯« backend.tf çš„æ™‚é–“ï¼Œåœ¨ç¶­è­·ä¸Šä¹Ÿæœƒæ›´åŠ çš„æ–¹ä¾¿ã€‚\nå°‡å¾Œç«¯å­˜å„²æ¡¶ç´å…¥ç®¡ç† æ¥è‘—ï¼Œå¤§å®¶æœ‰æ²’æœ‰æƒ³éï¼Œæˆ‘å€‘éƒ½å·²ç¶“ä½¿ç”¨ Terraform ä¾†ç®¡ç† IaC ï¼Œä¸¦æŠŠç‹€æ…‹æª”æ¡ˆæ”¾åˆ° gcs ä¸Šé¢ä¾†ä¿å­˜ï¼Œä½†ä¸€é–‹å§‹é‚„æ²’æœ‰ç”¨ Terraform ç®¡ç† gcs çš„è³‡æºï¼Œæˆ‘å€‘é‚„éœ€è¦åœ¨è¨­å®š backend.tf å‰ï¼Œå…ˆæ‰‹å‹•å»æ–°å¢ä¸€å€‹ gcs ï¼Œæ‰èƒ½ä¾†å­˜æ”¾ tfstate ç‹€æ…‹æª”æ¡ˆå‘¢ï¼Ÿ\nå› æ­¤åœ¨ Terragrunt remote_state çš„ config æ™‚ï¼Œå¯ä»¥å¤šè¨­å®š gcs çš„ project id ä»¥åŠ locationï¼ŒTerragrunt åœ¨åˆå§‹åŒ–å¾Œç«¯æ™‚ï¼Œæœƒæª¢æŸ¥æ˜¯å¦æœ‰è©² gcs bucketï¼Œå¦‚æœæ²’æœ‰å°±æœƒè‡ªå‹•å»ºç«‹ï¼Œè¨­å®šæª”å¦‚ä¸‹ï¼š\nterragrunt.hclremote_state { backend = \"gcs\" generate = { path = \"backend.tf\" if_exists = \"overwrite\" } config = { project = \"gcp-xxxxxx\" location = \"asia\" bucket = \"terragrunt-tfstate\" prefix = \"${path_relative_to_include()}\" } } ä½¿ç”¨ generate è‡ªå‹•ç”Ÿæˆæª”æ¡ˆ åœ¨å‰›å‰›æˆ‘å€‘å¯ä»¥ä½¿ç”¨ generate ä¾†è‡ªå‹• backend.tf æª”æ¡ˆï¼Œé‚£ä»£è¡¨æˆ‘å€‘ä¹Ÿå¯ä»¥æŠŠæ¯å€‹ provider.tf çš„å…§å®¹ï¼Œä¹Ÿé€é generate ä¾†ç”Ÿæˆï¼Œå¦‚ä¸‹ï¼š\nterragrunt.hclgenerate \"provider\" { path = \"provider.tf\" if_exists = \"overwrite\" contents = \u003c\u003cEOF terraform { required_providers { google = { source = \"hashicorp/google\" version = \"~\u003e 4.48.0\" } } } EOF } é€™æ¨£å­æ¯å€‹ include é€™ä»½è¨­å®šæª”çš„æœå‹™é™¤äº† backend.tf æª”æ¡ˆä»¥å¤–ï¼Œé‚„æœƒè‡ªå‹•ç”¢ç”Ÿ provider.tf æª”æ¡ˆã€‚\nä½¿ç”¨ include æª”æ¡ˆä¾†é”åˆ° DRY åŸå‰‡ æˆ‘å€‘æå®šäº† backend.tf è·Ÿ provider.tf å¾Œï¼Œé‚„å‰©ä¸‹ main.tfï¼Œæ‰€ä»¥æˆ‘å€‘ä¹Ÿå°‡å®ƒæ”¹æˆ Terragrunt çš„æ ¼å¼å¦‚ä¸‹ï¼š\nterragrunt.hclterraform { source = \"${get_path_to_repo_root()}/modules/google_compute_instance\" } include \"root\" { path = find_in_parent_folders() } inputs = { instance_name = \"gcp-3456-ccc\" machine_type = \"e2-small\" instance_zone = \"asia-east1-b\" instance_tags = [] instance_labels = {} boot_disk_auto_delete = true boot_disk_image_name = \"debian-cloud/debian-10\" ... è¨­å®šéƒ¨åˆ†çœç•¥ ... } é€™é‚Šå¯ä»¥çœ‹åˆ° terraform source å®ƒå°±æ˜¯æˆ‘å€‘ä½¿ç”¨ module çš„è·¯å¾‘ï¼Œä¹Ÿå¯ä»¥ç”¨ ${get_path_to_repo_root()} é€™å€‹è®Šæ•¸ä»–æœƒè‡ªå‹•æŠ“è©²å°ˆæ¡ˆçš„æ ¹ç›®éŒ„ï¼Œæˆ‘å€‘å°±ä¸éœ€è¦å»ç‰¹åˆ¥è¨­å®šã€‚\næ­¤å¤–ä¹Ÿå¯ä»¥å°‡ module ç¨ç«‹æˆä¸€å€‹å°ˆæ¡ˆï¼Œæˆ–æ˜¯ä½¿ç”¨å…¶ä»–äººå¯«å¥½çš„ moduleï¼Œåœ¨ source çš„æ™‚å€™å¯ä»¥ä½¿ç”¨ git::https://[gitlab-ç¶²å€]/sre/terraform/module.git//google_compute_address çš„æ–¹å¼ä¾†å–å¾— moduleï¼Œå¯ä»¥è¨­å®šè¦ä½¿ç”¨å“ªå€‹åˆ†æ”¯æˆ–æ˜¯ tagï¼Œåªéœ€è¦åœ¨ç¶²å€å¾Œé¢åŠ ä¸Šï¼Œ?ref=[åˆ†ä¹‹ or tag åç¨±] å³å¯ï¼Œé€™æ¨£å¯ä»¥è®“é–‹ç™¼ä¸­çš„ module ä¸æœƒå½±éŸ¿åˆ°ç·šä¸Šå…¶ä»–æ­£åœ¨ä½¿ç”¨ä¸­çš„ module è¨­å®šã€‚\n(module.git å¾Œé¢çš„ // æ˜¯ Terraform module source çš„è¦å‰‡ï¼Œå¦‚æœä¸åŠ æœƒè·³è­¦å‘Šè¨Šæ¯)\næ¥è‘—æˆ‘å€‘å¯ä»¥çœ‹åˆ° include \"root\" {} é€™æ®µï¼Œè£¡é¢æœ‰ä½¿ç”¨ find_in_parent_folders é€™é‚Šè®Šæ•¸ï¼Œä»–å°±æ˜¯ä¸Šé¢çš„æåˆ°æœƒè‡ªå‹•å»æŠ“æ”¾åœ¨çˆ¶è³‡æ–™å¤¾çš„ remote_state è·Ÿ generate terragrunt.hcl æª”æ¡ˆã€‚\nå¾Œé¢çš„ input å°±è·Ÿä½¿ç”¨ module æ™‚ä¸€æ¨£ï¼Œå°‡ module çš„åƒæ•¸å¸¶å…¥å³å¯ã€‚\nè£œå……ï¼šæ‰€ä»¥æˆ‘å€‘ä¹Ÿå¯ä»¥æŠŠä¸€äº›é€šç”¨çš„è¨­å®šå¯«åœ¨æ ¹ç›®éŒ„çš„ terragrunt.hcl æª”æ¡ˆï¼Œä¾‹å¦‚å°ˆæ¡ˆçš„ idï¼Œå¯ä»¥å¯«ä»¥ä¸‹å…§å®¹ä¾†è®“ include å®ƒçš„æª”æ¡ˆåƒåˆ°åŒä¸€å€‹åƒæ•¸è¨­å®šï¼š\nterragrunt.hclinputs = { project_id = \"gcp-3456\" } ç®¡ç† Module ä¹‹é–“çš„ä¾è³´æ€§ ç”±æ–¼ Terragrunt æ˜¯æŠŠæ¯å€‹æœå‹™æ‹†åˆ†æˆæœ€å°åŒ–ï¼Œæ²’è¾¦æ³•æŠŠä½¿ç”¨ä¸åŒ module çš„è³‡æºæ”¾åœ¨ä¸€èµ·(å–®ç´”ä½¿ç”¨ module çš„è©±ï¼Œå¯ä»¥ä¸€æ¬¡ source å¤šäº† moduleï¼Œä¸¦æŠŠä»–æ”¾åœ¨åŒä¸€å€‹ tf æª”æ¡ˆä¸­)ï¼Œé‚£åƒæ˜¯æˆ‘å€‘å»ºç«‹ k8s æœƒä½¿ç”¨åˆ° google_container_clusterã€google_container_node_pool å…©ç¨®ä¸åŒçš„ module è©²æ€éº¼è¾¦å‘¢ï¼Ÿ\né¦–å…ˆæˆ‘å€‘å…ˆåœ¨ modules è³‡æ–™å¤¾æ”¾ä¸Š google_container_clusterã€google_container_node_pool å…©å€‹ module çš„è¨­å®šæª”æ¡ˆï¼Œè©³ç´°ç¨‹å¼å¯ä»¥é»æˆ‘å‰å¾€\nmodules google_container_cluster main.tf outputs.tf variables.tf google_container_node_pool main.tf variables.tf åœ¨ projects åº•ä¸‹æ–°å¢ gke è³‡æ–™å¤¾ï¼Œæ–°å¢ terragrunt.hcl ä¾†æ”¾ remote_state provider çš„è¨­å®šï¼Œä¸¦å€åˆ†å…©å€‹è³‡æ–™å¤¾ï¼Œåˆ†åˆ¥æ˜¯ cluster è³‡æ–™å¤¾ä¾†å­˜æ”¾ cluster è³‡è¨Šï¼Œä»¥åŠ test è³‡æ–™å¤¾ä¾†å­˜æ”¾ test node-pool è³‡è¨Šï¼š\nprojects gke cluster terragrunt.hcl terragrunt.hcl test terragrunt.hcl cluster çš„ terragrunt.hcl æª”æ¡ˆå¦‚ä¸‹ï¼š\nterragrunt.hclterraform { source = \"${get_path_to_repo_root()}/modules/google_container_cluster\" } include { path = find_in_parent_folders() } inputs = { cluster_name = \"tf-test\" cluster_location = \"asia-east1-b\" node_locations = [] cluster_version = \"1.24.12-gke.500\" network_name = \"projects/gcp-202011216-001/global/networks/bbin-testdev\" subnetwork_name = \"projects/gcp-202011216-001/regions/asia-east1/subnetworks/bbin-testdev-dev-platform\" node_max_pods = 64 remove_default_node_pool = true initial_node_count = 1 enable_shielded_nodes = false resource_labels = { \"dept\" : \"pid\", \"env\" : \"dev\", \"product\" : \"bbin\" } dns_enabled = false cluster_dns = \"PROVIDER_UNSPECIFIED\" cluster_dns_scope = \"DNS_SCOPE_UNSPECIFIED\" private_cluster_ipv4_cidr = \"172.16.0.176/28\" binary_authorization_enabled = true binary_authorization = \"DISABLED\" } test node-pool æª”æ¡ˆå¦‚ä¸‹ï¼š\nterragrunt.hclterraform { source = \"${get_path_to_repo_root()}/modules/google_container_node_pool\" } include { path = find_in_parent_folders() } dependency \"cluster\" { config_path = \"../cluster\" } inputs = { cluster_name = dependency.cluster.outputs.cluster_name cluster_location = dependency.cluster.outputs.cluster_location cluster_version = dependency.cluster.outputs.cluster_version node_pool_name = \"test\" node_count = 1 node_machine_type = \"e2-small\" node_disk_size = 100 node_disk_type = \"pd-standard\" node_image_type = \"COS_CONTAINERD\" node_oauth_scopes = [ \"https://www.googleapis.com/auth/devstorage.read_only\", \"https://www.googleapis.com/auth/logging.write\", \"https://www.googleapis.com/auth/monitoring\", \"https://www.googleapis.com/auth/service.management.readonly\", \"https://www.googleapis.com/auth/servicecontrol\", \"https://www.googleapis.com/auth/trace.append\" ] node_tags = [] node_taint_enabled = false node_taint_key = \"\" node_taint_value = \"\" node_taint_effect = \"\" auto_repair = true auto_upgrade = true upgrade_max_surge = 1 upgrade_max_unavailable = 0 upgrade_strategy = \"SURGE\" autoscaling_enabled = true autoscaling_max_node_count = 2 autoscaling_min_node_count = 1 autoscaling_total_max_node_count = 0 autoscaling_total_min_node_count = 0 } ä¸Šé¢å…©å€‹æª”æ¡ˆåˆ†åˆ¥æ˜¯ cluster çš„è¨­å®šï¼Œä»¥åŠ test node-pool çš„è¨­å®šï¼Œè£¡é¢çš„è¨­å®šï¼Œä¸Šé¢åŸºæœ¬éƒ½æœ‰æéï¼Œé€™é‚Šè¦æçš„æ˜¯ dependencyï¼Œdependency ä»–æ˜¯ Terragrunt æä¾›è®“æˆ‘å€‘å¯ä»¥æ–¹ä¾¿åœ°å»ç®¡ç† IaC ä¹‹é–“çš„ç›¸ä¾æ€§ï¼Œåƒæ˜¯æˆ‘å€‘é€™é‚Šï¼Œéœ€è¦å…ˆå»ºç«‹å¥½ cluster æ‰èƒ½å»ºç«‹ node_poolï¼Œæ­¤æ™‚å°±å¯ä»¥ä¾é  dependency block ä¾†å®Œæˆéœ€æ±‚ã€‚\n( é  dependency ä¾†å–å¾— cluster çš„è³‡è¨Šï¼Œä¸¦å¸¶å…¥ node_pool ä¸­ )\næ­¤æ™‚çš„åŸ·è¡ŒæŒ‡ä»¤æ˜¯åœ¨ gke ç›®éŒ„ä¸‹ï¼Œä½¿ç”¨ terragrunt run-all [åƒæ•¸] ä¾†è·‘æ•´å€‹ç›¸ä¾çš„ moduleï¼Œæˆ‘å€‘é€™é‚Šå°±å»ºç«‹ä¸€å€‹åç‚º tf-test çš„ clusterï¼Œä¸¦ä¸”æœ‰ä¸€å€‹åç‚º test çš„ node_pool ï¼Œå…¶ä»–è¨­å®šè«‹åƒè€ƒä¸Šé¢ç¨‹å¼ï¼š\næ¸¬è©¦ terragrunt run-all\n(é»ƒè‰²çš„ WARN æ˜¯å› ç‚º gcs ä¸Šé‚„æ²’æœ‰å­˜éè©²ç‹€æ…‹æª”æ¡ˆï¼Œæ‰€ä»¥æœƒè·³å‡ºæç¤º)\nç­‰åˆ° cluster å»ºç«‹å®Œæˆå¾Œï¼Œæœƒå°‡ cluster çš„è³‡è¨Šå¸¶å…¥ node_poolï¼Œæ‰é–‹å§‹å»ºç«‹ node_pool çš„è³‡æºï¼š\næ¸¬è©¦ terragrunt run-all\nç”¢ç”Ÿä¾è³´é—œè¯åœ– ç•¶æˆ‘å€‘æœå‹™ä½¿ç”¨åˆ°å¾ˆå¤šä¾è³´é—œä¿‚ï¼Œæƒ³è¦é‡æ¸…æ˜¯èª°ä¾è³´èª°ï¼Œå¦‚æœå–®ç´”çœ‹ç¨‹å¼æœƒæ¯”è¼ƒéº»ç…©ï¼Œåœ¨ Terragrunt é‚„æœ‰ä¸€å€‹å¥½ç”¨çš„æŒ‡ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼Œç”¢ç”Ÿå°æ‡‰çš„ä¾è³´é—œä¿‚åœ–ï¼Œåœ¨æª¢è¦–æ™‚å¯ä»¥æ›´æ¸…æ¥šçŸ¥é“é—œä¿‚ï¼š\nterragrunt graph-dependencies | dot -Tpng \u003e graph.png ( é€™å€‹ dot æŒ‡ä»¤æ˜¯å¦å¤–çš„å¥—ä»¶ï¼Œæœƒå°‡é—œä¿‚åœ–ç¨‹å¼ç¢¼è½‰æˆåœ–æª”ï¼Œè«‹å…ˆå®‰è£ brew install graphviz )\né—œè¯åœ–","terragrunt-å®‰è£æ–¹å¼#Terragrunt å®‰è£æ–¹å¼":"é‚£è¦æ€éº¼ä½¿ç”¨ Terragrunt å‘¢ï¼ï¼Ÿ\nç¬¬ä¸€æ­¥ç•¶ç„¶æ˜¯å®‰è£å®ƒå›‰ï¼Œæˆ‘å€‘ç³»çµ±æ˜¯ macOSï¼Œæ‰€ä»¥æˆ‘å€‘å®‰è£æ–¹å¼æ˜¯ Homebrew ä¾†é€²è¡Œå®‰è£ï¼š\nbrew install terragrunt æ¥è‘—æˆ‘å€‘çš„æŒ‡ä»¤æœƒå¾ terraform XXX è®Šæˆä»¥ä¸‹ï¼š\nterragrunt plan terragrunt apply terragrunt output terragrunt destroy Terragrunt æœƒå°‡æ‰€æœ‰å‘½ä»¤ã€åƒæ•¸å’Œé¸é …ç›´æ¥è½‰ç™¼åˆ° Terraformã€‚(æ‰€ä»¥æˆ‘å€‘ä¹Ÿéœ€è¦ä¸‹è¼‰ Terraform)\nTerragrunt çš„é è¨­æª”æ¡ˆåç¨±æ˜¯ terragrunt.hcl ï¼ŒTerragrunt çš„è¨­å®šæª”æ¡ˆåŸºæœ¬ä¸Šèˆ‡ Module å·®ä¸å¤šï¼Œåªæ˜¯æœ‰æ›´å¤šæ›´æ–¹ä¾¿çš„è®Šæ•¸å¯ä»¥ä½¿ç”¨ã€‚","åƒè€ƒè³‡æ–™#åƒè€ƒè³‡æ–™":"äº‹åŠåŠŸå€ â€” ä½¿ç”¨ Terragrunt æ­é… Terraform ç®¡ç†åŸºç¤è¨­ç½®ï¼šhttps://medium.com/act-as-a-software-engineer/%E4%BA%8B%E5%8D%8A%E5%8A%9F%E5%80%8D-%E4%BD%BF%E7%94%A8-terragrunt-%E6%90%AD%E9%85%8D-terraform-%E7%AE%A1%E7%90%86%E5%9F%BA%E7%A4%8E%E8%A8%AD%E6%96%BD-f70c30166639"},"title":"å¦‚ä½•å°å…¥ Terragruntï¼ŒTerragrunt å¥½è™•æ˜¯ä»€éº¼ï¼Ÿ"},"/projects/":{"data":{"":" æ´»å‹•ç”³è«‹ç³»çµ± (Web)å¹«å­¸æ ¡é–‹ç™¼çš„å¤§å‹æ ¡å‹™ç³»çµ±ï¼Œæ–¹ä¾¿ç³»çµ±ç¤¾åœ˜ä½¿ç”¨é›»å­å¡«å–®æ–¹å¼ç”³è«‹æ´»å‹•ï¼Œä¹Ÿè®“ä¹‹å¾Œçš„å­¸å¼Ÿå¦¹ï¼Œå¯ä»¥æ›´å¿«é€Ÿçš„æŸ¥çœ‹åˆ°æ­·å±†è¾¦ç†çš„æ´»å‹•ã€‚ å·”å³°æ¥µé€Ÿ å…Œæ›è™›å¯¶ç¶²ç«™ (Web)è©²éŠæˆ²æœ‰å¤§é‡è™›å¯¶å¯ä»¥å…Œæ›ï¼Œä½†å®˜æ–¹æä¾›çš„ç¶²é ï¼Œéœ€è¦é‡è¤‡è¼¸å…¥ ID ä»¥åŠé©—è­‰ç¢¼é‚„æœ‰åºè™Ÿï¼Œå› æ­¤å¯«äº†ä¸€å€‹å°ç¶²é ï¼Œå¯ä»¥åªè¼¸å…¥ä¸€æ¬¡ ID ä»¥åŠé©—è­‰ç¢¼ï¼Œå°±å…Œæ›å®Œæ‰€æœ‰åºè™Ÿã€‚ äº¬ç·¯å·¥ç¨‹æœ‰é™å…¬å¸å®˜ç¶² (Web)å”åŠ©äº¬ç·¯å·¥ç¨‹æœ‰é™å…¬å¸å»ºç«‹å…¬å¸å®˜æ–¹ç¶²é ã€‚ "},"title":"å°ˆæ¡ˆæˆå°±"}}